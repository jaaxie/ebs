<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>EBS v3 - Cloud</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<style>
:root{--bg:#2f2f2d;--bg2:#252523;--bg3:#1f1e1d;--bg4:#131312;--border:rgba(221,220,208,0.08);--border-strong:rgba(221,220,208,0.12);--text:#faf9f5;--text2:#c1bfb5;--text3:#9b9991;--text-muted:#9b9991;--accent:#5a9ac8;--accent-hover:#6aa8d4;--accent-main:#d87756;--selection:rgba(90,154,200,0.12);--green:#6aaa6a;--yellow:#b8a050;--orange:#d87756;--red:#c07070;--cyan:#6aa0aa;--purple:#9888aa;--s0:#8a8a82;--s1:#c07070;--s2:#d87756;--s3:#b8a050;--s4:#9888aa;--s5:#6aa0aa;--s6:#6aaa6a;--checkbox:#5a9ac8;--btn-primary-bg:#faf9f5;--btn-primary-text:#2f2f2d;--shadow:0 4px 12px rgba(0,0,0,0.15)}
[data-theme="claude-light"]{--bg:#ffffff;--bg2:#faf9f5;--bg3:#f4f4ec;--bg4:#e7e5db;--border:rgba(31,30,29,0.06);--border-strong:rgba(31,30,29,0.10);--text:#131312;--text2:#3c3c39;--text3:#72716b;--text-muted:#72716b;--accent:#1a66b2;--green:#1a7a1a;--yellow:#8a6a20;--orange:#c6603f;--red:#b04545;--cyan:#1a7a90;--purple:#6a4a9a;--s0:#6a6a62;--s1:#b04545;--s2:#c6603f;--s3:#8a6a20;--s4:#6a4a9a;--s5:#1a7a90;--s6:#1a7a1a;--accent-main:#c6603f;--checkbox:#1a66b2;--btn-primary-bg:#131312;--btn-primary-text:#faf9f5;--shadow:0 4px 12px rgba(0,0,0,0.06)}
.theme-popover{width:240px}
.theme-popover .modal-body{padding:16px}
.theme-grid{display:flex;flex-direction:column;gap:6px}
.theme-card{padding:14px 16px;border-radius:12px;cursor:pointer;border:2px solid transparent;background:var(--bg3);transition:all .2s cubic-bezier(0.4,0,0.2,1);position:relative}
.theme-card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
.theme-card.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(138,186,220,.2)}
.theme-card.active::after{content:'âœ“';position:absolute;top:12px;right:14px;font-size:13px;font-weight:600;color:var(--accent)}
.theme-name{font-size:12px;font-weight:600;margin-bottom:8px}
.theme-preview{display:flex;gap:4px;height:24px;border-radius:6px;overflow:hidden}
.theme-preview span{flex:1;border-radius:4px}
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:var(--text-muted) transparent}
*::-webkit-scrollbar{width:8px;height:8px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:var(--text-muted);border-radius:4px;border:2px solid var(--bg)}
*::-webkit-scrollbar-thumb:hover{background:var(--text3)}
html,body{height:100%;overflow:hidden;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);font-size:14px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;line-height:1.5}
.header{background:var(--bg);border-bottom:1px solid var(--border);padding:0 20px;display:flex;align-items:center;position:fixed;top:0;left:0;right:0;z-index:100;height:50px;gap:12px}
.logo{font-weight:500;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:120px;max-width:280px;letter-spacing:-0.2px;flex-shrink:0}
.header-search{position:relative;width:180px;flex-shrink:0}
.header-search input{width:100%;height:32px;padding:0 32px 0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:16px;transition:all .2s}
.header-search input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,0.08)}
.header-search input::placeholder{color:var(--text-muted)}
.header-search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;background:var(--bg3);border:none;border-radius:50%;color:var(--text3);font-size:9px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:all .15s}
.header-search-clear.visible{display:flex}
.header-search-clear:hover{background:var(--text3);color:var(--bg)}
.ai-console-btn{display:flex;align-items:center;gap:8px;padding:4px 10px 4px 4px;background:transparent;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text);transition:all .15s;flex-shrink:0}
.ai-console-btn:hover{background:var(--bg2)}
.ai-console-btn.active{background:var(--accent-main);color:white}
.ai-console-btn.active .ai-console-icon{background:rgba(255,255,255,0.2)}
.ai-console-btn.active .ai-console-plus{animation:icon-spin-accel 2s ease-in forwards}
.ai-console-btn.active .ai-console-plus::before,.ai-console-btn.active .ai-console-plus::after{animation:bar-to-dot 2s ease-in forwards}
.ai-console-btn.spinning .ai-console-plus{animation:icon-spin-fast 0.08s linear infinite}
.ai-console-btn.spinning .ai-console-plus::before,.ai-console-btn.spinning .ai-console-plus::after{width:10px;height:10px;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.92);opacity:0.75;animation:dot-pulse 1.5s ease-in-out infinite}
.ai-console-btn.decelerating .ai-console-plus{animation:icon-spin-decel 2s ease-out forwards}
.ai-console-btn.decelerating .ai-console-plus::before,.ai-console-btn.decelerating .ai-console-plus::after{animation:dot-to-bar 2s ease-out forwards}
.ai-console-icon{width:24px;height:24px;border-radius:50%;background:var(--accent-main);display:flex;align-items:center;justify-content:center;color:white;transition:all .3s}
.ai-console-plus{width:12px;height:12px;position:relative}
.ai-console-plus::before,.ai-console-plus::after{content:'';position:absolute;background:white;border-radius:1px}
.ai-console-plus::before{width:12px;height:2.5px;top:50%;left:0;transform:translateY(-50%)}
.ai-console-plus::after{width:2.5px;height:12px;left:50%;top:0;transform:translateX(-50%)}
@keyframes icon-spin-accel{0%{transform:rotate(0deg)}100%{transform:rotate(1440deg)}}
@keyframes icon-spin-decel{0%{transform:rotate(0deg)}100%{transform:rotate(1440deg)}}
@keyframes icon-spin-fast{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes bar-to-dot{0%{border-radius:1px}100%{width:10px;height:10px;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.92);opacity:0.75}}
@keyframes dot-to-bar{0%{width:10px;height:10px;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.92);opacity:0.75}100%{border-radius:1px;opacity:1}}
@keyframes dot-pulse{0%,100%{opacity:0.75;transform:translate(-50%,-50%) scale(0.92)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}}
.header-spacer{flex:1}
.header-metrics{display:flex;align-items:center;gap:8px;cursor:pointer;border-radius:10px;padding:2px;margin:-2px;transition:background .15s}
.header-metrics:hover{background:var(--bg2)}
.hm{display:flex;align-items:center;gap:8px;padding:5px 10px;background:var(--bg2);border-radius:8px;border:1px solid var(--border)}
.hm-label{font-size:9px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px}
.hm-value{font-size:13px;font-weight:500;color:var(--text2)}
.hm-progress{min-width:130px}
.hm-bar{width:60px;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
.hm-bar-fill{height:100%;border-radius:2px;background:#7aaa7a;transition:width .4s ease}
.header-btns{display:flex;gap:4px;align-items:center}
.header-btns .btn{background:transparent;border:none;color:var(--text2);height:36px;padding:0 10px;font-size:13px}
.header-btns .btn:hover{background:var(--bg3);color:var(--text)}
.version-badge{font-size:10px;color:var(--text-muted);padding:6px 10px;font-family:ui-monospace,monospace;cursor:pointer;position:relative;border-radius:4px;transition:all .15s}
.version-badge:hover{color:var(--text3);background:var(--bg2)}
.version-info{position:fixed;background:var(--bg3);border:1px solid var(--border-strong);border-radius:8px;padding:12px;font-size:11px;color:var(--text2);opacity:0;visibility:hidden;transform:translateY(4px);transition:all .15s;box-shadow:var(--shadow);z-index:1000;width:240px;font-family:system-ui,-apple-system,sans-serif;pointer-events:none}
.version-info.open{opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto}
.version-info-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;gap:12px}
.version-info-label{color:var(--text-muted);font-size:11px;flex-shrink:0}
.version-info-value{color:var(--text);font-weight:500;font-size:11px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px}
.version-info-divider{height:1px;background:var(--border);margin:8px 0}
.btn{height:34px;padding:0 12px;font-size:12px;font-weight:500;color:var(--text2);background:transparent;border:1px solid var(--border);border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all .15s}
.btn:hover{background:var(--bg2);color:var(--text);border-color:var(--border-strong)}
.btn:active{transform:scale(0.98)}
.btn-primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);border-color:transparent}
.btn-primary:hover{opacity:0.9}
.btn-report{gap:8px}
.btn-receive{gap:8px}
.po-details-actions .btn-receive{background:rgba(127,184,127,0.08);color:var(--green);border:1px solid rgba(127,184,127,0.2)}
.po-details-actions .btn-receive:hover{background:rgba(127,184,127,0.15)}
.btn-save{background:transparent;color:var(--text2)}
.btn-save:hover{background:var(--bg2)}
.btn-danger{background:rgba(192,128,128,0.06);color:var(--red);border-color:transparent}
.btn-danger:hover{background:rgba(192,128,128,0.12)}
.po-popover{width:320px}
.receive-po-popover{width:360px}
.receive-po-preview{margin-top:14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;max-height:220px;overflow-y:auto}
.receive-po-empty{padding:20px;text-align:center;color:var(--text3);font-size:12px}
.receive-po-list{padding:6px 0}
.receive-po-item{display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border)}
.receive-po-item:last-child{border-bottom:none}
.receive-po-item-name{flex:1;font-size:13px;font-weight:500}
.receive-po-item-status{font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg3);color:var(--text2);font-weight:550}
.receive-po-item-status.ordered{background:#3b3000;color:#fbbf24}
.receive-po-item-status.arrived{background:#1a3a2f;color:#6ee7b7}
.receive-po-count{padding:12px 14px;background:var(--bg3);border-radius:10px 10px 0 0;font-size:13px;font-weight:600;color:var(--text2)}
.receive-po-count span{color:var(--accent)}
.po-note{font-size:11px;color:var(--text3);margin-top:6px;font-style:italic}
.delete-modal{max-width:320px}
.notes-cell{font-size:11px;color:var(--text3);font-style:italic;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.eta-cell{display:flex;flex-direction:column;gap:2px;font-size:11px}
.eta-date{cursor:pointer}
.eta-date.historical{color:var(--text3)}
.eta-date.user-set{color:var(--green)}
.eta-po{font-size:10px;color:var(--accent);cursor:pointer;font-weight:500}
.eta-po:hover{text-decoration:underline}
.eta-po.active{background:var(--accent);color:#fff;padding:2px 6px;border-radius:3px}
.autocomplete-wrapper{position:relative;width:100%}
.autocomplete-wrapper input{width:100%;height:26px;padding:2px 8px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--accent);border-radius:4px;outline:none}
.autocomplete-list{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:8px;max-height:180px;overflow-y:auto;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.5);display:none}
.autocomplete-list.open{display:block}
.autocomplete-item{padding:8px 12px;font-size:13px;cursor:pointer;color:var(--text)}
.autocomplete-item:hover,.autocomplete-item.selected{background:var(--bg4)}
.autocomplete-item em{color:var(--accent);font-style:normal;font-weight:600}
.main{padding-top:50px;height:100vh;display:flex;overflow:hidden}
.sidebar{width:200px;min-width:200px;background:var(--bg);border-right:1px solid var(--border);padding:20px 16px;display:flex;flex-direction:column;gap:24px;overflow-y:auto;position:relative;z-index:15}
.sidebar-section{}
.sidebar-label{font-size:11px;font-weight:500;color:var(--text-muted);letter-spacing:0.3px;margin-bottom:12px;padding:0 12px;text-transform:uppercase}
.content{flex:1;padding:12px 16px;display:flex;flex-direction:column;overflow:hidden;position:relative}
.content:has(.ai-workspace.active){padding:0}
.pipeline{display:flex;flex-direction:column;gap:4px}
.pipe{background:transparent;border:none;border-radius:10px;padding:10px 12px;text-align:left;cursor:pointer;position:relative;transition:all .15s;display:flex;align-items:center;gap:12px}
.pipe::before{content:'';width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pipe[data-s="pending"]::before{background:var(--s0)}.pipe[data-s="to-order"]::before{background:var(--s1)}.pipe[data-s="ordered"]::before{background:var(--s2)}.pipe[data-s="arrived"]::before{background:var(--s3)}.pipe[data-s="tested"]::before{background:var(--s4)}.pipe[data-s="configured"]::before{background:var(--s5)}.pipe[data-s="installed"]::before{background:var(--s6)}
.pipe:hover{background:var(--bg2)}.pipe.active{background:var(--bg2)}
.pipe-count{font-size:14px;font-weight:500;min-width:28px;color:var(--text2)}
.pipe-label{font-size:14px;font-weight:400;color:var(--text3)}
.tabs{display:flex;flex-direction:column;gap:4px}
.tab{height:44px;padding:0 12px;display:flex;align-items:center;gap:14px;font-size:14px;font-weight:400;color:var(--text3);background:transparent;border:none;border-radius:10px;cursor:pointer;transition:all .15s;text-align:left}
.tab-icon{width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:17px;color:var(--text2)}
.tab:hover{color:var(--text);background:var(--bg2)}
.tab:hover .tab-icon{color:var(--text)}
.tab.active{color:var(--text);background:var(--bg2)}
.tab.active .tab-icon{color:var(--text)}
.tab.active::after{display:none}
.toolbar{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-shrink:0}
.search{flex:1;height:34px;padding:0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:8px;transition:all .2s}
.search:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,0.08)}
.search::placeholder{color:var(--text-muted)}
.filter-select{height:34px;padding:0 10px;font-size:12px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:8px;cursor:pointer}
.toggle-btn{height:34px;padding:0 12px;font-size:12px;font-weight:500;color:var(--text2);background:transparent;border:1px solid var(--border);border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
.toggle-btn:hover{background:var(--bg2);color:var(--text)}
.toggle-btn.expanded{background:var(--bg2);color:var(--text)}
.toggle-btn .arrow{font-size:8px;transition:transform .2s}
.panel{display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden}.panel.active{display:flex}
.filter-badges{margin-bottom:6px;flex-shrink:0}
.filter-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(138,186,220,.06);color:var(--accent);padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;margin-right:6px}
.filter-badge button{background:rgba(255,255,255,.06);border:none;color:var(--accent);width:16px;height:16px;border-radius:50%;cursor:pointer;font-size:9px}
.data-table{background:var(--bg2);border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
.table-header{display:grid;gap:4px;padding:0 12px;background:transparent;border-bottom:1px solid var(--border);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;height:34px;align-items:center;flex-shrink:0}
.table-body{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden}
.parts-grid{grid-template-columns:28px minmax(200px,1fr) 100px 90px 80px 40px 76px 96px 90px minmax(150px,1fr) 36px}
.part-checkbox{width:14px;height:14px;accent-color:var(--checkbox);cursor:pointer;margin:0}
.part-row.selected{background:var(--selection)!important}
.part-row.selected:hover{background:rgba(138,186,220,0.16)!important}
.bulk-bar{display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);align-items:center;gap:12px;padding:14px 18px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2);z-index:1000;flex-direction:row;width:auto}
.bulk-bar.active{display:flex}
.bulk-bar-count{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap}
.bulk-bar-actions{display:flex;gap:8px}
.bulk-bar .btn{background:var(--bg3);color:var(--text);border:1px solid var(--border);height:32px;padding:0 14px;font-size:12px;border-radius:8px;white-space:nowrap}
.bulk-bar .btn:hover{background:var(--bg4);border-color:var(--border-strong)}
.bulk-bar .btn-danger{background:rgba(192,128,128,0.1);color:var(--red);border-color:transparent}
.bulk-bar .btn-danger:hover{background:rgba(192,128,128,0.2)}
.bulk-bar .btn-clear{background:transparent;color:var(--text3);padding:0 8px}
.bulk-popover{width:320px}
.bulk-preview{background:var(--bg);border-radius:8px;padding:10px;margin-bottom:10px;max-height:120px;overflow-y:auto}
.bulk-preview-item{font-size:12px;color:var(--text2);padding:4px 0}
.add-row{display:flex;align-items:center;padding:4px 12px;background:var(--bg)}
.add-row-btn{width:20px;height:20px;background:var(--bg3);border:none;border-radius:6px;color:var(--text3);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.add-row-btn:hover{background:var(--accent);color:#fff}
.asm-row{display:grid;gap:4px;padding:0 12px;background:var(--bg3);height:40px;align-items:center;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border)}
.asm-row:hover{background:var(--bg4)}
.asm-row.highlight{background:rgba(10,132,255,0.2)!important;animation:asm-row-highlight 1.5s ease-out}
@keyframes asm-row-highlight{0%{background:rgba(10,132,255,0.4)}100%{background:var(--bg3)}}
.asm-priority{display:flex;flex-direction:column;gap:1px;align-items:center}
.asm-priority-btn{width:18px;height:14px;background:transparent;border:none;color:var(--text3);font-size:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:3px;transition:all .15s}
.asm-priority-btn:hover{background:var(--bg4);color:var(--text)}
.asm-priority-btn:active{background:var(--accent);color:#fff}
.asm-toggle{width:20px;height:20px;background:transparent;border:none;color:var(--text2);font-size:10px;cursor:pointer;pointer-events:none}
.asm-name{font-weight:600;font-size:13px;color:var(--accent);pointer-events:none}
.asm-name-cell{display:flex;align-items:center;gap:8px}
.asm-meta{font-size:11px;color:var(--text3);pointer-events:none}
.asm-progress{display:flex;align-items:center;gap:8px}
.asm-bar{width:180px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;display:block}
.asm-bar-fill{height:100%;border-radius:3px;display:block}
.asm-pct{font-size:11px;font-weight:500;min-width:36px;color:var(--text2)}
.stage-dots{display:flex;align-items:center;gap:4px}
.stage-dot{width:6px;height:6px;border-radius:50%;background:var(--bg4)}
.stage-dot.done{background:var(--green)}
.stage-dot.current{background:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,.12)}
.asm-actions{display:flex;gap:4px}
.sm-btn{width:24px;height:24px;background:transparent;border:none;border-radius:5px;color:var(--text-muted);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.del-btn{width:32px;height:32px;background:transparent;border:none;border-radius:6px;color:var(--text-muted);font-size:18px;font-weight:300;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.del-btn:hover{background:rgba(192,128,128,.15);color:var(--red)}
.notes-chat-cell{font-size:11px;color:var(--text2);padding:4px 8px;border-radius:6px;cursor:pointer;transition:all .15s;min-height:24px;display:flex;align-items:center;gap:6px;max-width:100%}
.notes-chat-cell:hover{background:var(--bg3);color:var(--text)}
.notes-chat-cell .comment-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}
.add-note{color:var(--text3);font-style:italic}
.notes-chat-cell:hover .add-note{color:var(--text2)}
.comment-badge{background:var(--accent);color:#fff;font-size:9px;padding:1px 5px;border-radius:8px;font-weight:500;flex-shrink:0;line-height:1.3}
.sm-btn:hover{background:var(--bg3);color:var(--text2)}.sm-btn.red{color:var(--red)}.sm-btn.red:hover{background:rgba(192,128,128,.08)}
.part-row{display:grid;gap:4px;padding:0 12px;background:var(--bg2);height:40px;align-items:center;transition:background .15s;border-bottom:1px solid var(--border)}
.part-row.ai-highlight{background:rgba(216,119,86,0.25);animation:ai-pulse 0.5s ease-out}
@keyframes ai-pulse{0%{background:rgba(216,119,86,0.4)}100%{background:rgba(216,119,86,0.25)}}
.asm-row.ai-highlight{background:rgba(216,119,86,0.2)}
.part-row:last-child{border-bottom:none}
.part-row:hover{background:var(--bg3)}.part-row.child{background:var(--bg)}.part-row.child:hover{background:var(--bg3)}
.part-row.subchild{background:var(--bg)}
.part-row.highlight{background:var(--selection)}
.part-name-cell{display:flex;align-items:center;gap:8px}
.part-name-cell .cell{flex:1}
.subpart-add{width:18px;height:18px;border-radius:4px;background:transparent;border:1px dashed var(--border);color:var(--text-muted);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;opacity:0;flex-shrink:0}
.part-row:hover .subpart-add{opacity:0.5}
.subpart-add:hover{background:var(--accent);border-color:var(--accent);color:#fff;opacity:1!important}
.part-row.depth-1,.part-row.depth-2,.part-row.depth-3{border-left:3px solid var(--accent)}
.part-row.depth-1{border-left-color:rgba(138,186,220,0.3)}
.part-row.depth-2{border-left-color:rgba(138,186,220,0.5)}
.part-row.depth-3{border-left-color:rgba(138,186,220,0.7)}
.cell{font-size:12px;color:var(--text);padding:3px 5px;border-radius:4px;cursor:text;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:22px;display:flex;align-items:center}
.cell.editing{overflow:visible;position:relative;z-index:100}
.cell.editing{overflow:visible;position:relative;z-index:50}
.cell:hover{background:var(--bg4)}.cell.editing{background:var(--bg);padding:0}
.cell input,.cell select{width:100%;height:26px;padding:0 8px;font-size:12px;color:var(--text);background:var(--bg);border:1px solid var(--accent);border-radius:4px;outline:none}
.cell.muted{color:var(--text2)}.cell.note{font-style:italic;color:var(--text3);font-size:11px;margin-left:4px}
.status-badge{font-size:10px;font-weight:500;padding:3px 7px;border-radius:4px;text-align:center;display:inline-block}
.status-badge.pending{background:rgba(138,138,130,.08);color:var(--s0)}.status-badge.to-order{background:rgba(192,128,128,.08);color:var(--s1)}.status-badge.ordered{background:rgba(196,134,106,.08);color:var(--s2)}.status-badge.arrived{background:rgba(191,160,96,.08);color:var(--s3)}.status-badge.tested{background:rgba(160,144,180,.08);color:var(--s4)}.status-badge.configured{background:rgba(122,172,180,.08);color:var(--s5)}.status-badge.installed{background:rgba(127,184,127,.08);color:var(--s6)}
.eta-badge{font-size:10px;padding:3px 7px;border-radius:4px;background:var(--bg3);color:var(--text2);cursor:pointer;font-weight:500}
.eta-badge:hover{background:var(--bg4);color:var(--text)}
.eta-badge.has-data{background:rgba(160,144,180,.08);color:var(--purple)}
.eta-badge.manual{background:rgba(127,184,127,.08);color:var(--green)}
.action-indicator{width:16px;height:16px;background:var(--yellow);color:var(--bg);border-radius:4px;font-size:9px;font-weight:600;display:flex;align-items:center;justify-content:center;cursor:pointer}
.adv-btn{width:24px;height:24px;font-size:11px;font-weight:500;color:var(--text-muted);background:transparent;border:none;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.adv-btn:hover{background:var(--bg3);color:var(--text2)}.adv-btn.done{color:var(--green);cursor:default}.adv-btn.done:hover{background:transparent}
.empty{padding:40px 16px;text-align:center;color:var(--text-muted);font-size:13px;flex:1;display:flex;align-items:center;justify-content:center}
.action-grid{grid-template-columns:minmax(120px,1fr) 100px 65px 80px 75px 75px 75px 80px}
.action-row{display:grid;gap:6px;padding:0 12px;background:var(--bg2);height:40px;align-items:center;border-bottom:1px solid var(--border)}
.action-row:last-child{border-bottom:none}
.action-row:hover{background:var(--bg3)}
.action-task{font-size:12px}.action-task.completed{text-decoration:line-through;color:var(--text3)}
.action-progress-bar{width:100%;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
.action-progress-fill{height:100%;border-radius:2px;transition:width .4s ease}
.action-link{font-size:11px;color:var(--accent);cursor:pointer}.action-link:hover{text-decoration:underline}
.action-due{font-size:12px;color:var(--text2)}.action-due.overdue{color:var(--red);font-weight:600}.action-due.soon{color:var(--yellow)}
.action-status{font-size:10px;font-weight:600;padding:4px 8px;border-radius:6px;text-align:center}
.action-status.not-started{background:rgba(255,69,58,.15);color:var(--s1)}.action-status.in-progress{background:rgba(255,214,10,.15);color:var(--s3)}.action-status.completed{background:rgba(48,209,88,.15);color:var(--s5)}
.progress-layout{display:flex;flex-direction:column;gap:10px;flex:1;overflow-y:auto;overflow-x:hidden}
.progress-top{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:900px){.progress-top{grid-template-columns:1fr}}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;flex-direction:column}
.card-title{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.card-title a{font-size:12px;color:var(--accent);cursor:pointer;text-transform:none;font-weight:500}
.burndown-container{background:var(--bg);border-radius:10px;padding:12px;flex:1;display:flex;align-items:center;justify-content:center;min-height:180px}
.burndown-container svg{display:block;width:100%;height:100%}
.burndown-dates{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-top:8px}
.burndown-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);font-size:13px;cursor:pointer;gap:6px}
.burndown-legend{display:flex;gap:16px;margin-top:10px;font-size:11px;color:var(--text2)}
.legend-item{display:flex;align-items:center;gap:6px}
.legend-dot{width:10px;height:3px;border-radius:2px}
.legend-dot.green{background:var(--green)}.legend-dot.red{background:var(--red)}.legend-dot.gray{background:var(--text3)}
.insights-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ins-group{margin-bottom:12px}.ins-group:last-child{margin-bottom:0}
.ins-group-title{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;padding:0 4px}
.ins-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg);border-radius:8px;font-size:12px}
.ins-label{color:var(--text2)}.ins-val{font-weight:600}
.ins-val.green{color:var(--green)}.ins-val.red{color:var(--red)}.ins-val.yellow{color:var(--yellow)}.ins-val.cyan{color:var(--cyan)}.ins-val.orange{color:var(--orange)}

/* Metrics Popover */
/* Backdrop overlay for popovers */
.popover-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:999;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
.popover-backdrop.active{opacity:1;pointer-events:auto}

.metrics-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:520px;max-width:calc(100vw - 40px);padding:20px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.metrics-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.metrics-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.metrics-row:last-child{margin-bottom:0}
.metrics-popover-title{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;padding:0 4px}
.metrics-popover .ins-row{padding:6px 8px;margin-bottom:4px}
.metrics-popover .ins-row:last-child{margin-bottom:0}
.metrics-section-full{grid-column:span 2;margin-bottom:12px}
.mp-forecast{padding:8px 0}
.mp-forecast-date{font-size:20px;font-weight:600;color:var(--text)}
.mp-forecast-label{font-size:12px;margin-left:8px}
.mp-forecast-detail{font-size:11px;color:var(--text3);margin-top:4px}
.mp-bottlenecks{display:flex;flex-wrap:wrap;gap:8px}
.mp-bottleneck{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg3);border-radius:6px;font-size:11px;cursor:pointer;transition:background .15s}
.mp-bottleneck:hover{background:var(--bg4)}
.mp-bottleneck-name{color:var(--text)}
.mp-bottleneck-info{color:var(--text3)}
.mp-otd-detail{margin-top:8px;padding:8px;background:var(--bg);border-radius:8px}
.mp-otd-content{margin-top:8px;max-height:200px;overflow-y:auto}
.mp-otd-item{display:flex;justify-content:space-between;padding:6px 8px;font-size:12px;border-radius:4px}
.mp-otd-item:nth-child(odd){background:var(--bg3)}
.mp-otd-item-mfr{color:var(--text)}
.mp-otd-item-stats{color:var(--text3)}
.mp-chart-container{background:var(--bg);border-radius:10px;padding:16px;min-height:160px;display:flex;align-items:center;justify-content:center}
.mp-chart-container svg{display:block;width:100%;height:100%}
.mp-chart-legend{display:flex;gap:16px;margin-top:12px;font-size:11px;color:var(--text2);justify-content:center}
.mp-legend-item{display:flex;align-items:center;gap:6px}
.mp-legend-dot{width:8px;height:8px;border-radius:50%}
.mp-chart-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);font-size:12px;gap:6px;cursor:pointer;padding:20px}
.mp-chart-empty:hover{color:var(--text2)}
.metrics-section{margin-bottom:12px}
.metrics-section:last-child{margin-bottom:0}
.metrics-section-title{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;padding:4px 8px;margin-bottom:4px}
.forecast-card{background:var(--bg);border-radius:10px;padding:12px;margin-top:8px;border-left:3px solid var(--purple)}
.forecast-title{font-size:10px;font-weight:600;color:var(--purple);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.forecast-main{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.forecast-date{font-size:20px;font-weight:700;letter-spacing:-0.5px}
.forecast-label{font-size:12px;color:var(--text2)}
.forecast-detail{font-size:11px;color:var(--text3)}
/* Progress Page */
.progress-layout-full{display:flex;flex-direction:column;gap:12px;flex:1;overflow-y:auto}
.progress-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.asm-progress-list{display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto}
.asm-progress-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bg3)}
.asm-progress-item:last-child{border-bottom:none}
.asm-progress-name{flex:1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.asm-progress-bar{width:80px;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden}
.asm-progress-fill{height:100%;border-radius:3px;transition:width 0.3s}
.asm-progress-pct{font-size:11px;font-weight:600;width:36px;text-align:right}
.bottleneck-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto}
.bottleneck-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border-radius:6px;font-size:11px;border-left:3px solid var(--red)}
.bottleneck-item.warning{border-color:var(--yellow)}
.bottleneck-name{flex:1;font-weight:500}
.bottleneck-days{color:var(--text3)}
.forecast-card-inner{padding:8px 0}

/* Gantt Chart - MS Project Style */
.gantt-container{display:flex;flex-direction:column;flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.gantt-toolbar{display:flex;align-items:center;gap:18px;padding:14px 20px;background:transparent;border-bottom:1px solid var(--border)}
.gantt-toolbar-title{font-size:15px;font-weight:500;color:var(--text)}
.gantt-toolbar-dates{display:flex;align-items:center;gap:10px;margin-left:auto}
.gantt-date-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.gantt-date-input{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:12px;color:var(--text);width:130px}
.gantt-date-input:focus{outline:none;border-color:var(--accent)}
.gantt-date-arrow{color:var(--text-muted);font-size:14px}
.gantt-toolbar-actions{display:flex;align-items:center;gap:8px}
.btn-sm{padding:6px 12px;font-size:12px;height:30px}
.gantt-header-row{display:flex;background:transparent;border-bottom:1px solid var(--border);position:relative}
.gantt-sidebar-header{width:340px;min-width:340px;display:grid;grid-template-columns:1fr 70px 70px 50px;font-size:10px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border);background:transparent;position:sticky;left:0;z-index:5}
.gantt-sidebar-header>div{padding:12px 10px}
.gantt-col-name{padding-left:20px!important}
.gantt-timeline-header-wrap{flex:1;overflow:hidden}
.gantt-timeline-header{display:flex}
.gantt-timeline-day{min-width:32px;width:32px;padding:8px 0;text-align:center;font-size:9px;color:var(--text-muted);border-right:1px solid var(--border)}
.gantt-timeline-day.weekend{background:rgba(0,0,0,0.08)}
.gantt-timeline-day.today{background:rgba(138,186,220,0.1);color:var(--accent);font-weight:500}
.gantt-timeline-day .day-num{font-size:11px;font-weight:500;color:var(--text3)}
.gantt-timeline-day.today .day-num{color:var(--accent)}
.gantt-body-wrap{flex:1;overflow:auto;cursor:grab;user-select:none;position:relative}
.gantt-body-wrap.grabbing{cursor:grabbing}
.gantt-body-inner{display:flex;min-height:100%}
.gantt-sidebar-body{width:340px;min-width:340px;border-right:1px solid var(--border);background:var(--bg2);position:sticky;left:0;z-index:5}
.gantt-sidebar-row{display:grid;grid-template-columns:1fr 70px 70px 50px;border-bottom:1px solid var(--border);font-size:13px;align-items:center;height:40px}
.gantt-sidebar-row:hover{background:var(--bg3)}
.gantt-sidebar-row.asm{background:var(--bg3);font-weight:500}
.gantt-sidebar-row.asm:hover{background:var(--bg4)}
.gantt-sidebar-row>div{padding:0 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gantt-sidebar-row .gantt-col-name{padding-left:20px;display:flex;align-items:center;gap:8px}
.gantt-sidebar-row.part .gantt-col-name{padding-left:32px;color:var(--text2)}
.gantt-sidebar-row .gantt-col-start,.gantt-sidebar-row .gantt-col-end{font-size:11px;color:var(--text3);cursor:pointer;transition:all 0.15s}
.gantt-sidebar-row .gantt-col-start:hover,.gantt-sidebar-row .gantt-col-end:hover{color:var(--accent);background:var(--bg4);border-radius:4px;margin:-2px -4px;padding:2px 14px}
.gantt-sidebar-row .gantt-col-dur{font-size:11px;color:var(--text-muted);text-align:center}
.gantt-toggle{cursor:pointer;font-size:10px;color:var(--text-muted)}
.gantt-asm-link{cursor:pointer;transition:color 0.15s}
.gantt-asm-link:hover{color:var(--accent)}
.gantt-sidebar-row.highlight{background:rgba(138,186,220,0.15)!important;animation:gantt-row-highlight 1.5s ease-out}
@keyframes gantt-row-highlight{0%{background:rgba(138,186,220,0.3)}100%{background:transparent}}
.gantt-link-btn{background:var(--bg3)!important;font-size:12px!important}
.gantt-timeline-body{position:relative;flex:1}
.gantt-timeline-row{display:flex;height:40px;border-bottom:1px solid var(--border);position:relative}
.gantt-timeline-row:hover{background:var(--bg3)}
.gantt-timeline-row.asm{background:var(--bg3)}
.gantt-timeline-cell{min-width:32px;width:32px;border-right:1px solid var(--border)}
.gantt-timeline-cell.weekend{background:rgba(0,0,0,0.06)}
.gantt-bar-container{position:absolute;top:0;bottom:0;display:flex;align-items:center}
.gantt-bar{height:24px;border-radius:6px;font-size:10px;font-weight:500;color:#fff;display:flex;align-items:center;padding:0 10px;min-width:24px;cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;text-shadow:0 1px 2px rgba(0,0,0,0.2)}
.gantt-bar:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.gantt-bar.asm{background:var(--text-muted);height:3px;border-radius:2px;box-shadow:none;min-width:10px}
.gantt-bar.asm:hover{transform:none;height:5px;margin-top:-1px}
.gantt-bar.pending{background:#8a8a82}
.gantt-bar.to-order{background:#b87070}
.gantt-bar.ordered{background:#b88060}
.gantt-bar.arrived{background:#a89050;color:#fff}
.gantt-bar.configured{background:#9080a8}
.gantt-bar.tested{background:#6898a0;color:#fff}
.gantt-bar.installed{background:#70a070}
.gantt-bar-progress{position:absolute;left:0;top:0;bottom:0;background:rgba(255,255,255,0.2);border-radius:6px 0 0 6px}
.gantt-bar-label{position:relative;z-index:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gantt-dependency{position:absolute;pointer-events:none;z-index:5}
.gantt-dependency line{stroke:var(--text-muted);stroke-width:1.5}
.gantt-dependency polygon{fill:var(--text-muted)}
.gantt-today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--accent-main);z-index:20;pointer-events:none;opacity:0.8}
.gantt-today-marker{position:absolute;top:-20px;background:var(--accent-main);color:#fff;font-size:10px;font-weight:500;padding:3px 8px;border-radius:4px;transform:translateX(-50%);white-space:nowrap}
.gantt-color-popup{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;display:none;min-width:160px}
.gantt-color-popup.open{display:block}
.gantt-date-popup{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;display:none;min-width:180px}
.gantt-date-popup.open{display:block}
.gantt-date-popup-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px}
.gantt-date-popup-input{width:100%;background:var(--bg);border:1px solid var(--bg4);border-radius:6px;padding:8px 10px;font-size:13px;color:var(--text);margin-bottom:10px}
.gantt-date-popup-input:focus{outline:none;border-color:var(--accent)}
.gantt-date-popup-btns{display:flex;gap:8px;justify-content:flex-end}
.gantt-color-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px}
.gantt-color-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.gantt-color-swatch{width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.gantt-color-swatch:hover{transform:scale(1.15);border-color:var(--text)}
.gantt-color-swatch.selected{border-color:var(--text);box-shadow:0 0 0 2px var(--bg2),0 0 0 4px var(--text)}
.ai-modal{max-width:720px;width:95vw}
.ai-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--text2)}
.ai-loading-spinner{width:32px;height:32px;border:3px solid var(--bg4);border-top-color:var(--purple);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.ai-loading-text{font-size:14px;color:#888;font-style:italic}
.ai-loading-sub{font-size:10px;color:var(--text3);margin-top:4px}
.ai-report{font-size:12px;line-height:1.7}
.ai-report-section{margin-bottom:16px}
.ai-report-header{display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.ai-report-header-icon{font-size:14px}
.ai-report-items{display:flex;flex-direction:column;gap:6px}
.ai-report-item{display:flex;gap:8px;padding:8px 10px;background:var(--bg);border-radius:6px;font-size:11px;align-items:flex-start}
.ai-report-item.critical{border-left:3px solid var(--red)}
.ai-report-item.warning{border-left:3px solid var(--yellow)}
.ai-report-item.info{border-left:3px solid var(--cyan)}
.ai-report-item.success{border-left:3px solid var(--green)}
.ai-report-bullet{flex-shrink:0;margin-top:2px}
.ai-report-text{flex:1}
.ai-report-meta{font-size:10px;color:var(--text3);margin-top:2px}
.ai-summary{background:var(--bg);padding:12px;border-radius:8px;margin-bottom:16px;font-size:12px;line-height:1.6;border-left:3px solid var(--purple)}
.ai-error{text-align:center;padding:30px;color:var(--text3)}
.ai-error-icon{font-size:24px;margin-bottom:8px}
.ai-error-msg{font-size:12px;margin-bottom:12px}
.ai-insights-list{display:flex;flex-direction:column;gap:8px}
.ai-insight{display:flex;gap:10px;padding:10px;background:var(--bg);border-radius:6px;border-left:3px solid var(--border);cursor:pointer}
.ai-insight:hover{background:var(--bg3)}
.ai-insight.critical{border-color:var(--red)}.ai-insight.warning{border-color:var(--yellow)}.ai-insight.info{border-color:var(--cyan)}.ai-insight.success{border-color:var(--green)}
.ai-insight-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.ai-insight.critical .ai-insight-icon{background:rgba(201,74,74,.15);color:var(--red)}.ai-insight.warning .ai-insight-icon{background:rgba(201,162,39,.15);color:var(--yellow)}.ai-insight.info .ai-insight-icon{background:rgba(58,168,168,.15);color:var(--cyan)}.ai-insight.success .ai-insight-icon{background:rgba(61,181,114,.15);color:var(--green)}
.ai-insight-content{flex:1}
.ai-insight-title{font-size:12px;font-weight:600;margin-bottom:2px}
.ai-insight-desc{font-size:10px;color:var(--text2)}
.ai-insight-action{font-size:9px;color:var(--accent);margin-top:4px}
.ai-timestamp{font-size:9px;color:var(--text3);text-align:right;margin-top:12px;padding-top:8px;border-top:1px solid var(--border)}
.ai-source{font-size:10px;color:var(--text3);text-align:center;padding:6px;margin-bottom:12px;background:var(--bg);border-radius:6px}
.report-model-badge{font-size:10px;color:var(--text3);background:var(--bg3);padding:4px 10px;border-radius:6px;font-weight:500}
.report-refresh-btn{background:transparent;border:none;color:var(--text3);font-size:18px;cursor:pointer;width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.report-refresh-btn:hover{background:var(--bg3);color:var(--text)}
.report-refresh-btn.spinning{animation:spin 1s linear infinite}
.report-refresh-btn:disabled{opacity:0.3;cursor:not-allowed}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.report-content{font-size:14px;line-height:1.7;color:var(--text);flex:1;overflow-y:auto;padding:12px 0}
.report-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--text3)}
.report-loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
.report-loading-text{font-size:13px}
.report-empty{display:flex;align-items:center;justify-content:center;flex:1}
.report-generate-btn{background:var(--accent-main);color:white;border:none;padding:14px 28px;border-radius:12px;font-size:15px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .2s;box-shadow:0 2px 8px rgba(216,119,86,0.3)}
.report-generate-btn:hover{filter:brightness(1.1);transform:translateY(-1px);box-shadow:0 4px 12px rgba(216,119,86,0.4)}
.report-generate-btn svg{opacity:0.9}
.report-section{margin-bottom:20px}
.report-section-title{font-size:13px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.report-prose{font-size:14px;line-height:1.75;padding:8px 0;flex:1}
.report-prose p{margin-bottom:14px}
.report-prose ul{margin:10px 0;padding-left:24px}
.report-prose li{margin-bottom:8px}
.report-prose strong{color:var(--text)}
.report-prose h1,.report-prose h2,.report-prose h3{color:var(--accent);margin:20px 0 12px 0}
.report-prose h1{font-size:18px}
.report-prose h2{font-size:16px}
.report-prose h3{font-size:14px}
.report-meta{font-size:11px;color:var(--text3);margin-bottom:14px;display:flex;justify-content:space-between;padding:0 2px}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);justify-content:center;align-items:center;z-index:1000;padding:20px}
.modal-bg.open{display:flex}

/* Small contextual popover */
.popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;padding:20px;min-width:220px;max-width:300px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.popover-msg{font-size:14px;margin-bottom:14px;line-height:1.5;color:var(--text)}
.popover-btns{display:flex;gap:10px;justify-content:flex-end}
.popover-btns .btn{padding:8px 14px;font-size:13px;min-width:70px}

/* Backdrop overlay for popovers */
.popover-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:999;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
.popover-backdrop.active{opacity:1;pointer-events:auto}

/* Popover-style modal (positioned near trigger) */
.modal-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:360px;max-width:calc(100vw - 40px);max-height:calc(100vh - 100px);overflow:auto;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.modal-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.modal-popover .modal-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:transparent}
.modal-popover .modal-title{font-size:15px;font-weight:600;letter-spacing:-0.2px}
.modal-popover .modal-close{background:var(--bg3);border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:0;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.modal-popover .modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-popover .modal-body{padding:20px}
.modal-popover .modal-foot{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:transparent}
.modal-popover .field{margin-bottom:16px}
.modal-popover .field-label{font-size:11px;font-weight:600;margin-bottom:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.modal-popover .field-input,.modal-popover .field-select,.modal-popover .field-textarea{width:100%;padding:12px 14px;font-size:14px;font-weight:430;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);transition:border-color .15s,box-shadow .15s}
.modal-popover .field-input:focus,.modal-popover .field-select:focus,.modal-popover .field-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(138,186,220,0.15)}
.modal-popover .field-textarea{min-height:80px;resize:vertical}
.modal-popover .field-row{display:flex;gap:14px}
.modal-popover .field-row .field{flex:1;margin-bottom:16px}
.modal-popover .btn{padding:10px 16px;font-size:13px;font-weight:550;border-radius:10px}
.report-popover{position:fixed;top:51px;right:0;bottom:0;width:calc(100vw - 240px);max-width:1000px;opacity:0;transform:translateX(20px);display:flex;flex-direction:column;border-radius:16px 0 0 16px;border-left:1px solid var(--border);border-top:none;border-right:none;border-bottom:none}
.report-popover.open{transform:translateX(0);opacity:1}
.report-popover .modal-head{gap:8px;flex-shrink:0;border-radius:16px 0 0 0}
.report-popover .modal-body{flex:1;overflow:hidden;display:flex;flex-direction:column;padding:0 20px 10px}
.report-popover .modal-foot{flex-shrink:0;border-radius:0 0 0 16px}
.modal-popover .notify-btn{width:100%;padding:12px;font-size:12px;margin-top:10px}

/* AI popover specific - Claude UI style */
.ai-popover{width:640px;max-width:calc(100vw - 40px);background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.15);max-height:calc(100vh - 100px);display:flex;flex-direction:column}
.ai-popover .modal-body{padding:0;display:flex;flex-direction:column;flex:1;overflow:hidden}
.ai-popover .modal-head{display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);padding:14px 18px;flex-shrink:0;background:var(--bg2)}
.ai-popover .modal-title{flex:1;font-size:15px;font-weight:550;color:var(--text2)}
.ai-popover .modal-close{background:transparent;color:var(--text3);width:28px;height:28px;font-size:16px;border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ai-popover .modal-close:hover{background:var(--bg4);color:var(--text)}
.ai-title-icon{color:#c4956a;font-size:14px;margin-right:4px}
.ai-model-badge{font-size:11px;color:var(--text3);font-family:inherit;background:var(--bg3);padding:6px 12px;border-radius:8px;font-weight:500;border:1px solid var(--border);cursor:pointer;transition:all .15s}
.ai-model-badge:hover{background:var(--bg4);border-color:var(--border-strong)}
.ai-model-selector{position:relative}
.ai-model-dropdown{position:absolute;top:100%;right:0;margin-top:6px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:10;min-width:160px;padding:6px;opacity:0;transform:translateY(-8px);pointer-events:none;transition:all .15s}
.ai-model-dropdown.open{opacity:1;transform:translateY(0);pointer-events:auto}
.ai-model-option{display:flex;flex-direction:column;align-items:flex-start;width:100%;padding:10px 12px;background:transparent;border:none;border-radius:6px;cursor:pointer;text-align:left;transition:all .1s}
.ai-model-option:hover{background:var(--bg3)}
.ai-model-option.active{background:var(--accent);color:#fff}
.ai-model-option .model-name{font-size:12px;font-weight:600;color:var(--text)}
.ai-model-option .model-desc{font-size:10px;color:var(--text3);margin-top:2px}
.ai-model-option.active .model-name,.ai-model-option.active .model-desc{color:#fff}
.thinking-pulse{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.ai-model-selector-ws{position:relative}
.ai-model-badge-ws{font-size:11px;color:var(--text3);background:transparent;padding:6px 10px;border-radius:8px;font-weight:500;border:none;cursor:pointer;transition:all .15s;white-space:nowrap}
.ai-model-badge-ws:hover{background:var(--bg3);color:var(--text2)}
.ai-model-dropdown-ws{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:8px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:10;min-width:160px;padding:6px;opacity:0;pointer-events:none;transition:all .15s}
.ai-model-dropdown-ws.open{opacity:1;pointer-events:auto}
.ai-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:24px;background:var(--bg);-webkit-overflow-scrolling:touch;min-height:200px}
.ai-welcome{color:var(--text3);font-size:13px;line-height:1.6}
.ai-welcome p{margin:0}
.ai-welcome strong{color:var(--text2);font-weight:600}
.ai-dashboard{display:flex;flex-direction:column;gap:8px}
.ai-insights-list{display:flex;flex-direction:column;gap:6px}
.ai-insight-card{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg);border-radius:8px;cursor:pointer;transition:all .15s;border-left:3px solid var(--border)}
.ai-insight-card:hover{background:var(--bg3);transform:translateX(2px)}
.ai-insight-card.positive{border-left-color:var(--green)}
.ai-insight-card.warning{border-left-color:var(--yellow)}
.ai-insight-card.negative{border-left-color:var(--red)}
.ai-insight-card.neutral{border-left-color:var(--accent)}
.ai-insight-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--text2);background:var(--bg2);border-radius:6px;flex-shrink:0}
.ai-insight-card.positive .ai-insight-icon{color:var(--green)}
.ai-insight-card.warning .ai-insight-icon{color:var(--yellow)}
.ai-insight-card.negative .ai-insight-icon{color:var(--red)}
.ai-insight-body{flex:1;min-width:0}
.ai-insight-title{font-size:13px;font-weight:500;color:var(--text);margin-bottom:2px}
.ai-insight-detail{font-size:11px;color:var(--text3)}
.ai-insight-arrow{color:var(--text3);font-size:12px;opacity:0;transition:opacity .15s}
.ai-insight-card:hover .ai-insight-arrow{opacity:1}
.ai-dashboard-hint{font-size:10px;color:var(--text-muted);text-align:center;padding-top:8px;border-top:1px solid var(--border);margin-top:4px}
.ai-prose{font-size:15px;line-height:1.8;color:var(--text)}
.ai-model-attribution{font-size:10px;color:var(--text3);text-align:right;margin-top:12px;padding-top:8px;border-top:1px solid var(--border);opacity:0.7;cursor:help}
.ai-prose p{margin-bottom:16px}
.ai-prose p:last-child{margin-bottom:0}
.ai-prose strong{color:var(--text);font-weight:600}
.ai-prose ul,.ai-prose ol{margin:12px 0 20px 0;padding-left:0;list-style:none}
.ai-prose li{margin:10px 0;padding:12px 16px 12px 36px;position:relative;line-height:1.6;background:var(--bg2);border-radius:10px;border-left:3px solid var(--accent)}
.ai-prose li::before{content:'â†’';position:absolute;left:14px;color:var(--accent);font-size:12px}
.ai-section-header{font-size:11px;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase;margin:24px 0 12px 0;padding-bottom:6px;border-bottom:1px solid var(--border)}
.ai-section-header:first-child{margin-top:0}
.ai-part-link{color:var(--accent);cursor:pointer;text-decoration:underline;text-decoration-color:rgba(107,155,210,0.4);text-underline-offset:3px;transition:all .15s}
.ai-part-link:hover{color:var(--accent);text-decoration-color:rgba(107,155,210,0.7)}
.ai-asm-link{color:var(--cyan);cursor:pointer;text-decoration:underline;text-decoration-color:rgba(86,182,194,0.4);text-underline-offset:3px;transition:all .15s}
.ai-asm-link:hover{color:var(--cyan);text-decoration-color:rgba(86,182,194,0.7)}
.ai-visual{margin:12px 0;padding:16px;background:var(--bg);border-radius:8px;display:flex;justify-content:center}
.ai-mini-chart{max-width:100%}
.ai-action-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;margin:8px 4px 8px 0;font-size:12px;font-weight:500;color:var(--accent);background:rgba(138,186,220,0.08);border:1px solid rgba(138,186,220,0.2);border-radius:6px;cursor:pointer;transition:all .15s}
.ai-action-btn:hover{background:rgba(138,186,220,0.15);border-color:rgba(138,186,220,0.4)}
.ai-input-row{display:flex;align-items:center;gap:10px;padding:16px 20px;background:var(--bg2);border-radius:0 0 16px 16px;border-top:1px solid var(--border)}
.ai-input-row input{flex:1;height:44px;padding:0 18px;font-size:14px;background:var(--bg);border:1px solid var(--border);border-radius:22px;color:var(--text);transition:all .15s}
.ai-input-row input:focus{outline:none;border-color:var(--accent)}
.ai-input-row input::placeholder{color:var(--text3)}
.ai-input-row .btn{height:38px;padding:0 18px;font-size:14px;font-weight:500;border-radius:10px;min-width:auto}
.ai-input-row .btn:first-of-type{background:transparent;color:var(--text2);border:1px solid var(--border)}
.ai-input-row .btn:first-of-type:hover{background:var(--bg3);color:var(--text)}

/* AI Workspace - Full Panel */
.ai-workspace{display:none;flex-direction:column;position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:10}
.ai-workspace.active{display:flex}
.ai-workspace-conversation{flex:1;overflow-y:auto;padding:40px 20px 20px;display:flex;justify-content:center}
.ai-workspace-conversation-inner{max-width:680px;width:100%}
.ai-welcome-minimal{color:var(--text3);font-size:15px;padding:80px 20px;text-align:center}
.ai-workspace-input-wrap{padding:0 20px 28px;margin-top:24px;width:100%;box-sizing:border-box}
.ai-workspace-input{display:flex;align-items:flex-end;gap:0;max-width:680px;width:100%;margin:0 auto;background:var(--bg2);border:1px solid var(--border);border-radius:24px;padding:8px 8px 8px 18px}
.ai-workspace-input textarea{flex:1;border:none;background:transparent;color:var(--text);font-size:15px;line-height:1.5;resize:none;max-height:150px;padding:8px 0;font-family:inherit}
.ai-workspace-input textarea:focus{outline:none}
.ai-workspace-input textarea::placeholder{color:var(--text3)}
.ai-input-actions{display:flex;align-items:center;gap:2px}
.ai-input-btn{width:36px;height:36px;border-radius:50%;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all .15s}
.ai-input-btn:hover{background:var(--bg3);color:var(--text)}
.ai-send-btn{width:36px;height:36px;border-radius:50%;background:var(--text);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--bg);transition:all .15s}
.ai-send-btn:hover{opacity:0.85}
.ai-msg{margin-bottom:28px;display:block;clear:both}
.ai-msg-user{display:flex;justify-content:flex-end}
.ai-msg-user .ai-msg-content{background:var(--bg3);color:var(--text);border-radius:20px;padding:12px 16px;max-width:80%;font-size:15px;line-height:1.5}
.ai-msg-assistant{display:block;margin-top:32px}
.ai-msg-thinking{margin-top:40px}
.ai-msg-assistant .ai-msg-content{color:var(--text);font-size:15px;line-height:1.75}
.ai-msg-assistant .ai-msg-content p{margin:0 0 16px 0}
.ai-msg-assistant .ai-msg-content p:last-child{margin-bottom:0}
.ai-msg-assistant .ai-msg-content ul{margin:12px 0;padding-left:24px}
.ai-msg-assistant .ai-msg-content li{margin:8px 0}
.ai-msg-assistant .ai-msg-content strong{color:var(--text);font-weight:600}
.ai-welcome-insights{display:flex;flex-direction:column;gap:10px;margin:24px 0}
.ai-welcome-insight{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s}
.ai-welcome-insight:hover{background:var(--bg3);border-color:var(--text3)}
.ai-welcome-insight.critical{border-left:3px solid var(--red)}
.ai-welcome-insight.warning{border-left:3px solid var(--yellow)}
.ai-welcome-insight.info{border-left:3px solid var(--cyan)}
.ai-welcome-insight.success{border-left:3px solid var(--green)}
.ai-welcome-insight-icon{font-size:18px;line-height:1}
.ai-welcome-insight-text{flex:1}
.ai-welcome-insight-title{font-size:14px;font-weight:500;color:var(--text);margin-bottom:2px}
.ai-welcome-insight-desc{font-size:12px;color:var(--text3)}
.ai-welcome-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:24px;justify-content:center}
.ai-suggest-btn{padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:20px;font-size:13px;color:var(--text2);cursor:pointer;transition:all .15s}
.ai-suggest-btn:hover{background:var(--bg3);color:var(--text);border-color:var(--text3)}

/* Thinking indicator - pulsating dot */
.ai-thinking-orb{position:relative;width:28px;height:28px;border-radius:50%;background:var(--accent-main);display:flex;align-items:center;justify-content:center}
.ai-thinking-plus{width:12px;height:12px;position:relative;animation:icon-spin-fast 0.08s linear infinite}
.ai-thinking-plus::before,.ai-thinking-plus::after{content:'';position:absolute;background:white;border-radius:50%;width:10px;height:10px;top:50%;left:50%;transform:translate(-50%,-50%);animation:dot-pulse 1.5s ease-in-out infinite}

.ai-visual{margin:20px 0;display:block;clear:both}
.ai-mini-chart{background:var(--bg2);border-radius:12px;border:1px solid var(--border);display:block}
.ai-action-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;cursor:pointer;transition:all .15s;margin:8px 8px 8px 0}
.ai-action-btn:hover{background:var(--bg3);border-color:var(--text3)}
.ai-action-btn svg{opacity:0.6;flex-shrink:0}
.ai-action-btn:hover svg{opacity:1}
.ai-part-link,.ai-asm-link{color:var(--accent);text-decoration:none;border-bottom:1px solid transparent}
.ai-part-link:hover,.ai-asm-link:hover{border-bottom-color:var(--accent)}
.btn-tell{background:var(--accent-main);color:white;border:none;border-radius:9px}
.btn-tell:hover{opacity:0.9}
.ai-conversation{display:flex;flex-direction:column;gap:28px}
.ai-message{font-size:15px;line-height:1.8}
.ai-message.user{color:#888;font-size:14px}
.ai-user-label{color:#60a5fa;font-weight:500}
.ai-message.assistant{color:#e0e0e0}
.ai-message.assistant p{margin:0 0 16px 0}
.ai-message.assistant p:last-child{margin-bottom:0}
.modal{background:var(--bg2);width:100%;max-width:400px;max-height:85vh;overflow-y:auto;border-radius:16px;border:none;box-shadow:0 16px 48px rgba(0,0,0,.25);-webkit-overflow-scrolling:touch}
.modal-head{padding:16px 18px;display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px;letter-spacing:-0.2px}
.modal-close{width:28px;height:28px;background:var(--bg3);border:none;border-radius:8px;color:var(--text2);font-size:14px;cursor:pointer;transition:all .15s}
.modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-body{padding:4px 18px 18px}
.modal-foot{padding:14px 18px;background:var(--bg3);display:flex;gap:8px;border-radius:0 0 14px 14px}
.modal-foot .btn{flex:1;height:36px}
.field{margin-bottom:14px}
.field-label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:6px;letter-spacing:0.2px}
.field-input,.field-select,.field-textarea{width:100%;height:38px;padding:0 12px;font-size:14px;color:var(--text);background:var(--bg);border:none;border-radius:10px}
.field-input:focus,.field-select:focus{outline:none;box-shadow:0 0 0 3px rgba(10,132,255,.3)}
.field-input[type="date"]{cursor:pointer;padding-right:12px;color-scheme:dark}
.field-input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer;filter:invert(0.8);opacity:1;width:24px;height:24px;padding:4px;border-radius:4px;background-color:var(--bg3)}
.field-input[type="date"]::-webkit-calendar-picker-indicator:hover{background-color:var(--bg4)}
.field-textarea{height:60px;padding:10px 12px;resize:none}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.notify-btn{width:100%;height:38px;margin-top:14px;background:var(--bg3);border:none;border-radius:10px;color:var(--yellow);font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
.notify-btn:hover{background:var(--bg4)}.notify-btn:disabled{opacity:.4;cursor:not-allowed}
.toast-box{position:fixed;bottom:16px;left:16px;right:16px;z-index:1100;pointer-events:none}

/* Login Screen - Clean minimal style */
.login-screen{position:fixed;inset:0;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;padding:20px}
.login-box{background:#f5f5f4;border-radius:16px;padding:28px 24px;width:100%;max-width:320px;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.login-logo{font-size:15px;font-weight:500;text-align:center;margin-bottom:20px;color:#1a1a1a;letter-spacing:-0.2px}
.login-subtitle{display:none}
.login-icon{display:none}
.login-divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:#888;font-size:12px}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:#ddd}
.login-field{margin-bottom:12px}
.login-field label{display:none}
.login-field input{width:100%;height:44px;padding:0 14px;font-size:14px;color:#1a1a1a;background:#fff;border:1px solid #d4d4d4;border-radius:8px;outline:none;transition:border-color .15s}
.login-field input::placeholder{color:#888}
.login-field input:focus{border-color:#1a1a1a}
.login-btn{width:100%;height:44px;font-size:14px;font-weight:500;color:#fff;background:#1a1a1a;border:none;border-radius:8px;cursor:pointer;transition:all .15s}
.login-btn:hover{background:#333}
.login-btn:active{transform:scale(0.98)}
.login-btn:disabled{opacity:0.5;cursor:not-allowed}
.login-btn-outline{width:100%;height:44px;font-size:14px;font-weight:500;color:#1a1a1a;background:#fff;border:1px solid #d4d4d4;border-radius:8px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px}
.login-btn-outline:hover{background:#f9f9f9;border-color:#bbb}
.login-btn-outline svg{width:18px;height:18px}
.login-footer{font-size:11px;color:#888;text-align:center;margin-top:16px;line-height:1.5}
.login-footer a{color:#666;text-decoration:underline}
.login-error{color:#dc2626;font-size:12px;text-align:center;margin-top:8px;min-height:16px}
.login-status{font-size:11px;color:#888;text-align:center;margin-top:16px}
.sync-indicator{position:fixed;top:62px;right:74px;padding:6px 12px;background:var(--bg2);border-radius:8px;font-size:11px;color:var(--text2);display:flex;align-items:center;gap:6px;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.2);opacity:0;transform:translateY(-5px);transition:opacity 0.4s ease,transform 0.4s ease;pointer-events:none}
.sync-indicator.active{opacity:1;transform:translateY(0);pointer-events:auto}
.sync-indicator.syncing{color:var(--yellow)}
.sync-indicator.syncing .sync-dot{animation:spin 1s linear infinite;border:2px solid var(--yellow);border-top-color:transparent;background:transparent}
.sync-indicator.synced{color:var(--green)}
.sync-indicator.offline{color:var(--red)}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.offline-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:2001;padding:20px}
.offline-overlay.active{display:flex}
.offline-box{background:#f5f5f4;border-radius:20px;padding:40px 32px;width:100%;max-width:360px;box-shadow:0 12px 48px rgba(0,0,0,.3);text-align:center}
.offline-icon{margin-bottom:20px;color:#c07070}
.offline-title{font-size:20px;font-weight:600;color:#1a1a1a;margin-bottom:8px}
.offline-message{font-size:14px;color:#666;margin-bottom:24px}
.offline-spinner{width:32px;height:32px;border:3px solid #e0e0e0;border-top-color:#c07070;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
.offline-hint{font-size:12px;color:#888;line-height:1.5}
.offline-pending{font-size:13px;font-weight:600;color:#1a1a1a;margin-bottom:16px;padding:8px 16px;background:#e8e8e8;border-radius:8px}

/* Online indicator */
.online-badge{display:flex;align-items:center;gap:6px;padding:5px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text2);position:relative;cursor:pointer}
.online-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* Chat Panel */
/* Online hover card */
.online-hover{position:absolute;top:100%;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:400;display:none}
.online-badge:hover .online-hover{display:block}
.online-user{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px}
.online-user-dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.online-user-name{flex:1;color:var(--text)}
.online-user-time{font-size:10px;color:var(--text3)}

/* Part comments */
.comment-btn{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;padding:2px 4px;border-radius:4px;display:flex;align-items:center;gap:3px}
.comment-btn:hover{color:var(--accent);background:var(--bg4)}
.comment-btn.has-comments{color:var(--accent)}
.comment-count{font-size:10px}
.comments-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:320px;max-height:400px;display:flex;flex-direction:column;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.comments-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.comments-header{padding:14px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center;color:var(--text)}
.comments-header button{background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px}
.comments-header button:hover{background:var(--bg3);color:var(--text)}
.comments-list{flex:1;overflow-y:auto;padding:12px;max-height:240px}
.comment-item{padding:10px 12px;background:var(--bg);border-radius:10px;margin-bottom:8px;font-size:12px}
.comment-item:last-child{margin-bottom:0}
.comment-author{font-weight:600;color:var(--accent);margin-bottom:2px}
.comment-text{color:var(--text);line-height:1.4}
.comment-time{font-size:9px;color:var(--text3);margin-top:4px}
.comments-input{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px}
.comments-input input{flex:1;height:36px;padding:0 12px;font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)}
.comments-input input:focus{border-color:var(--accent);outline:none}
.comments-input button{padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:500;cursor:pointer;transition:background .15s}
.comments-input button:hover{background:var(--accent-hover)}
.comments-empty{text-align:center;color:var(--text3);padding:30px 20px;font-size:12px;font-style:italic}

/* Item Code Configuration */
.item-config-list{max-height:300px;overflow-y:auto;margin:12px 0;border:1px solid var(--border);border-radius:8px}
.item-config-row{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);align-items:center}
.item-config-row:last-child{border-bottom:none}
.item-config-row.header{background:var(--bg3);font-weight:600;font-size:11px;color:var(--text2);position:sticky;top:0}
.item-config-code{font-weight:500;font-size:12px}
.item-config-code small{display:block;font-weight:400;color:var(--text3);font-size:10px;margin-top:2px}
.item-config-badges{display:flex;gap:4px;flex-wrap:wrap}
.item-config-badge{padding:2px 6px;border-radius:4px;font-size:10px;background:var(--bg4);color:var(--text2)}
.item-config-badge.active{background:var(--accent);color:#fff}
.item-config-badge.skip{background:var(--bg4);color:var(--text3);text-decoration:line-through}
.item-config-actions button{padding:4px 8px;font-size:11px;background:var(--bg4);border:none;border-radius:4px;color:var(--text2);cursor:pointer}
.item-config-actions button:hover{background:var(--accent);color:#fff}
.item-config-empty{text-align:center;padding:30px;color:var(--text3);font-size:12px}
.item-config-form{display:grid;gap:10px;padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:12px}
.item-config-form label{font-size:11px;color:var(--text2);margin-bottom:2px}
.item-config-form input[type="text"],.item-config-form select{width:100%;padding:8px 10px;font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.item-config-form .checkbox-row{display:flex;align-items:center;gap:8px;padding:6px 0}
.item-config-form .checkbox-row input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.item-config-form .checkbox-row label{font-size:12px;color:var(--text);margin:0}
.item-config-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.item-config-form .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.item-config-form button{padding:8px 16px;font-size:12px;border:none;border-radius:6px;cursor:pointer}
.item-config-form button.primary{background:var(--accent);color:#fff}
.item-config-form button.secondary{background:var(--bg4);color:var(--text2)}

.nav-preview-item{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);gap:10px}
.nav-preview-item:last-child{border-bottom:none}
.nav-preview-item.no-match{opacity:0.5}
.nav-preview-name{flex:1;font-size:12px;font-weight:500;min-width:0}
.nav-preview-name .match{color:var(--green);font-size:10px;margin-left:6px}
.nav-preview-name .no-match{color:var(--text3);font-size:10px;margin-left:6px}
.nav-preview-po{font-size:11px;color:var(--accent);font-weight:500}
.nav-preview-eta{font-size:10px;color:var(--text2)}
.nav-preview-status{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg3)}
.nav-preview-status.will-receive{background:#1a3a2f;color:#6ee7b7}
.nav-preview-status.will-update{background:#3b3000;color:#fbbf24}

.po-details-popover{min-width:320px;max-width:400px;padding:0}
.po-details-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
.po-details-number{font-weight:600;font-size:14px}
.po-details-supplier{font-size:12px;color:var(--text2)}
.po-details-dates{display:flex;gap:16px;padding:10px 14px;font-size:11px;color:var(--text2);border-bottom:1px solid var(--border)}
.po-details-table{padding:8px 0}
.po-details-thead{display:grid;grid-template-columns:1fr 60px 70px;padding:4px 14px;font-size:10px;color:var(--text3);text-transform:uppercase;border-bottom:1px solid var(--border)}
.po-details-tbody{max-height:180px;overflow-y:auto}
.po-details-row{display:grid;grid-template-columns:1fr 60px 70px;padding:8px 14px;font-size:12px;align-items:center;border-bottom:1px solid var(--bg3)}
.po-details-row:last-child{border-bottom:none}
.po-details-row .item-name{display:flex;flex-direction:column;gap:2px}
.po-details-row .item-code{font-size:10px;color:var(--text3)}
.po-details-row .qty{text-align:center}
.po-details-row .status{display:flex;align-items:center;gap:4px}
.po-details-row .status.received{color:var(--green)}
.po-details-row .status.pending{color:var(--text3)}
.po-details-summary{padding:10px 14px;background:var(--bg3);font-size:12px;display:flex;justify-content:space-between;align-items:center}
.po-details-summary .progress-bar{width:100px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.po-details-summary .progress-fill{height:100%;background:var(--green);border-radius:3px}
.po-details-actions{padding:10px 14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end}
.po-details-actions .btn{font-size:11px;padding:6px 12px}

.toast{padding:14px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;font-size:14px;margin-top:10px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
.toast.success{border-left:3px solid var(--green)}.toast.err{border-left:3px solid var(--red)}
.dropdown{position:relative;z-index:1002}
.dropdown-menu{display:none;position:absolute;top:calc(100% + 8px);right:0;background:var(--bg2);border:1px solid var(--border);border-radius:14px;min-width:220px;z-index:1002;overflow:hidden;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);padding:6px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1)}
.dropdown-menu.open{display:block;opacity:1;transform:translateY(0) scale(1)}
.dropdown-item{padding:11px 16px;font-size:13px;font-weight:500;cursor:pointer;color:var(--text2);transition:all .15s;display:flex;align-items:center;gap:12px;border-radius:8px;margin:2px 0}
.dropdown-item:hover{background:var(--bg3);color:var(--text)}.dropdown-item.danger{color:var(--red)}
.dropdown-div{height:1px;background:var(--border);margin:8px 10px}
.team-list{margin-top:12px}
.team-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg);border-radius:10px;margin-bottom:6px;font-size:13px}
.team-item-info{flex:1}
.team-item-del{width:22px;height:22px;background:transparent;border:none;border-radius:6px;color:var(--red);cursor:pointer;font-size:12px;transition:all .15s}
.team-item-del:hover{background:rgba(255,69,58,.15)}
.eta-popover{min-width:320px;max-width:380px;padding:0}
.eta-popover-header{display:flex;flex-direction:column;gap:2px;padding:12px 14px;border-bottom:1px solid var(--border)}
.eta-popover-name{font-weight:600;font-size:14px}
.eta-popover-code{font-size:11px;color:var(--text3)}
.eta-popover-history{padding:10px 14px;border-bottom:1px solid var(--border)}
.eta-popover-history-title{font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:8px}
.eta-popover-history-empty{font-size:12px;color:var(--text3);padding:8px 0}
.eta-popover-history-item{display:flex;justify-content:space-between;font-size:12px;color:var(--text2);padding:4px 0}
.eta-popover-avg{display:flex;justify-content:space-between;font-size:12px;font-weight:500;padding:8px 0;margin-top:4px;border-top:1px solid var(--border)}
.eta-popover-input{padding:12px 14px}
.eta-popover-input label{font-size:11px;color:var(--text2);display:block;margin-bottom:6px}
.eta-popover-input input{width:100%;height:34px;padding:0 10px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:6px}
.eta-popover-actions{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.part-info-popover{min-width:300px;max-width:360px;padding:0}
.part-info-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
.part-info-name{font-weight:600;font-size:14px;color:var(--text)}
.part-info-body{padding:12px 14px;font-size:12px}
.part-info-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
.part-info-row:last-child{border-bottom:none}
.part-info-label{color:var(--text3)}
.part-info-value{color:var(--text);font-weight:500;text-align:right}
.part-info-value.status{padding:2px 8px;border-radius:4px;font-size:11px}
.part-info-value.pending{background:rgba(138,138,130,.1);color:var(--s0)}
.part-info-value.to-order{background:rgba(192,128,128,.1);color:var(--s1)}
.part-info-value.ordered{background:rgba(196,134,106,.1);color:var(--s2)}
.part-info-value.arrived{background:rgba(191,160,96,.1);color:var(--s3)}
.part-info-value.tested{background:rgba(160,144,180,.1);color:var(--s4)}
.part-info-value.configured{background:rgba(122,172,180,.1);color:var(--s5)}
.part-info-value.installed{background:rgba(127,184,127,.1);color:var(--s6)}
.part-info-notes{margin-top:8px;padding:8px;background:var(--bg);border-radius:6px;font-size:11px;color:var(--text2);line-height:1.5}
.part-info-footer{padding:10px 14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end}
.part-info-footer .btn-sm{height:28px;padding:0 12px;font-size:11px}
.pending-popover{width:280px;padding:0}
.pending-popover-header{padding:14px;font-size:14px;font-weight:600;border-bottom:1px solid var(--border)}
.pending-popover-note{padding:12px}
.pending-popover-note textarea{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;color:var(--text);resize:none;font-family:inherit}
.pending-popover-note textarea:focus{outline:none;border-color:var(--accent)}
.pending-popover-actions{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.pending-popover-actions .btn{height:32px;padding:0 14px;font-size:12px}
.status-badge.pending.has-note::after{content:'';display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;margin-left:6px;vertical-align:middle}
.bom-modal{max-width:450px}
.bom-list{max-height:200px;overflow-y:auto;margin-bottom:12px}
.bom-item{display:flex;align-items:center;padding:8px 10px;background:var(--bg);border-radius:4px;margin-bottom:4px;cursor:pointer}
.bom-item:hover{background:var(--bg3)}
.bom-item-info{flex:1}
.bom-item-name{font-weight:600;font-size:12px}
.bom-item-meta{font-size:10px;color:var(--text3)}
.bom-item-del{width:20px;height:20px;background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--red);cursor:pointer;font-size:10px}
.leadtime-modal{max-width:500px}
.lt-item{background:var(--bg);border-radius:6px;padding:10px;margin-bottom:8px}
.itemconfig-modal{max-width:600px}
.itemconfig-list{max-height:350px;overflow-y:auto}
.itemconfig-item{background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px}
.itemconfig-item-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.itemconfig-code{font-weight:600;font-size:14px;flex:1;color:var(--accent)}
.itemconfig-del{width:24px;height:24px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--red);cursor:pointer;font-size:12px}
.itemconfig-options{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.itemconfig-opt{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg2);border-radius:6px}
.itemconfig-opt label{font-size:11px;color:var(--text2);flex:1}
.itemconfig-opt input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.itemconfig-opt select{flex:1;padding:4px 6px;font-size:11px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text)}
.itemconfig-add{display:flex;gap:8px;margin-bottom:12px;padding:12px;background:var(--bg);border-radius:8px}
.itemconfig-add input{flex:1;height:32px;padding:0 10px;font-size:12px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.itemconfig-add button{padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer}
.itemconfig-empty{text-align:center;padding:30px;color:var(--text3);font-size:13px}
.otd-modal{max-width:500px}
.otd-item{display:flex;align-items:center;background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px}
.otd-mfr{font-weight:600;font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.otd-stats{display:flex;gap:16px;align-items:center}
.otd-stat{text-align:center}
.otd-stat-val{font-size:16px;font-weight:600;display:block}
.otd-stat-label{font-size:10px;color:var(--text3)}
.otd-bar{width:60px;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}
.otd-bar-fill{height:100%;border-radius:3px}
.otd-empty{text-align:center;color:var(--text3);padding:30px}
.lt-code{font-weight:600;font-size:12px;margin-bottom:6px;color:var(--accent)}
.lt-stats{display:flex;gap:12px;font-size:10px;align-items:center}
.lt-stat-val{font-size:14px;font-weight:700;color:var(--purple)}
.lt-samples{font-size:9px;color:var(--text3)}

/* Tablet styles */
@media(max-width:1024px){
  .header-metrics{gap:6px}
  .hm{padding:6px 10px}
  .hm-progress{min-width:140px}
  .hm-bar{width:80px}
  .header-search{width:180px}
  .ai-console-btn{padding:8px 14px;font-size:12px}
}

/* Mobile styles */
@media(max-width:768px){
  html,body{overflow-x:hidden!important}
  .header{height:50px;padding:0 12px;gap:8px;overflow:hidden}
  .logo{min-width:60px;max-width:100px;font-size:14px}
  .header-search{display:none}
  .header-metrics{display:none}
  .ai-console-btn{display:none}
  .header-spacer{display:none}
  .header-btns .btn span{display:none}
  .header-btns .btn{padding:0 8px;min-width:36px;justify-content:center}
  .header-btns{gap:2px}
  .version-badge{font-size:9px;padding:2px 6px}
  .main{padding:8px 10px;padding-top:58px;overflow-x:hidden}
  .pipeline{gap:4px;margin-bottom:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0}
  .pipe{min-width:60px;padding:8px 6px;border-radius:10px;flex-shrink:0}
  .pipe-count{font-size:16px}
  .pipe-label{font-size:8px}
  .tabs{margin-bottom:8px;padding:2px;gap:1px;flex-shrink:0}
  .tab{height:32px;font-size:12px;padding:0 8px}
  .data-table{border-radius:10px;overflow:hidden}
  .table-header{height:32px;padding:0 8px;font-size:9px}
  .parts-grid{grid-template-columns:24px 1fr 60px 60px minmax(80px,1fr) 32px!important}
  .asm-row{height:38px;padding:0 8px}
  .part-row{height:36px;padding:0 8px}
  .parts-grid>div:nth-child(n+10){display:none}
  .bulk-bar{padding:10px 14px;gap:10px}
  .bulk-bar-count{font-size:11px}
  .bulk-bar-actions{gap:4px}
  .bulk-bar .btn{height:30px;padding:0 12px;font-size:11px}
  .col-subpart,.col-code,.col-mfr,.col-qty,.col-assignee,.col-eta,.col-notes{display:none!important}
  .asm-priority{display:none}
  .asm-name{font-size:13px}
  .asm-meta{font-size:10px}
  .asm-toggle{font-size:10px}
  .cell{font-size:12px}
  .status-badge{font-size:9px;padding:3px 6px}
  .sm-btn{width:28px;height:28px}
  .adv-btn{width:28px;height:28px}
  .subpart-add{display:none}
  .add-row{padding:4px!important;padding-left:12px!important}
  .add-row-btn{width:20px;height:20px;font-size:12px}
  .card{padding:12px;border-radius:10px}
  .card-title{font-size:13px}
  .progress-row{grid-template-columns:1fr!important;gap:10px}
  .progress-layout-full{gap:10px}
  .gantt-container{display:none}
  [data-tab="gantt"]{display:none}
  .ins-group-title{font-size:10px}
  .ins-label{font-size:11px}
  .ins-val{font-size:13px}
  .toolbar{gap:8px;flex-wrap:wrap}
  .toolbar .search{width:100%;max-width:none}
  .toolbar .filter-select{width:100%}
  .toolbar .btn{flex:1;min-width:80px}
  .action-row{grid-template-columns:1fr 70px 70px 28px!important}
  .action-row>div:nth-child(2),.action-row>div:nth-child(3),.action-row>div:nth-child(5){display:none}
  .action-task{font-size:12px}
  .action-status{font-size:9px;padding:3px 6px}
  .filter-badges{flex-wrap:wrap}
  .filter-badge{font-size:10px}
  .modal{max-width:calc(100vw - 32px);max-height:calc(100vh - 32px);border-radius:14px}
  .modal-head{padding:14px 16px}
  .modal-title{font-size:15px}
  .modal-body{padding:4px 16px 16px}
  .modal-foot{padding:12px 16px}
  .field-label{font-size:11px}
  .field-input,.field-select,.field-textarea{font-size:16px;height:44px;border-radius:8px}
  .field-textarea{height:80px}
  .field-row{flex-direction:column;gap:8px}
  .modal-foot .btn{height:44px;font-size:14px}
  .toast{font-size:12px;padding:10px 14px}
  .dropdown-menu{right:0;left:auto;min-width:180px}
  .theme-card{padding:10px}
  .theme-name{font-size:11px}
  .burndown-container{height:140px}
  .report-content{font-size:13px}
  .notes-cell{display:none}
}

/* Small mobile styles */
@media(max-width:480px){
  .header{height:48px;padding:0 10px}
  .logo{font-size:13px;min-width:50px;max-width:80px}
  .header-btns .btn{padding:0 8px;height:32px;min-width:32px}
  .main{padding:6px 8px;padding-top:54px}
  .pipeline{gap:3px;margin-bottom:6px;padding-bottom:4px}
  .pipe{min-width:56px;padding:6px 4px;border-radius:8px}
  .pipe-count{font-size:14px}
  .pipe-label{font-size:7px;letter-spacing:0}
  .tabs{margin-bottom:6px}
  .tab{height:30px;font-size:11px;padding:0 6px}
  .parts-grid{grid-template-columns:20px 1fr minmax(60px,1fr) 30px!important}
  .asm-row{height:36px}
  .part-row{height:34px}
  .part-checkbox{width:14px;height:14px}
  .bulk-bar{padding:8px 12px;gap:8px}
  .bulk-bar .btn{height:28px;font-size:10px;padding:0 10px}
  .asm-name{font-size:12px}
  .cell{font-size:11px}
  .status-badge{font-size:8px;padding:2px 5px}
  .sm-btn{width:26px;height:26px;font-size:10px}
  .adv-btn{width:26px;height:26px;font-size:10px}
  .action-row{grid-template-columns:1fr 60px 26px!important}
  .action-task{font-size:11px}
  .modal{border-radius:12px;margin:8px}
  .modal-head{padding:12px 14px}
  .modal-body{padding:4px 14px 14px}
  .modal-foot{padding:10px 14px;flex-direction:column;gap:8px}
  .modal-foot .btn{width:100%}
  .field-input,.field-select,.field-textarea{height:44px;font-size:16px}
  .modal-foot .btn{height:44px;font-size:14px}
  .progress-top{gap:8px}
  .card{padding:10px}
  .ins-row{padding:6px 0}
  .burndown-container{height:120px}
  .forecast-card{padding:10px}
  .forecast-date{font-size:16px}
}

/* Touch improvements */
@media(hover:none){
  .btn:hover,.sm-btn:hover,.adv-btn:hover,.pipe:hover,.tab:hover,.action-row:hover,.part-row:hover,.asm-row:hover{transform:none;filter:none}
  .btn:active,.sm-btn:active,.adv-btn:active{transform:scale(0.95);opacity:0.8}
  .pipe:active,.tab:active{background:var(--bg4)}
}

/* Safe area for notched devices */
@supports(padding:max(0px)){
  .header{padding-left:max(12px,env(safe-area-inset-left));padding-right:max(12px,env(safe-area-inset-right))}
  .main{padding-left:max(10px,env(safe-area-inset-left));padding-right:max(10px,env(safe-area-inset-right));padding-bottom:max(10px,env(safe-area-inset-bottom))}
  .modal{margin-bottom:env(safe-area-inset-bottom)}
}
</style>
</head>
<body>
<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
<div class="login-logo">EF Final Assembly</div>
<button class="login-btn-outline" id="loginQuick"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>Continue as Guest</button>
<div class="login-divider">OR</div>
<div class="login-field">
<input type="password" id="loginCode" placeholder="Enter access code" autocomplete="off">
</div>
<button class="login-btn" id="loginBtn">Continue with code</button>
<div class="login-error" id="loginError"></div>
<div class="login-status" id="loginStatus">Connecting...</div>
</div>
</div>

<!-- Sync Indicator -->
<div class="sync-indicator" id="syncIndicator"><div class="sync-dot"></div><span id="syncText">Synced</span></div>

<!-- Offline Overlay -->
<div class="offline-overlay" id="offlineOverlay">
<div class="offline-box">
<div class="offline-icon">
  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
    <path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55M5 12.55a10.94 10.94 0 0 1 5.17-2.39M10.71 5.05A16 16 0 0 1 22.58 9M1.42 9a15.91 15.91 0 0 1 4.7-2.88M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/>
  </svg>
</div>
<div class="offline-title">Connection Lost</div>
<div class="offline-message">Waiting for connection to be restored...</div>
<div class="offline-spinner"></div>
<div class="offline-pending" id="offlinePending"></div>
<div class="offline-hint">Your changes are saved locally and will sync when reconnected.</div>
</div>
</div>

<header class="header">
<div class="logo" id="projectName">EBS v2</div>
<button class="ai-console-btn" id="aiAlert" title="AI Console"><div class="ai-console-icon"><span class="ai-console-plus"></span></div>AI Console</button>
<div class="header-spacer"></div>
<select class="filter-select" id="assigneeFilter"><option value="">All Assignees</option></select>
<button class="toggle-btn" id="expandToggle"><span class="arrow">â–¼</span> Expand</button>
<div class="header-spacer"></div>
<div class="online-badge"><div class="online-dot"></div><span id="onlineCount">1 online</span><div class="online-hover" id="onlineHover"><div id="onlineUserList"></div></div></div>
<div class="header-spacer"></div>
<div class="header-search"><input type="text" id="headerSearch" placeholder="Search parts..."><button class="header-search-clear" id="headerSearchClear">Ã—</button></div>
<div class="header-spacer"></div>
<div class="header-metrics" id="headerMetrics" onclick="window.toggleMetricsPopover(event)">
<div class="hm"><div><div class="hm-label">Ready</div><div class="hm-value" id="sReady">0/0</div></div></div>
<div class="hm" id="hmDays" style="display:none"><div><div class="hm-label">Days</div><div class="hm-value" id="sDays">â€”</div></div></div>
<div class="hm hm-progress" id="hmProgress"><div><div class="hm-label">Progress</div><div class="hm-value" id="sPct">0%</div></div><div class="hm-bar"><div class="hm-bar-fill" id="sBar"></div></div></div>
</div>
<div class="header-btns">
<button class="btn" id="themeBtn"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5.5"/><path d="M8 2.5v11M8 2.5a5.5 5.5 0 0 1 0 11" fill="currentColor" stroke="none"/></svg></button>
<button class="btn btn-receive" id="receivePOBtn"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M8 2v9M4.5 7.5 8 11l3.5-3.5M3 13h10"/></svg><span>Receive PO</span></button>
<button class="btn btn-report" id="reportBtn"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><rect x="2.5" y="2" width="11" height="12" rx="1.5"/><path d="M5 5.5h6M5 8h6M5 10.5h3"/></svg><span>Report</span></button>
<div class="dropdown"><button class="btn" id="menuBtn">â˜°</button><div class="dropdown-menu" id="menuDrop"><div class="dropdown-item" id="teamBtn">Team</div><div class="dropdown-item" id="datesBtn">Project Dates</div><div class="dropdown-item" id="leadtimeBtn">Lead Time Data</div><div class="dropdown-item" id="itemConfigBtn">Item Code Config</div><div class="dropdown-div"></div><div class="dropdown-item" id="navImportBtn">ðŸ“¥ Import NAV Data</div><div class="dropdown-div"></div><div class="dropdown-item" id="sampleBtn">Reset to Sample Data</div><div class="dropdown-div"></div><div class="dropdown-item danger" id="clearBtn">Clear All</div><div class="dropdown-div"></div><div class="dropdown-item" id="signOutBtn">Sign Out</div></div></div>
</div>
</header>
<main class="main">
<aside class="sidebar">
<div class="sidebar-section">
<div class="tabs">
<button class="tab active" data-tab="list"><span class="tab-icon">â˜°</span>Parts List</button>
<button class="tab" data-tab="actions"><span class="tab-icon">âœ“</span>Action Plan</button>
<button class="tab" data-tab="gantt"><span class="tab-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg></span>Timeline</button>
</div>
</div>
<div class="sidebar-section">
<div class="sidebar-label">Pipeline</div>
<div class="pipeline">
<div class="pipe" data-s="pending"><div class="pipe-count" id="p0">0</div><div class="pipe-label">Pending</div></div>
<div class="pipe" data-s="to-order"><div class="pipe-count" id="p1">0</div><div class="pipe-label">To Order</div></div>
<div class="pipe" data-s="ordered"><div class="pipe-count" id="p2">0</div><div class="pipe-label">Ordered</div></div>
<div class="pipe" data-s="arrived"><div class="pipe-count" id="p3">0</div><div class="pipe-label">Arrived</div></div>
<div class="pipe" data-s="tested"><div class="pipe-count" id="p4">0</div><div class="pipe-label">Tested</div></div>
<div class="pipe" data-s="configured"><div class="pipe-count" id="p5">0</div><div class="pipe-label">Configured</div></div>
<div class="pipe" data-s="installed"><div class="pipe-count" id="p6">0</div><div class="pipe-label">Installed</div></div>
</div>
</div>
<div style="flex:1"></div>
<div class="version-badge" id="versionBadge">v1.0.2
<div class="version-info">
<div class="version-info-row"><span class="version-info-label">Version</span><span class="version-info-value">1.0.2</span></div>
<div class="version-info-row"><span class="version-info-label">Server</span><span class="version-info-value" id="serverStatus">Firebase</span></div>
<div class="version-info-divider"></div>
<div class="version-info-row"><span class="version-info-label">Project</span><span class="version-info-value" id="infoProjectId">â€”</span></div>
<div class="version-info-row"><span class="version-info-label">User</span><span class="version-info-value" id="infoUserEmail">â€”</span></div>
<div class="version-info-divider"></div>
<div class="version-info-row"><span class="version-info-label">Last sync</span><span class="version-info-value" id="infoLastSync">â€”</span></div>
</div>
</div>
</aside>
<div class="content">
<div class="panel active" id="listPanel">
<div class="filter-badges" id="filterBadges"></div>
<div class="bulk-bar" id="bulkBar"><span class="bulk-bar-count"><span id="bulkCount">0</span> selected</span><div class="bulk-bar-actions"><button class="btn" id="bulkStatusBtn">Set Status</button><button class="btn" id="bulkAssignBtn">Set Assignee</button><button class="btn" id="bulkPOBtn">Set PO</button><button class="btn btn-danger" id="bulkDeleteBtn">Delete</button><button class="btn btn-clear" id="bulkClearBtn">âœ• Clear</button></div></div>
<div class="data-table" id="partsTable"><div class="table-header parts-grid"><div><input type="checkbox" class="part-checkbox" id="selectAllParts" title="Select all"></div><div>Name</div><div>Code</div><div>Mfr</div><div>Assignee</div><div>Qty</div><div>Status</div><div>Prog</div><div>ETA / PO</div><div>Notes</div><div></div></div><div class="table-body" id="partsList"></div></div>
<div class="empty" id="emptyList" style="display:none;">No items found</div>
</div>
<div class="panel" id="actionsPanel">
<div class="toolbar"><input type="text" class="search" id="actionSearchBox" placeholder="Search actions..."><select class="filter-select" id="actionAssigneeFilter"><option value="">All Assignees</option></select><button class="btn btn-primary" id="addActionBtn">+ Action</button></div>
<div class="data-table" id="actionsTable"><div class="table-header action-grid"><div>Task</div><div>Linked Part</div><div>Created</div><div>Progress</div><div>Due Date</div><div>Assignee</div><div>Status</div><div></div></div><div class="table-body" id="actionsList"></div></div>
<div class="empty" id="emptyActions" style="display:none;">No actions yet</div>
</div>
<div class="panel" id="progressPanel">
<div class="progress-layout-full">
<div class="progress-row">
<div class="card"><div class="card-title">Burndown Chart <a id="burndownEdit">Edit Dates</a></div><div class="burndown-container" id="burndownChart"></div><div class="burndown-dates" id="burndownDates"></div><div class="burndown-legend"><div class="legend-item"><div class="legend-dot green"></div> Ahead</div><div class="legend-item"><div class="legend-dot red"></div> Behind</div><div class="legend-item"><div class="legend-dot gray"></div> Target</div></div></div>
<div class="card"><div class="card-title">Schedule</div><div class="insights-grid">
<div class="ins-row"><span class="ins-label">Days Left</span><span class="ins-val" id="insDays">â€”</span></div>
<div class="ins-row"><span class="ins-label">Status</span><span class="ins-val" id="insStatus">â€”</span></div>
<div class="ins-row"><span class="ins-label">Expected Progress</span><span class="ins-val" id="insExpected">â€”</span></div>
<div class="ins-row"><span class="ins-label">Actual Progress</span><span class="ins-val" id="insActual">â€”</span></div>
<div class="ins-row"><span class="ins-label">Velocity</span><span class="ins-val" id="insRate">â€”</span></div>
<div class="ins-row"><span class="ins-label">Est. Completion</span><span class="ins-val" id="insEst">â€”</span></div>
</div></div>
<div class="card"><div class="card-title">Suppliers</div><div class="insights-grid">
<div class="ins-row" style="cursor:pointer" onclick="window.showOTDModal()"><span class="ins-label">ðŸšš On-Time Delivery</span><span class="ins-val" id="insOTD">â€”</span></div>
<div class="ins-row"><span class="ins-label">Avg Lead Time</span><span class="ins-val" id="insAvgLead">â€”</span></div>
<div class="ins-row"><span class="ins-label">Parts In Transit</span><span class="ins-val" id="insInTransit">â€”</span></div>
<div class="ins-row"><span class="ins-label">Awaiting Order</span><span class="ins-val" id="insToOrder">â€”</span></div>
<div class="ins-row"><span class="ins-label">Top Supplier</span><span class="ins-val" id="insTopSupplier">â€”</span></div>
<div class="ins-row"><span class="ins-label">Longest Lead</span><span class="ins-val" id="insLongestLead">â€”</span></div>
</div></div>
</div>
<div class="progress-row">
<div class="card"><div class="card-title">Assembly Progress</div><div class="asm-progress-list" id="asmProgressList"></div></div>
<div class="card"><div class="card-title">Bottlenecks</div><div class="bottleneck-list" id="bottleneckList"></div></div>
<div class="card"><div class="card-title">Velocity Forecast</div><div class="forecast-card-inner"><div class="forecast-main"><span class="forecast-date" id="forecastDate">â€”</span><span class="forecast-label" id="forecastLabel"></span></div><div class="forecast-detail" id="forecastDetail"></div></div></div>
</div>
</div>
</div>
<div class="panel" id="ganttPanel">
<div class="gantt-container">
<div class="gantt-toolbar">
<span class="gantt-toolbar-title">Project Timeline</span>
<div class="gantt-toolbar-dates">
<label class="gantt-date-label">Start</label>
<input type="date" class="gantt-date-input" id="ganttInputStart">
<span class="gantt-date-arrow">â†’</span>
<label class="gantt-date-label">End</label>
<input type="date" class="gantt-date-input" id="ganttInputEnd">
</div>
<div class="gantt-toolbar-actions">
<button class="btn btn-sm" id="ganttToday">Today</button>
</div>
</div>
<div class="gantt-header-row">
<div class="gantt-sidebar-header">
<div class="gantt-col-name">Task Name</div>
<div class="gantt-col-start">Start</div>
<div class="gantt-col-end">End</div>
<div class="gantt-col-dur">Days</div>
</div>
<div class="gantt-timeline-header-wrap" id="ganttTimelineHeaderWrap">
<div class="gantt-timeline-header" id="ganttTimelineHeader"></div>
</div>
</div>
<div class="gantt-body-wrap" id="ganttBodyWrap">
<div class="gantt-body-inner" id="ganttBodyInner">
<div class="gantt-sidebar-body" id="ganttSidebar"></div>
<div class="gantt-timeline-body" id="ganttTimelineBody"></div>
</div>
</div>
</div>
<div class="gantt-color-popup" id="ganttColorPopup">
<div class="gantt-color-title">Bar Color</div>
<div class="gantt-color-grid" id="ganttColorGrid"></div>
</div>
<div class="gantt-date-popup" id="ganttDatePopup">
<div class="gantt-date-popup-title" id="ganttDatePopupTitle">Set Date</div>
<input type="date" class="gantt-date-popup-input" id="ganttDatePopupInput">
<div class="gantt-date-popup-btns">
<button class="btn btn-sm" id="ganttDatePopupClear">Clear</button>
<button class="btn btn-sm btn-primary" id="ganttDatePopupSave">Save</button>
</div>
</div>
</div>
</div>
<div class="ai-workspace" id="aiWorkspace">
<div class="ai-workspace-conversation" id="aiWorkspaceConversation">
<div class="ai-workspace-conversation-inner">
<div class="ai-welcome-minimal">What would you like to know?</div>
</div>
</div>
<div class="ai-workspace-input-wrap">
<div class="ai-workspace-input">
<textarea id="aiWorkspaceQuestion" placeholder="Reply..." rows="1"></textarea>
<div class="ai-input-actions">
<div class="ai-model-selector-ws"><button class="ai-model-badge-ws" id="aiModelBadgeWs" onclick="window.toggleModelSelectorWs(event)">sonnet-4.5 <span style="opacity:0.5">â–¾</span></button><div class="ai-model-dropdown-ws" id="aiModelDropdownWs"><button class="ai-model-option" data-model="claude-haiku-4-5-20251001" onclick="window.selectAIModelWs(this)"><span class="model-name">Haiku 4.5</span><span class="model-desc">Fast & efficient</span></button><button class="ai-model-option active" data-model="claude-sonnet-4-5-20250929" onclick="window.selectAIModelWs(this)"><span class="model-name">Sonnet 4.5</span><span class="model-desc">Balanced</span></button><button class="ai-model-option" data-model="claude-opus-4-5-20251101" onclick="window.selectAIModelWs(this)"><span class="model-name">Opus 4.5</span><span class="model-desc">Most capable</span></button></div></div>
<button class="ai-input-btn" id="aiWorkspaceTellBtn" title="Get briefing">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg>
</button>
<button class="ai-send-btn" id="aiWorkspaceAskBtn" title="Send">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
</button>
</div>
</div>
</div>
</div>
</main>
<div class="modal-popover ai-popover ai-modal" id="aiModal"><div class="modal-head"><span class="modal-title"><span class="ai-title-icon">âœ¦</span> AI Console</span><div class="ai-model-selector"><button class="ai-model-badge" id="aiModelBadge" onclick="window.toggleModelSelector(event)">sonnet-4.5 <span style="opacity:0.5;margin-left:2px">â–¾</span></button><div class="ai-model-dropdown" id="aiModelDropdown"><button class="ai-model-option" data-model="claude-haiku-4-5-20251001" onclick="window.selectAIModel(this)"><span class="model-name">Haiku 4.5</span><span class="model-desc">Fast & efficient</span></button><button class="ai-model-option active" data-model="claude-sonnet-4-5-20250929" onclick="window.selectAIModel(this)"><span class="model-name">Sonnet 4.5</span><span class="model-desc">Balanced</span></button><button class="ai-model-option" data-model="claude-opus-4-5-20251101" onclick="window.selectAIModel(this)"><span class="model-name">Opus 4.5</span><span class="model-desc">Most capable</span></button></div></div><button class="modal-close" id="aiClose">Ã—</button></div><div class="modal-body"><div class="ai-content" id="aiContent"><div class="ai-welcome"><p>Ask any question about your project, or click <strong>Tell me</strong> for a status briefing.</p></div></div><div class="ai-input-row"><input type="text" id="aiQuestion" placeholder="Ask a question..."><button class="btn" id="aiAskBtn">Ask</button><button class="btn btn-tell" id="aiStraightBtn">Tell me</button></div></div></div>
<div class="modal-popover report-popover" id="reportModal"><div class="modal-head"><span class="modal-title">Project Status Report</span><span class="report-model-badge" id="reportModelBadge"></span><button class="report-refresh-btn" id="reportRefresh" title="Regenerate report">â†»</button><button class="modal-close" id="reportClose">Ã—</button></div><div class="modal-body"><div class="report-content" id="reportContent"></div></div><div class="modal-foot"><button class="btn" id="reportCopy">Copy</button><button class="btn btn-primary" id="reportEmail">Email</button></div></div>
<div class="popover eta-popover" id="etaPopover">
<div class="eta-popover-header"><span class="eta-popover-name" id="etaPartName"></span><span class="eta-popover-code" id="etaCode"></span></div>
<div class="eta-popover-history" id="etaHistory"></div>
<div class="eta-popover-input"><label>Expected Arrival Date</label><input type="date" id="etaDateInput"></div>
<div class="eta-popover-actions"><button class="btn" id="etaClear">Clear</button><button class="btn btn-primary" id="etaSave">Save</button></div>
</div>
<div class="modal-bg" id="bomModal"><div class="modal bom-modal"><div class="modal-head"><span class="modal-title" id="bomTitle">ðŸ’¾ Save Specification</span><button class="modal-close" id="bomClose">Ã—</button></div><div class="modal-body"><div class="field" id="bomNameField"><label class="field-label">Specification Name</label><input type="text" class="field-input" id="bomName" placeholder="e.g. Standard Control Panel"></div><div class="bom-list" id="bomList"></div></div><div class="modal-foot"><button class="btn" id="bomCancel">Cancel</button><button class="btn btn-primary" id="bomSave">Save</button></div></div></div>
<div class="modal-bg" id="leadtimeModal"><div class="modal leadtime-modal"><div class="modal-head"><span class="modal-title">ðŸ“Š Lead Time Database</span><button class="modal-close" id="ltClose">Ã—</button></div><div class="modal-body" id="ltBody"></div><div class="modal-foot"><button class="btn" id="ltClear">Clear Data</button><button class="btn btn-primary" id="ltDone">Done</button></div></div></div>
<div class="modal-bg" id="itemConfigModal"><div class="modal itemconfig-modal"><div class="modal-head"><span class="modal-title">âš™ï¸ Item Code Configuration</span><button class="modal-close" id="icClose">Ã—</button></div><div class="modal-body"><p style="font-size:12px;color:var(--text2);margin-bottom:12px">Configure testing and configuration requirements per item code. These settings persist across projects.</p><div class="itemconfig-add"><input type="text" id="icNewCode" placeholder="Enter item code..."><button id="icAddBtn">Add Code</button></div><div class="itemconfig-list" id="icList"></div></div><div class="modal-foot"><button class="btn btn-primary" id="icDone">Done</button></div></div></div>
<div class="modal-bg" id="otdModal"><div class="modal otd-modal"><div class="modal-head"><span class="modal-title">ðŸšš Supplier On-Time Delivery</span><button class="modal-close" id="otdClose">Ã—</button></div><div class="modal-body" id="otdBody"></div><div class="modal-foot"><button class="btn btn-primary" id="otdDone">Done</button></div></div></div>
<div class="popover-backdrop" id="popoverBackdrop"></div>

<!-- Metrics Popover -->
<div class="metrics-popover" id="metricsPopover">
<div class="metrics-section metrics-section-full">
<div class="metrics-section-title">Progress Chart</div>
<div class="mp-chart-container" id="mpChart"></div>
<div class="mp-chart-legend"><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--green)"></span>Ahead</span><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--red)"></span>Behind</span><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--text3)"></span>Target</span></div>
</div>
<div class="metrics-row">
<div class="metrics-section">
<div class="metrics-section-title">Velocity Forecast</div>
<div class="mp-forecast" id="mpForecast"></div>
</div>
<div class="metrics-section">
<div class="metrics-section-title">Bottlenecks</div>
<div class="mp-bottlenecks" id="mpBottlenecks"></div>
</div>
</div>
<div class="metrics-row">
<div class="metrics-section">
<div class="metrics-section-title">Schedule</div>
<div class="ins-row"><span class="ins-label">Days Left</span><span class="ins-val" id="mpDays">â€”</span></div>
<div class="ins-row"><span class="ins-label">Status</span><span class="ins-val" id="mpStatus">â€”</span></div>
<div class="ins-row"><span class="ins-label">Expected Progress</span><span class="ins-val" id="mpExpected">â€”</span></div>
<div class="ins-row"><span class="ins-label">Actual Progress</span><span class="ins-val" id="mpActual">â€”</span></div>
<div class="ins-row"><span class="ins-label">Velocity</span><span class="ins-val" id="mpRate">â€”</span></div>
<div class="ins-row"><span class="ins-label">Est. Completion</span><span class="ins-val" id="mpEst">â€”</span></div>
</div>
<div class="metrics-section">
<div class="metrics-section-title">Suppliers</div>
<div class="ins-row mp-otd-row" style="cursor:pointer" onclick="window.showOTDInline()"><span class="ins-label">ðŸšš On-Time Delivery</span><span class="ins-val" id="mpOTD">â€”</span><span class="mp-otd-arrow" id="mpOTDArrow" style="color:var(--text-muted);font-size:10px;margin-left:4px">â–¶</span></div>
<div class="mp-otd-detail" id="mpOTDDetail" style="display:none">
<div class="mp-otd-content" id="mpOTDContent"></div>
</div>
<div id="mpSupplierRows">
<div class="ins-row"><span class="ins-label">Avg Lead Time</span><span class="ins-val" id="mpAvgLead">â€”</span></div>
<div class="ins-row"><span class="ins-label">Parts In Transit</span><span class="ins-val" id="mpInTransit">â€”</span></div>
<div class="ins-row"><span class="ins-label">Awaiting Order</span><span class="ins-val" id="mpToOrder">â€”</span></div>
<div class="ins-row"><span class="ins-label">Top Supplier</span><span class="ins-val" id="mpTopSupplier">â€”</span></div>
<div class="ins-row"><span class="ins-label">Longest Lead</span><span class="ins-val" id="mpLongestLead">â€”</span></div>
</div>
</div>
</div>
</div>
<div class="modal-popover" id="partModal"><div class="modal-head"><span class="modal-title" id="pmTitle">Add Part</span><button class="modal-close" id="pmClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="pmName"></div><div class="field-row"><div class="field"><label class="field-label">Item Code</label><input type="text" class="field-input" id="pmCode"></div><div class="field"><label class="field-label">Manufacturer</label><input type="text" class="field-input" id="pmMfr"></div></div><div class="field-row"><div class="field"><label class="field-label">Qty</label><input type="number" class="field-input" id="pmQty" value="1" min="1"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="pmAssignee"></select></div></div><div class="field-row"><div class="field"><label class="field-label">Status</label><select class="field-select" id="pmStatus"><option value="pending">Pending</option><option value="to-order">To Order</option><option value="ordered">Ordered</option><option value="arrived">Arrived</option><option value="tested">Tested</option><option value="configured">Configured</option><option value="installed">Installed</option></select></div><div class="field"><label class="field-label">Assembly</label><select class="field-select" id="pmParent"></select></div></div><div class="field"><label class="field-label">Notes</label><textarea class="field-textarea" id="pmNotes"></textarea></div><button class="notify-btn" id="pmNotify" disabled>ðŸ”” Notify</button></div><div class="modal-foot"><button class="btn" id="pmCancel">Cancel</button><button class="btn btn-primary" id="pmSave">Save</button></div></div>
<div class="modal-popover" id="asmModal"><div class="modal-head"><span class="modal-title" id="amTitle">Add Assembly</span><button class="modal-close" id="amClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="amName"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="amAssignee"></select></div><div class="field"><label class="field-label">Notes</label><textarea class="field-textarea" id="amNotes"></textarea></div><button class="notify-btn" id="amNotify" disabled>ðŸ”” Notify</button></div><div class="modal-foot"><button class="btn" id="amCancel">Cancel</button><button class="btn btn-primary" id="amSave">Save</button></div></div>
<div class="modal-popover" id="actionModal"><div class="modal-head"><span class="modal-title" id="actTitle">Add Action</span><button class="modal-close" id="actClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Task</label><input type="text" class="field-input" id="actTask"></div><div class="field"><label class="field-label">Linked Part</label><select class="field-select" id="actLinkedPart"></select></div><div class="field-row"><div class="field"><label class="field-label">Due Date</label><input type="date" class="field-input" id="actDue"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="actAssignee"></select></div></div><div class="field"><label class="field-label">Status</label><select class="field-select" id="actStatus"><option value="not-started">Not Started</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div></div><div class="modal-foot"><button class="btn" id="actCancel">Cancel</button><button class="btn btn-primary" id="actSave">Save</button></div></div>
<div class="modal-bg" id="teamModal"><div class="modal"><div class="modal-head"><span class="modal-title">Team</span><button class="modal-close" id="teamClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="teamName"></div><div class="field"><label class="field-label">Email</label><input type="email" class="field-input" id="teamEmail"></div><button class="btn btn-primary" id="teamAdd" style="width:100%">Add</button><div class="team-list" id="teamList"></div></div><div class="modal-foot"><button class="btn" id="teamDone">Done</button></div></div></div>
<div class="modal-bg" id="datesModal"><div class="modal"><div class="modal-head"><span class="modal-title">Project Dates</span><button class="modal-close" id="datesClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Start</label><input type="date" class="field-input" id="startDate"></div><div class="field"><label class="field-label">End</label><input type="date" class="field-input" id="endDate"></div></div><div class="modal-foot"><button class="btn" id="datesCancel">Cancel</button><button class="btn btn-primary" id="datesSave">Save</button></div></div></div>
<div class="modal-popover theme-popover" id="themeModal"><div class="modal-head"><span class="modal-title">Theme</span><button class="modal-close" id="themeClose">Ã—</button></div><div class="modal-body"><div class="theme-grid" id="themeGrid"></div></div></div>
<div class="modal-bg" id="itemConfigModal"><div class="modal" style="max-width:500px"><div class="modal-head"><span class="modal-title">âš™ï¸ Item Code Configuration</span><button class="modal-close" id="icClose">Ã—</button></div><div class="modal-body">
<div class="item-config-form" id="icForm">
<div style="font-size:11px;color:var(--text3);margin-bottom:8px">Configure which phases apply to each item code. Settings are saved globally and reused across projects.</div>
<div><label>Item Code</label><input type="text" id="icCode" placeholder="e.g., PLC-001" style="text-transform:uppercase"></div>
<div class="form-row">
<div class="checkbox-row"><input type="checkbox" id="icReqConfig"><label for="icReqConfig">Requires Configuration</label></div>
<div class="checkbox-row"><input type="checkbox" id="icReqTest" checked><label for="icReqTest">Requires Testing</label></div>
</div>
<div class="form-row">
<div><label>Configured By</label><select id="icConfigBy"><option value="">Anyone</option></select></div>
<div><label>Tested By</label><select id="icTestBy"><option value="">Anyone</option></select></div>
</div>
<div class="form-actions"><button class="secondary" id="icClear">Clear</button><button class="primary" id="icSave">Save Configuration</button></div>
</div>
<div class="item-config-list" id="icList"></div>
</div><div class="modal-foot"><button class="btn" id="icExport">Export</button><button class="btn btn-primary" id="icDone">Done</button></div></div></div>
<div class="modal-popover po-popover" id="poModal"><div class="modal-head"><span class="modal-title">Order Details</span><button class="modal-close" id="poClose">Ã—</button></div><div class="modal-body"><div id="poPartName" style="font-weight:600;margin-bottom:12px;font-size:14px"></div><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="poNumber" placeholder="e.g. PO-2024-001"></div><div class="field"><label class="field-label">Expected Arrival Date</label><input type="date" class="field-input" id="poArrivalDate"></div><div class="po-note">Leave arrival date empty to use historical lead time data</div></div><div class="modal-foot"><button class="btn" id="poCancel">Cancel</button><button class="btn btn-primary" id="poSave">Confirm Order</button></div></div>
<div class="modal-popover receive-po-popover" id="receivePOModal"><div class="modal-head"><span class="modal-title">Receive PO</span><button class="modal-close" id="receivePOClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="receivePONumber" placeholder="Enter PO number..." list="poSuggestions"><datalist id="poSuggestions"></datalist></div><div class="receive-po-preview" id="receivePOPreview"><div class="receive-po-empty">Enter a PO number to see matching parts</div></div></div><div class="modal-foot"><button class="btn" id="receivePOCancel">Cancel</button><button class="btn btn-primary" id="receivePOConfirm" disabled>Receive All</button></div></div>
<div class="popover" id="deletePopover"><div class="popover-msg" id="deleteMsg"></div><div class="popover-btns"><button class="btn" id="deleteCancel">Cancel</button><button class="btn btn-danger" id="deleteConfirm">Delete</button></div></div>
<div class="modal-popover bulk-popover" id="bulkStatusModal"><div class="modal-head"><span class="modal-title">Set Status</span><button class="modal-close" id="bulkStatusClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkStatusPreview"></div><div class="field"><label class="field-label">New Status</label><select class="field-select" id="bulkStatusSelect"><option value="">Select status...</option><option value="pending">Pending</option><option value="to-order">To Order</option><option value="ordered">Ordered</option><option value="arrived">Arrived</option><option value="tested">Tested</option><option value="configured">Configured</option><option value="installed">Installed</option></select></div><div id="bulkPOFields" style="display:none"><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="bulkStatusPO" placeholder="e.g. PO-2024-001"></div><div class="field"><label class="field-label">Expected Arrival Date</label><input type="date" class="field-input" id="bulkStatusETA"></div></div></div><div class="modal-foot"><button class="btn" id="bulkStatusCancel">Cancel</button><button class="btn btn-primary" id="bulkStatusApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkAssignModal"><div class="modal-head"><span class="modal-title">Set Assignee</span><button class="modal-close" id="bulkAssignClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkAssignPreview"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="bulkAssignSelect"></select></div></div><div class="modal-foot"><button class="btn" id="bulkAssignCancel">Cancel</button><button class="btn btn-primary" id="bulkAssignApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkPOModal"><div class="modal-head"><span class="modal-title">Set PO Number</span><button class="modal-close" id="bulkPOClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkPOPreview"></div><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="bulkPOInput" placeholder="e.g. PO-2024-001"></div></div><div class="modal-foot"><button class="btn" id="bulkPOCancel">Cancel</button><button class="btn btn-primary" id="bulkPOApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkDeleteModal"><div class="modal-head"><span class="modal-title">Delete Parts</span><button class="modal-close" id="bulkDeleteClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkDeletePreview"></div><p style="color:var(--red);font-size:12px;margin-top:8px">This action cannot be undone.</p></div><div class="modal-foot"><button class="btn" id="bulkDeleteCancel">Cancel</button><button class="btn btn-danger" id="bulkDeleteApply">Delete All</button></div></div>
<div class="modal-bg" id="navImportModal"><div class="modal" style="max-width:600px"><div class="modal-head"><span class="modal-title">ðŸ“¥ Import NAV Data</span><button class="modal-close" id="navImportClose">Ã—</button></div><div class="modal-body">
<div style="font-size:12px;color:var(--text2);margin-bottom:16px">Import PO data exported from NAV to automatically update parts with PO numbers, expected arrival dates, and receive arrived items.</div>
<div class="field"><label class="field-label">CSV File from NAV</label><input type="file" id="navFileInput" accept=".csv,.txt" style="display:none"><button class="btn" id="navFileBtn" style="width:100%;justify-content:center">ðŸ“ Choose CSV File...</button><div id="navFileName" style="font-size:11px;color:var(--text3);margin-top:4px"></div></div>
<div id="navPreview" style="display:none;margin-top:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:13px">Preview</span><span id="navMatchCount" style="font-size:11px;color:var(--text3)"></span></div>
<div id="navPreviewList" style="max-height:280px;overflow-y:auto;background:var(--bg);border-radius:8px;border:1px solid var(--border)"></div>
<div style="margin-top:12px;display:flex;gap:8px;align-items:center"><label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="navAutoReceive" checked> Auto-receive items marked as received in NAV</label></div>
</div>
</div><div class="modal-foot"><button class="btn" id="navImportCancel">Cancel</button><button class="btn btn-primary" id="navImportApply" disabled>Import</button></div></div></div>
<div class="popover" id="statusPopover" style="min-width:140px"><div style="font-size:11px;color:var(--text3);margin-bottom:8px">Change Status</div><div id="statusPopoverOptions"></div></div>
<div class="popover pending-popover" id="pendingPopover">
  <div class="pending-popover-header">Part ready for order?</div>
  <div class="pending-popover-note">
    <textarea id="pendingNoteInput" placeholder="Add note about why part is pending..." rows="3"></textarea>
  </div>
  <div class="pending-popover-actions">
    <button class="btn" id="pendingNo">Not Yet</button>
    <button class="btn btn-primary" id="pendingYes">Yes, Ready â†’</button>
  </div>
</div>
<div class="popover part-info-popover" id="partInfoPopover">
  <div class="part-info-header">
    <span class="part-info-name" id="partInfoName"></span>
    <button class="modal-close" onclick="$('partInfoPopover').classList.remove('open')">Ã—</button>
  </div>
  <div class="part-info-body" id="partInfoBody"></div>
  <div class="part-info-footer">
    <button class="btn btn-sm" onclick="window.goToPartFromPopover()">View in List â†’</button>
  </div>
</div>
<div class="popover po-details-popover" id="poDetailsPopover">
<div class="po-details-header"><span class="po-details-number" id="poDetailsNumber"></span><span class="po-details-supplier" id="poDetailsSupplier"></span></div>
<div class="po-details-dates"><span id="poDetailsOrdered"></span><span id="poDetailsExpected"></span></div>
<div class="po-details-table">
<div class="po-details-thead"><span>Item</span><span>Ordered</span><span>Received</span></div>
<div class="po-details-tbody" id="poDetailsList"></div>
</div>
<div class="po-details-summary" id="poDetailsSummary"></div>
<div class="po-details-actions"><button class="btn" id="poDetailsClose" style="flex:1">Close</button><button class="btn btn-receive" id="poDetailsReceiveAll">Receive All</button></div>
</div>
<div class="toast-box" id="toastBox"></div>

<!-- Chat -->
<div class="comments-popover" id="commentsPopover">
<div class="comments-header"><span id="commentsTitle">Comments</span><button id="commentsClose">Ã—</button></div>
<div class="comments-list" id="commentsList"></div>
<div class="comments-input"><input type="text" id="commentInput" placeholder="Add a note..." maxlength="200"><button id="commentAdd">Send</button></div>
</div>
<script>
(function(){

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyCuzREUYQica1pjdVgQJlXD2eh8D7Dqlo4",
  authDomain: "ebsv1-78d54.firebaseapp.com",
  databaseURL: "https://ebsv1-78d54-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ebsv1-78d54",
  storageBucket: "ebsv1-78d54.firebasestorage.app",
  messagingSenderId: "70538130924",
  appId: "1:70538130924:web:9e34e90b56e4f3f72ebcc9"
};

// Access code for the team
const ACCESS_CODE = "jaakko123";

// ============================================
// Initialize Firebase
// ============================================
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const projectRef = db.ref('project');

// ============================================
// App State
// ============================================
const STAGES=['pending','to-order','ordered','arrived','tested','configured','installed'];
const SLABELS={'pending':'Pending','to-order':'To Order','ordered':'Ordered','arrived':'Arrived','configured':'Configured','tested':'Tested','installed':'Installed'};
const ASTAGES=['not-started','in-progress','completed'];
const ALABELS={'not-started':'Not Started','in-progress':'In Progress','completed':'Completed'};

let data=[],team=[],expanded={},history=[],projectDates={start:'',end:''},actions=[],leadTimeDb={},savedBoms=[],currentProjectName='New Project',allExpanded=false;

// Item Code Configuration - saved to Firebase globally (shared across all projects)
// Structure: { 'ITEM-CODE': { requiresTesting: bool, tester: string, requiresConfig: bool, configuredBy: string } }
let itemCodeConfig={};
const ITEM_CONFIG_KEY='ebs-item-code-config';
const itemConfigRef = db.ref('itemCodeConfig');

function loadItemCodeConfig(){
  // Load from localStorage first as fallback
  try{
    const stored=localStorage.getItem(ITEM_CONFIG_KEY);
    if(stored)itemCodeConfig=JSON.parse(stored);
  }catch(e){console.warn('Failed to load item code config from localStorage',e)}
  
  // Then sync from Firebase
  itemConfigRef.on('value',snapshot=>{
    const val=snapshot.val();
    if(val){
      itemCodeConfig=val;
      // Also save to localStorage as backup
      try{localStorage.setItem(ITEM_CONFIG_KEY,JSON.stringify(itemCodeConfig))}catch(e){}
      render(); // Re-render when config changes from another client
    }
  });
}

function saveItemCodeConfig(){
  // Save to Firebase
  itemConfigRef.set(itemCodeConfig).catch(e=>console.warn('Failed to save item config to Firebase',e));
  // Also save to localStorage as backup
  try{
    localStorage.setItem(ITEM_CONFIG_KEY,JSON.stringify(itemCodeConfig));
  }catch(e){console.warn('Failed to save item code config to localStorage',e)}
}

function getItemConfig(code){
  if(!code||!itemCodeConfig[code])return{requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  return itemCodeConfig[code];
}

function getPartStages(part){
  const config=getItemConfig(part.code);
  let stages=['pending','to-order','ordered','arrived'];
  // Include tested if config requires OR part is currently tested
  if(config.requiresTesting||part.status==='tested')stages.push('tested');
  // Include configured if config requires OR part is currently configured
  if(config.requiresConfig||part.status==='configured')stages.push('configured');
  stages.push('installed');
  return stages;
}

function getNextStage(part){
  const stages=getPartStages(part);
  const currentIdx=stages.indexOf(part.status);
  if(currentIdx===-1||currentIdx>=stages.length-1)return null;
  return stages[currentIdx+1];
}
let globalCodes=[],globalMfrs=[];
let editId=null,editAsmId=null,editActId=null,editEtaPartId=null,filterStage='',filterAssignee='',filterPO='',searchQ='',actionSearchQ='',actionAssigneeFilter='',highlightActionId=null,highlightPartId=null,bomMode='save';
let selectedParts=new Set(),lastSelectedPartId=null;
let isAuthenticated=false,isConnected=false,isSyncing=false;

const $=id=>document.getElementById(id);
const esc=s=>s?String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'):'';
const toast=(msg,e)=>{const t=document.createElement('div');t.className='toast '+(e?'err':'success');t.textContent=msg;$('toastBox').appendChild(t);setTimeout(()=>t.remove(),2500)};

// ============================================
// Sync Indicator
// ============================================
function showSync(status,text){
  const ind=$('syncIndicator');
  const txt=$('syncText');
  ind.className='sync-indicator active '+status;
  txt.textContent=text||status;
  if(status==='synced')setTimeout(()=>ind.classList.remove('active'),2000);
}

let lastSyncTime=null;
function updateVersionInfo(){
  lastSyncTime=new Date();
  const timeStr=lastSyncTime.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  if($('infoLastSync'))$('infoLastSync').textContent=timeStr;
  if($('infoProjectId'))$('infoProjectId').textContent=currentProjectName?currentProjectName.substring(0,20):'â€”';
  if($('serverStatus'))$('serverStatus').textContent=isConnected?'Connected':'Offline';
}

// Version badge click handler
$('versionBadge').onclick=function(e){
  e.stopPropagation();
  const info=this.querySelector('.version-info');
  const rect=this.getBoundingClientRect();
  info.style.left=rect.left+'px';
  info.style.bottom=(window.innerHeight-rect.top+8)+'px';
  info.classList.toggle('open');
};
document.addEventListener('click',function(e){
  const info=document.querySelector('.version-info');
  if(info&&info.classList.contains('open')&&!e.target.closest('.version-badge')){
    info.classList.remove('open');
  }
});

// ============================================
// Firebase Data Operations
// ============================================
let saveTimeout=null;
let isSaving=false;
let lastSyncShow=0;
let lastLocalSaveTime=0;
let lastSaveId='';
const clientId='client-'+Math.random().toString(36).substr(2,9)+'-'+Date.now();
const SYNC_SHOW_INTERVAL=10000; // Only show sync indicator every 10 seconds max

// Granular change tracking for offline support
const pendingPartChanges = new Map(); // partId -> {fields that changed}
const pendingAsmChanges = new Map();  // asmId -> {fields that changed}
let pendingMetaChanges = false; // For team, history, projectDates, actions

// Track field-level timestamps
function updateFieldTimestamp(item, field) {
  if (!item._fieldTs) item._fieldTs = {};
  item._fieldTs[field] = Date.now();
}

// Mark a part as having pending changes
function markPartChanged(partId, changedFields) {
  if (!pendingPartChanges.has(partId)) {
    pendingPartChanges.set(partId, new Set());
  }
  changedFields.forEach(f => pendingPartChanges.get(partId).add(f));
}

// Mark an assembly as having pending changes  
function markAsmChanged(asmId, changedFields) {
  if (!pendingAsmChanges.has(asmId)) {
    pendingAsmChanges.set(asmId, new Set());
  }
  changedFields.forEach(f => pendingAsmChanges.get(asmId).add(f));
}

// Merge remote part with local part, keeping newer field values
function mergePartFields(localPart, remotePart) {
  if (!remotePart) return localPart;
  if (!localPart) return remotePart;
  
  const merged = { ...remotePart };
  const localTs = localPart._fieldTs || {};
  const remoteTs = remotePart._fieldTs || {};
  
  // For each field, keep the one with the newer timestamp
  const fields = ['name', 'code', 'mfr', 'assignee', 'qty', 'status', 'notes', 
                  'poNumber', 'orderDate', 'expectedArrival', 'actualArrival', 'parentId'];
  
  fields.forEach(field => {
    const localTime = localTs[field] || 0;
    const remoteTime = remoteTs[field] || 0;
    
    if (localTime > remoteTime && localPart[field] !== undefined) {
      merged[field] = localPart[field];
      if (!merged._fieldTs) merged._fieldTs = {};
      merged._fieldTs[field] = localTime;
    }
  });
  
  // Merge comments - keep all unique comments by timestamp
  if (localPart.comments || remotePart.comments) {
    const localComments = localPart.comments || [];
    const remoteComments = remotePart.comments || [];
    const commentMap = new Map();
    
    [...remoteComments, ...localComments].forEach(c => {
      const key = c.ts + '-' + c.author;
      if (!commentMap.has(key) || commentMap.get(key).ts < c.ts) {
        commentMap.set(key, c);
      }
    });
    
    merged.comments = Array.from(commentMap.values()).sort((a, b) => a.ts - b.ts);
  }
  
  return merged;
}

// Sync pending changes after reconnection
async function syncPendingChanges() {
  if (useLocalStorage || !isConnected || !isAuthenticated) return;
  
  const hasPending = pendingPartChanges.size > 0 || pendingAsmChanges.size > 0 || pendingMetaChanges;
  if (!hasPending) return;
  
  console.log('ðŸ”„ Syncing pending changes:', pendingPartChanges.size, 'parts,', pendingAsmChanges.size, 'assemblies');
  showSync('syncing', 'Syncing offline changes...');
  
  try {
    // Fetch current server state
    const snapshot = await projectRef.child('main').once('value');
    const serverData = snapshot.val() || {};
    const serverParts = serverData.data || [];
    
    // Create a map of server parts by ID
    const serverPartMap = new Map();
    serverParts.forEach(p => serverPartMap.set(p.id, p));
    
    // Merge local changes with server data
    const mergedData = data.map(localItem => {
      const serverItem = serverPartMap.get(localItem.id);
      
      // If this item has pending changes, merge field by field
      if (pendingPartChanges.has(localItem.id) || pendingAsmChanges.has(localItem.id)) {
        return mergePartFields(localItem, serverItem);
      }
      
      // No local changes - use server version if newer
      if (serverItem && serverItem._fieldTs) {
        return mergePartFields(localItem, serverItem);
      }
      
      return localItem;
    });
    
    // Add any server parts that don't exist locally
    serverParts.forEach(serverPart => {
      if (!data.find(d => d.id === serverPart.id)) {
        mergedData.push(serverPart);
      }
    });
    
    // Update local data
    data = mergedData;
    
    // Save merged data to server
    lastLocalSaveTime = Date.now();
    lastSaveId = clientId + '-' + Date.now();
    
    await projectRef.child('main').update({
      data, team, history, projectDates, actions, projectName: currentProjectName,
      updatedAt: firebase.database.ServerValue.TIMESTAMP,
      lastSaveId: lastSaveId
    });
    
    // Clear pending changes
    pendingPartChanges.clear();
    pendingAsmChanges.clear();
    pendingMetaChanges = false;
    
    // Save merged state to localStorage
    saveToLocalStorage();
    
    render();
    showSync('synced', 'Synced âœ“');
    console.log('âœ… Sync complete');
    
  } catch (e) {
    console.error('Sync failed:', e);
    showSync('offline', 'Sync failed');
  }
}

function save(){
  if(!isAuthenticated) return;
  
  // Always save to localStorage first (immediate, reliable)
  saveToLocalStorage();
  
  // For localStorage-only mode, we're done
  if(useLocalStorage) return;
  
  // If offline, just track that we have pending changes
  if(!isConnected) {
    console.log('ðŸ“´ Offline - changes queued for sync');
    // Update pending count display if overlay is showing
    if($('offlineOverlay').classList.contains('active')){
      const count = pendingPartChanges.size + pendingAsmChanges.size;
      const el = $('offlinePending');
      if(el){
        el.textContent = count + ' pending change' + (count > 1 ? 's' : '');
        el.style.display = 'block';
      }
    }
    return;
  }
  
  clearTimeout(saveTimeout);
  
  saveTimeout=setTimeout(()=>{
    if(isSaving) return;
    isSaving=true;
    
    // Mark this as a local save so we don't re-render when it echoes back
    lastLocalSaveTime = Date.now();
    lastSaveId = clientId + '-' + Date.now();
    
    // Only show syncing indicator if enough time has passed
    const now=Date.now();
    const showIndicator=now-lastSyncShow>SYNC_SHOW_INTERVAL;
    if(showIndicator) showSync('syncing','Syncing...');
    
    // Use update() instead of set() for safer multi-user concurrency
    projectRef.child('main').update({
      data, team, history, projectDates, actions, projectName: currentProjectName,
      updatedAt: firebase.database.ServerValue.TIMESTAMP,
      lastSaveId: lastSaveId
    }).then(()=>{
      isSaving=false;
      // Clear pending changes on successful save
      pendingPartChanges.clear();
      pendingAsmChanges.clear();
      pendingMetaChanges = false;
      recordProgress(); // Record progress after successful save
      if(showIndicator){
        lastSyncShow=Date.now();
        showSync('synced','Synced âœ“');
        setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
      }
    }).catch(e=>{
      isSaving=false;
      showSync('offline','Save failed');
      console.error(e);
    });
  },500);
}

function saveLeadTime(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('leadTime').set(leadTimeDb).catch(console.error);
}

function saveBoms(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('boms').set(savedBoms).catch(console.error);
}

function saveGlobalCodes(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('globalCodes').set(globalCodes).catch(console.error);
}

function saveGlobalMfrs(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('globalMfrs').set(globalMfrs).catch(console.error);
}

function saveExpanded(){
  // Keep expanded state local (per-user preference)
  try{localStorage.setItem('ebs-expanded',JSON.stringify(expanded))}catch(e){}
}

function loadExpanded(){
  try{const s=localStorage.getItem('ebs-expanded');if(s)expanded=JSON.parse(s)}catch(e){expanded={}}
}

function addGlobalCode(code){if(code&&!globalCodes.includes(code)){globalCodes.push(code);saveGlobalCodes()}}
function addGlobalMfr(mfr){if(mfr&&!globalMfrs.includes(mfr)){globalMfrs.push(mfr);saveGlobalMfrs()}}
function getAllCodes(){const projectCodes=[...new Set(data.filter(d=>d.code).map(d=>d.code))];return[...new Set([...globalCodes,...projectCodes])].sort()}
function getAllMfrs(){const projectMfrs=[...new Set(data.filter(d=>d.mfr).map(d=>d.mfr))];return[...new Set([...globalMfrs,...projectMfrs])].sort()}

function loadSampleBoms(){savedBoms=[{id:1,name:'Standard Control Panel',items:[{name:'Control Panel',isAsm:true},{name:'PLC CPU',code:'6ES7-1500',mfr:'Siemens',qty:1,parent:'Control Panel'}]}];saveBoms()}

function updateProjectName(){$('projectName').textContent=(currentProjectName||'EBS Cloud')+' â˜ï¸'}

// ============================================
// Authentication
// ============================================
function checkAuth(){
  const stored=sessionStorage.getItem('ebs-auth');
  return stored===ACCESS_CODE;
}

function login(code){
  if(code===ACCESS_CODE){
    sessionStorage.setItem('ebs-auth',code);
    isAuthenticated=true;
    $('loginScreen').style.display='none';
    initFirebaseListeners();
    return true;
  }
  return false;
}

function logout(){
  sessionStorage.removeItem('ebs-auth');
  isAuthenticated=false;
  location.reload();
}

// ============================================
// Firebase Real-time Listeners
// ============================================
const LOCAL_STORAGE_KEY = 'ebs-v3-data';
let useLocalStorage = false;
let dataInitialized = false;

function initFirebaseListeners(){
  showSync('syncing','Loading...');
  
  // ALWAYS check localStorage first
  const localData = loadFromLocalStorage();
  
  if(localData){
    // We have local data - use it immediately
    console.log('Loaded from localStorage');
    dataInitialized = true;
    showSync('synced','Loaded');
    setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
    
    // Try to connect to Firebase for sync
    tryFirebaseSync();
  } else {
    // No local data - try Firebase, then create sample if needed
    tryFirebaseFirst();
  }
}

function tryFirebaseFirst(){
  const timeout = setTimeout(()=>{
    // Firebase taking too long - create sample locally
    console.log('Firebase timeout, creating local sample');
    useLocalStorage = true;
    createAndSaveSampleData();
  }, 3000);
  
  projectRef.child('main').once('value').then(snapshot=>{
    clearTimeout(timeout);
    const val = snapshot.val();
    const hasData = val && val.data && (Array.isArray(val.data) ? val.data.length > 0 : Object.keys(val.data).length > 0);
    
    if(hasData){
      console.log('Loaded from Firebase');
      loadFromSnapshot(val);
      saveToLocalStorage(); // Cache locally
      dataInitialized = true;
      showSync('synced','Connected');
      setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
      setupRealtimeListener();
      
    } else {
      // Firebase empty - create sample and save to both
      console.log('Firebase empty, creating sample');
      createAndSaveSampleData();
      // Save to Firebase too
      projectRef.child('main').set({
        data, team, history, projectDates, actions, projectName: currentProjectName,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
      setupRealtimeListener();
      
    }
  }).catch(err=>{
    clearTimeout(timeout);
    console.log('Firebase error, using localStorage:', err);
    useLocalStorage = true;
    createAndSaveSampleData();
  });
}

function tryFirebaseSync(){
  projectRef.child('main').once('value').then(snapshot=>{
    const val = snapshot.val();
    if(val && val.data){
      // Firebase has data - check if newer
      console.log('Firebase connected, setting up sync');
    }
    setupRealtimeListener();
    
  }).catch(err=>{
    console.log('Firebase unavailable, local mode only');
    useLocalStorage = true;
  });
}

function loadFromLocalStorage(){
  try {
    const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
    if(saved){
      const val = JSON.parse(saved);
      if(val.data && val.data.length > 0){
        data = val.data;
        team = val.team || [];
        history = val.history || [];
        actions = val.actions || [];
        projectDates = val.projectDates || {start:'',end:''};
        currentProjectName = val.projectName || 'EBS Project';
        updateProjectName();
        render();
        return true;
      }
    }
  } catch(e){
    console.error('localStorage read error:', e);
  }
  return false;
}

function saveToLocalStorage(){
  try {
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
      data, team, history, actions, projectDates, projectName: currentProjectName
    }));
  } catch(e){
    console.error('localStorage save error:', e);
  }
}

function createAndSaveSampleData(){
  createSampleData();
  saveToLocalStorage();
  dataInitialized = true;
  showSync('synced','Ready');
  setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
  toast('Project initialized: 15 assemblies, 150 parts');
}

function createSampleData(){
  const now=Date.now(),day=86400000;
  
  currentProjectName='Industrial Automation Line - Phase 2';
  team=[
    {name:'Marisa',email:'marisa@company.com'},
    {name:'John',email:'john@company.com'},
    {name:'Sarah',email:'sarah@company.com'},
    {name:'Mike',email:'mike@company.com'}
  ];
  
  // Project: Jan 1 - June 30, 2026
  projectDates={start:'2026-01-01',end:'2026-06-30'};
  
  // Calculate "today" as somewhere in mid-project for interesting data
  // Simulating we're about 45 days into a 180-day project (~Feb 15)
  const projectStart=new Date('2026-01-01').getTime();
  const simToday=projectStart+45*day;
  
  // PO number generator
  let poCounter=4521;
  const getPO=()=>'PO-2026-'+(poCounter++);
  
  // Notes with context for interesting AI analysis
  const partNotes={
    'Robot Arm 6-Axis':'CRITICAL PATH - Long lead item. Fanuc quoted 6-8 weeks. Expedite fee available for $2,500.',
    'Safety PLC':'Customer requires Cat 3 PLd certification. Pilz confirmed compatible.',
    'Light Curtain 600mm':'Original spec was 400mm - changed per customer layout revision v3.',
    'Hydraulic Power Unit':'15HP special order (standard is 10HP). Engineering confirmed sizing.',
    'Robot Stand':'Custom fabrication in progress at MetalWorks Inc. Weekly status calls scheduled.',
    'Main Breaker 400A':'Electrician confirmed panel has space. Installation requires 4-hour shutdown.',
    '2D Camera':'Switched from Cognex to Keyence CV-X420 per demo results. Better price/performance.',
    'Air Compressor 7.5HP':'Evaluating if existing plant air (6 bar) is sufficient vs dedicated unit.',
    'VFD 15kW':'Programming requires Yaskawa specialist. Training scheduled Feb 20.',
    'Servo Motor 3kW':'ISSUE: Wrong model delivered Dec 28. RMA in progress, replacement due Feb 18.'
  };
  
  // Realistic multi-person conversations
  const partComments={
    'Robot Arm 6-Axis':[
      {text:'Fanuc confirmed build slot for Jan 15',ts:simToday-25*day,author:'John'},
      {text:'Shipment delayed - new ETA Jan 28',ts:simToday-18*day,author:'John'},
      {text:'Cleared customs today. Delivery scheduled Feb 2.',ts:simToday-12*day,author:'John'},
      {text:'Received and inspected. Minor shipping damage on cable cover - ordering replacement part.',ts:simToday-8*day,author:'Marisa'},
      {text:'Installation training booked for Feb 22-23 with Fanuc tech',ts:simToday-3*day,author:'Sarah'}
    ],
    'Safety PLC':[
      {text:'Customer confirmed Cat 3 PLd is required, not Cat 4.',ts:simToday-20*day,author:'Mike'},
      {text:'Pilz quoted 5-day delivery. Ordered today.',ts:simToday-18*day,author:'Mike'},
      {text:'Arrived. Starting safety circuit design.',ts:simToday-12*day,author:'Mike'}
    ],
    'Light Curtain 600mm':[
      {text:'Sick says 10 business days, not 7 calendar as quoted!',ts:simToday-22*day,author:'Sarah'},
      {text:'Expedite fee is $180. Should we pay it?',ts:simToday-21*day,author:'Sarah'},
      {text:'Approved by PM. Rush order placed.',ts:simToday-20*day,author:'Marisa'},
      {text:'Arrived 2 days early. Sick came through.',ts:simToday-10*day,author:'Sarah'}
    ],
    'Hydraulic Power Unit':[
      {text:'Bosch Rexroth quoted 14 days, Parker quoted 21 days. Going with Bosch.',ts:simToday-28*day,author:'Mike'},
      {text:'Oil cooler sizing verification needed before shipping.',ts:simToday-20*day,author:'John'},
      {text:'Thermal calc confirmed 24V cooler is adequate. Cleared for ship.',ts:simToday-18*day,author:'Mike'},
      {text:'Delivered to dock. Waiting for rigging crew (available Thursday).',ts:simToday-5*day,author:'John'}
    ],
    'Robot Stand':[
      {text:'MetalWorks wants 50% deposit before starting fab.',ts:simToday-30*day,author:'John'},
      {text:'Finance approved. PO sent with deposit.',ts:simToday-28*day,author:'Marisa'},
      {text:'Fabrication started. 3-week lead time.',ts:simToday-26*day,author:'John'},
      {text:'Progress photos received - looks good. On track for Feb 20.',ts:simToday-10*day,author:'John'}
    ],
    'Servo Motor 3kW':[
      {text:'Wrong model shipped! We got SM-2KW not SM-3KW.',ts:simToday-15*day,author:'Sarah'},
      {text:'RMA initiated. Yaskawa apologized, expediting replacement.',ts:simToday-14*day,author:'Sarah'},
      {text:'Replacement shipped today via overnight. Due tomorrow.',ts:simToday-3*day,author:'Sarah'}
    ],
    'HMI Panel 15"':[
      {text:'Customer wants 3 additional screens added to HMI spec.',ts:simToday-12*day,author:'John'},
      {text:'Change request logged as CR-0042. Pricing TBD.',ts:simToday-11*day,author:'Marisa'},
      {text:'CR approved at +$4,200. Updating software scope.',ts:simToday-5*day,author:'John'}
    ],
    '2D Camera':[
      {text:'Keyence demo was impressive. 0.02mm repeatability!',ts:simToday-25*day,author:'Sarah'},
      {text:'Proceeding with CV-X420. Need calibration target separately.',ts:simToday-22*day,author:'Sarah'},
      {text:'Camera arrived. Target on backorder - 2 week wait.',ts:simToday-8*day,author:'Sarah'}
    ],
    'Gripper Assembly':[
      {text:'Schunk can do 5-day if we pay express freight (+$340)',ts:simToday-20*day,author:'Marisa'},
      {text:'Express approved. Critical path item.',ts:simToday-19*day,author:'Marisa'}
    ],
    'PLC CPU S7-1500':[
      {text:'Firmware must be V2.9+ for Pilz safety integration.',ts:simToday-30*day,author:'Mike'},
      {text:'Confirmed V3.0 ships standard now. All good.',ts:simToday-28*day,author:'Mike'}
    ]
  };
  
  // Part templates with realistic status distribution
  const partTemplates=[
    {asm:'Main Control Panel',priority:1,parts:[
      {name:'PLC CPU S7-1500',code:'6ES7-1500',mfr:'Siemens',status:'tested',daysInStatus:3},
      {name:'HMI Panel 15"',code:'HMI-TP1500',mfr:'Siemens',status:'configured',daysInStatus:5},
      {name:'PSU 24V 40A',code:'PSU-24-40',mfr:'Mean Well',status:'installed',daysInStatus:8},
      {name:'DI Module 32pt',code:'IO-DI-32',mfr:'Siemens',status:'installed',daysInStatus:10},
      {name:'DO Module 32pt',code:'IO-DO-32',mfr:'Siemens',status:'installed',daysInStatus:10},
      {name:'AI Module 8ch',code:'IO-AI-8',mfr:'Siemens',status:'tested',daysInStatus:4},
      {name:'AO Module 4ch',code:'IO-AO-4',mfr:'Siemens',status:'tested',daysInStatus:4},
      {name:'Profinet Switch',code:'PN-SW-8',mfr:'Scalance',status:'installed',daysInStatus:12},
      {name:'UPS System',code:'UPS-3KVA',mfr:'APC',status:'arrived',daysInStatus:2},
      {name:'Panel Cooler',code:'PC-500W',mfr:'Rittal',status:'installed',daysInStatus:15}
    ]},
    {asm:'Conveyor Line 1',priority:2,parts:[
      {name:'Servo Motor 3kW',code:'SM-3KW-01',mfr:'Yaskawa',status:'ordered',daysInStatus:3},
      {name:'Servo Drive',code:'SD-3KW-01',mfr:'Yaskawa',status:'arrived',daysInStatus:5},
      {name:'Gearbox 15:1',code:'GB-15-1',mfr:'SEW',status:'installed',daysInStatus:8},
      {name:'Timing Belt',code:'TB-500',mfr:'Gates',status:'installed',daysInStatus:10},
      {name:'Conveyor Frame',code:'CF-3M',mfr:'Bosch',status:'installed',daysInStatus:20},
      {name:'Guide Rails',code:'GR-3M',mfr:'Bosch',status:'installed',daysInStatus:18},
      {name:'Proximity Sensors x4',code:'PS-IND-4',mfr:'IFM',status:'tested',daysInStatus:3},
      {name:'Photo Eyes x2',code:'PE-RET-2',mfr:'Banner',status:'tested',daysInStatus:3},
      {name:'Motor Cable 15m',code:'MC-15M',mfr:'Lapp',status:'installed',daysInStatus:12},
      {name:'Encoder Cable',code:'EC-10M',mfr:'Lapp',status:'arrived',daysInStatus:2}
    ]},
    {asm:'Conveyor Line 2',priority:3,parts:[
      {name:'Servo Motor 2kW',code:'SM-2KW-02',mfr:'Yaskawa',status:'tested',daysInStatus:2},
      {name:'Servo Drive 2kW',code:'SD-2KW-02',mfr:'Yaskawa',status:'tested',daysInStatus:2},
      {name:'Gearbox 10:1',code:'GB-10-2',mfr:'SEW',status:'installed',daysInStatus:6},
      {name:'V-Belt System',code:'VB-400',mfr:'Gates',status:'installed',daysInStatus:8},
      {name:'Conveyor Frame 2m',code:'CF-2M',mfr:'Bosch',status:'installed',daysInStatus:18},
      {name:'Side Guards',code:'SG-2M',mfr:'Bosch',status:'installed',daysInStatus:15},
      {name:'Inductive Sensors x6',code:'PS-IND-6',mfr:'IFM',status:'configured',daysInStatus:4},
      {name:'Reflective Sensor',code:'RS-01',mfr:'Sick',status:'tested',daysInStatus:3},
      {name:'Junction Box',code:'JB-IP65',mfr:'Wago',status:'installed',daysInStatus:12},
      {name:'Cable Tray 2m',code:'CT-2M',mfr:'Legrand',status:'installed',daysInStatus:20}
    ]},
    {asm:'Robot Cell 1',priority:4,parts:[
      {name:'Robot Arm 6-Axis',code:'RA-6AX-20',mfr:'Fanuc',status:'configured',daysInStatus:6},
      {name:'Robot Controller R30iB',code:'RC-R30IB',mfr:'Fanuc',status:'configured',daysInStatus:6},
      {name:'Gripper Assembly',code:'GRP-PNU',mfr:'Schunk',status:'tested',daysInStatus:3},
      {name:'Tool Changer',code:'TC-AUTO',mfr:'ATI',status:'arrived',daysInStatus:4},
      {name:'Vision Camera',code:'VC-2MP',mfr:'Cognex',status:'tested',daysInStatus:5},
      {name:'Vision Light',code:'VL-RING',mfr:'CCS',status:'installed',daysInStatus:10},
      {name:'Robot Pedestal',code:'RP-750',mfr:'Custom',status:'installed',daysInStatus:22},
      {name:'Safety Mat',code:'SM-1200',mfr:'Omron',status:'installed',daysInStatus:18},
      {name:'Teach Pendant Cable',code:'TPC-10M',mfr:'Fanuc',status:'arrived',daysInStatus:8},
      {name:'Robot Base Plate',code:'RBP-01',mfr:'Custom',status:'installed',daysInStatus:25}
    ]},
    {asm:'Robot Cell 2',priority:5,parts:[
      {name:'Robot Arm SCARA',code:'RA-SCARA',mfr:'Epson',status:'arrived',daysInStatus:3},
      {name:'Robot Controller RC90',code:'RC-90',mfr:'Epson',status:'arrived',daysInStatus:3},
      {name:'Vacuum Gripper',code:'VG-SUC',mfr:'Schmalz',status:'ordered',daysInStatus:8},
      {name:'Force Sensor',code:'FS-6AX',mfr:'ATI',status:'ordered',daysInStatus:12},
      {name:'2D Camera',code:'CAM-2D',mfr:'Keyence',status:'arrived',daysInStatus:6},
      {name:'Backlight Panel',code:'BL-200',mfr:'CCS',status:'tested',daysInStatus:4},
      {name:'Robot Stand',code:'RS-400',mfr:'Custom',status:'ordered',daysInStatus:18},
      {name:'Vacuum Generator',code:'VG-01',mfr:'SMC',status:'installed',daysInStatus:10},
      {name:'IO Link Master',code:'IOL-8PT',mfr:'IFM',status:'tested',daysInStatus:5},
      {name:'Cable Carrier',code:'CC-R38',mfr:'Igus',status:'installed',daysInStatus:12}
    ]},
    {asm:'Safety System',priority:6,parts:[
      {name:'Safety PLC',code:'SP-PNOZ',mfr:'Pilz',status:'configured',daysInStatus:8},
      {name:'Light Curtain 600mm',code:'LC-600',mfr:'Sick',status:'tested',daysInStatus:4},
      {name:'Light Curtain 400mm',code:'LC-400',mfr:'Sick',status:'tested',daysInStatus:4},
      {name:'E-Stop Stations x4',code:'ES-4SET',mfr:'ABB',status:'installed',daysInStatus:15},
      {name:'Safety Door Switch x3',code:'SDS-3SET',mfr:'Schmersal',status:'installed',daysInStatus:12},
      {name:'Safety Relay Module',code:'SRM-01',mfr:'Pilz',status:'tested',daysInStatus:3},
      {name:'Muting Sensors x4',code:'MS-4SET',mfr:'Sick',status:'arrived',daysInStatus:5},
      {name:'Safety Scanner',code:'SS-3M',mfr:'Sick',status:'ordered',daysInStatus:10},
      {name:'Reset Button x2',code:'RB-2SET',mfr:'ABB',status:'installed',daysInStatus:14},
      {name:'Safety Edge',code:'SE-2M',mfr:'Haake',status:'pending',daysInStatus:4,pendingNote:'Waiting for final safety assessment approval from customer'},
      {name:'Backup E-Stop',code:'ES-BK',mfr:'ABB',status:'pending',daysInStatus:6,pendingNote:'Design review scheduled for next week'}
    ]},
    {asm:'Pneumatic System',priority:7,parts:[
      {name:'Air Compressor 7.5HP',code:'AC-7HP',mfr:'Atlas Copco',status:'to-order',daysInStatus:5},
      {name:'Air Dryer',code:'AD-REF',mfr:'Atlas Copco',status:'pending',daysInStatus:8,pendingNote:'Capacity calculation pending - may need larger unit'},
      {name:'FRL Unit Large',code:'FRL-LG',mfr:'SMC',status:'installed',daysInStatus:12},
      {name:'Main Manifold',code:'MM-16PT',mfr:'SMC',status:'installed',daysInStatus:10},
      {name:'Solenoid Valves x8',code:'SV-5-8',mfr:'SMC',status:'tested',daysInStatus:3},
      {name:'Cylinders 50mm x4',code:'CYL-50-4',mfr:'Festo',status:'installed',daysInStatus:8},
      {name:'Cylinders 32mm x6',code:'CYL-32-6',mfr:'Festo',status:'tested',daysInStatus:4},
      {name:'Flow Controls x10',code:'FC-10SET',mfr:'SMC',status:'installed',daysInStatus:10},
      {name:'Air Tank 100L',code:'AT-100L',mfr:'SMC',status:'pending',daysInStatus:3,pendingNote:'Verifying mounting location with facilities team'},
      {name:'Pressure Transducer',code:'PT-0-10',mfr:'SMC',status:'installed',daysInStatus:12}
    ]},
    {asm:'Hydraulic Unit',priority:8,parts:[
      {name:'Hydraulic Power Unit',code:'HPU-15HP',mfr:'Bosch Rexroth',status:'arrived',daysInStatus:5},
      {name:'Hydraulic Manifold',code:'HM-6PT',mfr:'Custom',status:'ordered',daysInStatus:15},
      {name:'Proportional Valve',code:'PV-01',mfr:'Bosch Rexroth',status:'arrived',daysInStatus:8},
      {name:'Pressure Relief Valve',code:'PRV-210',mfr:'Sun',status:'installed',daysInStatus:10},
      {name:'Hydraulic Cylinder',code:'HC-100-500',mfr:'Parker',status:'ordered',daysInStatus:18},
      {name:'Hydraulic Hoses Set',code:'HH-SET',mfr:'Eaton',status:'arrived',daysInStatus:3},
      {name:'Oil Cooler',code:'OC-24V',mfr:'AKG',status:'arrived',daysInStatus:8},
      {name:'Hydraulic Filter',code:'HF-10UM',mfr:'Hydac',status:'installed',daysInStatus:12},
      {name:'Level Switch',code:'LS-01',mfr:'Hydac',status:'installed',daysInStatus:12},
      {name:'Pressure Gauge x2',code:'PG-2SET',mfr:'WIKA',status:'installed',daysInStatus:14}
    ]},
    {asm:'Electrical Distribution',priority:9,parts:[
      {name:'Main Breaker 400A',code:'MB-400A',mfr:'ABB',status:'installed',daysInStatus:20},
      {name:'Contactor 150A x2',code:'CT-150-2',mfr:'ABB',status:'installed',daysInStatus:18},
      {name:'Soft Starter 75kW',code:'SS-75KW',mfr:'ABB',status:'tested',daysInStatus:5},
      {name:'VFD 15kW',code:'VFD-15KW',mfr:'ABB',status:'configured',daysInStatus:8},
      {name:'VFD 7.5kW x2',code:'VFD-7K5-2',mfr:'ABB',status:'tested',daysInStatus:4},
      {name:'MCB Set 20pc',code:'MCB-20SET',mfr:'Schneider',status:'installed',daysInStatus:22},
      {name:'Overload Relays x6',code:'OLR-6SET',mfr:'ABB',status:'installed',daysInStatus:15},
      {name:'Power Meter',code:'PM-3PH',mfr:'Schneider',status:'tested',daysInStatus:3},
      {name:'Surge Protector',code:'SPD-01',mfr:'Phoenix',status:'installed',daysInStatus:20},
      {name:'Bus Bar System',code:'BBS-400A',mfr:'Rittal',status:'installed',daysInStatus:25}
    ]},
    {asm:'Vision Inspection',priority:10,parts:[
      {name:'Smart Camera',code:'SC-5MP',mfr:'Cognex',status:'tested',daysInStatus:5},
      {name:'Telecentric Lens',code:'TL-0.5X',mfr:'Edmund',status:'tested',daysInStatus:5},
      {name:'Dome Light',code:'DL-150',mfr:'CCS',status:'installed',daysInStatus:8},
      {name:'Bar Light x2',code:'BAR-200-2',mfr:'CCS',status:'installed',daysInStatus:8},
      {name:'Light Controller',code:'LC-4CH',mfr:'CCS',status:'tested',daysInStatus:4},
      {name:'Camera Mount',code:'CM-ADJ',mfr:'Cognex',status:'installed',daysInStatus:10},
      {name:'Trigger Sensor',code:'TS-01',mfr:'Banner',status:'tested',daysInStatus:3},
      {name:'Ethernet Switch',code:'ETH-5PT',mfr:'Cisco',status:'installed',daysInStatus:15},
      {name:'Reject Cylinder',code:'RJ-CYL',mfr:'Festo',status:'configured',daysInStatus:6},
      {name:'Inspection Stand',code:'IS-ADJ',mfr:'Custom',status:'installed',daysInStatus:18}
    ]},
    {asm:'Labeling Station',priority:11,parts:[
      {name:'Label Applicator',code:'LA-AUTO',mfr:'Videojet',status:'arrived',daysInStatus:10},
      {name:'Label Roll Holder',code:'LRH-01',mfr:'Videojet',status:'arrived',daysInStatus:10},
      {name:'Print Engine',code:'PE-300',mfr:'Zebra',status:'ordered',daysInStatus:8},
      {name:'Ribbon Holder',code:'RIB-01',mfr:'Zebra',status:'ordered',daysInStatus:8},
      {name:'Label Sensor',code:'LS-FORK',mfr:'Sick',status:'tested',daysInStatus:3},
      {name:'Tamp Cylinder',code:'TC-50',mfr:'Festo',status:'installed',daysInStatus:10},
      {name:'Vacuum Pad Set',code:'VP-SET',mfr:'Schmalz',status:'tested',daysInStatus:4},
      {name:'Control Box',code:'LCB-01',mfr:'Custom',status:'ordered',daysInStatus:12},
      {name:'Warning Lights',code:'WL-3CLR',mfr:'Patlite',status:'installed',daysInStatus:15},
      {name:'Label Waste Bin',code:'LWB-01',mfr:'Custom',status:'installed',daysInStatus:18}
    ]},
    {asm:'Packaging Unit',priority:12,parts:[
      {name:'Box Former',code:'BF-AUTO',mfr:'Wexxar',status:'configured',daysInStatus:12},
      {name:'Tape Head x2',code:'TH-2SET',mfr:'3M',status:'tested',daysInStatus:5},
      {name:'Case Conveyor',code:'CC-1.5M',mfr:'Bosch',status:'installed',daysInStatus:15},
      {name:'Pusher Cylinder',code:'PC-100',mfr:'Festo',status:'installed',daysInStatus:10},
      {name:'Box Magazine',code:'BM-50',mfr:'Custom',status:'tested',daysInStatus:6},
      {name:'Glue System',code:'GS-HOT',mfr:'Nordson',status:'configured',daysInStatus:8},
      {name:'Glue Nozzles x4',code:'GN-4SET',mfr:'Nordson',status:'installed',daysInStatus:12},
      {name:'Photoeye Set',code:'PES-3',mfr:'Banner',status:'tested',daysInStatus:4},
      {name:'Reject Gate',code:'RG-01',mfr:'Custom',status:'installed',daysInStatus:14},
      {name:'Pack Counter',code:'PC-DIG',mfr:'Red Lion',status:'tested',daysInStatus:3}
    ]},
    {asm:'Palletizer',priority:13,parts:[
      {name:'Palletizer Frame',code:'PF-MAIN',mfr:'Custom',status:'ordered',daysInStatus:20},
      {name:'Layer Gripper',code:'LG-01',mfr:'Schmalz',status:'pending',daysInStatus:5,pendingNote:'Waiting for final product dimensions from customer'},
      {name:'Z-Axis Servo',code:'ZS-5KW',mfr:'Yaskawa',status:'ordered',daysInStatus:10},
      {name:'X-Axis Linear',code:'XL-2M',mfr:'Bosch',status:'ordered',daysInStatus:12},
      {name:'Y-Axis Linear',code:'YL-1.5M',mfr:'Bosch',status:'ordered',daysInStatus:12},
      {name:'Pallet Dispenser',code:'PD-01',mfr:'Custom',status:'to-order',daysInStatus:5},
      {name:'Slip Sheet Inserter',code:'SSI-01',mfr:'Custom',status:'to-order',daysInStatus:5},
      {name:'Layer Press',code:'LP-01',mfr:'Custom',status:'to-order',daysInStatus:8},
      {name:'Pallet Sensor',code:'PS-RF',mfr:'Sick',status:'arrived',daysInStatus:4},
      {name:'Stack Height Sensor',code:'SHS-01',mfr:'Banner',status:'arrived',daysInStatus:4}
    ]},
    {asm:'Stretch Wrapper',priority:14,parts:[
      {name:'Turntable',code:'TT-1500',mfr:'Lantech',status:'pending',daysInStatus:12,pendingNote:'Awaiting floor load capacity confirmation from building engineer'},
      {name:'Film Carriage',code:'FC-PRE',mfr:'Lantech',status:'to-order',daysInStatus:10},
      {name:'Film Roll Holder',code:'FRH-01',mfr:'Lantech',status:'to-order',daysInStatus:10},
      {name:'Mast Assembly',code:'MA-2M',mfr:'Lantech',status:'to-order',daysInStatus:10},
      {name:'Cut & Clamp',code:'CC-AUTO',mfr:'Lantech',status:'to-order',daysInStatus:10},
      {name:'Top Press',code:'TP-01',mfr:'Custom',status:'to-order',daysInStatus:8},
      {name:'Ramp',code:'RAMP-01',mfr:'Custom',status:'ordered',daysInStatus:5},
      {name:'Film Break Sensor',code:'FBS-01',mfr:'Banner',status:'arrived',daysInStatus:6},
      {name:'Wrap Counter',code:'WC-DIG',mfr:'Red Lion',status:'arrived',daysInStatus:6},
      {name:'Safety Fence Gate',code:'SFG-01',mfr:'Troax',status:'ordered',daysInStatus:14}
    ]},
    {asm:'Outfeed Conveyor',priority:15,parts:[
      {name:'Roller Conveyor 3m',code:'RC-3M',mfr:'Hytrol',status:'pending',daysInStatus:14},
      {name:'Drive Motor 1.5kW',code:'DM-1K5',mfr:'SEW',status:'to-order',daysInStatus:8},
      {name:'Gearmotor',code:'GM-01',mfr:'SEW',status:'to-order',daysInStatus:8},
      {name:'Accumulation Zone x3',code:'AZ-3SET',mfr:'Hytrol',status:'to-order',daysInStatus:12},
      {name:'Zone Sensors',code:'ZS-6SET',mfr:'Banner',status:'ordered',daysInStatus:5},
      {name:'Transfer Section',code:'TS-90',mfr:'Hytrol',status:'to-order',daysInStatus:12},
      {name:'End Stop',code:'ESTOP-01',mfr:'Custom',status:'ordered',daysInStatus:8},
      {name:'Pallet Stop x2',code:'PSTOP-2',mfr:'Custom',status:'ordered',daysInStatus:8},
      {name:'Guide Rails 3m',code:'GR-3M-2',mfr:'Bosch',status:'arrived',daysInStatus:3},
      {name:'Floor Mounts Set',code:'FM-SET',mfr:'Custom',status:'arrived',daysInStatus:3}
    ]}
  ];

  data=[];let id=1;expanded={};
  
  // Workload imbalance: Marisa gets ~79% of work (for AI to detect)
  const assignPart=(ai,pi)=>{
    const r=Math.random();
    if(r<0.79)return 'Marisa';
    if(r<0.86)return 'John';
    if(r<0.93)return 'Sarah';
    return 'Mike';
  };
  
  partTemplates.forEach((template,ai)=>{
    const asmId=id++;
    data.push({id:asmId,name:template.asm,isAsm:true,assignee:'Marisa',priority:template.priority});
    expanded[asmId]=ai<4;
    
    template.parts.forEach((p,pi)=>{
      const partId=id++;
      const assignee=assignPart(ai,pi);
      const changedAt=simToday-p.daysInStatus*day;
      
      // Generate PO and dates for ordered+ parts (not pending or to-order)
      let poNumber,orderedAt,arrivedAt,expectedArrival;
      
      if(p.status!=='to-order'&&p.status!=='pending'){
        poNumber=getPO();
        const orderDaysAgo=p.daysInStatus+Math.floor(Math.random()*10)+5;
        orderedAt=simToday-orderDaysAgo*day;
        
        // Set expected arrival based on typical lead times
        const leadDays=p.mfr==='Custom'?18:p.mfr==='Fanuc'||p.mfr==='Epson'?14:Math.floor(Math.random()*8)+5;
        expectedArrival=new Date(orderedAt+leadDays*day).toISOString().split('T')[0];
        
        if(['arrived','tested','configured','installed'].includes(p.status)){
          const actualLeadDays=leadDays+(Math.random()>0.7?Math.floor(Math.random()*5):-Math.floor(Math.random()*3));
          arrivedAt=orderedAt+actualLeadDays*day;
          if(arrivedAt>simToday)arrivedAt=simToday-p.daysInStatus*day-day;
        }
      }
      
      data.push({
        id:partId,
        name:p.name,
        code:p.code,
        mfr:p.mfr,
        qty:Math.ceil(Math.random()*2),
        assignee,
        parentId:asmId,
        status:p.status,
        changedAt,
        poNumber,
        orderedAt,
        arrivedAt,
        expectedArrival,
        pendingNote:p.pendingNote,
        notes:partNotes[p.name]||'',
        comments:partComments[p.name]?partComments[p.name].map(c=>({...c,ts:c.ts})):undefined
      });
    });
  });

  // Progress history - realistic ramp up from Jan 1 to mid-Feb
  history=[
    {date:'2026-01-05',pct:2,action:'Project kickoff'},
    {date:'2026-01-10',pct:5,action:'Initial orders placed'},
    {date:'2026-01-15',pct:8,action:'Control panel started'},
    {date:'2026-01-20',pct:14,action:'First parts arriving'},
    {date:'2026-01-25',pct:19,action:'Electrical install begins'},
    {date:'2026-01-30',pct:25,action:'Major deliveries week'},
    {date:'2026-02-03',pct:32,action:'Robot cell 1 started'},
    {date:'2026-02-07',pct:38,action:'Conveyors operational'},
    {date:'2026-02-10',pct:44,action:'Safety system testing'},
    {date:'2026-02-14',pct:51,action:'Mid-project milestone'}
  ];

  // Realistic action items with various states
  actions=[
    {id:now+1,task:'Order remaining pneumatic components (compressor decision)',linkedPartId:null,due:'2026-02-10',assignee:'Marisa',status:'not-started',createdAt:'2026-02-01'},
    {id:now+2,task:'Complete safety system risk assessment documentation',linkedPartId:null,due:'2026-02-20',assignee:'Mike',status:'in-progress',createdAt:'2026-01-28'},
    {id:now+3,task:'Schedule Fanuc robot training (2 days)',linkedPartId:null,due:'2026-02-18',assignee:'Sarah',status:'in-progress',createdAt:'2026-02-05'},
    {id:now+4,task:'Get customer signoff on HMI screen changes (CR-0042)',linkedPartId:null,due:'2026-02-08',assignee:'John',status:'not-started',createdAt:'2026-02-03'},
    {id:now+5,task:'Follow up on Robot Stand fabrication progress',linkedPartId:null,due:'2026-02-12',assignee:'John',status:'not-started',createdAt:'2026-02-01'},
    {id:now+6,task:'Arrange rigging crew for hydraulic unit installation',linkedPartId:null,due:'2026-02-16',assignee:'John',status:'not-started',createdAt:'2026-02-10'},
    {id:now+7,task:'Order calibration target for Keyence camera (backorder)',linkedPartId:null,due:'2026-02-10',assignee:'Sarah',status:'completed',createdAt:'2026-02-05'},
    {id:now+8,task:'Verify Servo Motor 3kW replacement shipment',linkedPartId:null,due:'2026-02-15',assignee:'Sarah',status:'in-progress',createdAt:'2026-02-12'},
    {id:now+9,task:'Review Palletizer frame drawings before fab starts',linkedPartId:null,due:'2026-02-05',assignee:'Marisa',status:'completed',createdAt:'2026-01-25'},
    {id:now+10,task:'Schedule VFD programming with Yaskawa specialist',linkedPartId:null,due:'2026-02-20',assignee:'Mike',status:'not-started',createdAt:'2026-02-08'},
    {id:now+11,task:'Get quote for Stretch Wrapper package from Lantech',linkedPartId:null,due:'2026-02-18',assignee:'Marisa',status:'not-started',createdAt:'2026-02-10'},
    {id:now+12,task:'Confirm Label Applicator tech visit date',linkedPartId:null,due:'2026-02-07',assignee:'Sarah',status:'not-started',createdAt:'2026-02-05'}
  ];

  // Lead time database
  leadTimeDb={
    '6ES7-1500':{samples:[{days:7,date:'2025-12-20'},{days:6,date:'2025-12-10'},{days:8,date:'2025-11-25'}],avg:7},
    'HMI-TP1500':{samples:[{days:10,date:'2025-12-15'},{days:12,date:'2025-11-20'}],avg:11},
    'SM-3KW-01':{samples:[{days:5,date:'2025-12-22'},{days:4,date:'2025-12-01'}],avg:5},
    'RA-6AX-20':{samples:[{days:28,date:'2025-12-15'},{days:25,date:'2025-11-10'}],avg:27},
    'LC-600':{samples:[{days:10,date:'2025-12-18'},{days:8,date:'2025-12-05'}],avg:9},
    'HPU-15HP':{samples:[{days:14,date:'2025-12-10'}],avg:14},
    'SC-5MP':{samples:[{days:6,date:'2025-12-20'},{days:5,date:'2025-12-08'}],avg:6},
    'VFD-15KW':{samples:[{days:3,date:'2025-12-22'},{days:4,date:'2025-12-15'},{days:3,date:'2025-12-01'}],avg:3},
    'SP-PNOZ':{samples:[{days:5,date:'2025-12-18'}],avg:5},
    'GRP-PNU':{samples:[{days:7,date:'2025-12-15'},{days:5,date:'2025-11-28'}],avg:6}
  };
  
  updateProjectName();
  render();
}

function loadFromSnapshot(val){
  if(!val) return;
  
  if(val.data){
    data = Array.isArray(val.data) ? val.data : Object.values(val.data);
  } else {
    data = [];
  }
  if(val.team){
    team = Array.isArray(val.team) ? val.team : Object.values(val.team);
  } else {
    team = [];
  }
  if(val.history){
    history = Array.isArray(val.history) ? val.history : Object.values(val.history);
  } else {
    history = [];
  }
  if(val.actions){
    actions = Array.isArray(val.actions) ? val.actions : Object.values(val.actions);
  } else {
    actions = [];
  }
  projectDates = val.projectDates || {start:'',end:''};
  currentProjectName = val.projectName || 'EBS Project';
  
  updateProjectName();
  updateVersionInfo();
  render();
}

// Track local changes to avoid re-render on echo
let pendingRenderTimeout = null;

function setupRealtimeListener(){
  let skipNext = true;
  
  projectRef.child('main').on('value', snapshot=>{
    if(skipNext){
      skipNext = false;
      return;
    }
    
    const val = snapshot.val();
    if(!val || !val.data) return;
    
    // If this is our own change echoing back, skip re-render
    if(val.lastSaveId && val.lastSaveId === lastSaveId){
      return;
    }
    
    console.log('Received update from another user');
    loadFromSnapshot(val);
    saveToLocalStorage();
  });
  
  projectRef.child('leadTime').on('value', snapshot=>{
    leadTimeDb = snapshot.val() || {};
  });
  
  projectRef.child('boms').on('value', snapshot=>{
    const val = snapshot.val();
    if(val) savedBoms = Array.isArray(val) ? val : Object.values(val);
  });
  
  projectRef.child('globalCodes').on('value', snapshot=>{
    const val = snapshot.val();
    globalCodes = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  });
  
  projectRef.child('globalMfrs').on('value', snapshot=>{
    const val = snapshot.val();
    globalMfrs = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  });
  
  let wasOffline = false;
  let offlineTimer = null;
  
  function updateOfflinePendingCount() {
    const count = pendingPartChanges.size + pendingAsmChanges.size;
    const el = $('offlinePending');
    if (el) {
      el.textContent = count > 0 ? count + ' pending change' + (count > 1 ? 's' : '') : 'No pending changes';
      el.style.display = count > 0 ? 'block' : 'none';
    }
  }
  
  db.ref('.info/connected').on('value', snapshot=>{
    isConnected = snapshot.val() === true;
    updateVersionInfo();
    if(!isConnected && !useLocalStorage && isAuthenticated){
      wasOffline = true;
      showSync('offline','Offline');
      // Show offline overlay after a brief delay (avoid flashing on brief disconnects)
      clearTimeout(offlineTimer);
      offlineTimer = setTimeout(()=>{
        if(!isConnected && isAuthenticated){
          updateOfflinePendingCount();
          $('offlineOverlay').classList.add('active');
        }
      }, 2000);
    } else if(isConnected){
      clearTimeout(offlineTimer);
      if(wasOffline){
        wasOffline = false;
        $('offlineOverlay').classList.remove('active');
        showSync('synced','Back online');
        // Trigger sync of any pending changes
        syncPendingChanges();
        setTimeout(()=>$('syncIndicator').classList.remove('active'),2000);
      }
    }
  });
}

// ============================================
// Login UI Handlers
// ============================================
// Set up login handlers immediately since DOM should be ready
(function setupLoginHandlers(){
  const quickBtn = document.getElementById('loginQuick');
  const codeBtn = document.getElementById('loginBtn');
  const codeInput = document.getElementById('loginCode');
  
  console.log('Login setup:', !!quickBtn, !!codeBtn, !!codeInput);
  
  if(quickBtn){
    quickBtn.onclick = function(){
      console.log('Guest login clicked');
      this.disabled = true;
      this.innerHTML = '<span>Loading...</span>';
      setTimeout(()=>login(ACCESS_CODE), 200);
    };
  }
  
  if(codeBtn){
    codeBtn.onclick = function(){
      console.log('Code login clicked');
      const code = codeInput ? codeInput.value.trim() : '';
      if(code && code !== ACCESS_CODE){
        const err = document.getElementById('loginError');
        if(err) err.textContent = 'Invalid code';
        return;
      }
      this.disabled = true;
      this.textContent = 'Loading...';
      setTimeout(()=>login(ACCESS_CODE), 200);
    };
  }
  
  if(codeInput){
    codeInput.onkeydown = function(e){
      if(e.key === 'Enter' && codeBtn) codeBtn.click();
    };
  }
})();

// Check connection status on load
db.ref('.info/connected').once('value').then(()=>{
  $('loginStatus').textContent='Ready';
}).catch(()=>{
  $('loginStatus').textContent='Unable to connect - check Firebase config';
});

function recordLeadTime(code,days){if(!code||days<=0||days>365)return;code=code.toUpperCase();if(!leadTimeDb[code])leadTimeDb[code]={samples:[],avg:null};const entry=leadTimeDb[code];entry.samples.push({days,date:new Date().toISOString().split('T')[0]});if(entry.samples.length>20)entry.samples=entry.samples.slice(-20);entry.avg=Math.round(entry.samples.reduce((a,s)=>a+s.days,0)/entry.samples.length);saveLeadTime()}

function getPartETA(part){
  if(STAGES.indexOf(part.status)>=2)return{display:'â€”',type:'done'};
  
  // Helper to format date as "25.12."
  function formatDate(d){
    return d.getDate()+'.'+(d.getMonth()+1)+'.';
  }
  
  // For manual ETA, calculate from orderedAt if available, else from today
  if(part.manualEta!==undefined&&part.manualEta!==null){
    const baseDate=part.orderedAt?new Date(part.orderedAt):new Date();
    const arrivalDate=new Date(baseDate);
    arrivalDate.setDate(arrivalDate.getDate()+part.manualEta);
    return{display:formatDate(arrivalDate),type:'manual',days:part.manualEta};
  }
  
  const code=part.code?part.code.toUpperCase():null;
  const lt=code?leadTimeDb[code]:null;
  if(lt&&lt.avg){
    // For ordered parts, calculate arrival date from order date
    if(part.status==='ordered'&&part.orderedAt){
      const orderDate=new Date(part.orderedAt);
      const arrivalDate=new Date(orderDate);
      arrivalDate.setDate(arrivalDate.getDate()+lt.avg);
      return{display:formatDate(arrivalDate),type:'predicted',days:lt.avg,avg:lt.avg};
    }
    // For to-order parts, we can't calculate a date since we don't know when they'll be ordered
    return{display:'?',type:'unknown'};
  }
  return{display:'?',type:'unknown'};
}
function getLeadTimeHistory(code){if(!code)return null;return leadTimeDb[code.toUpperCase()]||null}
function getProgressColor(pct){if(pct<20)return'var(--red)';if(pct<40)return'var(--orange)';return'var(--green)'}

function isOnSchedule(){
  if(!projectDates.start||!projectDates.end)return true;
  const start=new Date(projectDates.start),end=new Date(projectDates.end),now=new Date();
  const totalDays=Math.max(1,(end-start)/86400000);
  const elapsedDays=Math.max(0,(now-start)/86400000);
  const expectedPct=(elapsedDays/totalDays)*100;
  const actualPct=calcOverallProgress();
  return actualPct>=expectedPct;
}

function getScheduleColor(){return isOnSchedule()?'var(--green)':'var(--red)'}
function getProgressClass(pct){if(pct<20)return'red';if(pct<40)return'orange';return'green'}

// Calculate Supplier OTD from actual project data
function calcSupplierOTD(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt);
  if(!parts.length)return null;
  let onTime=0,total=0;
  parts.forEach(p=>{
    total++;
    // Check if arrived on or before expected date
    if(p.expectedArrival){
      const expected=new Date(p.expectedArrival).getTime();
      if(p.arrivedAt<=expected+86400000)onTime++; // Give 1 day grace
    }else{
      // No expected date set, consider on-time if lead time was reasonable (<=14 days)
      const days=Math.round((p.arrivedAt-p.orderedAt)/86400000);
      if(days<=14)onTime++;
    }
  });
  return total?Math.round(onTime/total*100):null;
}

// Calculate average lead time from actual project data
function calcAvgLeadTime(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt);
  if(!parts.length)return null;
  const totalDays=parts.reduce((sum,p)=>sum+Math.round((p.arrivedAt-p.orderedAt)/86400000),0);
  return Math.round(totalDays/parts.length);
}

// Calculate OTD per manufacturer
function calcOTDByMfr(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt&&p.mfr);
  const mfrStats={};
  parts.forEach(p=>{
    const mfr=p.mfr;
    if(!mfrStats[mfr])mfrStats[mfr]={onTime:0,total:0,totalDays:0};
    mfrStats[mfr].total++;
    const days=Math.round((p.arrivedAt-p.orderedAt)/86400000);
    mfrStats[mfr].totalDays+=days;
    if(p.expectedArrival){
      const expected=new Date(p.expectedArrival).getTime();
      if(p.arrivedAt<=expected+86400000)mfrStats[mfr].onTime++;
    }else{
      if(days<=14)mfrStats[mfr].onTime++;
    }
  });
  return Object.keys(mfrStats).map(mfr=>({
    mfr,
    otd:Math.round(mfrStats[mfr].onTime/mfrStats[mfr].total*100),
    avgLead:Math.round(mfrStats[mfr].totalDays/mfrStats[mfr].total),
    total:mfrStats[mfr].total
  })).sort((a,b)=>b.otd-a.otd||b.total-a.total);
}

function getVelocityForecast(){if(history.length<2)return null;const first=history[0],last=history[history.length-1];const days=Math.max(1,(new Date(last.date)-new Date(first.date))/86400000);const rate=(last.pct-first.pct)/days;if(rate<=0)return{status:'stalled',rate:0,estDate:null,daysToComplete:null};const pct=calcOverallProgress();const remaining=100-pct;const daysToComplete=Math.ceil(remaining/rate);const estDate=new Date();estDate.setDate(estDate.getDate()+daysToComplete);const daysLeft=getDaysLeft();let status='on-track';if(daysLeft!==null){if(daysToComplete>daysLeft+3)status='at-risk';else if(daysToComplete>daysLeft)status='behind';else if(daysToComplete<daysLeft-3)status='ahead'}return{status,rate,estDate:estDate.toISOString().split('T')[0],daysToComplete,daysLeft}}

const getAsms=()=>data.filter(d=>d.isAsm).sort((a,b)=>(a.priority||99)-(b.priority||99));
const getParts=()=>data.filter(d=>!d.isAsm);
const getPartActions=partId=>actions.filter(a=>a.linkedPartId===partId&&a.status!=='completed');
const getPartById=id=>data.find(d=>d.id===id);
const getTeamEmail=name=>{const t=team.find(m=>m.name===name);return t?t.email:''};
const calcPartProgress=p=>STAGES.indexOf(p.status)/(STAGES.length-1);
function calcAsmProgress(asmId){const kids=data.filter(d=>d.parentId===asmId);if(!kids.length)return 0;return Math.round(kids.reduce((acc,k)=>acc+calcPartProgress(k),0)/kids.length*100)}
function calcOverallProgress(){const parts=getParts();if(!parts.length)return 0;return Math.round(parts.reduce((acc,p)=>acc+calcPartProgress(p),0)/parts.length*100)}
function getExpectedProgress(){if(!projectDates.start||!projectDates.end)return null;const start=new Date(projectDates.start),end=new Date(projectDates.end),now=new Date();const total=end-start,elapsed=now-start;if(elapsed<0)return 0;if(elapsed>total)return 100;return Math.round(elapsed/total*100)}
function getDaysLeft(){if(!projectDates.end)return null;return Math.ceil((new Date(projectDates.end)-new Date())/86400000)}
function getProjectDateRange(){const parts=getParts();if(!parts.length)return{start:null,end:null};let earliest=null,latest=null;parts.forEach(p=>{if(p.changedAt){const d=new Date(p.changedAt);if(!earliest||d<earliest)earliest=d;if(!latest||d>latest)latest=d}});if(projectDates.start)earliest=new Date(projectDates.start);if(projectDates.end)latest=new Date(projectDates.end);return{start:earliest,end:latest}}
function recordProgress(){const today=new Date().toISOString().split('T')[0];const pct=calcOverallProgress();const idx=history.findIndex(h=>h.date===today);if(idx>=0)history[idx].pct=pct;else history.push({date:today,pct});if(history.length>100)history=history.slice(-100)}
const formatDate=d=>{if(!d)return'â€”';const p=d.split('-');return p[1]+'/'+p[2]};
const formatDateShort=d=>{if(!d)return'â€”';const dt=new Date(d);return dt.getDate()+'.'+(dt.getMonth()+1)+'.'};
const getWeek=d=>{const o=new Date(d.getFullYear(),0,1);return Math.ceil((((d-o)/86400000)+o.getDay()+1)/7)};

function render(){
  try{
    updateProjectName();
    const parts=getParts(),asms=getAsms();
    const pct=calcOverallProgress(),daysLeft=getDaysLeft();
    const readyCount=parts.filter(p=>p.status==='installed').length;

    $('sReady').textContent=readyCount+'/'+parts.length;
    $('sReady').style.color=parts.length?(readyCount===parts.length?'var(--green)':'var(--text)'):'var(--text3)';
    const scheduleColor=getScheduleColor();
    $('sPct').textContent=pct+'%';
    $('sPct').style.color=scheduleColor;
    $('sBar').style.width=pct+'%';
    $('sBar').style.background=scheduleColor;
    $('hmProgress').title=isOnSchedule()?'On Schedule':'Behind Schedule';

    if(daysLeft!==null){$('hmDays').style.display='block';$('sDays').textContent=daysLeft+'d';$('sDays').className='hm-value '+(daysLeft<3?'red':daysLeft<7?'yellow':'')}
    else{$('hmDays').style.display='none'}

    $('p0').textContent=parts.filter(p=>p.status==='pending').length;
    $('p1').textContent=parts.filter(p=>p.status==='to-order').length;
    $('p2').textContent=parts.filter(p=>p.status==='ordered').length;
    $('p3').textContent=parts.filter(p=>p.status==='arrived').length;
    $('p4').textContent=parts.filter(p=>p.status==='tested').length;
    $('p5').textContent=parts.filter(p=>p.status==='configured').length;
    $('p6').textContent=parts.filter(p=>p.status==='installed').length;

    document.querySelectorAll('.pipe').forEach(p=>p.classList.toggle('active',p.dataset.s===filterStage));
    $('pmParent').innerHTML='<option value="">â€”</option>'+asms.map(a=>'<option value="'+a.id+'">'+esc(a.name)+'</option>').join('');
    updateSelects();updateExpandToggle();renderInsights();renderActions();updateAIAlert();

    let badges='';
    if(filterStage)badges+='<span class="filter-badge">'+SLABELS[filterStage]+' <button onclick="window.clearStageFilter()">Ã—</button></span>';
    if(filterAssignee)badges+='<span class="filter-badge">'+esc(filterAssignee)+' <button onclick="window.clearAssigneeFilter()">Ã—</button></span>';
    if(filterPO)badges+='<span class="filter-badge">PO: '+esc(filterPO)+' <button onclick="window.clearPOFilter()">Ã—</button></span>';
    $('filterBadges').innerHTML=badges;

    let html='';
    
    // Helper to render a part and its sub-parts recursively
    function renderPartWithChildren(part,depth){
      let partHtml=renderPart({type:'part',item:part,child:true,depth:depth});
      // Check for sub-parts (parts whose parentId is this part's id)
      const subParts=data.filter(d=>!d.isAsm&&d.parentId===part.id).filter(matchPart);
      if(subParts.length){
        subParts.forEach(sp=>{
          partHtml+=renderPartWithChildren(sp,depth+1);
        });
      }
      return partHtml;
    }
    
    asms.forEach(asm=>{
      // Get direct children of assembly (not sub-parts of parts)
      const kids=data.filter(d=>d.parentId===asm.id&&!data.find(p=>p.id===d.parentId&&!p.isAsm));
      const matchingKids=kids.filter(matchPart);
      const asmMatch=!filterAssignee||asm.assignee===filterAssignee;
      if((filterStage||filterAssignee||filterPO)&&!matchingKids.length&&!asmMatch)return;
      if(searchQ&&asm.name.toLowerCase().indexOf(searchQ.toLowerCase())===-1&&!matchingKids.length)return;
      const isExp=(filterStage||filterAssignee||filterPO)?true:expanded[asm.id];
      html+=renderAsm({type:'asm',item:asm,kids:kids.length,match:matchingKids.length,exp:isExp});
      if(isExp){
        const visibleKids=(filterStage||filterAssignee||filterPO)?matchingKids:kids.filter(matchPart);
        visibleKids.forEach(k=>{
          html+=renderPartWithChildren(k,0);
        });
        html+='<div class="add-row" style="padding-left:44px"><button class="add-row-btn" onclick="window.addNewPart('+asm.id+')" title="Add part to '+esc(asm.name)+'">+</button></div>';
      }
    });
    data.filter(d=>!d.isAsm&&!d.parentId).filter(matchPart).forEach(p=>{html+=renderPart({type:'part',item:p,child:false,depth:0})});
    $('partsList').innerHTML=html;
    $('partsTable').style.display='flex';$('emptyList').style.display='none';
    if(highlightPartId){setTimeout(()=>{const row=document.querySelector('[data-part-id="'+highlightPartId+'"]');if(row){row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),1500)}highlightPartId=null},50)}
    if($('ganttPanel').classList.contains('active'))renderGantt();
  }catch(err){console.error('Render error:',err)}
}

const matchPart=p=>{if(filterStage&&p.status!==filterStage)return false;if(filterAssignee&&p.assignee!==filterAssignee)return false;if(filterPO&&p.poNumber!==filterPO)return false;if(searchQ&&[p.name,p.assignee,p.code,p.mfr].join(' ').toLowerCase().indexOf(searchQ.toLowerCase())===-1)return false;return true};

function renderInsights(){
  const daysLeft=getDaysLeft(),pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast(),otd=calcSupplierOTD(),avgLead=calcAvgLeadTime();
  const parts=getParts(),asms=getAsms();
  const now=Date.now(),day=86400000;

  $('insDays').textContent=daysLeft!==null?daysLeft+'d':'â€”';
  $('insDays').className='ins-val'+(daysLeft!==null&&daysLeft<3?' red':daysLeft!==null&&daysLeft<7?' yellow':'');

  if(expected!==null){
    const diff=pct-expected;
    if(diff>=5){$('insStatus').textContent='Ahead';$('insStatus').className='ins-val green'}
    else if(diff<=-5){$('insStatus').textContent='Behind';$('insStatus').className='ins-val red'}
    else{$('insStatus').textContent='On Track';$('insStatus').className='ins-val green'}
    $('insExpected').textContent=expected+'%';
  }else{$('insStatus').textContent='â€”';$('insExpected').textContent='â€”'}

  $('insActual').textContent=pct+'%';
  $('insActual').className='ins-val '+getProgressClass(pct);

  $('insOTD').textContent=otd!==null?otd+'%':'â€”';
  $('insOTD').className='ins-val '+(otd===null?'':(otd>=90?'green':otd>=70?'yellow':'red'));
  $('insAvgLead').textContent=avgLead!==null?avgLead+'d':'â€”';

  // New supplier insights
  const inTransit=parts.filter(p=>p.status==='ordered').length;
  const toOrder=parts.filter(p=>p.status==='to-order').length;
  $('insInTransit').textContent=inTransit;
  $('insInTransit').className='ins-val'+(inTransit>10?' yellow':'');
  $('insToOrder').textContent=toOrder;
  $('insToOrder').className='ins-val'+(toOrder>5?' yellow':'');

  // Top supplier by part count
  const mfrCounts={};
  parts.filter(p=>p.mfr).forEach(p=>{mfrCounts[p.mfr]=(mfrCounts[p.mfr]||0)+1});
  const topMfr=Object.entries(mfrCounts).sort((a,b)=>b[1]-a[1])[0];
  $('insTopSupplier').textContent=topMfr?topMfr[0]:'â€”';

  // Longest lead time
  const leadCodes=Object.keys(leadTimeDb);
  let longestLead=null,longestCode='';
  leadCodes.forEach(code=>{
    if(leadTimeDb[code].avg>longestLead){longestLead=leadTimeDb[code].avg;longestCode=code}
  });
  $('insLongestLead').textContent=longestLead?longestLead+'d':'â€”';

  if(forecast&&forecast.rate>0){
    $('insRate').textContent=forecast.rate.toFixed(1)+'%/d';
    $('insRate').className='ins-val green';
    $('insEst').textContent=formatDateShort(forecast.estDate);
    $('insEst').className='ins-val'+(forecast.status==='ahead'||forecast.status==='on-track'?' green':' red');
    $('forecastDate').textContent=formatDateShort(forecast.estDate);
    $('forecastDate').style.color=forecast.status==='ahead'||forecast.status==='on-track'?'var(--green)':'var(--red)';
    if(forecast.daysLeft!==null){
      const diff=forecast.daysLeft-forecast.daysToComplete;
      if(diff>0){$('forecastLabel').textContent=diff+' days early';$('forecastLabel').style.color='var(--green)'}
      else if(diff<0){$('forecastLabel').textContent=Math.abs(diff)+' days late';$('forecastLabel').style.color='var(--red)'}
      else{$('forecastLabel').textContent='on deadline';$('forecastLabel').style.color='var(--text2)'}
    }else{$('forecastLabel').textContent=''}
    $('forecastDetail').textContent='At '+forecast.rate.toFixed(1)+'%/day â€¢ '+forecast.daysToComplete+'d to complete';
  }else{
    $('insRate').textContent='â€”';$('insEst').textContent='â€”';
    $('forecastDate').textContent='â€”';$('forecastDate').style.color='var(--text3)';
    $('forecastLabel').textContent='';$('forecastDetail').textContent='Need 2+ days of data';
  }

  // Assembly progress list
  const asmProgress=asms.map(a=>{
    const prog=calcAsmProgress(a.id);
    return {id:a.id,name:a.name,progress:prog};
  }).sort((a,b)=>a.progress-b.progress);
  
  $('asmProgressList').innerHTML=asmProgress.length?asmProgress.map(a=>{
    const color=a.progress<30?'var(--red)':a.progress<60?'var(--orange)':'var(--green)';
    return '<div class="asm-progress-item"><span class="asm-progress-name">'+esc(a.name)+'</span><div class="asm-progress-bar"><div class="asm-progress-fill" style="width:'+a.progress+'%;background:'+color+'"></div></div><span class="asm-progress-pct" style="color:'+color+'">'+a.progress+'%</span></div>';
  }).join(''):'<div style="color:var(--text3);font-size:12px;padding:12px">No assemblies</div>';

  // Bottleneck list - parts stuck longest
  const bottlenecks=parts.filter(p=>p.changedAt&&p.status!=='installed').map(p=>({
    id:p.id,name:p.name,status:p.status,days:Math.floor((now-p.changedAt)/day)
  })).filter(p=>p.days>=3).sort((a,b)=>b.days-a.days).slice(0,8);

  $('bottleneckList').innerHTML=bottlenecks.length?bottlenecks.map(b=>{
    const level=b.days>=7?'':'warning';
    return '<div class="bottleneck-item '+level+'"><span class="bottleneck-name">'+esc(b.name)+'</span><span class="bottleneck-days">'+b.days+'d in '+SLABELS[b.status]+'</span></div>';
  }).join(''):'<div style="color:var(--text3);font-size:12px;padding:12px">No bottlenecks detected</div>';
}

function renderActions(){
  const today=new Date().toISOString().split('T')[0],soon=new Date();soon.setDate(soon.getDate()+3);const soonStr=soon.toISOString().split('T')[0];
  const filtered=actions.filter(a=>{
    if(actionSearchQ&&!a.task.toLowerCase().includes(actionSearchQ.toLowerCase()))return false;
    if(actionAssigneeFilter&&a.assignee!==actionAssigneeFilter)return false;
    return true;
  }).sort((a,b)=>{if(a.status==='completed'&&b.status!=='completed')return 1;if(b.status==='completed'&&a.status!=='completed')return -1;return new Date(a.due||'9999')-new Date(b.due||'9999')});
  if(!filtered.length){$('actionsList').innerHTML='';$('actionsTable').style.display='none';$('emptyActions').style.display='flex';return}
  $('actionsTable').style.display='flex';$('emptyActions').style.display='none';
  $('actionsList').innerHTML=filtered.map(a=>{
    let dueClass='';if(a.status!=='completed'&&a.due){if(a.due<today)dueClass=' overdue';else if(a.due<=soonStr)dueClass=' soon'}
    const si=ASTAGES.indexOf(a.status),next=ASTAGES[si+1];
    const advBtn=!next?'<button class="adv-btn done">âœ“</button>':'<button class="adv-btn" onclick="window.advAction('+a.id+')">â†’</button>';
    const linkedPart=a.linkedPartId?getPartById(a.linkedPartId):null;
    const linkedHtml=linkedPart?'<span class="action-link" onclick="window.goToPart('+linkedPart.id+')">'+esc(linkedPart.name)+'</span>':'<span style="color:var(--text3)">â€”</span>';
    const highlight=highlightActionId===a.id?' highlight':'';
    // Created date in "29.12." format
    const createdDate=a.createdAt?formatDateShort(a.createdAt):'â€”';
    // Progress bar calculation
    let progressHtml='<span style="color:var(--text3)">â€”</span>';
    if(a.createdAt&&a.due&&a.status!=='completed'){
      const created=new Date(a.createdAt).getTime();
      const due=new Date(a.due).getTime();
      const now=Date.now();
      const total=due-created;
      const elapsed=now-created;
      const pct=total>0?Math.min(100,Math.max(0,Math.round(elapsed/total*100))):0;
      const barColor=pct>=100?'var(--red)':pct>=80?'var(--orange)':'var(--text3)';
      progressHtml='<div class="action-progress-bar"><div class="action-progress-fill" style="width:'+pct+'%;background:'+barColor+'"></div></div>';
    }else if(a.status==='completed'){
      progressHtml='<div class="action-progress-bar"><div class="action-progress-fill" style="width:100%;background:var(--green)"></div></div>';
    }
    // Due date in "29.12." format
    const dueDate=a.due?formatDateShort(a.due):'â€”';
    return '<div class="action-row action-grid'+highlight+'" data-action-id="'+a.id+'"><div class="action-task'+(a.status==='completed'?' completed':'')+'">'+esc(a.task)+'</div><div>'+linkedHtml+'</div><div style="font-size:11px;color:var(--text3)">'+createdDate+'</div><div>'+progressHtml+'</div><div class="action-due'+dueClass+'">'+dueDate+'</div><div style="font-size:10px;color:var(--text2)">'+(a.assignee||'â€”')+'</div><div class="action-status '+a.status+'">'+ALABELS[a.status]+'</div><div style="display:flex;gap:2px;justify-content:flex-end">'+advBtn+'<button class="adv-btn" onclick="window.editAction('+a.id+',event)">âœŽ</button><button class="adv-btn" onclick="window.delAction('+a.id+',event)">Ã—</button></div></div>';
  }).join('');
  highlightActionId=null;
}

function renderBurndown(){
  const chart=$('burndownChart');
  if(!projectDates.start||!projectDates.end){chart.innerHTML='<div class="burndown-empty" onclick="window.openDates()"><span>ðŸ“…</span><span>Set project dates</span></div>';$('burndownDates').innerHTML='';return}
  const start=new Date(projectDates.start),end=new Date(projectDates.end);
  const totalDays=Math.max(1,(end-start)/86400000);
  const w=500,h=160,pad={top:16,right:16,bottom:24,left:36};
  const chartW=w-pad.left-pad.right,chartH=h-pad.top-pad.bottom;
  const xScale=x=>pad.left+(x/totalDays)*chartW;
  const yScale=y=>pad.top+(1-y/100)*chartH;
  const points=history.filter(pt=>{const d=new Date(pt.date);return d>=start&&d<=end}).map(pt=>{const d=new Date(pt.date),dayNum=(d-start)/86400000;return{x:xScale(dayNum),y:yScale(pt.pct),pct:pt.pct,dayNum}});
  let svg='<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="xMidYMid meet">';
  [0,25,50,75,100].forEach(g=>{const y=yScale(g);svg+='<line x1="'+pad.left+'" y1="'+y+'" x2="'+(w-pad.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="1"/><text x="'+(pad.left-6)+'" y="'+(y+4)+'" fill="var(--text3)" font-size="10" text-anchor="end">'+g+'</text>'});
  svg+='<line x1="'+xScale(0)+'" y1="'+yScale(0)+'" x2="'+xScale(totalDays)+'" y2="'+yScale(100)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="4,3"/>';
  for(let i=0;i<points.length-1;i++){const p1=points[i],p2=points[i+1];const idealY1=(p1.dayNum/totalDays)*100,idealY2=(p2.dayNum/totalDays)*100;const above1=p1.pct>=idealY1,above2=p2.pct>=idealY2;const col1=above1?'var(--green)':'var(--red)';const col2=above2?'var(--green)':'var(--red)';if(above1===above2){svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>'}else{const t=(idealY1-p1.pct)/((p2.pct-p1.pct)-(idealY2-idealY1));const ix=p1.x+t*(p2.x-p1.x),iy=p1.y+t*(p2.y-p1.y);svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+ix+'" y2="'+iy+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/><line x1="'+ix+'" y1="'+iy+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col2+'" stroke-width="2.5" stroke-linecap="round"/>'}}
  points.forEach(p=>{const idealY=(p.dayNum/totalDays)*100;svg+='<circle cx="'+p.x+'" cy="'+p.y+'" r="4" fill="'+(p.pct>=idealY?'var(--green)':'var(--red)')+'"/>'});
  svg+='</svg>';chart.innerHTML=svg;
  $('burndownDates').innerHTML='<span>'+formatDateShort(projectDates.start)+'</span><span>'+formatDateShort(projectDates.end)+'</span>';
}

function renderAsm(r){
  const a=r.item,progress=calcAsmProgress(a.id);
  const pColor=progress<20?'var(--red)':progress<40?'var(--orange)':'var(--green)';
  const count=(filterStage||filterAssignee||filterPO)?r.match+'/'+r.kids:r.kids;
  const priorityBtns='<div class="asm-priority" onclick="event.stopPropagation()"><button class="asm-priority-btn" onclick="window.moveAsmUp('+a.id+')" title="Move up">â–²</button><button class="asm-priority-btn" onclick="window.moveAsmDown('+a.id+')" title="Move down">â–¼</button></div>';
  const ganttBtn='<button class="sm-btn gantt-link-btn" onclick="window.goToGanttAsm('+a.id+',event)" title="View in Timeline"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg></button>';
  return '<div class="asm-row parts-grid" data-asm-id="'+a.id+'" onclick="window.toggleAsmRow(event,'+a.id+')"><div class="asm-toggle">'+(r.exp?'â–¼':'â–¶')+'</div><div class="asm-name-cell">'+priorityBtns+'<span class="asm-name">'+esc(a.name)+'</span> <span class="asm-meta">('+count+')</span></div><div></div><div></div><div></div><div></div><div onclick="event.stopPropagation()">'+ganttBtn+'</div><div class="asm-progress"><div class="asm-bar"><div class="asm-bar-fill" style="width:'+progress+'%;background:'+pColor+';"></div></div><span class="asm-pct" style="color:'+pColor+'">'+progress+'%</span></div><div></div><div class="notes-cell" title="'+(a.notes?esc(a.notes):'')+'">'+(a.notes?esc(a.notes):'â€”')+'</div><div class="asm-actions" onclick="event.stopPropagation()"><button class="sm-btn" onclick="window.editAsm('+a.id+',event)">âœŽ</button><button class="del-btn" onclick="window.confirmDelete('+a.id+',\'assembly\',event)" style="margin-left:4px">Ã—</button></div></div>';
}

function renderPart(r){
  const p=r.item;
  const partStages=getPartStages(p);
  const si=partStages.indexOf(p.status);
  const isInstalled=p.status==='installed';
  const stageDots=partStages.map((s,i)=>'<div class="stage-dot'+((i<si||isInstalled)?' done':(i===si?' current':'')+'" title="'+SLABELS[s])+'"></div>').join('');
  
  // Determine indent level
  const depth=r.depth||0;
  const indent=depth*24;
  
  // Add sub-part button (appears on hover)
  const addSubBtn='<button class="subpart-add" onclick="window.addSubPart('+p.id+',event)" title="Add sub-part">+</button>';
  
  // ETA and PO handling
  let etaHtml='';
  let etaDate='',etaClass='historical',poHtml='';
  
  // Only show arrival date if not installed
  if(p.status!=='installed'){
    if(p.expectedArrival){
      etaDate=formatDateShort(p.expectedArrival);
      etaClass='user-set';
    }else if(p.status==='ordered'||p.status==='to-order'){
      const eta=getPartETA(p);
      if(eta.type==='predicted'){
        etaDate=eta.display;
        etaClass='historical';
      }else if(eta.type==='manual'){
        etaDate=eta.display;
        etaClass='user-set';
      }else{
        etaDate='?';
        etaClass='historical';
      }
    }else{
      etaDate='?';
      etaClass='historical';
    }
  }
  
  // Always show PO number if exists
  if(p.poNumber){
    const isFiltered=filterPO===p.poNumber;
    poHtml='<span class="eta-po'+(isFiltered?' active':'')+'" onclick="window.showPODetails(\''+esc(p.poNumber)+'\',event)" title="Click to view PO details">'+esc(p.poNumber)+'</span>';
  }
  
  if(etaDate||poHtml){
    etaHtml='<div class="eta-cell">'+(etaDate?'<span class="eta-date '+etaClass+'" onclick="window.openEtaModal('+p.id+',event)" title="Click to edit">'+etaDate+'</span>':'')+(poHtml||'')+'</div>';
  }else{
    etaHtml='<span style="color:var(--text3)">â€”</span>';
  }
  
  // Notes/Comments - clickable cell that opens chat popover
  const commentCount=p.comments?.length||0;
  const lastComment=p.comments&&p.comments.length?p.comments[p.comments.length-1]:null;
  const maxLen=commentCount>1?28:42;
  const commentPreview=lastComment?esc(lastComment.text).substring(0,maxLen)+(lastComment.text.length>maxLen?'â€¦':''):'';
  const notesHtml='<div class="notes-chat-cell" onclick="window.openNotesChat('+p.id+',event)"><span class="comment-text">'+(commentPreview||'<span class="add-note">add note</span>')+'</span>'+(commentCount>1?'<span class="comment-badge">+'+(commentCount-1)+'</span>':'')+'</div>';
  
  const depthClass=depth>0?' depth-'+Math.min(depth,3):'';
  const childClass=r.child?' child'+depthClass:'';
  
  // Checkbox for bulk selection
  const isSelected=selectedParts.has(p.id);
  const checkbox='<input type="checkbox" class="part-checkbox" data-part-id="'+p.id+'" '+(isSelected?'checked':'')+' onclick="window.togglePartSelection('+p.id+',event)">';
  
  // Status badge with has-note indicator for pending parts
  const hasNoteClass=(p.status==='pending'&&p.pendingNote)?' has-note':'';
  const statusBadge='<span class="status-badge '+p.status+hasNoteClass+'" onclick="window.openStatusPopover('+p.id+',event)" style="cursor:pointer" '+(p.pendingNote?'title="'+esc(p.pendingNote)+'"':'')+'>'+SLABELS[p.status]+'</span>';
  
  return '<div class="part-row parts-grid'+childClass+(isSelected?' selected':'')+'" data-part-id="'+p.id+'" data-depth="'+depth+'" onclick="window.handleRowClick(event)"><div>'+checkbox+'</div><div class="part-name-cell" style="padding-left:'+indent+'px"><span class="cell" onclick="window.editCell(event,'+p.id+',\'name\')">'+esc(p.name)+'</span>'+addSubBtn+'</div><div class="cell muted" onclick="window.editCellAutocomplete(event,'+p.id+',\'code\')">'+(p.code||'â€”')+'</div><div class="cell muted" onclick="window.editCellAutocomplete(event,'+p.id+',\'mfr\')">'+(p.mfr||'â€”')+'</div><div class="cell muted" onclick="window.editCellAssignee(event,'+p.id+')">'+(p.assignee||'â€”')+'</div><div class="cell muted" onclick="window.editCell(event,'+p.id+',\'qty\')">'+(p.qty||1)+'</div><div>'+statusBadge+'</div><div class="stage-dots">'+stageDots+'</div><div>'+etaHtml+'</div><div>'+notesHtml+'</div><div onclick="event.stopPropagation()"><button class="del-btn" onclick="window.confirmDelete('+p.id+',\'part\',event)">Ã—</button></div></div>';
}

let ganttZoom='day'; // day, week
let ganttExpanded={};
let ganttBarColors={}; // Store custom bar colors

function renderGantt(){
  const asms=getAsms();
  const parts=getParts();
  if(!asms.length){
    $('ganttSidebar').innerHTML='<div style="padding:20px;text-align:center;color:var(--text3)">No assemblies</div>';
    $('ganttTimelineHeader').innerHTML='';
    $('ganttTimelineBody').innerHTML='';
    return;
  }

  // Get dates from inputs or project dates
  const inputStart=$('ganttInputStart').value;
  const inputEnd=$('ganttInputEnd').value;
  const startDate=inputStart?new Date(inputStart):(projectDates.start?new Date(projectDates.start):new Date());
  const endDate=inputEnd?new Date(inputEnd):(projectDates.end?new Date(projectDates.end):new Date(startDate.getTime()+60*86400000));
  const today=new Date();
  today.setHours(0,0,0,0);
  
  // Sync inputs with current values
  if(!inputStart&&projectDates.start)$('ganttInputStart').value=projectDates.start;
  if(!inputEnd&&projectDates.end)$('ganttInputEnd').value=projectDates.end;
  
  // Extend range slightly for visibility
  const rangeStart=new Date(startDate);
  rangeStart.setDate(rangeStart.getDate()-7);
  const rangeEnd=new Date(endDate);
  rangeEnd.setDate(rangeEnd.getDate()+14);

  // Generate days array
  const days=[];
  const dayMs=86400000;
  let d=new Date(rangeStart);
  while(d<=rangeEnd){
    const dayOfWeek=d.getDay();
    days.push({
      date:new Date(d),
      dayNum:d.getDate(),
      dayName:['S','M','T','W','T','F','S'][dayOfWeek],
      month:d.toLocaleDateString('en-US',{month:'short'}),
      isWeekend:dayOfWeek===0||dayOfWeek===6,
      isToday:d.getTime()===today.getTime(),
      isFirstOfMonth:d.getDate()===1
    });
    d=new Date(d.getTime()+dayMs);
  }

  const cellWidth=32;
  const totalWidth=days.length*cellWidth;

  // Render timeline header
  let headerHtml='';
  days.forEach((day,i)=>{
    const classes=['gantt-timeline-day'];
    if(day.isWeekend)classes.push('weekend');
    if(day.isToday)classes.push('today');
    headerHtml+='<div class="'+classes.join(' ')+'" style="min-width:'+cellWidth+'px;width:'+cellWidth+'px">'+(day.isFirstOfMonth||i===0?'<div style="font-size:8px;margin-bottom:1px">'+day.month+'</div>':'')+'<div class="day-num">'+day.dayNum+'</div></div>';
  });
  $('ganttTimelineHeader').innerHTML=headerHtml;

  // Build rows data
  const rows=[];
  asms.forEach((asm,asmIdx)=>{
    const asmParts=parts.filter(p=>p.parentId===asm.id);
    const asmProgress=calcAsmProgress(asm.id);
    
    // Assembly row - spans entire project
    rows.push({
      type:'asm',
      id:asm.id,
      name:asm.name,
      startDate:startDate,
      endDate:endDate,
      progress:asmProgress,
      status:'asm',
      expanded:ganttExpanded[asm.id]!==false
    });

    // Part rows if expanded
    if(ganttExpanded[asm.id]!==false){
      asmParts.forEach(p=>{
        // Use orderedAt (epoch ms) for start date
        let pStart;
        if(p.orderedAt) pStart=new Date(p.orderedAt);
        else pStart=new Date(startDate);
        
        // expectedArrival is stored as ISO string (YYYY-MM-DD)
        let pEnd;
        if(p.expectedArrival) pEnd=new Date(p.expectedArrival);
        else pEnd=new Date(pStart.getTime()+14*dayMs);
        
        // For installed parts, use arrivedAt (epoch ms)
        if(p.status==='installed'){
          if(p.arrivedAt) pEnd=new Date(p.arrivedAt);
          else if(p.changedAt) pEnd=new Date(p.changedAt);
          else pEnd=today;
        }
        rows.push({
          type:'part',
          id:p.id,
          name:p.name,
          startDate:pStart,
          endDate:pEnd,
          progress:getPartProgress(p),
          status:p.status,
          parentId:asm.id
        });
      });
    }
  });

  // Render sidebar
  let sidebarHtml='';
  rows.forEach(row=>{
    const rowClass=row.type==='asm'?'asm':'part';
    const toggle=row.type==='asm'?'<span class="gantt-toggle" onclick="window.toggleGanttAsm('+row.id+',event)">'+(row.expanded?'â–¼':'â–¶')+'</span>':'';
    const startStr=row.startDate?formatDateShort(row.startDate):'â€”';
    const endStr=row.endDate?formatDateShort(row.endDate):'â€”';
    const duration=row.startDate&&row.endDate?Math.max(1,Math.ceil((row.endDate-row.startDate)/dayMs)):'â€”';
    const startISO=row.startDate?row.startDate.toISOString().split('T')[0]:'';
    const endISO=row.endDate?row.endDate.toISOString().split('T')[0]:'';
    const nameLink=row.type==='asm'?'<span class="gantt-asm-link" onclick="window.goToAsm('+row.id+')">'+esc(row.name)+'</span>':'<span>'+esc(row.name)+'</span>';
    sidebarHtml+='<div class="gantt-sidebar-row '+rowClass+'" data-row-type="'+row.type+'" data-row-id="'+row.id+'"><div class="gantt-col-name">'+toggle+nameLink+'</div><div class="gantt-col-start" data-field="start" data-date="'+startISO+'">'+startStr+'</div><div class="gantt-col-end" data-field="end" data-date="'+endISO+'">'+endStr+'</div><div class="gantt-col-dur">'+duration+'</div></div>';
  });
  $('ganttSidebar').innerHTML=sidebarHtml;

  // Render timeline body with bars
  let bodyHtml='';
  const todayIdx=days.findIndex(d=>d.isToday);

  rows.forEach((row,rowIdx)=>{
    const rowClass=row.type==='asm'?'asm':'';
    let cellsHtml='';
    days.forEach(day=>{
      const classes=['gantt-timeline-cell'];
      if(day.isWeekend)classes.push('weekend');
      cellsHtml+='<div class="'+classes.join(' ')+'" style="min-width:'+cellWidth+'px;width:'+cellWidth+'px"></div>';
    });

    // Calculate bar position
    let barHtml='';
    if(row.startDate&&row.endDate){
      const startIdx=days.findIndex(d=>d.date>=row.startDate);
      const endIdx=days.findIndex(d=>d.date>row.endDate);
      const barStart=Math.max(0,startIdx)*cellWidth;
      const barEnd=(endIdx>=0?endIdx:days.length)*cellWidth;
      const barWidth=Math.max(cellWidth,barEnd-barStart);
      
      const barClass=row.type==='asm'?'asm':row.status;
      const label=row.type==='asm'?'':SLABELS[row.status]||'';
      
      // Custom color support
      const customColor=ganttBarColors[row.type+'-'+row.id];
      const colorStyle=customColor?'background:'+customColor+';':'';
      
      barHtml='<div class="gantt-bar-container" style="left:'+barStart+'px;width:'+barWidth+'px"><div class="gantt-bar '+barClass+'" data-bar-type="'+row.type+'" data-bar-id="'+row.id+'" style="width:100%;'+colorStyle+'"><span class="gantt-bar-label">'+label+'</span></div></div>';
    }

    bodyHtml+='<div class="gantt-timeline-row '+rowClass+'" style="width:'+totalWidth+'px">'+cellsHtml+barHtml+'</div>';
  });

  // Add today line
  if(todayIdx>=0){
    const todayPos=todayIdx*cellWidth+cellWidth/2;
    bodyHtml+='<div class="gantt-today-line" style="left:'+todayPos+'px"><div class="gantt-today-marker">Today</div></div>';
  }

  $('ganttTimelineBody').innerHTML=bodyHtml;
  $('ganttTimelineBody').style.width=totalWidth+'px';
  $('ganttTimelineHeader').style.width=totalWidth+'px';

  // Scroll to today on first render
  if(todayIdx>=0&&!window._ganttScrolled){
    const container=$('ganttBodyWrap');
    if(container){
      const scrollPos=Math.max(0,todayIdx*cellWidth-container.clientWidth/2+320);
      container.scrollLeft=scrollPos;
      $('ganttTimelineHeaderWrap').scrollLeft=scrollPos;
      window._ganttScrolled=true;
    }
  }
}

function getPartProgress(p){
  const stages=['to-order','ordered','arrived','tested','configured','installed'];
  const idx=stages.indexOf(p.status);
  if(idx<0)return 0;
  return Math.round((idx/(stages.length-1))*100);
}

window.toggleGanttAsm=(asmId,e)=>{
  e&&e.stopPropagation();
  ganttExpanded[asmId]=ganttExpanded[asmId]===false?true:false;
  renderGantt();
};

// Date input handlers
$('ganttInputStart').onchange=()=>{
  projectDates.start=$('ganttInputStart').value;
  save();
  window._ganttScrolled=false;
  renderGantt();
};
$('ganttInputEnd').onchange=()=>{
  projectDates.end=$('ganttInputEnd').value;
  save();
  renderGantt();
};

$('ganttToday').onclick=()=>{
  const container=$('ganttBodyWrap');
  const todayLine=document.querySelector('.gantt-today-line');
  if(container&&todayLine){
    const pos=parseInt(todayLine.style.left)||0;
    container.scrollTo({left:Math.max(0,pos-container.clientWidth/2+320),behavior:'smooth'});
  }
};

// Sync horizontal scroll between header and body
$('ganttBodyWrap').addEventListener('scroll',function(){
  $('ganttTimelineHeaderWrap').scrollLeft=this.scrollLeft;
});

// Drag to scroll with momentum
(function(){
  const container=$('ganttBodyWrap');
  if(!container)return;
  
  let isDragging=false;
  let startX=0;
  let scrollStartX=0;
  let velocity=0;
  let lastX=0;
  let lastTime=0;
  let momentumId=null;
  
  container.addEventListener('mousedown',e=>{
    if(e.target.closest('.gantt-bar')||e.target.closest('.gantt-col-start')||e.target.closest('.gantt-col-end')){return;}
    isDragging=true;
    startX=e.pageX;
    scrollStartX=container.scrollLeft;
    lastX=e.pageX;
    lastTime=Date.now();
    velocity=0;
    container.classList.add('grabbing');
    if(momentumId){cancelAnimationFrame(momentumId);momentumId=null;}
    e.preventDefault();
  });
  
  document.addEventListener('mousemove',e=>{
    if(!isDragging)return;
    const x=e.pageX;
    const walk=startX-x;
    container.scrollLeft=scrollStartX+walk;
    
    // Calculate velocity
    const now=Date.now();
    const dt=now-lastTime;
    if(dt>0){
      velocity=(lastX-x)/dt;
    }
    lastX=x;
    lastTime=now;
  });
  
  document.addEventListener('mouseup',()=>{
    if(!isDragging)return;
    isDragging=false;
    container.classList.remove('grabbing');
    
    // Apply momentum
    if(Math.abs(velocity)>0.1){
      const deceleration=0.95;
      const minVelocity=0.1;
      
      function applyMomentum(){
        if(Math.abs(velocity)<minVelocity){
          momentumId=null;
          return;
        }
        container.scrollLeft+=velocity*16;
        velocity*=deceleration;
        momentumId=requestAnimationFrame(applyMomentum);
      }
      applyMomentum();
    }
  });
  
  // Cancel momentum on new interaction
  container.addEventListener('wheel',()=>{
    if(momentumId){cancelAnimationFrame(momentumId);momentumId=null;}
  });
})();

// Color picker for bars
const ganttColors=['#ff6b6b','#ffa94d','#ffd43b','#69db7c','#38d9a9','#4dabf7','#748ffc','#da77f2','#f783ac','#868e96'];

function renderGanttColorGrid(){
  $('ganttColorGrid').innerHTML=ganttColors.map(c=>'<div class="gantt-color-swatch" data-color="'+c+'" style="background:'+c+'"></div>').join('');
}
renderGanttColorGrid();

let colorPickerTarget=null;

document.addEventListener('click',e=>{
  const bar=e.target.closest('.gantt-bar');
  const popup=$('ganttColorPopup');
  
  // Close popup if clicking outside
  if(!bar&&!popup.contains(e.target)){
    popup.classList.remove('open');
    colorPickerTarget=null;
    return;
  }
  
  // Open popup for bar click
  if(bar&&!e.target.closest('.gantt-color-popup')){
    const barType=bar.dataset.barType;
    const barId=bar.dataset.barId;
    if(!barType||!barId)return;
    
    colorPickerTarget={type:barType,id:barId};
    const rect=bar.getBoundingClientRect();
    const panelRect=$('ganttPanel').getBoundingClientRect();
    
    popup.style.left=(rect.left-panelRect.left+rect.width/2-80)+'px';
    popup.style.top=(rect.bottom-panelRect.top+8)+'px';
    popup.classList.add('open');
    
    // Highlight current color
    const currentColor=ganttBarColors[barType+'-'+barId];
    document.querySelectorAll('.gantt-color-swatch').forEach(s=>{
      s.classList.toggle('selected',s.dataset.color===currentColor);
    });
  }
});

$('ganttColorGrid').addEventListener('click',e=>{
  const swatch=e.target.closest('.gantt-color-swatch');
  if(!swatch||!colorPickerTarget)return;
  
  const color=swatch.dataset.color;
  const key=colorPickerTarget.type+'-'+colorPickerTarget.id;
  ganttBarColors[key]=color;
  
  // Update the bar immediately
  const bar=document.querySelector('.gantt-bar[data-bar-type="'+colorPickerTarget.type+'"][data-bar-id="'+colorPickerTarget.id+'"]');
  if(bar)bar.style.background=color;
  
  $('ganttColorPopup').classList.remove('open');
  colorPickerTarget=null;
  
  // Save colors
  try{localStorage.setItem('ganttBarColors',JSON.stringify(ganttBarColors))}catch(e){}
});

// Load saved colors
try{
  const saved=localStorage.getItem('ganttBarColors');
  if(saved)ganttBarColors=JSON.parse(saved);
}catch(e){}

// Date picker popup for gantt row dates
let datePickerTarget=null;

$('ganttSidebar').addEventListener('click',e=>{
  const dateCell=e.target.closest('.gantt-col-start, .gantt-col-end');
  if(!dateCell)return;
  
  const row=dateCell.closest('.gantt-sidebar-row');
  if(!row)return;
  
  const rowType=row.dataset.rowType;
  const rowId=row.dataset.rowId;
  const field=dateCell.dataset.field;
  const currentDate=dateCell.dataset.date||'';
  
  datePickerTarget={type:rowType,id:parseInt(rowId),field};
  
  $('ganttDatePopupTitle').textContent=field==='start'?'Start Date':'End Date';
  $('ganttDatePopupInput').value=currentDate;
  
  const popup=$('ganttDatePopup');
  const rect=dateCell.getBoundingClientRect();
  const panelRect=$('ganttPanel').getBoundingClientRect();
  
  popup.style.left=(rect.left-panelRect.left)+'px';
  popup.style.top=(rect.bottom-panelRect.top+4)+'px';
  popup.classList.add('open');
  
  setTimeout(()=>$('ganttDatePopupInput').focus(),50);
});

$('ganttDatePopupSave').onclick=()=>{
  if(!datePickerTarget)return;
  const newDate=$('ganttDatePopupInput').value;
  
  if(datePickerTarget.type==='part'){
    const part=data.find(d=>d.id===datePickerTarget.id);
    if(part){
      if(datePickerTarget.field==='start'){
        // Store as epoch ms for consistency with orderedAt
        part.orderedAt=newDate?new Date(newDate).getTime():undefined;
      }else{
        // expectedArrival stays as ISO string for backward compatibility
        part.expectedArrival=newDate||undefined;
      }
      save();
      renderGantt();
    }
  }else if(datePickerTarget.type==='asm'){
    // For assemblies, we could store custom dates - for now just close
    toast('Assembly dates follow project dates');
  }
  
  $('ganttDatePopup').classList.remove('open');
  datePickerTarget=null;
};

$('ganttDatePopupClear').onclick=()=>{
  if(!datePickerTarget)return;
  
  if(datePickerTarget.type==='part'){
    const part=data.find(d=>d.id===datePickerTarget.id);
    if(part){
      if(datePickerTarget.field==='start'){
        part.orderedAt=undefined;
      }else{
        part.expectedArrival=undefined;
      }
      save();
      renderGantt();
    }
  }
  
  $('ganttDatePopup').classList.remove('open');
  datePickerTarget=null;
};

// Close date popup when clicking outside
document.addEventListener('click',e=>{
  const popup=$('ganttDatePopup');
  if(popup.classList.contains('open')&&!popup.contains(e.target)&&!e.target.closest('.gantt-col-start')&&!e.target.closest('.gantt-col-end')){
    popup.classList.remove('open');
    datePickerTarget=null;
  }
});

function generateAIInsights(){
  const insights=[],parts=getParts();
  const today=new Date().toISOString().split('T')[0];
  const now=Date.now(),day=86400000;
  const pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast();
  const overdueActions=actions.filter(a=>a.status!=='completed'&&a.due&&a.due<today);
  if(overdueActions.length>0){insights.push({level:'critical',icon:'âš ',title:overdueActions.length+' overdue action'+(overdueActions.length>1?'s':''),desc:overdueActions.map(a=>a.task).slice(0,2).join(', '),action:'View in Action Plan â†’',handler:()=>{document.querySelector('[data-tab="actions"]').click();hidePopoverModal($('aiModal'))}})}
  if(forecast&&forecast.status==='at-risk'){insights.push({level:'critical',icon:'ðŸ“‰',title:'Completion at risk',desc:'At current rate, finishing '+(forecast.daysToComplete-forecast.daysLeft)+' days late',action:'Review metrics â†’',handler:()=>{window.toggleMetricsPopover({stopPropagation:()=>{}});hidePopoverModal($('aiModal'))}})}
  if(expected!==null&&pct<expected-10){insights.push({level:'critical',icon:'ðŸ“Š',title:'Behind schedule',desc:(expected-pct)+'% behind target progress',action:'Review metrics â†’',handler:()=>{window.toggleMetricsPopover({stopPropagation:()=>{}});hidePopoverModal($('aiModal'))}})}
  const stuckParts=parts.filter(p=>p.status==='to-order'&&p.changedAt&&(now-p.changedAt)>5*day);
  if(stuckParts.length>0){insights.push({level:'warning',icon:'â³',title:stuckParts.length+' part'+(stuckParts.length>1?'s':'')+' waiting >5 days',desc:stuckParts.map(p=>p.name).slice(0,2).join(', '),action:'View parts â†’',handler:()=>{filterStage='to-order';render();hidePopoverModal($('aiModal'))}})}
  const longTransit=parts.filter(p=>p.status==='ordered'&&p.changedAt&&(now-p.changedAt)>7*day);
  if(longTransit.length>0){insights.push({level:'warning',icon:'ðŸ“¦',title:longTransit.length+' part'+(longTransit.length>1?'s':'')+' in transit >7d',desc:'Follow up with suppliers',action:'View parts â†’',handler:()=>{filterStage='ordered';render();hidePopoverModal($('aiModal'))}})}
  const missingEta=parts.filter(p=>(p.status==='to-order'||p.status==='ordered')&&getPartETA(p).type==='unknown');
  if(missingEta.length>0){insights.push({level:'warning',icon:'â“',title:missingEta.length+' part'+(missingEta.length>1?'s':'')+' missing ETA',desc:'Add lead time data for planning',action:'Set ETA â†’',handler:()=>{if(missingEta[0])window.openEtaModal(missingEta[0].id);hidePopoverModal($('aiModal'))}})}
  const otd=calcSupplierOTD();
  if(otd!==null&&otd<80){insights.push({level:'warning',icon:'ðŸšš',title:'Supplier OTD: '+otd+'%',desc:'Consider adding buffer to estimates',action:'View lead times â†’',handler:()=>{renderLeadTimeModal();$('leadtimeModal').classList.add('open');hidePopoverModal($('aiModal'))}})}
  if(forecast&&forecast.status==='ahead'){insights.push({level:'success',icon:'ðŸŽ¯',title:'Ahead of schedule',desc:'Est. completion '+(forecast.daysLeft-forecast.daysToComplete)+' days early',action:null,handler:null})}
  const readyToInstall=parts.filter(p=>p.status==='tested');
  if(readyToInstall.length>0){insights.push({level:'info',icon:'âœ“',title:readyToInstall.length+' ready to install',desc:readyToInstall.map(p=>p.name).slice(0,3).join(', '),action:'Install now â†’',handler:()=>{filterStage='tested';render();hidePopoverModal($('aiModal'))}})}
  if(insights.length===0){insights.push({level:'success',icon:'âœ“',title:'All systems nominal',desc:'No issues detected',action:null,handler:null})}
  return insights;
}

function updateAIAlert(){
  // Just generate insights for caching
  window._aiInsights=generateAIInsights();
}

// ============================================
// Event Logging for AI Learning
// ============================================
const eventLogRef=db.ref('analytics/events');

function logEvent(type,eventData){
  const event={
    timestamp:Date.now(),
    type,
    projectName:currentProjectName,
    ...eventData
  };
  eventLogRef.push(event).catch(e=>console.warn('Event log failed:',e));
}

function logArrival(part,daysInTransit,wasLate,daysDelta){
  logEvent('arrival',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    daysInTransit,
    expectedArrival:part.expectedArrival||null,
    wasLate,
    daysDelta,
    assemblyId:part.parentId,
    assemblyName:getAsms().find(a=>a.id===part.parentId)?.name||''
  });
}

function logStuck(part,stage,daysStuck){
  logEvent('stuck',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    stage,
    daysStuck,
    assemblyId:part.parentId
  });
}

function logEtaMiss(part,expectedDate,actualDate,daysDelta){
  logEvent('eta_miss',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    expectedDate,
    actualDate,
    daysDelta
  });
}

function logComment(part,text){
  logEvent('comment',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    assemblyId:part.parentId,
    text:text.slice(0,500),
    partStatus:part.status
  });
}

function logActionOverdue(action,daysOverdue){
  logEvent('action_overdue',{
    actionId:action.id,
    task:action.task,
    assignee:action.assignee||'',
    daysOverdue,
    linkedPartId:action.linkedPartId||null
  });
}

// ============================================
// AI Report Generation (LLM-Powered)
// ============================================
let currentAIMode='quick';
let aiCache={quick:null,standup:null,risks:null};
let aiCacheTime={quick:0,standup:0,risks:0};
const AI_CACHE_TTL=60000; // 1 minute cache
let aiConversation=[];

function detectQuestionType(question){
  if(!question)return 'general';
  const q=question.toLowerCase();
  
  // Velocity/speed related
  if(/velocit|speed|pace|accelerat|slow|fast|rate|throughput|transition/.test(q))return 'velocity';
  
  // Bottleneck/stuck related
  if(/bottleneck|stuck|block|wait|delay|held up|holding/.test(q))return 'bottleneck';
  
  // Lead time/supplier related
  if(/lead\s*time|supplier|vendor|delivery|ship|transit|eta|arrival|on-?time/.test(q))return 'leadtime';
  
  // Workload/team related
  if(/workload|team|assign|who|balance|capacity|resource/.test(q))return 'workload';
  
  // Progress/forecast related
  if(/progress|forecast|complete|finish|deadline|schedule|behind|ahead|risk|estimat/.test(q))return 'forecast';
  
  // Action/task related
  if(/action|task|todo|overdue|due|upcoming/.test(q))return 'actions';
  
  // Specific part/assembly query
  if(/which part|what part|show.*part|list.*part|find.*part/.test(q))return 'parts';
  
  return 'general';
}

function buildProjectContext(question){
  const parts=getParts();
  const asms=getAsms();
  const today=new Date().toISOString().split('T')[0];
  const now=Date.now(),day=86400000;
  const questionType=detectQuestionType(question);
  
  // Always include: basic project stats
  const byStatus={};
  STAGES.forEach(s=>byStatus[s]=parts.filter(p=>p.status===s).length);
  
  const totalParts=parts.length;
  const installedParts=byStatus.installed||0;
  const remainingParts=totalParts-installedParts;
  const velocity=getVelocity();
  const daysLeft=getDaysRemaining();
  const daysNeeded=velocity&&velocity>0?Math.ceil(remainingParts/velocity):null;
  
  // Base context (always included)
  const context={
    project:{
      name:currentProjectName,
      progress:calcOverallProgress(),
      velocity,
      daysLeft,
      startDate:projectDates.start,
      endDate:projectDates.end
    },
    counts:{
      total:totalParts,
      remaining:remainingParts,
      assemblies:asms.length,
      ...byStatus
    },
    questionType // Tell the LLM what we detected
  };
  
  // VELOCITY: focus on transitions and timing
  if(questionType==='velocity'||questionType==='general'){
    const recentTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)<14*day).map(p=>({
      id:p.id,
      name:p.name,
      status:p.status,
      daysAgo:Math.floor((now-p.changedAt)/day)
    }));
    const weekAgoCount=recentTransitions.filter(t=>t.daysAgo<=7).length;
    const priorWeekCount=recentTransitions.filter(t=>t.daysAgo>7&&t.daysAgo<=14).length;
    context.velocity={
      current:velocity,
      transitionsThisWeek:weekAgoCount,
      transitionsLastWeek:priorWeekCount,
      trend:priorWeekCount>0?Math.round((weekAgoCount-priorWeekCount)/priorWeekCount*100):0,
      recentMoves:recentTransitions.slice(0,10)
    };
    context.progressHistory=history.slice(-14).map(h=>({date:h.date,pct:h.pct}));
  }
  
  // BOTTLENECK: focus on dwell times per stage
  if(questionType==='bottleneck'||questionType==='general'){
    const stageDwell={};
    STAGES.forEach(s=>{
      const inStage=parts.filter(p=>p.status===s&&p.changedAt);
      if(inStage.length>0){
        const avgDays=Math.round(inStage.reduce((sum,p)=>sum+(now-p.changedAt),0)/inStage.length/day);
        const maxDays=Math.round(Math.max(...inStage.map(p=>(now-p.changedAt)/day)));
        stageDwell[s]={count:inStage.length,avgDays,maxDays};
      }
    });
    context.bottleneck={stageDwell};
    
    // Top stuck items (limit to 5)
    context.stuck=parts.filter(p=>p.changedAt&&(now-p.changedAt)>5*day&&p.status!=='installed')
      .map(p=>({id:p.id,name:p.name,status:p.status,days:Math.floor((now-p.changedAt)/day)}))
      .sort((a,b)=>b.days-a.days)
      .slice(0,8);
  }
  
  // LEAD TIME: focus on supplier performance
  if(questionType==='leadtime'||questionType==='general'){
    const arrivedWithDates=parts.filter(p=>p.orderedAt&&p.arrivedAt);
    let avgLead=0,onTimeRate=null;
    if(arrivedWithDates.length>=2){
      const leadTimes=arrivedWithDates.map(p=>Math.round((p.arrivedAt-p.orderedAt)/day));
      avgLead=Math.round(leadTimes.reduce((a,b)=>a+b,0)/leadTimes.length);
      
      const withEta=arrivedWithDates.filter(p=>p.expectedArrival);
      if(withEta.length>=2){
        const onTime=withEta.filter(p=>p.arrivedAt<=new Date(p.expectedArrival).getTime()+day);
        onTimeRate=Math.round(onTime.length/withEta.length*100);
      }
    }
    
    // Supplier breakdown
    const mfrPerf={};
    parts.filter(p=>p.mfr).forEach(p=>{
      if(!mfrPerf[p.mfr])mfrPerf[p.mfr]={total:0,inTransit:0,leadTimes:[]};
      mfrPerf[p.mfr].total++;
      if(p.status==='ordered')mfrPerf[p.mfr].inTransit++;
      if(p.orderedAt&&p.arrivedAt)mfrPerf[p.mfr].leadTimes.push(Math.round((p.arrivedAt-p.orderedAt)/day));
    });
    
    context.leadTime={
      avgDays:avgLead,
      onTimeRate,
      suppliers:Object.entries(mfrPerf).map(([mfr,d])=>({
        name:mfr,
        total:d.total,
        inTransit:d.inTransit,
        avgLead:d.leadTimes.length?Math.round(d.leadTimes.reduce((a,b)=>a+b,0)/d.leadTimes.length):null
      })).filter(s=>s.total>=2).slice(0,5)
    };
  }
  
  // WORKLOAD: focus on assignee distribution
  if(questionType==='workload'||questionType==='general'){
    const assigneeWork={};
    parts.filter(p=>p.status!=='installed').forEach(p=>{
      const assignee=p.assignee||'Unassigned';
      if(!assigneeWork[assignee])assigneeWork[assignee]={total:0,byStatus:{}};
      assigneeWork[assignee].total++;
      assigneeWork[assignee].byStatus[p.status]=(assigneeWork[assignee].byStatus[p.status]||0)+1;
    });
    context.workload=Object.entries(assigneeWork)
      .map(([name,d])=>({name,total:d.total,byStatus:d.byStatus}))
      .sort((a,b)=>b.total-a.total);
  }
  
  // FORECAST: focus on schedule risk
  if(questionType==='forecast'||questionType==='general'){
    context.forecast=getVelocityForecast();
    context.project.daysNeeded=daysNeeded;
    context.project.buffer=daysLeft&&daysNeeded?(daysLeft-daysNeeded):null;
    
    // Assembly progress (limit to struggling ones)
    context.asmProgress=asms.map(a=>({
      name:a.name,
      progress:calcAsmProgress(a.id),
      partCount:parts.filter(p=>p.parentId===a.id).length
    })).filter(a=>a.progress<80).sort((a,b)=>a.progress-b.progress).slice(0,5);
  }
  
  // ACTIONS: focus on tasks
  if(questionType==='actions'||questionType==='general'){
    const nextWeek=new Date(now+7*day).toISOString().split('T')[0];
    context.actions={
      overdue:actions.filter(a=>a.status!=='completed'&&a.due&&a.due<today)
        .map(a=>({task:a.task,assignee:a.assignee||'Unassigned',daysOverdue:Math.floor((new Date(today)-new Date(a.due))/day)}))
        .slice(0,5),
      upcoming:actions.filter(a=>a.status!=='completed'&&a.due&&a.due>=today&&a.due<=nextWeek)
        .map(a=>({task:a.task,assignee:a.assignee||'Unassigned',due:a.due}))
        .slice(0,5),
      completed:actions.filter(a=>a.status==='completed').length,
      total:actions.length
    };
  }
  
  // PARTS: Always include part list (limited) so AI can link to specific parts
  // Include stuck/problematic parts first, then sample others
  const stuckParts=parts.filter(p=>p.changedAt&&(now-p.changedAt)>5*day&&p.status!=='installed')
    .sort((a,b)=>(b.changedAt||0)-(a.changedAt||0));
  const recentParts=parts.filter(p=>p.changedAt&&(now-p.changedAt)<=5*day)
    .sort((a,b)=>(b.changedAt||0)-(a.changedAt||0));
  const otherParts=parts.filter(p=>!stuckParts.includes(p)&&!recentParts.includes(p));
  
  // Combine: stuck first, then recent activity, then others - include ALL parts
  const prioritizedParts=[...stuckParts,...recentParts,...otherParts];
  context.partsList=prioritizedParts.map(p=>{
    const asm=asms.find(a=>a.id===p.parentId);
    const daysInStatus=p.changedAt?Math.floor((now-p.changedAt)/day):0;
    const part={
      id:p.id,
      name:p.name,
      status:p.status,
      daysInStatus
    };
    // Only include non-empty fields
    if(asm?.name)part.assembly=asm.name;
    if(p.assignee)part.assignee=p.assignee;
    if(p.poNumber)part.poNumber=p.poNumber;
    if(p.mfr)part.mfr=p.mfr;
    if(p.code)part.code=p.code;
    if(p.qty&&p.qty>1)part.qty=p.qty;
    if(p.expectedArrival)part.expectedArrival=p.expectedArrival;
    if(p.orderedAt)part.orderedAt=new Date(p.orderedAt).toISOString().split('T')[0];
    if(p.arrivedAt)part.arrivedAt=new Date(p.arrivedAt).toISOString().split('T')[0];
    if(p.pendingNote)part.pendingNote=p.pendingNote;
    if(p.notes)part.notes=p.notes;
    if(p.comments?.length)part.commentCount=p.comments.length;
    return part;
  });
  
  return context;
}

function getDaysRemaining(){
  if(!projectDates.end)return null;
  const end=new Date(projectDates.end);
  const now=new Date();
  return Math.max(0,Math.ceil((end-now)/(86400000)));
}

function getVelocity(){
  if(history.length<2)return null;
  const recent=history.slice(-7);
  if(recent.length<2)return null;
  const days=Math.max(1,(new Date(recent[recent.length-1].date)-new Date(recent[0].date))/(86400000));
  const progress=recent[recent.length-1].pct-recent[0].pct;
  const partsPerDay=(progress/100)*getParts().length/days;
  return Math.round(partsPerDay*10)/10;
}

async function generateAIReport(mode,question){
  const context=buildProjectContext();
  
  // Quick mode uses local generation (instant, no API call)
  if(mode==='quick'){
    $('aiModelBadge').textContent='';
    return generateLocalReport(mode,context);
  }
  
  // AI modes use Claude via Cloud Function
  try{
    console.log('Calling Cloud Function for mode:',mode);
    $('aiModelBadge').innerHTML='<span class="thinking-pulse">thinking...</span>';
    $('aiModelBadgeWs').innerHTML='<span class="thinking-pulse">thinking...</span>';
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const payload={
      mode,
      projectContext:context,
      maxChars:1000,
      style:'concise',
      model:selectedAIModel
    };
    if(question)payload.question=question;
    
    const result=await generateInsights(payload);
    
    // Log model verification
    const requestedModel=selectedAIModel;
    const returnedModel=result.data?.model||'unknown';
    console.log('ðŸ¤– AI Model Verification:');
    console.log('   Requested:', requestedModel);
    console.log('   Returned:', returnedModel);
    console.log('   Match:', requestedModel===returnedModel ? 'âœ… YES' : 'âŒ NO');
    
    if(result.data?.success){
      // Use the RETURNED model from API, not the requested one
      const actualModel=result.data.model||selectedAIModel;
      const modelName=AI_MODELS[actualModel]?.name||actualModel;
      $('aiModelBadge').innerHTML=modelName+' <span style="opacity:0.5;margin-left:2px">â–¾</span>';
      $('aiModelBadgeWs').innerHTML=modelName+' <span style="opacity:0.5">â–¾</span>';
      lastUsedModel=actualModel;
      return formatClaudeResponse(result.data.content,mode,actualModel);
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Cloud function failed:',e);
    $('aiModelBadge').innerHTML='offline <span style="opacity:0.5;margin-left:2px">â–¾</span>';
    $('aiModelBadgeWs').innerHTML='offline <span style="opacity:0.5">â–¾</span>';
    return '<div class="ai-prose"><p>Unable to connect to AI service. Please try again.</p></div>';
  }
}

function formatClaudeResponse(text,mode,usedModel){
  let html=text;
  
  // Check for SVG response - render directly
  if(html.trim().startsWith('<svg')){
    return '<div class="ai-visual">'+html+'</div>';
  }
  
  // Check for structured action response [ACTION:type:param]
  html=html.replace(/\[ACTION:filter:([^\]]+)\]/g,(match,stage)=>{
    return '<button class="ai-action-btn" onclick="window.aiFilterStage(\''+stage+'\')"><span>Show '+stage.replace('-',' ')+' parts</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>';
  });
  
  html=html.replace(/\[ACTION:highlight:([^\]]+)\]/g,(match,ids)=>{
    return '<button class="ai-action-btn" onclick="window.highlightParts(['+ids+'])"><span>Highlight these parts</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>';
  });
  
  // Check for mini chart markers [CHART:type:data]
  html=html.replace(/\[CHART:bar:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label,val:parseInt(val)};
      });
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*40+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 340 '+h+'" width="340">';
      items.forEach((item,i)=>{
        const w=Math.round(item.val/max*180);
        const y=i*40+10;
        svg+='<text x="8" y="'+(y+24)+'" font-size="13" fill="var(--text2)">'+item.label+'</text>';
        svg+='<rect x="130" y="'+(y+8)+'" width="'+w+'" height="24" rx="6" fill="var(--accent)" opacity="0.75"/>';
        svg+='<text x="'+(140+w)+'" y="'+(y+26)+'" font-size="14" fill="var(--text)" font-weight="500">'+item.val+'</text>';
      });
      svg+='</svg>';
      return '<div class="ai-visual">'+svg+'</div>';
    }catch(e){return '';}
  });
  
  // Funnel chart for pipeline
  html=html.replace(/\[CHART:funnel:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label,val:parseInt(val)};
      });
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*44+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 360 '+h+'" width="360">';
      items.forEach((item,i)=>{
        const w=Math.round(item.val/max*180);
        const x=(180-w)/2+100;
        const y=i*44+10;
        svg+='<text x="8" y="'+(y+26)+'" font-size="12" fill="var(--text3)">'+item.label+'</text>';
        svg+='<rect x="'+x+'" y="'+(y+8)+'" width="'+w+'" height="28" rx="6" fill="var(--s'+((i%6)+1)+')" opacity="0.85"/>';
        svg+='<text x="300" y="'+(y+28)+'" font-size="14" fill="var(--text)" font-weight="600">'+item.val+'</text>';
      });
      svg+='</svg>';
      return '<div class="ai-visual">'+svg+'</div>';
    }catch(e){return '';}
  });
  
  // Escape HTML first (but preserve our generated HTML)
  const visualParts=[];
  html=html.replace(/<div class="ai-visual">[\s\S]*?<\/div>/g,(match)=>{
    visualParts.push(match);
    return '{{VISUAL'+(visualParts.length-1)+'}}';
  });
  const btnParts=[];
  html=html.replace(/<button class="ai-action-btn"[^>]*>.*?<\/button>/g,(match)=>{
    btnParts.push(match);
    return '{{BTN'+(btnParts.length-1)+'}}';
  });
  
  html=esc(html);
  
  // Restore visual parts
  visualParts.forEach((v,i)=>{html=html.replace('{{VISUAL'+i+'}}',v);});
  btnParts.forEach((b,i)=>{html=html.replace('{{BTN'+i+'}}',b);});
  
  // Replace [[Part Name]] with clickable links
  html=html.replace(/\[\[([^\]]+)\]\]/g,(match,partName)=>{
    // Try exact match first (case-insensitive)
    let part=getParts().find(p=>p.name.toLowerCase()===partName.toLowerCase().trim());
    
    // If no exact match, try partial match (part name contains the linked text or vice versa)
    if(!part){
      const searchName=partName.toLowerCase().trim();
      part=getParts().find(p=>
        p.name.toLowerCase().includes(searchName) || 
        searchName.includes(p.name.toLowerCase())
      );
    }
    
    // If still no match, try matching just the first word
    if(!part){
      const firstWord=partName.toLowerCase().trim().split(/\s+/)[0];
      if(firstWord.length>3){
        part=getParts().find(p=>p.name.toLowerCase().startsWith(firstWord));
      }
    }
    
    if(part){
      return '<a class="ai-part-link" href="#" onclick="window.aiGoToPart('+part.id+',event);return false;">'+partName+'</a>';
    }
    return partName;
  });
  
  // Replace {{Assembly Name}} with clickable links  
  html=html.replace(/\{\{([^\}]+)\}\}/g,(match,asmName)=>{
    const asm=getAsms().find(a=>a.name.toLowerCase()===asmName.toLowerCase());
    if(asm){
      return '<a class="ai-asm-link" href="#" onclick="window.aiGoToAsm('+asm.id+');return false;">'+asmName+'</a>';
    }
    return asmName;
  });
  
  // Replace **bold** with <strong>
  html=html.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  
  // Process line by line
  const lines=html.split('\n');
  let result=[];
  let inList=false;
  let listItems=[];
  
  const flushList=()=>{
    if(listItems.length){
      result.push('<ul>'+listItems.map(li=>'<li>'+li+'</li>').join('')+'</ul>');
      listItems=[];
    }
    inList=false;
  };
  
  lines.forEach(line=>{
    const trimmed=line.trim();
    if(!trimmed)return;
    
    // Check for section header (ALL CAPS followed by colon)
    if(/^[A-Z][A-Z\s]+:$/.test(trimmed)){
      flushList();
      result.push('<h4 class="ai-section-header">'+trimmed.replace(':','')+'</h4>');
      return;
    }
    
    // Check for bullet point
    if(/^[â€¢\-\*]\s/.test(trimmed)){
      inList=true;
      listItems.push(trimmed.replace(/^[â€¢\-\*]\s*/,''));
      return;
    }
    
    // Check for numbered item
    if(/^\d+[\.\)]\s/.test(trimmed)){
      inList=true;
      listItems.push(trimmed.replace(/^\d+[\.\)]\s*/,''));
      return;
    }
    
    // Regular text - flush any pending list and add as paragraph
    flushList();
    result.push('<p>'+trimmed+'</p>');
  });
  
  flushList();
  
  // Add model attribution
  const modelAttribution=usedModel?'<div class="ai-model-attribution" title="Response generated by '+usedModel+'">'+( AI_MODELS[usedModel]?.name||usedModel)+'</div>':'';
  
  return '<div class="ai-prose">'+result.join('')+modelAttribution+'</div>';
}

// Navigation functions for AI links
let currentPartInfoId=null;

window.aiGoToPart=function(partId,e){
  const part=data.find(d=>d.id===partId);
  if(!part)return;
  
  currentPartInfoId=partId;
  const asm=data.find(d=>d.id===part.parentId);
  
  // Build popover content
  $('partInfoName').textContent=part.name;
  
  let bodyHtml='';
  bodyHtml+='<div class="part-info-row"><span class="part-info-label">Status</span><span class="part-info-value status '+part.status+'">'+SLABELS[part.status]+'</span></div>';
  if(part.code)bodyHtml+='<div class="part-info-row"><span class="part-info-label">Code</span><span class="part-info-value">'+esc(part.code)+'</span></div>';
  if(part.mfr)bodyHtml+='<div class="part-info-row"><span class="part-info-label">Manufacturer</span><span class="part-info-value">'+esc(part.mfr)+'</span></div>';
  if(asm)bodyHtml+='<div class="part-info-row"><span class="part-info-label">Assembly</span><span class="part-info-value">'+esc(asm.name)+'</span></div>';
  if(part.assignee)bodyHtml+='<div class="part-info-row"><span class="part-info-label">Assignee</span><span class="part-info-value">'+esc(part.assignee)+'</span></div>';
  if(part.poNumber)bodyHtml+='<div class="part-info-row"><span class="part-info-label">PO Number</span><span class="part-info-value">'+esc(part.poNumber)+'</span></div>';
  if(part.expectedArrival)bodyHtml+='<div class="part-info-row"><span class="part-info-label">Expected</span><span class="part-info-value">'+part.expectedArrival+'</span></div>';
  
  const daysInStatus=Math.floor((Date.now()-(part.changedAt||Date.now()))/(1000*60*60*24));
  bodyHtml+='<div class="part-info-row"><span class="part-info-label">Days in Status</span><span class="part-info-value">'+daysInStatus+'</span></div>';
  
  if(part.notes){
    bodyHtml+='<div class="part-info-notes">'+esc(part.notes)+'</div>';
  }
  
  $('partInfoBody').innerHTML=bodyHtml;
  
  // Position popover near clicked link
  const popover=$('partInfoPopover');
  const link=e?.target?.closest('a')||e?.target;
  if(link){
    const rect=link.getBoundingClientRect();
    popover.style.top=(rect.bottom+8)+'px';
    popover.style.left=Math.min(rect.left,window.innerWidth-380)+'px';
  }else{
    popover.style.top='100px';
    popover.style.left='50%';
    popover.style.transform='translateX(-50%)';
  }
  
  popover.classList.add('open');
};

window.goToPartFromPopover=function(){
  if(!currentPartInfoId)return;
  const partId=currentPartInfoId;
  $('partInfoPopover').classList.remove('open');
  closeAIWorkspace();
  hidePopoverModal($('aiModal'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  const part=data.find(d=>d.id===partId);
  if(part&&part.parentId){
    expanded[part.parentId]=true;
  }
  render();
  setTimeout(()=>{
    const row=document.querySelector('[data-part-id="'+partId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.classList.add('ai-highlight');
      setTimeout(()=>row.classList.remove('ai-highlight'),2500);
    }
  },100);
};

// Close part info popover when clicking outside
document.addEventListener('click',e=>{
  const popover=$('partInfoPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.ai-part-link')){
    popover.classList.remove('open');
  }
});

window.highlightParts=function(partIds){
  closeAIWorkspace();
  hidePopoverModal($('aiModal'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  // Expand all parent assemblies
  partIds.forEach(id=>{
    const part=data.find(d=>d.id===id);
    if(part&&part.parentId)expanded[part.parentId]=true;
  });
  render();
  setTimeout(()=>{
    partIds.forEach((id,i)=>{
      const row=document.querySelector('[data-part-id="'+id+'"]');
      if(row){
        row.classList.add('ai-highlight');
        if(i===0)row.scrollIntoView({behavior:'smooth',block:'center'});
        setTimeout(()=>row.classList.remove('ai-highlight'),3000);
      }
    });
  },100);
};

window.aiGoToAsm=function(asmId){
  closeAIWorkspace();
  hidePopoverModal($('aiModal'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  expanded[asmId]=true;
  render();
  setTimeout(()=>{
    const row=document.querySelector('[data-id="'+asmId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.classList.add('ai-highlight');
      setTimeout(()=>row.classList.remove('ai-highlight'),2500);
    }
  },100);
};

window.aiFilterStage=function(stage){
  closeAIWorkspace();
  hidePopoverModal($('aiModal'));
  
  // Handle special filter cases
  if(stage==='stuck'){
    // Show parts stuck more than 5 days
    const stuckIds=getParts().filter(p=>{
      const days=Math.floor((Date.now()-(p.changedAt||Date.now()))/(1000*60*60*24));
      return days>5&&p.status!=='installed';
    }).map(p=>p.id);
    if(stuckIds.length>0){
      highlightParts(stuckIds);
    }else{
      toast('No stuck parts found');
    }
    return;
  }
  
  filterStage=stage;
  render();
};

// AI Model Selection
let selectedAIModel='claude-sonnet-4-5-20250929';
let lastUsedModel=null;

// Debug helper - call window.checkAIModel() in console to see current model
window.checkAIModel=function(){
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ¤– AI Model Status');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Selected model:', selectedAIModel);
  console.log('Display name:', AI_MODELS[selectedAIModel]?.name || 'unknown');
  console.log('Last used model:', lastUsedModel || 'none yet');
  if(lastUsedModel){
    console.log('Last response from:', AI_MODELS[lastUsedModel]?.name || lastUsedModel);
  }
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  return {selected: selectedAIModel, lastUsed: lastUsedModel};
};
const AI_MODELS={
  'claude-haiku-4-5-20251001':{name:'haiku-4.5',label:'Haiku 4.5'},
  'claude-sonnet-4-5-20250929':{name:'sonnet-4.5',label:'Sonnet 4.5'},
  'claude-opus-4-5-20251101':{name:'opus-4.5',label:'Opus 4.5'}
};

window.toggleModelSelector=function(e){
  e.stopPropagation();
  $('aiModelDropdown').classList.toggle('open');
};

window.selectAIModel=function(btn){
  const model=btn.dataset.model;
  selectedAIModel=model;
  $('aiModelBadge').innerHTML=AI_MODELS[model].name+' <span style="opacity:0.5;margin-left:2px">â–¾</span>';
  $('aiModelBadgeWs').innerHTML=AI_MODELS[model].name+' <span style="opacity:0.5">â–¾</span>';
  // Update active state
  document.querySelectorAll('.ai-model-option').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.ai-model-option[data-model="'+model+'"]').forEach(b=>b.classList.add('active'));
  $('aiModelDropdown').classList.remove('open');
};

window.toggleModelSelectorWs=function(e){
  e.stopPropagation();
  $('aiModelDropdownWs').classList.toggle('open');
};

window.selectAIModelWs=function(btn){
  const model=btn.dataset.model;
  selectedAIModel=model;
  $('aiModelBadge').innerHTML=AI_MODELS[model].name+' <span style="opacity:0.5;margin-left:2px">â–¾</span>';
  $('aiModelBadgeWs').innerHTML=AI_MODELS[model].name+' <span style="opacity:0.5">â–¾</span>';
  // Update active state in both dropdowns
  document.querySelectorAll('.ai-model-option').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.ai-model-option[data-model="'+model+'"]').forEach(b=>b.classList.add('active'));
  $('aiModelDropdownWs').classList.remove('open');
};

// Close dropdown when clicking outside
document.addEventListener('click',e=>{
  if(!e.target.closest('.ai-model-selector')){
    $('aiModelDropdown').classList.remove('open');
  }
  if(!e.target.closest('.ai-model-selector-ws')){
    $('aiModelDropdownWs').classList.remove('open');
  }
});

async function askAI(question){
  const context=buildProjectContext(question); // Pass question for smart filtering
  
  try{
    $('aiModelBadge').innerHTML='<span class="thinking-pulse">thinking...</span>';
    $('aiModelBadgeWs').innerHTML='<span class="thinking-pulse">thinking...</span>';
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({
      mode:'ask',
      projectContext:context,
      question,
      maxChars:500,
      style:'concise',
      model:selectedAIModel
    });
    
    // Log model verification
    const requestedModel=selectedAIModel;
    const returnedModel=result.data?.model||'unknown';
    console.log('ðŸ¤– AI Model Verification:');
    console.log('   Requested:', requestedModel);
    console.log('   Returned:', returnedModel);
    console.log('   Match:', requestedModel===returnedModel ? 'âœ… YES' : 'âŒ NO');
    
    if(result.data?.success){
      // Use the RETURNED model from API, not the requested one
      const actualModel=result.data.model||selectedAIModel;
      const modelName=AI_MODELS[actualModel]?.name||actualModel;
      $('aiModelBadge').innerHTML=modelName+' <span style="opacity:0.5;margin-left:2px">â–¾</span>';
      $('aiModelBadgeWs').innerHTML=modelName+' <span style="opacity:0.5">â–¾</span>';
      lastUsedModel=actualModel;
      return formatClaudeResponse(result.data.content,'ask',actualModel);
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Ask failed:',e);
    $('aiModelBadge').innerHTML='offline <span style="opacity:0.5;margin-left:2px">â–¾</span>';
    $('aiModelBadgeWs').innerHTML='offline <span style="opacity:0.5">â–¾</span>';
    return '<div class="ai-prose"><p>Unable to get response. Please try again.</p></div>';
  }
}

function generateLocalReport(mode,ctx){
  const today=new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});
  
  if(mode==='quick'){
    return renderQuickInsights();
  }
  
  if(mode==='standup'){
    let html='<div class="ai-summary"><strong>'+ctx.project.name+'</strong><br>'+today+'<br><br>';
    html+='<strong>'+ctx.project.progress+'%</strong> complete';
    if(ctx.project.daysLeft!==null)html+=' Â· <strong>'+ctx.project.daysLeft+'</strong> days left';
    if(ctx.project.velocity)html+=' Â· <strong>'+ctx.project.velocity+'</strong> parts/day';
    html+='</div>';
    
    // Blockers
    if(ctx.overdue.length||ctx.stuck.filter(s=>s.status==='to-order').length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ”´</span> Blockers</div><div class="ai-report-items">';
      ctx.overdue.forEach(a=>{
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(a.task)+'</strong><div class="ai-report-meta">'+a.daysOverdue+' day'+(a.daysOverdue!==1?'s':'')+' overdue Â· '+esc(a.assignee)+'</div></div></div>';
      });
      ctx.stuck.filter(s=>s.status==='to-order').slice(0,3).forEach(p=>{
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(p.name)+'</strong> waiting to order<div class="ai-report-meta">'+p.days+' days Â· '+(p.mfr||'No supplier')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Needs Attention
    const arrivedCount=ctx.counts.arrived||0;
    const inTransit=ctx.stuck.filter(s=>s.status==='ordered');
    if(arrivedCount||inTransit.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸŸ¡</span> Needs Attention</div><div class="ai-report-items">';
      if(arrivedCount){
        html+='<div class="ai-report-item warning"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+arrivedCount+' part'+(arrivedCount!==1?'s':'')+' arrived</strong> - awaiting next step</div></div>';
      }
      inTransit.slice(0,3).forEach(p=>{
        html+='<div class="ai-report-item warning"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(p.name)+'</strong> in transit '+p.days+' days<div class="ai-report-meta">'+(p.mfr||'Unknown supplier')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Due Soon
    if(ctx.upcoming.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ“‹</span> Due This Week</div><div class="ai-report-items">';
      ctx.upcoming.slice(0,5).forEach(a=>{
        const dueDate=new Date(a.due).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text">'+esc(a.task)+'<div class="ai-report-meta">'+dueDate+' Â· '+esc(a.assignee)+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Focus
    html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸŽ¯</span> Focus Today</div><div class="ai-report-items">';
    const focuses=[];
    if(ctx.overdue.length)focuses.push('Clear '+ctx.overdue.length+' overdue action'+(ctx.overdue.length!==1?'s':''));
    if(arrivedCount>=3)focuses.push('Process '+arrivedCount+' arrived parts');
    if(ctx.stuck.filter(s=>s.status==='to-order').length>=3)focuses.push('Place orders for stuck parts');
    if(inTransit.length)focuses.push('Follow up on long-transit items');
    if(!focuses.length)focuses.push('Continue steady progress');
    focuses.slice(0,3).forEach((f,i)=>{
      html+='<div class="ai-report-item success"><span class="ai-report-bullet">'+(i+1)+'.</span><div class="ai-report-text">'+f+'</div></div>';
    });
    html+='</div></div>';
    
    return html;
  }
  
  if(mode==='risks'){
    let html='<div class="ai-summary"><strong>Risk Analysis</strong><br>'+ctx.project.name+'<br>'+today+'</div>';
    
    // Schedule Risk
    const forecast=ctx.forecast;
    if(forecast){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ“Š</span> Schedule Risk</div><div class="ai-report-items">';
      if(forecast.status==='at-risk'){
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>Behind Schedule</strong><div class="ai-report-meta">At current velocity, completion '+(forecast.daysToComplete-forecast.daysLeft)+' days late</div></div></div>';
      }else if(forecast.status==='ahead'){
        html+='<div class="ai-report-item success"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>Ahead of Schedule</strong><div class="ai-report-meta">Est. completion '+(forecast.daysLeft-forecast.daysToComplete)+' days early</div></div></div>';
      }else{
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>On Track</strong><div class="ai-report-meta">Current velocity matches target</div></div></div>';
      }
      html+='</div></div>';
    }
    
    // Supplier Risks
    const riskySuppliers=ctx.suppliers.filter(s=>s.inTransit>=2);
    if(riskySuppliers.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸšš</span> Supplier Exposure</div><div class="ai-report-items">';
      riskySuppliers.forEach(s=>{
        const level=s.inTransit>=4?'critical':s.inTransit>=2?'warning':'info';
        html+='<div class="ai-report-item '+level+'"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(s.mfr)+'</strong><div class="ai-report-meta">'+s.inTransit+' parts in transit'+(s.avgLead?' Â· avg '+s.avgLead+'d lead time':'')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Assembly Risks (lowest progress)
    const atRiskAsms=ctx.asmProgress.filter(a=>a.progress<40);
    if(atRiskAsms.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">âš ï¸</span> Assemblies Behind</div><div class="ai-report-items">';
      atRiskAsms.slice(0,5).forEach(a=>{
        const level=a.progress<20?'critical':a.progress<40?'warning':'info';
        html+='<div class="ai-report-item '+level+'"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(a.name)+'</strong><div class="ai-report-meta">'+a.progress+'% complete Â· '+a.parts+' parts</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Recent Comments (may indicate issues)
    if(ctx.recentComments.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ’¬</span> Recent Notes</div><div class="ai-report-items">';
      ctx.recentComments.slice(0,5).forEach(c=>{
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text">"'+esc(c.text.slice(0,100))+(c.text.length>100?'...':'')+'"<div class="ai-report-meta">'+esc(c.partName)+' Â· '+c.date+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Mitigations
    html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ›¡ï¸</span> Recommended Actions</div><div class="ai-report-items">';
    const mitigations=[];
    if(ctx.overdue.length)mitigations.push('Clear overdue actions to unblock progress');
    if(riskySuppliers.length)mitigations.push('Contact '+riskySuppliers[0].mfr+' for delivery status');
    if(atRiskAsms.length)mitigations.push('Prioritize '+atRiskAsms[0].name+' assembly');
    if(ctx.counts['to-order']>10)mitigations.push('Reduce ordering backlog ('+ctx.counts['to-order']+' pending)');
    if(!mitigations.length)mitigations.push('Continue monitoring - no critical actions needed');
    mitigations.slice(0,4).forEach((m,i)=>{
      html+='<div class="ai-report-item success"><span class="ai-report-bullet">'+(i+1)+'.</span><div class="ai-report-text">'+m+'</div></div>';
    });
    html+='</div></div>';
    
    return html;
  }
  
  return '<div class="ai-error"><div class="ai-error-icon">â“</div><div class="ai-error-msg">Unknown report mode</div></div>';
}

function renderQuickInsights(){
  const insights=window._aiInsights||generateAIInsights();
  return insights.map((ins,i)=>'<div class="ai-insight '+ins.level+'" data-idx="'+i+'"><div class="ai-insight-icon">'+ins.icon+'</div><div class="ai-insight-content"><div class="ai-insight-title">'+ins.title+'</div><div class="ai-insight-desc">'+ins.desc+'</div>'+(ins.action?'<div class="ai-insight-action">'+ins.action+'</div>':'')+'</div></div>').join('');
}

let aiWorkspaceOpen=false;
let aiWorkspaceConversation=[];

function toggleAIWorkspace(){
  if(aiWorkspaceOpen){
    closeAIWorkspace();
  }else{
    openAIWorkspace();
  }
}

function openAIWorkspace(){
  aiWorkspaceOpen=true;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  $('aiWorkspace').classList.add('active');
  const btn=$('aiAlert');
  btn.classList.remove('decelerating');
  btn.classList.add('active');
  // After acceleration animation (2s), switch to fast spinning dot
  setTimeout(()=>{
    if(aiWorkspaceOpen)btn.classList.add('spinning');
  },1950);
  renderWorkspaceConversation();
  $('aiWorkspaceQuestion').focus();
}

function closeAIWorkspace(){
  if(!aiWorkspaceOpen)return;
  aiWorkspaceOpen=false;
  $('aiWorkspace').classList.remove('active');
  const btn=$('aiAlert');
  btn.classList.remove('active','spinning');
  btn.classList.add('decelerating');
  // Remove decelerating class after animation completes
  setTimeout(()=>{
    btn.classList.remove('decelerating');
  },2000);
  const activeTab=document.querySelector('.tab.active')||document.querySelector('[data-tab="list"]');
  if(activeTab){
    activeTab.classList.add('active');
    $(activeTab.dataset.tab+'Panel').classList.add('active');
  }else{
    document.querySelector('[data-tab="list"]').classList.add('active');
    $('listPanel').classList.add('active');
  }
}

function renderWorkspaceConversation(){
  const container=$('aiWorkspaceConversation');
  if(aiWorkspaceConversation.length===0){
    // Show insights dashboard when empty
    const insights=generateInsights();
    let html='<div class="ai-workspace-conversation-inner">';
    html+='<div class="ai-welcome-minimal">What would you like to know?</div>';
    if(insights.length>0){
      html+='<div class="ai-welcome-insights">';
      insights.slice(0,4).forEach(ins=>{
        html+='<div class="ai-welcome-insight '+ins.level+'" data-question="'+escapeAttr(ins.question||ins.title)+'">';
        html+='<span class="ai-welcome-insight-icon">'+ins.icon+'</span>';
        html+='<div class="ai-welcome-insight-text">';
        html+='<div class="ai-welcome-insight-title">'+ins.title+'</div>';
        html+='<div class="ai-welcome-insight-desc">'+ins.desc+'</div>';
        html+='</div>';
        html+='</div>';
      });
      html+='</div>';
    }
    html+='<div class="ai-welcome-suggestions">';
    html+='<button class="ai-suggest-btn" data-q="What\'s blocking progress?">What\'s blocking progress?</button>';
    html+='<button class="ai-suggest-btn" data-q="Which parts need attention?">Parts needing attention</button>';
    html+='<button class="ai-suggest-btn" data-q="Summarize supplier performance">Supplier performance</button>';
    html+='<button class="ai-suggest-btn" data-q="What should I focus on today?">Today\'s priorities</button>';
    html+='</div>';
    html+='</div>';
    container.innerHTML=html;
    // Bind click handlers
    container.querySelectorAll('.ai-welcome-insight').forEach(el=>{
      el.onclick=()=>{
        const q=el.dataset.question;
        if(q){$('aiWorkspaceQuestion').value=q;handleWorkspaceAsk();}
      };
    });
    container.querySelectorAll('.ai-suggest-btn').forEach(btn=>{
      btn.onclick=()=>{
        const q=btn.dataset.q;
        if(q){$('aiWorkspaceQuestion').value=q;handleWorkspaceAsk();}
      };
    });
    return;
  }
  let html='<div class="ai-workspace-conversation-inner">';
  html+=aiWorkspaceConversation.map(msg=>{
    if(msg.role==='user'){
      return '<div class="ai-msg ai-msg-user"><div class="ai-msg-content">'+msg.content+'</div></div>';
    }else{
      if(msg.isThinking){
        return '<div class="ai-msg ai-msg-assistant ai-msg-thinking">'+msg.content+'</div>';
      }
      return '<div class="ai-msg ai-msg-assistant"><div class="ai-msg-content">'+msg.content+'</div></div>';
    }
  }).join('');
  html+='</div>';
  container.innerHTML=html;
  container.scrollTop=container.scrollHeight;
}

function escapeAttr(str){return str.replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

function generateInsights(){
  const parts=data.filter(d=>!d.isAsm);
  const total=parts.length;
  if(total===0)return [];
  
  const insights=[];
  const now=Date.now();
  const day=86400000;
  
  // Stuck parts
  const stuckParts=parts.filter(p=>p.status!=='installed'&&p.changedAt&&(now-p.changedAt)>5*day);
  if(stuckParts.length>0){
    insights.push({level:'warning',icon:'â³',title:stuckParts.length+' parts stuck >5 days',desc:stuckParts.slice(0,2).map(p=>p.name).join(', '),question:'Which parts are stuck and why?'});
  }
  
  // Progress
  const installed=parts.filter(p=>p.status==='installed').length;
  const pct=Math.round(installed/total*100);
  if(pct<50){
    insights.push({level:'info',icon:'ðŸ“Š',title:pct+'% complete',desc:'Progress update',question:'How is the project progressing?'});
  }
  
  // Ready to install
  const readyToInstall=parts.filter(p=>p.status==='tested');
  if(readyToInstall.length>0){
    insights.push({level:'success',icon:'âœ“',title:readyToInstall.length+' ready to install',desc:readyToInstall.slice(0,2).map(p=>p.name).join(', '),question:'Which parts are ready to install?'});
  }
  
  // Workload
  const assignees={};
  parts.forEach(p=>{if(p.assignee)assignees[p.assignee]=(assignees[p.assignee]||0)+1;});
  const sorted=Object.entries(assignees).sort((a,b)=>b[1]-a[1]);
  if(sorted.length>0&&sorted[0][1]>total*0.5){
    insights.push({level:'warning',icon:'ðŸ‘¤',title:sorted[0][0]+' has '+sorted[0][1]+' parts',desc:'Workload may be unbalanced',question:'How is workload distributed across the team?'});
  }
  
  // In transit
  const inTransit=parts.filter(p=>p.status==='ordered');
  if(inTransit.length>5){
    insights.push({level:'info',icon:'ðŸ“¦',title:inTransit.length+' parts in transit',desc:'Awaiting delivery',question:'Which parts are in transit and when will they arrive?'});
  }
  
  return insights;
}

const AI_THINKING_ICON='<div class="ai-thinking-orb"><div class="ai-thinking-plus"></div></div>';

async function handleWorkspaceAsk(){
  const input=$('aiWorkspaceQuestion');
  const question=input.value.trim();
  if(!question)return;
  
  aiWorkspaceConversation.push({role:'user',content:esc(question)});
  renderWorkspaceConversation();
  input.value='';
  input.style.height='auto';
  
  aiWorkspaceConversation.push({role:'assistant',content:AI_THINKING_ICON,isThinking:true});
  renderWorkspaceConversation();
  
  const response=await askAI(question);
  
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'');
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].isThinking=false;
  renderWorkspaceConversation();
}

async function handleWorkspaceTell(){
  aiWorkspaceConversation.push({role:'user',content:'Tell me about the project status'});
  renderWorkspaceConversation();
  
  aiWorkspaceConversation.push({role:'assistant',content:AI_THINKING_ICON,isThinking:true});
  renderWorkspaceConversation();
  
  const response=await generateAIReport('straight');
  
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'');
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].isThinking=false;
  renderWorkspaceConversation();
}

function openAIModal(){
  showPopoverModal($('aiModal'),$('aiAlert'));
  if(aiConversation.length===0){
    $('aiContent').innerHTML=renderAIDashboard();
    $('aiModelBadge').textContent='';
  }else{
    renderConversation();
  }
  $('aiQuestion').focus();
}

function renderAIDashboard(){
  const parts=data.filter(d=>!d.isAsm);
  const asms=data.filter(d=>d.isAsm);
  const total=parts.length;
  if(total===0)return '<div class="ai-welcome"><p>No parts in this project yet. Add assemblies and parts to see analysis.</p></div>';
  
  const now=Date.now();
  const day=86400000;
  const week=7*day;
  
  // Calculate stage transitions for velocity
  const recentTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)<week).length;
  const olderTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)>=week&&(now-p.changedAt)<2*week).length;
  const velocityTrend=olderTransitions>0?Math.round((recentTransitions-olderTransitions)/olderTransitions*100):0;
  const velocityDir=velocityTrend>10?'accelerating':velocityTrend<-10?'slowing':'steady';
  
  // Bottleneck detection - find stage with longest average dwell time
  const stages=['to-order','ordered','arrived','tested','configured','installed'];
  const stageLabels={'to-order':'To Order','ordered':'Ordered','arrived':'Arrived','tested':'Tested','configured':'Configured','installed':'Installed'};
  const stageDwellTimes={};
  stages.forEach(s=>{
    const inStage=parts.filter(p=>p.status===s&&p.changedAt);
    if(inStage.length>0){
      const avgDwell=inStage.reduce((sum,p)=>sum+(now-p.changedAt),0)/inStage.length/day;
      stageDwellTimes[s]={avg:avgDwell,count:inStage.length};
    }
  });
  let bottleneck=null,maxDwell=0;
  Object.entries(stageDwellTimes).forEach(([stage,data])=>{
    if(stage!=='installed'&&data.avg>maxDwell&&data.count>=2){
      maxDwell=data.avg;bottleneck=stage;
    }
  });
  
  // Lead time analysis (order to arrival)
  const completedOrders=parts.filter(p=>p.orderedAt&&p.arrivedAt);
  let avgLeadTime=0,leadTimeVariance=0;
  if(completedOrders.length>=2){
    const leadTimes=completedOrders.map(p=>(p.arrivedAt-p.orderedAt)/day);
    avgLeadTime=Math.round(leadTimes.reduce((a,b)=>a+b,0)/leadTimes.length);
    const mean=avgLeadTime;
    leadTimeVariance=Math.round(Math.sqrt(leadTimes.reduce((sum,lt)=>sum+Math.pow(lt-mean,2),0)/leadTimes.length));
  }
  
  // Workload imbalance
  const assignees={};
  parts.filter(p=>p.assignee&&p.status!=='installed').forEach(p=>{
    assignees[p.assignee]=(assignees[p.assignee]||0)+1;
  });
  const assigneeList=Object.entries(assignees).sort((a,b)=>b[1]-a[1]);
  const maxWorkload=assigneeList[0]?assigneeList[0][1]:0;
  const minWorkload=assigneeList.length>1?assigneeList[assigneeList.length-1][1]:maxWorkload;
  const workloadImbalance=maxWorkload>0?(maxWorkload-minWorkload)/maxWorkload:0;
  
  // Stalled items (no change in 7+ days, not installed)
  const stalledParts=parts.filter(p=>p.status!=='installed'&&p.changedAt&&(now-p.changedAt)>week);
  
  // Arriving soon accuracy (parts that arrived vs their ETA)
  const arrivedWithEta=parts.filter(p=>p.arrivedAt&&p.expectedArrival);
  let onTimeRate=null,avgDelay=0;
  if(arrivedWithEta.length>=3){
    const onTime=arrivedWithEta.filter(p=>p.arrivedAt<=new Date(p.expectedArrival).getTime()+day);
    onTimeRate=Math.round(onTime.length/arrivedWithEta.length*100);
    avgDelay=Math.round(arrivedWithEta.reduce((sum,p)=>{
      const expected=new Date(p.expectedArrival).getTime();
      return sum+(p.arrivedAt-expected)/day;
    },0)/arrivedWithEta.length);
  }
  
  // Completion forecast based on velocity
  const installed=parts.filter(p=>p.status==='installed').length;
  const remaining=total-installed;
  const dailyVelocity=recentTransitions/7;
  const daysToComplete=dailyVelocity>0?Math.ceil(remaining/dailyVelocity):null;
  
  // Risk score (0-100)
  let riskScore=0;
  if(stalledParts.length>total*0.2)riskScore+=30;
  else if(stalledParts.length>total*0.1)riskScore+=15;
  if(velocityDir==='slowing')riskScore+=20;
  if(bottleneck&&maxDwell>5)riskScore+=25;
  else if(bottleneck&&maxDwell>3)riskScore+=10;
  if(onTimeRate!==null&&onTimeRate<70)riskScore+=25;
  else if(onTimeRate!==null&&onTimeRate<85)riskScore+=10;
  
  // Build insights array
  const insights=[];
  
  // Velocity insight
  if(recentTransitions>0||olderTransitions>0){
    const velIcon=velocityDir==='accelerating'?'â†‘':velocityDir==='slowing'?'â†“':'â†’';
    const velClass=velocityDir==='accelerating'?'positive':velocityDir==='slowing'?'negative':'neutral';
    insights.push({
      icon:velIcon,
      cls:velClass,
      title:'Velocity '+velocityDir,
      detail:recentTransitions+' transitions this week'+(velocityTrend!==0?' ('+(velocityTrend>0?'+':'')+velocityTrend+'%)':''),
      prompt:'Velocity is '+velocityDir+'. One cause, one fix. Max 2 sentences.'
    });
  }
  
  // Bottleneck insight
  if(bottleneck&&maxDwell>2){
    insights.push({
      icon:'âŠ˜',
      cls:'warning',
      title:'Bottleneck: '+stageLabels[bottleneck],
      detail:stageDwellTimes[bottleneck].count+' parts stuck avg '+Math.round(maxDwell)+'d',
      prompt:'Bottleneck at '+stageLabels[bottleneck]+' ('+stageDwellTimes[bottleneck].count+' parts, '+Math.round(maxDwell)+'d avg). Root cause and action. Show [ACTION:filter:'+bottleneck+'] button.'
    });
  }
  
  // Lead time insight
  if(avgLeadTime>0){
    const reliability=leadTimeVariance<avgLeadTime*0.3?'consistent':'variable';
    insights.push({
      icon:'â—·',
      cls:reliability==='consistent'?'neutral':'warning',
      title:'Lead time: '+avgLeadTime+'d avg',
      detail:'Â±'+leadTimeVariance+'d variance ('+reliability+')',
      prompt:'Lead time '+avgLeadTime+'d Â±'+leadTimeVariance+'d. What buffer to add? One number answer with brief reason.'
    });
  }
  
  // Forecast insight
  if(daysToComplete!==null&&remaining>0){
    const forecastDate=new Date(now+daysToComplete*day);
    const dateStr=forecastDate.getDate()+'/'+(forecastDate.getMonth()+1);
    insights.push({
      icon:'â—Ž',
      cls:daysToComplete>30?'warning':'neutral',
      title:'Est. completion: '+dateStr,
      detail:daysToComplete+' days at current velocity ('+remaining+' remaining)',
      prompt:'Completion forecast: '+daysToComplete+' days, '+remaining+' parts left. Top risk to this date? One sentence.'
    });
  }
  
  // Stalled items insight
  if(stalledParts.length>0){
    const pct=Math.round(stalledParts.length/total*100);
    const stalledIds=stalledParts.slice(0,5).map(p=>p.id).join(',');
    insights.push({
      icon:'â—¼',
      cls:pct>20?'negative':'warning',
      title:stalledParts.length+' stalled parts ('+pct+'%)',
      detail:'No movement in 7+ days',
      prompt:stalledParts.length+' parts stalled 7+ days. Pattern or common cause? Include [ACTION:highlight:'+stalledIds+'] to show them.'
    });
  }
  
  // On-time delivery insight
  if(onTimeRate!==null){
    insights.push({
      icon:'â—‡',
      cls:onTimeRate>=85?'positive':onTimeRate>=70?'warning':'negative',
      title:'On-time delivery: '+onTimeRate+'%',
      detail:avgDelay>0?'Avg '+Math.round(avgDelay)+'d late':'Avg '+Math.abs(Math.round(avgDelay))+'d early',
      prompt:'Supplier OTD '+onTimeRate+'%. '+(avgDelay>0?'Avg '+Math.round(avgDelay)+'d late.':'')+' Should I add buffer? Yes/no + days.'
    });
  }
  
  // Workload imbalance insight
  if(assigneeList.length>=2&&workloadImbalance>0.4){
    insights.push({
      icon:'âš–',
      cls:'warning',
      title:'Workload imbalance',
      detail:assigneeList[0][0]+' has '+assigneeList[0][1]+' items vs '+assigneeList[assigneeList.length-1][1]+' for '+assigneeList[assigneeList.length-1][0],
      prompt:'Workload: '+assigneeList[0][0]+'='+assigneeList[0][1]+', '+assigneeList[assigneeList.length-1][0]+'='+assigneeList[assigneeList.length-1][1]+'. Rebalance suggestion in one sentence.'
    });
  }
  
  // Risk score insight
  if(insights.length>0){
    const riskLabel=riskScore>=50?'High':riskScore>=25?'Moderate':'Low';
    const riskCls=riskScore>=50?'negative':riskScore>=25?'warning':'positive';
    insights.unshift({
      icon:'â—',
      cls:riskCls,
      title:'Risk level: '+riskLabel,
      detail:'Score: '+riskScore+'/100 based on '+insights.length+' factors',
      prompt:'Risk score '+riskScore+'/100. Top 3 risks as bullet points, max 5 words each.'
    });
  }
  
  // Build HTML
  let html='<div class="ai-dashboard">';
  
  if(insights.length===0){
    html+='<div class="ai-welcome"><p>Not enough data yet for analysis. As parts move through stages, insights will appear here.</p></div>';
  }else{
    html+='<div class="ai-insights-list">';
    insights.forEach((ins,idx)=>{
      html+='<div class="ai-insight-card '+ins.cls+'" data-prompt-idx="'+idx+'">';
      html+='<div class="ai-insight-icon">'+ins.icon+'</div>';
      html+='<div class="ai-insight-body"><div class="ai-insight-title">'+ins.title+'</div>';
      html+='<div class="ai-insight-detail">'+ins.detail+'</div></div>';
      html+='<div class="ai-insight-arrow">â†’</div></div>';
    });
    html+='</div>';
    html+='<div class="ai-dashboard-hint">Click any insight to explore with AI</div>';
  }
  
  html+='</div>';
  
  // Store prompts globally for click handlers
  window._aiPrompts=insights.map(i=>i.prompt);
  
  // Add click handlers after render
  setTimeout(()=>{
    document.querySelectorAll('.ai-insight-card[data-prompt-idx]').forEach(card=>{
      card.onclick=()=>{
        const idx=parseInt(card.dataset.promptIdx);
        if(window._aiPrompts&&window._aiPrompts[idx]){
          askAIQuestion(window._aiPrompts[idx]);
        }
      };
    });
  },0);
  
  return html;
}

function askAIQuestion(prompt){
  $('aiQuestion').value=prompt;
  handleAskSubmit();
}
window.askAIQuestion=askAIQuestion;

function renderConversation(){
  let html='<div class="ai-conversation">';
  aiConversation.forEach(msg=>{
    if(msg.role==='user'){
      html+='<div class="ai-message user"><span class="ai-user-label">You:</span> '+msg.content+'</div>';
    }else{
      html+='<div class="ai-message assistant">'+msg.content+'</div>';
    }
  });
  html+='</div>';
  $('aiContent').innerHTML=html;
  // Scroll to bottom
  const content=$('aiContent');
  content.scrollTop=content.scrollHeight;
}

async function handleAskSubmit(){
  const input=$('aiQuestion');
  const question=input.value.trim();
  if(!question)return;
  
  // Add user message
  aiConversation.push({role:'user',content:esc(question)});
  renderConversation();
  input.value='';
  
  // Add loading indicator
  aiConversation.push({role:'assistant',content:'<span class="ai-loading-text">Thinking...</span>'});
  renderConversation();
  
  // Get AI response
  const response=await askAI(question);
  
  // Replace loading with actual response - preserve paragraph breaks
  aiConversation[aiConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'').replace(/<\/p>\s*<p>/g,'</p><p>');
  renderConversation();
}

async function handleStraight(){
  // Add system indicator
  aiConversation.push({role:'user',content:'Tell me'});
  renderConversation();
  
  // Add loading indicator
  aiConversation.push({role:'assistant',content:'<span class="ai-loading-text">Analyzing...</span>'});
  renderConversation();
  
  // Get AI response
  const response=await generateAIReport('straight');
  
  // Replace loading with actual response - preserve paragraph breaks
  aiConversation[aiConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'').replace(/<\/p>\s*<p>/g,'</p><p>');
  renderConversation();
}

function bindQuickInsightHandlers(){
  const insights=window._aiInsights||[];
  document.querySelectorAll('.ai-insight').forEach(el=>{
    const idx=parseInt(el.dataset.idx);
    const ins=insights[idx];
    if(ins&&ins.handler)el.onclick=ins.handler;
  });
}

function renderLeadTimeModal(){const codes=Object.keys(leadTimeDb).sort();if(!codes.length){$('ltBody').innerHTML='<p style="color:var(--text3);text-align:center;padding:20px">No lead time data yet.</p>';return}$('ltBody').innerHTML=codes.map(code=>{const lt=leadTimeDb[code];return'<div class="lt-item"><div class="lt-code">'+esc(code)+'</div><div class="lt-stats"><span class="lt-stat-val">'+lt.avg+'d</span><span style="color:var(--text2);margin-left:8px">avg lead time</span><span class="lt-samples" style="margin-left:auto">'+lt.samples.length+' sample'+(lt.samples.length!==1?'s':'')+'</span></div></div>'}).join('')}

function openEtaModal(partId,e){const part=data.find(d=>d.id===partId);if(!part)return;editEtaPartId=partId;$('etaPartName').textContent=part.name;$('etaCode').textContent=part.code?'Item Code: '+part.code:'No item code set';const lt=getLeadTimeHistory(part.code);let histHtml='<div class="eta-popover-history-title">Historical Data</div>';if(lt&&lt.samples.length){histHtml+=lt.samples.slice(-5).reverse().map(s=>'<div class="eta-popover-history-item"><span>'+s.date+'</span><span>'+s.days+' days</span></div>').join('');histHtml+='<div class="eta-popover-avg"><span>Average</span><span>'+lt.avg+' days</span></div>'}else{histHtml+='<div class="eta-popover-history-empty">No historical data</div>'}$('etaHistory').innerHTML=histHtml;$('etaDateInput').value=part.expectedArrival||'';const popover=$('etaPopover');if(e){const rect=e.target.getBoundingClientRect();popover.style.visibility='hidden';popover.classList.add('open');const popoverHeight=popover.offsetHeight||280;const popoverWidth=popover.offsetWidth||320;popover.classList.remove('open');popover.style.visibility='';let top=rect.bottom+8;if(top+popoverHeight>window.innerHeight-20){top=rect.top-popoverHeight-8;if(top<20)top=20}let left=rect.left;if(left+popoverWidth>window.innerWidth-20){left=window.innerWidth-popoverWidth-20}if(left<20)left=20;popover.style.top=top+'px';popover.style.left=left+'px'}closeAllPopovers();popover.classList.add('open')}
window.openEtaModal=openEtaModal;

function updateSelects(){const opts='<option value="">â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');$('pmAssignee').innerHTML=opts;$('amAssignee').innerHTML=opts;$('actAssignee').innerHTML=opts;$('assigneeFilter').innerHTML='<option value="">All</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');$('actionAssigneeFilter').innerHTML='<option value="">All Assignees</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');$('actLinkedPart').innerHTML='<option value="">â€” None â€”</option>'+getParts().map(p=>'<option value="'+p.id+'">'+esc(p.name)+'</option>').join('')}
function updateExpandToggle(){const btn=$('expandToggle');const asms=getAsms();const expandedCount=asms.filter(a=>expanded[a.id]).length;allExpanded=expandedCount>asms.length/2;btn.innerHTML=allExpanded?'<span class="arrow">â–²</span> Collapse':'<span class="arrow">â–¼</span> Expand';btn.classList.toggle('expanded',allExpanded)}

function renderTeamList(){$('teamList').innerHTML=!team.length?'<p style="color:var(--text3);text-align:center;padding:12px;font-size:10px">No team members</p>':team.map((t,i)=>'<div class="team-item"><div class="team-item-info"><div style="font-weight:600">'+esc(t.name)+'</div><div style="font-size:10px;color:var(--text3)">'+esc(t.email)+'</div></div><button class="team-item-del" onclick="window.delTeam('+i+',event)">Ã—</button></div>').join('')}
function renderBomList(){if(!savedBoms.length){$('bomList').innerHTML='<p style="color:var(--text3);text-align:center;padding:20px">No saved specifications</p>';return}$('bomList').innerHTML=savedBoms.map(b=>'<div class="bom-item" onclick="window.loadBom('+b.id+')"><div class="bom-item-info"><div class="bom-item-name">'+esc(b.name)+'</div><div class="bom-item-meta">'+b.items.filter(i=>i.isAsm).length+' asm, '+b.items.filter(i=>!i.isAsm).length+' parts</div></div><button class="bom-item-del" onclick="event.stopPropagation();window.delBom('+b.id+',event)">Ã—</button></div>').join('')}

window.toggleAsmRow=function(e,id){if(e.target.closest('.asm-actions')||e.target.closest('.cell')||e.target.closest('.asm-priority'))return;expanded[id]=!expanded[id];saveExpanded();render()};
window.moveAsmUp=function(id){
  const asms=getAsms();
  const idx=asms.findIndex(a=>a.id===id);
  if(idx<=0)return;
  const current=asms[idx],prev=asms[idx-1];
  const tempPriority=current.priority;
  current.priority=prev.priority;
  prev.priority=tempPriority;
  save();render();
};
window.moveAsmDown=function(id){
  const asms=getAsms();
  const idx=asms.findIndex(a=>a.id===id);
  if(idx<0||idx>=asms.length-1)return;
  const current=asms[idx],next=asms[idx+1];
  const tempPriority=current.priority;
  current.priority=next.priority;
  next.priority=tempPriority;
  save();render();
};
window.addNewAsm=function(){const id=Date.now(),asms=getAsms();const maxP=asms.length?Math.max(...asms.map(a=>a.priority||0)):0;data.push({id,name:'New Assembly',isAsm:true,assignee:'',priority:maxP+1});expanded[id]=true;save();render();setTimeout(()=>{editAsmId=id;$('amTitle').textContent='Edit Assembly';$('amName').value='New Assembly';$('amAssignee').value='';$('amNotes').value='';$('amNotify').disabled=true;showPopoverModal($('asmModal'),null);$('amName').select()},50)};
window.addNewPart=function(parentId){const id=Date.now();data.push({id,name:'New Part',code:'',mfr:'',qty:1,assignee:'',parentId,status:'to-order',changedAt:id});save();render();highlightPartId=id;setTimeout(()=>{const row=document.querySelector('[data-part-id="'+id+'"] .cell');if(row)row.click()},50)};
window.addSubPart=function(parentPartId,e){if(e)e.stopPropagation();const parentPart=data.find(d=>d.id===parentPartId);if(!parentPart)return;const id=Date.now();data.push({id,name:'New Sub-Part',code:'',mfr:'',qty:1,assignee:parentPart.assignee||'',parentId:parentPartId,status:'to-order',changedAt:id});save();highlightPartId=id;render();setTimeout(()=>{const nameCell=document.querySelector('[data-part-id="'+id+'"] .part-name-cell .cell');if(nameCell){nameCell.click();setTimeout(()=>{const input=nameCell.querySelector('input');if(input)input.select()},10)}},50)};

window.toggleMetricsPopover=function(e){
  e.stopPropagation();
  const popover=$('metricsPopover');
  const isOpen=popover.classList.contains('open');
  if(isOpen){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
    return;
  }
  updateMetricsPopover();
  const btn=$('headerMetrics');
  const rect=btn.getBoundingClientRect();
  popover.style.top=(rect.bottom+8)+'px';
  popover.style.right=(window.innerWidth-rect.right)+'px';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>{
    const closeHandler=(ev)=>{
      if(!popover.contains(ev.target)&&!btn.contains(ev.target)){
        popover.classList.remove('open');
        $('popoverBackdrop').classList.remove('active');
        document.removeEventListener('click',closeHandler);
      }
    };
    document.addEventListener('click',closeHandler);
  },0);
};

function updateMetricsPopover(){
  const daysLeft=getDaysLeft(),pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast(),otd=calcSupplierOTD(),avgLead=calcAvgLeadTime();
  const parts=getParts();
  const inTransit=parts.filter(p=>p.status==='ordered').length;
  const toOrder=parts.filter(p=>p.status==='to-order').length;
  
  // Schedule section
  $('mpDays').textContent=daysLeft!==null?daysLeft+'d':'â€”';
  $('mpDays').className='ins-val'+(daysLeft!==null&&daysLeft<3?' red':daysLeft!==null&&daysLeft<7?' yellow':'');
  if(expected!==null){
    const diff=pct-expected;
    if(diff>=5){$('mpStatus').textContent='Ahead';$('mpStatus').className='ins-val green'}
    else if(diff<=-5){$('mpStatus').textContent='Behind';$('mpStatus').className='ins-val red'}
    else{$('mpStatus').textContent='On Track';$('mpStatus').className='ins-val green'}
    $('mpExpected').textContent=Math.round(expected)+'%';
  }else{$('mpStatus').textContent='â€”';$('mpExpected').textContent='â€”'}
  $('mpActual').textContent=pct+'%';
  $('mpActual').className='ins-val '+getProgressClass(pct);
  if(forecast&&forecast.rate>0){
    $('mpRate').textContent=forecast.rate.toFixed(1)+'%/d';
    $('mpRate').className='ins-val'+(forecast.rate>=1?' green':' yellow');
    $('mpEst').textContent=formatDateShort(forecast.estDate);
  }else{$('mpRate').textContent='â€”';$('mpRate').className='ins-val';$('mpEst').textContent='â€”'}
  
  // Suppliers section
  $('mpOTD').textContent=otd!==null?otd+'%':'â€”';
  $('mpOTD').className='ins-val '+(otd===null?'':(otd>=90?'green':otd>=70?'yellow':'red'));
  $('mpAvgLead').textContent=avgLead!==null?avgLead+'d':'â€”';
  $('mpInTransit').textContent=inTransit;
  $('mpInTransit').className='ins-val'+(inTransit>10?' yellow':'');
  $('mpToOrder').textContent=toOrder;
  $('mpToOrder').className='ins-val'+(toOrder>5?' yellow':'');
  
  // Top supplier
  const supplierCounts={};
  parts.forEach(p=>{if(p.mfr){supplierCounts[p.mfr]=(supplierCounts[p.mfr]||0)+1}});
  const topSupplier=Object.entries(supplierCounts).sort((a,b)=>b[1]-a[1])[0];
  $('mpTopSupplier').textContent=topSupplier?topSupplier[0]:'â€”';
  
  // Longest lead
  let longestLead=0;
  Object.entries(leadTimeDb).forEach(([code,lt])=>{if(lt.avg&&lt.avg>longestLead){longestLead=lt.avg}});
  $('mpLongestLead').textContent=longestLead?longestLead+'d':'â€”';
  
  // Velocity forecast
  let forecastHtml='';
  if(forecast&&forecast.estDate&&forecast.rate>0){
    let label='on time',labelColor='var(--text2)';
    if(forecast.daysLeft!==null&&forecast.daysToComplete!==null){
      const diff=forecast.daysLeft-forecast.daysToComplete;
      if(diff>0){label=diff+' days early';labelColor='var(--green)'}
      else if(diff<0){label=Math.abs(diff)+' days late';labelColor='var(--red)'}
    }
    forecastHtml='<div><span class="mp-forecast-date">'+formatDateShort(forecast.estDate)+'</span><span class="mp-forecast-label" style="color:'+labelColor+'"> '+label+'</span></div><div class="mp-forecast-detail">At '+forecast.rate.toFixed(1)+'%/day â€¢ '+forecast.daysToComplete+'d to complete</div>';
  }else{
    forecastHtml='<div style="color:var(--text3);font-size:11px">Not enough data</div>';
  }
  $('mpForecast').innerHTML=forecastHtml;
  
  // Bottlenecks
  const now=Date.now(),day=86400000;
  const bottlenecks=parts.filter(p=>p.status!=='installed').map(p=>{
    const daysInStage=p.changedAt?Math.floor((now-p.changedAt)/day):0;
    return{...p,daysInStage};
  }).filter(p=>p.daysInStage>=5).sort((a,b)=>b.daysInStage-a.daysInStage).slice(0,5);
  let bnHtml='';
  bottlenecks.forEach(p=>{
    bnHtml+='<div class="mp-bottleneck" onclick="window.goToPart('+p.id+')"><span class="mp-bottleneck-name">'+esc(p.name)+'</span><span class="mp-bottleneck-info">'+p.daysInStage+'d in '+SLABELS[p.status]+'</span></div>';
  });
  $('mpBottlenecks').innerHTML=bnHtml||'<div style="color:var(--text3);font-size:11px">No bottlenecks detected</div>';
  
  // Progress chart (burn-up)
  renderMetricsChart();
  
  // Reset OTD detail view
  $('mpOTDDetail').style.display='none';
  $('mpSupplierRows').style.display='block';
  $('mpOTDArrow').textContent='â–¶';
}

function renderMetricsChart(){
  const chart=$('mpChart');
  if(!projectDates.start||!projectDates.end){
    chart.innerHTML='<div class="mp-chart-empty" onclick="window.openDates()"><span>ðŸ“…</span><span>Set project dates to see chart</span></div>';
    return;
  }
  if(history.length<2){
    chart.innerHTML='<div class="mp-chart-empty"><span>ðŸ“Š</span><span>Not enough data yet</span></div>';
    return;
  }
  const start=new Date(projectDates.start),end=new Date(projectDates.end);
  const totalDays=Math.max(1,(end-start)/86400000);
  const w=480,h=150,pad={top:14,right:14,bottom:22,left:34};
  const chartW=w-pad.left-pad.right,chartH=h-pad.top-pad.bottom;
  const xScale=x=>pad.left+(x/totalDays)*chartW;
  const yScale=y=>pad.top+(1-y/100)*chartH;
  const points=history.filter(pt=>{const d=new Date(pt.date);return d>=start&&d<=end}).map(pt=>{const d=new Date(pt.date),dayNum=(d-start)/86400000;return{x:xScale(dayNum),y:yScale(pt.pct),pct:pt.pct,dayNum}});
  let svg='<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="xMidYMid meet">';
  // Grid lines
  [0,25,50,75,100].forEach(g=>{const y=yScale(g);svg+='<line x1="'+pad.left+'" y1="'+y+'" x2="'+(w-pad.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="1"/><text x="'+(pad.left-6)+'" y="'+(y+3)+'" fill="var(--text3)" font-size="9" text-anchor="end">'+g+'</text>'});
  // Target line (diagonal)
  svg+='<line x1="'+xScale(0)+'" y1="'+yScale(0)+'" x2="'+xScale(totalDays)+'" y2="'+yScale(100)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="4,3"/>';
  // Progress line with color based on ahead/behind
  for(let i=0;i<points.length-1;i++){
    const p1=points[i],p2=points[i+1];
    const idealY1=(p1.dayNum/totalDays)*100,idealY2=(p2.dayNum/totalDays)*100;
    const above1=p1.pct>=idealY1,above2=p2.pct>=idealY2;
    const col1=above1?'var(--green)':'var(--red)';
    const col2=above2?'var(--green)':'var(--red)';
    if(above1===above2){
      svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>';
    }else{
      const t=(idealY1-p1.pct)/((p2.pct-p1.pct)-(idealY2-idealY1));
      const ix=p1.x+t*(p2.x-p1.x),iy=p1.y+t*(p2.y-p1.y);
      svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+ix+'" y2="'+iy+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>';
      svg+='<line x1="'+ix+'" y1="'+iy+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col2+'" stroke-width="2.5" stroke-linecap="round"/>';
    }
  }
  // Data points
  points.forEach(p=>{const idealY=(p.dayNum/totalDays)*100;svg+='<circle cx="'+p.x+'" cy="'+p.y+'" r="3.5" fill="'+(p.pct>=idealY?'var(--green)':'var(--red)')+'"/>'});
  svg+='</svg>';
  chart.innerHTML=svg;
}

window.editCell=function(e,id,field){e.stopPropagation();const cell=e.currentTarget;if(cell.classList.contains('editing'))return;const item=data.find(d=>d.id===id);if(!item)return;const currentValue=item[field]||'';cell.classList.add('editing');const inputType=field==='qty'?'number':'text';cell.innerHTML='<input type="'+inputType+'" value="'+esc(currentValue)+'" '+(field==='qty'?'min="1"':'')+'>';const input=cell.querySelector('input');input.focus();input.select();const saveValue=()=>{const newValue=field==='qty'?parseInt(input.value)||1:input.value.trim();if(item[field]!==newValue){item[field]=newValue;updateFieldTimestamp(item,field);markPartChanged(id,[field])}save();render()};input.onblur=saveValue;input.onkeydown=ev=>{if(ev.key==='Enter'){ev.preventDefault();saveValue()}if(ev.key==='Escape')render()}};

window.editCellAutocomplete=function(e,id,field){
  e.stopPropagation();
  const cell=e.currentTarget;
  if(cell.classList.contains('editing'))return;
  const item=data.find(d=>d.id===id);
  if(!item)return;
  const currentValue=item[field]||'';
  const suggestions=field==='code'?getAllCodes():getAllMfrs();
  
  cell.classList.add('editing');
  cell.innerHTML='<div class="autocomplete-wrapper"><input type="text" value="'+esc(currentValue)+'" placeholder="Type to search..."><div class="autocomplete-list"></div></div>';
  const wrapper=cell.querySelector('.autocomplete-wrapper');
  const input=cell.querySelector('input');
  const list=cell.querySelector('.autocomplete-list');
  let selectedIdx=-1;
  
  function positionList(){
    const rect=wrapper.getBoundingClientRect();
    list.style.top=(rect.bottom+2)+'px';
    list.style.left=rect.left+'px';
    list.style.width=Math.max(rect.width,180)+'px';
  }
  
  function filterSuggestions(val){
    if(!val||!val.trim())return suggestions.slice(0,10);
    const v=val.toLowerCase();
    return suggestions.filter(s=>s.toLowerCase().includes(v)).slice(0,10);
  }
  
  function renderList(filtered,val){
    if(!filtered.length){list.classList.remove('open');list.innerHTML='';return}
    list.innerHTML=filtered.map((s,i)=>{
      let highlighted=esc(s);
      if(val&&val.trim()){
        const idx=s.toLowerCase().indexOf(val.toLowerCase());
        if(idx>=0)highlighted=esc(s.substring(0,idx))+'<em>'+esc(s.substring(idx,idx+val.length))+'</em>'+esc(s.substring(idx+val.length));
      }
      return '<div class="autocomplete-item'+(i===selectedIdx?' selected':'')+'" data-val="'+esc(s)+'">'+highlighted+'</div>';
    }).join('');
    positionList();
    list.classList.add('open');
    list.querySelectorAll('.autocomplete-item').forEach((el,i)=>{
      el.onmousedown=ev=>{ev.preventDefault();ev.stopPropagation();input.value=el.dataset.val;saveValue()};
    });
  }
  
  input.focus();input.select();
  
  // Find existing part with same code to auto-fill name and mfr
  function findMatchingPart(code){
    if(!code)return null;
    return data.find(d=>!d.isAsm&&d.id!==id&&d.code&&d.code.toLowerCase()===code.toLowerCase());
  }
  
  const saveValue=()=>{
    list.classList.remove('open');
    const newValue=input.value.trim();
    item[field]=newValue;
    if(newValue){
      if(field==='code'){
        addGlobalCode(newValue);
        // Auto-fill name and mfr from existing part with same code
        const match=findMatchingPart(newValue);
        if(match){
          if(match.name&&(!item.name||item.name==='New Part'))item.name=match.name;
          if(match.mfr&&!item.mfr)item.mfr=match.mfr;
        }
      }else if(field==='mfr'){
        addGlobalMfr(newValue);
      }
    }
    save();render();
  };
  
  input.oninput=()=>{selectedIdx=-1;renderList(filterSuggestions(input.value),input.value)};
  input.onfocus=()=>{renderList(filterSuggestions(input.value),input.value)};
  input.onblur=()=>setTimeout(saveValue,200);
  input.onkeydown=ev=>{
    const filtered=filterSuggestions(input.value);
    if(ev.key==='ArrowDown'){ev.preventDefault();selectedIdx=Math.min(selectedIdx+1,filtered.length-1);renderList(filtered,input.value)}
    else if(ev.key==='ArrowUp'){ev.preventDefault();selectedIdx=Math.max(selectedIdx-1,-1);renderList(filtered,input.value)}
    else if(ev.key==='Enter'){ev.preventDefault();if(selectedIdx>=0&&filtered[selectedIdx])input.value=filtered[selectedIdx];saveValue()}
    else if(ev.key==='Escape')render();
    else if(ev.key==='Tab'&&selectedIdx>=0&&filtered[selectedIdx]){input.value=filtered[selectedIdx]}
  };
  // Show suggestions immediately on open
  setTimeout(()=>renderList(filterSuggestions(currentValue),currentValue),50);
};

window.editCellAssignee=function(e,id){e.stopPropagation();const cell=e.currentTarget;if(cell.classList.contains('editing'))return;const item=data.find(d=>d.id===id);if(!item)return;cell.classList.add('editing');const opts='<option value="">â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(t.name===item.assignee?' selected':'')+'>'+esc(t.name)+'</option>').join('');cell.innerHTML='<select>'+opts+'</select>';const select=cell.querySelector('select');select.focus();const saveValue=()=>{if(item.assignee!==select.value){item.assignee=select.value;updateFieldTimestamp(item,'assignee');markPartChanged(id,['assignee'])}save();render()};select.onblur=saveValue;select.onchange=saveValue;select.onkeydown=ev=>{if(ev.key==='Escape')render()}};

function generateReport(){
  const today=new Date();const dateStr=today.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const parts=getParts(),asms=getAsms();
  const pct=calcOverallProgress(),expected=getExpectedProgress(),daysLeft=getDaysLeft();
  const toOrder=parts.filter(p=>p.status==='to-order');
  const ordered=parts.filter(p=>p.status==='ordered');
  const installed=parts.filter(p=>p.status==='installed');
  const overdueActions=actions.filter(a=>a.status!=='completed'&&a.due&&a.due<today.toISOString().split('T')[0]);
  const forecast=getVelocityForecast();const otd=calcSupplierOTD();

  let status='ðŸŸ¢ ON TRACK',statusDetail='Project progressing as planned.';
  if(expected&&pct<expected-10){status='ðŸ”´ BEHIND SCHEDULE';statusDetail='Project is '+(expected-pct)+'% behind expected progress.'}
  else if(expected&&pct>=expected+5){status='ðŸŸ¢ AHEAD OF SCHEDULE';statusDetail='Project is '+(pct-expected)+'% ahead of target.'}

  let report=currentProjectName.toUpperCase()+'\nPROJECT STATUS REPORT\n'+'â•'.repeat(52)+'\n'+dateStr+'\n\nEXECUTIVE SUMMARY\n'+'â”€'.repeat(36)+'\nStatus: '+status+'\n'+statusDetail+'\n\nPROGRESS METRICS\n'+'â”€'.repeat(36)+'\nOverall Completion: '+pct+'%\n  â””â”€ '+installed.length+' of '+parts.length+' parts installed\n\n';
  if(expected!==null)report+='Expected Progress: '+expected+'%\nVariance: '+(pct>=expected?'+':'')+(pct-expected)+'%\n';
  if(daysLeft!==null)report+='Days Remaining: '+daysLeft+'\n';
  report+='\nVELOCITY FORECAST\n'+'â”€'.repeat(36)+'\n';
  if(forecast&&forecast.rate>0)report+='Current Rate: '+forecast.rate.toFixed(1)+'% per day\nEst. Completion: '+formatDateShort(forecast.estDate)+'\nDays Required: '+forecast.daysToComplete+'\n'+(daysLeft!==null?'Buffer: '+(forecast.daysToComplete<=daysLeft?'+':'')+(daysLeft-forecast.daysToComplete)+' days\n':'')+'\nStatus: '+(forecast.status==='ahead'?'âœ“ Ahead of schedule':forecast.status==='on-track'?'âœ“ On track':forecast.status==='behind'?'âš  Slightly behind':'âš  At risk')+'\n';
  else report+='Insufficient data for velocity forecast\n';
  report+='\nSUPPLIER PERFORMANCE\n'+'â”€'.repeat(36)+'\nOn-Time Delivery: '+(otd!==null?otd+'%':'No data yet')+'\nAverage Lead Time: '+(calcAvgLeadTime()||'â€”')+' days\n';
  report+='\nASSEMBLY STATUS\n'+'â”€'.repeat(36)+'\n'+asms.map(a=>{const prog=calcAsmProgress(a.id);const statusIcon=prog===100?'âœ“':prog>=50?'â—':'â—‹';return statusIcon+' '+a.name.substring(0,30).padEnd(30)+' '+String(prog).padStart(3)+'%'}).join('\n')+'\n';
  if(toOrder.length)report+='\nâš  AWAITING ORDER ('+toOrder.length+')\n'+'â”€'.repeat(36)+'\n'+toOrder.slice(0,8).map(p=>'  â€¢ '+p.name+(p.code?' ['+p.code+']':'')).join('\n')+(toOrder.length>8?'\n  ... and '+(toOrder.length-8)+' more':'')+'\n';
  if(ordered.length)report+='\nðŸ“¦ IN TRANSIT ('+ordered.length+')\n'+'â”€'.repeat(36)+'\n'+ordered.slice(0,8).map(p=>{const eta=getPartETA(p);return'  â€¢ '+p.name+' â€” ETA: '+eta.display}).join('\n')+(ordered.length>8?'\n  ... and '+(ordered.length-8)+' more':'')+'\n';
  if(overdueActions.length)report+='\nðŸš¨ OVERDUE ACTIONS ('+overdueActions.length+')\n'+'â”€'.repeat(36)+'\n'+overdueActions.map(a=>'  â€¢ '+a.task+'\n    Due: '+a.due+' | '+(a.assignee||'Unassigned')).join('\n')+'\n';
  report+='\n'+'â•'.repeat(52)+'\nGenerated: '+new Date().toLocaleString();
  return report;
}


window.loadBom=function(bomId){const bom=savedBoms.find(b=>b.id===bomId);if(!bom)return;if(!confirm('Load "'+bom.name+'"?'))return;currentProjectName=bom.name;data=[];expanded={};history=[];let id=1;const asmMap={};bom.items.filter(i=>i.isAsm).forEach((item,idx)=>{const asmId=id++;asmMap[item.name]=asmId;data.push({id:asmId,name:item.name,isAsm:true,assignee:'',priority:idx+1});expanded[asmId]=true});bom.items.filter(i=>!i.isAsm).forEach(item=>{const parentId=asmMap[item.parent]||null;data.push({id:id++,name:item.name,code:item.code||'',mfr:item.mfr||'',qty:item.qty||1,assignee:'',parentId,status:'to-order',changedAt:Date.now()})});save();render();closeModal('bomModal');toast('Loaded: '+bom.name)};
window.delBom=function(bomId,e){
  deleteTarget={id:bomId,type:'bom'};
  const bom=savedBoms.find(b=>b.id===bomId);
  const name=bom?bom.name:'Specification';
  $('deleteMsg').innerHTML='Delete "<strong>'+esc(name)+'</strong>"?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};
window.saveBom=function(){const name=$('bomName').value.trim();if(!name){toast('Enter name',1);return}const items=[];const asms=getAsms();asms.forEach(asm=>{items.push({name:asm.name,isAsm:true});data.filter(d=>d.parentId===asm.id).forEach(p=>{items.push({name:p.name,code:p.code,mfr:p.mfr,qty:p.qty,parent:asm.name})})});savedBoms.push({id:Date.now(),name,items});saveBoms();closeModal('bomModal');toast('Saved')};

window.clearStageFilter=()=>{filterStage='';render()};
window.clearAssigneeFilter=()=>{filterAssignee='';$('assigneeFilter').value='';render()};
window.clearPOFilter=()=>{filterPO='';render()};
window.togglePOFilter=(po,e)=>{e&&e.stopPropagation();filterPO=filterPO===po?'':po;render()};

window.showPODetails=(po,e)=>{
  e&&e.stopPropagation();
  const parts=data.filter(p=>p.poNumber===po);
  if(!parts.length)return;
  
  // Get first part's data for header info
  const firstPart=parts.find(p=>p.orderedAt)||parts[0];
  const supplier=parts.find(p=>p.supplier)?.supplier||'';
  const orderedDate=firstPart.orderedAt?new Date(firstPart.orderedAt).toLocaleDateString():'-';
  const expectedDate=firstPart.expectedArrival?new Date(firstPart.expectedArrival).toLocaleDateString():'-';
  
  $('poDetailsNumber').textContent=po;
  $('poDetailsSupplier').textContent=supplier;
  $('poDetailsOrdered').innerHTML='<strong>Ordered:</strong> '+orderedDate;
  $('poDetailsExpected').innerHTML='<strong>Expected:</strong> '+expectedDate;
  
  // Build items list
  let received=0,total=parts.length;
  let html='';
  parts.forEach(p=>{
    const isReceived=p.status!=='to-order'&&p.status!=='ordered';
    if(isReceived)received++;
    const recDate=p.arrivedAt?new Date(p.arrivedAt).toLocaleDateString().split('/').slice(0,2).join('.'):'â€”';
    html+='<div class="po-details-row">';
    html+='<div class="item-name"><span>'+esc(p.name)+'</span>'+(p.code?'<span class="item-code">'+esc(p.code)+'</span>':'')+'</div>';
    html+='<div class="qty">'+(p.qty||1)+'</div>';
    html+='<div class="status '+(isReceived?'received':'pending')+'">'+(isReceived?'<span>'+recDate+'</span> âœ“':'â€”')+'</div>';
    html+='</div>';
  });
  $('poDetailsList').innerHTML=html;
  
  // Summary
  const pct=Math.round((received/total)*100);
  $('poDetailsSummary').innerHTML='<span>'+received+' of '+total+' lines complete</span><div class="progress-bar"><div class="progress-fill" style="width:'+pct+'%"></div></div><span>'+pct+'%</span>';
  
  // Show/hide receive button
  const canReceive=parts.some(p=>p.status==='ordered');
  $('poDetailsReceiveAll').style.display=canReceive?'block':'none';
  $('poDetailsReceiveAll').onclick=()=>{
    const toReceive=parts.filter(p=>p.status==='ordered');
    if(!confirm('Receive '+toReceive.length+' item'+(toReceive.length>1?'s':'')+'?'))return;
    toReceive.forEach(p=>{
      p.status='arrived';
      p.arrivedAt=Date.now();
      p.changedAt=Date.now();
    });
    save();render();
    closeAllPopovers();
    toast('Received '+toReceive.length+' items','success');
  };
  
  // Position and show popover
  const popover=$('poDetailsPopover');
  const rect=e.target.getBoundingClientRect();
  
  // Calculate popover height (estimate if not yet visible)
  popover.style.visibility='hidden';
  popover.classList.add('open');
  const popoverHeight=popover.offsetHeight||300;
  const popoverWidth=popover.offsetWidth||360;
  popover.classList.remove('open');
  popover.style.visibility='';
  
  // Position vertically - show above if not enough space below
  let top=rect.bottom+8;
  if(top+popoverHeight>window.innerHeight-20){
    top=rect.top-popoverHeight-8;
    if(top<20)top=20; // Don't go above viewport
  }
  
  // Position horizontally
  let left=rect.left;
  if(left+popoverWidth>window.innerWidth-20){
    left=window.innerWidth-popoverWidth-20;
  }
  if(left<20)left=20;
  
  popover.style.top=top+'px';
  popover.style.left=left+'px';
  closeAllPopovers();
  popover.classList.add('open');
};
$('poDetailsClose').onclick=()=>$('poDetailsPopover').classList.remove('open');
document.addEventListener('click',e=>{
  const popover=$('poDetailsPopover');
  if(popover&&popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.eta-po')){
    popover.classList.remove('open');
  }
  const etaPop=$('etaPopover');
  if(etaPop&&etaPop.classList.contains('open')&&!etaPop.contains(e.target)&&!e.target.closest('.eta-date')){
    etaPop.classList.remove('open');editEtaPartId=null;
  }
});
function closeAllPopovers(){
  // Close popover modals
  ['partModal','asmModal','actionModal','aiModal'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  // Close other popovers
  ['themeModal','reportModal','receivePOModal','commentsPopover','deletePopover','statusPopover','pendingPopover','poDetailsPopover','etaPopover','bulkStatusPopover','bulkAssigneePopover','bulkPOPopover','bulkDeletePopover','partInfoPopover'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  // Close gantt popups
  ['ganttColorPopup','ganttDatePopup'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  $('popoverBackdrop').classList.remove('active');
}
function showPopoverModal(modal,btn){
  closeAllPopovers();
  $('popoverBackdrop').classList.add('active');
  if(btn){
    const rect=btn.getBoundingClientRect();
    const mw=320,mh=Math.min(modal.scrollHeight||400,window.innerHeight-100);
    let top=rect.top;
    let left=rect.right-mw-10;
    // Keep in viewport
    if(left<16)left=16;
    if(left+mw>window.innerWidth-16)left=window.innerWidth-mw-16;
    if(top+mh>window.innerHeight-50)top=Math.max(50,window.innerHeight-mh-50);
    modal.style.top=top+'px';
    modal.style.left=left+'px';
  }else{
    modal.style.top='50%';
    modal.style.left='50%';
    modal.style.transform='translate(-50%,-50%) scale(1)';
  }
  modal.classList.add('open');
}
function hidePopoverModal(modal){
  modal.classList.remove('open');
  modal.style.transform='';
  $('popoverBackdrop').classList.remove('active');
}
$('popoverBackdrop').onclick=()=>{
  hidePopoverModal($('partModal'));editId=null;
  hidePopoverModal($('asmModal'));editAsmId=null;
  hidePopoverModal($('actionModal'));editActId=null;
  hidePopoverModal($('aiModal'));
  $('themeModal').classList.remove('open');
  $('reportModal').classList.remove('open');
  $('receivePOModal').classList.remove('open');
  $('metricsPopover').classList.remove('open');
  $('poModal').classList.remove('open');pendingAdvPartId=null;
  $('commentsPopover').classList.remove('open');currentCommentPartId=null;
  $('deletePopover').classList.remove('open');deleteTarget={id:null,type:null};
  $('popoverBackdrop').classList.remove('active');
};
window.editAsm=(id,e)=>{const a=data.find(d=>d.id===id);if(!a)return;editAsmId=id;$('amTitle').textContent='Edit Assembly';$('amName').value=a.name;$('amAssignee').value=a.assignee||'';$('amNotes').value=a.notes||'';$('amNotify').disabled=!getTeamEmail(a.assignee);showPopoverModal($('asmModal'),e?e.target.closest('button'):null)};
window.editPart=(id,e)=>{const p=data.find(d=>d.id===id);if(!p)return;editId=id;$('pmTitle').textContent='Edit Part';$('pmName').value=p.name;$('pmCode').value=p.code||'';$('pmMfr').value=p.mfr||'';$('pmQty').value=p.qty||1;$('pmAssignee').value=p.assignee||'';$('pmStatus').value=p.status;$('pmParent').value=p.parentId||'';$('pmNotes').value=p.notes||'';$('pmNotify').disabled=!getTeamEmail(p.assignee);showPopoverModal($('partModal'),e?e.target.closest('button'):null)};

let statusPopoverPartId=null;
window.openStatusPopover=(id,e)=>{
  e.stopPropagation();
  const p=data.find(d=>d.id===id);if(!p)return;
  statusPopoverPartId=id;
  
  // Special handling for pending status
  if(p.status==='pending'){
    const popover=$('pendingPopover');
    $('pendingNoteInput').value=p.pendingNote||'';
    const rect=e.target.getBoundingClientRect();
    let top=rect.bottom+6;
    let left=rect.left;
    if(left+280>window.innerWidth)left=window.innerWidth-290;
    if(top+200>window.innerHeight)top=rect.top-210;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
    popover.classList.add('open');
    setTimeout(()=>$('pendingNoteInput').focus(),50);
    return;
  }
  
  const popover=$('statusPopover');
  const rect=e.target.getBoundingClientRect();
  let top=rect.bottom+6;
  let left=rect.left;
  if(left+140>window.innerWidth)left=window.innerWidth-150;
  if(top+200>window.innerHeight)top=rect.top-210;
  popover.style.top=Math.max(10,top)+'px';
  popover.style.left=Math.max(10,left)+'px';
  // Generate status options
  $('statusPopoverOptions').innerHTML=STAGES.map(s=>{
    const active=s===p.status?' style="background:var(--accent);color:#fff"':'';
    return '<div class="dropdown-item"'+active+' onclick="window.setPartStatus('+id+',\''+s+'\')">'+SLABELS[s]+'</div>';
  }).join('');
  popover.classList.add('open');
};

// Pending popover handlers
$('pendingYes').onclick=()=>{
  const p=data.find(d=>d.id===statusPopoverPartId);
  if(!p)return;
  const note=$('pendingNoteInput').value.trim();
  if(note)p.pendingNote=note;
  p.status='to-order';
  p.changedAt=Date.now();
  updateFieldTimestamp(p,'status');
  markPartChanged(statusPopoverPartId,['status']);
  $('pendingPopover').classList.remove('open');
  save();render();
  toast('â†’ To Order');
};

$('pendingNo').onclick=()=>{
  const p=data.find(d=>d.id===statusPopoverPartId);
  if(!p)return;
  const note=$('pendingNoteInput').value.trim();
  if(note){
    p.pendingNote=note;
    updateFieldTimestamp(p,'pendingNote');
    markPartChanged(statusPopoverPartId,['pendingNote']);
    save();render();
    toast('Note saved');
  }
  $('pendingPopover').classList.remove('open');
};

window.setPartStatus=(id,status)=>{
  const p=data.find(d=>d.id===id);if(!p)return;
  const now=Date.now();
  const oldStatus=p.status;
  if(oldStatus===status){$('statusPopover').classList.remove('open');return;}
  $('statusPopover').classList.remove('open');
  
  // If moving to "ordered" from "to-order", show PO popover
  if(oldStatus==='to-order'&&status==='ordered'){
    pendingAdvPartId=id;
    $('poPartName').textContent=p.name+(p.code?' ('+p.code+')':'');
    $('poNumber').value=p.poNumber||'';
    $('poArrivalDate').value=p.expectedArrival||'';
    const popover=$('poModal');
    // Position near the status badge
    const badge=document.querySelector('[data-part-id="'+id+'"] .status-badge');
    if(badge){
      const rect=badge.getBoundingClientRect();
      let top=rect.bottom+8;
      let left=rect.left;
      if(left+320>window.innerWidth)left=window.innerWidth-330;
      if(top+300>window.innerHeight)top=rect.top-310;
      popover.style.top=Math.max(10,top)+'px';
      popover.style.left=Math.max(10,left)+'px';
    }
    popover.classList.add('open');
    $('popoverBackdrop').classList.add('active');
    setTimeout(()=>$('poNumber').focus(),100);
    return;
  }
  
  if(oldStatus==='ordered'&&status==='arrived'&&p.orderedAt&&p.code){
    const days=Math.round((now-p.orderedAt)/86400000);
    if(days>0)recordLeadTime(p.code,days);
    p.arrivedAt=now;
  }
  if(status==='ordered'&&oldStatus!=='ordered')p.orderedAt=now;
  p.status=status;
  p.changedAt=now;
  updateFieldTimestamp(p,'status');
  markPartChanged(id,['status']);
  save();render();
  toast('â†’ '+SLABELS[status]);
};

// Close status popover on outside click
document.addEventListener('click',e=>{
  const popover=$('statusPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.status-badge')){
    popover.classList.remove('open');
  }
});

// Close pending popover on outside click
document.addEventListener('click',e=>{
  const popover=$('pendingPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.status-badge')){
    popover.classList.remove('open');
  }
});

let pendingAdvPartId=null;
window.advPart=(id,e)=>{
  const p=data.find(d=>d.id===id);if(!p)return;
  const si=STAGES.indexOf(p.status),next=STAGES[si+1];
  if(!next)return;
  // If moving to "ordered", show PO popover
  if(p.status==='to-order'&&next==='ordered'){
    pendingAdvPartId=id;
    $('poPartName').textContent=p.name+(p.code?' ('+p.code+')':'');
    $('poNumber').value=p.poNumber||'';
    $('poArrivalDate').value=p.expectedArrival||'';
    const popover=$('poModal');
    if(e&&e.target){
      const rect=e.target.getBoundingClientRect();
      let top=rect.bottom+8;
      let left=rect.left;
      // Ensure it stays on screen
      if(left+320>window.innerWidth)left=window.innerWidth-330;
      if(top+300>window.innerHeight)top=rect.top-310;
      popover.style.top=Math.max(10,top)+'px';
      popover.style.left=Math.max(10,left)+'px';
    }
    popover.classList.add('open');
    $('popoverBackdrop').classList.add('active');
    setTimeout(()=>$('poNumber').focus(),100);
    return;
  }
  // Normal advancement
  advancePartStatus(id);
};

function advancePartStatus(id){
  const p=data.find(d=>d.id===id);if(!p)return;
  const next=getNextStage(p);
  if(!next)return;
  const oldStatus=p.status;
  // Record lead time when transitioning from ordered to arrived
  if(p.status==='ordered'&&next==='arrived'&&p.orderedAt){
    const days=Math.round((Date.now()-p.orderedAt)/86400000);
    if(p.code&&days>0)recordLeadTime(p.code,days);
    p.arrivedAt=Date.now();
    // Log arrival event
    const wasLate=p.expectedArrival&&new Date(p.expectedArrival)<new Date();
    const daysDelta=p.expectedArrival?Math.round((Date.now()-new Date(p.expectedArrival).getTime())/86400000):null;
    logArrival(p,days,wasLate,daysDelta);
    // Log ETA miss if late
    if(wasLate&&p.expectedArrival){
      logEtaMiss(p,p.expectedArrival,new Date().toISOString().split('T')[0],daysDelta);
    }
  }
  if(next==='ordered')p.orderedAt=Date.now();
  p.status=next;p.changedAt=Date.now();
  save();render();toast('â†’ '+SLABELS[next]);
}

let deleteTarget={id:null,type:null};
window.confirmDelete=(id,type,e)=>{
  if(e)e.stopPropagation();
  deleteTarget={id,type};
  const item=data.find(d=>d.id===id);
  const name=item?item.name:'Item';
  let msg='Delete "<strong>'+esc(name)+'</strong>"?';
  if(type==='assembly'){
    const kids=data.filter(d=>d.parentId===id);
    if(kids.length)msg+='<br><span style="color:var(--text3);font-size:11px">+'+kids.length+' part'+(kids.length>1?'s':'')+'</span>';
  }else if(type==='part'){
    const subParts=data.filter(d=>d.parentId===id);
    if(subParts.length)msg+='<br><span style="color:var(--text3);font-size:11px">+'+subParts.length+' sub-part'+(subParts.length>1?'s':'')+'</span>';
  }
  $('deleteMsg').innerHTML=msg;
  
  // Position popover near the button
  const popover=$('deletePopover');
  popover.style.transform=''; // Reset any previous transform
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left;
    // Keep in viewport
    if(left+220>window.innerWidth)left=window.innerWidth-230;
    if(left<10)left=10;
    if(top+150>window.innerHeight)top=rect.top-160;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
  }else{
    popover.style.top='50%';
    popover.style.left='50%';
    popover.style.transform='translate(-50%,-50%)';
  }
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
};

window.copyPO=(po,e)=>{
  e.stopPropagation();
  navigator.clipboard.writeText(po);
  toast('Copied: '+po);
};

window.delTeam=(idx,e)=>{
  deleteTarget={id:idx,type:'team'};
  const member=team[idx];
  const name=member?member.name:'Member';
  $('deleteMsg').innerHTML='Remove "<strong>'+esc(name)+'</strong>" from team?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};
window.openDates=()=>{$('startDate').value=projectDates.start||'';$('endDate').value=projectDates.end||'';$('datesModal').classList.add('open')};

function sendNotify(item,isAsm){const email=getTeamEmail(item.assignee);if(!email)return;const status=isAsm?calcAsmProgress(item.id)+'%':SLABELS[item.status],subject=encodeURIComponent('Action Required: '+item.name),body=encodeURIComponent('Hi '+item.assignee+',\n\nItem: '+item.name+'\nStatus: '+status+'\n'+(item.notes?'Notes: '+item.notes+'\n':'')+'\nThanks!');window.location.href='mailto:'+email+'?subject='+subject+'&body='+body}

window.editAction=(id,e)=>{const a=actions.find(x=>x.id===id);if(!a)return;editActId=id;$('actTitle').textContent='Edit Action';$('actTask').value=a.task;$('actLinkedPart').value=a.linkedPartId||'';$('actDue').value=a.due||'';$('actAssignee').value=a.assignee||'';$('actStatus').value=a.status;showPopoverModal($('actionModal'),e?e.target.closest('button'):null)};
window.advAction=id=>{const a=actions.find(x=>x.id===id);if(!a)return;const si=ASTAGES.indexOf(a.status),next=ASTAGES[si+1];if(next){a.status=next;save();render();toast('â†’ '+ALABELS[next])}};
window.delAction=(id,e)=>{
  deleteTarget={id,type:'action'};
  const item=actions.find(a=>a.id===id);
  const name=item?item.task:'Action';
  $('deleteMsg').innerHTML='Delete "<strong>'+esc(name.substring(0,30))+(name.length>30?'...':'')+'</strong>"?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};

window.goToAction=actionId=>{highlightActionId=actionId;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="actions"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('actionsPanel').classList.add('active');renderActions();setTimeout(()=>{const row=document.querySelector('[data-action-id="'+actionId+'"]');if(row)row.scrollIntoView({behavior:'smooth',block:'center'})},50)};
window.goToPart=partId=>{$('metricsPopover').classList.remove('open');document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="list"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('listPanel').classList.add('active');const part=data.find(d=>d.id===partId);if(part&&part.parentId)expanded[part.parentId]=true;highlightPartId=partId;render();setTimeout(()=>{const row=document.querySelector('[data-part-id="'+partId+'"]');if(row)row.scrollIntoView({behavior:'smooth',block:'center'})},50)};
window.goToAsm=asmId=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="list"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('listPanel').classList.add('active');expanded[asmId]=true;highlightAsmId=asmId;render();setTimeout(()=>{const row=document.querySelector('[data-asm-id="'+asmId+'"]');if(row){row.scrollIntoView({behavior:'smooth',block:'center'});row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),1500)}},50)};
window.goToGanttAsm=(asmId,e)=>{e&&e.stopPropagation();document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="gantt"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('ganttPanel').classList.add('active');ganttExpanded[asmId]=true;window._ganttScrolled=false;setTimeout(()=>{renderGantt();const row=document.querySelector('.gantt-sidebar-row[data-row-id="'+asmId+'"]');if(row){row.scrollIntoView({behavior:'smooth',block:'center'});row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),1500)}},50)};
let highlightAsmId=null;

const closeModal=id=>$(id).classList.remove('open');

// Event listeners
$('aiAlert').onclick=(e)=>{toggleAIWorkspace()};
$('aiClose').onclick=()=>hidePopoverModal($('aiModal'));
$('aiAskBtn').onclick=handleAskSubmit;
$('aiStraightBtn').onclick=handleStraight;
$('aiQuestion').onkeydown=e=>{if(e.key==='Enter')handleAskSubmit()};

// AI Workspace handlers
$('aiWorkspaceAskBtn').onclick=handleWorkspaceAsk;
$('aiWorkspaceTellBtn').onclick=handleWorkspaceTell;
$('aiWorkspaceQuestion').onkeydown=e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleWorkspaceAsk()}
};
$('aiWorkspaceQuestion').oninput=function(){
  this.style.height='auto';
  this.style.height=Math.min(this.scrollHeight,150)+'px';
};

$('reportBtn').onclick=async(e)=>{
  const popover=$('reportModal');
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  
  // Show empty state if no report generated yet
  if(!lastReportContent){
    showReportEmptyState();
  }
};

function showReportEmptyState(){
  $('reportModelBadge').textContent='';
  $('reportRefresh').disabled=true;
  $('reportContent').innerHTML=`
    <div class="report-empty">
      <button class="report-generate-btn" onclick="event.stopPropagation(); window.generateOpusReport()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 3v3m0 12v3m-9-9h3m12 0h3m-4.6-7.4l-2.1 2.1m-5.7 5.7l-2.1 2.1m0-9.9l2.1 2.1m5.7 5.7l2.1 2.1"/></svg>
        Generate Report
      </button>
    </div>
  `;
}

window.generateOpusReport=async function(){
  $('reportContent').innerHTML='<div class="report-loading"><div class="report-loading-spinner"></div><div class="report-loading-text">Generating comprehensive report with Opus 4.5...</div></div>';
  $('reportModelBadge').textContent='thinking...';
  $('reportRefresh').disabled=false;
  $('reportRefresh').classList.add('spinning');
  
  const context=buildFullProjectContext();
  
  try{
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({
      mode:'report',
      projectContext:context,
      maxChars:2000,
      style:'detailed',
      model:'claude-opus-4-5-20251101'
    });
    
    console.log('ðŸ¤– Report Model Verification:');
    console.log('   Requested: claude-opus-4-5-20251101');
    console.log('   Returned:', result.data?.model||'unknown');
    
    if(result.data?.success){
      const actualModel=result.data.model||'claude-opus-4-5-20251101';
      $('reportModelBadge').textContent=AI_MODELS[actualModel]?.name||actualModel;
      $('reportContent').innerHTML=formatReportResponse(result.data.content);
      lastReportContent=result.data.content;
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Report generation failed:',e);
    $('reportModelBadge').textContent='offline';
    // Fallback to local report
    const localReport=generateReport();
    $('reportContent').innerHTML='<div class="report-prose"><p style="color:var(--text3);margin-bottom:12px;font-size:12px">âš  AI unavailable - showing local report</p><pre style="white-space:pre-wrap;font-family:inherit;font-size:13px">'+esc(localReport)+'</pre></div>';
    lastReportContent=localReport;
  }
  
  $('reportRefresh').classList.remove('spinning');
}

function buildFullProjectContext(){
  const parts=getParts(),asms=getAsms();
  const pct=calcOverallProgress(),expected=getExpectedProgress(),daysLeft=getDaysLeft();
  const forecast=getVelocityForecast();
  const otd=calcSupplierOTD();
  const now=Date.now(),day=86400000;
  
  // Build comprehensive context
  const ctx={
    project:{
      name:currentProjectName,
      progress:pct,
      expected:expected,
      daysLeft:daysLeft,
      totalParts:parts.length,
      totalAssemblies:asms.length
    },
    counts:{
      pending:parts.filter(p=>p.status==='pending').length,
      'to-order':parts.filter(p=>p.status==='to-order').length,
      ordered:parts.filter(p=>p.status==='ordered').length,
      arrived:parts.filter(p=>p.status==='arrived').length,
      tested:parts.filter(p=>p.status==='tested').length,
      configured:parts.filter(p=>p.status==='configured').length,
      installed:parts.filter(p=>p.status==='installed').length,
      total:parts.length
    },
    assemblies:asms.map(a=>({
      name:a.name,
      progress:calcAsmProgress(a.id),
      partCount:parts.filter(p=>p.parentId===a.id).length,
      priority:a.priority||999
    })).sort((a,b)=>a.priority-b.priority),
    // ALL parts with full details (only non-empty fields)
    allParts:parts.map(p=>{
      const asm=asms.find(a=>a.id===p.parentId);
      const daysInStatus=p.changedAt?Math.floor((now-p.changedAt)/day):0;
      const part={id:p.id,name:p.name,status:p.status,daysInStatus};
      if(asm?.name)part.assembly=asm.name;
      if(p.assignee)part.assignee=p.assignee;
      if(p.poNumber)part.poNumber=p.poNumber;
      if(p.mfr)part.mfr=p.mfr;
      if(p.code)part.code=p.code;
      if(p.qty&&p.qty>1)part.qty=p.qty;
      if(p.expectedArrival)part.expectedArrival=p.expectedArrival;
      if(p.pendingNote)part.pendingNote=p.pendingNote;
      if(p.notes)part.notes=p.notes;
      return part;
    }),
    stuck:parts.filter(p=>{
      const days=Math.floor((now-(p.changedAt||now))/day);
      return days>5&&p.status!=='installed';
    }).map(p=>({
      name:p.name,
      status:p.status,
      days:Math.floor((now-(p.changedAt||now))/day),
      assembly:asms.find(a=>a.id===p.parentId)?.name||'Unassigned',
      assignee:p.assignee||''
    })),
    velocity:forecast?{
      rate:forecast.rate,
      daysToComplete:forecast.daysToComplete,
      status:forecast.status,
      estDate:forecast.estDate
    }:null,
    suppliers:getSupplierStats(),
    otdRate:otd,
    overdueActions:actions.filter(a=>a.status!=='completed'&&a.due&&a.due<new Date().toISOString().split('T')[0]).map(a=>({
      task:a.task,
      due:a.due,
      assignee:a.assignee,
      daysOverdue:Math.floor((now-new Date(a.due))/day)
    })),
    upcomingActions:actions.filter(a=>a.status!=='completed'&&a.due).sort((a,b)=>a.due.localeCompare(b.due)).slice(0,5).map(a=>({
      task:a.task,
      due:a.due,
      assignee:a.assignee
    })),
    workload:getWorkloadStats(),
    recentActivity:history.slice(-10).map(h=>({
      action:h.action,
      item:h.item,
      time:new Date(h.ts).toLocaleDateString()
    }))
  };
  
  return ctx;
}

function getSupplierStats(){
  const parts=getParts();
  const suppliers={};
  parts.forEach(p=>{
    if(p.mfr){
      if(!suppliers[p.mfr])suppliers[p.mfr]={total:0,installed:0,ordered:0};
      suppliers[p.mfr].total++;
      if(p.status==='installed')suppliers[p.mfr].installed++;
      if(p.status==='ordered')suppliers[p.mfr].ordered++;
    }
  });
  return Object.entries(suppliers).map(([name,s])=>({
    name,
    total:s.total,
    installed:s.installed,
    pending:s.ordered
  })).sort((a,b)=>b.total-a.total).slice(0,8);
}

function getWorkloadStats(){
  const parts=getParts();
  const workload={};
  parts.forEach(p=>{
    const assignee=p.assignee||'Unassigned';
    if(!workload[assignee])workload[assignee]={total:0,installed:0,pending:0};
    workload[assignee].total++;
    if(p.status==='installed')workload[assignee].installed++;
    else workload[assignee].pending++;
  });
  return Object.entries(workload).map(([name,w])=>({
    name,
    total:w.total,
    installed:w.installed,
    pending:w.pending
  })).sort((a,b)=>b.pending-a.pending).slice(0,6);
}

function formatReportResponse(text){
  let html=text;
  
  // Process charts BEFORE escaping
  // Bar chart
  html=html.replace(/\[CHART:bar:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)};
      });
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*40+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 400 '+h+'" width="400" style="margin:16px 0">';
      items.forEach((item,i)=>{
        const w=Math.round(item.val/max*200);
        const y=i*40+10;
        svg+='<text x="8" y="'+(y+24)+'" font-size="13" fill="var(--text2)">'+item.label+'</text>';
        svg+='<rect x="140" y="'+(y+8)+'" width="'+w+'" height="24" rx="6" fill="var(--accent)" opacity="0.75"/>';
        svg+='<text x="'+(150+w)+'" y="'+(y+26)+'" font-size="14" fill="var(--text)" font-weight="500">'+item.val+'</text>';
      });
      svg+='</svg>';
      return svg;
    }catch(e){return '';}
  });
  
  // Funnel chart
  html=html.replace(/\[CHART:funnel:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)};
      });
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*44+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 420 '+h+'" width="420" style="margin:16px 0">';
      items.forEach((item,i)=>{
        const w=Math.round(item.val/max*200);
        const x=(200-w)/2+120;
        const y=i*44+10;
        svg+='<text x="8" y="'+(y+26)+'" font-size="12" fill="var(--text3)">'+item.label+'</text>';
        svg+='<rect x="'+x+'" y="'+(y+8)+'" width="'+w+'" height="28" rx="6" fill="var(--s'+((i%6)+1)+')" opacity="0.85"/>';
        svg+='<text x="340" y="'+(y+28)+'" font-size="14" fill="var(--text)" font-weight="600">'+item.val+'</text>';
      });
      svg+='</svg>';
      return svg;
    }catch(e){return '';}
  });
  
  // Extract SVGs before escaping
  const svgParts=[];
  html=html.replace(/<svg[\s\S]*?<\/svg>/g,(match)=>{
    svgParts.push(match);
    return '{{SVG'+(svgParts.length-1)+'}}';
  });
  
  // Escape HTML
  html=esc(html);
  
  // Restore SVGs
  svgParts.forEach((v,i)=>{html=html.replace('{{SVG'+i+'}}',v);});
  
  // Replace [[Part Name]] with clickable links
  html=html.replace(/\[\[([^\]]+)\]\]/g,(match,partName)=>{
    // Try exact match first (case-insensitive)
    let part=getParts().find(p=>p.name.toLowerCase()===partName.toLowerCase().trim());
    
    // If no exact match, try partial match
    if(!part){
      const searchName=partName.toLowerCase().trim();
      part=getParts().find(p=>
        p.name.toLowerCase().includes(searchName) || 
        searchName.includes(p.name.toLowerCase())
      );
    }
    
    // If still no match, try matching just the first word
    if(!part){
      const firstWord=partName.toLowerCase().trim().split(/\s+/)[0];
      if(firstWord.length>3){
        part=getParts().find(p=>p.name.toLowerCase().startsWith(firstWord));
      }
    }
    
    if(part){
      return '<a class="ai-part-link" href="#" onclick="window.aiGoToPart('+part.id+',event);return false;">'+partName+'</a>';
    }
    return '<strong>'+partName+'</strong>';
  });
  
  // Replace {{Assembly Name}} with clickable links  
  html=html.replace(/\{\{([^\}]+)\}\}/g,(match,asmName)=>{
    // Skip our SVG placeholders
    if(asmName.startsWith('SVG'))return match;
    const asm=getAsms().find(a=>a.name.toLowerCase()===asmName.toLowerCase());
    if(asm){
      return '<a class="ai-asm-link" href="#" onclick="window.aiGoToAsm('+asm.id+');return false;">'+asmName+'</a>';
    }
    return '<strong>'+asmName+'</strong>';
  });
  
  // Replace **bold** with <strong>
  html=html.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  
  // Replace headers
  html=html.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  html=html.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  html=html.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  
  // Replace --- with divider
  html=html.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid var(--border);margin:20px 0">');
  
  // Replace bullet points
  html=html.replace(/^[â€¢\-\*] (.+)$/gm,'<li>$1</li>');
  
  // Wrap consecutive li elements in ul
  html=html.replace(/(<li>.*<\/li>\n?)+/g,(match)=>'<ul>'+match+'</ul>');
  
  // Replace numbered lists
  html=html.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
  
  // Handle ALL CAPS headers
  html=html.replace(/^([A-Z][A-Z\s&]+):?\s*$/gm,'<h2 style="margin-top:24px">$1</h2>');
  
  // Paragraphs - split by double newline
  const parts=html.split(/\n\n+/);
  const processed=parts.map(p=>{
    p=p.trim();
    if(!p)return '';
    if(p.startsWith('<'))return p;
    return '<p>'+p.replace(/\n/g,' ')+'</p>';
  }).filter(p=>p).join('\n');
  
  return '<div class="report-prose">'+processed+'</div>';
}

let lastReportContent='';

$('reportRefresh').onclick=async()=>{
  await window.generateOpusReport();
};
$('reportClose').onclick=()=>{$('reportModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
document.addEventListener('click',e=>{
  const popover=$('reportModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#reportBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});
$('reportCopy').onclick=()=>{
  const text=$('reportContent').innerText||lastReportContent;
  navigator.clipboard.writeText(text);
  toast('Copied');
};
$('reportEmail').onclick=()=>{
  const emails=team.map(t=>t.email).filter(e=>e).join(',');
  if(!emails){toast('No team emails',1);return}
  const text=$('reportContent').innerText||lastReportContent;
  const subject=encodeURIComponent(currentProjectName+' - Status Report');
  const body=encodeURIComponent(text);
  window.location.href='mailto:'+emails+'?subject='+subject+'&body='+body;
};

$('etaSave').onclick=()=>{if(!editEtaPartId)return;const part=data.find(d=>d.id===editEtaPartId);if(!part)return;const val=$('etaDateInput').value;part.expectedArrival=val||undefined;part.manualEta=undefined;save();render();$('etaPopover').classList.remove('open');editEtaPartId=null;toast('Saved')};
$('etaClear').onclick=()=>{if(!editEtaPartId)return;const part=data.find(d=>d.id===editEtaPartId);if(!part)return;part.expectedArrival=undefined;part.manualEta=undefined;save();render();$('etaPopover').classList.remove('open');editEtaPartId=null;toast('Cleared')};

$('bomClose').onclick=$('bomCancel').onclick=()=>closeModal('bomModal');
$('bomModal').onclick=e=>{if(e.target.id==='bomModal')closeModal('bomModal')};
$('bomSave').onclick=window.saveBom;

$('leadtimeBtn').onclick=()=>{renderLeadTimeModal();$('leadtimeModal').classList.add('open')};
$('ltClose').onclick=$('ltDone').onclick=()=>closeModal('leadtimeModal');
$('leadtimeModal').onclick=e=>{if(e.target.id==='leadtimeModal')closeModal('leadtimeModal')};
$('ltClear').onclick=()=>{if(confirm('Clear all?')){leadTimeDb={};saveLeadTime();renderLeadTimeModal();toast('Cleared')}};

// Item Code Configuration Modal
function renderItemConfigModal(){
  const codes=Object.keys(itemCodeConfig).sort();
  if(!codes.length){
    $('icList').innerHTML='<div class="itemconfig-empty">No item codes configured yet.<br>Add a code above to customize testing & configuration requirements.</div>';
    return;
  }
  let html='';
  codes.forEach(code=>{
    const cfg=itemCodeConfig[code];
    html+='<div class="itemconfig-item" data-code="'+esc(code)+'">';
    html+='<div class="itemconfig-item-header"><span class="itemconfig-code">'+esc(code)+'</span><button class="itemconfig-del" onclick="window.deleteItemConfig(\''+esc(code)+'\')">Ã—</button></div>';
    html+='<div class="itemconfig-options">';
    html+='<div class="itemconfig-opt"><label>Testing Required</label><input type="checkbox" '+(cfg.requiresTesting?'checked':'')+' onchange="window.updateItemConfig(\''+esc(code)+'\',\'requiresTesting\',this.checked)"></div>';
    html+='<div class="itemconfig-opt"><label>Tester</label><select onchange="window.updateItemConfig(\''+esc(code)+'\',\'tester\',this.value)"><option value="">â€” Any â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(cfg.tester===t.name?' selected':'')+'>'+esc(t.name)+'</option>').join('')+'</select></div>';
    html+='<div class="itemconfig-opt"><label>Config Required</label><input type="checkbox" '+(cfg.requiresConfig?'checked':'')+' onchange="window.updateItemConfig(\''+esc(code)+'\',\'requiresConfig\',this.checked)"></div>';
    html+='<div class="itemconfig-opt"><label>Configured By</label><select onchange="window.updateItemConfig(\''+esc(code)+'\',\'configuredBy\',this.value)"><option value="">â€” Any â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(cfg.configuredBy===t.name?' selected':'')+'>'+esc(t.name)+'</option>').join('')+'</select></div>';
    html+='</div></div>';
  });
  $('icList').innerHTML=html;
}

window.updateItemConfig=function(code,field,value){
  if(!itemCodeConfig[code])itemCodeConfig[code]={requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  itemCodeConfig[code][field]=value;
  saveItemCodeConfig();
  render(); // Re-render to update stage dots
};

window.deleteItemConfig=function(code){
  delete itemCodeConfig[code];
  saveItemCodeConfig();
  renderItemConfigModal();
  render();
  toast('Removed');
};

window.addItemConfig=function(){
  const input=$('icNewCode');
  const code=input.value.trim().toUpperCase();
  if(!code){toast('Enter code',1);return}
  if(itemCodeConfig[code]){toast('Already exists',1);return}
  itemCodeConfig[code]={requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  saveItemCodeConfig();
  input.value='';
  renderItemConfigModal();
  toast('Added');
};

$('itemConfigBtn').onclick=()=>{renderItemConfigModal();$('itemConfigModal').classList.add('open')};
$('icClose').onclick=$('icDone').onclick=()=>closeModal('itemConfigModal');
$('itemConfigModal').onclick=e=>{if(e.target.id==='itemConfigModal')closeModal('itemConfigModal')};
$('icAddBtn').onclick=window.addItemConfig;
$('icNewCode').onkeydown=e=>{if(e.key==='Enter')window.addItemConfig()};

// OTD Modal
window.showOTDModal=function(){
  const mfrData=calcOTDByMfr();
  const overallOTD=calcSupplierOTD();
  const avgLead=calcAvgLeadTime();
  
  let html='';
  if(!mfrData.length){
    html='<div class="otd-empty">No delivery data yet.<br><span style="font-size:11px">Data is collected when parts move from Ordered â†’ Arrived</span></div>';
  }else{
    // Overall summary
    html+='<div class="otd-item" style="background:var(--bg3);margin-bottom:16px"><div class="otd-mfr">Overall</div><div class="otd-stats"><div class="otd-stat"><span class="otd-stat-val" style="color:'+(overallOTD>=90?'var(--green)':overallOTD>=70?'var(--yellow)':'var(--red)')+'">'+(overallOTD||0)+'%</span><span class="otd-stat-label">OTD</span></div><div class="otd-stat"><span class="otd-stat-val">'+(avgLead||0)+'d</span><span class="otd-stat-label">Avg Lead</span></div></div></div>';
    // Per manufacturer
    mfrData.forEach(m=>{
      const color=m.otd>=90?'var(--green)':m.otd>=70?'var(--yellow)':'var(--red)';
      html+='<div class="otd-item"><div class="otd-mfr">'+esc(m.mfr)+'</div><div class="otd-stats"><div class="otd-stat"><span class="otd-stat-val" style="color:'+color+'">'+m.otd+'%</span><span class="otd-stat-label">OTD</span></div><div class="otd-stat"><span class="otd-stat-val">'+m.avgLead+'d</span><span class="otd-stat-label">Lead</span></div><div class="otd-stat"><span class="otd-stat-val" style="font-size:13px">'+m.total+'</span><span class="otd-stat-label">Parts</span></div><div class="otd-bar"><div class="otd-bar-fill" style="width:'+m.otd+'%;background:'+color+'"></div></div></div></div>';
    });
  }
  $('otdBody').innerHTML=html;
  $('otdModal').classList.add('open');
};

window.showOTDInline=function(){
  const isOpen=$('mpOTDDetail').style.display==='block';
  if(isOpen){
    window.hideOTDInline();
    return;
  }
  const mfrData=calcOTDByMfr();
  const overallOTD=calcSupplierOTD();
  const avgLead=calcAvgLeadTime();
  
  let html='';
  if(!mfrData.length){
    html='<div style="color:var(--text3);font-size:11px;padding:8px">No delivery data yet</div>';
  }else{
    // Overall summary row
    html+='<div class="mp-otd-item" style="font-weight:500"><span class="mp-otd-item-mfr">Overall</span><span class="mp-otd-item-stats" style="color:'+(overallOTD>=90?'var(--green)':overallOTD>=70?'var(--yellow)':'var(--red)')+'">'+(overallOTD||0)+'% OTD â€¢ '+(avgLead||0)+'d avg</span></div>';
    // Per manufacturer
    mfrData.forEach(m=>{
      const color=m.otd>=90?'var(--green)':m.otd>=70?'var(--yellow)':'var(--red)';
      html+='<div class="mp-otd-item"><span class="mp-otd-item-mfr">'+esc(m.mfr)+'</span><span class="mp-otd-item-stats"><span style="color:'+color+'">'+m.otd+'%</span> â€¢ '+m.avgLead+'d â€¢ '+m.total+' parts</span></div>';
    });
  }
  $('mpOTDContent').innerHTML=html;
  $('mpOTDDetail').style.display='block';
  $('mpSupplierRows').style.display='none';
  $('mpOTDArrow').textContent='â–¼';
};

window.hideOTDInline=function(){
  $('mpOTDDetail').style.display='none';
  $('mpSupplierRows').style.display='block';
  $('mpOTDArrow').textContent='â–¶';
};

$('otdClose').onclick=$('otdDone').onclick=()=>closeModal('otdModal');
$('otdModal').onclick=e=>{if(e.target.id==='otdModal')closeModal('otdModal')};

$('pmClose').onclick=$('pmCancel').onclick=()=>{hidePopoverModal($('partModal'));editId=null};
$('pmSave').onclick=()=>{
  const name=$('pmName').value.trim();if(!name){toast('Enter name',1);return}
  const now=Date.now();
  if(editId){
    const p=data.find(d=>d.id===editId);
    if(p){
      const changedFields=[];
      const oldStatus=p.status;
      const newName=$('pmName').value.trim();
      const newCode=$('pmCode').value.trim();
      const newMfr=$('pmMfr').value.trim();
      const newQty=parseInt($('pmQty').value)||1;
      const newAssignee=$('pmAssignee').value;
      const newParentId=$('pmParent').value?parseInt($('pmParent').value):null;
      const newNotes=$('pmNotes').value.trim();
      const newStatus=$('pmStatus').value;
      
      if(p.name!==newName){p.name=newName;changedFields.push('name');}
      if(p.code!==newCode){p.code=newCode;changedFields.push('code');}
      if(p.mfr!==newMfr){p.mfr=newMfr;changedFields.push('mfr');}
      if(p.qty!==newQty){p.qty=newQty;changedFields.push('qty');}
      if(p.assignee!==newAssignee){p.assignee=newAssignee;changedFields.push('assignee');}
      if(p.parentId!==newParentId){p.parentId=newParentId;changedFields.push('parentId');}
      if(p.notes!==newNotes){p.notes=newNotes;changedFields.push('notes');}
      
      if(oldStatus!==newStatus){
        if(oldStatus==='ordered'&&newStatus==='arrived'&&p.orderedAt&&p.code){
          const days=Math.round((now-p.orderedAt)/86400000);
          if(days>0)recordLeadTime(p.code,days);
        }
        if(newStatus==='ordered')p.orderedAt=now;
        p.status=newStatus;
        p.changedAt=now;
        changedFields.push('status');
      }
      
      changedFields.forEach(f=>updateFieldTimestamp(p,f));
      if(changedFields.length)markPartChanged(editId,changedFields);
    }
    toast('Updated');
  }else{
    const part={id:now,name,code:$('pmCode').value.trim(),mfr:$('pmMfr').value.trim(),qty:parseInt($('pmQty').value)||1,assignee:$('pmAssignee').value,status:$('pmStatus').value,parentId:$('pmParent').value?parseInt($('pmParent').value):null,notes:$('pmNotes').value.trim(),changedAt:now,_fieldTs:{}};
    ['name','code','mfr','qty','assignee','status','parentId','notes'].forEach(f=>{if(part[f])part._fieldTs[f]=now;});
    if(part.status==='ordered')part.orderedAt=now;
    data.push(part);
    markPartChanged(now,['name','code','mfr','qty','assignee','status','parentId','notes']);
    toast('Added');
  }
  save();render();hidePopoverModal($('partModal'));editId=null;
};


$('amClose').onclick=$('amCancel').onclick=()=>{hidePopoverModal($('asmModal'));editAsmId=null};
$('amSave').onclick=()=>{
  const name=$('amName').value.trim();if(!name){toast('Enter name',1);return}
  if(editAsmId){
    const a=data.find(d=>d.id===editAsmId);
    if(a){a.name=name;a.assignee=$('amAssignee').value;a.notes=$('amNotes').value.trim()}
    toast('Updated');
  }else{
    const asms=getAsms(),maxP=asms.length?Math.max(...asms.map(a=>a.priority||0)):0;
    const id=Date.now();
    data.push({id,name,isAsm:true,assignee:$('amAssignee').value,notes:$('amNotes').value.trim(),priority:maxP+1});
    expanded[id]=true;
    toast('Added');
  }
  save();render();hidePopoverModal($('asmModal'));editAsmId=null;
};


$('amNotify').onclick=()=>{if(editAsmId){const a=data.find(d=>d.id===editAsmId);if(a)sendNotify(a,true)}};
$('amAssignee').onchange=()=>{$('amNotify').disabled=!getTeamEmail($('amAssignee').value)};
$('pmAssignee').onchange=()=>{$('pmNotify').disabled=!getTeamEmail($('pmAssignee').value)};
$('pmNotify').onclick=()=>{if(editId){const p=data.find(d=>d.id===editId);if(p)sendNotify(p,false)}};

$('actClose').onclick=$('actCancel').onclick=()=>{hidePopoverModal($('actionModal'));editActId=null};
$('actSave').onclick=()=>{
  const task=$('actTask').value.trim();if(!task){toast('Enter task',1);return}
  const newStatus=$('actStatus').value;
  if(editActId){
    const a=actions.find(x=>x.id===editActId);
    if(a){
      a.task=task;a.linkedPartId=$('actLinkedPart').value?parseInt($('actLinkedPart').value):null;a.due=$('actDue').value;a.assignee=$('actAssignee').value;a.status=newStatus;
    }
    toast('Updated');
  }else{
    actions.push({id:Date.now(),task,linkedPartId:$('actLinkedPart').value?parseInt($('actLinkedPart').value):null,due:$('actDue').value,assignee:$('actAssignee').value,status:newStatus,createdAt:new Date().toISOString().split('T')[0]});
    toast('Added');
  }
  save();render();hidePopoverModal($('actionModal'));editActId=null;
};


$('addActionBtn').onclick=(e)=>{editActId=null;$('actTitle').textContent='Add Action';$('actTask').value='';$('actLinkedPart').value='';$('actDue').value='';$('actAssignee').value='';$('actStatus').value='not-started';showPopoverModal($('actionModal'),e.target)};

$('teamBtn').onclick=()=>{renderTeamList();$('teamModal').classList.add('open')};
$('teamClose').onclick=$('teamDone').onclick=()=>closeModal('teamModal');
$('teamModal').onclick=e=>{if(e.target.id==='teamModal')closeModal('teamModal')};
$('teamAdd').onclick=()=>{const name=$('teamName').value.trim(),email=$('teamEmail').value.trim();if(!name||!email.includes('@')){toast('Enter name & email',1);return}if(team.find(t=>t.name===name)){toast('Exists',1);return}team.push({name,email});save();$('teamName').value='';$('teamEmail').value='';renderTeamList();updateSelects();toast('Added')};

$('datesBtn').onclick=$('burndownEdit').onclick=window.openDates;
$('datesClose').onclick=$('datesCancel').onclick=()=>closeModal('datesModal');
$('datesSave').onclick=()=>{projectDates.start=$('startDate').value;projectDates.end=$('endDate').value;save();render();closeModal('datesModal');toast('Saved')};
$('datesModal').onclick=e=>{if(e.target.id==='datesModal')closeModal('datesModal')};

// PO Modal handlers
$('poClose').onclick=$('poCancel').onclick=()=>{$('poModal').classList.remove('open');$('popoverBackdrop').classList.remove('active');pendingAdvPartId=null};
$('poSave').onclick=()=>{
  if(pendingAdvPartId){
    const p=data.find(d=>d.id===pendingAdvPartId);
    if(p){
      p.poNumber=$('poNumber').value.trim()||null;
      p.expectedArrival=$('poArrivalDate').value||null;
      advancePartStatus(pendingAdvPartId);
    }
  }
  $('poModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  pendingAdvPartId=null;
};

// Receive PO Modal handlers
function updatePOSuggestions(){
  const poNumbers=[...new Set(data.filter(d=>d.poNumber&&d.status==='ordered').map(d=>d.poNumber))];
  $('poSuggestions').innerHTML=poNumbers.map(po=>'<option value="'+esc(po)+'">').join('');
}
function updateReceivePOPreview(){
  const po=$('receivePONumber').value.trim();
  if(!po){
    $('receivePOPreview').innerHTML='<div class="receive-po-empty">Enter a PO number to see matching parts</div>';
    $('receivePOConfirm').disabled=true;
    return;
  }
  const matchingParts=data.filter(d=>d.poNumber===po&&d.status==='ordered');
  if(!matchingParts.length){
    $('receivePOPreview').innerHTML='<div class="receive-po-empty">No ordered parts found with PO: '+esc(po)+'</div>';
    $('receivePOConfirm').disabled=true;
    return;
  }
  $('receivePOPreview').innerHTML='<div class="receive-po-count"><span>'+matchingParts.length+'</span> part'+(matchingParts.length!==1?'s':'')+' will be marked as arrived</div><div class="receive-po-list">'+matchingParts.map(p=>'<div class="receive-po-item"><span class="receive-po-item-name">'+esc(p.name)+'</span><span class="receive-po-item-status ordered">Ordered</span></div>').join('')+'</div>';
  $('receivePOConfirm').disabled=false;
}
$('receivePOBtn').onclick=(e)=>{
  updatePOSuggestions();
  $('receivePONumber').value='';
  updateReceivePOPreview();
  const popover=$('receivePOModal');
  const btn=e.target.closest('button');
  const rect=btn.getBoundingClientRect();
  popover.style.top=(rect.bottom+8)+'px';
  popover.style.left=Math.max(10,rect.right-320)+'px';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>$('receivePONumber').focus(),100);
};
$('receivePONumber').oninput=updateReceivePOPreview;
$('receivePOClose').onclick=$('receivePOCancel').onclick=()=>{$('receivePOModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
$('receivePOConfirm').onclick=()=>{
  const po=$('receivePONumber').value.trim();
  if(!po)return;
  const matchingParts=data.filter(d=>d.poNumber===po&&d.status==='ordered');
  if(!matchingParts.length)return;
  const today=new Date().toISOString().split('T')[0];
  matchingParts.forEach(p=>{
    // Record lead time if we have orderedDate
    if(p.orderedDate&&p.code){
      const orderDate=new Date(p.orderedDate);
      const arriveDate=new Date(today);
      const days=Math.round((arriveDate-orderDate)/(86400000));
      if(days>0&&days<365)recordLeadTime(p.code,days);
    }
    p.status='arrived';
    p.arrivedDate=today;
    p.changedAt=Date.now();
  });
  save();
  render();
  $('receivePOModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  toast(matchingParts.length+' part'+(matchingParts.length!==1?'s':'')+' received');
};
// Close receive PO popover when clicking outside
document.addEventListener('click',e=>{
  const popover=$('receivePOModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#receivePOBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});

// Delete confirmation popover handlers
function closeDeletePopover(){$('deletePopover').classList.remove('open');$('popoverBackdrop').classList.remove('active');deleteTarget={id:null,type:null}}
$('deleteCancel').onclick=closeDeletePopover;
$('deleteConfirm').onclick=()=>{
  if(deleteTarget.id!==null){
    if(deleteTarget.type==='action'){
      actions=actions.filter(a=>a.id!==deleteTarget.id);
      save();render();
    }else if(deleteTarget.type==='team'){
      team.splice(deleteTarget.id,1);
      save();renderTeamList();updateSelects();
    }else if(deleteTarget.type==='bom'){
      savedBoms=savedBoms.filter(b=>b.id!==deleteTarget.id);
      saveBoms();renderBomList();
    }else{
      const item=data.find(d=>d.id===deleteTarget.id);
      if(item){
        data=data.filter(d=>d.id!==deleteTarget.id&&d.parentId!==deleteTarget.id);
        delete expanded[deleteTarget.id];
        save();render();
      }
    }
    toast('Deleted');
  }
  closeDeletePopover();
};
// Delete close handled by backdrop

$('menuBtn').onclick=e=>{
  e.stopPropagation();
  $('menuDrop').classList.toggle('open');
};
document.addEventListener('click',e=>{
  if($('menuDrop').classList.contains('open')&&!e.target.closest('.dropdown')){
    $('menuDrop').classList.remove('open');
  }
});

$('sampleBtn').onclick=()=>{if(confirm('Reset to sample data? This will replace all current data.'))createAndSaveSampleData()};

// NAV Import functionality
let navImportData=[];
$('navImportBtn').onclick=()=>{
  navImportData=[];
  $('navFileInput').value='';
  $('navFileName').textContent='';
  $('navPreview').style.display='none';
  $('navImportApply').disabled=true;
  $('navImportModal').classList.add('open');
};
$('navImportClose').onclick=$('navImportCancel').onclick=()=>$('navImportModal').classList.remove('open');
$('navFileBtn').onclick=()=>$('navFileInput').click();
$('navFileInput').onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  $('navFileName').textContent=file.name;
  const reader=new FileReader();
  reader.onload=ev=>{
    parseNavCSV(ev.target.result);
  };
  reader.readAsText(file);
};

function parseNavCSV(csvText){
  const lines=csvText.trim().split('\n');
  if(lines.length<2){toast('Invalid CSV file','err');return}
  
  // Parse header to find columns - flexible matching
  const header=lines[0].split(/[,;\t]/).map(h=>h.trim().toLowerCase().replace(/['"]/g,''));
  const colMap={};
  header.forEach((h,i)=>{
    if(h.includes('item')&&h.includes('no')||h==='itemno'||h==='item_no'||h==='item number')colMap.itemNo=i;
    else if(h.includes('description')||h==='desc')colMap.desc=i;
    else if(h.includes('po')&&h.includes('no')||h==='pono'||h==='po_no'||h==='po number'||h==='document no')colMap.po=i;
    else if(h.includes('quantity')||h==='qty')colMap.qty=i;
    else if(h.includes('expected')&&h.includes('date')||h.includes('eta')||h.includes('arrival')||h.includes('receipt date'))colMap.eta=i;
    else if(h.includes('status')||h.includes('received')||h.includes('qty received')||h.includes('quantity received'))colMap.status=i;
    else if(h.includes('vendor')||h.includes('supplier'))colMap.vendor=i;
  });
  
  // Fallback: if no specific PO column, check for 'no' or 'document'
  if(colMap.po===undefined){
    header.forEach((h,i)=>{
      if((h.includes('document')||h==='no')&&colMap.po===undefined)colMap.po=i;
    });
  }
  
  navImportData=[];
  const delimiter=lines[0].includes('\t')?'\t':lines[0].includes(';')?';':',';
  
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(delimiter).map(c=>c.trim().replace(/^["']|["']$/g,''));
    if(cols.length<2)continue;
    
    const itemNo=colMap.itemNo!==undefined?cols[colMap.itemNo]:'';
    const desc=colMap.desc!==undefined?cols[colMap.desc]:'';
    const po=colMap.po!==undefined?cols[colMap.po]:'';
    const qty=colMap.qty!==undefined?parseInt(cols[colMap.qty])||1:1;
    const eta=colMap.eta!==undefined?cols[colMap.eta]:'';
    const statusRaw=colMap.status!==undefined?cols[colMap.status]:'';
    const vendor=colMap.vendor!==undefined?cols[colMap.vendor]:'';
    
    // Determine if item is received (check qty received or status text)
    let isReceived=false;
    if(statusRaw){
      const sl=statusRaw.toLowerCase();
      if(sl==='received'||sl==='yes'||sl==='true'||sl==='arrived')isReceived=true;
      // If it's a number (qty received), check if >0
      const qtyRec=parseInt(statusRaw);
      if(!isNaN(qtyRec)&&qtyRec>0)isReceived=true;
    }
    
    // Try to match with existing parts by item code or description
    let matchedPart=null;
    if(itemNo){
      matchedPart=data.find(p=>!p.isAsm&&p.code&&p.code.toLowerCase()===itemNo.toLowerCase());
    }
    if(!matchedPart&&desc){
      // Try exact match first, then partial
      matchedPart=data.find(p=>!p.isAsm&&p.name&&p.name.toLowerCase()===desc.toLowerCase());
      if(!matchedPart){
        matchedPart=data.find(p=>!p.isAsm&&p.name&&(p.name.toLowerCase().includes(desc.toLowerCase())||desc.toLowerCase().includes(p.name.toLowerCase())));
      }
    }
    
    navImportData.push({
      itemNo,desc,po,qty,eta,isReceived,vendor,
      matchedPartId:matchedPart?matchedPart.id:null,
      matchedPartName:matchedPart?matchedPart.name:null
    });
  }
  
  renderNavPreview();
}

function renderNavPreview(){
  const list=$('navPreviewList');
  const matched=navImportData.filter(d=>d.matchedPartId);
  const unmatched=navImportData.filter(d=>!d.matchedPartId);
  
  $('navMatchCount').textContent=matched.length+' of '+navImportData.length+' items matched to parts';
  
  let html='';
  // Show matched first
  matched.forEach(d=>{
    const etaDisplay=d.eta?new Date(d.eta).toLocaleDateString():'â€”';
    const statusClass=d.isReceived?'will-receive':'will-update';
    const statusText=d.isReceived?'Will receive':'Will update PO';
    html+='<div class="nav-preview-item"><div class="nav-preview-name">'+esc(d.matchedPartName)+'<span class="match">âœ“ matched</span></div>';
    if(d.po)html+='<div class="nav-preview-po">'+esc(d.po)+'</div>';
    if(d.eta)html+='<div class="nav-preview-eta">ETA: '+etaDisplay+'</div>';
    html+='<div class="nav-preview-status '+statusClass+'">'+statusText+'</div></div>';
  });
  
  // Show a few unmatched
  if(unmatched.length>0){
    const showUnmatched=unmatched.slice(0,5);
    showUnmatched.forEach(d=>{
      html+='<div class="nav-preview-item no-match"><div class="nav-preview-name">'+esc(d.desc||d.itemNo||'Unknown')+'<span class="no-match">no match</span></div>';
      if(d.po)html+='<div class="nav-preview-po">'+esc(d.po)+'</div>';
      html+='<div class="nav-preview-status">Skipped</div></div>';
    });
    if(unmatched.length>5){
      html+='<div class="nav-preview-item no-match" style="justify-content:center;color:var(--text3);font-size:11px">+'+(unmatched.length-5)+' more unmatched items</div>';
    }
  }
  
  if(html==='')html='<div style="padding:16px;text-align:center;color:var(--text3)">No data found in CSV</div>';
  
  list.innerHTML=html;
  $('navPreview').style.display='block';
  $('navImportApply').disabled=matched.length===0;
}

$('navImportApply').onclick=()=>{
  const autoReceive=$('navAutoReceive').checked;
  let updated=0,received=0;
  
  navImportData.filter(d=>d.matchedPartId).forEach(d=>{
    const part=data.find(p=>p.id===d.matchedPartId);
    if(!part)return;
    
    // Update PO number
    if(d.po&&d.po!==part.poNumber){
      part.poNumber=d.po;
      updated++;
    }
    
    // Update vendor/supplier
    if(d.vendor&&!part.supplier){
      part.supplier=d.vendor;
    }
    
    // Update expected arrival date
    if(d.eta){
      const etaDate=new Date(d.eta);
      if(!isNaN(etaDate.getTime())){
        part.expectedArrival=etaDate.toISOString().split('T')[0];
      }
    }
    
    // Auto-receive if enabled and item is marked as received
    if(autoReceive&&d.isReceived&&(part.status==='ordered'||part.status==='to-order')){
      part.status='arrived';
      part.arrivedAt=Date.now();
      part.changedAt=Date.now();
      received++;
    }
    
    // If part was to-order and now has PO, mark as ordered
    if(d.po&&part.status==='to-order'){
      part.status='ordered';
      part.orderedAt=Date.now();
      part.changedAt=Date.now();
    }
  });
  
  save();render();
  $('navImportModal').classList.remove('open');
  
  let msg='Import complete: '+updated+' parts updated';
  if(received>0)msg+=', '+received+' received';
  toast(msg,'success');
};

$('expandToggle').onclick=()=>{
  const asms=getAsms();
  if(allExpanded){expanded={};allExpanded=false}
  else{asms.forEach(a=>expanded[a.id]=true);allExpanded=true}
  save();render();
};

$('clearBtn').onclick=()=>{if(confirm('Delete ALL data? This cannot be undone.')){data=[];team=[];expanded={};history=[];projectDates={start:'',end:''};actions=[];currentProjectName='New Project';projectRef.child('main').set({data,team,history,projectDates,actions,projectName:currentProjectName,updatedAt:firebase.database.ServerValue.TIMESTAMP});toast('All data cleared')}};
$('signOutBtn').onclick=()=>{if(confirm('Sign out?'))logout()};

// Header search
$('headerSearch').oninput=e=>{
  searchQ=e.target.value;
  $('headerSearchClear').classList.toggle('visible',searchQ.length>0);
  render();
};
$('headerSearchClear').onclick=()=>{
  $('headerSearch').value='';
  searchQ='';
  $('headerSearchClear').classList.remove('visible');
  render();
};

$('actionSearchBox').oninput=e=>{actionSearchQ=e.target.value;renderActions()};
$('actionAssigneeFilter').onchange=e=>{actionAssigneeFilter=e.target.value;renderActions()};
$('assigneeFilter').onchange=e=>{filterAssignee=e.target.value;render()};

document.querySelectorAll('.pipe').forEach(p=>p.onclick=()=>{filterStage=filterStage===p.dataset.s?'':p.dataset.s;document.querySelector('[data-tab="list"]').click();render()});

document.querySelectorAll('.tab').forEach(tab=>tab.onclick=()=>{
  closeAIWorkspace();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $(tab.dataset.tab+'Panel').classList.add('active');
  if(tab.dataset.tab==='gantt')setTimeout(renderGantt,10);
});

document.onkeydown=e=>{if(e.key==='Escape'){closeAIWorkspace();['teamModal','datesModal','leadtimeModal','bomModal','otdModal','itemConfigModal'].forEach(closeModal);$('themeModal').classList.remove('open');$('receivePOModal').classList.remove('open');$('reportModal').classList.remove('open');$('metricsPopover').classList.remove('open');$('poModal').classList.remove('open');$('menuDrop').classList.remove('open');$('ganttColorPopup').classList.remove('open');$('ganttDatePopup').classList.remove('open');$('etaPopover').classList.remove('open');hidePopoverModal($('partModal'));hidePopoverModal($('asmModal'));hidePopoverModal($('actionModal'));hidePopoverModal($('aiModal'));closeDeletePopover();$('commentsPopover').classList.remove('open');$('popoverBackdrop').classList.remove('active');currentCommentPartId=null;editId=editAsmId=editActId=editEtaPartId=pendingAdvPartId=null}};

// Comments on parts
let currentCommentPartId=null;

window.openComments=window.openNotesChat=function(partId,e){
  currentCommentPartId=partId;
  const part=data.find(d=>d.id===partId);
  $('commentsTitle').textContent=part?part.name.substring(0,25):'Notes';
  
  // Position near clicked element
  const popover=$('commentsPopover');
  const target=e?e.target.closest('.notes-chat-cell')||e.target.closest('button')||e.target:null;
  if(target){
    const rect=target.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left;
    if(left+320>window.innerWidth)left=window.innerWidth-330;
    if(top+400>window.innerHeight)top=rect.top-400-8;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
  }
  
  loadComments(partId);
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>$('commentInput').focus(),100);
};

function loadComments(partId){
  const part=data.find(d=>d.id===partId);
  const comments=part?.comments||[];
  if(comments.length===0){
    $('commentsList').innerHTML='<div class="comments-empty">No notes yet.<br>Add the first one below.</div>';
  }else{
    $('commentsList').innerHTML=comments.map(c=>{
      const time=new Date(c.ts||c.timestamp).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      return '<div class="comment-item"><div class="comment-author">'+esc(c.author)+'</div><div class="comment-text">'+esc(c.text)+'</div><div class="comment-time">'+time+'</div></div>';
    }).join('');
  }
}

$('commentsClose').onclick=()=>{
  $('commentsPopover').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  currentCommentPartId=null;
};

// Close comments - handled by backdrop

$('commentAdd').onclick=()=>{
  const input=$('commentInput');
  const text=input.value.trim();
  if(!text||!currentCommentPartId)return;
  
  const part=data.find(d=>d.id===currentCommentPartId);
  if(!part)return;
  
  // Get or prompt for username
  let author=localStorage.getItem('ebs-username');
  if(!author){
    author=prompt('Enter your name for comments:','');
    if(author)localStorage.setItem('ebs-username',author);
  }
  if(!author)author='Anonymous';
  
  if(!part.comments)part.comments=[];
  part.comments.push({
    author:author,
    text:text,
    ts:Date.now()
  });
  
  // Track the comment change
  updateFieldTimestamp(part,'comments');
  markPartChanged(currentCommentPartId,['comments']);
  
  // Log comment event
  logComment(part,text);
  
  save();
  loadComments(currentCommentPartId);
  input.value='';
  render(); // Update comment count
};

$('commentInput').onkeydown=e=>{if(e.key==='Enter')$('commentAdd').click()};

// ============================================
// BULK OPERATIONS
// ============================================
function updateBulkBar(){
  const bar=$('bulkBar');
  const count=selectedParts.size;
  $('bulkCount').textContent=count;
  
  if(count>0){
    bar.classList.add('active');
  }else{
    bar.classList.remove('active');
  }
}

function clearSelection(){
  selectedParts.clear();
  lastSelectedPartId=null;
  updateBulkBar();
  render();
}

window.togglePartSelection=function(partId,e){
  e.stopPropagation();
  const parts=getParts().filter(matchPart);
  
  // Shift+click for range selection
  if(e.shiftKey&&lastSelectedPartId!==null){
    const ids=parts.map(p=>p.id);
    const startIdx=ids.indexOf(lastSelectedPartId);
    const endIdx=ids.indexOf(partId);
    if(startIdx>=0&&endIdx>=0){
      const [from,to]=[Math.min(startIdx,endIdx),Math.max(startIdx,endIdx)];
      for(let i=from;i<=to;i++){
        selectedParts.add(ids[i]);
      }
    }
  }else{
    if(selectedParts.has(partId)){
      selectedParts.delete(partId);
    }else{
      selectedParts.add(partId);
    }
    lastSelectedPartId=partId;
  }
  updateBulkBar();
  render();
};

window.toggleSelectAll=function(e){
  const parts=getParts().filter(matchPart);
  if(selectedParts.size===parts.length){
    selectedParts.clear();
  }else{
    parts.forEach(p=>selectedParts.add(p.id));
  }
  updateBulkBar();
  render();
};

// Click on empty space in parts table to deselect
$('partsList').addEventListener('click',function(e){
  // If click is directly on the table body (not on a part row or its children)
  if(e.target===this||e.target.classList.contains('add-row')||e.target.classList.contains('add-row-text')){
    if(selectedParts.size>0){
      clearSelection();
    }
  }
});

// Click on table container background to deselect
$('partsTable').addEventListener('click',function(e){
  if(e.target===this){
    if(selectedParts.size>0){
      clearSelection();
    }
  }
});

// Handle clicks on row background/padding to deselect
window.handleRowClick=function(e){
  if(!selectedParts.size)return;
  // Check if click is on the row itself (padding area) or on an empty child div
  const row=e.currentTarget;
  // If clicked directly on the row (padding area)
  if(e.target===row){
    clearSelection();
    return;
  }
  // If clicked on an empty div that's a direct child of the row
  if(e.target.parentElement===row&&e.target.tagName==='DIV'){
    // Check if this div has no interactive content
    const hasContent=e.target.textContent.trim()||e.target.querySelector('input,button,span.status-badge,span.eta-po,span.eta-date,.cell,.stage-dot,.comment-btn,.adv-btn,.sm-btn');
    if(!hasContent){
      clearSelection();
      return;
    }
  }
};

// Click on partsList background (between rows) to deselect
$('partsList').addEventListener('click',function(e){
  if(!selectedParts.size)return;
  if(e.target===this){
    clearSelection();
  }
});

function positionBulkPopover(popover,btn){
  const rect=btn.getBoundingClientRect();
  let top=rect.bottom+8;
  let left=rect.left;
  if(left+320>window.innerWidth)left=window.innerWidth-330;
  if(top+300>window.innerHeight)top=rect.top-310;
  popover.style.top=Math.max(10,top)+'px';
  popover.style.left=Math.max(10,left)+'px';
}

function renderBulkPreview(containerId){
  const container=$(containerId);
  const parts=Array.from(selectedParts).map(id=>data.find(d=>d.id===id)).filter(Boolean);
  if(parts.length<=5){
    container.innerHTML=parts.map(p=>'<div style="padding:4px 0;font-size:11px;border-bottom:1px solid var(--bg4)">'+esc(p.name)+'</div>').join('');
  }else{
    container.innerHTML=parts.slice(0,3).map(p=>'<div style="padding:4px 0;font-size:11px;border-bottom:1px solid var(--bg4)">'+esc(p.name)+'</div>').join('')+'<div style="padding:4px 0;font-size:11px;color:var(--text3)">...and '+(parts.length-3)+' more</div>';
  }
}

function closeBulkPopovers(){
  ['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
}

window.openBulkStatusModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkStatusPreview');
  $('bulkStatusSelect').value='';
  $('bulkStatusPO').value='';
  $('bulkStatusETA').value='';
  $('bulkPOFields').style.display='none';
  positionBulkPopover($('bulkStatusModal'),e.target);
  $('bulkStatusModal').classList.add('open');
};

window.openBulkAssignModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkAssignPreview');
  $('bulkAssignSelect').innerHTML='<option value="">Select assignee...</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');
  positionBulkPopover($('bulkAssignModal'),e.target);
  $('bulkAssignModal').classList.add('open');
};

window.openBulkPOModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkPOPreview');
  $('bulkPOInput').value='';
  positionBulkPopover($('bulkPOModal'),e.target);
  $('bulkPOModal').classList.add('open');
  setTimeout(()=>$('bulkPOInput').focus(),100);
};

window.openBulkDeleteModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkDeletePreview');
  positionBulkPopover($('bulkDeleteModal'),e.target);
  $('bulkDeleteModal').classList.add('open');
};

window.applyBulkStatus=function(){
  const status=$('bulkStatusSelect').value;
  if(!status)return;
  const now=Date.now();
  const po=$('bulkStatusPO').value.trim();
  const eta=$('bulkStatusETA').value;
  const count=selectedParts.size;
  
  selectedParts.forEach(id=>{
    const p=data.find(d=>d.id===id);
    if(p){
      const changedFields=['status'];
      if(p.status==='ordered'&&status==='arrived'&&p.orderedAt&&p.code){
        const days=Math.round((now-p.orderedAt)/86400000);
        if(days>0)recordLeadTime(p.code,days);
        p.arrivedAt=now;
      }
      if(status==='ordered'&&p.status!=='ordered'){
        p.orderedAt=now;
        if(po){p.poNumber=po;changedFields.push('poNumber');}
        if(eta){p.expectedArrival=eta;changedFields.push('expectedArrival');}
      }
      p.status=status;
      p.changedAt=now;
      changedFields.forEach(f=>updateFieldTimestamp(p,f));
      markPartChanged(id,changedFields);
    }
  });
  save();
  $('bulkStatusModal').classList.remove('open');
  clearSelection();
  render();
  toast(count+' parts updated â†’ '+SLABELS[status]);
};

// Show/hide PO fields based on status selection
$('bulkStatusSelect').onchange=function(){
  const showPO=this.value==='ordered';
  $('bulkPOFields').style.display=showPO?'block':'none';
};

window.applyBulkAssign=function(){
  const assignee=$('bulkAssignSelect').value;
  if(!assignee)return;
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    const p=data.find(d=>d.id===id);
    if(p){
      p.assignee=assignee;
      updateFieldTimestamp(p,'assignee');
      markPartChanged(id,['assignee']);
    }
  });
  save();
  $('bulkAssignModal').classList.remove('open');
  clearSelection();
  render();
  toast(count+' parts assigned');
};

window.applyBulkPO=function(){
  const po=$('bulkPOInput').value.trim();
  if(!po)return;
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    const p=data.find(d=>d.id===id);
    if(p){
      p.poNumber=po;
      updateFieldTimestamp(p,'poNumber');
      markPartChanged(id,['poNumber']);
    }
  });
  save();
  $('bulkPOModal').classList.remove('open');
  clearSelection();
  render();
  toast(count+' parts updated');
};

window.applyBulkDelete=function(){
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    data=data.filter(d=>d.id!==id&&d.parentId!==id);
  });
  save();
  $('bulkDeleteModal').classList.remove('open');
  clearSelection();
  render();
  toast(count+' parts deleted');
};

// Close bulk popovers
['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
  $(id).querySelector('.modal-close').onclick=()=>$(id).classList.remove('open');
});

document.addEventListener('click',e=>{
  ['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
    const modal=$(id);
    if(modal.classList.contains('open')&&!modal.contains(e.target)&&!e.target.closest('.bulk-bar')){
      modal.classList.remove('open');
    }
  });
});

// Theme System
const THEMES=[
  {id:'default',name:'Claude Dark',colors:{bg:'#302e2b',bg2:'#282624',accent:'#8abadc',green:'#7fb87f',red:'#c08080'}},
  {id:'claude-light',name:'Claude Light',colors:{bg:'#ffffff',bg2:'#faf9f5',accent:'#1a66b2',green:'#1a7a1a',red:'#b04545'}}
];
let currentTheme=localStorage.getItem('ebs-theme')||'default';

function applyTheme(themeId){
  if(themeId==='default')document.documentElement.removeAttribute('data-theme');
  else document.documentElement.setAttribute('data-theme',themeId);
  currentTheme=themeId;
  localStorage.setItem('ebs-theme',themeId);
  renderThemeGrid();
}

function renderThemeGrid(){
  const grid=$('themeGrid');
  const lightThemes=['claude-light'];
  grid.innerHTML=THEMES.map(t=>{
    const isActive=t.id===currentTheme;
    const isLight=lightThemes.includes(t.id);
    return '<div class="theme-card'+(isActive?' active':'')+'" data-theme-id="'+t.id+'" style="background:'+t.colors.bg+';color:'+(isLight?'#2d2d2d':'#e8e8ec')+'"><div class="theme-name">'+t.name+'</div><div class="theme-preview"><span style="background:'+t.colors.bg2+'"></span><span style="background:'+t.colors.accent+'"></span><span style="background:'+t.colors.green+'"></span><span style="background:'+t.colors.red+'"></span></div></div>';
  }).join('');
  grid.querySelectorAll('.theme-card').forEach(card=>{
    card.onclick=()=>applyTheme(card.dataset.themeId);
  });
}

$('themeBtn').onclick=(e)=>{
  renderThemeGrid();
  const popover=$('themeModal');
  const btn=e.target.closest('button');
  const rect=btn.getBoundingClientRect();
  popover.style.top=(rect.bottom+8)+'px';
  popover.style.left=Math.max(10,rect.right-280)+'px';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
};
$('themeClose').onclick=()=>{$('themeModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
document.addEventListener('click',e=>{
  const popover=$('themeModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#themeBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});

// Item Code Configuration
function renderItemConfigList(){
  const codes=Object.keys(itemCodeConfig).sort();
  if(codes.length===0){
    $('icList').innerHTML='<div class="item-config-empty">No item codes configured yet.<br>Add configurations above to customize phase requirements.</div>';
    return;
  }
  let html='<div class="item-config-row header"><div>Item Code</div><div>Phases</div><div></div></div>';
  codes.forEach(code=>{
    const cfg=itemCodeConfig[code];
    let badges='';
    badges+=cfg.requiresConfig?'<span class="item-config-badge active">Config'+(cfg.configuredBy?' ('+esc(cfg.configuredBy)+')':'')+'</span>':'<span class="item-config-badge skip">Config</span>';
    badges+=cfg.requiresTesting?'<span class="item-config-badge active">Test'+(cfg.tester?' ('+esc(cfg.tester)+')':'')+'</span>':'<span class="item-config-badge skip">Test</span>';
    html+='<div class="item-config-row"><div class="item-config-code">'+esc(code)+'</div><div class="item-config-badges">'+badges+'</div><div class="item-config-actions"><button onclick="window.editItemConfig(\''+esc(code)+'\')">Edit</button><button onclick="window.deleteItemConfig(\''+esc(code)+'\')">Ã—</button></div></div>';
  });
  $('icList').innerHTML=html;
}

function updateItemConfigSelects(){
  const teamOpts='<option value="">Anyone</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');
  $('icConfigBy').innerHTML=teamOpts;
  $('icTestBy').innerHTML=teamOpts;
}

function clearItemConfigForm(){
  $('icCode').value='';
  $('icReqConfig').checked=false;
  $('icReqTest').checked=true;
  $('icConfigBy').value='';
  $('icTestBy').value='';
}

window.editItemConfig=function(code){
  const cfg=itemCodeConfig[code]||{};
  $('icCode').value=code;
  $('icReqConfig').checked=cfg.requiresConfig||false;
  $('icReqTest').checked=cfg.requiresTesting!==false;
  $('icConfigBy').value=cfg.configuredBy||'';
  $('icTestBy').value=cfg.tester||'';
};

window.deleteItemConfig=function(code){
  if(!confirm('Remove configuration for "'+code+'"?'))return;
  delete itemCodeConfig[code];
  saveItemCodeConfig();
  renderItemConfigList();
  render();
  toast('Removed');
};

$('itemConfigBtn').onclick=()=>{
  updateItemConfigSelects();
  renderItemConfigList();
  clearItemConfigForm();
  $('itemConfigModal').classList.add('open');
};

$('icClose').onclick=$('icDone').onclick=()=>closeModal('itemConfigModal');
$('itemConfigModal').onclick=e=>{if(e.target.id==='itemConfigModal')closeModal('itemConfigModal')};

$('icSave').onclick=()=>{
  const code=$('icCode').value.trim().toUpperCase();
  if(!code){toast('Enter item code',1);return}
  itemCodeConfig[code]={
    requiresConfig:$('icReqConfig').checked,
    configuredBy:$('icConfigBy').value,
    requiresTesting:$('icReqTest').checked,
    tester:$('icTestBy').value
  };
  saveItemCodeConfig();
  renderItemConfigList();
  clearItemConfigForm();
  render();
  toast('Saved: '+code);
};

$('icClear').onclick=clearItemConfigForm;

$('icExport').onclick=()=>{
  const json=JSON.stringify(itemCodeConfig,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='item-code-config.json';a.click();
  URL.revokeObjectURL(url);
  toast('Exported');
};

// Bulk operations button handlers
$('bulkStatusBtn').onclick=window.openBulkStatusModal;
$('bulkAssignBtn').onclick=window.openBulkAssignModal;
$('bulkPOBtn').onclick=window.openBulkPOModal;
$('bulkDeleteBtn').onclick=window.openBulkDeleteModal;
$('bulkClearBtn').onclick=clearSelection;
$('selectAllParts').onclick=window.toggleSelectAll;
$('bulkStatusApply').onclick=window.applyBulkStatus;
$('bulkAssignApply').onclick=window.applyBulkAssign;
$('bulkPOApply').onclick=window.applyBulkPO;
$('bulkDeleteApply').onclick=window.applyBulkDelete;
$('bulkStatusCancel').onclick=()=>$('bulkStatusModal').classList.remove('open');
$('bulkAssignCancel').onclick=()=>$('bulkAssignModal').classList.remove('open');
$('bulkPOCancel').onclick=()=>$('bulkPOModal').classList.remove('open');
$('bulkDeleteCancel').onclick=()=>$('bulkDeleteModal').classList.remove('open');

// Initialize
applyTheme(currentTheme);
loadExpanded();
loadItemCodeConfig();

// Check if already authenticated
if(checkAuth()){
  isAuthenticated=true;
  $('loginScreen').style.display='none';
  initFirebaseListeners();
}

})();
</script>
</body>
</html>
