<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>EBS v3 - Cloud</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<!-- DOMPurify for HTML sanitization -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" integrity="sha512-H+rglffZ6f5gF7UJgvH4Naa+fGCgjrHKMgoFOGmcPTRwR6oILo5R+gtzNrpDp7iMV3udbymBVjkeZGNz1Em4rQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- SheetJS for Excel import -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#2f2f2d;--bg2:#252523;--bg3:#1f1e1d;--bg4:#131312;--border:rgba(221,220,208,0.08);--border-strong:rgba(221,220,208,0.12);--text:#faf9f5;--text2:#c1bfb5;--text3:#9b9991;--text-muted:#9b9991;--accent:#5a9ac8;--accent-hover:#6aa8d4;--accent-main:#d87756;--selection:rgba(90,154,200,0.12);--green:#6aaa6a;--yellow:#b8a050;--orange:#d87756;--red:#c07070;--cyan:#6aa0aa;--purple:#9888aa;--blue:#5a9ac8;--s0:#8a8a82;--s1:#c07070;--s2:#d87756;--s3:#b8a050;--s4:#6aa0aa;--s5:#9888aa;--s6:#6aaa6a;--checkbox:#5a9ac8;--btn-primary-bg:#faf9f5;--btn-primary-text:#2f2f2d;--shadow:0 4px 12px rgba(0,0,0,0.15)}
[data-theme="claude-light"]{--bg:#ffffff;--bg2:#faf9f5;--bg3:#f4f4ec;--bg4:#e7e5db;--border:rgba(31,30,29,0.06);--border-strong:rgba(31,30,29,0.10);--text:#131312;--text2:#3c3c39;--text3:#72716b;--text-muted:#72716b;--accent:#1a66b2;--green:#1a7a1a;--yellow:#8a6a20;--orange:#c6603f;--red:#b04545;--cyan:#1a7a90;--purple:#6a4a9a;--blue:#1a66b2;--s0:#6a6a62;--s1:#b04545;--s2:#c6603f;--s3:#8a6a20;--s4:#1a7a90;--s5:#6a4a9a;--s6:#1a7a1a;--accent-main:#c6603f;--checkbox:#1a66b2;--btn-primary-bg:#131312;--btn-primary-text:#faf9f5;--shadow:0 4px 12px rgba(0,0,0,0.06)}
.theme-popover{width:240px}
.theme-popover .modal-body{padding:16px}
.theme-grid{display:flex;flex-direction:column;gap:6px}
.theme-card{padding:14px 16px;border-radius:12px;cursor:pointer;border:2px solid transparent;background:var(--bg3);transition:all .2s cubic-bezier(0.4,0,0.2,1);position:relative}
.theme-card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
.theme-card.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(138,186,220,.2)}
.theme-card.active::after{content:'âœ“';position:absolute;top:12px;right:14px;font-size:13px;font-weight:600;color:var(--accent)}
.theme-name{font-size:12px;font-weight:600;margin-bottom:8px}
.theme-preview{display:flex;gap:4px;height:24px;border-radius:6px;overflow:hidden}
.theme-preview span{flex:1;border-radius:4px}
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:var(--text-muted) transparent}
*::-webkit-scrollbar{width:8px;height:8px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:var(--text-muted);border-radius:4px;border:2px solid var(--bg)}
*::-webkit-scrollbar-thumb:hover{background:var(--text3)}
html,body{height:100%;overflow:hidden;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);font-size:14px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;line-height:1.5}
.header{background:var(--bg);border-bottom:1px solid var(--border);padding:0 56px 0 16px;display:flex;align-items:center;position:fixed;top:0;left:0;right:0;z-index:100;height:50px;gap:8px}
.logo{font-weight:500;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px;letter-spacing:-0.2px;flex-shrink:0;cursor:pointer;padding:6px 10px;border-radius:8px;margin:-6px 0 -6px -10px;transition:all .15s ease}
.logo:hover{background:var(--bg2);color:var(--accent)}
.project-selector{display:flex;align-items:center;gap:2px;flex-shrink:0;position:relative}
.project-selector-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text3);cursor:pointer;transition:all .15s}
.project-selector-btn:hover{background:var(--bg2);border-color:var(--border);color:var(--text)}
.project-selector-btn svg{width:14px;height:14px}
.master-schedule-link{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;cursor:pointer;transition:all .15s ease;margin-left:4px}
.master-schedule-link:hover{background:var(--bg2)}
.master-schedule-link:hover .master-schedule-label{color:var(--text)}
.master-schedule-link:hover .project-selector-btn{color:var(--text);background:transparent;border-color:transparent}
.master-schedule-link .project-selector-btn{margin:0;pointer-events:none;width:20px;height:20px}
.master-schedule-link .project-selector-btn svg{width:13px;height:13px}
.master-schedule-label{font-size:12px;color:var(--text3);font-weight:400;letter-spacing:-0.1px;transition:color .15s}
.project-dropdown{position:absolute;top:100%;left:0;margin-top:6px;min-width:280px;max-width:360px;background:var(--bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.15);z-index:1000;display:none;overflow:hidden}
.project-dropdown.open{display:block}
.project-dropdown-header{padding:10px 14px;font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border)}
.project-dropdown-list{max-height:320px;overflow-y:auto}
.project-dropdown-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--border)}
.project-dropdown-item:last-child{border-bottom:none}
.project-dropdown-item:hover{background:var(--bg2)}
.project-dropdown-item.active{background:var(--bg3)}
.project-dropdown-item-name{flex:1;font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.project-dropdown-item-check{width:16px;color:var(--accent);font-size:14px}
.project-dropdown-item-archived{font-size:10px;color:var(--text3);background:var(--bg3);padding:2px 6px;border-radius:4px}
.project-dropdown-footer{padding:8px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:4px}
.project-dropdown-action{display:flex;align-items:center;gap:8px;padding:8px 10px;font-size:12px;color:var(--text2);cursor:pointer;border-radius:6px;transition:all .1s}
.project-dropdown-action:hover{background:var(--bg2);color:var(--text)}
.project-dropdown-action svg{width:14px;height:14px;opacity:0.7}
.project-dropdown-master{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--border)}
.project-dropdown-master:hover{background:var(--bg2)}
.project-dropdown-master.active{background:var(--accent);color:white}
.project-dropdown-master.active .project-dropdown-master-icon{color:white}
.project-dropdown-master-icon{width:16px;height:16px;color:var(--text);flex-shrink:0;opacity:0.9}
.project-dropdown-master-label{font-size:13px;font-weight:500;flex:1}
.master-toolbar-title.clickable{cursor:pointer;padding:6px 10px;margin:-6px -10px;border-radius:8px;transition:all .15s ease}
.master-toolbar-title.clickable:hover{background:var(--bg2);color:var(--accent)}
.manage-project-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border)}
.manage-project-item:last-child{border-bottom:none}
.manage-project-item-name{flex:1;font-size:13px;color:var(--text);font-weight:500}
.manage-project-item-date{font-size:11px;color:var(--text3)}
.manage-project-item-archived{font-size:10px;color:var(--text3);background:var(--bg3);padding:2px 6px;border-radius:4px;margin-left:8px}
.manage-project-item-actions{display:flex;gap:4px}
.manage-project-item-actions button{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text3);cursor:pointer;transition:all .15s;font-size:12px}
.manage-project-item-actions button:hover{background:var(--bg2);border-color:var(--border);color:var(--text)}
.manage-project-item-actions button.danger:hover{color:var(--red);border-color:var(--red)}
.template-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
.template-item:last-child{border-bottom:none}
.template-item-info{flex:1;min-width:0}
.template-item-name{font-size:13px;color:var(--text);font-weight:500}
.template-item-desc{font-size:11px;color:var(--text3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.template-item-meta{font-size:10px;color:var(--text3);margin-top:4px}
.template-item-actions{display:flex;gap:4px}
.template-item-actions button{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text3);cursor:pointer;transition:all .15s;font-size:12px}
.template-item-actions button:hover{background:var(--bg2);border-color:var(--border);color:var(--text)}
.template-item-actions button.danger:hover{color:var(--red);border-color:var(--red)}
.master-schedule-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:500;display:none;flex-direction:column}
.master-schedule-overlay.open{display:flex}
.master-schedule-container{display:flex;flex-direction:column;flex:1;min-height:0}
.master-toolbar{display:flex;align-items:center;padding:0 56px 0 16px;height:50px;border-bottom:1px solid var(--border);background:var(--bg);gap:8px}
.master-toolbar-title{font-weight:500;font-size:14px;color:var(--text);letter-spacing:-0.2px;white-space:nowrap}
.master-toolbar-actions{display:flex;align-items:center;gap:6px}
.master-toolbar-btn{display:flex;align-items:center;gap:5px;padding:6px 10px;background:transparent;border:none;border-radius:6px;color:var(--text2);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap}
.master-toolbar-btn:hover{background:var(--bg2);color:var(--text)}
.master-toolbar-btn svg{width:14px;height:14px;opacity:0.7}
.master-toolbar-toggle{display:flex;align-items:center;gap:5px;padding:6px 10px;background:transparent;border:none;border-radius:6px;color:var(--text3);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap}
.master-toolbar-toggle:hover{background:var(--bg2);color:var(--text2)}
.master-toolbar-toggle input{accent-color:var(--accent)}
.master-toolbar-toggle.active{color:var(--text)}
.master-toolbar-sep{width:1px;height:20px;background:var(--border);margin:0 6px}
.master-schedule-close{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:6px;color:var(--text3);cursor:pointer;font-size:16px;transition:all .15s;margin-left:6px}
.master-schedule-close:hover{background:var(--bg2);color:var(--text)}
.master-header-row{display:flex;border-bottom:1px solid var(--border);background:var(--bg)}
.master-sidebar-header{width:390px;min-width:390px;flex-shrink:0;display:grid;grid-template-columns:1fr 70px 55px 55px 40px;font-size:10px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px;border-right:1px solid var(--border);background:var(--bg);align-items:end}
.master-sidebar-header>div{padding:11px 9px}
.master-col-name{padding-left:18px!important}
.master-timeline-header-wrap{flex:1;overflow:scroll;cursor:grab;-ms-overflow-style:none;scrollbar-width:none}
.master-timeline-header-wrap::-webkit-scrollbar{display:none}
.master-timeline-header-wrap.grabbing{cursor:grabbing}
.master-timeline-header{display:flex;flex-direction:column}
.master-year-row{display:flex;border-bottom:1px solid var(--border)}
.master-year-cell{font-size:11px;font-weight:600;color:var(--text);padding:5px 8px;background:var(--bg2);border-right:1px solid var(--border);white-space:nowrap;overflow:hidden}
.master-month-row{display:flex;border-bottom:1px solid var(--border)}
.master-month-cell{font-size:9px;font-weight:500;color:var(--text3);padding:4px 6px;background:var(--bg);border-right:1px solid var(--border);white-space:nowrap;overflow:hidden;text-transform:uppercase;letter-spacing:0.3px}
.master-weeks-row{display:flex}
.master-timeline-week{min-width:28px;width:28px;padding:4px 0;text-align:center;font-size:9px;color:var(--text3);border-right:1px solid rgba(0,0,0,0.06)}
.master-timeline-week.today{background:rgba(199,89,89,0.12);color:#c75959;font-weight:600}
.master-timeline-week.month-start{border-left:1px solid var(--border)}
.master-body-row{display:flex;flex:1;min-height:0;overflow:hidden}
.master-sidebar-body{width:390px;min-width:390px;flex-shrink:0;border-right:1px solid var(--border);background:var(--bg);overflow-y:auto;box-shadow:2px 0 8px rgba(0,0,0,0.08);z-index:10}
.master-body-wrap{flex:1;overflow:auto;cursor:grab;position:relative;-ms-overflow-style:none;scrollbar-width:none}
.master-body-wrap::-webkit-scrollbar{display:none}
.master-body-wrap.grabbing{cursor:grabbing}
.master-sidebar-row{display:grid;grid-template-columns:1fr 70px 55px 55px 40px;border-bottom:1px solid var(--border);min-height:43px;align-items:center;font-size:13px;color:var(--text)}
.master-sidebar-row:hover{background:var(--bg2)}
.master-sidebar-row>div{padding:11px 9px}
.master-sidebar-row .master-col-name{font-weight:500;cursor:pointer;padding-left:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}
.master-sidebar-row .master-col-name:hover{color:var(--accent)}
.master-sidebar-row .master-col-follows{font-size:11px;color:var(--text3)}
.master-follows-select{background:var(--bg3);border:1px solid var(--border);font-size:10px;color:var(--text);cursor:pointer;padding:3px 4px;border-radius:4px;max-width:62px}
.master-follows-select:hover{background:var(--bg4);border-color:var(--accent)}
.master-follows-select:focus{outline:none;border-color:var(--accent)}
.master-sidebar-row .master-col-start,.master-sidebar-row .master-col-end{font-size:11px;color:var(--text3)}
.master-sidebar-row .master-col-dur{font-size:11px;color:var(--text3);text-align:center}
.master-sidebar-row.highlight{background:rgba(138,180,220,0.12)!important}
.master-timeline-body{position:relative}
.master-timeline-row{display:flex;border-bottom:1px solid var(--border);min-height:43px;position:relative}
.master-timeline-cell{min-width:28px;width:28px;border-right:1px solid rgba(0,0,0,0.04)}
.master-timeline-cell.month-start{border-left:1px solid var(--border)}
.master-timeline-cell.today{background:rgba(199,89,89,0.06)}
.master-bar-container{position:absolute;top:0;bottom:0;display:flex;align-items:center}
.master-bar{height:20px;border-radius:4px;font-size:10px;font-weight:500;color:#fff;display:flex;align-items:center;padding:0 7px;cursor:grab;transition:opacity 0.15s,box-shadow 0.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.master-bar:hover{box-shadow:0 2px 8px rgba(0,0,0,0.15);filter:brightness(1.05)}
.master-bar:active{cursor:grabbing}
.master-bar.archived{background:var(--text3)!important;opacity:0.5}
.master-bar-resize{position:absolute;top:-2px;bottom:-2px;width:9px;cursor:ew-resize;z-index:5;opacity:0;transition:opacity .15s}
.master-bar:hover .master-bar-resize{opacity:1}
.master-bar-resize-left{left:-2px;border-radius:4px 0 0 4px}
.master-bar-resize-right{right:-2px;border-radius:0 4px 4px 0}
.master-bar-resize:hover{background:rgba(255,255,255,0.3)}
.master-today-line{position:absolute;top:0;bottom:0;width:2px;background:#c75959;z-index:15;pointer-events:none}
.master-schedule-empty{text-align:center;padding:54px 18px;color:var(--text3)}
.master-dependency-layer{position:absolute;top:0;left:0;pointer-events:none;overflow:visible}
.master-dependency-line{fill:none;stroke:#888;stroke-width:1.5;opacity:0.6}
.master-dependency-arrow{fill:#888;opacity:0.6}
.master-team-section{border-top:2px solid var(--border);background:var(--bg)}
.master-team-header-row{display:flex;border-bottom:1px solid var(--border);background:var(--bg)}
.master-team-sidebar-header{width:390px;min-width:390px;flex-shrink:0;display:grid;grid-template-columns:1fr 55px 55px 40px;font-size:10px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px;border-right:1px solid var(--border);background:var(--bg2)}
.master-team-sidebar-header>div{padding:11px 9px}
.master-team-sidebar-header .master-col-name{padding-left:18px!important}
.master-team-header{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.3px;color:var(--text3);padding:13px 18px;display:flex;align-items:center;gap:9px;background:var(--bg2)}
.master-team-header::before{content:'ðŸ‘¤'}
.master-team-body{overflow:auto;cursor:grab;-ms-overflow-style:none;scrollbar-width:none}
.master-team-body::-webkit-scrollbar{display:none}
.master-team-body.grabbing{cursor:grabbing}
.master-team-inner{display:flex;flex-direction:column;min-width:max-content;position:relative}
.master-team-row{display:flex;min-height:43px;position:relative}
.master-team-sidebar{width:390px;min-width:390px;flex-shrink:0;border-right:1px solid var(--border);background:var(--bg);position:sticky;left:0;z-index:10;display:grid;grid-template-columns:1fr 55px 55px 40px;align-items:center;border-bottom:1px solid var(--border);box-shadow:2px 0 8px rgba(0,0,0,0.08)}
.master-team-sidebar>div{padding:9px}
.master-team-sidebar .master-col-name{padding-left:18px;display:flex;flex-direction:column;gap:2px}
.master-team-name{font-size:13px;font-weight:500;color:var(--text)}
.master-team-meta{font-size:11px;color:var(--text3)}
.master-team-meta.has-conflict{color:#c75959;font-weight:500}
.master-team-sidebar .master-col-start,.master-team-sidebar .master-col-end{font-size:11px;color:var(--text3)}
.master-team-sidebar .master-col-dur{font-size:11px;color:var(--text3);text-align:center}
.master-team-timeline{flex:1;position:relative;border-bottom:1px solid var(--border);min-height:43px;overflow:hidden}
.master-timeline-bar{position:absolute;height:20px;border-radius:4px;cursor:pointer;display:flex;align-items:center;padding:0 7px;font-size:10px;color:#fff;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:filter .15s;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.master-timeline-bar:hover{filter:brightness(1.1)}
.master-timeline-bar.site-trip{background:#5b8fb9;opacity:0.9;cursor:grab}
.master-timeline-bar.site-trip:hover{opacity:1}
.master-timeline-bar.site-trip:active{cursor:grabbing}
.master-timeline-bar.conflict{background:#c75959;animation:conflict-pulse 1.5s ease-in-out infinite}
@keyframes conflict-pulse{0%,100%{opacity:0.85}50%{opacity:1}}
.master-trip-bar-resize{position:absolute;top:-2px;bottom:-2px;width:9px;cursor:ew-resize;z-index:5;opacity:0;transition:opacity .15s}
.master-timeline-bar:hover .master-trip-bar-resize{opacity:1}
.master-trip-bar-resize-left{left:-2px;border-radius:4px 0 0 4px}
.master-trip-bar-resize-right{right:-2px;border-radius:0 4px 4px 0}
.master-trip-bar-resize:hover{background:rgba(255,255,255,0.3)}
.site-trip-modal-list{max-height:300px;overflow-y:auto;margin:12px 0;border:1px solid var(--border);border-radius:8px}
.site-trip-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid var(--border)}
.site-trip-item:last-child{border-bottom:none}
.site-trip-item:hover{background:var(--bg2)}
.site-trip-item-info{flex:1}
.site-trip-item-site{font-size:13px;font-weight:500;color:var(--text)}
.site-trip-item-dates{font-size:11px;color:var(--text3)}
.site-trip-item-delete{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;color:var(--text3);cursor:pointer;border-radius:4px;transition:all .1s}
.site-trip-item-delete:hover{background:#c75959;color:white}
.master-legend{display:flex;gap:22px;padding:13px 25px;border-top:1px solid var(--border);background:var(--bg)}
.master-legend-item{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--text3)}
.master-legend-color{width:14px;height:14px;border-radius:4px}
.master-bar-progress{position:absolute;right:0;top:0;bottom:0;background:#9a9a9a;border-radius:4px;pointer-events:none}
.header-search{position:relative;width:140px;flex-shrink:0}
.header-search input{width:100%;height:32px;padding:0 32px 0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:16px;transition:all .2s}
.header-search input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,0.08)}
.header-search input::placeholder{color:var(--text-muted)}
.header-search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;background:var(--bg3);border:none;border-radius:50%;color:var(--text3);font-size:9px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:all .15s}
.header-search-clear.visible{display:flex}
.header-search-clear:hover{background:var(--text3);color:var(--bg)}
.ai-console-btn,#insightsAIBtn{display:flex;align-items:center;justify-content:center;padding:4px;background:transparent;border:none;border-radius:8px;cursor:pointer;transition:all .15s;flex-shrink:0;outline:none!important;outline-style:none!important;outline-width:0!important;outline-color:transparent!important;-webkit-tap-highlight-color:transparent;-webkit-appearance:none;-webkit-touch-callout:none;user-select:none;box-shadow:none!important}
.ai-console-btn:focus,.ai-console-btn:focus-visible,.ai-console-btn:active,.ai-console-btn:focus-within,#insightsAIBtn:focus,#insightsAIBtn:focus-visible,#insightsAIBtn:active{outline:none!important;outline-style:none!important;outline-width:0!important;box-shadow:none!important;border:none!important}
.ai-console-btn *,#insightsAIBtn *{outline:none!important}
.ai-console-btn:hover{background:var(--bg2)}
.ai-console-btn.active{background:var(--accent-main);color:white}
.ai-console-btn.active .ai-console-icon{background:rgba(255,255,255,0.2)}
.ai-console-btn.active .ai-console-plus{transform:rotate(45deg)}
.ai-console-btn.spinning .ai-console-plus{animation:icon-spin 1s linear infinite}
@keyframes icon-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.ai-console-icon{width:24px;height:24px;border-radius:50%;background:var(--accent-main);display:flex;align-items:center;justify-content:center;transition:all .3s}
.ai-console-plus{width:14px;height:14px;position:relative;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1)}
.ai-console-plus::before,.ai-console-plus::after{content:'';position:absolute;background:white;border-radius:2px;top:50%;left:50%;transform:translate(-50%,-50%)}
.ai-console-plus::before{width:14px;height:2px}
.ai-console-plus::after{width:2px;height:14px}
@keyframes dot-pulse{0%,100%{opacity:0.75;transform:translate(-50%,-50%) scale(0.92)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}}
.header-spacer{flex:1}
.header-metrics{display:flex;align-items:center;gap:8px;cursor:pointer;border-radius:10px;padding:2px;margin:-2px;margin-right:48px;transition:background .15s}
.header-metrics:hover{background:var(--bg2)}
.hm{display:flex;align-items:center;gap:8px;padding:5px 10px;background:var(--bg2);border-radius:8px;border:1px solid var(--border)}
.hm-label{font-size:9px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px}
.hm-value{font-size:13px;font-weight:500;color:var(--text2)}
.hm-progress{min-width:130px}
.hm-bar{width:60px;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
.hm-bar-fill{height:100%;border-radius:2px;background:#7aaa7a;transition:width .4s ease}
.header-btns{position:fixed;top:8px;right:16px;z-index:101;display:flex;gap:4px;align-items:center}
.header-btns .btn{background:transparent;border:none;color:var(--text2);height:36px;padding:0 10px;font-size:13px}
.header-btns .btn:hover{background:var(--bg3);color:var(--text)}
.version-badge{font-size:10px;color:var(--text-muted);padding:6px 10px;font-family:ui-monospace,monospace;cursor:pointer;position:relative;border-radius:4px;transition:all .15s}
.version-badge:hover{color:var(--text3);background:var(--bg2)}
.version-info{position:fixed;background:var(--bg3);border:1px solid var(--border-strong);border-radius:8px;padding:12px;font-size:11px;color:var(--text2);opacity:0;visibility:hidden;transform:translateY(4px);transition:all .15s;box-shadow:var(--shadow);z-index:1000;width:240px;font-family:system-ui,-apple-system,sans-serif;pointer-events:none}
.version-info.open{opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto}
.version-info-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;gap:12px}
.version-info-label{color:var(--text-muted);font-size:11px;flex-shrink:0}
.version-info-value{color:var(--text);font-weight:500;font-size:11px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px}
.version-info-divider{height:1px;background:var(--border);margin:8px 0}
.btn{height:34px;padding:0 12px;font-size:12px;font-weight:500;color:var(--text2);background:transparent;border:1px solid var(--border);border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all .15s}
.btn:hover{background:var(--bg2);color:var(--text);border-color:var(--border-strong)}
.btn:active{transform:scale(0.98)}
.btn-primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);border-color:transparent}
.btn-primary:hover{opacity:0.9}
.btn-report{gap:8px}
.btn-receive{gap:8px}
.po-details-actions .btn-receive{background:rgba(127,184,127,0.08);color:var(--green);border:1px solid rgba(127,184,127,0.2)}
.po-details-actions .btn-receive:hover{background:rgba(127,184,127,0.15)}
.btn-save{background:transparent;color:var(--text2)}
.btn-save:hover{background:var(--bg2)}
.btn-danger{background:rgba(192,128,128,0.06);color:var(--red);border-color:transparent}
.btn-danger:hover{background:rgba(192,128,128,0.12)}
.po-popover{width:320px}
.receive-po-popover{width:360px}
.receive-po-preview{margin-top:14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;max-height:220px;overflow-y:auto}
.receive-po-empty{padding:20px;text-align:center;color:var(--text3);font-size:12px}
.receive-po-list{padding:6px 0}
.receive-po-item{display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border)}
.receive-po-item:last-child{border-bottom:none}
.receive-po-item-name{flex:1;font-size:13px;font-weight:500}
.receive-po-item-status{font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg3);color:var(--text2);font-weight:550}
.receive-po-item-status.ordered{background:#3b3000;color:#fbbf24}
.receive-po-item-status.arrived{background:#1a3a2f;color:#6ee7b7}
.receive-po-count{padding:12px 14px;background:var(--bg3);border-radius:10px 10px 0 0;font-size:13px;font-weight:600;color:var(--text2)}
.receive-po-count span{color:var(--accent)}
.po-note{font-size:11px;color:var(--text3);margin-top:6px;font-style:italic}
.delete-modal{max-width:320px}
.notes-cell{font-size:11px;color:var(--text3);font-style:italic;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.eta-cell{display:flex;flex-direction:column;gap:2px;font-size:11px}
.eta-date{cursor:pointer}
.eta-date.historical{color:var(--text3)}
.eta-date.user-set{color:var(--green)}
.eta-po{font-size:10px;color:var(--accent);cursor:pointer;font-weight:500}
.eta-po:hover{text-decoration:underline}
.eta-po.active{background:var(--accent);color:#fff;padding:2px 6px;border-radius:3px}
.autocomplete-wrapper{position:relative;width:100%}
.autocomplete-wrapper input{width:100%;height:26px;padding:2px 8px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--accent);border-radius:4px;outline:none}
.autocomplete-list{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:8px;max-height:180px;overflow-y:auto;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.5);display:none}
.autocomplete-list.open{display:block}
.autocomplete-item{padding:8px 12px;font-size:13px;cursor:pointer;color:var(--text)}
.autocomplete-item:hover,.autocomplete-item.selected{background:var(--bg4)}
.autocomplete-item em{color:var(--accent);font-style:normal;font-weight:600}
.main{padding-top:50px;height:100vh;display:flex;overflow:hidden}
.sidebar{width:200px;min-width:200px;background:var(--bg);border-right:1px solid var(--border);padding:20px 16px;display:flex;flex-direction:column;gap:24px;overflow-y:auto;position:relative;z-index:15;transition:width .2s ease,min-width .2s ease,padding .2s ease}
.sidebar.collapsed{width:56px;min-width:56px;padding:20px 8px;gap:16px}
.sidebar-top{display:flex;justify-content:flex-end;margin-bottom:-8px}
.sidebar-toggle{display:flex;align-items:center;justify-content:center;gap:6px;padding:5px 10px;background:transparent;border:1px solid var(--border);border-radius:6px;cursor:pointer;color:var(--text2);font-size:10px;font-weight:500;transition:all .15s}
.sidebar-toggle:hover{background:var(--bg2);border-color:var(--text3);color:var(--text)}
.sidebar-toggle svg{width:14px;height:14px;flex-shrink:0;stroke:currentColor}
.sidebar.collapsed .sidebar-top{justify-content:center;margin-bottom:0}
.sidebar.collapsed .sidebar-toggle{padding:6px}
.sidebar.collapsed .sidebar-toggle svg{transform:scaleX(-1)}
.sidebar.collapsed .sidebar-toggle span{display:none}
.sidebar-label{font-size:11px;font-weight:500;color:var(--text-muted);letter-spacing:0.3px;margin-bottom:12px;padding:0 12px;text-transform:uppercase;transition:opacity .2s;white-space:nowrap}
.sidebar.collapsed .sidebar-label{opacity:0;height:0;margin:0;overflow:hidden}
.content{flex:1;padding:12px 16px;display:flex;flex-direction:column;overflow:hidden;position:relative}
.content:has(.ai-workspace.active){padding:0}
.pipeline{display:flex;flex-direction:column;gap:6px}
.pipe{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .15s;background:transparent;border:none;text-align:left}
.pipe:hover{background:var(--bg2)}.pipe.active{background:var(--bg2)}
.pipe-label{font-size:12px;color:var(--text2);width:76px;flex-shrink:0}
.pipe-bar{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;min-width:40px}
.pipe-bar-fill{height:100%;border-radius:2px;transition:width 0.3s ease}
.pipe[data-s="waiting"] .pipe-bar-fill{background:var(--s0)}
.pipe[data-s="to-order"] .pipe-bar-fill{background:var(--s1)}
.pipe[data-s="ordered"] .pipe-bar-fill{background:var(--s2)}
.pipe[data-s="arrived"] .pipe-bar-fill{background:var(--s3)}
.pipe[data-s="tested"] .pipe-bar-fill{background:var(--s4)}
.pipe[data-s="configured"] .pipe-bar-fill{background:var(--s5)}
.pipe[data-s="installed"] .pipe-bar-fill{background:var(--s6)}
.pipe-count{font-size:12px;font-weight:600;color:var(--text);width:28px;text-align:right;font-variant-numeric:tabular-nums}
.tabs{display:flex;flex-direction:column;gap:4px}
.tab{height:44px;padding:0 12px;display:flex;align-items:center;gap:14px;font-size:14px;font-weight:400;color:var(--text3);background:transparent;border:none;border-radius:10px;cursor:pointer;transition:all .15s;text-align:left}
.tab-icon{width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:17px;color:var(--text2)}
.tab:hover{color:var(--text);background:var(--bg2)}
.tab:hover .tab-icon{color:var(--text)}
.tab.active{color:var(--text);background:var(--bg2)}
.tab.active .tab-icon{color:var(--text)}
.tab.active::after{display:none}
/* Collapsed sidebar states */
.sidebar.collapsed .tabs{align-items:center}
.sidebar.collapsed .tab{padding:0;justify-content:center;height:40px;width:40px}
.sidebar.collapsed .tab>span:not(.tab-icon){display:none}
.sidebar.collapsed .tab-icon{margin:0}
.sidebar.collapsed .pipe{padding:8px;justify-content:center}
.sidebar.collapsed .pipe-count{min-width:auto;font-size:11px;width:auto}
.sidebar.collapsed .pipe[data-s="waiting"] .pipe-count{color:var(--s0)}
.sidebar.collapsed .pipe[data-s="to-order"] .pipe-count{color:var(--s1)}
.sidebar.collapsed .pipe[data-s="ordered"] .pipe-count{color:var(--s2)}
.sidebar.collapsed .pipe[data-s="arrived"] .pipe-count{color:var(--s3)}
.sidebar.collapsed .pipe[data-s="tested"] .pipe-count{color:var(--s4)}
.sidebar.collapsed .pipe[data-s="configured"] .pipe-count{color:var(--s5)}
.sidebar.collapsed .pipe[data-s="installed"] .pipe-count{color:var(--s6)}
.sidebar.collapsed .pipe-label{display:none}
.sidebar.collapsed .pipe-bar{display:none}
.sidebar.collapsed .activity-log{display:none}
.sidebar.collapsed .activity-view-all{display:none}
.sidebar.collapsed .sidebar-section{padding:0}
.sidebar.collapsed .cmd-minimized{padding:8px;justify-content:center}
.sidebar.collapsed .cmd-minimized-title{display:none}
.sidebar.collapsed .version-badge{font-size:9px;padding:4px}
.sidebar.collapsed .version-info{display:none}
.toolbar{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-shrink:0}
.search{flex:1;height:34px;padding:0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:8px;transition:all .2s}
.search:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,0.08)}
.search::placeholder{color:var(--text-muted)}
.filter-select{height:34px;padding:0 10px;font-size:12px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:8px;cursor:pointer}
.toggle-btn{height:34px;padding:0 12px;font-size:12px;font-weight:500;color:var(--text2);background:transparent;border:1px solid var(--border);border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
.toggle-btn:hover{background:var(--bg2);color:var(--text)}
.toggle-btn.expanded{background:var(--bg2);color:var(--text)}
.toggle-btn .arrow{font-size:8px;transition:transform .2s}
.th-name{display:flex;align-items:center;gap:10px}
.expand-toggle-btn{background:transparent;border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:10px;font-weight:500;color:var(--text2);cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:all .15s;white-space:nowrap}
.expand-toggle-btn:hover{background:var(--bg3);color:var(--text);border-color:var(--text3)}
.expand-toggle-btn .arrow{font-size:8px;transition:transform .2s}
.expand-toggle-btn.expanded .arrow{transform:rotate(180deg)}
.panel{display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden}.panel.active{display:flex}
.filter-badges{margin-bottom:6px;flex-shrink:0}
.filter-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(138,186,220,.06);color:var(--accent);padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;margin-right:6px}
.filter-badge button{background:rgba(255,255,255,.06);border:none;color:var(--accent);width:16px;height:16px;border-radius:50%;cursor:pointer;font-size:9px}
.data-table{background:var(--bg2);border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
.table-header{display:grid;gap:4px;padding:0 12px;background:transparent;border-bottom:1px solid var(--border);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;height:34px;align-items:center;flex-shrink:0}
.table-body{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden}
.parts-grid{grid-template-columns:28px minmax(200px,1fr) 100px 105px 95px 40px 76px 96px 90px minmax(80px,0.5fr) 72px}
.part-checkbox{width:14px;height:14px;accent-color:var(--checkbox);cursor:pointer;margin:0}
.part-row.selected{background:var(--selection)!important}
.part-row.selected:hover{background:rgba(138,186,220,0.16)!important}
.bulk-bar{display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);align-items:center;gap:12px;padding:14px 18px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2);z-index:1000;flex-direction:row;width:auto}
.bulk-bar.active{display:flex}
.bulk-bar-count{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap}
.bulk-bar-actions{display:flex;gap:8px}
.bulk-bar .btn{background:var(--bg3);color:var(--text);border:1px solid var(--border);height:32px;padding:0 14px;font-size:12px;border-radius:8px;white-space:nowrap}
.bulk-bar .btn:hover{background:var(--bg4);border-color:var(--border-strong)}
.bulk-bar .btn-danger{background:rgba(192,128,128,0.1);color:var(--red);border-color:transparent}
.bulk-bar .btn-danger:hover{background:rgba(192,128,128,0.2)}
.bulk-bar .btn-clear{background:transparent;color:var(--text3);padding:0 8px}
.bulk-popover{width:320px}
.bulk-preview{background:var(--bg);border-radius:8px;padding:10px;margin-bottom:10px;max-height:120px;overflow-y:auto}
.bulk-preview-item{font-size:12px;color:var(--text2);padding:4px 0}
.add-row{display:flex;align-items:center;padding:4px 12px;background:var(--bg)}
.add-row-btn{width:20px;height:20px;background:var(--bg3);border:none;border-radius:6px;color:var(--text3);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.add-row-btn:hover{background:var(--accent);color:#fff}
.asm-row{display:grid;gap:4px;padding:0 12px;background:var(--bg3);height:40px;align-items:center;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border)}
.asm-row:hover{background:var(--bg4)}
.asm-row.highlight{background:rgba(10,132,255,0.2)!important;animation:asm-row-highlight 5s ease-out}
@keyframes asm-row-highlight{0%{background:rgba(10,132,255,0.4)}80%{background:rgba(10,132,255,0.2)}100%{background:var(--bg3)}}
.asm-priority{display:flex;flex-direction:column;gap:1px;align-items:center}
.asm-priority-btn{width:18px;height:14px;background:transparent;border:none;color:var(--text3);font-size:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:3px;transition:all .15s}
.asm-priority-btn:hover{background:var(--bg4);color:var(--text)}
.asm-priority-btn:active{background:var(--accent);color:#fff}
.asm-toggle{width:28px;height:28px;background:transparent;border:none;color:var(--text3);font-size:12px;cursor:pointer;pointer-events:none;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .15s;margin:-4px}
.asm-row:hover .asm-toggle{color:var(--text);background:rgba(255,255,255,0.06)}
.asm-name{font-weight:600;font-size:13px;color:var(--accent);pointer-events:none}
.asm-name-cell{display:flex;align-items:center;gap:8px}
.asm-meta{font-size:11px;color:var(--text3);pointer-events:none}
.asm-progress{display:flex;align-items:center;gap:8px}
.asm-bar{width:180px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;display:block}
.asm-bar-fill{height:100%;border-radius:3px;display:block}
.asm-pct{font-size:11px;font-weight:500;min-width:36px;color:var(--text2)}
.stage-dots{display:flex;align-items:center;gap:4px}
.stage-dot{width:6px;height:6px;border-radius:50%;background:var(--bg4)}
.stage-dot.done{background:var(--green)}
.stage-dot.current{background:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,.12)}
.asm-actions{display:flex;gap:4px}
.sm-btn{width:24px;height:24px;background:transparent;border:none;border-radius:5px;color:var(--text-muted);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.del-btn{width:28px;height:28px;background:transparent;border:none;border-radius:6px;color:var(--text-muted);font-size:16px;font-weight:300;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:all .15s}
.del-btn:hover{background:rgba(192,128,128,.15);color:var(--red)}
.notes-chat-cell{font-size:11px;color:var(--text2);padding:4px 8px;border-radius:6px;cursor:pointer;transition:all .15s;min-height:24px;display:flex;align-items:center;gap:6px;max-width:100%}
.notes-chat-cell:hover{background:var(--bg3);color:var(--text)}
.notes-chat-cell .comment-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}
.add-note{color:var(--text3);font-style:italic}
.notes-chat-cell:hover .add-note{color:var(--text2)}
.comment-badge{background:var(--accent);color:#fff;font-size:9px;padding:1px 5px;border-radius:8px;font-weight:500;flex-shrink:0;line-height:1.3}
.sm-btn:hover{background:var(--bg3);color:var(--text2)}.sm-btn.red{color:var(--red)}.sm-btn.red:hover{background:rgba(192,128,128,.08)}
.part-row{display:grid;gap:4px;padding:0 12px;background:var(--bg2);height:40px;align-items:center;transition:background .15s;border-bottom:1px solid var(--border)}
.part-row.ai-highlight{background:rgba(196,166,122,0.25)!important;animation:ai-pulse 5s ease-out}
@keyframes ai-pulse{0%{background:rgba(196,166,122,0.4)}10%{background:rgba(196,166,122,0.25)}90%{background:rgba(196,166,122,0.25)}100%{background:transparent}}
.asm-row.ai-highlight{background:rgba(196,166,122,0.2)!important;animation:ai-pulse 5s ease-out}
.part-row:last-child{border-bottom:none}
.part-row:hover{background:var(--bg3)}.part-row.child{background:var(--bg)}.part-row.child:hover{background:var(--bg3)}
.part-row.subchild{background:var(--bg)}
.part-row.highlight{background:var(--selection)!important;animation:part-row-highlight 5s ease-out}
@keyframes part-row-highlight{0%{background:rgba(90,154,200,0.3)}10%{background:var(--selection)}90%{background:var(--selection)}100%{background:transparent}}
.part-name-cell{display:flex;align-items:center;gap:8px}
.part-name-cell .cell{flex:1}
.subpart-add{width:18px;height:18px;border-radius:4px;background:transparent;border:1px dashed var(--border);color:var(--text-muted);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;opacity:0;flex-shrink:0}
.part-row:hover .subpart-add{opacity:0.5}
.subpart-add:hover{background:var(--accent);border-color:var(--accent);color:#fff;opacity:1!important}
.part-row.depth-1,.part-row.depth-2,.part-row.depth-3{border-left:3px solid var(--accent)}
.part-row.depth-1{border-left-color:rgba(138,186,220,0.3)}
.part-row.depth-2{border-left-color:rgba(138,186,220,0.5)}
.part-row.depth-3{border-left-color:rgba(138,186,220,0.7)}
.cell{font-size:12px;color:var(--text);padding:3px 5px;border-radius:4px;cursor:text;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:22px;display:flex;align-items:center}
.cell.editing{overflow:visible;position:relative;z-index:100}
.cell.editing{overflow:visible;position:relative;z-index:50}
.cell:hover{background:var(--bg4)}.cell.editing{background:var(--bg);padding:0}
.cell input,.cell select{width:100%;height:26px;padding:0 8px;font-size:12px;color:var(--text);background:var(--bg);border:1px solid var(--accent);border-radius:4px;outline:none}
.cell.muted{color:var(--text2)}.cell.note{font-style:italic;color:var(--text3);font-size:11px;margin-left:4px}
.status-badge{font-size:10px;font-weight:500;padding:3px 7px;border-radius:4px;text-align:center;display:inline-block;position:relative}
.status-badge .days-badge{position:absolute;top:-8px;right:-8px;min-width:18px;height:16px;padding:0 4px;font-size:9px;font-weight:600;border-radius:8px;display:none;align-items:center;justify-content:center;white-space:nowrap;pointer-events:none;box-shadow:0 1px 3px rgba(0,0,0,0.2)}
.status-badge:hover .days-badge{display:flex}
.days-badge.always-show{display:flex}
.days-badge.fresh{background:var(--green);color:white}
.days-badge.normal{background:var(--accent);color:white}
.days-badge.aging{background:var(--orange);color:white}
.days-badge.stuck{background:var(--red);color:white}
.status-badge.waiting{background:rgba(138,138,130,.08);color:var(--s0)}.status-badge.to-order{background:rgba(192,112,112,.08);color:var(--s1)}.status-badge.ordered{background:rgba(216,119,86,.08);color:var(--s2)}.status-badge.arrived{background:rgba(184,160,80,.08);color:var(--s3)}.status-badge.tested{background:rgba(106,160,170,.08);color:var(--s4)}.status-badge.configured{background:rgba(152,136,170,.08);color:var(--s5)}.status-badge.installed{background:rgba(106,170,106,.08);color:var(--s6)}
.eta-badge{font-size:10px;padding:3px 7px;border-radius:4px;background:var(--bg3);color:var(--text2);cursor:pointer;font-weight:500}
.eta-badge:hover{background:var(--bg4);color:var(--text)}
.eta-badge.has-data{background:rgba(160,144,180,.08);color:var(--purple)}
.eta-badge.manual{background:rgba(127,184,127,.08);color:var(--green)}
.action-indicator{width:16px;height:16px;background:var(--yellow);color:var(--bg);border-radius:4px;font-size:9px;font-weight:600;display:flex;align-items:center;justify-content:center;cursor:pointer}
.adv-btn{width:24px;height:24px;font-size:11px;font-weight:500;color:var(--text-muted);background:transparent;border:none;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.adv-btn:hover{background:var(--bg3);color:var(--text2)}.adv-btn.done{color:var(--green);cursor:default}.adv-btn.done:hover{background:transparent}
.empty{padding:40px 16px;text-align:center;color:var(--text-muted);font-size:13px;flex:1;display:flex;align-items:center;justify-content:center}
.action-grid{grid-template-columns:minmax(120px,1fr) 100px 65px 80px 75px 75px 75px 80px}
.action-row{display:grid;gap:6px;padding:0 12px;background:var(--bg2);height:40px;align-items:center;border-bottom:1px solid var(--border)}
.action-row:last-child{border-bottom:none}
.action-row:hover{background:var(--bg3)}
.action-task{font-size:12px}.action-task.completed{text-decoration:line-through;color:var(--text3)}
.action-progress-bar{width:100%;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
.action-progress-fill{height:100%;border-radius:2px;transition:width .4s ease}
.action-link{font-size:11px;color:var(--accent);cursor:pointer}.action-link:hover{text-decoration:underline}
.action-due{font-size:12px;color:var(--text2)}.action-due.overdue{color:var(--red);font-weight:600}.action-due.soon{color:var(--yellow)}
.action-status{font-size:10px;font-weight:600;padding:4px 8px;border-radius:6px;text-align:center}
.action-status.not-started{background:rgba(255,69,58,.15);color:var(--s1)}.action-status.in-progress{background:rgba(255,214,10,.15);color:var(--s2)}.action-status.completed{background:rgba(48,209,88,.15);color:var(--s3)}
.progress-layout{display:flex;flex-direction:column;gap:10px;flex:1;overflow-y:auto;overflow-x:hidden}
.progress-top{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:900px){.progress-top{grid-template-columns:1fr}}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;flex-direction:column}
.card-title{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.card-title a{font-size:12px;color:var(--accent);cursor:pointer;text-transform:none;font-weight:500}
.burndown-container{background:var(--bg);border-radius:10px;padding:12px;flex:1;display:flex;align-items:center;justify-content:center;min-height:180px}
.burndown-container svg{display:block;width:100%;height:100%}
.burndown-dates{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-top:8px}
.burndown-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);font-size:13px;cursor:pointer;gap:6px}
.burndown-legend{display:flex;gap:16px;margin-top:10px;font-size:11px;color:var(--text2)}
.legend-item{display:flex;align-items:center;gap:6px}
.legend-dot{width:10px;height:3px;border-radius:2px}
.legend-dot.green{background:var(--green)}.legend-dot.red{background:var(--red)}.legend-dot.gray{background:var(--text3)}
.insights-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ins-group{margin-bottom:12px}.ins-group:last-child{margin-bottom:0}
.ins-group-title{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;padding:0 4px}
.ins-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg);border-radius:8px;font-size:12px}
.ins-label{color:var(--text2)}.ins-val{font-weight:600}
.ins-val.green{color:var(--green)}.ins-val.red{color:var(--red)}.ins-val.yellow{color:var(--yellow)}.ins-val.cyan{color:var(--cyan)}.ins-val.orange{color:var(--orange)}

/* Metrics Popover */
/* Backdrop overlay for popovers */
.popover-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:999;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
.popover-backdrop.active{opacity:1;pointer-events:auto}

.metrics-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:640px;max-width:calc(100vw - 40px);padding:20px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.metrics-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.metrics-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.metrics-row:last-child{margin-bottom:0}
.metrics-popover-title{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;padding:0 4px}
.metrics-popover .ins-row{padding:6px 8px;margin-bottom:4px}
.metrics-popover .ins-row:last-child{margin-bottom:0}
.metrics-section-full{grid-column:span 2;margin-bottom:12px}
.mp-forecast{padding:8px 0}
.mp-forecast-date{font-size:20px;font-weight:600;color:var(--text)}
.mp-forecast-label{font-size:12px;margin-left:8px}
.mp-forecast-detail{font-size:11px;color:var(--text3);margin-top:4px}
.mp-bottlenecks{display:flex;flex-wrap:wrap;gap:8px}
.mp-bottleneck{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg3);border-radius:6px;font-size:11px;cursor:pointer;transition:background .15s}
.mp-bottleneck:hover{background:var(--bg4)}
.mp-bottleneck-name{color:var(--text)}
.mp-bottleneck-info{color:var(--text3)}
.mp-otd-detail{margin-top:8px;padding:8px;background:var(--bg);border-radius:8px}
.mp-otd-content{margin-top:8px;max-height:200px;overflow-y:auto}
.mp-otd-item{display:flex;justify-content:space-between;padding:6px 8px;font-size:12px;border-radius:4px}
.mp-otd-item:nth-child(odd){background:var(--bg3)}
.mp-otd-item-mfr{color:var(--text)}
.mp-otd-item-stats{color:var(--text3)}
.mp-chart-container{background:var(--bg);border-radius:10px;padding:16px;min-height:270px;display:flex;align-items:center;justify-content:center;position:relative}
.mp-chart-container svg{display:block;width:100%;height:100%}
.mp-chart-tooltip{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:11px;color:var(--text);pointer-events:none;white-space:nowrap;z-index:100;opacity:0;transition:opacity 0.1s;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.mp-chart-tooltip.visible{opacity:1}
.mp-forecast-popover{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-size:12px;color:var(--text);z-index:101;box-shadow:0 4px 16px rgba(0,0,0,0.4);max-width:240px;line-height:1.5}
.mp-forecast-popover-title{font-weight:600;margin-bottom:6px;color:var(--green)}
.mp-forecast-popover-close{position:absolute;top:6px;right:8px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:2px 6px}
.mp-forecast-popover-close:hover{color:var(--text)}
.mp-forecast-popover-stat{display:flex;justify-content:space-between;margin:4px 0;color:var(--text2)}
.mp-forecast-popover-stat span:last-child{color:var(--text);font-weight:500}
.mp-chart-legend{display:flex;gap:16px;margin-top:12px;font-size:11px;color:var(--text2);justify-content:center}
.mp-legend-item{display:flex;align-items:center;gap:6px}
.mp-legend-dot{width:8px;height:8px;border-radius:50%}
.mp-chart-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);font-size:12px;gap:6px;cursor:pointer;padding:20px}
.mp-chart-empty:hover{color:var(--text2)}
.metrics-section{margin-bottom:12px}
.metrics-section:last-child{margin-bottom:0}
.metrics-section-title{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;padding:4px 8px;margin-bottom:4px}
.forecast-card{background:var(--bg);border-radius:10px;padding:12px;margin-top:8px;border-left:3px solid var(--purple)}
.forecast-title{font-size:10px;font-weight:600;color:var(--purple);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.forecast-main{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.forecast-date{font-size:20px;font-weight:700;letter-spacing:-0.5px}
.forecast-label{font-size:12px;color:var(--text2)}
.forecast-detail{font-size:11px;color:var(--text3)}
/* Insights Panel - Minimal Design */
.insights-btn{display:flex;align-items:center;gap:6px;padding:5px 10px;background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:11px;font-weight:500;cursor:pointer;transition:all .15s;margin-right:8px}
.insights-btn:hover{background:var(--bg2);color:var(--text);border-color:var(--text3)}
.insights-btn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2}
.insights-btn-dot{display:none}
.insights-panel{position:fixed;background:var(--bg);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.3);z-index:1002;width:680px;max-width:calc(100vw - 40px);height:calc(100vh - 120px);max-height:900px;opacity:0;transform:translateY(-8px);transition:opacity 0.2s,transform 0.2s;pointer-events:none;overflow:hidden;display:flex;flex-direction:column}
.insights-panel.open{opacity:1;transform:translateY(0);pointer-events:auto}
.insights-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
.insights-title{font-size:13px;font-weight:500;color:var(--text);display:flex;align-items:center;gap:8px;letter-spacing:-0.2px}
.insights-title-icon{display:none}
.insights-close{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;border-radius:4px;transition:all .1s;font-size:16px;line-height:1}
.insights-close:hover{background:var(--bg2);color:var(--text)}
.insights-body{flex:1;overflow-y:auto;padding:12px 16px}
.insights-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.insights-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px 16px;transition:border-color 0.15s,box-shadow 0.15s}
.insights-card:hover{border-color:var(--border);box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.insights-card.full{grid-column:span 2}
.insights-card-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.insights-card-icon{display:none}
.insights-card-label{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;flex:1}
.insights-card-title{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;flex:1}
.insights-card-badge{font-size:10px;font-weight:500;padding:2px 8px;border-radius:4px;background:var(--bg2);color:var(--text2)}
.insights-card-badge.good{color:var(--green)}
.insights-card-badge.warning{color:var(--yellow)}
.insights-card-badge.critical{color:var(--red);background:rgba(239,68,68,0.1)}
.insights-card-body{font-size:12px;color:var(--text2);line-height:1.5}
.insights-metric{display:flex;align-items:baseline;gap:4px;margin-bottom:2px}
.insights-metric-value{font-size:24px;font-weight:600;color:var(--text);letter-spacing:-0.5px;font-variant-numeric:tabular-nums}
.insights-metric-unit{font-size:12px;color:var(--text3);font-weight:400}
.insights-metric-label{font-size:11px;color:var(--text3)}
.insights-bar{height:4px;background:var(--bg2);border-radius:2px;overflow:hidden;margin:6px 0}
.insights-bar-fill{height:100%;border-radius:2px;transition:width 0.4s}
.insights-bar-fill.green{background:var(--green)}
.insights-bar-fill.yellow{background:var(--yellow)}
.insights-bar-fill.red{background:var(--red)}
.insights-list{display:flex;flex-direction:column;gap:2px;max-height:130px;overflow-y:auto}
.insights-list-item{display:flex;align-items:center;gap:6px;padding:5px 6px;border-radius:4px;font-size:11px;cursor:pointer;transition:background .1s}
.insights-list-item:hover{background:var(--bg2)}
.insights-list-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.insights-list-dot.red{background:var(--red)}
.insights-list-dot.yellow{background:var(--yellow)}
.insights-list-dot.green{background:var(--green)}
.insights-list-dot.blue{background:var(--accent)}
.insights-list-text{flex:1;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.insights-list-meta{color:var(--text3);font-size:10px;flex-shrink:0}
.insights-velocity-compare{display:flex;align-items:center;justify-content:center;gap:12px;padding:8px 0}
.insights-vel-item{text-align:center}
.insights-vel-value{font-size:20px;font-weight:600;color:var(--text);font-variant-numeric:tabular-nums}
.insights-vel-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px}
.insights-vel-vs{font-size:14px;padding:4px 8px;border-radius:4px}
.insights-vel-vs.good{color:var(--green)}
.insights-vel-vs.warning{color:var(--yellow)}
.insights-vel-vs.critical{color:var(--red)}
.insights-forecast{display:flex;gap:6px;margin-top:8px}
.insights-forecast-item{flex:1;text-align:center;padding:8px 6px;background:var(--bg2);border-radius:6px;border:1px solid transparent}
.insights-forecast-item.highlight{border-color:var(--border)}
.insights-forecast-date{font-size:12px;font-weight:500;color:var(--text);font-variant-numeric:tabular-nums}
.insights-forecast-label{font-size:9px;color:var(--text3);margin-top:2px;text-transform:uppercase;letter-spacing:0.3px}
.insights-deadline-compare{display:flex;align-items:center;justify-content:space-between;margin-top:8px;padding:6px 10px;background:var(--bg2);border-radius:4px;font-size:10px}
.insights-deadline-label{color:var(--text3)}
.insights-deadline-status{font-weight:500}
.insights-deadline-status.green{color:var(--green)}
.insights-deadline-status.yellow{color:var(--yellow)}
.insights-deadline-status.red{color:var(--red)}
.insights-stage-bars{display:flex;flex-direction:column;gap:5px}
.insights-stage-row{display:flex;align-items:center;gap:10px}
.insights-stage-row.bottleneck .insights-stage-name{color:var(--red);font-weight:500}
.insights-stage-name{width:56px;font-size:10px;color:var(--text3);text-align:right;flex-shrink:0}
.insights-stage-bar{flex:1;height:18px;background:var(--bg2);border-radius:4px;overflow:hidden;position:relative}
.insights-stage-fill{height:100%;border-radius:4px;transition:width 0.3s ease-out;background:var(--accent);opacity:0.5}
.insights-stage-fill.slow{background:var(--red);opacity:0.55}
.insights-stage-fill.medium{background:var(--yellow);opacity:0.55}
.insights-stage-fill.fast{background:var(--green);opacity:0.55}
.insights-stage-value{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:10px;font-weight:500;color:var(--text);font-variant-numeric:tabular-nums}
.insights-supplier-list{display:flex;flex-direction:column;gap:1px;max-height:130px;overflow-y:auto}
.insights-supplier-row{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:3px}
.insights-supplier-row:nth-child(odd){background:var(--bg2)}
.insights-supplier-name{flex:1;font-size:10px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.insights-supplier-otd{width:40px;text-align:center;font-size:9px;font-weight:500}
.insights-supplier-otd.good{color:var(--green)}
.insights-supplier-otd.warning{color:var(--yellow)}
.insights-supplier-otd.bad{color:var(--red)}
.insights-supplier-lead{width:45px;text-align:right;font-size:9px;color:var(--text3);font-variant-numeric:tabular-nums}
.insights-supplier-count{width:30px;text-align:right;font-size:9px;color:var(--text3)}
.insights-empty{text-align:center;padding:12px;color:var(--text3);font-size:10px}
.insights-week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.insights-week-day{text-align:center;padding:8px 4px;background:var(--bg2);border-radius:6px;cursor:default;transition:background 0.15s}
.insights-week-day.has-arrivals{background:var(--accent);background:rgba(var(--accent-rgb,88,166,255),0.15)}
.insights-week-count{font-size:16px;font-weight:600;color:var(--text3);font-variant-numeric:tabular-nums}
.insights-week-day.has-arrivals .insights-week-count{color:var(--accent)}
.insights-week-day .insights-week-label{font-size:9px;color:var(--text3);margin-top:2px}
.insights-week-label{font-size:8px;color:var(--text3);text-transform:uppercase;margin-top:2px}
.insights-velocity-chart{height:48px;display:flex;align-items:flex-end;gap:2px;padding:6px 0}
.insights-velocity-bar{flex:1;background:var(--text3);opacity:0.3;border-radius:1px 1px 0 0;min-height:2px;transition:all 0.15s;position:relative;cursor:default}
.insights-velocity-bar:hover{opacity:0.6}
.insights-velocity-bar::after{content:attr(data-label) " " attr(data-value);position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--border);padding:2px 6px;border-radius:3px;font-size:9px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.1s;color:var(--text)}
.insights-velocity-bar:hover::after{opacity:1}
.insights-velocity-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-top:4px;font-variant-numeric:tabular-nums}
.insights-velocity-trend{font-size:10px;margin-top:4px;color:var(--text3)}
.insights-velocity-trend.up{color:var(--green)}
.insights-velocity-trend.down{color:var(--red)}
/* Master Insights (Portfolio) */
.master-insights{z-index:1100}
.insights-health-summary{display:flex;justify-content:space-around;margin-bottom:14px}
.insights-health-stat{text-align:center}
.insights-health-value{display:block;font-size:26px;font-weight:600;color:var(--text);font-variant-numeric:tabular-nums;letter-spacing:-0.5px}
.insights-health-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.4px;margin-top:2px}
.insights-health-bar-wrap{display:flex;height:8px;border-radius:4px;overflow:hidden;background:var(--bg2)}
.insights-health-bar{height:100%;transition:width 0.3s ease-out}
.insights-health-legend{display:flex;gap:14px;margin-top:10px;justify-content:center;flex-wrap:wrap}
.insights-legend-item{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text2)}
.insights-legend-dot{width:8px;height:8px;border-radius:2px}
.insights-risk-list{display:flex;flex-direction:column;gap:3px}
.insights-risk-item{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--bg2);border-radius:5px;cursor:pointer;transition:background 0.1s;border-left:3px solid transparent}
.insights-risk-item:hover{background:var(--bg3)}
.insights-risk-item.critical{border-left-color:var(--red)}
.insights-risk-item.warning{border-left-color:var(--yellow)}
.insights-risk-name{font-size:11px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.insights-risk-detail{font-size:10px;color:var(--text3);white-space:nowrap;margin-left:10px;font-variant-numeric:tabular-nums}
.insights-deadline-weeks{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.insights-deadline-week{padding:10px;background:var(--bg2);border-radius:6px}
.insights-week-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px}
.insights-week-empty{font-size:10px;color:var(--text3);opacity:0.4}
.insights-week-project{font-size:10px;color:var(--text2);padding:3px 0;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:color 0.1s}
.insights-week-project:hover{color:var(--text)}
.insights-week-pct{color:var(--text3);font-size:9px;margin-left:4px}
.insights-sparkline{display:flex;align-items:flex-end;gap:6px;height:64px;padding:8px 4px}
.insights-spark-bar{flex:1;background:var(--text3);opacity:0.3;border-radius:2px;min-height:4px;transition:all 0.15s;cursor:pointer}
.insights-spark-bar:hover{opacity:0.6}
.insights-spark-bar.current{background:var(--green);opacity:0.8}
.insights-spark-bar.current:hover{opacity:1}
.insights-spark-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--text3);padding:4px 4px 0}
.insights-spark-labels span{flex:1;text-align:center}
.insights-spark-summary{text-align:center;font-size:11px;color:var(--text2);margin-top:8px}
.insights-empty-card{text-align:center;padding:24px 12px;color:var(--text3);font-size:11px;opacity:0.8}
.insights-loading{text-align:center;padding:48px 20px;color:var(--text3);font-size:12px}
.insights-pipeline-bar{display:flex;height:12px;border-radius:6px;overflow:hidden;background:var(--bg3)}
.insights-pipeline-seg{height:100%;min-width:2px;transition:width 0.3s}
.insights-pipeline-legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;justify-content:center}
.insights-work-summary{display:flex;justify-content:space-between;margin-bottom:16px;padding:0 8px}
.insights-work-stat{text-align:center;flex:1}
.insights-work-value{display:block;font-size:22px;font-weight:600;color:var(--text);font-variant-numeric:tabular-nums;letter-spacing:-0.5px}
.insights-work-value.urgent{color:var(--red)}
.insights-work-stat .insights-work-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.4px;margin-top:3px;display:block}
.insights-bars{display:flex;align-items:flex-end;gap:1px;height:96px;position:relative}
.insights-bars .insights-bar{flex:1;background:var(--green);border-radius:1px 1px 0 0;min-height:2px;opacity:0.5;position:relative;cursor:pointer}
.insights-bars .insights-bar.today{opacity:1}
.insights-bars .insights-bar:hover{opacity:1;background:var(--accent)}
.insights-chart-xaxis{display:flex;justify-content:space-between;font-size:9px;color:var(--text3);margin-top:4px}
.bar-tooltip{position:fixed;background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:11px;padding:6px 10px;border-radius:6px;pointer-events:none;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.15);white-space:nowrap;display:none}
.bar-tooltip.visible{display:block}
.insights-card-wide{grid-column:span 2}
.insights-velocity-stats{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:12px}
.insights-velocity-stats strong{color:var(--text);font-weight:600}
.master-sidebar-row.highlight{background:var(--accent);background:rgba(var(--accent-rgb,88,166,255),0.15);transition:background 0.3s}
/* Insights AI Chat - Claude Style */
.insights-header-actions{display:flex;align-items:center;gap:6px}
.insights-ai-toggle.active .ai-console-plus{transform:rotate(45deg)}
.insights-ai-toggle.active .ai-console-icon{background:var(--accent-main)}
.insights-ai-chat{display:none;flex-direction:column;flex:1;min-height:0}
.insights-panel.ai-mode{display:flex;flex-direction:column}
.insights-panel.ai-mode .insights-body{display:none}
.insights-panel.ai-mode .insights-ai-chat{display:flex}
.insights-ai-toolbar{display:none}
.insights-ai-output{flex:1;overflow-y:auto;padding:24px 28px;font-size:14px;line-height:1.7;color:var(--text);position:relative}
.insights-ai-output:empty::before{content:'Ask anything about this project...';color:var(--text3);font-size:15px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.insights-ai-output .ai-user-msg{background:var(--bg3);color:var(--text);padding:12px 16px;border-radius:18px;margin-left:auto;margin-bottom:20px;max-width:85%;width:fit-content;font-size:14px;line-height:1.5}
.insights-ai-output .ai-response{margin-bottom:28px}
.insights-ai-output .ai-response:last-child{margin-bottom:0}
.insights-ai-output .ai-model-badge{display:none}
.insights-ai-output h2{font-size:17px;font-weight:600;color:var(--text);margin:20px 0 10px 0}
.insights-ai-output h3{font-size:15px;font-weight:600;color:var(--text);margin:18px 0 8px 0}
.insights-ai-output h4{font-size:14px;font-weight:600;color:var(--text);margin:14px 0 6px 0}
.insights-ai-output p{margin:0 0 16px 0;line-height:1.7}
.insights-ai-output p:last-child{margin-bottom:0}
.insights-ai-output ul,.insights-ai-output ol{margin:8px 0 12px 0;padding-left:20px}
.insights-ai-output li{margin-bottom:2px;line-height:1.5;padding-left:2px}
.insights-ai-output li::marker{color:var(--text3)}
.insights-ai-output strong{color:var(--text);font-weight:600}
.ai-part-link{color:var(--accent-main);cursor:pointer;text-decoration:underline;text-decoration-color:transparent;transition:text-decoration-color .15s}
.ai-part-link:hover{text-decoration-color:var(--accent-main)}
.insights-ai-input-area{padding:16px 20px 20px;background:var(--bg)}
.insights-ai-input-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:12px 16px;display:flex;flex-direction:column;gap:10px}
.insights-ai-input{width:100%;padding:0;border:none;background:transparent;color:var(--text);font-size:14px;outline:none;resize:none;font-family:inherit;line-height:1.5}
.insights-ai-input::placeholder{color:var(--text3)}
.insights-ai-input-footer{display:flex;align-items:center;justify-content:space-between}
.insights-ai-input-actions{display:flex;align-items:center;gap:8px}
.insights-ai-model{padding:4px 10px;border:none;border-radius:6px;background:transparent;color:var(--text3);font-size:12px;cursor:pointer;outline:none}
.insights-ai-model:hover{color:var(--text)}
.insights-ai-clear{background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer;padding:4px 8px}
.insights-ai-clear:hover{color:var(--text)}
.insights-ai-buttons{display:flex;align-items:center;gap:6px}
.insights-ai-summary-btn{background:transparent;border:1px solid var(--border);color:var(--text2);padding:6px 12px;border-radius:8px;font-size:12px;cursor:pointer;transition:all .15s}
.insights-ai-summary-btn:hover{background:var(--bg3);color:var(--text)}
.insights-ai-ask-btn{background:var(--accent-main);border:none;color:white;width:32px;height:32px;border-radius:10px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:opacity .15s}
.insights-ai-ask-btn:hover{opacity:0.85}
.insights-ai-ask-btn:disabled,.insights-ai-summary-btn:disabled{opacity:0.4;cursor:not-allowed}
.insights-ai-thinking{color:var(--text3)}
.insights-ai-thinking::after{content:'...';animation:insightsThinkingDots 1.4s steps(4,end) infinite}
@keyframes insightsThinkingDots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}
/* Progress Page */
.progress-layout-full{display:flex;flex-direction:column;gap:12px;flex:1;overflow-y:auto}
.progress-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.asm-progress-list{display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto}
.asm-progress-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bg3)}
.asm-progress-item:last-child{border-bottom:none}
.asm-progress-name{flex:1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.asm-progress-bar{width:80px;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden}
.asm-progress-fill{height:100%;border-radius:3px;transition:width 0.3s}
.asm-progress-pct{font-size:11px;font-weight:600;width:36px;text-align:right}
.bottleneck-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto}
.bottleneck-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border-radius:6px;font-size:11px;border-left:3px solid var(--red)}
.bottleneck-item.warning{border-color:var(--yellow)}
.bottleneck-name{flex:1;font-weight:500}
.bottleneck-days{color:var(--text3)}
.forecast-card-inner{padding:8px 0}

/* Gantt Chart - MS Project Style */
.gantt-container{display:flex;flex-direction:column;flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.gantt-toolbar{display:flex;align-items:center;gap:18px;padding:14px 20px;background:transparent;border-bottom:1px solid var(--border)}
.gantt-toolbar-title{font-size:15px;font-weight:500;color:var(--text)}
.gantt-toolbar-dates{display:flex;align-items:center;gap:10px;margin-left:auto}
.gantt-date-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.gantt-date-display{display:flex;flex-direction:column;gap:2px;padding:6px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.15s;min-width:100px}
.gantt-date-display:hover{border-color:var(--accent);background:var(--bg4)}
.gantt-date-value{font-size:13px;font-weight:500;color:var(--text)}
.gantt-date-arrow{color:var(--text-muted);font-size:14px}
.gantt-toolbar-actions{display:flex;align-items:center;gap:8px}
.gantt-filter-select{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:12px;color:var(--text);cursor:pointer;min-width:140px}
.gantt-filter-select:focus{outline:none;border-color:var(--accent)}
.gantt-col-resource{font-size:11px;color:var(--text3);cursor:pointer}
.gantt-col-follows{font-size:11px;color:var(--text3);cursor:pointer}
.gantt-follows-select{background:var(--bg3);border:1px solid var(--border);font-size:10px;color:var(--text);cursor:pointer;padding:3px 4px;border-radius:4px;max-width:62px;position:relative;z-index:20;pointer-events:auto}
.gantt-follows-select:hover{background:var(--bg4);border-color:var(--accent)}
.gantt-follows-select:focus{outline:none;border-color:var(--accent)}
.gantt-dependency-layer{position:absolute;top:0;left:0;pointer-events:none;overflow:visible;z-index:5}
.gantt-dependency-line{fill:none;stroke:#888;stroke-width:1.5;opacity:0.7}
.gantt-dependency-arrow{fill:#888;opacity:0.7}
.gantt-resource-select{background:var(--bg3);border:1px solid var(--border);font-size:11px;color:var(--text);cursor:pointer;padding:4px 6px;border-radius:4px;max-width:80px;position:relative;z-index:20;pointer-events:auto}
.gantt-resource-select:hover{background:var(--bg4);border-color:var(--accent)}
.gantt-resource-select:focus{outline:none;border-color:var(--accent)}
.gantt-col-resource{pointer-events:auto;position:relative;z-index:20}
.btn-sm{padding:6px 12px;font-size:12px;height:30px}
.gantt-header-row{display:flex;background:transparent;border-bottom:1px solid var(--border);position:relative}
.gantt-sidebar-header{width:490px;min-width:490px;flex-shrink:0;display:grid;grid-template-columns:1fr 70px 70px 55px 55px 40px;font-size:10px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border);background:var(--bg2);position:sticky;left:0;z-index:10;box-shadow:2px 0 8px rgba(0,0,0,0.1);align-items:end}
.gantt-sidebar-header>div{padding:12px 10px}
.gantt-col-name{padding-left:20px!important}
.gantt-timeline-header-wrap{flex:1;overflow:hidden}
.gantt-timeline-header{display:flex;flex-direction:column;position:relative}
.gantt-timeline-year-row{display:flex;border-bottom:1px solid var(--border)}
.gantt-timeline-year-cell{font-size:11px;font-weight:600;color:var(--text);padding:6px 8px;border-right:1px solid var(--border);background:var(--bg2);white-space:nowrap;overflow:hidden}
.gantt-timeline-month-row{display:flex;border-bottom:1px solid var(--border)}
.gantt-timeline-month-cell{font-size:10px;font-weight:500;color:var(--text3);padding:4px 6px;border-right:1px solid var(--border);background:var(--bg);white-space:nowrap;overflow:hidden;text-transform:uppercase;letter-spacing:0.3px}
.gantt-timeline-week-row{display:flex}
.gantt-timeline-day{min-width:32px;width:32px;padding:4px 0;text-align:center;font-size:9px;color:var(--text-muted);border-right:1px solid var(--border)}
.gantt-timeline-day.weekend{background:rgba(0,0,0,0.08)}
.gantt-timeline-day.today{background:rgba(138,186,220,0.1);color:var(--accent);font-weight:500}
.gantt-timeline-day .day-num{font-size:11px;font-weight:500;color:var(--text3)}
.gantt-timeline-day.today .day-num{color:var(--accent)}
.gantt-body-wrap{flex:1;overflow:auto;cursor:grab;position:relative}
.gantt-body-wrap.grabbing{cursor:grabbing}
.gantt-body-wrap.grabbing{cursor:grabbing}
.gantt-body-inner{display:flex;min-height:100%;position:relative}
.gantt-sidebar-body{width:490px;min-width:490px;flex-shrink:0;border-right:1px solid var(--border);background:var(--bg2);position:sticky;left:0;z-index:10;box-shadow:2px 0 8px rgba(0,0,0,0.1)}
.gantt-sidebar-row{display:grid;grid-template-columns:1fr 70px 70px 55px 55px 40px;border-bottom:1px solid var(--border);font-size:13px;align-items:center;height:44px}
.gantt-sidebar-row:hover{background:var(--bg3)}
.gantt-sidebar-row.asm{font-weight:500}
.gantt-sidebar-row>div{padding:0 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gantt-sidebar-row .gantt-col-name{padding-left:20px;display:flex;align-items:center;gap:8px}
.gantt-sidebar-row.part .gantt-col-name{padding-left:32px;color:var(--text2)}
.gantt-sidebar-row .gantt-col-start,.gantt-sidebar-row .gantt-col-end{font-size:11px;color:var(--text3);cursor:pointer;transition:all 0.15s}
.gantt-sidebar-row .gantt-col-start:hover,.gantt-sidebar-row .gantt-col-end:hover{color:var(--accent);background:var(--bg4);border-radius:4px;margin:-2px -4px;padding:2px 14px}
.gantt-sidebar-row .gantt-col-dur{font-size:11px;color:var(--text-muted);text-align:center}
.gantt-toggle{cursor:pointer;font-size:10px;color:var(--text-muted)}
.gantt-asm-link{cursor:pointer;transition:color 0.15s}
.gantt-asm-link:hover{color:var(--accent)}
.gantt-sidebar-row.highlight{background:rgba(138,186,220,0.15)!important;animation:gantt-row-highlight 5s ease-out}
@keyframes gantt-row-highlight{0%{background:rgba(138,186,220,0.3)}80%{background:rgba(138,186,220,0.15)}100%{background:transparent}}
.gantt-link-btn{background:var(--bg3)!important;font-size:12px!important}
.gantt-timeline-body{position:relative;flex-shrink:0}
.gantt-timeline-row{display:flex;height:44px;border-bottom:1px solid var(--border);position:relative}
.gantt-timeline-row:hover{background:var(--bg3)}
.gantt-timeline-cell{min-width:32px;width:32px;border-right:1px solid var(--border)}
.gantt-timeline-cell.weekend{background:rgba(0,0,0,0.06)}
.gantt-bar-container{position:absolute;top:0;bottom:0;display:flex;align-items:center}
.gantt-bar{height:15px;border-radius:4px;font-size:9px;font-weight:500;color:#fff;display:flex;align-items:center;padding:0 4px;min-width:12px;cursor:grab;transition:opacity 0.15s,box-shadow 0.15s;text-shadow:0 1px 2px rgba(0,0,0,0.2);position:relative;overflow:visible}
.gantt-bar:hover{box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.gantt-bar:active{cursor:grabbing}
.gantt-bar-asm{height:15px;border-radius:4px}
.gantt-bar.asm{background:var(--text-muted);height:3px;border-radius:2px;box-shadow:none;min-width:10px}
.gantt-bar.asm:hover{transform:none;height:5px;margin-top:-1px}
.gantt-bar.waiting{background:#8a8a82}
.gantt-bar.to-order{background:#c07070}
.gantt-bar.ordered{background:#d87756}
.gantt-bar.arrived{background:#b8a050;color:#fff}
.gantt-bar.tested{background:#6aa0aa}
.gantt-bar.configured{background:#9888aa}
.gantt-bar.installed{background:#6aaa6a}
.gantt-bar-progress{position:absolute;right:0;top:0;bottom:0;background:#9a9a9a;border-radius:4px}
.gantt-bar-label{position:relative;z-index:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gantt-bar-conflict{position:absolute;left:4px;top:50%;transform:translateY(-50%);font-size:10px;line-height:1;filter:drop-shadow(0 1px 1px rgba(0,0,0,0.3));z-index:2}
.gantt-bar.has-conflict{padding-left:20px}
.gantt-bar.has-conflict::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:#ff6b35;border-radius:4px 0 0 4px}
.gantt-conflict-badge{background:#ff6b35;color:#fff;font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px;margin-left:8px;cursor:help;position:relative}
.gantt-conflict-popover{position:absolute;top:100%;left:0;margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.25);padding:12px;min-width:280px;max-width:400px;z-index:1000;display:none;text-align:left}
.gantt-conflict-popover.open{display:block}
.gantt-conflict-popover-title{font-size:11px;font-weight:600;color:#ff6b35;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.gantt-conflict-item{padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;color:var(--text)}
.gantt-conflict-item:last-child{border-bottom:none;padding-bottom:0}
.gantt-conflict-item:first-child{padding-top:0}
.gantt-conflict-resource{font-weight:600;color:var(--text);margin-bottom:4px}
.gantt-conflict-tasks{color:var(--text2);font-size:11px;line-height:1.4}
.gantt-bar-resize{position:absolute;top:-2px;bottom:-2px;width:6px;cursor:ew-resize;z-index:5;opacity:0;transition:opacity .15s}
.gantt-bar:hover .gantt-bar-resize{opacity:1}
.gantt-bar-resize-left{left:0;border-radius:4px 0 0 4px}
.gantt-bar-resize-right{right:0;border-radius:0 4px 4px 0}
.gantt-bar-resize:hover{background:rgba(255,255,255,0.4)}
.gantt-bar.overdue{box-shadow:0 0 0 2px #e53935,0 2px 8px rgba(229,57,53,0.4)}
.gantt-bar.overdue::after{content:'!';position:absolute;right:-8px;top:-8px;background:#e53935;color:#fff;font-size:9px;font-weight:700;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.3)}
.gantt-bar.conflict-highlight{animation:conflict-highlight-pulse 0.8s ease-in-out 6;box-shadow:0 0 0 3px var(--red),0 4px 20px rgba(192,112,112,0.5)}
@keyframes conflict-highlight-pulse{0%,100%{box-shadow:0 0 0 3px var(--red),0 4px 20px rgba(192,112,112,0.5)}50%{box-shadow:0 0 0 6px var(--red),0 4px 30px rgba(192,112,112,0.8)}}
.gantt-tooltip{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;box-shadow:0 8px 24px rgba(0,0,0,0.25);z-index:1000;pointer-events:none;max-width:280px;font-size:12px;line-height:1.5;display:none}
.gantt-tooltip.visible{display:block}
.gantt-tooltip-title{font-weight:600;font-size:13px;margin-bottom:6px;color:var(--text)}
.gantt-tooltip-row{display:flex;justify-content:space-between;gap:12px;margin:3px 0;color:var(--text2)}
.gantt-tooltip-row span:first-child{color:var(--text3)}
.gantt-tooltip-conflict{margin-top:8px;padding-top:8px;border-top:1px solid var(--border);color:#ff6b35;font-weight:500}
.gantt-tooltip-overdue{color:#e53935;font-weight:500}
.gantt-milestone{position:absolute;width:16px;height:16px;transform:rotate(45deg) translateY(-50%);background:var(--accent);border:2px solid var(--bg2);box-shadow:0 2px 6px rgba(0,0,0,0.3);z-index:15;cursor:pointer;top:50%;margin-top:-8px}
.gantt-milestone:hover{transform:rotate(45deg) translateY(-50%) scale(1.15)}
.gantt-milestone.milestone-deadline{background:#e53935}
.gantt-milestone.milestone-delivery{background:#4caf50}
.gantt-milestone.milestone-review{background:#ff9800}
.gantt-milestone.milestone-custom{background:#9c27b0}
.gantt-dependency{position:absolute;pointer-events:none;z-index:5}
.gantt-dependency line{stroke:var(--text-muted);stroke-width:1.5}
.gantt-dependency polygon{fill:var(--text-muted)}
.gantt-today-line{position:absolute;top:0;bottom:0;width:2px;background:#e53935;z-index:20;pointer-events:none}
.gantt-color-popup{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;display:none;min-width:160px}
.gantt-color-popup.open{display:block}
.gantt-date-popup{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;display:none;min-width:180px}
.gantt-date-popup.open{display:block}
.gantt-date-popup-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px}
.gantt-date-popup-input{width:100%;background:var(--bg);border:1px solid var(--bg4);border-radius:6px;padding:8px 10px;font-size:13px;color:var(--text);margin-bottom:10px}
.gantt-date-popup-input:focus{outline:none;border-color:var(--accent)}
.gantt-date-popup-btns{display:flex;gap:8px;justify-content:flex-end}
.gantt-color-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px}
.gantt-color-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.gantt-color-swatch{width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.gantt-color-swatch:hover{transform:scale(1.15);border-color:var(--text)}
.gantt-color-swatch.selected{border-color:var(--text);box-shadow:0 0 0 2px var(--bg2),0 0 0 4px var(--text)}
.ai-modal{max-width:720px;width:95vw}
/* AI Console Window - Matching app design */
.cmd-window{position:fixed;z-index:9500;background:var(--bg2);border:1px solid var(--border-strong);border-radius:12px;box-shadow:var(--shadow),0 0 0 1px var(--border);display:none;flex-direction:column;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;width:2100px;height:1200px;min-width:800px;min-height:500px;resize:both;overflow:hidden}
.cmd-window.open{display:flex}
.cmd-window.minimized{display:none}
.cmd-titlebar{display:flex;align-items:center;background:var(--bg3);padding:10px 16px;cursor:move;user-select:none;border-bottom:1px solid var(--border);flex-shrink:0;border-radius:12px 12px 0 0}
.cmd-icon{color:var(--accent-main);font-size:14px;margin-right:10px}
.cmd-title{flex:1;color:var(--text);font-size:13px;font-weight:500}
.cmd-controls{display:flex;gap:4px;align-items:center}
.cmd-ctrl-btn{background:transparent;border:none;color:var(--text3);width:32px;height:28px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .15s}
.cmd-ctrl-btn:hover{background:var(--bg);color:var(--text)}
.cmd-ctrl-btn:last-child:hover{background:var(--red);color:#fff}
.cmd-body{flex:1;overflow-y:auto;padding:20px 24px;color:var(--text);font-size:13px;line-height:1.6;background:var(--bg2)}
.cmd-body::-webkit-scrollbar{width:8px}
.cmd-body::-webkit-scrollbar-track{background:transparent}
.cmd-body::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:4px}
.cmd-body::-webkit-scrollbar-thumb:hover{background:var(--text3)}
.cmd-line{margin:6px 0;white-space:pre-wrap;word-break:break-word}
.cmd-line.prompt{color:var(--accent);font-weight:500;margin-top:16px}
.cmd-line.response{color:var(--text)}
.cmd-line.error{color:var(--red);background:rgba(192,112,112,0.08);padding:10px 14px;border-radius:8px;border-left:3px solid var(--red)}
.cmd-line.success{color:var(--green)}
.cmd-line.warning{color:var(--yellow)}
.cmd-line.info{color:var(--cyan)}
.cmd-line.muted{color:var(--text3);font-style:italic}
.cmd-link{color:var(--accent);text-decoration:underline;text-decoration-color:rgba(90,154,200,0.4);text-underline-offset:2px;cursor:pointer;transition:all .15s}
.cmd-link:hover{color:var(--accent-hover);text-decoration-color:rgba(90,154,200,0.7)}
.cmd-input-row{display:flex;align-items:center;padding:12px 20px;background:var(--bg3);border-top:1px solid var(--border);flex-shrink:0;gap:12px}
.cmd-prompt{color:var(--accent);font-size:13px;font-weight:500}
.cmd-input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:13px;padding:10px 14px;outline:none;transition:all .15s}
.cmd-input:focus{border-color:var(--accent);background:var(--bg)}
.cmd-input::placeholder{color:var(--text3)}
.cmd-suggestions{display:flex;flex-wrap:wrap;gap:8px;padding:14px 20px;background:var(--bg3);border-top:1px solid var(--border);flex-shrink:0}
.cmd-suggestion{background:var(--bg);border:1px solid var(--border);color:var(--text2);padding:8px 14px;font-size:12px;border-radius:6px;cursor:pointer;font-family:inherit;transition:all .15s}
.cmd-suggestion:hover{background:var(--bg3);border-color:var(--accent);color:var(--text)}
.cmd-btn-row{display:flex;gap:8px;margin-left:auto}
.cmd-btn{background:var(--bg);border:1px solid var(--border);color:var(--text2);padding:8px 16px;font-size:12px;cursor:pointer;font-family:inherit;border-radius:6px;transition:all .15s}
.cmd-btn:hover{background:var(--bg3);color:var(--text)}
.cmd-btn.primary{background:var(--btn-primary-bg);border-color:var(--btn-primary-bg);color:var(--btn-primary-text)}
.cmd-btn.primary:hover{opacity:0.9}
/* Minimized state */
.cmd-minimized{display:none;padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin:8px;cursor:pointer;font-size:11px;color:var(--text2)}
.cmd-minimized:hover{background:var(--bg3);border-color:var(--border-strong)}
.cmd-minimized.active{display:flex;align-items:center;gap:8px}
.cmd-minimized-icon{color:var(--accent-main)}
.cmd-minimized-title{flex:1}
/* Model selector */
.cmd-model-row{display:flex;align-items:center;gap:8px;padding:6px 0;margin-bottom:12px;border-bottom:1px solid var(--border)}
.cmd-model-label{color:var(--text3);font-size:11px}
.cmd-model-select{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-family:inherit;font-size:11px;padding:4px 8px;cursor:pointer}
.cmd-model-select:hover{border-color:var(--border-strong)}
/* Suggested questions */
.cmd-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0;padding:14px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.cmd-suggestion{background:var(--bg);border:1px solid var(--border);color:var(--text2);padding:8px 14px;font-size:12px;cursor:pointer;font-family:inherit;border-radius:6px;transition:all .15s}
.cmd-suggestion:hover{background:var(--bg3);border-color:var(--accent);color:var(--text)}
/* Structured response styles */
.cmd-section{margin:12px 0;padding:12px 0;border-bottom:1px solid var(--border)}
.cmd-section:last-child{border-bottom:none}
.cmd-section-header{color:var(--accent);font-weight:600;margin-bottom:8px;font-size:12px}
.cmd-bullet{color:var(--text3);margin-right:8px}
.ai-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text3)}
.ai-loading-spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
@keyframes spin{to{transform:rotate(360deg)}}
.ai-loading-text{font-size:13px;color:var(--text3)}
.ai-loading-sub{font-size:11px;color:var(--text-muted);margin-top:6px}
.ai-report{font-size:13px;line-height:1.6}
.ai-report-section{margin-bottom:20px}
.ai-report-header{display:flex;align-items:center;gap:10px;font-weight:600;font-size:13px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border);color:var(--text)}
.ai-report-header-icon{font-size:14px}
.ai-report-items{display:flex;flex-direction:column;gap:8px}
.ai-report-item{display:flex;gap:10px;padding:12px 14px;background:var(--bg);border-radius:8px;font-size:12px;align-items:flex-start}
.ai-report-item.critical{border-left:3px solid var(--red)}
.ai-report-item.warning{border-left:3px solid var(--yellow)}
.ai-report-item.info{border-left:3px solid var(--cyan)}
.ai-report-item.success{border-left:3px solid var(--green)}
.ai-report-bullet{flex-shrink:0;margin-top:2px}
.ai-report-text{flex:1;color:var(--text)}
.ai-report-meta{font-size:11px;color:var(--text3);margin-top:4px}
.ai-summary{background:var(--bg);padding:14px 16px;border-radius:8px;margin-bottom:20px;font-size:13px;line-height:1.6;border-left:3px solid var(--accent);color:var(--text)}
.ai-error{text-align:center;padding:30px;color:var(--text3)}
.ai-error-icon{font-size:24px;margin-bottom:8px}
.ai-error-msg{font-size:12px;margin-bottom:12px}
.ai-insights-list{display:flex;flex-direction:column;gap:8px}
.ai-insight{display:flex;gap:10px;padding:10px;background:var(--bg);border-radius:6px;border-left:3px solid var(--border);cursor:pointer}
.ai-insight:hover{background:var(--bg3)}
.ai-insight.critical{border-color:var(--red)}.ai-insight.warning{border-color:var(--yellow)}.ai-insight.info{border-color:var(--cyan)}.ai-insight.success{border-color:var(--green)}
.ai-insight-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.ai-insight.critical .ai-insight-icon{background:rgba(201,74,74,.15);color:var(--red)}.ai-insight.warning .ai-insight-icon{background:rgba(201,162,39,.15);color:var(--yellow)}.ai-insight.info .ai-insight-icon{background:rgba(58,168,168,.15);color:var(--cyan)}.ai-insight.success .ai-insight-icon{background:rgba(61,181,114,.15);color:var(--green)}
.ai-insight-content{flex:1}
.ai-insight-title{font-size:12px;font-weight:600;margin-bottom:2px}
.ai-insight-desc{font-size:10px;color:var(--text2)}
.ai-insight-action{font-size:9px;color:var(--accent);margin-top:4px}
.ai-timestamp{font-size:9px;color:var(--text3);text-align:right;margin-top:12px;padding-top:8px;border-top:1px solid var(--border)}
.ai-source{font-size:10px;color:var(--text3);text-align:center;padding:6px;margin-bottom:12px;background:var(--bg);border-radius:6px}
.report-model-badge{font-size:10px;color:var(--text3);background:var(--bg3);padding:4px 10px;border-radius:6px;font-weight:500}
.report-refresh-btn{background:transparent;border:none;color:var(--text3);font-size:18px;cursor:pointer;width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.report-refresh-btn:hover{background:var(--bg3);color:var(--text)}
.report-refresh-btn.spinning{animation:spin 1s linear infinite}
.report-refresh-btn:disabled{opacity:0.3;cursor:not-allowed}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.report-content{font-size:14px;line-height:1.7;color:var(--text);flex:1;overflow-y:auto;padding:12px 0}
.report-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--text3)}
.report-loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
.report-loading-text{font-size:13px}
.report-empty{display:flex;align-items:center;justify-content:center;flex:1}
.report-generate-btn{background:var(--accent-main);color:white;border:none;padding:14px 28px;border-radius:12px;font-size:15px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .2s;box-shadow:0 2px 8px rgba(216,119,86,0.3)}
.report-generate-btn:hover{filter:brightness(1.1);transform:translateY(-1px);box-shadow:0 4px 12px rgba(216,119,86,0.4)}
.report-generate-btn svg{opacity:0.9}
.report-section{margin-bottom:20px}
.report-section-title{font-size:13px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.report-prose{font-size:14px;line-height:1.75;padding:8px 0;flex:1}
.report-prose p{margin-bottom:14px}
.report-prose ul{margin:10px 0;padding-left:24px}
.report-prose li{margin-bottom:8px}
.report-prose strong{color:var(--text)}
.report-prose h1,.report-prose h2,.report-prose h3{color:var(--accent);margin:20px 0 12px 0}
.report-prose h1{font-size:18px}
.report-prose h2{font-size:16px}
.report-prose h3{font-size:14px}
.report-meta{font-size:11px;color:var(--text3);margin-bottom:14px;display:flex;justify-content:space-between;padding:0 2px}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);justify-content:center;align-items:center;z-index:1000;padding:20px}
.modal-bg.open{display:flex}

/* Small contextual popover */
.popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;padding:20px;min-width:220px;max-width:300px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.popover-msg{font-size:14px;margin-bottom:14px;line-height:1.5;color:var(--text)}
.popover-btns{display:flex;gap:10px;justify-content:flex-end}
.popover-btns .btn{padding:8px 14px;font-size:13px;min-width:70px}

/* Backdrop overlay for popovers */
.popover-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:999;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
.popover-backdrop.active{opacity:1;pointer-events:auto}

/* Popover-style modal (positioned near trigger) */
.modal-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:360px;max-width:calc(100vw - 40px);max-height:calc(100vh - 100px);overflow:auto;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.modal-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.modal-popover .modal-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:transparent}
.modal-popover .modal-title{font-size:15px;font-weight:600;letter-spacing:-0.2px}
.modal-popover .modal-close{background:var(--bg3);border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:0;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.modal-popover .modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-popover .modal-body{padding:20px}
.modal-popover .modal-foot{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:transparent}
.modal-popover .field{margin-bottom:16px}
.modal-popover .field-label{font-size:11px;font-weight:600;margin-bottom:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.modal-popover .field-input,.modal-popover .field-select,.modal-popover .field-textarea{width:100%;padding:12px 14px;font-size:14px;font-weight:430;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);transition:border-color .15s,box-shadow .15s}
.modal-popover .field-input:focus,.modal-popover .field-select:focus,.modal-popover .field-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(138,186,220,0.15)}
.modal-popover .field-textarea{min-height:80px;resize:vertical}
.modal-popover .field-row{display:flex;gap:14px}
.modal-popover .field-row .field{flex:1;margin-bottom:16px}
.modal-popover .btn{padding:10px 16px;font-size:13px;font-weight:550;border-radius:10px}
.report-popover{position:fixed;top:51px;right:0;bottom:0;width:calc(100vw - 240px);max-width:1000px;opacity:0;transform:translateX(20px);display:flex;flex-direction:column;border-radius:16px 0 0 16px;border-left:1px solid var(--border);border-top:none;border-right:none;border-bottom:none}
.report-popover.open{transform:translateX(0);opacity:1}
.report-popover .modal-head{gap:8px;flex-shrink:0;border-radius:16px 0 0 0}
.report-popover .modal-body{flex:1;overflow:hidden;display:flex;flex-direction:column;padding:0 20px 10px}
.report-popover .modal-foot{flex-shrink:0;border-radius:0 0 0 16px;display:flex;justify-content:center}
.report-popover .modal-foot .btn{min-width:200px}
.report-model-select{font-size:11px;background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:500;margin-right:auto}
.report-model-select:hover{background:var(--bg4);border-color:var(--border-strong)}

/* Report Header */
.report-header{margin-bottom:24px}
.report-title{font-size:20px;font-weight:600;color:var(--text);margin-bottom:12px}
.report-header-row{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.report-status-badge{font-size:11px;font-weight:600;padding:5px 12px;border-radius:6px;text-transform:uppercase;letter-spacing:0.3px}
.report-status-badge.status-on-track{background:rgba(48,209,88,0.15);color:#30d158}
.report-status-badge.status-behind{background:rgba(255,159,10,0.15);color:#ff9f0a}
.report-status-badge.status-critical{background:rgba(255,69,58,0.15);color:#ff453a}
.report-date{font-size:12px;color:var(--text3)}
.report-days-left{font-size:12px;color:var(--text3);margin-left:auto}

/* Progress Bar */
.report-progress-container{margin-bottom:20px}
.report-progress-bar{height:8px;background:var(--bg4);border-radius:4px;position:relative;overflow:visible}
.report-progress-fill{height:100%;border-radius:4px;transition:width 0.3s}
.report-progress-fill.status-on-track{background:linear-gradient(90deg,#30d158,#34c759)}
.report-progress-fill.status-behind{background:linear-gradient(90deg,#ff9f0a,#ffcc00)}
.report-progress-fill.status-critical{background:linear-gradient(90deg,#ff453a,#ff6961)}
.report-progress-expected{position:absolute;top:-4px;bottom:-4px;width:2px;background:var(--text3);border-radius:1px}
.report-progress-expected::after{content:'Expected';position:absolute;top:14px;left:50%;transform:translateX(-50%);font-size:9px;color:var(--text3);white-space:nowrap}
.report-progress-labels{display:flex;justify-content:space-between;margin-top:8px;font-size:12px}
.report-progress-current{font-weight:600;color:var(--text)}
.report-progress-target{color:var(--text3)}

/* Pipeline Funnel */
.report-pipeline{margin-bottom:24px;padding:16px;background:var(--bg3);border-radius:12px}
.report-pipeline-title{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px}
.report-pipeline-row{display:flex;align-items:center;gap:12px;margin-bottom:6px}
.report-pipeline-row:last-child{margin-bottom:0}
.report-pipeline-label{font-size:12px;color:var(--text2);width:80px;flex-shrink:0}
.report-pipeline-bar-container{flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden}
.report-pipeline-bar{height:100%;border-radius:3px;transition:width 0.3s}
.report-pipeline-bar.s-waiting{background:var(--text3)}
.report-pipeline-bar.s-to-order{background:#ff9f0a}
.report-pipeline-bar.s-ordered{background:#5ac8fa}
.report-pipeline-bar.s-arrived{background:#bf5af2}
.report-pipeline-bar.s-tested{background:#64d2ff}
.report-pipeline-bar.s-configured{background:#30d158}
.report-pipeline-bar.s-installed{background:var(--accent)}
.report-pipeline-count{font-size:12px;font-weight:600;color:var(--text);width:32px;text-align:right}
.report-pipeline-note{font-size:10px;color:var(--yellow);margin-left:4px}

/* Summary */
.report-summary{font-size:14px;line-height:1.8;color:var(--text);margin-bottom:24px;padding:20px 24px;background:var(--bg3);border-radius:12px;border-left:3px solid var(--accent)}
.report-summary p{margin:0 0 12px 0}
.report-summary p:last-child{margin-bottom:0}

/* Clickable part links */
.report-part-link{color:var(--accent);cursor:pointer;text-decoration:none;border-bottom:1px dotted var(--accent);transition:all .15s}
.report-part-link:hover{color:var(--accent-hover);border-bottom-style:solid}

/* Section */
.report-section{margin-bottom:24px}
.report-section-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.report-section-icon{width:18px;height:18px;color:var(--text3)}
.report-section-title{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px}

/* Issues with Severity */
.report-issues{display:flex;flex-direction:column;gap:8px}
.report-issue{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;background:var(--bg3);border-radius:8px}
.report-severity{width:6px;height:6px;border-radius:50%;margin-top:6px;flex-shrink:0}
.report-severity.high{background:#ff453a;box-shadow:0 0 8px rgba(255,69,58,0.4)}
.report-severity.medium{background:#ff9f0a;box-shadow:0 0 8px rgba(255,159,10,0.3)}
.report-severity.low{background:#30d158}
.report-issue-text{font-size:13px;color:var(--text);line-height:1.5}

/* Next Moves by Owner */
.report-moves-group{margin-bottom:16px}
.report-moves-group:last-child{margin-bottom:0}
.report-moves-owner{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.report-moves-avatar{width:24px;height:24px;border-radius:50%;background:var(--accent);color:white;font-size:11px;font-weight:600;display:flex;align-items:center;justify-content:center}
.report-moves-name{font-size:13px;font-weight:600;color:var(--text)}
.report-moves-count{font-size:11px;color:var(--text3)}
.report-moves-list{margin-left:32px;display:flex;flex-direction:column;gap:6px}
.report-move-item{font-size:13px;color:var(--text2);padding:8px 12px;background:var(--bg3);border-radius:6px}

/* Lookahead Timeline */
.report-timeline{position:relative;padding:16px 0}
.report-timeline-line{position:absolute;top:24px;left:6px;right:6px;height:2px;background:var(--border)}
.report-timeline-items{display:flex;justify-content:space-between;position:relative}
.report-timeline-item{display:flex;flex-direction:column;align-items:center;text-align:center;flex:1;max-width:120px}
.report-timeline-dot{width:12px;height:12px;border-radius:50%;background:var(--bg2);border:2px solid var(--accent);margin-bottom:8px;position:relative;z-index:1}
.report-timeline-dot.today{background:var(--accent)}
.report-timeline-date{font-size:11px;font-weight:600;color:var(--text);margin-bottom:4px}
.report-timeline-event{font-size:10px;color:var(--text3);line-height:1.3}

/* Missing Info */
.report-missing{display:flex;flex-direction:column;gap:6px}
.report-missing-item{font-size:13px;color:var(--text2);padding:8px 12px;background:var(--bg3);border-radius:6px;border-left:2px solid var(--yellow)}

/* Timestamp */
.report-timestamp{font-size:11px;color:var(--text3);margin-top:24px;padding-top:16px;border-top:1px solid var(--border);text-align:center}

/* Portfolio Report Specific */
.portfolio-popover{width:700px;max-width:95vw}
.portfolio-popover .modal-body{padding:0 24px 10px}

/* Portfolio Header Stats */
.portfolio-stats{display:flex;gap:16px;margin-bottom:8px}
.portfolio-stat{font-size:12px;color:var(--text3)}
.portfolio-stat strong{color:var(--text);font-weight:600}

/* Project Cards */
.report-projects{display:flex;flex-direction:column;gap:10px;margin-bottom:24px}
.report-project-card{display:flex;align-items:stretch;background:var(--bg3);border-radius:10px;overflow:hidden;cursor:pointer;transition:all .15s}
.report-project-card:hover{background:var(--bg4);transform:translateX(2px)}
.report-project-status{width:4px;flex-shrink:0}
.report-project-status.on-track{background:#30d158}
.report-project-status.behind{background:#ff9f0a}
.report-project-status.critical{background:#ff453a}
.report-project-content{flex:1;padding:12px 14px;min-width:0}
.report-project-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.report-project-name{font-size:14px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.report-project-progress{display:flex;align-items:center;gap:8px;margin-left:auto;flex-shrink:0}
.report-project-pct{font-size:13px;font-weight:600;color:var(--text)}
.report-project-days{font-size:11px;color:var(--text3);padding:2px 6px;background:var(--bg2);border-radius:4px}
.report-project-bar{width:100px;height:4px;background:var(--bg2);border-radius:2px;overflow:hidden}
.report-project-bar-fill{height:100%;border-radius:2px}
.report-project-bar-fill.on-track{background:#30d158}
.report-project-bar-fill.behind{background:#ff9f0a}
.report-project-bar-fill.critical{background:#ff453a}
.report-project-highlight{font-size:12px;color:var(--text2);line-height:1.4}
.report-project-arrow{display:flex;align-items:center;padding:0 12px;color:var(--text3)}
.report-project-card:hover .report-project-arrow{color:var(--accent)}

/* Deadline Timeline with Risk */
.report-deadline-item{display:flex;flex-direction:column;align-items:center;text-align:center;flex:1;max-width:140px}
.report-deadline-risk{font-size:9px;font-weight:600;padding:2px 6px;border-radius:4px;margin-top:4px}
.report-deadline-risk.low{background:rgba(48,209,88,0.15);color:#30d158}
.report-deadline-risk.medium{background:rgba(255,159,10,0.15);color:#ff9f0a}
.report-deadline-risk.high{background:rgba(255,69,58,0.15);color:#ff453a}

.modal-popover .notify-btn{width:100%;padding:12px;font-size:12px;margin-top:10px}

/* AI popover specific - Claude UI style */
.ai-popover{width:640px;max-width:calc(100vw - 40px);background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.15);max-height:calc(100vh - 100px);display:flex;flex-direction:column}
.ai-popover .modal-body{padding:0;display:flex;flex-direction:column;flex:1;overflow:hidden}
.ai-popover .modal-head{display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);padding:14px 18px;flex-shrink:0;background:var(--bg2)}
.ai-popover .modal-title{flex:1;font-size:15px;font-weight:550;color:var(--text2)}
.ai-popover .modal-close{background:transparent;color:var(--text3);width:28px;height:28px;font-size:16px;border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ai-popover .modal-close:hover{background:var(--bg4);color:var(--text)}
.ai-title-icon{color:#c4956a;font-size:14px;margin-right:4px}
.ai-model-badge{font-size:11px;color:var(--text3);font-family:inherit;background:var(--bg3);padding:6px 12px;border-radius:8px;font-weight:500;border:1px solid var(--border);cursor:pointer;transition:all .15s}
.ai-model-badge:hover{background:var(--bg4);border-color:var(--border-strong)}
.ai-model-selector{position:relative}
.ai-model-dropdown{position:absolute;top:100%;right:0;margin-top:6px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:10;min-width:160px;padding:6px;opacity:0;transform:translateY(-8px);pointer-events:none;transition:all .15s}
.ai-model-dropdown.open{opacity:1;transform:translateY(0);pointer-events:auto}
.ai-model-option{display:flex;flex-direction:column;align-items:flex-start;width:100%;padding:10px 12px;background:transparent;border:none;border-radius:6px;cursor:pointer;text-align:left;transition:all .1s}
.ai-model-option:hover{background:var(--bg3)}
.ai-model-option.active{background:var(--accent);color:#fff}
.ai-model-option .model-name{font-size:12px;font-weight:600;color:var(--text)}
.ai-model-option .model-desc{font-size:10px;color:var(--text3);margin-top:2px}
.ai-model-option.active .model-name,.ai-model-option.active .model-desc{color:#fff}
.thinking-pulse{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.ai-model-selector-ws{position:relative}
.ai-model-badge-ws{font-size:11px;color:var(--text3);background:transparent;padding:6px 10px;border-radius:8px;font-weight:500;border:none;cursor:pointer;transition:all .15s;white-space:nowrap}
.ai-model-badge-ws:hover{background:var(--bg3);color:var(--text2)}
.ai-model-dropdown-ws{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:8px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:10;min-width:160px;padding:6px;opacity:0;pointer-events:none;transition:all .15s}
.ai-model-dropdown-ws.open{opacity:1;pointer-events:auto}
.ai-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:24px;background:var(--bg);-webkit-overflow-scrolling:touch;min-height:200px}
.ai-welcome{color:var(--text3);font-size:13px;line-height:1.6}
.ai-welcome p{margin:0}
.ai-welcome strong{color:var(--text);font-weight:600}
.ai-dashboard{display:flex;flex-direction:column;gap:8px}
.ai-insights-list{display:flex;flex-direction:column;gap:6px}
.ai-insight-card{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg);border-radius:8px;cursor:pointer;transition:all .15s;border-left:3px solid var(--border)}
.ai-insight-card:hover{background:var(--bg3);transform:translateX(2px)}
.ai-insight-card.positive{border-left-color:var(--green)}
.ai-insight-card.warning{border-left-color:var(--yellow)}
.ai-insight-card.negative{border-left-color:var(--red)}
.ai-insight-card.neutral{border-left-color:var(--accent)}
.ai-insight-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--text2);background:var(--bg2);border-radius:6px;flex-shrink:0}
.ai-insight-card.positive .ai-insight-icon{color:var(--green)}
.ai-insight-card.warning .ai-insight-icon{color:var(--yellow)}
.ai-insight-card.negative .ai-insight-icon{color:var(--red)}
.ai-insight-body{flex:1;min-width:0}
.ai-insight-title{font-size:13px;font-weight:500;color:var(--text);margin-bottom:2px}
.ai-insight-detail{font-size:11px;color:var(--text3)}
.ai-insight-arrow{color:var(--text3);font-size:11px;opacity:0;transition:opacity .15s}
.ai-insight-card:hover .ai-insight-arrow{opacity:1}
.ai-dashboard-hint{font-size:10px;color:var(--text-muted);text-align:center;padding-top:10px;border-top:1px solid var(--border);margin-top:6px}
.ai-prose{font-size:13px;line-height:1.7;color:var(--text)}
.ai-model-attribution{font-size:10px;color:var(--text3);text-align:right;margin-top:14px;padding-top:10px;border-top:1px solid var(--border);cursor:help}
.ai-prose p{margin-bottom:14px}
.ai-prose p:last-child{margin-bottom:0}
.ai-prose strong{color:var(--text);font-weight:600}
.ai-prose ul,.ai-prose ol{margin:12px 0 18px 0;padding-left:0;list-style:none}
.ai-prose li{margin:8px 0;padding:12px 14px 12px 32px;position:relative;line-height:1.6;background:var(--bg);border-radius:8px;border-left:3px solid var(--accent)}
.ai-prose li::before{content:'â†’';position:absolute;left:12px;color:var(--accent);font-size:12px}
.ai-section-header{font-size:11px;font-weight:600;color:var(--accent);letter-spacing:0.5px;text-transform:uppercase;margin:24px 0 12px 0;padding-bottom:6px;border-bottom:1px solid var(--border)}
.ai-section-header:first-child{margin-top:0}
.ai-part-link{color:var(--accent);cursor:pointer;text-decoration:underline;text-decoration-color:rgba(90,154,200,0.4);text-underline-offset:2px;transition:all .15s}
.ai-part-link:hover{color:var(--accent-hover);text-decoration-color:rgba(90,154,200,0.7)}
.ai-asm-link{color:var(--cyan);cursor:pointer;text-decoration:underline;text-decoration-color:rgba(106,160,170,0.4);text-underline-offset:2px;transition:all .15s}
.ai-asm-link:hover{color:var(--cyan);text-decoration-color:rgba(106,160,170,0.7)}
.ai-visual{margin:12px 0;padding:16px;background:var(--bg);border-radius:8px;display:flex;justify-content:center}
.ai-mini-chart{max-width:100%}
.ai-action-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;margin:8px 4px 8px 0;font-size:12px;font-weight:500;color:var(--accent);background:rgba(90,154,200,0.08);border:1px solid rgba(90,154,200,0.2);border-radius:6px;cursor:pointer;transition:all .15s}
.ai-action-btn:hover{background:rgba(90,154,200,0.15);border-color:rgba(90,154,200,0.4)}
.ai-input-row{display:flex;align-items:center;gap:12px;padding:14px 20px;background:var(--bg3);border-radius:0 0 12px 12px;border-top:1px solid var(--border)}
.ai-input-row input{flex:1;height:40px;padding:0 16px;font-size:13px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);transition:all .15s}
.ai-input-row input:focus{outline:none;border-color:var(--accent)}
.ai-input-row input::placeholder{color:var(--text3)}
.ai-input-row .btn{height:36px;padding:0 16px;font-size:13px;font-weight:500;border-radius:8px;min-width:auto}
.ai-input-row .btn:first-of-type{background:transparent;color:var(--text2);border:1px solid var(--border)}
.ai-input-row .btn:first-of-type:hover{background:var(--bg);color:var(--text)}

/* AI Workspace - Full Panel */
.ai-workspace{display:none;flex-direction:column;position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg2);z-index:10}
.ai-workspace.active{display:flex}
.ai-workspace-conversation{flex:1;overflow-y:auto;padding:32px 24px 24px;display:flex;justify-content:center}
.ai-workspace-conversation-inner{max-width:800px;width:100%}
.ai-welcome-minimal{color:var(--text3);font-size:14px;padding:60px 20px;text-align:center}
.ai-workspace-input-wrap{padding:0 24px 24px;margin-top:20px;width:100%;box-sizing:border-box}
.ai-workspace-input{display:flex;align-items:flex-end;gap:0;max-width:800px;width:100%;margin:0 auto;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px 12px 10px 18px}
.ai-workspace-input textarea{flex:1;border:none;background:transparent;color:var(--text);font-size:14px;line-height:1.5;resize:none;max-height:140px;padding:8px 0;font-family:inherit}
.ai-workspace-input textarea:focus{outline:none}
.ai-workspace-input textarea::placeholder{color:var(--text3)}
.ai-input-actions{display:flex;align-items:center;gap:4px}
.ai-input-btn{width:34px;height:34px;border-radius:8px;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all .15s}
.ai-input-btn:hover{background:var(--bg3);color:var(--text)}
.ai-send-btn{width:34px;height:34px;border-radius:8px;background:var(--accent);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;transition:all .15s}
.ai-send-btn:hover{background:var(--accent-hover)}
.ai-msg{margin-bottom:24px;display:block;clear:both}
.ai-msg-user{display:flex;justify-content:flex-end}
.ai-msg-user .ai-msg-content{background:var(--bg3);color:var(--text);border-radius:12px;padding:12px 16px;max-width:80%;font-size:13px;line-height:1.5}
.ai-msg-assistant{display:block;margin-top:28px}
.ai-msg-thinking{margin-top:36px}
.ai-msg-assistant .ai-msg-content{color:var(--text);font-size:13px;line-height:1.7}
.ai-msg-assistant .ai-msg-content p{margin:0 0 14px 0}
.ai-msg-assistant .ai-msg-content p:last-child{margin-bottom:0}
.ai-msg-assistant .ai-msg-content ul{margin:12px 0;padding-left:24px}
.ai-msg-assistant .ai-msg-content li{margin:6px 0}
.ai-msg-assistant .ai-msg-content strong{color:var(--text);font-weight:600}
.ai-welcome-insights{display:flex;flex-direction:column;gap:10px;margin:24px 0}
.ai-welcome-insight{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s}
.ai-welcome-insight:hover{background:var(--bg3);border-color:var(--border-strong)}
.ai-welcome-insight.critical{border-left:3px solid var(--red)}
.ai-welcome-insight.warning{border-left:3px solid var(--yellow)}
.ai-welcome-insight.info{border-left:3px solid var(--cyan)}
.ai-welcome-insight.success{border-left:3px solid var(--green)}
.ai-welcome-insight-icon{font-size:16px;line-height:1}
.ai-welcome-insight-text{flex:1}
.ai-welcome-insight-title{font-size:14px;font-weight:500;color:var(--text);margin-bottom:2px}
.ai-welcome-insight-desc{font-size:12px;color:var(--text3)}
.ai-welcome-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:24px;justify-content:center}
.ai-suggest-btn{padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:20px;font-size:13px;color:var(--text2);cursor:pointer;transition:all .15s}
.ai-suggest-btn:hover{background:var(--bg3);color:var(--text);border-color:var(--text3)}

/* Thinking indicator - pulsating dot */
.ai-thinking-orb{position:relative;width:28px;height:28px;border-radius:50%;background:var(--accent-main);display:flex;align-items:center;justify-content:center}
.ai-thinking-plus{width:12px;height:12px;position:relative;animation:icon-spin-fast 0.08s linear infinite}
.ai-thinking-plus::before,.ai-thinking-plus::after{content:'';position:absolute;background:white;border-radius:50%;width:10px;height:10px;top:50%;left:50%;transform:translate(-50%,-50%);animation:dot-pulse 1.5s ease-in-out infinite}

.ai-visual{margin:20px 0;display:block;clear:both}
.ai-mini-chart{background:var(--bg2);border-radius:12px;border:1px solid var(--border);display:block}
.ai-action-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;cursor:pointer;transition:all .15s;margin:8px 8px 8px 0}
.ai-action-btn:hover{background:var(--bg3);border-color:var(--text3)}
.ai-action-btn svg{opacity:0.6;flex-shrink:0}
.ai-action-btn:hover svg{opacity:1}
.ai-part-link,.ai-asm-link{color:var(--accent);text-decoration:none;border-bottom:1px solid transparent}
.ai-part-link:hover,.ai-asm-link:hover{border-bottom-color:var(--accent)}
.btn-tell{background:var(--accent-main);color:white;border:none;border-radius:9px}
.btn-tell:hover{opacity:0.9}
.ai-conversation{display:flex;flex-direction:column;gap:28px}
.ai-message{font-size:15px;line-height:1.8}
.ai-message.user{color:#888;font-size:14px}
.ai-user-label{color:#60a5fa;font-weight:500}
.ai-message.assistant{color:#e0e0e0}
.ai-message.assistant p{margin:0 0 16px 0}
.ai-message.assistant p:last-child{margin-bottom:0}
.modal{background:var(--bg2);width:100%;max-width:400px;max-height:85vh;overflow-y:auto;border-radius:16px;border:none;box-shadow:0 16px 48px rgba(0,0,0,.25);-webkit-overflow-scrolling:touch}
.modal-head{padding:16px 18px;display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px;letter-spacing:-0.2px}
.modal-close{width:28px;height:28px;background:var(--bg3);border:none;border-radius:8px;color:var(--text2);font-size:14px;cursor:pointer;transition:all .15s}
.modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-body{padding:4px 18px 18px}
.modal-foot{padding:14px 18px;background:var(--bg3);display:flex;gap:8px;border-radius:0 0 14px 14px}
.modal-foot .btn{flex:1;height:36px}
.field{margin-bottom:14px}
.field-label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:6px;letter-spacing:0.2px}
.field-input,.field-select,.field-textarea{width:100%;height:38px;padding:0 12px;font-size:14px;color:var(--text);background:var(--bg);border:none;border-radius:10px}
.field-input:focus,.field-select:focus{outline:none;box-shadow:0 0 0 3px rgba(10,132,255,.3)}
.field-input[type="date"]{cursor:pointer;padding-right:12px;color-scheme:dark}
.field-input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer;filter:invert(0.8);opacity:1;width:24px;height:24px;padding:4px;border-radius:4px;background-color:var(--bg3)}
.field-input[type="date"]::-webkit-calendar-picker-indicator:hover{background-color:var(--bg4)}
.field-textarea{height:60px;padding:10px 12px;resize:none}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.notify-btn{width:100%;height:38px;margin-top:14px;background:var(--bg3);border:none;border-radius:10px;color:var(--yellow);font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
.notify-btn:hover{background:var(--bg4)}.notify-btn:disabled{opacity:.4;cursor:not-allowed}

/* Login Screen - Clean minimal style */
.login-screen{position:fixed;inset:0;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;padding:20px}
.login-box{background:#f5f5f4;border-radius:16px;padding:28px 24px;width:100%;max-width:320px;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.login-logo{font-size:15px;font-weight:500;text-align:center;margin-bottom:20px;color:#1a1a1a;letter-spacing:-0.2px}
.login-subtitle{display:none}
.login-icon{display:none}
.login-divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:#888;font-size:12px}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:#ddd}
.login-field{margin-bottom:12px}
.login-field label{display:none}
.login-field input{width:100%;height:44px;padding:0 14px;font-size:14px;color:#1a1a1a;background:#fff;border:1px solid #d4d4d4;border-radius:8px;outline:none;transition:border-color .15s}
.login-field input::placeholder{color:#888}
.login-field input:focus{border-color:#1a1a1a}
.login-btn{width:100%;height:44px;font-size:14px;font-weight:500;color:#fff;background:#1a1a1a;border:none;border-radius:8px;cursor:pointer;transition:all .15s}
.login-btn:hover{background:#333}
.login-btn:active{transform:scale(0.98)}
.login-btn:disabled{opacity:0.5;cursor:not-allowed}
.login-btn-outline{width:100%;height:44px;font-size:14px;font-weight:500;color:#1a1a1a;background:#fff;border:1px solid #d4d4d4;border-radius:8px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px}
.login-btn-outline:hover{background:#f9f9f9;border-color:#bbb}
.login-btn-outline svg{width:18px;height:18px}
.login-footer{font-size:11px;color:#888;text-align:center;margin-top:16px;line-height:1.5}
.login-footer a{color:#666;text-decoration:underline}
.login-error{color:#dc2626;font-size:12px;text-align:center;margin-top:8px;min-height:16px}
.login-status{font-size:11px;color:#888;text-align:center;margin-top:16px}
.sync-indicator{position:fixed;top:62px;right:74px;padding:6px 12px;background:var(--bg2);border-radius:8px;font-size:11px;color:var(--text2);display:flex;align-items:center;gap:6px;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.2);opacity:0;transform:translateY(-5px);transition:opacity 0.4s ease,transform 0.4s ease;pointer-events:none}
.sync-indicator.active{opacity:1;transform:translateY(0);pointer-events:auto}
.sync-indicator.syncing{color:var(--yellow)}
.sync-indicator.syncing .sync-dot{animation:spin 1s linear infinite;border:2px solid var(--yellow);border-top-color:transparent;background:transparent}
.sync-indicator.synced{color:var(--green)}
.sync-indicator.offline{color:var(--red)}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.offline-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:2001;padding:20px}
.offline-overlay.active{display:flex}
.offline-box{background:#f5f5f4;border-radius:20px;padding:40px 32px;width:100%;max-width:360px;box-shadow:0 12px 48px rgba(0,0,0,.3);text-align:center}
.offline-icon{margin-bottom:20px;color:#c07070}
.offline-title{font-size:20px;font-weight:600;color:#1a1a1a;margin-bottom:8px}
.offline-message{font-size:14px;color:#666;margin-bottom:24px}
.offline-spinner{width:32px;height:32px;border:3px solid #e0e0e0;border-top-color:#c07070;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
.offline-hint{font-size:12px;color:#888;line-height:1.5}
.offline-pending{font-size:13px;font-weight:600;color:#1a1a1a;margin-bottom:16px;padding:8px 16px;background:#e8e8e8;border-radius:8px}

/* Online indicator */
.online-badge{display:flex;align-items:center;gap:6px;padding:5px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text2);position:relative;cursor:pointer}
.online-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* Chat Panel */
/* Online hover card */
.online-hover{position:absolute;top:100%;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:400;display:none}
.online-badge:hover .online-hover{display:block}
.online-user{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px}
.online-user-dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.online-user-name{flex:1;color:var(--text)}
.online-user-time{font-size:10px;color:var(--text3)}

/* Activity Log */
.activity-log{display:flex;flex-direction:column;gap:2px;max-height:180px;overflow-y:auto}
.activity-item{display:flex;align-items:center;gap:10px;padding:6px 12px;font-size:11px;color:var(--text2);border-radius:6px;cursor:default}
.activity-item:hover{background:var(--bg2)}
.activity-icon{width:14px;height:14px;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:var(--text3)}
.activity-icon svg{display:block}
.activity-text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.activity-time{color:var(--text-muted);font-size:10px;flex-shrink:0}
.activity-view-all{background:transparent;border:none;color:var(--accent);font-size:11px;padding:8px 12px;cursor:pointer;text-align:left;border-radius:6px}
.activity-view-all:hover{background:var(--bg2)}
.activity-empty{padding:12px;font-size:11px;color:var(--text-muted);text-align:center}
.activity-modal{width:400px;max-height:500px;display:flex;flex-direction:column;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.98);opacity:0}
.activity-modal.open{transform:translate(-50%,-50%) scale(1);opacity:1}
.activity-modal .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border)}
.activity-modal .modal-header span{font-weight:600;font-size:14px}
.activity-modal .modal-close{background:none;border:none;font-size:20px;color:var(--text3);cursor:pointer;padding:4px 8px;border-radius:4px}
.activity-modal .modal-close:hover{background:var(--bg3);color:var(--text)}
.activity-filters{display:flex;gap:4px;padding:12px 16px;border-bottom:1px solid var(--border)}
.activity-filter{background:transparent;border:1px solid var(--border);color:var(--text2);font-size:11px;padding:4px 10px;border-radius:12px;cursor:pointer}
.activity-filter:hover{background:var(--bg2)}
.activity-filter.active{background:var(--accent);border-color:var(--accent);color:white}
.activity-list{flex:1;overflow-y:auto;padding:8px}
.activity-list .activity-item{padding:10px 12px}
.activity-list .activity-time{min-width:60px;text-align:right}

/* Part comments */
.comment-btn{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;padding:2px 4px;border-radius:4px;display:flex;align-items:center;gap:3px}
.comment-btn:hover{color:var(--accent);background:var(--bg4)}
.comment-btn.has-comments{color:var(--accent)}
.comment-count{font-size:10px}
.comments-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:320px;max-height:400px;display:flex;flex-direction:column;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.comments-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.comments-header{padding:14px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center;color:var(--text)}
.comments-header button{background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px}
.comments-header button:hover{background:var(--bg3);color:var(--text)}
.comments-list{flex:1;overflow-y:auto;padding:12px;max-height:240px}
.comment-item{padding:10px 12px;background:var(--bg);border-radius:10px;margin-bottom:8px;font-size:12px}
.comment-item:last-child{margin-bottom:0}
.comment-author{font-weight:600;color:var(--accent);margin-bottom:2px}
.comment-text{color:var(--text);line-height:1.4}
.comment-time{font-size:9px;color:var(--text3);margin-top:4px}
.comments-input{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px}
.comments-input input{flex:1;height:36px;padding:0 12px;font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)}
.comments-input input:focus{border-color:var(--accent);outline:none}
.comments-input button{padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:500;cursor:pointer;transition:background .15s}
.comments-input button:hover{background:var(--accent-hover)}
.comments-empty{text-align:center;color:var(--text3);padding:30px 20px;font-size:12px;font-style:italic}

/* Item Code Configuration */
.item-config-list{max-height:300px;overflow-y:auto;margin:12px 0;border:1px solid var(--border);border-radius:8px}
.item-config-row{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);align-items:center}
.item-config-row:last-child{border-bottom:none}
.item-config-row.header{background:var(--bg3);font-weight:600;font-size:11px;color:var(--text2);position:sticky;top:0}
.item-config-code{font-weight:500;font-size:12px}
.item-config-code small{display:block;font-weight:400;color:var(--text3);font-size:10px;margin-top:2px}
.item-config-badges{display:flex;gap:4px;flex-wrap:wrap}
.item-config-badge{padding:2px 6px;border-radius:4px;font-size:10px;background:var(--bg4);color:var(--text2)}
.item-config-badge.active{background:var(--accent);color:#fff}
.item-config-badge.skip{background:var(--bg4);color:var(--text3);text-decoration:line-through}
.item-config-actions button{padding:4px 8px;font-size:11px;background:var(--bg4);border:none;border-radius:4px;color:var(--text2);cursor:pointer}
.item-config-actions button:hover{background:var(--accent);color:#fff}
.item-config-empty{text-align:center;padding:30px;color:var(--text3);font-size:12px}
.item-config-form{display:grid;gap:10px;padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:12px}
.item-config-form label{font-size:11px;color:var(--text2);margin-bottom:2px}
.item-config-form input[type="text"],.item-config-form select{width:100%;padding:8px 10px;font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.item-config-form .checkbox-row{display:flex;align-items:center;gap:8px;padding:6px 0}
.item-config-form .checkbox-row input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.item-config-form .checkbox-row label{font-size:12px;color:var(--text);margin:0}
.item-config-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.item-config-form .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.item-config-form button{padding:8px 16px;font-size:12px;border:none;border-radius:6px;cursor:pointer}
.item-config-form button.primary{background:var(--accent);color:#fff}
.item-config-form button.secondary{background:var(--bg4);color:var(--text2)}

.nav-preview-item{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);gap:10px}
.nav-preview-item:last-child{border-bottom:none}
.nav-preview-item.no-match{opacity:0.5}
.nav-preview-name{flex:1;font-size:12px;font-weight:500;min-width:0}
.nav-preview-name .match{color:var(--green);font-size:10px;margin-left:6px}
.nav-preview-name .no-match{color:var(--text3);font-size:10px;margin-left:6px}
.nav-preview-po{font-size:11px;color:var(--accent);font-weight:500}
.nav-preview-eta{font-size:10px;color:var(--text2)}
.nav-preview-status{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg3)}
.nav-preview-status.will-receive{background:#1a3a2f;color:#6ee7b7}
.nav-preview-status.will-update{background:#3b3000;color:#fbbf24}

.po-details-popover{min-width:320px;max-width:400px;padding:0}
.po-details-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
.po-details-number{font-weight:600;font-size:14px}
.po-details-supplier{font-size:12px;color:var(--text2)}
.po-details-dates{display:flex;gap:16px;padding:10px 14px;font-size:11px;color:var(--text2);border-bottom:1px solid var(--border)}
.po-details-table{padding:8px 0}
.po-details-thead{display:grid;grid-template-columns:1fr 60px 70px;padding:4px 14px;font-size:10px;color:var(--text3);text-transform:uppercase;border-bottom:1px solid var(--border)}
.po-details-tbody{max-height:180px;overflow-y:auto}
.po-details-row{display:grid;grid-template-columns:1fr 60px 70px;padding:8px 14px;font-size:12px;align-items:center;border-bottom:1px solid var(--bg3)}
.po-details-row:last-child{border-bottom:none}
.po-details-row .item-name{display:flex;flex-direction:column;gap:2px}
.po-details-row .item-code{font-size:10px;color:var(--text3)}
.po-details-row .qty{text-align:center}
.po-details-row .status{display:flex;align-items:center;gap:4px}
.po-details-row .status.received{color:var(--green)}
.po-details-row .status.pending{color:var(--text3)}
.po-details-summary{padding:10px 14px;background:var(--bg3);font-size:12px;display:flex;justify-content:space-between;align-items:center}
.po-details-summary .progress-bar{width:100px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.po-details-summary .progress-fill{height:100%;background:var(--green);border-radius:3px}
.po-details-actions{padding:10px 14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end}
.po-details-actions .btn{font-size:11px;padding:6px 12px}

.dropdown{position:relative;z-index:1002}
.dropdown-menu{display:none;position:absolute;top:calc(100% + 8px);right:0;background:var(--bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:12px;min-width:220px;z-index:1002;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.15);padding:6px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1)}
.dropdown-menu.open{display:block;opacity:1;transform:translateY(0) scale(1)}
.dropdown-item{padding:10px 14px;font-size:13px;font-weight:500;cursor:pointer;color:var(--text);transition:all .1s;display:flex;align-items:center;gap:10px;border-radius:6px;margin:1px 0}
.dropdown-item:hover{background:var(--bg2)}.dropdown-item.danger{color:var(--red)}
.dropdown-div{height:1px;background:var(--border);margin:6px 8px}
.team-list{margin-top:12px}
.team-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg);border-radius:10px;margin-bottom:6px;font-size:13px}
.team-item-info{flex:1}
.team-item-del{width:22px;height:22px;background:transparent;border:none;border-radius:6px;color:var(--red);cursor:pointer;font-size:12px;transition:all .15s}
.team-item-del:hover{background:rgba(255,69,58,.15)}
.eta-popover{min-width:320px;max-width:380px;padding:0}
.eta-popover-header{display:flex;flex-direction:column;gap:2px;padding:12px 14px;border-bottom:1px solid var(--border)}
.eta-popover-name{font-weight:600;font-size:14px}
.eta-popover-code{font-size:11px;color:var(--text3)}
.eta-popover-history{padding:10px 14px;border-bottom:1px solid var(--border)}
.eta-popover-history-title{font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:8px}
.eta-popover-history-empty{font-size:12px;color:var(--text3);padding:8px 0}
.eta-popover-history-item{display:flex;justify-content:space-between;font-size:12px;color:var(--text2);padding:4px 0}
.eta-popover-avg{display:flex;justify-content:space-between;font-size:12px;font-weight:500;padding:8px 0;margin-top:4px;border-top:1px solid var(--border)}
.eta-popover-input{padding:12px 14px}
.eta-popover-input label{font-size:11px;color:var(--text2);display:block;margin-bottom:6px}
.eta-popover-input input{width:100%;height:34px;padding:0 10px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:6px}
.eta-popover-actions{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.part-info-popover{min-width:300px;max-width:360px;padding:0;z-index:9600}
.part-info-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
.part-info-name{font-weight:600;font-size:14px;color:var(--text)}
.part-info-body{padding:12px 14px;font-size:12px}
.part-info-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
.part-info-row:last-child{border-bottom:none}
.part-info-label{color:var(--text3)}
.part-info-value{color:var(--text);font-weight:500;text-align:right}
.part-info-value.status{padding:2px 8px;border-radius:4px;font-size:11px}
.part-info-value.waiting{background:rgba(138,138,130,.1);color:var(--s0)}
.part-info-value.to-order{background:rgba(192,112,112,.1);color:var(--s1)}
.part-info-value.ordered{background:rgba(216,119,86,.1);color:var(--s2)}
.part-info-value.arrived{background:rgba(184,160,80,.1);color:var(--s3)}
.part-info-value.tested{background:rgba(106,160,170,.1);color:var(--s4)}
.part-info-value.configured{background:rgba(152,136,170,.1);color:var(--s5)}
.part-info-value.installed{background:rgba(106,170,106,.1);color:var(--s6)}
.part-info-notes{margin-top:8px;padding:8px;background:var(--bg);border-radius:6px;font-size:11px;color:var(--text2);line-height:1.5}
.part-info-footer{padding:10px 14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end}
.part-info-footer .btn-sm{height:28px;padding:0 12px;font-size:11px}
.pending-popover{width:280px;padding:0}
.pending-popover-header{padding:14px;font-size:14px;font-weight:600;border-bottom:1px solid var(--border)}
.pending-popover-note{padding:12px}
.pending-popover-note textarea{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;color:var(--text);resize:none;font-family:inherit}
.pending-popover-note textarea:focus{outline:none;border-color:var(--accent)}
.pending-popover-actions{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.pending-popover-actions .btn{height:32px;padding:0 14px;font-size:12px}
.status-badge.waiting.has-note::after{content:'';display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;margin-left:6px;vertical-align:middle}
.bom-modal{max-width:450px}
.bom-list{max-height:200px;overflow-y:auto;margin-bottom:12px}
.bom-item{display:flex;align-items:center;padding:8px 10px;background:var(--bg);border-radius:4px;margin-bottom:4px;cursor:pointer}
.bom-item:hover{background:var(--bg3)}
.bom-item-info{flex:1}
.bom-item-name{font-weight:600;font-size:12px}
.bom-item-meta{font-size:10px;color:var(--text3)}
.bom-item-del{width:20px;height:20px;background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--red);cursor:pointer;font-size:10px}
.leadtime-modal{max-width:500px}
.lt-item{background:var(--bg);border-radius:6px;padding:10px;margin-bottom:8px}
.itemconfig-modal{max-width:600px}
.itemconfig-list{max-height:350px;overflow-y:auto}
.itemconfig-item{background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px}
.itemconfig-item-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.itemconfig-code{font-weight:600;font-size:14px;flex:1;color:var(--accent)}
.itemconfig-del{width:24px;height:24px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--red);cursor:pointer;font-size:12px}
.itemconfig-options{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.itemconfig-opt{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg2);border-radius:6px}
.itemconfig-opt label{font-size:11px;color:var(--text2);flex:1}
.itemconfig-opt input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.itemconfig-opt select{flex:1;padding:4px 6px;font-size:11px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text)}
.itemconfig-add{display:flex;gap:8px;margin-bottom:12px;padding:12px;background:var(--bg);border-radius:8px}
.itemconfig-add input{flex:1;height:32px;padding:0 10px;font-size:12px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.itemconfig-add button{padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer}
.itemconfig-empty{text-align:center;padding:30px;color:var(--text3);font-size:13px}
.otd-modal{max-width:500px}
.otd-item{display:flex;align-items:center;background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px}
.otd-mfr{font-weight:600;font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.otd-stats{display:flex;gap:16px;align-items:center}
.otd-stat{text-align:center}
.otd-stat-val{font-size:16px;font-weight:600;display:block}
.otd-stat-label{font-size:10px;color:var(--text3)}
.otd-bar{width:60px;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}
.otd-bar-fill{height:100%;border-radius:3px}
.otd-empty{text-align:center;color:var(--text3);padding:30px}
.lt-code{font-weight:600;font-size:12px;margin-bottom:6px;color:var(--accent)}
.lt-stats{display:flex;gap:12px;font-size:10px;align-items:center}
.lt-stat-val{font-size:14px;font-weight:700;color:var(--purple)}
.lt-samples{font-size:9px;color:var(--text3)}

/* Tablet styles */
@media(max-width:1024px){
  .header-metrics{gap:6px}
  .hm{padding:6px 10px}
  .hm-progress{min-width:140px}
  .hm-bar{width:80px}
  .header-search{width:180px}
  .ai-console-btn{padding:8px 14px;font-size:12px}
}

/* Mobile styles - HIDE DESKTOP, SHOW MOBILE VIEW */
@media(max-width:768px){
  /* Hide entire desktop layout */
  .main{display:none!important}
  .header{display:none!important}
  /* Show mobile app */
  .mobile-app{display:flex!important}
}

/* ===== MOBILE APP (completely separate from desktop) ===== */
.mobile-app{
  display:none;
  flex-direction:column;
  height:100vh;
  height:100dvh;
  background:var(--bg);
  overflow:hidden;
}
.mob-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  padding-top:max(12px,env(safe-area-inset-top));
  background:var(--bg);
  border-bottom:1px solid var(--border);
  gap:12px;
  flex-shrink:0;
}
.mob-logo{font-size:15px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.mob-header-btns{display:flex;gap:8px}
.mob-btn{
  height:36px;
  padding:0 12px;
  font-size:13px;
  font-weight:500;
  color:var(--text2);
  background:var(--bg2);
  border:1px solid var(--border);
  border-radius:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.mob-btn:active{opacity:0.7;transform:scale(0.96)}
.mob-btn-primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);border:none}
.mob-pipeline{
  display:flex;
  gap:6px;
  padding:12px 16px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  flex-shrink:0;
  background:var(--bg2);
}
.mob-pipe{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
  padding:8px 10px;
  background:var(--bg3);
  border-radius:10px;
  min-width:52px;
  flex-shrink:0;
  cursor:pointer;
  transition:all .15s;
}
.mob-pipe.active{background:var(--accent);color:white}
.mob-pipe.active .mob-pipe-label{color:rgba(255,255,255,0.8)}
.mob-pipe-count{font-size:18px;font-weight:600;color:var(--text)}
.mob-pipe.active .mob-pipe-count{color:white}
.mob-pipe-label{font-size:9px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px}
.mob-content{
  flex:1;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding:0 0 env(safe-area-inset-bottom) 0;
}
.mob-list{padding:8px}
.mob-asm{
  background:var(--bg2);
  border-radius:12px;
  margin-bottom:8px;
  overflow:hidden;
}
.mob-asm-header{
  display:flex;
  align-items:center;
  padding:14px 16px;
  gap:12px;
  cursor:pointer;
}
.mob-asm-header:active{background:var(--bg3)}
.mob-asm-toggle{font-size:12px;color:var(--text3);transition:transform .2s}
.mob-asm.expanded .mob-asm-toggle{transform:rotate(90deg)}
.mob-asm-info{flex:1;min-width:0}
.mob-asm-name{font-size:14px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mob-asm-meta{font-size:12px;color:var(--text3);margin-top:2px}
.mob-asm-progress{
  width:50px;
  height:6px;
  background:var(--bg4);
  border-radius:3px;
  overflow:hidden;
}
.mob-asm-progress-bar{height:100%;background:var(--green);border-radius:3px;transition:width .3s}
.mob-asm-pct{font-size:12px;font-weight:600;color:var(--text2);min-width:36px;text-align:right}
.mob-parts{display:none;border-top:1px solid var(--border)}
.mob-asm.expanded .mob-parts{display:block}
.mob-part{
  display:flex;
  align-items:center;
  padding:12px 16px;
  gap:12px;
  border-bottom:1px solid var(--border);
  cursor:pointer;
}
.mob-part:last-child{border-bottom:none}
.mob-part:active{background:var(--bg3)}
.mob-part-info{flex:1;min-width:0}
.mob-part-name{font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mob-part-meta{font-size:11px;color:var(--text3);margin-top:2px;display:flex;gap:8px;flex-wrap:wrap}
.mob-status{
  font-size:10px;
  font-weight:600;
  padding:4px 8px;
  border-radius:6px;
  text-transform:uppercase;
  letter-spacing:0.3px;
  white-space:nowrap;
}
.mob-status.waiting{background:rgba(138,138,130,0.15);color:var(--s0)}
.mob-status.to-order{background:rgba(192,112,112,0.15);color:var(--s1)}
.mob-status.ordered{background:rgba(216,119,86,0.15);color:var(--s2)}
.mob-status.arrived{background:rgba(184,160,80,0.15);color:var(--s3)}
.mob-status.tested{background:rgba(106,160,170,0.15);color:var(--s4)}
.mob-status.configured{background:rgba(152,136,170,0.15);color:var(--s5)}
.mob-status.installed{background:rgba(106,170,106,0.15);color:var(--s6)}
.mob-part-arrow{color:var(--text3);font-size:14px}
.mob-empty{padding:40px 20px;text-align:center;color:var(--text3);font-size:14px}
/* Mobile modal overrides */
.mob-modal{
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:1000;
  display:none;
  flex-direction:column;
}
.mob-modal.open{display:flex}
.mob-modal-header{
  display:flex;
  align-items:center;
  padding:12px 16px;
  padding-top:max(12px,env(safe-area-inset-top));
  border-bottom:1px solid var(--border);
  gap:12px;
}
.mob-modal-back{
  width:36px;
  height:36px;
  background:transparent;
  border:none;
  color:var(--accent);
  font-size:20px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
.mob-modal-title{flex:1;font-size:16px;font-weight:600;color:var(--text)}
.mob-modal-body{flex:1;overflow-y:auto;padding:16px}
.mob-field{margin-bottom:16px}
.mob-field-label{font-size:12px;font-weight:500;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px}
.mob-field-input,.mob-field-select{
  width:100%;
  height:48px;
  padding:0 14px;
  font-size:16px;
  color:var(--text);
  background:var(--bg2);
  border:1px solid var(--border);
  border-radius:10px;
}
.mob-field-input:focus,.mob-field-select:focus{border-color:var(--accent);outline:none}
.mob-modal-footer{
  padding:12px 16px;
  padding-bottom:max(12px,env(safe-area-inset-bottom));
  border-top:1px solid var(--border);
  display:flex;
  gap:10px;
}
.mob-modal-footer .mob-btn{flex:1;height:48px;font-size:15px}

/* Touch improvements */
@media(hover:none){
  .btn:hover,.sm-btn:hover,.adv-btn:hover,.pipe:hover,.tab:hover,.action-row:hover,.part-row:hover,.asm-row:hover{transform:none;filter:none}
  .btn:active,.sm-btn:active,.adv-btn:active{transform:scale(0.95);opacity:0.8}
  .pipe:active,.tab:active{background:var(--bg4)}
}

/* Safe area for notched devices */
@supports(padding:max(0px)){
  .header{padding-left:max(12px,env(safe-area-inset-left));padding-right:max(12px,env(safe-area-inset-right))}
  .main{padding-left:max(10px,env(safe-area-inset-left));padding-right:max(10px,env(safe-area-inset-right));padding-bottom:max(10px,env(safe-area-inset-bottom))}
  .modal{margin-bottom:env(safe-area-inset-bottom)}
}

/* Label Print Modal */
.label-modal{width:480px}
.label-modal .modal-body{padding:20px}
.label-options{display:flex;flex-direction:column;gap:16px;margin-bottom:20px}
.label-option-row{display:flex;align-items:center;gap:12px}
.label-option-row label{font-size:12px;color:var(--text2);width:100px;flex-shrink:0}
.label-option-row select{flex:1;height:32px;padding:0 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px}
.label-option-row input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.label-option-row .checkbox-label{font-size:12px;color:var(--text2);flex:1}
.label-preview-container{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:20px;display:flex;justify-content:center;align-items:center;min-height:150px}
.label-preview{background:#fff;color:#000;display:flex;align-items:center;gap:12px;padding:12px 16px;font-family:'Arial',sans-serif;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
.label-preview-qr{flex-shrink:0}
.label-preview-qr canvas{display:block}
.label-preview-info{flex:1;min-width:0}
.label-preview-name{font-size:14px;font-weight:600;margin-bottom:4px;word-break:break-word}
.label-preview-code{font-size:18px;font-weight:700;font-family:'Consolas','Courier New',monospace;margin-bottom:4px}
.label-preview-meta{font-size:10px;color:#666}
.label-count-info{text-align:center;font-size:11px;color:var(--text3);margin-top:12px}
.print-btn{background:var(--btn-primary-bg);color:var(--btn-primary-text);border:none;padding:0 20px;height:36px;font-size:13px;font-weight:500;border-radius:8px;cursor:pointer}
.print-btn:hover{opacity:0.9}
.print-btn svg{margin-right:6px}

/* Print button in row */
.print-label-btn{background:transparent;border:none;color:var(--text3);cursor:pointer;padding:4px;border-radius:4px;font-size:14px;opacity:0.6;transition:all .15s;width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;margin-right:4px}
.print-label-btn:hover{background:var(--bg3);color:var(--accent);opacity:1}
.part-row:hover .print-label-btn{opacity:1}
.part-actions{display:flex;align-items:center;gap:4px}

/* Print-specific styles - only shown when printing */
@media print{
  /* Hide everything except the print area */
  body *{visibility:hidden}
  #labelPrintArea,#labelPrintArea *{visibility:visible}
  #labelPrintArea{position:fixed;left:0;top:0;background:#fff;margin:0;padding:0}
  
  /* Individual label styling for print */
  .print-label{page-break-inside:avoid;background:#fff;color:#000;margin:0;padding:0}
  .print-label-inner{display:flex;align-items:center;gap:3mm;padding:2mm}
  .print-label-qr{flex-shrink:0}
  .print-label-qr img,.print-label-qr canvas{width:15mm;height:15mm}
  .print-label-info{flex:1}
  .print-label-name{font-size:11pt;font-weight:600;font-family:'Arial',sans-serif;margin-bottom:1mm}
  .print-label-code{font-size:14pt;font-weight:700;font-family:'Consolas','Courier New',monospace;margin-bottom:1mm}
  .print-label-meta{font-size:8pt;color:#333;font-family:'Arial',sans-serif}
  
  /* Label sizes */
  .print-label.size-102x51{width:102mm;height:51mm}
  .print-label.size-62x29{width:62mm;height:29mm}
  .print-label.size-62x100{width:62mm;height:100mm}
  .print-label.size-29x90{width:29mm;height:90mm}
  .print-label.size-29x90 .print-label-inner{flex-direction:column;text-align:center;padding:3mm}
  .print-label.size-29x90 .print-label-qr{margin-bottom:2mm}
  .print-label.size-29x90 .print-label-code{font-size:10pt}
  .print-label.size-29x90 .print-label-name{font-size:9pt}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
<div class="login-logo">EF Final Assembly</div>
<button class="login-btn-outline" id="loginQuick"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>Try Demo Project</button>
<div class="login-divider">OR</div>
<div class="login-field">
<input type="text" id="loginCode" placeholder="Enter project code" autocomplete="off">
</div>
<button class="login-btn" id="loginBtn">Open Project</button>
<div class="login-error" id="loginError"></div>
<div class="login-status" id="loginStatus">Connecting...</div>
</div>
</div>

<!-- Sync Indicator -->
<div class="sync-indicator" id="syncIndicator"><div class="sync-dot"></div><span id="syncText">Synced</span></div>

<!-- Offline Overlay -->
<div class="offline-overlay" id="offlineOverlay">
<div class="offline-box">
<div class="offline-icon">
  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
    <path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55M5 12.55a10.94 10.94 0 0 1 5.17-2.39M10.71 5.05A16 16 0 0 1 22.58 9M1.42 9a15.91 15.91 0 0 1 4.7-2.88M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/>
  </svg>
</div>
<div class="offline-title">Connection Lost</div>
<div class="offline-message">Waiting for connection to be restored...</div>
<div class="offline-spinner"></div>
<div class="offline-pending" id="offlinePending"></div>
<div class="offline-hint">Your changes are saved locally and will sync when reconnected.</div>
</div>
</div>

<header class="header">
<div class="project-selector">
<div class="logo" id="projectName">EBS v2</div>
<button class="project-selector-btn" id="projectSelectorBtn" title="Switch Project"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></button>
<div class="project-dropdown" id="projectDropdown">
<div class="project-dropdown-master" id="projectDropdownMaster">
<svg class="project-dropdown-master-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="4" rx="1"/><rect x="3" y="10" width="13" height="4" rx="1"/><rect x="3" y="16" width="16" height="4" rx="1"/></svg>
<span class="project-dropdown-master-label">Master Schedule</span>
</div>
<div class="project-dropdown-header">Projects</div>
<div class="project-dropdown-list" id="projectDropdownList"></div>
<div class="project-dropdown-footer">
<div class="project-dropdown-action" id="newProjectBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Project</div>
<div class="project-dropdown-action" id="manageProjectsBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>Manage Projects</div>
</div>
</div>
</div>
<div style="flex:1"></div>
<button class="insights-btn" id="insightsBtn" title="Project Insights"><svg viewBox="0 0 24 24"><path d="M21 21H4.6c-.6 0-1.1-.5-1.1-1.1V3"/><path d="m7 14 4-4 4 4 6-6"/></svg><span>Insights</span><span class="insights-btn-dot"></span></button>
<select class="filter-select" id="assigneeFilter"><option value="">All Assignees</option></select>
<div class="online-badge" title="Users online"><div class="online-dot"></div><span id="onlineCount">1</span><div class="online-hover" id="onlineHover"><div id="onlineUserList"></div></div></div>
<div class="header-search"><input type="text" id="headerSearch" placeholder="Search parts..."><button class="header-search-clear" id="headerSearchClear">Ã—</button></div>
<div class="header-metrics" id="headerMetrics" onclick="window.toggleMetricsPopover(event)">
<div class="hm"><div><div class="hm-label">Ready</div><div class="hm-value" id="sReady">0/0</div></div></div>
<div class="hm" id="hmDays" style="display:none"><div><div class="hm-label">Days</div><div class="hm-value" id="sDays">â€”</div></div></div>
<div class="hm hm-progress" id="hmProgress"><div><div class="hm-label">Progress</div><div class="hm-value" id="sPct">0%</div></div><div class="hm-bar"><div class="hm-bar-fill" id="sBar"></div></div></div>
</div>
<div class="header-btns">
<div class="dropdown"><button class="btn" id="menuBtn">â˜°</button><div class="dropdown-menu" id="menuDrop"><div class="dropdown-item" id="receivePOBtn">ðŸ“¥ Receive PO</div><div class="dropdown-item" id="themeBtn">ðŸŒ“ Toggle Theme</div><div class="dropdown-div"></div><div class="dropdown-item" id="reportBtn">ðŸ“Š View Status Report</div><div class="dropdown-div"></div><div class="dropdown-item" id="teamBtn">Team</div><div class="dropdown-item" id="datesBtn">Project Dates</div><div class="dropdown-item" id="milestonesBtn">ðŸ”· Milestones</div><div class="dropdown-item" id="leadtimeBtn">Lead Time Data</div><div class="dropdown-item" id="itemConfigBtn">Item Code Config</div><div class="dropdown-div"></div><div class="dropdown-item" id="saveTemplateBtn">ðŸ’¾ Save as Template</div><div class="dropdown-item" id="manageTemplatesBtn">ðŸ“‹ Manage Templates</div><div class="dropdown-item" id="importMssrBtn">ðŸ“¦ Import MSSR BOM Template</div><div class="dropdown-div"></div><div class="dropdown-item" id="navImportBtn">ðŸ“¥ Import NAV Data</div><div class="dropdown-div"></div><div class="dropdown-item" id="sampleBtn">Load Sample Data</div><div class="dropdown-item" id="generateTestProjectsBtn">ðŸ§ª Generate 5 Test Projects</div><div class="dropdown-item danger" id="clearBtn">Clear All</div><div class="dropdown-div"></div><div class="dropdown-item" id="signOutBtn">Sign Out</div></div></div>
</div>
</header>
<main class="main">
<aside class="sidebar" id="sidebar">
<div class="sidebar-top">
<button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/><polyline points="15 8 12 12 15 16"/></svg>
<span>Hide</span>
</button>
</div>
<div class="sidebar-section">
<div class="tabs">
<button class="tab active" data-tab="list" title="Parts List"><span class="tab-icon">â˜°</span><span>Parts List</span></button>
<button class="tab" data-tab="gantt" title="Timeline"><span class="tab-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg></span><span>Timeline</span></button>
</div>
</div>
<div class="sidebar-section">
<div class="sidebar-label">Pipeline</div>
<div class="pipeline">
<div class="pipe" data-s="waiting" title="Waiting"><div class="pipe-label">Waiting</div><div class="pipe-bar"><div class="pipe-bar-fill" id="bar0"></div></div><div class="pipe-count" id="p0">0</div></div>
<div class="pipe" data-s="to-order" title="To Order"><div class="pipe-label">To Order</div><div class="pipe-bar"><div class="pipe-bar-fill" id="bar1"></div></div><div class="pipe-count" id="p1">0</div></div>
<div class="pipe" data-s="ordered" title="Ordered"><div class="pipe-label">Ordered</div><div class="pipe-bar"><div class="pipe-bar-fill" id="bar2"></div></div><div class="pipe-count" id="p2">0</div></div>
<div class="pipe" data-s="arrived" title="Arrived"><div class="pipe-label">Arrived</div><div class="pipe-bar"><div class="pipe-bar-fill" id="bar3"></div></div><div class="pipe-count" id="p3">0</div></div>
<div class="pipe" data-s="tested" title="Tested"><div class="pipe-label">Tested</div><div class="pipe-bar"><div class="pipe-bar-fill" id="bar4"></div></div><div class="pipe-count" id="p4">0</div></div>
<div class="pipe" data-s="configured" title="Configured"><div class="pipe-label">Configured</div><div class="pipe-bar"><div class="pipe-bar-fill" id="bar5"></div></div><div class="pipe-count" id="p5">0</div></div>
<div class="pipe" data-s="installed" title="Installed"><div class="pipe-label">Installed</div><div class="pipe-bar"><div class="pipe-bar-fill" id="bar6"></div></div><div class="pipe-count" id="p6">0</div></div>
</div>
</div>
<div class="sidebar-section">
<div class="sidebar-label">Activity</div>
<div class="activity-log" id="activityLog">
<div class="activity-empty">No recent activity</div>
</div>
<button class="activity-view-all" id="activityViewAll">View All â†’</button>
</div>
<div class="cmd-minimized" id="cmdMinimized" title="Restore AI Console">
<span class="cmd-minimized-icon">â– </span>
<span class="cmd-minimized-title">AI Console</span>
</div>
<div style="flex:1"></div>
<div class="version-badge" id="versionBadge">v2.1.0
<div class="version-info">
<div class="version-info-row"><span class="version-info-label">Version</span><span class="version-info-value">1.0.2</span></div>
<div class="version-info-row"><span class="version-info-label">Server</span><span class="version-info-value" id="serverStatus">Firebase</span></div>
<div class="version-info-divider"></div>
<div class="version-info-row"><span class="version-info-label">Project</span><span class="version-info-value" id="infoProjectId">â€”</span></div>
<div class="version-info-row"><span class="version-info-label">User</span><span class="version-info-value" id="infoUserEmail">â€”</span></div>
<div class="version-info-divider"></div>
<div class="version-info-row"><span class="version-info-label">Last sync</span><span class="version-info-value" id="infoLastSync">â€”</span></div>
</div>
</div>
</aside>
<div class="content">
<div class="panel active" id="listPanel">
<div class="filter-badges" id="filterBadges"></div>
<div class="bulk-bar" id="bulkBar"><span class="bulk-bar-count"><span id="bulkCount">0</span> selected</span><div class="bulk-bar-actions"><button class="btn" id="bulkStatusBtn">Set Status</button><button class="btn" id="bulkAssignBtn">Set Assignee</button><button class="btn" id="bulkPOBtn">Set PO</button><button class="btn" id="bulkPrintBtn">ðŸ·ï¸ Print Labels</button><button class="btn btn-danger" id="bulkDeleteBtn">Delete</button><button class="btn btn-clear" id="bulkClearBtn">âœ• Clear</button></div></div>
<div class="data-table" id="partsTable"><div class="table-header parts-grid"><div><input type="checkbox" class="part-checkbox" id="selectAllParts" title="Select all"></div><div class="th-name"><button class="expand-toggle-btn" id="expandToggle"><span class="arrow">â–¼</span> Expand</button>Name</div><div>Code</div><div>Mfr</div><div>Assignee</div><div>Qty</div><div>Status</div><div>Prog</div><div>ETA / PO</div><div>Notes</div><div></div></div><div class="table-body" id="partsList"></div></div>
<div class="empty" id="emptyList" style="display:none;">No items found</div>
</div>
<div class="panel" id="progressPanel">
<div class="progress-layout-full">
<div class="progress-row">
<div class="card"><div class="card-title">Burndown Chart <a id="burndownEdit">Edit Dates</a></div><div class="burndown-container" id="burndownChart"></div><div class="burndown-dates" id="burndownDates"></div><div class="burndown-legend"><div class="legend-item"><div class="legend-dot green"></div> Ahead</div><div class="legend-item"><div class="legend-dot red"></div> Behind</div><div class="legend-item"><div class="legend-dot gray"></div> Target</div><div class="legend-item"><div style="width:16px;height:2px;background:repeating-linear-gradient(90deg,var(--text3) 0,var(--text3) 3px,transparent 3px,transparent 6px);opacity:0.7;border-radius:1px"></div> Forecast</div><div class="legend-item"><div style="width:1px;height:10px;background:var(--accent);opacity:0.5"></div> Today</div></div></div>
</div>
<div class="progress-row">
<div class="card"><div class="card-title">Assembly Progress</div><div class="asm-progress-list" id="asmProgressList"></div></div>
<div class="card"><div class="card-title">Bottlenecks</div><div class="bottleneck-list" id="bottleneckList"></div></div>
<div class="card"><div class="card-title">Velocity Forecast</div><div class="forecast-card-inner"><div class="forecast-main"><span class="forecast-date" id="forecastDate">â€”</span><span class="forecast-label" id="forecastLabel"></span></div><div class="forecast-detail" id="forecastDetail"></div></div></div>
</div>
</div>
</div>
<div class="panel" id="ganttPanel">
<div class="gantt-container">
<div class="gantt-toolbar">
<span class="gantt-toolbar-title">Project Timeline</span>
<div class="gantt-toolbar-actions">
<span id="ganttConflictBadge" style="display:none;position:relative"></span>
<select class="gantt-filter-select" id="ganttResourceFilter">
<option value="">All Resources</option>
</select>
<button class="btn btn-sm" id="ganttExportPdf">ðŸ“„ Export PDF</button>
<button class="btn btn-sm" id="ganttToday">Today</button>
</div>
</div>
<div class="gantt-header-row">
<div class="gantt-sidebar-header">
<div class="gantt-col-name">Task Name</div>
<div class="gantt-col-resource">Resource</div>
<div class="gantt-col-follows">Follows</div>
<div class="gantt-col-start">Start</div>
<div class="gantt-col-end">End</div>
<div class="gantt-col-dur">Days</div>
</div>
<div class="gantt-timeline-header-wrap" id="ganttTimelineHeaderWrap">
<div class="gantt-timeline-header" id="ganttTimelineHeader"></div>
</div>
</div>
<div class="gantt-body-wrap" id="ganttBodyWrap">
<div class="gantt-body-inner" id="ganttBodyInner">
<div class="gantt-sidebar-body" id="ganttSidebar"></div>
<div class="gantt-timeline-body" id="ganttTimelineBody"></div>
</div>
</div>
</div>
<div class="gantt-color-popup" id="ganttColorPopup">
<div class="gantt-color-title">Bar Color</div>
<div class="gantt-color-grid" id="ganttColorGrid"></div>
</div>
<div class="gantt-date-popup" id="ganttDatePopup">
<div class="gantt-date-popup-title" id="ganttDatePopupTitle">Set Date</div>
<input type="date" class="gantt-date-popup-input" id="ganttDatePopupInput">
<div class="gantt-date-popup-btns">
<button class="btn btn-sm" id="ganttDatePopupClear">Clear</button>
<button class="btn btn-sm btn-primary" id="ganttDatePopupSave">Save</button>
</div>
</div>
<div class="gantt-tooltip" id="ganttTooltip">
<div class="gantt-tooltip-title" id="ganttTooltipTitle"></div>
<div class="gantt-tooltip-body" id="ganttTooltipBody"></div>
</div>
</div>
<div class="ai-workspace" id="aiWorkspace">
<div class="ai-workspace-conversation" id="aiWorkspaceConversation">
<div class="ai-workspace-conversation-inner">
<div class="ai-welcome-minimal">What would you like to know?</div>
</div>
</div>
<div class="ai-workspace-input-wrap">
<div class="ai-workspace-input">
<textarea id="aiWorkspaceQuestion" placeholder="Reply..." rows="1"></textarea>
<div class="ai-input-actions">
<div class="ai-model-selector-ws"><button class="ai-model-badge-ws" id="aiModelBadgeWs" onclick="window.toggleModelSelectorWs(event)">sonnet-4.5 <span style="opacity:0.5">â–¾</span></button><div class="ai-model-dropdown-ws" id="aiModelDropdownWs"><button class="ai-model-option" data-model="claude-haiku-4-5-20251001" onclick="window.selectAIModelWs(this)"><span class="model-name">Haiku 4.5</span><span class="model-desc">Fast & efficient</span></button><button class="ai-model-option active" data-model="claude-sonnet-4-5-20250929" onclick="window.selectAIModelWs(this)"><span class="model-name">Sonnet 4.5</span><span class="model-desc">Balanced</span></button><button class="ai-model-option" data-model="claude-opus-4-5-20251101" onclick="window.selectAIModelWs(this)"><span class="model-name">Opus 4.5</span><span class="model-desc">Most capable</span></button></div></div>
<button class="ai-input-btn" id="aiWorkspaceTellBtn" title="Get briefing">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg>
</button>
<button class="ai-send-btn" id="aiWorkspaceAskBtn" title="Send">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
</button>
</div>
</div>
</div>
</div>
</main>

<!-- ===== MOBILE APP (completely separate from desktop) ===== -->
<div class="mobile-app" id="mobileApp">
  <header class="mob-header">
    <div class="mob-logo" id="mobLogo">EF Final Assembly</div>
    <div class="mob-header-btns">
      <button class="mob-btn" id="mobMenuBtn">â˜°</button>
    </div>
  </header>
  <div class="mob-pipeline" id="mobPipeline">
    <div class="mob-pipe" data-status="waiting"><div class="mob-pipe-count" id="mobP0">0</div><div class="mob-pipe-label">Waiting</div></div>
    <div class="mob-pipe" data-status="to-order"><div class="mob-pipe-count" id="mobP1">0</div><div class="mob-pipe-label">To Order</div></div>
    <div class="mob-pipe" data-status="ordered"><div class="mob-pipe-count" id="mobP2">0</div><div class="mob-pipe-label">Ordered</div></div>
    <div class="mob-pipe" data-status="arrived"><div class="mob-pipe-count" id="mobP3">0</div><div class="mob-pipe-label">Arrived</div></div>
    <div class="mob-pipe" data-status="tested"><div class="mob-pipe-count" id="mobP4">0</div><div class="mob-pipe-label">Tested</div></div>
    <div class="mob-pipe" data-status="configured"><div class="mob-pipe-count" id="mobP5">0</div><div class="mob-pipe-label">Config</div></div>
    <div class="mob-pipe" data-status="installed"><div class="mob-pipe-count" id="mobP6">0</div><div class="mob-pipe-label">Done</div></div>
  </div>
  <div class="mob-content">
    <div class="mob-list" id="mobPartsList"></div>
  </div>
</div>

<!-- Mobile Part Modal -->
<div class="mob-modal" id="mobPartModal">
  <div class="mob-modal-header">
    <button class="mob-modal-back" id="mobPartBack">â†</button>
    <div class="mob-modal-title" id="mobPartTitle">Part Details</div>
  </div>
  <div class="mob-modal-body">
    <div class="mob-field">
      <div class="mob-field-label">Name</div>
      <input type="text" class="mob-field-input" id="mobPartName">
    </div>
    <div class="mob-field">
      <div class="mob-field-label">Status</div>
      <select class="mob-field-select" id="mobPartStatus">
        <option value="waiting">Waiting</option>
        <option value="to-order">To Order</option>
        <option value="ordered">Ordered</option>
        <option value="arrived">Arrived</option>
        <option value="tested">Tested</option>
        <option value="configured">Configured</option>
        <option value="installed">Installed</option>
      </select>
    </div>
    <div class="mob-field">
      <div class="mob-field-label">Assignee</div>
      <select class="mob-field-select" id="mobPartAssignee"></select>
    </div>
    <div class="mob-field">
      <div class="mob-field-label">PO Number</div>
      <input type="text" class="mob-field-input" id="mobPartPO">
    </div>
  </div>
  <div class="mob-modal-footer">
    <button class="mob-btn" id="mobPartCancel">Cancel</button>
    <button class="mob-btn mob-btn-primary" id="mobPartSave">Save</button>
  </div>
</div>

<!-- Mobile Menu Modal -->
<div class="mob-modal" id="mobMenuModal">
  <div class="mob-modal-header">
    <button class="mob-modal-back" id="mobMenuBack">â†</button>
    <div class="mob-modal-title">Menu</div>
  </div>
  <div class="mob-modal-body">
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="mob-btn" id="mobSampleBtn" style="justify-content:flex-start;padding:0 16px">ðŸ“¦ Load Sample Data</button>
      <button class="mob-btn" id="mobSignOutBtn" style="justify-content:flex-start;padding:0 16px">ðŸšª Sign Out</button>
    </div>
  </div>
</div>

<div class="cmd-window" id="cmdWindow">
<div class="cmd-titlebar" id="cmdTitlebar">
<span class="cmd-icon">â– </span>
<span class="cmd-title">AI Console</span>
<div class="cmd-controls">
<select class="cmd-model-select" id="cmdModelSelect">
<option value="claude-haiku-4-5-20251001">haiku-4.5</option>
<option value="claude-sonnet-4-5-20250929" selected>sonnet-4.5</option>
<option value="claude-opus-4-5-20251101">opus-4.5</option>
</select>
<button class="cmd-ctrl-btn" id="cmdMinimize" title="Minimize">â”€</button>
<button class="cmd-ctrl-btn" id="cmdClose" title="Close">Ã—</button>
</div>
</div>
<div class="cmd-body" id="cmdBody">
<div class="cmd-line muted">Click a suggestion below or type your own question.</div>
</div>
<div class="cmd-suggestions" id="cmdSuggestions"></div>
<div class="cmd-input-row">
<span class="cmd-prompt">&gt;</span>
<input type="text" class="cmd-input" id="cmdInput" placeholder="Ask about your project...">
<div class="cmd-btn-row">
<button class="cmd-btn" id="cmdAsk">Ask</button>
<button class="cmd-btn primary" id="cmdTell">Tell me</button>
</div>
</div>
</div>
<div class="modal-popover report-popover" id="reportModal"><div class="modal-head"><span class="modal-title">Project Status Report</span><select class="report-model-select" id="reportModelSelect"><option value="claude-sonnet-4-5-20250929">Sonnet 4.5</option><option value="claude-opus-4-5-20251101">Opus 4.5</option></select><span class="report-model-badge" id="reportModelBadge"></span><button class="report-refresh-btn" id="reportRefresh" title="Regenerate report">â†»</button><button class="modal-close" id="reportClose">Ã—</button></div><div class="modal-body"><div class="report-content" id="reportContent"></div></div><div class="modal-foot"><button class="btn btn-primary" id="reportCreatePDF"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>Create PDF</button></div></div>
<div class="modal-popover report-popover portfolio-popover" id="portfolioReportModal"><div class="modal-head"><span class="modal-title">Portfolio Status Report</span><select class="report-model-select" id="portfolioModelSelect"><option value="claude-sonnet-4-5-20250929">Sonnet 4.5</option><option value="claude-opus-4-5-20251101">Opus 4.5</option></select><span class="report-model-badge" id="portfolioModelBadge"></span><button class="report-refresh-btn" id="portfolioRefresh" title="Regenerate report">â†»</button><button class="modal-close" id="portfolioReportClose">Ã—</button></div><div class="modal-body"><div class="report-content" id="portfolioReportContent"></div></div><div class="modal-foot"><button class="btn btn-primary" id="portfolioCreatePDF"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>Create PDF</button></div></div>
<div class="popover eta-popover" id="etaPopover">
<div class="eta-popover-header"><span class="eta-popover-name" id="etaPartName"></span><span class="eta-popover-code" id="etaCode"></span></div>
<div class="eta-popover-history" id="etaHistory"></div>
<div class="eta-popover-input"><label>Expected Arrival Date</label><input type="date" id="etaDateInput"></div>
<div class="eta-popover-actions"><button class="btn" id="etaClear">Clear</button><button class="btn btn-primary" id="etaSave">Save</button></div>
</div>
<div class="modal-bg" id="bomModal"><div class="modal bom-modal"><div class="modal-head"><span class="modal-title" id="bomTitle">ðŸ’¾ Save Specification</span><button class="modal-close" id="bomClose">Ã—</button></div><div class="modal-body"><div class="field" id="bomNameField"><label class="field-label">Specification Name</label><input type="text" class="field-input" id="bomName" placeholder="e.g. Standard Control Panel"></div><div class="bom-list" id="bomList"></div></div><div class="modal-foot"><button class="btn" id="bomCancel">Cancel</button><button class="btn btn-primary" id="bomSave">Save</button></div></div></div>
<div class="modal-bg" id="leadtimeModal"><div class="modal leadtime-modal"><div class="modal-head"><span class="modal-title">ðŸ“Š Lead Time Database</span><button class="modal-close" id="ltClose">Ã—</button></div><div class="modal-body" id="ltBody"></div><div class="modal-foot"><button class="btn" id="ltClear">Clear Data</button><button class="btn btn-primary" id="ltDone">Done</button></div></div></div>
<div class="modal-bg" id="itemConfigModal"><div class="modal itemconfig-modal"><div class="modal-head"><span class="modal-title">âš™ï¸ Item Code Configuration</span><button class="modal-close" id="icClose">Ã—</button></div><div class="modal-body"><p style="font-size:12px;color:var(--text2);margin-bottom:12px">Configure testing and configuration requirements per item code. These settings persist across projects.</p><div class="itemconfig-add"><input type="text" id="icNewCode" placeholder="Enter item code..."><button id="icAddBtn">Add Code</button></div><div class="itemconfig-list" id="icList"></div></div><div class="modal-foot"><button class="btn btn-primary" id="icDone">Done</button></div></div></div>
<div class="modal-bg" id="otdModal"><div class="modal otd-modal"><div class="modal-head"><span class="modal-title">ðŸšš Supplier On-Time Delivery</span><button class="modal-close" id="otdClose">Ã—</button></div><div class="modal-body" id="otdBody"></div><div class="modal-foot"><button class="btn btn-primary" id="otdDone">Done</button></div></div></div>
<div class="popover-backdrop" id="popoverBackdrop"></div>
<div class="bar-tooltip" id="barTooltip"></div>

<!-- Insights Panel -->
<div class="insights-panel" id="insightsPanel">
<div class="insights-header">
<div class="insights-title">Insights</div>
<div class="insights-header-actions">
<div class="ai-console-btn insights-ai-toggle" id="insightsAIBtn" tabindex="-1"><div class="ai-console-icon"><span class="ai-console-plus"></span></div></div>
<button class="insights-close" id="insightsClose">Ã—</button>
</div>
</div>
<div class="insights-body" id="insightsBody"></div>
<div class="insights-ai-chat" id="insightsAIChat">
<div class="insights-ai-output" id="insightsAIOutput"></div>
<div class="insights-ai-input-area">
<div class="insights-ai-input-wrap">
<input type="text" class="insights-ai-input" id="insightsAIInput" placeholder="Reply...">
<div class="insights-ai-input-footer">
<div class="insights-ai-input-actions">
<button class="insights-ai-clear" id="insightsAIClear">Clear</button>
</div>
<div class="insights-ai-buttons">
<select class="insights-ai-model" id="insightsAIModel">
<option value="claude-haiku-4-5-20251001" selected>Haiku</option>
<option value="claude-sonnet-4-5-20250929">Sonnet</option>
</select>
<button class="insights-ai-summary-btn" id="insightsAISummaryBtn">Summary</button>
<button class="insights-ai-ask-btn" id="insightsAIAskBtn">â†‘</button>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Master Insights Panel -->
<div class="insights-panel master-insights" id="masterInsightsPanel">
<div class="insights-header">
<div class="insights-title">Portfolio Insights</div>
<button class="insights-close" id="masterInsightsClose" onclick="closeMasterInsightsPanel()">Ã—</button>
</div>
<div class="insights-body" id="masterInsightsBody"></div>
</div>

<!-- Metrics Popover -->
<div class="metrics-popover" id="metricsPopover">
<div class="metrics-section metrics-section-full">
<div class="metrics-section-title">Progress Chart <span id="mpDeadlineLabel" style="font-weight:normal;color:var(--text-muted);font-size:11px;margin-left:8px"></span></div>
<div class="mp-chart-wrapper" style="position:relative">
<div class="mp-chart-container" id="mpChart"></div>
<div class="mp-chart-tooltip" id="mpChartTooltip"></div>
<div class="mp-forecast-popover" id="mpForecastPopover" style="display:none">
  <button class="mp-forecast-popover-close" onclick="$('mpForecastPopover').style.display='none'">Ã—</button>
  <div class="mp-forecast-popover-title" id="mpForecastPopoverTitle">Forecasted Finish</div>
  <div id="mpForecastPopoverContent"></div>
</div>
</div>
<div class="mp-chart-legend"><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--green)"></span>Ahead</span><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--red)"></span>Behind</span><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--text3)"></span>Target</span><span class="mp-legend-item"><span style="width:16px;height:2px;background:repeating-linear-gradient(90deg,var(--text3) 0,var(--text3) 3px,transparent 3px,transparent 6px);opacity:0.7;border-radius:1px"></span>Forecast</span><span class="mp-legend-item"><span style="width:1px;height:10px;background:var(--accent);opacity:0.5"></span>Today</span><span class="mp-legend-item"><span style="width:1px;height:10px;background:var(--red);opacity:0.5"></span>Deadline</span></div>
</div>
<div class="metrics-section">
<div class="metrics-section-title">Velocity Forecast</div>
<div class="mp-forecast" id="mpForecast"></div>
</div>
</div>
<div class="modal-popover" id="partModal"><div class="modal-head"><span class="modal-title" id="pmTitle">Add Part</span><button class="modal-close" id="pmClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="pmName"></div><div class="field-row"><div class="field"><label class="field-label">Item Code</label><input type="text" class="field-input" id="pmCode"></div><div class="field"><label class="field-label">Manufacturer</label><input type="text" class="field-input" id="pmMfr"></div></div><div class="field-row"><div class="field"><label class="field-label">Qty</label><input type="number" class="field-input" id="pmQty" value="1" min="1"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="pmAssignee"></select></div></div><div class="field-row"><div class="field"><label class="field-label">Status</label><select class="field-select" id="pmStatus"><option value="waiting">Waiting</option><option value="to-order">To Order</option><option value="ordered">Ordered</option><option value="arrived">Arrived</option><option value="tested">Tested</option><option value="configured">Configured</option><option value="installed">Installed</option></select></div><div class="field"><label class="field-label">Assembly</label><select class="field-select" id="pmParent"></select></div></div><div class="field"><label class="field-label">Notes</label><textarea class="field-textarea" id="pmNotes"></textarea></div><button class="notify-btn" id="pmNotify" disabled>ðŸ”” Notify</button></div><div class="modal-foot"><button class="btn" id="pmCancel">Cancel</button><button class="btn btn-primary" id="pmSave">Save</button></div></div>
<div class="modal-popover" id="asmModal"><div class="modal-head"><span class="modal-title" id="amTitle">Add Assembly</span><button class="modal-close" id="amClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="amName"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="amAssignee"></select></div><div class="field"><label class="field-label">Notes</label><textarea class="field-textarea" id="amNotes"></textarea></div><button class="notify-btn" id="amNotify" disabled>ðŸ”” Notify</button></div><div class="modal-foot"><button class="btn" id="amCancel">Cancel</button><button class="btn btn-primary" id="amSave">Save</button></div></div>

<div class="modal-bg" id="teamModal"><div class="modal"><div class="modal-head"><span class="modal-title">Team</span><button class="modal-close" id="teamClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="teamName"></div><div class="field"><label class="field-label">Email</label><input type="email" class="field-input" id="teamEmail"></div><button class="btn btn-primary" id="teamAdd" style="width:100%">Add</button><div class="team-list" id="teamList"></div></div><div class="modal-foot"><button class="btn" id="teamDone">Done</button></div></div></div>
<div class="modal-bg" id="milestonesModal"><div class="modal"><div class="modal-head"><span class="modal-title">Milestones</span><button class="modal-close" id="milestonesClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="milestoneName" placeholder="e.g. Customer Delivery"></div><div class="field"><label class="field-label">Date</label><input type="date" class="field-input" id="milestoneDate"></div><div class="field"><label class="field-label">Type</label><select class="field-input" id="milestoneType"><option value="deadline">ðŸ”´ Deadline</option><option value="delivery">ðŸŸ¢ Delivery</option><option value="review">ðŸŸ  Review</option><option value="custom">ðŸŸ£ Custom</option></select></div><button class="btn btn-primary" id="milestoneAdd" style="width:100%">Add Milestone</button><div class="team-list" id="milestoneList"></div></div><div class="modal-foot"><button class="btn" id="milestonesDone">Done</button></div></div></div>
<div class="modal-bg" id="datesModal"><div class="modal"><div class="modal-head"><span class="modal-title">Project Dates</span><button class="modal-close" id="datesClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Start</label><input type="date" class="field-input" id="startDate"></div><div class="field"><label class="field-label">End</label><input type="date" class="field-input" id="endDate"></div></div><div class="modal-foot"><button class="btn" id="datesCancel">Cancel</button><button class="btn btn-primary" id="datesSave">Save</button></div></div></div>
<div class="modal-popover theme-popover" id="themeModal"><div class="modal-head"><span class="modal-title">Theme</span><button class="modal-close" id="themeClose">Ã—</button></div><div class="modal-body"><div class="theme-grid" id="themeGrid"></div></div></div>
<div class="modal-popover activity-modal" id="activityModal"><div class="modal-header"><span>Activity History</span><button class="modal-close" id="activityClose">Ã—</button></div><div class="activity-filters"><button class="activity-filter active" data-filter="all">All</button><button class="activity-filter" data-filter="status">Status</button><button class="activity-filter" data-filter="parts">Parts</button><button class="activity-filter" data-filter="dates">Dates</button></div><div class="activity-list" id="activityFullList"></div></div>
<div class="modal-bg" id="itemConfigModal"><div class="modal" style="max-width:500px"><div class="modal-head"><span class="modal-title">âš™ï¸ Item Code Configuration</span><button class="modal-close" id="icClose">Ã—</button></div><div class="modal-body">
<div class="item-config-form" id="icForm">
<div style="font-size:11px;color:var(--text3);margin-bottom:8px">Configure which phases apply to each item code. Settings are saved globally and reused across projects.</div>
<div><label>Item Code</label><input type="text" id="icCode" placeholder="e.g., PLC-001" style="text-transform:uppercase"></div>
<div class="form-row">
<div class="checkbox-row"><input type="checkbox" id="icReqConfig"><label for="icReqConfig">Requires Configuration</label></div>
<div class="checkbox-row"><input type="checkbox" id="icReqTest" checked><label for="icReqTest">Requires Testing</label></div>
</div>
<div class="form-row">
<div><label>Configured By</label><select id="icConfigBy"><option value="">Anyone</option></select></div>
<div><label>Tested By</label><select id="icTestBy"><option value="">Anyone</option></select></div>
</div>
<div class="form-actions"><button class="secondary" id="icClear">Clear</button><button class="primary" id="icSave">Save Configuration</button></div>
</div>
<div class="item-config-list" id="icList"></div>
</div><div class="modal-foot"><button class="btn" id="icExport">Export</button><button class="btn btn-primary" id="icDone">Done</button></div></div></div>
<div class="modal-popover po-popover" id="poModal"><div class="modal-head"><span class="modal-title">Order Details</span><button class="modal-close" id="poClose">Ã—</button></div><div class="modal-body"><div id="poPartName" style="font-weight:600;margin-bottom:12px;font-size:14px"></div><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="poNumber" placeholder="e.g. PO-2024-001"></div><div class="field"><label class="field-label">Expected Arrival Date</label><input type="date" class="field-input" id="poArrivalDate"></div><div class="po-note">Leave arrival date empty to use historical lead time data</div></div><div class="modal-foot"><button class="btn" id="poCancel">Cancel</button><button class="btn btn-primary" id="poSave">Confirm Order</button></div></div>
<div class="modal-popover receive-po-popover" id="receivePOModal"><div class="modal-head"><span class="modal-title">Receive PO</span><button class="modal-close" id="receivePOClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="receivePONumber" placeholder="Enter PO number..." list="poSuggestions"><datalist id="poSuggestions"></datalist></div><div class="receive-po-preview" id="receivePOPreview"><div class="receive-po-empty">Enter a PO number to see matching parts</div></div></div><div class="modal-foot"><button class="btn" id="receivePOCancel">Cancel</button><button class="btn btn-primary" id="receivePOConfirm" disabled>Receive All</button></div></div>
<div class="popover" id="deletePopover"><div class="popover-msg" id="deleteMsg"></div><div class="popover-btns"><button class="btn" id="deleteCancel">Cancel</button><button class="btn btn-danger" id="deleteConfirm">Delete</button></div></div>
<div class="modal-popover bulk-popover" id="bulkStatusModal"><div class="modal-head"><span class="modal-title">Set Status</span><button class="modal-close" id="bulkStatusClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkStatusPreview"></div><div class="field"><label class="field-label">New Status</label><select class="field-select" id="bulkStatusSelect"><option value="">Select status...</option><option value="waiting">Waiting</option><option value="to-order">To Order</option><option value="ordered">Ordered</option><option value="arrived">Arrived</option><option value="tested">Tested</option><option value="configured">Configured</option><option value="installed">Installed</option></select></div><div id="bulkPOFields" style="display:none"><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="bulkStatusPO" placeholder="e.g. PO-2024-001"></div><div class="field"><label class="field-label">Expected Arrival Date</label><input type="date" class="field-input" id="bulkStatusETA"></div></div></div><div class="modal-foot"><button class="btn" id="bulkStatusCancel">Cancel</button><button class="btn btn-primary" id="bulkStatusApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkAssignModal"><div class="modal-head"><span class="modal-title">Set Assignee</span><button class="modal-close" id="bulkAssignClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkAssignPreview"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="bulkAssignSelect"></select></div></div><div class="modal-foot"><button class="btn" id="bulkAssignCancel">Cancel</button><button class="btn btn-primary" id="bulkAssignApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkPOModal"><div class="modal-head"><span class="modal-title">Set PO Number</span><button class="modal-close" id="bulkPOClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkPOPreview"></div><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="bulkPOInput" placeholder="e.g. PO-2024-001"></div></div><div class="modal-foot"><button class="btn" id="bulkPOCancel">Cancel</button><button class="btn btn-primary" id="bulkPOApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkDeleteModal"><div class="modal-head"><span class="modal-title">Delete Parts</span><button class="modal-close" id="bulkDeleteClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkDeletePreview"></div><p style="color:var(--red);font-size:12px;margin-top:8px">This action cannot be undone.</p></div><div class="modal-foot"><button class="btn" id="bulkDeleteCancel">Cancel</button><button class="btn btn-danger" id="bulkDeleteApply">Delete All</button></div></div>
<div class="modal-bg" id="navImportModal"><div class="modal" style="max-width:600px"><div class="modal-head"><span class="modal-title">ðŸ“¥ Import NAV Data</span><button class="modal-close" id="navImportClose">Ã—</button></div><div class="modal-body">
<div style="font-size:12px;color:var(--text2);margin-bottom:16px">Import PO data exported from NAV to automatically update parts with PO numbers, expected arrival dates, and receive arrived items.</div>
<div class="field"><label class="field-label">CSV File from NAV</label><input type="file" id="navFileInput" accept=".csv,.txt" style="display:none"><button class="btn" id="navFileBtn" style="width:100%;justify-content:center">ðŸ“ Choose CSV File...</button><div id="navFileName" style="font-size:11px;color:var(--text3);margin-top:4px"></div></div>
<div id="navPreview" style="display:none;margin-top:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:13px">Preview</span><span id="navMatchCount" style="font-size:11px;color:var(--text3)"></span></div>
<div id="navPreviewList" style="max-height:280px;overflow-y:auto;background:var(--bg);border-radius:8px;border:1px solid var(--border)"></div>
<div style="margin-top:12px;display:flex;gap:8px;align-items:center"><label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="navAutoReceive" checked> Auto-receive items marked as received in NAV</label></div>
</div>
</div><div class="modal-foot"><button class="btn" id="navImportCancel">Cancel</button><button class="btn btn-primary" id="navImportApply" disabled>Import</button></div></div></div>
<div class="popover" id="statusPopover" style="min-width:140px"><div style="font-size:11px;color:var(--text3);margin-bottom:8px">Change Status</div><div id="statusPopoverOptions"></div></div>
<div class="popover pending-popover" id="pendingPopover">
  <div class="pending-popover-header">Ready to order this part?</div>
  <div class="pending-popover-note">
    <textarea id="pendingNoteInput" placeholder="Add note about why part is pending..." rows="3"></textarea>
  </div>
  <div class="pending-popover-actions">
    <button class="btn" id="pendingNo">Not Yet</button>
    <button class="btn btn-primary" id="pendingYes">Yes, Ready â†’</button>
  </div>
</div>
<div class="popover part-info-popover" id="partInfoPopover">
  <div class="part-info-header">
    <span class="part-info-name" id="partInfoName"></span>
    <button class="modal-close" onclick="$('partInfoPopover').classList.remove('open')">Ã—</button>
  </div>
  <div class="part-info-body" id="partInfoBody"></div>
  <div class="part-info-footer">
    <button class="btn btn-sm" onclick="window.goToPartFromPopover()">View in List â†’</button>
  </div>
</div>
<div class="popover po-details-popover" id="poDetailsPopover">
<div class="po-details-header"><span class="po-details-number" id="poDetailsNumber"></span><span class="po-details-supplier" id="poDetailsSupplier"></span></div>
<div class="po-details-dates"><span id="poDetailsOrdered"></span><span id="poDetailsExpected"></span></div>
<div class="po-details-table">
<div class="po-details-thead"><span>Item</span><span>Ordered</span><span>Received</span></div>
<div class="po-details-tbody" id="poDetailsList"></div>
</div>
<div class="po-details-summary" id="poDetailsSummary"></div>
<div class="po-details-actions"><button class="btn" id="poDetailsClose" style="flex:1">Close</button><button class="btn btn-receive" id="poDetailsReceiveAll">Receive All</button></div>
</div>

<!-- New Project Modal -->
<div class="modal-bg" id="newProjectModal"><div class="modal" style="max-width:420px"><div class="modal-head"><span class="modal-title">New Project</span><button class="modal-close" id="newProjectClose">Ã—</button></div><div class="modal-body">
<div class="field"><label class="field-label">Project Name</label><input type="text" class="field-input" id="newProjectName" placeholder="e.g. MRS-450 Unit #8"></div>
<div class="field"><label class="field-label">Template</label><select class="field-input" id="newProjectTemplate"><option value="">Empty Project</option></select></div>
<div style="font-size:11px;color:var(--text3);margin-top:8px">The new project will use the shared team, lead time data, and item configurations.</div>
</div><div class="modal-foot"><button class="btn" id="newProjectCancel">Cancel</button><button class="btn btn-primary" id="newProjectCreate">Create Project</button></div></div></div>

<!-- Manage Projects Modal -->
<div class="modal-bg" id="manageProjectsModal"><div class="modal" style="max-width:520px"><div class="modal-head"><span class="modal-title">Manage Projects</span><button class="modal-close" id="manageProjectsClose">Ã—</button></div><div class="modal-body" style="padding:0">
<div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--bg2)">
<label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="showArchivedProjects"> Show archived</label>
</div>
<div id="manageProjectsList" style="max-height:400px;overflow-y:auto"></div>
</div><div class="modal-foot"><button class="btn" id="manageProjectsDone">Done</button></div></div></div>

<!-- Rename Project Modal -->
<div class="modal-bg" id="renameProjectModal"><div class="modal" style="max-width:380px"><div class="modal-head"><span class="modal-title">Rename Project</span><button class="modal-close" id="renameProjectClose">Ã—</button></div><div class="modal-body">
<div class="field"><label class="field-label">Project Name</label><input type="text" class="field-input" id="renameProjectName"></div>
</div><div class="modal-foot"><button class="btn" id="renameProjectCancel">Cancel</button><button class="btn btn-primary" id="renameProjectSave">Save</button></div></div></div>

<!-- Delete Project Modal -->
<div class="modal-bg" id="deleteProjectModal"><div class="modal" style="max-width:400px"><div class="modal-head"><span class="modal-title" style="color:var(--red)">Delete Project</span><button class="modal-close" id="deleteProjectClose">Ã—</button></div><div class="modal-body">
<div style="font-size:13px;color:var(--text);margin-bottom:16px">This will permanently delete the project and all its data. This cannot be undone.</div>
<div style="font-size:12px;color:var(--text2);margin-bottom:8px">Type the project name to confirm:</div>
<div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:8px;padding:8px;background:var(--bg2);border-radius:6px" id="deleteProjectDisplayName"></div>
<div class="field"><input type="text" class="field-input" id="deleteProjectConfirmName" placeholder="Type project name here"></div>
</div><div class="modal-foot"><button class="btn" id="deleteProjectCancel">Cancel</button><button class="btn" id="deleteProjectConfirm" style="background:var(--red);color:#fff" disabled>Delete Project</button></div></div></div>

<!-- Save as Template Modal -->
<div class="modal-bg" id="saveTemplateModal"><div class="modal" style="max-width:420px"><div class="modal-head"><span class="modal-title">ðŸ’¾ Save as Template</span><button class="modal-close" id="saveTemplateClose">Ã—</button></div><div class="modal-body">
<div style="font-size:12px;color:var(--text2);margin-bottom:16px">Save the current project structure (assemblies and parts) as a reusable template. Status, dates, and PO data will not be included.</div>
<div class="field"><label class="field-label">Template Name</label><input type="text" class="field-input" id="saveTemplateName" placeholder="e.g. MRS-450 Standard Config"></div>
<div class="field"><label class="field-label">Description (optional)</label><input type="text" class="field-input" id="saveTemplateDesc" placeholder="Brief description..."></div>
<div style="font-size:11px;color:var(--text3);margin-top:8px" id="saveTemplateStats"></div>
</div><div class="modal-foot"><button class="btn" id="saveTemplateCancel">Cancel</button><button class="btn btn-primary" id="saveTemplateSave">Save Template</button></div></div></div>

<!-- Manage Templates Modal -->
<div class="modal-bg" id="manageTemplatesModal"><div class="modal" style="max-width:520px"><div class="modal-head"><span class="modal-title">ðŸ“‹ Manage Templates</span><button class="modal-close" id="manageTemplatesClose">Ã—</button></div><div class="modal-body" style="padding:0">
<div id="templatesList" style="max-height:400px;overflow-y:auto"></div>
</div><div class="modal-foot"><button class="btn" id="manageTemplatesDone">Done</button></div></div></div>

<!-- Master Schedule Overlay -->
<div class="master-schedule-overlay" id="masterScheduleOverlay">
<div class="master-schedule-container">
<header class="header" style="position:relative;z-index:1">
<div class="project-selector">
<div class="logo" id="masterToolbarTitle" onclick="openProjectDropdownFromMaster(event)">Master Schedule</div>
<button class="project-selector-btn" onclick="openProjectDropdownFromMaster(event)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></button>
</div>
<div style="flex:1"></div>
<div class="master-toolbar-actions">
<button class="master-toolbar-btn" id="masterInsightsBtn" onclick="openMasterInsightsPanel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21H4.6c-.6 0-1.1-.5-1.1-1.1V3"/><path d="m7 14 4-4 4 4 6-6"/></svg>Insights</button>
<button class="master-toolbar-btn" id="portfolioReportBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Portfolio Report</button>
<div class="master-toolbar-sep"></div>
<label class="master-toolbar-toggle"><input type="checkbox" id="masterShowTeam">Team</label>
<label class="master-toolbar-toggle"><input type="checkbox" id="masterShowArchived">Archived</label>
<div class="master-toolbar-sep"></div>
<button class="master-toolbar-btn" id="manageSiteTripsBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/></svg>Site Trips</button>
<button class="master-toolbar-btn" id="masterToday">Today</button>
<button class="master-schedule-close" id="masterScheduleClose">Ã—</button>
</div>
</header>
<div class="master-header-row">
<div class="master-sidebar-header">
<div class="master-col-name">Project Name</div>
<div class="master-col-follows">Follows</div>
<div class="master-col-start">Start</div>
<div class="master-col-end">End</div>
<div class="master-col-dur">Days</div>
</div>
<div class="master-timeline-header-wrap" id="masterTimelineHeaderWrap">
<div class="master-timeline-header" id="masterTimelineHeader"></div>
</div>
</div>
<div class="master-body-row" id="masterBodyRow">
<div class="master-sidebar-body" id="masterSidebar"></div>
<div class="master-body-wrap" id="masterBodyWrap">
<div class="master-timeline-body" id="masterTimelineBody"></div>
</div>
</div>
<div id="masterTeamContent"></div>
<div class="master-legend">
<div class="master-legend-item"><div class="master-legend-color" style="background:#5b8fb9"></div> Site trip</div>
<div class="master-legend-item"><div class="master-legend-color" style="background:#c75959"></div> Conflict</div>
<div class="master-legend-item"><div class="master-legend-color" style="background:#c75959;width:2px"></div> Today</div>
</div>
</div>
</div>

<div class="modal-bg" id="siteTripsModal"><div class="modal" style="max-width:500px"><div class="modal-head"><span class="modal-title">Manage Site Trips</span><button class="modal-close" id="siteTripsClose">Ã—</button></div><div class="modal-body">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="field"><label class="field-label">Team Member</label><select class="field-input" id="siteTripAssignee"></select></div>
<div class="field"><label class="field-label">Site / Customer</label><input type="text" class="field-input" id="siteTripSite" placeholder="e.g. Customer ABC"></div>
<div class="field"><label class="field-label">Start Date</label><input type="date" class="field-input" id="siteTripStart"></div>
<div class="field"><label class="field-label">End Date</label><input type="date" class="field-input" id="siteTripEnd"></div>
</div>
<button class="btn btn-primary" id="siteTripAdd" style="width:100%;margin-top:12px">Add Site Trip</button>
<div class="site-trip-modal-list" id="siteTripList"></div>
</div><div class="modal-foot"><button class="btn" id="siteTripsDone">Done</button></div></div></div>

<div class="modal-bg" id="editSiteTripModal"><div class="modal" style="max-width:480px"><div class="modal-head"><span class="modal-title">Edit Site Trip</span><button class="modal-close" id="editSiteTripClose">Ã—</button></div><div class="modal-body">
<div class="field"><label class="field-label">Team Member</label><div class="field-input" id="editTripAssignee" style="background:var(--bg2);cursor:default"></div></div>
<div class="field"><label class="field-label">Site / Customer</label><input type="text" class="field-input" id="editTripSite"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="field"><label class="field-label">Start Date</label><input type="date" class="field-input" id="editTripStart"></div>
<div class="field"><label class="field-label">End Date</label><input type="date" class="field-input" id="editTripEnd"></div>
</div>
<div id="tripConflictInfo" style="margin-top:16px"></div>
</div><div class="modal-foot">
<button class="btn danger" id="editTripDelete" style="margin-right:auto">Delete</button>
<button class="btn" id="editTripCancel">Cancel</button>
<button class="btn btn-primary" id="editTripSave">Save Changes</button>
</div></div></div>

<!-- Chat -->
<div class="comments-popover" id="commentsPopover">
<div class="comments-header"><span id="commentsTitle">Comments</span><button id="commentsClose">Ã—</button></div>
<div class="comments-list" id="commentsList"></div>
<div class="comments-input"><input type="text" id="commentInput" placeholder="Add a note..." maxlength="200"><button id="commentAdd">Send</button></div>
</div>

<!-- Label Print Modal -->
<div class="modal-popover label-modal" id="labelModal">
<div class="modal-head"><span class="modal-title">ðŸ·ï¸ Print Label</span><button class="modal-close" id="labelClose">Ã—</button></div>
<div class="modal-body">
<div class="label-options">
<div class="label-option-row">
<label>Label Size</label>
<select id="labelSize">
<option value="29x90">90 Ã— 29mm (DK-1201 Landscape)</option>
<option value="102x51">102 Ã— 51mm (DK-1240)</option>
<option value="62x100">62 Ã— 100mm (DK-1202)</option>
<option value="62x29">62 Ã— 29mm (DK-1209)</option>
</select>
</div>
<div class="label-option-row">
<label>Options</label>
<div style="display:flex;flex-direction:column;gap:8px;flex:1">
<label style="display:flex;align-items:center;gap:8px;cursor:pointer;width:100%"><input type="checkbox" id="labelAssembly" checked><span class="checkbox-label">Show Assembly Name</span></label>
<label style="display:flex;align-items:center;gap:8px;cursor:pointer;width:100%"><input type="checkbox" id="labelMfr"><span class="checkbox-label">Show Manufacturer</span></label>
</div>
</div>
</div>
<div class="label-preview-container">
<div class="label-preview" id="labelPreview">
<div class="label-preview-info" id="labelPreviewInfo">
<div class="label-preview-name" id="labelPreviewName">Part Name</div>
<div class="label-preview-code" id="labelPreviewCode">CODE-123</div>
<div class="label-preview-meta" id="labelPreviewMeta">Assembly Name</div>
<div class="label-preview-project" id="labelPreviewProject" style="font-size:9px;color:#666;margin-top:4px;">Project: Project Name</div>
</div>
</div>
</div>
<div class="label-count-info" id="labelCountInfo"></div>
</div>
<div class="modal-foot">
<button class="btn" id="labelCancel">Cancel</button>
<button class="print-btn" id="labelPrint" onclick="window.printLabels()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>Print</button>
</div>
</div>

<!-- Hidden print area -->
<div id="labelPrintArea" style="display:none"></div>

<script>
(function(){

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyCuzREUYQica1pjdVgQJlXD2eh8D7Dqlo4",
  authDomain: "ebsv1-78d54.firebaseapp.com",
  databaseURL: "https://ebsv1-78d54-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ebsv1-78d54",
  storageBucket: "ebsv1-78d54.firebasestorage.app",
  messagingSenderId: "70538130924",
  appId: "1:70538130924:web:9e34e90b56e4f3f72ebcc9"
};

// Access code for the team (now serves as project code for path scoping)
const DEFAULT_PROJECT_CODE = "jaakko123";

// ============================================
// Initialize Firebase
// ============================================
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// ============================================
// Multi-Project Support
// ============================================
const globalRef = db.ref('global');
let projectIndex = {};  // {projectId: {name, archived, createdAt, updatedAt}}
let currentProjectId = null;

// Generate short alphanumeric ID for new projects
function generateProjectId() {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let id = 'p_';
  for (let i = 0; i < 6; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return id;
}

// Dynamic project reference - set after project code is entered
let projectRef = null;
let currentProjectCode = null;
let reportListener = null; // Real-time listener for report

// Set up project reference based on code
function setProjectCode(code) {
  currentProjectCode = code;
  currentProjectId = code;  // For now, code = id (will be migrated)
  projectRef = db.ref('projects/' + code);
  console.log('ðŸ“ Project path: projects/' + code);
  
  // Set up real-time report listener
  setupReportListener();
}

// Real-time listener for report - syncs across all clients
function setupReportListener() {
  // Remove old listener if exists
  if (reportListener && projectRef) {
    projectRef.child('report').off('value', reportListener);
  }
  
  if (!projectRef) return;
  
  reportListener = projectRef.child('report').on('value', snapshot => {
    const reportData = snapshot.val();
    if (reportData) {
      console.log('ðŸ“Š Report synced from Firebase:', reportData.generatedAt);
      cachedReport = reportData;
      lastReportContent = JSON.stringify(reportData, null, 2);
      
      // If report modal is open and functions are ready, update it
      if ($('reportModal')?.classList.contains('open') && typeof renderReportHTML === 'function') {
        displayCachedReport();
      }
    }
  });
}

// Display the cached report in the modal
function displayCachedReport() {
  if (!cachedReport || !cachedReport.status) {
    if (typeof showReportEmptyState === 'function') showReportEmptyState();
    return;
  }
  
  // Build context for rendering (only if function exists)
  if (typeof buildReportContext !== 'function' || typeof renderReportHTML !== 'function') {
    return;
  }
  
  const ctx = buildReportContext();
  
  // Update model badge
  const modelName = (typeof AI_MODELS !== 'undefined' && AI_MODELS[cachedReport.model]?.name) || cachedReport.model || '';
  $('reportModelBadge').textContent = modelName;
  $('reportRefresh').disabled = false;
  
  // Render the report
  $('reportContent').innerHTML = renderReportHTML(cachedReport, ctx);
}

// Save report to Firebase
function saveReportToFirebase(reportData) {
  if (!projectRef) {
    console.warn('Cannot save report: no project reference');
    return Promise.resolve();
  }
  
  return projectRef.child('report').set(reportData)
    .then(() => console.log('ðŸ“Š Report saved to Firebase'))
    .catch(e => console.error('Failed to save report to Firebase:', e));
}

window.setProjectCode = setProjectCode;
window.getCurrentProjectCode = () => currentProjectCode;

// Initialize with default (will be overwritten by login)
setProjectCode(DEFAULT_PROJECT_CODE);

// ============================================
// App State
// ============================================
const STAGES=['waiting','to-order','ordered','arrived','tested','configured','installed'];
const SLABELS={'waiting':'Waiting','to-order':'To Order','ordered':'Ordered','arrived':'Arrived','tested':'Tested','configured':'Configured','installed':'Installed'};

let data=[],team=[],expanded={},history=[],projectDates={start:'',end:''},leadTimeDb={},savedBoms=[],currentProjectName='New Project',allExpanded=false,milestones=[];
let siteTrips = []; // Global site trips for team availability tracking
let teamAssignments = {}; // { memberName: [{projectId, projectName, startDate, endDate, partCount}] }
let teamAssignmentsLoaded = false;

// Report state - synced via Firebase for all clients
let cachedReport = null;
let lastReportContent = '';

// Item Code Configuration - saved to Firebase globally (shared across all projects)
// Structure: { 'ITEM-CODE': { requiresTesting: bool, tester: string, requiresConfig: bool, configuredBy: string } }
let itemCodeConfig={};
const ITEM_CONFIG_KEY='ebs-item-code-config';
// Note: itemConfigRef is now under /global/itemCodeConfig (migrated from root /itemCodeConfig)

function loadItemCodeConfig(){
  // Load from localStorage first as fallback
  try{
    const stored=localStorage.getItem(ITEM_CONFIG_KEY);
    if(stored)itemCodeConfig=JSON.parse(stored);
  }catch(e){console.warn('Failed to load item code config from localStorage',e)}
  
  // Then sync from Firebase (now under /global/itemCodeConfig)
  globalRef.child('itemCodeConfig').on('value',snapshot=>{
    const val=snapshot.val();
    if(val){
      itemCodeConfig=val;
      // Also save to localStorage as backup
      try{localStorage.setItem(ITEM_CONFIG_KEY,JSON.stringify(itemCodeConfig))}catch(e){}
      render(); // Re-render when config changes from another client
    }
  });
}

function saveItemCodeConfig(){
  // Save to Firebase (now under /global/itemCodeConfig)
  globalRef.child('itemCodeConfig').set(itemCodeConfig).catch(e=>console.warn('Failed to save item config to Firebase',e));
  // Also save to localStorage as backup
  try{
    localStorage.setItem(ITEM_CONFIG_KEY,JSON.stringify(itemCodeConfig));
  }catch(e){console.warn('Failed to save item code config to localStorage',e)}
}

function getItemConfig(code){
  if(!code||!itemCodeConfig[code])return{requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  return itemCodeConfig[code];
}

// ============================================
// Global Data Migration (Phase 1)
// ============================================
// Migrates team, leadTime, globalCodes, globalMfrs from project-specific to global storage
// This ensures all projects share the same team and reference data

let globalDataLoaded = false;
let migrationInProgress = false;

async function checkAndRunMigration() {
  if (migrationInProgress) return;
  migrationInProgress = true;
  
  try {
    // Check if global data already exists
    const globalSnap = await globalRef.child('migrated').once('value');
    
    if (globalSnap.val()) {
      console.log('âœ“ Global data migration already complete');
      migrationInProgress = false;
      return;
    }
    
    console.log('ðŸ”„ Running global data migration...');
    
    // Read current project's shared data
    const [teamSnap, leadTimeSnap, codesSnap, mfrsSnap, itemConfigSnap] = await Promise.all([
      projectRef.child('meta/team').once('value'),
      projectRef.child('leadTime').once('value'),
      projectRef.child('globalCodes').once('value'),
      projectRef.child('globalMfrs').once('value'),
      db.ref('itemCodeConfig').once('value')  // Old root-level path
    ]);
    
    // Prepare migration data
    const updates = {};
    
    if (teamSnap.val()) {
      updates['team'] = teamSnap.val();
      console.log('  â†’ Migrating team:', Array.isArray(teamSnap.val()) ? teamSnap.val().length : Object.keys(teamSnap.val()).length, 'members');
    }
    
    if (leadTimeSnap.val()) {
      updates['leadTime'] = leadTimeSnap.val();
      console.log('  â†’ Migrating lead time data');
    }
    
    if (codesSnap.val()) {
      updates['globalCodes'] = codesSnap.val();
      console.log('  â†’ Migrating global codes');
    }
    
    if (mfrsSnap.val()) {
      updates['globalMfrs'] = mfrsSnap.val();
      console.log('  â†’ Migrating global manufacturers');
    }
    
    if (itemConfigSnap.val()) {
      updates['itemCodeConfig'] = itemConfigSnap.val();
      console.log('  â†’ Migrating item code config');
    }
    
    // Also register current project in the index
    updates['projectIndex/' + currentProjectCode] = {
      name: currentProjectName || 'Untitled Project',
      archived: false,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    updates['migrated'] = true;
    updates['migratedAt'] = firebase.database.ServerValue.TIMESTAMP;
    
    // Write all at once
    await globalRef.update(updates);
    
    console.log('âœ“ Global data migration complete');
    
  } catch (err) {
    console.error('Migration error:', err);
  }
  
  migrationInProgress = false;
}

// Load global shared data (team, leadTime, globalCodes, globalMfrs)
let templatesIndex = {};  // {templateId: {name, description, createdAt, asmCount, partCount}}

function setupGlobalListeners() {
  // Team - shared across all projects
  globalRef.child('team').on('value', snap => {
    const val = snap.val();
    if (val) {
      team = Array.isArray(val) ? val : Object.values(val);
      if (globalDataLoaded) {
        updateSelects();
        render();
      }
    }
  });
  
  // Site trips - team availability tracking
  globalRef.child('siteTrips').on('value', snap => {
    const val = snap.val();
    siteTrips = val ? Object.entries(val).map(([id, trip]) => ({ id, ...trip })) : [];
  });
  
  // Lead time database - shared across all projects
  globalRef.child('leadTime').on('value', snap => {
    leadTimeDb = snap.val() || {};
  });
  
  // Global codes - shared across all projects
  globalRef.child('globalCodes').on('value', snap => {
    const val = snap.val();
    globalCodes = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  });
  
  // Global manufacturers - shared across all projects
  globalRef.child('globalMfrs').on('value', snap => {
    const val = snap.val();
    globalMfrs = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  });
  
  // Project index - list of all projects
  globalRef.child('projectIndex').on('value', snap => {
    projectIndex = snap.val() || {};
    updateProjectDropdown();
  });
  
  // Templates index
  db.ref('templates').on('value', snap => {
    const val = snap.val() || {};
    templatesIndex = {};
    Object.entries(val).forEach(([id, tmpl]) => {
      if (tmpl.meta) {
        templatesIndex[id] = tmpl.meta;
      }
    });
    updateTemplateDropdowns();
  });
  
  globalDataLoaded = true;
  
  // Initialize portfolio report listener
  setupPortfolioReportListener();
}

// Update template dropdowns (New Project modal)
function updateTemplateDropdowns() {
  const select = $('newProjectTemplate');
  if (!select) return;
  
  const templates = Object.entries(templatesIndex)
    .map(([id, meta]) => ({ id, ...meta }))
    .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  
  select.innerHTML = '<option value="">Empty Project</option>' +
    templates.map(t => '<option value="' + esc(t.id) + '">' + esc(t.name) + ' (' + (t.asmCount || 0) + ' assemblies, ' + (t.partCount || 0) + ' parts)</option>').join('');
}

// Save global team data
function saveTeam() {
  globalRef.child('team').set(team).catch(e => console.warn('Failed to save team:', e));
}

// Save global lead time data  
function saveLeadTime() {
  globalRef.child('leadTime').set(leadTimeDb).catch(e => console.warn('Failed to save lead time:', e));
}

// Save global codes
function saveGlobalCodes() {
  globalRef.child('globalCodes').set(globalCodes).catch(e => console.warn('Failed to save global codes:', e));
}

// Save global manufacturers
function saveGlobalMfrs() {
  globalRef.child('globalMfrs').set(globalMfrs).catch(e => console.warn('Failed to save global mfrs:', e));
}

// Update project index entry
function updateProjectIndex() {
  if (!currentProjectCode) return;
  globalRef.child('projectIndex/' + currentProjectCode).update({
    name: currentProjectName,
    startDate: projectDates.start || null,
    endDate: projectDates.end || null,
    updatedAt: firebase.database.ServerValue.TIMESTAMP
  }).catch(e => console.warn('Failed to update project index:', e));
}

// ============================================
// Project Dropdown & Switching (Phase 2)
// ============================================

// Update the project dropdown UI
function updateProjectDropdown() {
  const list = $('projectDropdownList');
  if (!list) return;
  
  // Sort projects: active first (by name), then archived
  const projects = Object.entries(projectIndex)
    .map(([id, proj]) => ({ id, ...proj }))
    .sort((a, b) => {
      if (a.archived !== b.archived) return a.archived ? 1 : -1;
      return (a.name || '').localeCompare(b.name || '');
    });
  
  if (projects.length === 0) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:12px">No projects yet</div>';
    return;
  }
  
  list.innerHTML = projects.map(proj => {
    const isActive = proj.id === currentProjectCode;
    const archivedBadge = proj.archived ? '<span class="project-dropdown-item-archived">Archived</span>' : '';
    const checkMark = isActive ? 'âœ“' : '';
    return '<div class="project-dropdown-item'+(isActive?' active':'')+'" data-project-id="'+esc(proj.id)+'">' +
      '<span class="project-dropdown-item-check">'+checkMark+'</span>' +
      '<span class="project-dropdown-item-name">'+esc(proj.name || 'Untitled')+'</span>' +
      archivedBadge +
    '</div>';
  }).join('');
}

// Switch to a different project
async function switchProject(projectId) {
  if (projectId === currentProjectCode) {
    closeProjectDropdown();
    return;
  }

  const proj = projectIndex[projectId];
  if (!proj) {

    return;
  }

  console.log('ðŸ“ Switching to project:', projectId, proj.name);

  // Close Master Schedule and its panels if open
  $('masterScheduleOverlay').classList.remove('open');
  if(typeof closeMasterInsightsPanel==='function')closeMasterInsightsPanel();

  // Show loading state
  showSync('syncing', 'Switching...');
  
  // Detach current project listeners
  detachProjectListeners();
  
  // Clear current project data
  data = [];
  history = [];
  milestones = [];
  projectDates = { start: '', end: '' };
  savedBoms = [];
  expanded = {};
  
  // Clear localStorage for old project
  localStorage.removeItem('ebs-v3-project-' + currentProjectCode);
  
  // Set new project
  setProjectCode(projectId);
  currentProjectName = proj.name || 'Untitled Project';
  
  // Update URL
  const url = new URL(window.location);
  url.searchParams.set('project', projectId);
  window.history.pushState({}, '', url);
  
  // Load new project data
  await loadProjectData();
  
  // Close dropdown
  closeProjectDropdown();
  
  // Render
  updateProjectName();
  render();
  showSync('synced', 'Loaded');
  setTimeout(() => $('syncIndicator').classList.remove('active'), 1500);
}

// Detach all project-specific listeners
function detachProjectListeners() {
  if (!projectRef) return;
  
  try {
    projectRef.child('parts').off();
    projectRef.child('assemblies').off();
    projectRef.child('meta').off();
    projectRef.child('history').off();
    projectRef.child('boms').off();
  } catch (e) {
    console.warn('Error detaching listeners:', e);
  }
}

// Load project data (used after switch)
async function loadProjectData() {
  return new Promise((resolve) => {
    // Try localStorage first
    const localKey = 'ebs-v3-project-' + currentProjectCode;
    try {
      const saved = localStorage.getItem(localKey);
      if (saved) {
        const val = JSON.parse(saved);
        if (val.data && val.data.length > 0) {
          data = val.data;
          milestones = val.milestones || [];
          history = val.history || [];
          projectDates = val.projectDates || { start: '', end: '' };
          console.log('ðŸ“¦ Loaded from localStorage:', data.length, 'items');
        }
      }
    } catch (e) {
      console.warn('localStorage read error:', e);
    }
    
    // Set up realtime listeners for the new project
    setupRealtimeListener();

    // Wait a bit for Firebase to load
    setTimeout(resolve, 500);
  });
}

// Open/close dropdown
function openProjectDropdown() {
  $('projectDropdown').classList.add('open');
  updateProjectDropdown();
  updateMasterScheduleActive();
}

function closeProjectDropdown() {
  const dropdown = $('projectDropdown');
  dropdown.classList.remove('open');
  // Reset position styles (used when opened from Master Schedule title)
  dropdown.style.position = '';
  dropdown.style.top = '';
  dropdown.style.left = '';
  dropdown.style.zIndex = '';
  // Move dropdown back to project-selector if it was moved to body
  if (dropdown.dataset.movedToBody === 'true') {
    const selector = document.querySelector('.project-selector');
    if (selector) selector.appendChild(dropdown);
    delete dropdown.dataset.movedToBody;
  }
}

function updateMasterScheduleActive() {
  const isOpen = $('masterScheduleOverlay').classList.contains('open');
  $('projectDropdownMaster').classList.toggle('active', isOpen);
}

function toggleProjectDropdown() {
  const dropdown = $('projectDropdown');
  if (dropdown.classList.contains('open')) {
    closeProjectDropdown();
  } else {
    openProjectDropdown();
  }
}

// Handle URL parameters for project selection
function handleProjectUrlParam() {
  const params = new URLSearchParams(window.location.search);
  const projectId = params.get('project');
  
  if (projectId && projectId !== currentProjectCode) {
    // Will switch after global data loads
    return projectId;
  }
  return null;
}

// Save current project to its localStorage key
function saveProjectToLocalStorage() {
  if (!currentProjectCode) return;
  
  const localKey = 'ebs-v3-project-' + currentProjectCode;
  try {
    localStorage.setItem(localKey, JSON.stringify({
      data, milestones, history, projectDates, projectName: currentProjectName
    }));
  } catch (e) {
    console.warn('localStorage save error:', e);
  }
}

function getPartStages(part){
  return ['waiting','to-order','ordered','arrived','tested','configured','installed'];
}

function getNextStage(part){
  const stages=getPartStages(part);
  const currentIdx=stages.indexOf(part.status);
  if(currentIdx===-1||currentIdx>=stages.length-1)return null;
  return stages[currentIdx+1];
}
let globalCodes=[],globalMfrs=[];
let editId=null,editAsmId=null,editEtaPartId=null,filterStage='',filterAssignee='',filterPO='',searchQ='',highlightPartId=null,bomMode='save';
let selectedParts=new Set(),lastSelectedPartId=null;
let isAuthenticated=false,isConnected=false,isSyncing=false;

const $=id=>document.getElementById(id);
window.$=$;
const esc=s=>s?String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'):'';
window.esc=esc;

// ============================================
// Sync Indicator
// ============================================
function showSync(status,text){
  const ind=$('syncIndicator');
  const txt=$('syncText');
  ind.className='sync-indicator active '+status;
  txt.textContent=text||status;
  if(status==='synced')setTimeout(()=>ind.classList.remove('active'),2000);
}

let lastSyncTime=null;
function updateVersionInfo(){
  lastSyncTime=new Date();
  const timeStr=lastSyncTime.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  if($('infoLastSync'))$('infoLastSync').textContent=timeStr;
  if($('infoProjectId'))$('infoProjectId').textContent=currentProjectName?currentProjectName.substring(0,20):'â€”';
  if($('serverStatus'))$('serverStatus').textContent=isConnected?'Connected':'Offline';
}

// Version badge click handler
$('versionBadge').onclick=function(e){
  e.stopPropagation();
  const info=this.querySelector('.version-info');
  const rect=this.getBoundingClientRect();
  info.style.left=rect.left+'px';
  info.style.bottom=(window.innerHeight-rect.top+8)+'px';
  info.classList.toggle('open');
};
document.addEventListener('click',function(e){
  const info=document.querySelector('.version-info');
  if(info&&info.classList.contains('open')&&!e.target.closest('.version-badge')){
    info.classList.remove('open');
  }
});

// ============================================
// Firebase Data Operations - Granular Per-Entity Writes
// ============================================
let saveTimeout=null;
let isSaving=false;
let lastSyncShow=0;
let lastLocalSaveTime=0;
let lastSaveId='';
const clientId='client-'+Math.random().toString(36).substr(2,9)+'-'+Date.now();
const lastLocalWriteAt = new Map();  // Track local write times for echo suppression (by entity ID)
let serverTimeOffset = 0;  // Offset between client and server time (updated from .info/serverTimeOffset)

// Get server-aligned timestamp for cross-client merge decisions
function getServerAlignedTime() {
  return Date.now() + serverTimeOffset;
}
const SYNC_SHOW_INTERVAL=10000; // Only show sync indicator every 10 seconds max

// Dirty tracking - tracks which entities need to be written
const dirtyParts = new Set();      // part IDs that changed
const dirtyAsms = new Set();       // assembly IDs that changed  
const dirtyDeletes = new Set();    // IDs that were deleted (format: "part:id" or "asm:id")
let dirtyMeta = false;             // team, projectDates, projectName changed

// Legacy tracking (kept for field-level merge on incoming changes)
const pendingPartChanges = new Map(); // partId -> {fields that changed}
const pendingAsmChanges = new Map();  // asmId -> {fields that changed}
let pendingMetaChanges = false;

// Generate collision-proof IDs using Firebase push keys
function generateId() {
  return db.ref().push().key;
}

// Track field-level timestamps (using server-aligned time for cross-client merge)
function updateFieldTimestamp(item, field) {
  if (!item._fieldTs) item._fieldTs = {};
  item._fieldTs[field] = getServerAlignedTime();
}

// Mark a part as dirty (needs to be saved)
function markPartChanged(partId, changedFields) {
  dirtyParts.add(String(partId));
  // Also update legacy tracking for field-level merge
  if (!pendingPartChanges.has(partId)) {
    pendingPartChanges.set(partId, new Set());
  }
  changedFields.forEach(f => pendingPartChanges.get(partId).add(f));
}

// Mark an assembly as dirty
function markAsmChanged(asmId, changedFields) {
  dirtyAsms.add(String(asmId));
  if (!pendingAsmChanges.has(asmId)) {
    pendingAsmChanges.set(asmId, new Set());
  }
  changedFields.forEach(f => pendingAsmChanges.get(asmId).add(f));
}

// Mark entity for deletion
function markDeleted(type, id) {
  dirtyDeletes.add(type + ':' + String(id));
}

// Merge remote part with local part, keeping newer field values
function mergePartFields(localPart, remotePart) {
  if (!remotePart) return localPart;
  if (!localPart) return remotePart;
  
  // TOMBSTONE WINS: if remote is deleted, mark local as deleted too
  if (remotePart._deletedAt) {
    return { ...localPart, _deletedAt: remotePart._deletedAt, _deletedBy: remotePart._deletedBy };
  }
  
  // If local was deleted but remote isn't, the item was restored or never deleted remotely
  // In this case, we trust the remote (non-deleted) version
  if (localPart._deletedAt && !remotePart._deletedAt) {
    return remotePart;
  }
  
  const merged = { ...remotePart };
  const localTs = localPart._fieldTs || {};
  const remoteTs = remotePart._fieldTs || {};
  
  // For each field, keep the one with the newer timestamp
  const fields = ['name', 'code', 'mfr', 'assignee', 'qty', 'status', 'notes', 
                  'poNumber', 'orderedAt', 'expectedArrival', 'arrivedAt', 'parentId'];
  
  fields.forEach(field => {
    const localTime = localTs[field] || 0;
    const remoteTime = remoteTs[field] || 0;
    
    if (localTime > remoteTime && localPart[field] !== undefined) {
      merged[field] = localPart[field];
      if (!merged._fieldTs) merged._fieldTs = {};
      merged._fieldTs[field] = localTime;
    }
  });
  
  // Merge comments - keep all unique comments by timestamp
  if (localPart.comments || remotePart.comments) {
    const localComments = localPart.comments || [];
    const remoteComments = remotePart.comments || [];
    const commentMap = new Map();
    
    [...remoteComments, ...localComments].forEach(c => {
      const key = c.ts + '-' + c.author;
      if (!commentMap.has(key) || commentMap.get(key).ts < c.ts) {
        commentMap.set(key, c);
      }
    });
    
    merged.comments = Array.from(commentMap.values()).sort((a, b) => a.ts - b.ts);
  }
  
  return merged;
}

// Sync pending changes after reconnection (uses granular writes)
async function syncPendingChanges() {
  if (useLocalStorage || !isConnected || !isAuthenticated) return;
  
  const hasPending = dirtyParts.size > 0 || dirtyAsms.size > 0 || 
                     dirtyDeletes.size > 0 || dirtyMeta;
  if (!hasPending) return;
  
  console.log('ðŸ”„ Syncing pending changes:', dirtyParts.size, 'parts,', dirtyAsms.size, 'assemblies');
  showSync('syncing', 'Syncing offline changes...');
  
  // Just trigger the regular save - it now does granular writes
  clearTimeout(saveTimeout);
  isSaving = false;
  save();
}

function save(){
  if(!isAuthenticated) return;
  
  // Record daily progress for burndown chart (only if project has parts)
  if(getParts().length > 0 && projectDates.start) {
    recordProgress();
  }
  
  // Always save to localStorage first (immediate, reliable)
  saveToLocalStorage();
  
  // For localStorage-only mode, we're done
  if(useLocalStorage) return;
  
  // If offline, just track that we have pending changes
  if(!isConnected) {
    console.log('ðŸ“´ Offline - changes queued for sync');
    if($('offlineOverlay').classList.contains('active')){
      const count = dirtyParts.size + dirtyAsms.size + dirtyDeletes.size;
      const el = $('offlinePending');
      if(el){
        el.textContent = count + ' pending change' + (count > 1 ? 's' : '');
        el.style.display = 'block';
      }
    }
    return;
  }
  
  clearTimeout(saveTimeout);
  
  saveTimeout=setTimeout(()=>{
    if(isSaving) return;
    
    // Check if there's anything to save
    const hasChanges = dirtyParts.size > 0 || dirtyAsms.size > 0 || 
                       dirtyDeletes.size > 0 || dirtyMeta;
    if(!hasChanges) return;
    
    isSaving=true;
    lastLocalSaveTime = Date.now();
    lastSaveId = clientId + '-' + Date.now();
    
    const now=Date.now();
    const showIndicator=now-lastSyncShow>SYNC_SHOW_INTERVAL;
    if(showIndicator) showSync('syncing','Syncing...');
    
    // Build multi-path update object for atomic write
    const updates = {};
    
    // Write dirty parts
    dirtyParts.forEach(partId => {
      const part = data.find(d => String(d.id) === partId && !d.isAsm);
      if(part) {
        const partData = {...part};
        partData._updatedAt = firebase.database.ServerValue.TIMESTAMP;
        partData._updatedBy = clientId;
        // Track local write time for echo suppression (namespaced by entity type)
        lastLocalWriteAt.set('part:' + partId, Date.now());
        updates['parts/' + partId] = partData;
      }
    });
    
    // Write dirty assemblies
    dirtyAsms.forEach(asmId => {
      const asm = data.find(d => String(d.id) === asmId && d.isAsm);
      if(asm) {
        const asmData = {...asm};
        asmData._updatedAt = firebase.database.ServerValue.TIMESTAMP;
        asmData._updatedBy = clientId;
        lastLocalWriteAt.set('asm:' + asmId, Date.now());
        updates['assemblies/' + asmId] = asmData;
      }
    });
    
    // Process deletes (write tombstone instead of null for delete-wins semantics)
    dirtyDeletes.forEach(key => {
      const [type, id] = key.split(':');
      const tombstone = {
        _deletedAt: firebase.database.ServerValue.TIMESTAMP,
        _deletedBy: clientId
      };
      if(type === 'part') {
        updates['parts/' + id] = tombstone;
        lastLocalWriteAt.set('part:' + id, Date.now());
      } else if(type === 'asm') {
        updates['assemblies/' + id] = tombstone;
        lastLocalWriteAt.set('asm:' + id, Date.now());
      }
    });
    
    // Write meta if changed
    if(dirtyMeta) {
      updates['meta/projectName'] = currentProjectName;
      updates['meta/projectDates'] = projectDates;
      // Note: team is now saved globally via saveTeam()
      updates['meta/milestones'] = milestones;
      updates['meta/updatedAt'] = firebase.database.ServerValue.TIMESTAMP;
      // Also update project index with new name
      updateProjectIndex();
    }
    
    // Also update lastSaveId for echo detection
    updates['meta/lastSaveId'] = lastSaveId;
    
    // Record today's progress to Firebase (before the update call)
    const today = new Date().toISOString().split('T')[0];
    const pct = calcOverallProgress();
    const hIdx = history.findIndex(h => h.date === today);
    if(hIdx >= 0) {
      history[hIdx].pct = pct;
    } else {
      history.push({ date: today, pct });
    }
    if(history.length > 100) history = history.slice(-100);
    // Write just today's progress to Firebase
    updates['history/' + today] = {
      date: today,
      pct,
      _updatedBy: clientId,
      _updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    console.log('ðŸ’¾ Saving:', dirtyParts.size, 'parts,', dirtyAsms.size, 'asms,', dirtyDeletes.size, 'deletes');
    
    // Atomic multi-path update
    projectRef.update(updates).then(()=>{
      isSaving=false;
      
      // Clear dirty tracking
      dirtyParts.clear();
      dirtyAsms.clear();
      dirtyDeletes.clear();
      dirtyMeta = false;
      
      // Clear legacy tracking too
      pendingPartChanges.clear();
      pendingAsmChanges.clear();
      pendingMetaChanges = false;
      
      // Progress is now recorded before the update, not after
      
      if(showIndicator){
        lastSyncShow=Date.now();
        showSync('synced','Synced âœ“');
        setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
      }
    }).catch(e=>{
      isSaving=false;
      showSync('offline','Save failed');
      console.error('Save failed:', e);
    });
  },500);
}

function saveBoms(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('boms').set(savedBoms).catch(console.error);
}

function saveExpanded(){
  // Keep expanded state local (per-user preference)
  try{localStorage.setItem('ebs-expanded',JSON.stringify(expanded))}catch(e){}
}

function loadExpanded(){
  try{const s=localStorage.getItem('ebs-expanded');if(s)expanded=JSON.parse(s)}catch(e){expanded={}}
}

function addGlobalCode(code){if(code&&!globalCodes.includes(code)){globalCodes.push(code);saveGlobalCodes()}}
function addGlobalMfr(mfr){if(mfr&&!globalMfrs.includes(mfr)){globalMfrs.push(mfr);saveGlobalMfrs()}}
function getAllCodes(){const projectCodes=[...new Set(data.filter(d=>d.code).map(d=>d.code))];return[...new Set([...globalCodes,...projectCodes])].sort()}
function getAllMfrs(){const projectMfrs=[...new Set(data.filter(d=>d.mfr).map(d=>d.mfr))];return[...new Set([...globalMfrs,...projectMfrs])].sort()}

function loadSampleBoms(){savedBoms=[{id:1,name:'Standard Control Panel',items:[{name:'Control Panel',isAsm:true},{name:'PLC CPU',code:'6ES7-1500',mfr:'Siemens',qty:1,parent:'Control Panel'}]}];saveBoms()}

function updateProjectName(){$('projectName').textContent=currentProjectName||'Untitled'}

// ============================================
// Authentication (now uses Firebase anonymous auth + project code)
// ============================================
let firebaseUser = null;

async function initAuth() {
  // Sign in anonymously - silent, no user input needed
  try {
    const userCredential = await auth.signInAnonymously();
    firebaseUser = userCredential.user;
    console.log('ðŸ” Anonymous auth successful, uid:', firebaseUser.uid);
    return true;
  } catch (error) {
    console.error('Auth error:', error);
    return false;
  }
}

function checkAuth(){
  const stored = sessionStorage.getItem('ebs-project-code');
  return !!stored && !!firebaseUser;
}

async function login(code){
  // Validate project code format (alphanumeric, 4-20 chars)
  if(!code || !/^[a-zA-Z0-9_-]{4,20}$/.test(code)) {
    
    return false;
  }
  
  // Ensure we have Firebase auth
  if(!firebaseUser) {
    const authSuccess = await initAuth();
    if(!authSuccess) {
      
      return false;
    }
  }
  
  // Set the project path
  setProjectCode(code);
  sessionStorage.setItem('ebs-project-code', code);
  isAuthenticated = true;
  $('loginScreen').style.display = 'none';
  initFirebaseListeners();
  return true;
}

function logout(){
  sessionStorage.removeItem('ebs-project-code');
  isAuthenticated = false;
  currentProjectCode = null;
  projectRef = null;
  location.reload();
}

// ============================================
// Firebase Real-time Listeners
// ============================================
const LOCAL_STORAGE_KEY = 'ebs-v3-data';
let useLocalStorage = false;
let dataInitialized = false;

function initFirebaseListeners(){
  showSync('syncing','Loading...');
  
  // Check for project ID in URL parameter first
  const params = new URLSearchParams(window.location.search);
  const urlProjectId = params.get('project');
  
  if (urlProjectId && urlProjectId !== currentProjectCode) {
    // Switch to project specified in URL
    console.log('ðŸ“ Project from URL:', urlProjectId);
    setProjectCode(urlProjectId);
  } else {
    // Check for last opened project
    const lastProject = localStorage.getItem('ebs-v3-last-project');
    if (lastProject && lastProject !== currentProjectCode) {
      console.log('ðŸ“ Resuming last project:', lastProject);
      setProjectCode(lastProject);
    }
  }
  
  // Set up global listeners first (team, leadTime, globalCodes, globalMfrs, projectIndex)
  setupGlobalListeners();
  
  // ALWAYS check localStorage first
  const localData = loadFromLocalStorage();
  
  if(localData){
    // We have local data - use it immediately
    console.log('Loaded from localStorage');
    dataInitialized = true;
    showSync('synced','Loaded');
    setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
    
    // Try to connect to Firebase for sync
    tryFirebaseSync();
    
    // Run migration if needed (async, won't block UI)
    checkAndRunMigration();
  } else {
    // No local data - try Firebase, then create sample if needed
    tryFirebaseFirst();
  }
}

let checkedLegacyPath = false;

function tryFirebaseFirst(){
  const timeout = setTimeout(()=>{
    console.log('Firebase timeout, creating local sample');
    useLocalStorage = true;
    createAndSaveSampleData();
  }, 3000);
  
  // Try to load from new granular structure first
  Promise.all([
    projectRef.child('parts').once('value'),
    projectRef.child('assemblies').once('value'),
    projectRef.child('meta').once('value'),
    projectRef.child('history').once('value'),
    projectRef.child('main').once('value')  // Check for legacy data
  ]).then(async ([partsSnap, asmsSnap, metaSnap, historySnap, mainSnap]) => {
    clearTimeout(timeout);
    
    const partsVal = partsSnap.val();
    const asmsVal = asmsSnap.val();
    const metaVal = metaSnap.val();
    const mainVal = mainSnap.val();
    
    // Check if new project path has any data
    const hasNewPathData = partsVal || asmsVal || metaVal || mainVal;
    
    // If demo project and no data at new path, try legacy /project path (once)
    if(!hasNewPathData && currentProjectCode === DEFAULT_PROJECT_CODE && !checkedLegacyPath) {
      checkedLegacyPath = true;
      console.log('No data at new path, checking legacy /project path...');
      const legacyRef = db.ref('project');
      legacyRef.child('parts').once('value').then(legacySnap => {
        if(legacySnap.val()) {
          console.log('ðŸ“¦ Found data at legacy path, using it');
          // Switch to legacy path for this session
          projectRef = legacyRef;
          // Retry with legacy path
          tryFirebaseFirst();
        } else {
          // No legacy data either, create sample
          console.log('No legacy data, creating sample');
          createAndSaveSampleData();
        }
      }).catch(() => {
        createAndSaveSampleData();
      });
      return;
    }
    
    // Check schema version (0 = legacy, 1 = migration incomplete, 2 = granular)
    const schemaVersion = metaVal?.schemaVersion || 0;
    const hasGranularData = schemaVersion >= 2 || partsVal || asmsVal;
    const hasMigrationIncomplete = schemaVersion === 1;
    const hasLegacyData = mainVal && mainVal.data && 
      (Array.isArray(mainVal.data) ? mainVal.data.length > 0 : Object.keys(mainVal.data).length > 0);
    
    if(schemaVersion >= 2 || (hasGranularData && !hasMigrationIncomplete)) {
      // Load from granular structure
      console.log('Loading from granular structure');
      data = [];
      
      // Load assemblies
      if(asmsVal) {
        Object.entries(asmsVal).forEach(([id, asm]) => {
          data.push({...asm, id, isAsm: true});
        });
      }
      
      // Load parts
      if(partsVal) {
        Object.entries(partsVal).forEach(([id, part]) => {
          data.push({...part, id});
        });
      }
      
      // Load meta
      if(metaVal) {
        currentProjectName = metaVal.projectName || 'EBS Project';
        projectDates = metaVal.projectDates || {start:'', end:''};
        // Note: team is now loaded globally via setupGlobalListeners()
        // Only use project team as fallback if global team is empty (migration period)
        if(team.length === 0 && metaVal.team) {
          team = Array.isArray(metaVal.team) ? metaVal.team : Object.values(metaVal.team);
        }
        milestones = metaVal.milestones ? (Array.isArray(metaVal.milestones) ? metaVal.milestones : Object.values(metaVal.milestones)) : [];
      }
      
      // Load history
      const historyVal = historySnap.val();
      if(historyVal) {
        history = Array.isArray(historyVal) ? historyVal : Object.values(historyVal);
      }
      
      // If data is still empty after loading, create sample data
      if(data.length === 0){
        console.log('No assemblies/parts found, creating sample data');
        createSampleData();
        await saveAllToGranular();
      }
      
      // Seed history if empty but we have data (await to ensure save completes before listener starts)
      await seedHistoryIfNeeded();
      
      updateProjectName();
      saveToLocalStorage();
      dataInitialized = true;
      showSync('synced','Connected');
      setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
      setupRealtimeListener();
      render();
      
      // Run global data migration if needed
      checkAndRunMigration();
      
    } else if(hasMigrationIncomplete && hasLegacyData) {
      // Migration was interrupted - retry from legacy data
      console.log('âš ï¸ Incomplete migration detected (schemaVersion=1), retrying...');
      loadFromSnapshot(mainVal);
      saveToLocalStorage();
      dataInitialized = true;
      
      seedHistoryIfNeeded().then(() => {
        migrateToGranular().then(() => {
          showSync('synced','Migration completed âœ“');
          setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
          setupRealtimeListener();
          checkAndRunMigration();
        });
      });
      
    } else if(hasLegacyData) {
      // Migrate from legacy blob structure
      console.log('Migrating from legacy blob structure...');
      loadFromSnapshot(mainVal);
      saveToLocalStorage();
      dataInitialized = true;
      
      // Migrate to granular structure
      seedHistoryIfNeeded().then(() => {
        migrateToGranular().then(() => {
          showSync('synced','Migrated âœ“');
          setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
          setupRealtimeListener();
          checkAndRunMigration();
        });
      });
      
    } else {
      // No data - create sample
      console.log('Firebase empty, creating sample');
      createAndSaveSampleData();
      
      // Save to granular structure
      saveAllToGranular().then(() => {
        setupRealtimeListener();
        checkAndRunMigration();
      });
    }
  }).catch(err=>{
    clearTimeout(timeout);
    console.log('Firebase error, using localStorage:', err);
    useLocalStorage = true;
    createAndSaveSampleData();
  });
}

// Migrate legacy blob data to granular structure (two-phase for safety)
async function migrateToGranular() {
  console.log('ðŸ”„ Migrating to granular structure...');
  
  // Phase 1: Mark migration in progress
  try {
    await projectRef.child('meta/schemaVersion').set(1);
  } catch(e) {
    console.error('Failed to mark migration start:', e);
    return;
  }
  
  // Phase 2: Write all granular data
  const updates = {};
  
  // Migrate parts and assemblies
  data.forEach(item => {
    const id = String(item.id);
    if(item.isAsm) {
      updates['assemblies/' + id] = item;
    } else {
      updates['parts/' + id] = item;
    }
  });
  
  // Migrate meta (except schemaVersion - we'll set that last)
  updates['meta/projectName'] = currentProjectName;
  updates['meta/projectDates'] = projectDates;
  // Note: team is now global, handled by checkAndRunMigration()
  updates['meta/milestones'] = milestones;
  updates['meta/updatedAt'] = firebase.database.ServerValue.TIMESTAMP;
  
  // Migrate history
  history.forEach((h, idx) => {
    updates['history/' + (h.date || idx)] = h;
  });
  
  try {
    await projectRef.update(updates);
    
    // Phase 3: Mark migration complete (only after all writes succeed)
    await projectRef.child('meta/schemaVersion').set(2);
    console.log('âœ… Migration complete!');
    
    // Optionally clear legacy data after successful migration
    // await projectRef.child('main').remove();
    
  } catch(e) {
    console.error('Migration failed (schemaVersion=1, will retry on next load):', e);
  }
}

// Save all current data to granular structure (for new projects)
async function saveAllToGranular() {
  const updates = {};
  
  data.forEach(item => {
    const id = String(item.id);
    if(item.isAsm) {
      updates['assemblies/' + id] = item;
    } else {
      updates['parts/' + id] = item;
    }
  });
  
  updates['meta/projectName'] = currentProjectName;
  updates['meta/projectDates'] = projectDates;
  // Note: team is now global, saved via saveTeam()
  updates['meta/milestones'] = milestones;
  updates['meta/schemaVersion'] = 2;  // Mark as granular structure
  updates['meta/updatedAt'] = firebase.database.ServerValue.TIMESTAMP;
  
  // Save history too!
  history.forEach(h => {
    updates['history/' + h.date] = {
      date: h.date,
      pct: h.pct,
      action: h.action || null
    };
  });
  
  try {
    await projectRef.update(updates);
  } catch(e) {
    console.error('Save all failed:', e);
  }
}

function tryFirebaseSync(){
  projectRef.child('main').once('value').then(snapshot=>{
    const val = snapshot.val();
    if(val && val.data){
      // Firebase has data - check if newer
      console.log('Firebase connected, setting up sync');
    }
    setupRealtimeListener();
    
  }).catch(err=>{
    console.log('Firebase unavailable, local mode only');
    useLocalStorage = true;
  });
}

function loadFromLocalStorage(){
  try {
    // Try project-specific key first
    let saved = null;
    if (currentProjectCode) {
      const projectKey = 'ebs-v3-project-' + currentProjectCode;
      saved = localStorage.getItem(projectKey);
    }
    
    // Fall back to legacy key
    if (!saved) {
      saved = localStorage.getItem(LOCAL_STORAGE_KEY);
    }
    
    if(saved){
      const val = JSON.parse(saved);
      if(val.data && val.data.length > 0){
        data = val.data;
        team = val.team || team; // Keep existing team if not in saved data (team is global now)
        milestones = val.milestones || [];
        history = val.history || [];
        projectDates = val.projectDates || {start:'',end:''};
        currentProjectName = val.projectName || 'EBS Project';
        
        // Seed history if insufficient for chart - ALWAYS ensure we have 2+ points
        if(history.length < 2 && data.length > 0 && projectDates.start){
          const today = new Date().toISOString().split('T')[0];
          const parts = data.filter(d => !d.isAsm);
          const WEIGHTS = {'waiting':0,'to-order':20,'ordered':40,'arrived':70,'installed':100};
          const currentPct = parts.length ? Math.round(parts.reduce((acc, p) => acc + (WEIGHTS[p.status] || 0), 0) / parts.length) : 0;
          
          // Use project start date, or 7 days ago if project start is in the future
          const startDate = new Date(projectDates.start);
          const todayDate = new Date(today);
          
          if(startDate <= todayDate){
            // Project already started - create history from start to today
            history = [{date: projectDates.start, pct: 0}];
            // Add intermediate points if project is more than 7 days old
            const daysSinceStart = Math.floor((todayDate - startDate) / 86400000);
            if(daysSinceStart > 14){
              const midDate = new Date(startDate.getTime() + (todayDate - startDate) / 2);
              history.push({date: midDate.toISOString().split('T')[0], pct: Math.round(currentPct / 2)});
            }
            history.push({date: today, pct: currentPct});
          } else {
            // Project hasn't started yet - just use today
            const weekAgo = new Date(Date.now() - 7*86400000).toISOString().split('T')[0];
            history = [
              {date: weekAgo, pct: Math.max(0, currentPct - 10)},
              {date: today, pct: currentPct}
            ];
          }
          // Save the seeded history
          saveToLocalStorage();
        }
        
        updateProjectName();
        render();
        return true;
      }
    }
  } catch(e){
    console.error('localStorage read error:', e);
  }
  return false;
}

function saveToLocalStorage(){
  if (!currentProjectCode) return;
  
  try {
    // Save to project-specific key
    const projectKey = 'ebs-v3-project-' + currentProjectCode;
    localStorage.setItem(projectKey, JSON.stringify({
      data, milestones, history, projectDates, projectName: currentProjectName
    }));
    
    // Also save to legacy key for backward compatibility
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
      data, team, milestones, history, projectDates, projectName: currentProjectName
    }));
    
    // Remember last opened project
    localStorage.setItem('ebs-v3-last-project', currentProjectCode);
  } catch(e){
    console.error('localStorage save error:', e);
  }
}

function createAndSaveSampleData(){
  createSampleData();
  saveToLocalStorage();
  dataInitialized = true;
  showSync('synced','Ready');
  setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
  render();
}

function createSampleData(){
  const now=Date.now(),day=86400000;
  
  currentProjectName='Marine Radar System MRS-450 - Unit #7';
  
  // Finnish team matching test projects for consistency
  team=[
    {name:'Antti Korhonen',email:'antti.korhonen@radarfi.com'},      // Production Supervisor
    {name:'Mikko Lahtinen',email:'mikko.lahtinen@radarfi.com'},      // Tester 1
    {name:'Sari Virtanen',email:'sari.virtanen@radarfi.com'},        // Tester 2
    {name:'Jukka Heikkinen',email:'jukka.heikkinen@radarfi.com'},    // Assembler 1
    {name:'Tuomas Niemi',email:'tuomas.niemi@radarfi.com'},          // Project Manager
    {name:'Laura Salo',email:'laura.salo@radarfi.com'},              // R&D Engineer
    {name:'Kaisa MÃ¤kinen',email:'kaisa.makinen@radarfi.com'}         // Quality
  ];
  
  // Project: Oct 2025 - March 2026 (typical 5-month radar project per document)
  projectDates={start:'2025-10-01',end:'2026-03-31'};
  
  // Sample milestones
  milestones=[
    {id:1,name:'Design Review',date:'2025-11-15',type:'review'},
    {id:2,name:'Customer Inspection',date:'2026-01-20',type:'review'},
    {id:3,name:'Factory Acceptance Test',date:'2026-02-28',type:'deadline'},
    {id:4,name:'Customer Delivery',date:'2026-03-15',type:'delivery'}
  ];
  
  // Sample history for burndown chart (simulated progress from project start)
  history=[
    {date:'2025-10-01',pct:0},
    {date:'2025-10-15',pct:5},
    {date:'2025-11-01',pct:12},
    {date:'2025-11-15',pct:18},
    {date:'2025-12-01',pct:28},
    {date:'2025-12-15',pct:35},
    {date:'2026-01-01',pct:42},
    {date:new Date().toISOString().split('T')[0],pct:48}
  ];
  
  // Calculate timestamps for sample data
  const projectStart=new Date('2025-10-01').getTime();
  const simToday=now; // Use actual current time
  
  // PO number generator
  let poCounter=2026001;
  const getPO=()=>'PO-'+(poCounter++);
  
  // Notes reflecting radar manufacturing context from document
  const partNotes={
    'RF Transmitter Module':'CRITICAL - Safety-critical component per document rules. Full testing required, no shortcuts.',
    'Waveguide Assembly':'Custom fabrication by Precision Metals Oy. 50% deposit paid per policy. Weekly progress calls.',
    'X-Band Antenna':'UK sister company shipment - budget 7-10 days for customs per document guidelines.',
    'Signal Processor Board':'R&D completed design validation. Firmware V2.4 required.',
    'Power Amplifier 500W':'High-value item (â‚¬8,200). Dual approval obtained (Tuomas + Finance) per â‚¬5k rule.',
    'Rotary Joint':'Long lead item - 6 week lead time. Specialized RF component per document.',
    'Magnetron':'SAFETY CRITICAL - Requires calibration certificate. Reject if missing per document rules.',
    'Slip Ring Assembly':'Custom spec from R&D. 18-channel configuration.',
    'Radome':'Fiberglass construction. Weather seal inspection required.',
    'Motor Drive Unit':'Yaskawa specialist needed for commissioning. Training scheduled Feb 25.'
  };
  
  // Realistic multi-person conversations with Finnish team
  const partComments={
    'RF Transmitter Module':[
      {text:'Initial testing started. Running thermal validation.',ts:simToday-8*day,author:'Mikko'},
      {text:'Thermal test passed at 45Â°C ambient. Starting RF calibration tomorrow.',ts:simToday-6*day,author:'Mikko'},
      {text:'Calibration certificate received from manufacturer. All parameters within spec.',ts:simToday-4*day,author:'Sari'},
      {text:'Ready for integration. Moving to configured status.',ts:simToday-2*day,author:'Antti'}
    ],
    'Waveguide Assembly':[
      {text:'Precision Metals confirmed start of fabrication. 50% deposit sent.',ts:simToday-20*day,author:'Tuomas'},
      {text:'Progress photos received - machining 60% complete.',ts:simToday-12*day,author:'Antti'},
      {text:'Surface finish issue found. Rework in progress, +3 days to schedule.',ts:simToday-8*day,author:'Tuomas'},
      {text:'Rework complete. Final inspection tomorrow, ship Friday.',ts:simToday-3*day,author:'Antti'}
    ],
    'X-Band Antenna':[
      {text:'Shipped from UK today. DHL tracking: 1234567890',ts:simToday-14*day,author:'Tuomas'},
      {text:'Stuck in customs. Missing commercial invoice. Contacted UK team.',ts:simToday-10*day,author:'Antti'},
      {text:'Customs cleared! Delivery tomorrow morning.',ts:simToday-5*day,author:'Antti'},
      {text:'Received. Minor cosmetic damage to protective cover - acceptable.',ts:simToday-4*day,author:'Jukka'}
    ],
    'Signal Processor Board':[
      {text:'Matti confirmed firmware V2.4 ready for flash.',ts:simToday-15*day,author:'Tuomas'},
      {text:'Board arrived. Visual inspection OK, starting power-on test.',ts:simToday-10*day,author:'Mikko'},
      {text:'All self-tests passed. Firmware loaded successfully.',ts:simToday-8*day,author:'Mikko'}
    ],
    'Power Amplifier 500W':[
      {text:'Quote received: â‚¬8,200. Need dual approval per >â‚¬5k policy.',ts:simToday-25*day,author:'Antti'},
      {text:'Approved by Tuomas and Finance. Order placed.',ts:simToday-23*day,author:'Tuomas'},
      {text:'Shipped via express. ETA Thursday.',ts:simToday-6*day,author:'Antti'}
    ],
    'Magnetron':[
      {text:'IMPORTANT: Cal cert MUST accompany this part. Do not accept without it.',ts:simToday-30*day,author:'Matti'},
      {text:'Delivery attempted but driver had no cal cert. Refused shipment per policy.',ts:simToday-12*day,author:'Antti'},
      {text:'Supplier reshipping with proper documentation. New ETA +5 days.',ts:simToday-10*day,author:'Tuomas'}
    ],
    'Rotary Joint':[
      {text:'6-week lead time confirmed. This is critical path.',ts:simToday-35*day,author:'Tuomas'},
      {text:'Week 3 update: Joint housing complete, electrical work starting.',ts:simToday-14*day,author:'Antti'},
      {text:'On track for delivery next week. Sari will run continuity tests.',ts:simToday-3*day,author:'Tuomas'}
    ],
    'Motor Drive Unit':[
      {text:'Standard unit wont work - need custom parameters for radar rotation.',ts:simToday-20*day,author:'Matti'},
      {text:'Yaskawa confirmed factory programming available. +â‚¬400.',ts:simToday-18*day,author:'Antti'},
      {text:'Approved. They need our parameter file by Friday.',ts:simToday-16*day,author:'Tuomas'}
    ],
    'Radar Cabinet':[
      {text:'Konepaja Virtanen starting fabrication Monday.',ts:simToday-25*day,author:'Antti'},
      {text:'Cabinet 80% complete. Paint booth available Thursday.',ts:simToday-10*day,author:'Jukka'},
      {text:'Delivered! Mounting frame fits perfectly.',ts:simToday-6*day,author:'Pekka'}
    ],
    'Safety PLC':[
      {text:'Waiting for safety assessment approval from UK customer.',ts:simToday-8*day,author:'Tuomas'},
      {text:'Customer safety engineer reviewing next week.',ts:simToday-5*day,author:'Matti'}
    ]
  };
  
  // Radar system assemblies matching document structure
  const partTemplates=[
    {asm:'RF Transmitter Unit',priority:1,parts:[
      {name:'RF Transmitter Module',code:'RF-TX-450',mfr:'UK Sister Co',status:'arrived',daysInStatus:2},
      {name:'Power Amplifier 500W',code:'PA-500W',mfr:'Ampleon',status:'arrived',daysInStatus:3},
      {name:'Frequency Synthesizer',code:'FS-X01',mfr:'Analog Devices',status:'arrived',daysInStatus:4},
      {name:'RF Isolator',code:'ISO-9GHZ',mfr:'DiTom',status:'installed',daysInStatus:12},
      {name:'Directional Coupler',code:'DC-20DB',mfr:'Krytar',status:'installed',daysInStatus:10},
      {name:'Waveguide Assembly',code:'WG-CUST',mfr:'Precision Metals Oy',status:'ordered',daysInStatus:5},
      {name:'RF Cables Set',code:'RFC-SET',mfr:'Times Microwave',status:'installed',daysInStatus:15},
      {name:'EMI Shielding',code:'EMI-TX',mfr:'Laird',status:'installed',daysInStatus:18}
    ]},
    {asm:'Antenna Assembly',priority:2,parts:[
      {name:'X-Band Antenna',code:'ANT-X9G',mfr:'UK Sister Co',status:'arrived',daysInStatus:4},
      {name:'Radome',code:'RDM-450',mfr:'Saint-Gobain',status:'arrived',daysInStatus:5},
      {name:'Antenna Mount',code:'MNT-HVY',mfr:'Konecranes',status:'installed',daysInStatus:20},
      {name:'Rotary Joint',code:'RJ-18CH',mfr:'Cobham',status:'ordered',daysInStatus:8},
      {name:'Slip Ring Assembly',code:'SR-18',mfr:'Moog',status:'arrived',daysInStatus:6},
      {name:'Bearing Assembly',code:'BRG-SL',mfr:'SKF',status:'installed',daysInStatus:15},
      {name:'Weather Seal Kit',code:'WS-KIT',mfr:'Parker',status:'installed',daysInStatus:12},
      {name:'Encoder',code:'ENC-ABS',mfr:'Heidenhain',status:'arrived',daysInStatus:4}
    ]},
    {asm:'Signal Processing Unit',priority:3,parts:[
      {name:'Signal Processor Board',code:'SPB-450',mfr:'In-House',status:'tested',daysInStatus:6},
      {name:'FPGA Module',code:'FPGA-K7',mfr:'Xilinx',status:'configured',daysInStatus:5},
      {name:'ADC Board',code:'ADC-14B',mfr:'Analog Devices',status:'tested',daysInStatus:5},
      {name:'DSP Module',code:'DSP-C66',mfr:'Texas Instruments',status:'installed',daysInStatus:10},
      {name:'Memory Module 32GB',code:'MEM-32G',mfr:'Kingston',status:'installed',daysInStatus:12},
      {name:'Backplane',code:'BP-6SL',mfr:'Elma',status:'installed',daysInStatus:18},
      {name:'Cooling Fan Assembly',code:'FAN-SP',mfr:'Sanyo Denki',status:'configured',daysInStatus:15},
      {name:'Debug Interface',code:'DBG-USB',mfr:'FTDI',status:'arrived',daysInStatus:3}
    ]},
    {asm:'Power System',priority:4,parts:[
      {name:'Main Power Supply',code:'PSU-48V',mfr:'TDK-Lambda',status:'arrived',daysInStatus:4},
      {name:'DC-DC Converters Set',code:'DCDC-SET',mfr:'Vicor',status:'installed',daysInStatus:10},
      {name:'UPS Module',code:'UPS-1KVA',mfr:'APC',status:'arrived',daysInStatus:5},
      {name:'Battery Pack',code:'BAT-48V',mfr:'Panasonic',status:'arrived',daysInStatus:3},
      {name:'Power Distribution Board',code:'PDB-01',mfr:'In-House',status:'arrived',daysInStatus:8},
      {name:'Surge Protection',code:'SPD-48',mfr:'Phoenix Contact',status:'installed',daysInStatus:12},
      {name:'Power Cables',code:'PWR-CBL',mfr:'Lapp',status:'installed',daysInStatus:15},
      {name:'Main Breaker',code:'MCB-63A',mfr:'ABB',status:'installed',daysInStatus:18}
    ]},
    {asm:'Motor Drive System',priority:5,parts:[
      {name:'Motor Drive Unit',code:'VFD-3KW',mfr:'Yaskawa',status:'arrived',daysInStatus:5},
      {name:'Servo Motor',code:'SGM-3KW',mfr:'Yaskawa',status:'arrived',daysInStatus:4},
      {name:'Gearbox',code:'GB-50:1',mfr:'Neugart',status:'installed',daysInStatus:12},
      {name:'Motor Cable',code:'MC-10M',mfr:'Lapp',status:'installed',daysInStatus:14},
      {name:'Encoder Cable',code:'EC-10M',mfr:'Lapp',status:'installed',daysInStatus:14},
      {name:'Brake Resistor',code:'BR-1KW',mfr:'Danfoss',status:'installed',daysInStatus:10},
      {name:'Motor Mount',code:'MM-CUST',mfr:'Konepaja Virtanen',status:'arrived',daysInStatus:6},
      {name:'Limit Switches',code:'LS-SET',mfr:'Omron',status:'installed',daysInStatus:15}
    ]},
    {asm:'Control Unit',priority:6,parts:[
      {name:'Industrial PC',code:'IPC-I7',mfr:'Advantech',status:'arrived',daysInStatus:10},
      {name:'Display 19"',code:'DSP-19',mfr:'Advantech',status:'arrived',daysInStatus:4},
      {name:'Keyboard Panel',code:'KBD-IP65',mfr:'InduKey',status:'installed',daysInStatus:12},
      {name:'Trackball Mouse',code:'TBM-IP65',mfr:'NSI',status:'installed',daysInStatus:12},
      {name:'Ethernet Switch',code:'ETH-8P',mfr:'Cisco',status:'installed',daysInStatus:15},
      {name:'GPS Receiver',code:'GPS-01',mfr:'u-blox',status:'arrived',daysInStatus:3},
      {name:'Compass Module',code:'CMP-01',mfr:'Honeywell',status:'arrived',daysInStatus:3},
      {name:'Control Panel Enclosure',code:'ENC-CTL',mfr:'Rittal',status:'installed',daysInStatus:20}
    ]},
    {asm:'Main Enclosure',priority:7,parts:[
      {name:'Radar Cabinet',code:'CAB-MAIN',mfr:'Konepaja Virtanen',status:'arrived',daysInStatus:6},
      {name:'Mounting Frame',code:'MF-INT',mfr:'Konepaja Virtanen',status:'installed',daysInStatus:15},
      {name:'Cable Entry Plates',code:'CEP-SET',mfr:'Roxtec',status:'installed',daysInStatus:18},
      {name:'Cooling System',code:'AC-2KW',mfr:'Rittal',status:'arrived',daysInStatus:5},
      {name:'Door Switches',code:'DS-SET',mfr:'Schmersal',status:'installed',daysInStatus:12},
      {name:'Internal Lighting',code:'LED-INT',mfr:'Phoenix Contact',status:'installed',daysInStatus:20},
      {name:'DIN Rails Set',code:'DIN-SET',mfr:'Phoenix Contact',status:'installed',daysInStatus:22},
      {name:'Terminal Blocks',code:'TB-SET',mfr:'Wago',status:'installed',daysInStatus:20}
    ]},
    {asm:'Safety System',priority:8,parts:[
      {name:'Magnetron',code:'MAG-X9G',mfr:'CPI',status:'ordered',daysInStatus:10},
      {name:'RF Safety Interlock',code:'INT-RF',mfr:'Pilz',status:'arrived',daysInStatus:4},
      {name:'E-Stop Assembly',code:'ESTOP-3',mfr:'ABB',status:'installed',daysInStatus:15},
      {name:'Safety Relay',code:'PNOZ-S4',mfr:'Pilz',status:'arrived',daysInStatus:8},
      {name:'Warning Lights',code:'WL-SET',mfr:'Patlite',status:'installed',daysInStatus:12},
      {name:'Radiation Warning Signs',code:'SGN-RF',mfr:'Brady',status:'installed',daysInStatus:20},
      {name:'Interlock Key Switch',code:'KS-INT',mfr:'Schmersal',status:'installed',daysInStatus:14},
      {name:'Safety PLC',code:'S7-F',mfr:'Siemens',status:'waiting',daysInStatus:5,pendingNote:'Waiting for safety assessment approval from UK customer'}
    ]},
    {asm:'Interface Modules',priority:9,parts:[
      {name:'Serial Interface',code:'RS422-4',mfr:'Moxa',status:'arrived',daysInStatus:3},
      {name:'Fiber Optic Transceiver',code:'FO-SFP',mfr:'Finisar',status:'installed',daysInStatus:10},
      {name:'NMEA Interface',code:'NMEA-01',mfr:'Actisense',status:'arrived',daysInStatus:6},
      {name:'Radar Output Module',code:'ROM-01',mfr:'In-House',status:'arrived',daysInStatus:4},
      {name:'AIS Interface',code:'AIS-01',mfr:'Weatherdock',status:'waiting',daysInStatus:5},
      {name:'Video Output Card',code:'VID-HD',mfr:'Matrox',status:'arrived',daysInStatus:4},
      {name:'Network Module',code:'NET-GB',mfr:'Intel',status:'installed',daysInStatus:12},
      {name:'USB Hub',code:'USB-7P',mfr:'Startech',status:'installed',daysInStatus:15}
    ]},
    {asm:'Documentation & Spares',priority:10,parts:[
      {name:'Technical Manual',code:'DOC-TM',mfr:'In-House',status:'waiting',daysInStatus:8,pendingNote:'Technical writer completing final review'},
      {name:'Spare Parts Kit',code:'SPK-01',mfr:'Various',status:'waiting',daysInStatus:6},
      {name:'Calibration Tools',code:'CAL-KIT',mfr:'Anritsu',status:'ordered',daysInStatus:12},
      {name:'Test Equipment Cert',code:'TEST-CERT',mfr:'Various',status:'waiting',daysInStatus:4,pendingNote:'Awaiting final calibration certs from lab'},
      {name:'Software License',code:'SW-LIC',mfr:'In-House',status:'arrived',daysInStatus:10},
      {name:'Training Materials',code:'TRN-MAT',mfr:'In-House',status:'waiting',daysInStatus:8},
      {name:'Shipping Crate',code:'CRATE-01',mfr:'Suomen Pakkaus',status:'waiting',daysInStatus:10},
      {name:'Packing Materials',code:'PACK-SET',mfr:'Various',status:'waiting',daysInStatus:10}
    ]}
  ];

  data=[];let id=1;expanded={};
  
  // Assign parts to team based on role
  const assignPart=(ai,pi)=>{
    const roles=['Antti Korhonen','Mikko Lahtinen','Sari Virtanen','Jukka Heikkinen','Laura Salo'];
    return roles[(ai+pi)%roles.length];
  };
  
  partTemplates.forEach((template,ai)=>{
    const asmId=id++;
    data.push({id:asmId,name:template.asm,isAsm:true,assignee:'Tuomas Niemi',priority:template.priority});
    expanded[String(asmId)]=ai<4;
    
    template.parts.forEach((p,pi)=>{
      const partId=id++;
      const assignee=assignPart(ai,pi);
      const changedAt=simToday-p.daysInStatus*day;
      
      // Generate PO and dates for ordered+ parts (not waiting)
      let poNumber,orderedAt,arrivedAt,expectedArrival;
      
      if(p.status!=='waiting'){
        poNumber=getPO();
        const orderDaysAgo=p.daysInStatus+Math.floor(Math.random()*10)+5;
        orderedAt=simToday-orderDaysAgo*day;
        
        // Set expected arrival based on typical lead times
        // Lead times per document: stock 3-7, standard 10-14, custom 3-4 weeks, UK +7-10 customs
        let leadDays;
        if(p.mfr==='UK Sister Co') leadDays=Math.floor(Math.random()*4)+14; // 14-18 days with customs
        else if(p.mfr.includes('Oy')||p.mfr.includes('Virtanen')||p.mfr==='In-House') leadDays=Math.floor(Math.random()*7)+18; // 18-25 days custom
        else if(p.mfr==='CPI'||p.mfr==='Cobham') leadDays=Math.floor(Math.random()*14)+28; // 28-42 days specialized RF
        else leadDays=Math.floor(Math.random()*7)+7; // 7-14 days standard
        expectedArrival=new Date(orderedAt+leadDays*day).toISOString().split('T')[0];
        
        if(['arrived','installed'].includes(p.status)){
          const actualLeadDays=leadDays+(Math.random()>0.7?Math.floor(Math.random()*5):-Math.floor(Math.random()*3));
          arrivedAt=orderedAt+actualLeadDays*day;
          if(arrivedAt>simToday)arrivedAt=simToday-p.daysInStatus*day-day;
        }
      }
      
      data.push({
        id:partId,
        name:p.name,
        code:p.code,
        mfr:p.mfr,
        qty:Math.ceil(Math.random()*2),
        assignee,
        parentId:asmId,
        status:p.status,
        changedAt,
        poNumber,
        orderedAt,
        arrivedAt,
        expectedArrival,
        pendingNote:p.pendingNote,
        notes:partNotes[p.name]||'',
        comments:partComments[p.name]?partComments[p.name].map(c=>({...c,timestamp:c.ts})):undefined
      });
    });
  });

  // Progress history - radar project timeline (per document: 3-5 months typical)
  history=[
    {date:'2025-10-01',pct:0,action:'Project kickoff with UK customer'},
    {date:'2025-10-10',pct:5,action:'R&D completed BOM finalization'},
    {date:'2025-10-20',pct:10,action:'Long-lead items ordered (rotary joint, magnetron)'},
    {date:'2025-10-31',pct:16,action:'Custom fabrication started at Precision Metals Oy'},
    {date:'2025-11-10',pct:24,action:'First parts received from distributors'},
    {date:'2025-11-20',pct:32,action:'Main enclosure delivered from Konepaja Virtanen'},
    {date:'2025-11-30',pct:40,action:'RF transmitter unit testing begun'},
    {date:'2025-12-10',pct:50,action:'Antenna assembly integration started'},
    {date:'2025-12-20',pct:56,action:'Signal processor board configured'},
    {date:'2026-01-02',pct:62,action:'Production resumed after holidays'}
  ];

  // Lead time database - radar components matching document lead time expectations
  leadTimeDb={
    'RF-TX-450':{samples:[{days:16,date:'2025-12-01'},{days:18,date:'2025-10-15'}],avg:17},    // UK with customs
    'ANT-X9G':{samples:[{days:15,date:'2025-12-10'},{days:17,date:'2025-11-05'}],avg:16},      // UK with customs
    'SPB-450':{samples:[{days:8,date:'2025-12-15'},{days:7,date:'2025-11-20'}],avg:8},         // In-house
    'PSU-48V':{samples:[{days:6,date:'2025-12-08'},{days:5,date:'2025-11-25'},{days:7,date:'2025-10-30'}],avg:6}, // Stock
    'VFD-3KW':{samples:[{days:10,date:'2025-12-12'},{days:12,date:'2025-11-18'}],avg:11},      // Standard
    'CAB-MAIN':{samples:[{days:22,date:'2025-11-28'}],avg:22},                                  // Custom fab
    'WG-CUST':{samples:[{days:25,date:'2025-10-01'}],avg:25},                                   // Custom fab
    'RJ-18CH':{samples:[{days:42,date:'2025-09-15'}],avg:42},                                   // Specialized RF
    'MAG-X9G':{samples:[{days:35,date:'2025-10-20'}],avg:35},                                   // Specialized RF  
    'IPC-I7':{samples:[{days:5,date:'2025-12-18'},{days:4,date:'2025-12-01'}],avg:5}           // Stock
  };
  
  updateProjectName();
  render();
}

function loadFromSnapshot(val){
  if(!val) return;
  
  // Only update data if Firebase actually has data - don't clear existing data on empty response
  if(val.data){
    const newData = Array.isArray(val.data) ? val.data : Object.values(val.data);
    if(newData.length > 0 || data.length === 0) {
      data = newData;
    }
  }
  // Team is now global - only load from project as fallback during migration
  if(val.team && team.length === 0){
    const newTeam = Array.isArray(val.team) ? val.team : Object.values(val.team);
    if(newTeam.length > 0) {
      team = newTeam;
    }
  }
  if(val.milestones){
    const newMilestones = Array.isArray(val.milestones) ? val.milestones : Object.values(val.milestones);
    milestones = newMilestones;
  }
  if(val.history){
    const newHistory = Array.isArray(val.history) ? val.history : Object.values(val.history);
    if(newHistory.length > 0 || history.length === 0) {
      history = newHistory;
    }
  }
  if(val.projectDates) projectDates = val.projectDates;
  if(val.projectName) currentProjectName = val.projectName;
  
  updateProjectName();
  updateVersionInfo();
  render();
}

// Seed history if empty but we have parts data (for velocity forecast to work)
// Returns a Promise that resolves when seeding is complete (or immediately if no seeding needed)
async function seedHistoryIfNeeded() {
  const parts = data.filter(d => !d.isAsm && !d._deletedAt);
  if(parts.length === 0) return; // No parts, nothing to seed
  
  // If we already have 2+ history entries, we're good
  if(history.length >= 2) return;
  
  console.log('ðŸ“Š Seeding history for velocity forecast... (current entries:', history.length, ')');
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  // Calculate current progress inline
  const WEIGHTS = {'waiting':0,'to-order':20,'ordered':40,'arrived':70,'installed':100};
  const currentPct = Math.round(parts.reduce((acc, p) => acc + (WEIGHTS[p.status] || 0), 0) / parts.length);
  
  // Determine what "first point" date to use
  // If project start exists and is today or in the past, use project start
  // Otherwise use yesterday (but this may be filtered out)
  let firstPointDate;
  let firstPointPct;
  
  if(projectDates.start) {
    const startDate = new Date(projectDates.start);
    const daysSinceStart = Math.floor((today - startDate) / 86400000);
    
    if(daysSinceStart === 0) {
      // Today IS project start - use project start with 0% and today with current%
      // But they're the same day! We need to fake a second date.
      // Use "project start" as 0% and a "synthetic" date slightly after
      firstPointDate = projectDates.start;
      firstPointPct = 0;
    } else if(daysSinceStart > 0) {
      // Project started in the past - use project start date
      firstPointDate = projectDates.start;
      firstPointPct = 0;
    } else {
      // Project hasn't started yet - use yesterday
      const yesterday = new Date(today.getTime() - 86400000);
      firstPointDate = yesterday.toISOString().split('T')[0];
      firstPointPct = Math.max(0, currentPct - 5);
    }
  } else {
    // No project dates - use yesterday
    const yesterday = new Date(today.getTime() - 86400000);
    firstPointDate = yesterday.toISOString().split('T')[0];
    firstPointPct = Math.max(0, currentPct - 5);
  }
  
  // Build history array
  if(history.length === 1) {
    // We have 1 point, add another
    if(history[0].date === todayStr) {
      // Existing point is today - add the first point before it
      if(firstPointDate !== todayStr) {
        history.unshift({ date: firstPointDate, pct: firstPointPct });
      } else {
        // Both would be today - change first point to be 0% at start of day
        history.unshift({ date: firstPointDate, pct: 0 });
      }
    } else {
      // Existing point is not today - add today
      history.push({ date: todayStr, pct: currentPct });
    }
  } else {
    // No history - create 2 points
    history = [];
    if(firstPointDate === todayStr) {
      // Project starts today - create 0% at start and current% now
      history.push({ date: firstPointDate, pct: 0 });
      // For velocity calc, we need different dates - just duplicate with different pct
      // This won't show 2 dots but velocity will work based on rate calculation
      history.push({ date: todayStr, pct: currentPct });
    } else {
      history.push({ date: firstPointDate, pct: firstPointPct });
      history.push({ date: todayStr, pct: currentPct });
    }
  }
  
  // Remove duplicates by date (keep latest pct for each date)
  const dateMap = new Map();
  history.forEach(h => dateMap.set(h.date, h));
  history = Array.from(dateMap.values()).sort((a,b) => a.date.localeCompare(b.date));
  
  console.log('ðŸ“Š Seeded history:', history);
  
  // Save ALL seeded history entries to Firebase and WAIT for completion
  if(projectRef) {
    const historyUpdates = {};
    history.forEach(h => {
      historyUpdates[h.date] = {
        date: h.date,
        pct: h.pct,
        _updatedBy: clientId,
        _updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
    });
    try {
      await projectRef.child('history').update(historyUpdates);
      console.log('ðŸ“Š Saved seeded history to Firebase');
    } catch(err) {
      console.warn('Failed to save seeded history:', err);
    }
  }
}

// Track local changes to avoid re-render on echo
let pendingRenderTimeout = null;

function setupRealtimeListener(){
  // Track initial load for UX only (not data ingestion)
  let initialLoadComplete = false;
  let saveRenderTimeout = null;
  
  // Debounced save and render to prevent jank during burst events
  function scheduleSaveAndRender() {
    if(saveRenderTimeout) return;
    saveRenderTimeout = setTimeout(() => {
      saveRenderTimeout = null;
      saveToLocalStorage();
      if(initialLoadComplete) render();
    }, 50);  // 50ms debounce for burst coalescing
  }
  
  // ========== PARTS LISTENERS ==========
  // child_added fires for ALL existing children on attach - we handle this via upsert (findIndex + replace)
  projectRef.child('parts').on('child_added', snap => {
    const part = snap.val();
    if(!part) return;
    
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && !d.isAsm);
    
    // Always upsert (idempotent) - even for own changes to ensure data consistency
    if(idx >= 0) {
      // Only merge if not our own recent change (use local write time, not server timestamp)
      if(!(part._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('part:' + id) || 0) < 3000)) {
        data[idx] = mergePartFields(data[idx], {...part, id});
      }
    } else {
      // Insert new
      data.push({...part, id});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('parts').on('child_changed', snap => {
    const part = snap.val();
    if(!part) return;
    
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && !d.isAsm);
    
    // Always upsert - only skip merge for own RECENT echoes (use local write time)
    if(idx >= 0) {
      if(!(part._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('part:' + id) || 0) < 3000)) {
        data[idx] = mergePartFields(data[idx], {...part, id});
      }
    } else {
      // Insert if somehow missing (ensures consistency)
      data.push({...part, id});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('parts').on('child_removed', snap => {
    // With tombstones, child_removed should rarely fire (only manual Firebase console deletes)
    // Handle it gracefully by marking as deleted locally
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && !d.isAsm);
    if(idx >= 0) {
      data[idx]._deletedAt = Date.now();
      scheduleSaveAndRender();
    }
  });
  
  // ========== ASSEMBLY LISTENERS ==========
  projectRef.child('assemblies').on('child_added', snap => {
    const asm = snap.val();
    if(!asm) return;
    
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && d.isAsm);
    
    // Always upsert (idempotent) - use local write time for echo suppression
    if(idx >= 0) {
      if(!(asm._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('asm:' + id) || 0) < 3000)) {
        data[idx] = mergePartFields(data[idx], {...asm, id, isAsm: true});
      }
    } else {
      data.push({...asm, id, isAsm: true});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('assemblies').on('child_changed', snap => {
    const asm = snap.val();
    if(!asm) return;
    
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && d.isAsm);
    
    // Always upsert - only skip merge for own RECENT echoes
    if(idx >= 0) {
      if(!(asm._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('asm:' + id) || 0) < 3000)) {
        data[idx] = mergePartFields(data[idx], {...asm, id, isAsm: true});
      }
    } else {
      data.push({...asm, id, isAsm: true});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('assemblies').on('child_removed', snap => {
    // With tombstones, child_removed should rarely fire (only manual Firebase console deletes)
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && d.isAsm);
    if(idx >= 0) {
      data[idx]._deletedAt = Date.now();
      scheduleSaveAndRender();
    }
  });
  
  // ========== META LISTENER ==========
  projectRef.child('meta').on('value', snap => {
    const val = snap.val();
    if(!val) return;
    
    // Skip if this is our own change
    if(val.lastSaveId === lastSaveId) return;
    
    if(val.projectName) currentProjectName = val.projectName;
    if(val.projectDates) projectDates = val.projectDates;
    // Note: team is now global, loaded via setupGlobalListeners()
    if(val.milestones) milestones = Array.isArray(val.milestones) ? val.milestones : Object.values(val.milestones);
    
    updateProjectName();
    scheduleSaveAndRender();
  });
  
  // ========== HISTORY LISTENER ==========
  projectRef.child('history').on('value', snap => {
    const val = snap.val();
    if(!val) {
      history = [];
      scheduleSaveAndRender();
      return;
    }
    history = Array.isArray(val) ? val : Object.values(val);
    // Sort chronologically to prevent zigzag chart rendering
    history.sort((a, b) => String(a.date).localeCompare(String(b.date)));
    scheduleSaveAndRender();
  });
  
  // Mark initial load complete after Firebase has sent all existing data
  // This only affects UX (render throttling), not data correctness
  projectRef.child('parts').once('value', () => {
    projectRef.child('assemblies').once('value', () => {
      initialLoadComplete = true;
      render();  // Single render after all data loaded
      console.log('âœ… Realtime listeners active, initial load complete');
      loadActivity();  // Load activity log after Firebase is confirmed ready
    });
  });
  
  // ========== AUXILIARY LISTENERS (project-specific) ==========
  projectRef.child('boms').on('value', snapshot=>{
    const val = snapshot.val();
    if(val) savedBoms = Array.isArray(val) ? val : Object.values(val);
  });
  
  // ========== CONNECTION STATUS ==========
  // Guard: only attach .info/* listeners once (they're global, not project-specific)
  if (!window._infoListenersAttached) {
    window._infoListenersAttached = true;

    let wasOffline = false;
    let offlineTimer = null;

    function updateOfflinePendingCount() {
      const count = dirtyParts.size + dirtyAsms.size + dirtyDeletes.size +
                    dirtyActions.size + dirtyActionDeletes.size;
      const el = $('offlinePending');
      if (el) {
        el.textContent = count > 0 ? count + ' pending change' + (count > 1 ? 's' : '') : 'No pending changes';
        el.style.display = count > 0 ? 'block' : 'none';
      }
    }

    db.ref('.info/connected').on('value', snapshot=>{
      isConnected = snapshot.val() === true;
      updateVersionInfo();
      if(!isConnected && !useLocalStorage && isAuthenticated){
        wasOffline = true;
        showSync('offline','Offline');
        clearTimeout(offlineTimer);
        offlineTimer = setTimeout(()=>{
          if(!isConnected && isAuthenticated){
            updateOfflinePendingCount();
            $('offlineOverlay').classList.add('active');
          }
        }, 2000);
      } else if(isConnected){
        clearTimeout(offlineTimer);
        if(wasOffline){
          wasOffline = false;
          $('offlineOverlay').classList.remove('active');
          showSync('synced','Back online');
          syncPendingChanges();
          setTimeout(()=>$('syncIndicator').classList.remove('active'),2000);
        }
      }
    });

    // Sync server time offset for accurate cross-client timestamps
    db.ref('.info/serverTimeOffset').on('value', snapshot => {
      serverTimeOffset = snapshot.val() || 0;
      console.log('â±ï¸ Server time offset:', serverTimeOffset, 'ms');
    });
  }
}

// ============================================
// Login UI Handlers
// ============================================
// Set up login handlers immediately since DOM should be ready
(function setupLoginHandlers(){
  const quickBtn = document.getElementById('loginQuick');
  const codeBtn = document.getElementById('loginBtn');
  const codeInput = document.getElementById('loginCode');
  
  console.log('Login setup:', !!quickBtn, !!codeBtn, !!codeInput);
  
  if(quickBtn){
    quickBtn.onclick = async function(){
      console.log('Demo login clicked');
      this.disabled = true;
      this.innerHTML = '<span>Loading...</span>';
      const success = await login(DEFAULT_PROJECT_CODE);
      if(!success) {
        this.disabled = false;
        this.innerHTML = '<span>Try Demo Project</span>';
      }
    };
  }
  
  if(codeBtn){
    codeBtn.onclick = async function(){
      console.log('Code login clicked');
      const code = codeInput ? codeInput.value.trim() : '';
      if(!code) {
        const err = document.getElementById('loginError');
        if(err) err.textContent = 'Enter a project code';
        return;
      }
      this.disabled = true;
      this.textContent = 'Loading...';
      const success = await login(code);
      if(!success) {
        this.disabled = false;
        this.textContent = 'Continue with code';
        const err = document.getElementById('loginError');
        if(err) err.textContent = 'Failed to connect';
      }
    };
  }
  
  if(codeInput){
    codeInput.onkeydown = function(e){
      if(e.key === 'Enter' && codeBtn) codeBtn.click();
    };
  }
})();

// Check connection status on load
db.ref('.info/connected').once('value').then(()=>{
  $('loginStatus').textContent='Ready';
}).catch(()=>{
  $('loginStatus').textContent='Unable to connect - check Firebase config';
});

function recordLeadTime(code,days){if(!code||days<=0||days>365)return;code=code.toUpperCase();if(!leadTimeDb[code])leadTimeDb[code]={samples:[],avg:null};const entry=leadTimeDb[code];entry.samples.push({days,date:new Date().toISOString().split('T')[0]});if(entry.samples.length>20)entry.samples=entry.samples.slice(-20);entry.avg=Math.round(entry.samples.reduce((a,s)=>a+s.days,0)/entry.samples.length);saveLeadTime()}

function getPartETA(part){
  if(STAGES.indexOf(part.status)>=2)return{display:'â€”',type:'done'};
  
  // Helper to format date as "25.12."
  function formatDate(d){
    return d.getDate()+'.'+(d.getMonth()+1)+'.';
  }
  
  // For manual ETA, calculate from orderedAt if available, else from today
  if(part.manualEta!==undefined&&part.manualEta!==null){
    const baseDate=part.orderedAt?new Date(part.orderedAt):new Date();
    const arrivalDate=new Date(baseDate);
    arrivalDate.setDate(arrivalDate.getDate()+part.manualEta);
    return{display:formatDate(arrivalDate),type:'manual',days:part.manualEta};
  }
  
  const code=part.code?part.code.toUpperCase():null;
  const lt=code?leadTimeDb[code]:null;
  if(lt&&lt.avg){
    // For ordered parts, calculate arrival date from order date
    if(part.status==='ordered'&&part.orderedAt){
      const orderDate=new Date(part.orderedAt);
      const arrivalDate=new Date(orderDate);
      arrivalDate.setDate(arrivalDate.getDate()+lt.avg);
      return{display:formatDate(arrivalDate),type:'predicted',days:lt.avg,avg:lt.avg};
    }
    // For waiting parts, we can't calculate a date since we don't know when they'll be ordered
    return{display:'?',type:'unknown'};
  }
  return{display:'?',type:'unknown'};
}
function getLeadTimeHistory(code){if(!code)return null;return leadTimeDb[code.toUpperCase()]||null}
function getProgressColor(pct){if(pct<20)return'var(--red)';if(pct<40)return'var(--orange)';return'var(--green)'}

function isOnSchedule(){
  if(!projectDates.start||!projectDates.end)return true;
  const start=new Date(projectDates.start),end=new Date(projectDates.end),now=new Date();
  const totalDays=Math.max(1,(end-start)/86400000);
  const elapsedDays=Math.max(0,(now-start)/86400000);
  const expectedPct=(elapsedDays/totalDays)*100;
  const actualPct=calcOverallProgress();
  return actualPct>=expectedPct;
}

function getScheduleColor(){return isOnSchedule()?'var(--green)':'var(--red)'}
function getProgressClass(pct){if(pct<20)return'red';if(pct<40)return'orange';return'green'}

// Calculate Supplier OTD from actual project data
function calcSupplierOTD(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt);
  if(!parts.length)return null;
  let onTime=0,total=0;
  parts.forEach(p=>{
    total++;
    // Check if arrived on or before expected date
    if(p.expectedArrival){
      const expected=new Date(p.expectedArrival).getTime();
      if(p.arrivedAt<=expected+86400000)onTime++; // Give 1 day grace
    }else{
      // No expected date set, consider on-time if lead time was reasonable (<=14 days)
      const days=Math.round((p.arrivedAt-p.orderedAt)/86400000);
      if(days<=14)onTime++;
    }
  });
  return total?Math.round(onTime/total*100):null;
}

// Calculate average lead time from actual project data
function calcAvgLeadTime(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt);
  if(!parts.length)return null;
  const totalDays=parts.reduce((sum,p)=>sum+Math.round((p.arrivedAt-p.orderedAt)/86400000),0);
  return Math.round(totalDays/parts.length);
}

// Calculate OTD per manufacturer
function calcOTDByMfr(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt&&p.mfr);
  const mfrStats={};
  parts.forEach(p=>{
    const mfr=p.mfr;
    if(!mfrStats[mfr])mfrStats[mfr]={onTime:0,total:0,totalDays:0};
    mfrStats[mfr].total++;
    const days=Math.round((p.arrivedAt-p.orderedAt)/86400000);
    mfrStats[mfr].totalDays+=days;
    if(p.expectedArrival){
      const expected=new Date(p.expectedArrival).getTime();
      if(p.arrivedAt<=expected+86400000)mfrStats[mfr].onTime++;
    }else{
      if(days<=14)mfrStats[mfr].onTime++;
    }
  });
  return Object.keys(mfrStats).map(mfr=>({
    mfr,
    otd:Math.round(mfrStats[mfr].onTime/mfrStats[mfr].total*100),
    avgLead:Math.round(mfrStats[mfr].totalDays/mfrStats[mfr].total),
    total:mfrStats[mfr].total
  })).sort((a,b)=>b.otd-a.otd||b.total-a.total);
}

function getVelocityForecast(){
  // Handle edge case: only 1 history entry but has progress (e.g., project starts today with existing progress)
  if(history.length === 1) {
    const entry = history[0];
    if(entry.pct > 0) {
      // Assume all progress was made in 1 day
      const rate = entry.pct;
      const pct = calcOverallProgress();
      const remaining = 100 - pct;
      if(remaining <= 0) return { status: 'complete', rate, estDate: entry.date, daysToComplete: 0, daysLeft: getDaysLeft() };
      const daysToComplete = Math.ceil(remaining / rate);
      const estDate = new Date();
      estDate.setDate(estDate.getDate() + daysToComplete);
      const daysLeft = getDaysLeft();
      let status = 'on-track';
      if(daysLeft !== null) {
        if(daysToComplete > daysLeft + 3) status = 'at-risk';
        else if(daysToComplete > daysLeft) status = 'behind';
        else if(daysToComplete < daysLeft - 3) status = 'ahead';
      }
      return { status, rate, estDate: estDate.toISOString().split('T')[0], daysToComplete, daysLeft };
    }
    return null;
  }
  
  if(history.length < 2) return null;
  
  const first = history[0], last = history[history.length - 1];
  const days = Math.max(1, (new Date(last.date) - new Date(first.date)) / 86400000);
  const rate = (last.pct - first.pct) / days;
  
  if(rate <= 0) return { status: 'stalled', rate: 0, estDate: null, daysToComplete: null };
  
  const pct = calcOverallProgress();
  const remaining = 100 - pct;
  const daysToComplete = Math.ceil(remaining / rate);
  const estDate = new Date();
  estDate.setDate(estDate.getDate() + daysToComplete);
  const daysLeft = getDaysLeft();
  let status = 'on-track';
  if(daysLeft !== null) {
    if(daysToComplete > daysLeft + 3) status = 'at-risk';
    else if(daysToComplete > daysLeft) status = 'behind';
    else if(daysToComplete < daysLeft - 3) status = 'ahead';
  }
  return { status, rate, estDate: estDate.toISOString().split('T')[0], daysToComplete, daysLeft };
}

const getAsms=()=>data.filter(d=>d.isAsm && !d._deletedAt).sort((a,b)=>(a.priority||99)-(b.priority||99));
const getParts=()=>data.filter(d=>!d.isAsm && !d._deletedAt);
const getPartById=id=>data.find(d=>String(d.id)===String(id));
const getTeamEmail=name=>{const t=team.find(m=>m.name===name);return t?t.email:''};
const calcPartProgress=p=>STAGES.indexOf(p.status)/(STAGES.length-1);
function calcAsmProgress(asmId){const kids=data.filter(d=>!d._deletedAt&&String(d.parentId)===String(asmId));if(!kids.length)return 0;return Math.round(kids.reduce((acc,k)=>acc+calcPartProgress(k),0)/kids.length*100)}
function calcOverallProgress(){const parts=getParts();if(!parts.length)return 0;return Math.round(parts.reduce((acc,p)=>acc+calcPartProgress(p),0)/parts.length*100)}
function getExpectedProgress(){if(!projectDates.start||!projectDates.end)return null;const start=new Date(projectDates.start),end=new Date(projectDates.end),now=new Date();const total=end-start,elapsed=now-start;if(elapsed<0)return 0;if(elapsed>total)return 100;return Math.round(elapsed/total*100)}
function getDaysLeft(){if(!projectDates.end)return null;return Math.ceil((new Date(projectDates.end)-new Date())/86400000)}
function getProjectDateRange(){const parts=getParts();if(!parts.length)return{start:null,end:null};let earliest=null,latest=null;parts.forEach(p=>{if(p.changedAt){const d=new Date(p.changedAt);if(!earliest||d<earliest)earliest=d;if(!latest||d>latest)latest=d}});if(projectDates.start)earliest=new Date(projectDates.start);if(projectDates.end)latest=new Date(projectDates.end);return{start:earliest,end:latest}}
function recordProgress(){
  const today=new Date().toISOString().split('T')[0];
  const pct=calcOverallProgress();
  const idx=history.findIndex(h=>h.date===today);
  
  if(idx>=0){
    // Update today's entry if pct changed
    if(history[idx].pct !== pct) {
      history[idx].pct=pct;
    }
  } else {
    // Add new entry for today
    history.push({date:today,pct});
  }
  
  if(history.length>100) history=history.slice(-100);
  
  // Save to Firebase (debounced with rest of save)
  if(projectRef && !useLocalStorage) {
    projectRef.child('history/'+today).set({
      date: today,
      pct: pct,
      _updatedAt: firebase.database.ServerValue.TIMESTAMP
    }).catch(e => console.warn('Failed to save history:', e));
  }
}
const formatDate=d=>{if(!d)return'â€”';const p=d.split('-');return p[1]+'/'+p[2]};
const formatDateShort=d=>{if(!d)return'â€”';const dt=new Date(d);return dt.getDate()+'.'+(dt.getMonth()+1)+'.'};
const getWeek=d=>{const o=new Date(d.getFullYear(),0,1);return Math.ceil((((d-o)/86400000)+o.getDay()+1)/7)};

function render(){
  try{
    updateProjectName();
    const parts=getParts(),asms=getAsms();

    // Preindex for O(1) lookups (fixes O(nÂ²) render complexity)
    const childrenByParent=new Map();  // parentId -> [children]
    const partById=new Map();          // id -> part (non-asm only)
    data.forEach(d=>{
      if(d._deletedAt)return;
      if(!d.isAsm)partById.set(String(d.id),d);
      if(d.parentId){
        const pid=String(d.parentId);
        if(!childrenByParent.has(pid))childrenByParent.set(pid,[]);
        childrenByParent.get(pid).push(d);
      }
    });

    const pct=calcOverallProgress(),daysLeft=getDaysLeft();
    const readyCount=parts.filter(p=>p.status==='installed').length;
    
    // Update projectIndex with current progress
    if (currentProjectId && projectIndex[currentProjectId]) {
      projectIndex[currentProjectId].progress = pct;
      // Also save to Firebase (debounced to avoid too many writes)
      if (!render.progressSaveTimeout) {
        render.progressSaveTimeout = setTimeout(() => {
          db.ref('projectIndex/' + currentProjectId + '/progress').set(pct).catch(e => console.warn('Failed to save progress:', e));
          render.progressSaveTimeout = null;
        }, 2000);
      }
    }

    $('sReady').textContent=readyCount+'/'+parts.length;
    $('sReady').style.color=parts.length?(readyCount===parts.length?'var(--green)':'var(--text)'):'var(--text3)';
    const scheduleColor=getScheduleColor();
    $('sPct').textContent=pct+'%';
    $('sPct').style.color=scheduleColor;
    $('sBar').style.width=pct+'%';
    $('sBar').style.background=scheduleColor;
    $('hmProgress').title=isOnSchedule()?'On Schedule':'Behind Schedule';

    if(daysLeft!==null){$('hmDays').style.display='block';$('sDays').textContent=daysLeft+'d';$('sDays').className='hm-value '+(daysLeft<3?'red':daysLeft<7?'yellow':'')}
    else{$('hmDays').style.display='none'}

    const pipeCounts=[
      parts.filter(p=>p.status==='waiting').length,
      parts.filter(p=>p.status==='to-order').length,
      parts.filter(p=>p.status==='ordered').length,
      parts.filter(p=>p.status==='arrived').length,
      parts.filter(p=>p.status==='tested').length,
      parts.filter(p=>p.status==='configured').length,
      parts.filter(p=>p.status==='installed').length
    ];
    const maxCount=Math.max(...pipeCounts,1);
    pipeCounts.forEach((c,i)=>{
      $('p'+i).textContent=c;
      const bar=$('bar'+i);
      if(bar)bar.style.width=(c/maxCount*100)+'%';
    });

    document.querySelectorAll('.pipe').forEach(p=>p.classList.toggle('active',p.dataset.s===filterStage));
    $('pmParent').innerHTML='<option value="">â€”</option>'+asms.map(a=>'<option value="'+a.id+'">'+esc(a.name)+'</option>').join('');
    updateSelects();updateExpandToggle();renderInsights();updateAIAlert();

    let badges='';
    if(filterStage)badges+='<span class="filter-badge">'+SLABELS[filterStage]+' <button onclick="window.clearStageFilter()">Ã—</button></span>';
    if(filterAssignee)badges+='<span class="filter-badge">'+esc(filterAssignee)+' <button onclick="window.clearAssigneeFilter()">Ã—</button></span>';
    if(filterPO)badges+='<span class="filter-badge">PO: '+esc(filterPO)+' <button onclick="window.clearPOFilter()">Ã—</button></span>';
    $('filterBadges').innerHTML=badges;

    let html='';
    
    // Helper to render a part and its sub-parts recursively
    function renderPartWithChildren(part,depth){
      let partHtml=renderPart({type:'part',item:part,child:true,depth:depth});
      // Check for sub-parts using preindexed map (O(1) lookup)
      const subParts=(childrenByParent.get(String(part.id))||[]).filter(d=>!d.isAsm).filter(matchPart);
      if(subParts.length){
        subParts.forEach(sp=>{
          partHtml+=renderPartWithChildren(sp,depth+1);
        });
      }
      return partHtml;
    }
    
    asms.forEach(asm=>{
      // Get direct children of assembly using preindexed map (O(1) lookup)
      const kids=(childrenByParent.get(String(asm.id))||[]).filter(d=>!partById.has(String(d.parentId)));
      const matchingKids=kids.filter(matchPart);
      const asmMatch=!filterAssignee||asm.assignee===filterAssignee;
      if((filterStage||filterAssignee||filterPO)&&!matchingKids.length&&!asmMatch)return;
      if(searchQ&&asm.name.toLowerCase().indexOf(searchQ.toLowerCase())===-1&&!matchingKids.length)return;
      const isExp=(filterStage||filterAssignee||filterPO)?true:expanded[String(asm.id)];
      html+=renderAsm({type:'asm',item:asm,kids:kids.length,match:matchingKids.length,exp:isExp});
      if(isExp){
        const visibleKids=(filterStage||filterAssignee||filterPO)?matchingKids:kids.filter(matchPart);
        visibleKids.forEach(k=>{
          html+=renderPartWithChildren(k,0);
        });
        html+='<div class="add-row" style="padding-left:44px"><button class="add-row-btn" onclick="window.addNewPart(\''+asm.id+'\')" title="Add part to '+esc(asm.name)+'">+</button></div>';
      }
    });
    // Orphan parts (no parent) - use 'parts' which already excludes deleted/asms
    parts.filter(p=>!p.parentId).filter(matchPart).forEach(p=>{html+=renderPart({type:'part',item:p,child:false,depth:0})});
    
    // Show empty state with Add Assembly button if no assemblies
    if(!asms.length && !html){
      html='<div style="text-align:center;padding:60px 20px;color:var(--text3)">'+
        '<div style="font-size:32px;margin-bottom:12px">ðŸ“¦</div>'+
        '<div style="font-size:14px;font-weight:500;color:var(--text2);margin-bottom:8px">No assemblies yet</div>'+
        '<div style="font-size:12px;margin-bottom:20px">Add your first assembly to start tracking parts</div>'+
        '<button class="btn btn-primary" onclick="window.addNewAssembly()" style="display:inline-flex">+ Add Assembly</button>'+
      '</div>';
    } else if(asms.length && !filterStage && !filterAssignee && !filterPO && !searchQ) {
      // Add "Add Assembly" button at the bottom when not filtering
      html+='<div class="add-row" style="padding-left:12px;margin-top:8px"><button class="add-row-btn" onclick="window.addNewAssembly()" title="Add new assembly" style="width:auto;padding:0 12px;font-size:11px">+ Add Assembly</button></div>';
    }
    
    $('partsList').innerHTML=html;
    $('partsTable').style.display='flex';$('emptyList').style.display='none';
    if(highlightPartId){setTimeout(()=>{const row=document.querySelector('[data-part-id="'+highlightPartId+'"]');if(row){row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),5000)}highlightPartId=null},50)}
    if($('ganttPanel').classList.contains('active'))renderGantt();
  }catch(err){console.error('Render error:',err)}
}

const matchPart=p=>{if(filterStage&&p.status!==filterStage)return false;if(filterAssignee&&p.assignee!==filterAssignee)return false;if(filterPO&&p.poNumber!==filterPO)return false;if(searchQ&&[p.name,p.assignee,p.code,p.mfr].join(' ').toLowerCase().indexOf(searchQ.toLowerCase())===-1)return false;return true};

function renderInsights(){
  const daysLeft=getDaysLeft(),pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast(),otd=calcSupplierOTD(),avgLead=calcAvgLeadTime();
  const parts=getParts(),asms=getAsms();
  const now=Date.now(),day=86400000;

  // Update Velocity Forecast card
  if(forecast&&forecast.rate>0){
    $('forecastDate').textContent=formatDateShort(forecast.estDate);
    $('forecastDate').style.color=forecast.status==='ahead'||forecast.status==='on-track'?'var(--green)':'var(--red)';
    if(forecast.daysLeft!==null){
      const diff=forecast.daysLeft-forecast.daysToComplete;
      if(diff>0){$('forecastLabel').textContent=diff+' days early';$('forecastLabel').style.color='var(--green)'}
      else if(diff<0){$('forecastLabel').textContent=Math.abs(diff)+' days late';$('forecastLabel').style.color='var(--red)'}
      else{$('forecastLabel').textContent='on deadline';$('forecastLabel').style.color='var(--text2)'}
    }else{$('forecastLabel').textContent=''}
    $('forecastDetail').textContent='At '+forecast.rate.toFixed(1)+'%/day â€¢ '+forecast.daysToComplete+'d to complete';
  }else{
    $('forecastDate').textContent='â€”';$('forecastDate').style.color='var(--text3)';
    $('forecastLabel').textContent='';$('forecastDetail').textContent='Need 2+ days of data';
  }

  // Assembly progress list
  const asmProgress=asms.map(a=>{
    const prog=calcAsmProgress(a.id);
    return {id:a.id,name:a.name,progress:prog};
  }).sort((a,b)=>a.progress-b.progress);
  
  $('asmProgressList').innerHTML=asmProgress.length?asmProgress.map(a=>{
    const color=a.progress<30?'var(--red)':a.progress<60?'var(--orange)':'var(--green)';
    return '<div class="asm-progress-item"><span class="asm-progress-name">'+esc(a.name)+'</span><div class="asm-progress-bar"><div class="asm-progress-fill" style="width:'+a.progress+'%;background:'+color+'"></div></div><span class="asm-progress-pct" style="color:'+color+'">'+a.progress+'%</span></div>';
  }).join(''):'<div style="color:var(--text3);font-size:12px;padding:12px">No assemblies</div>';

  // Bottleneck list - parts stuck longest
  const bottlenecks=parts.filter(p=>p.changedAt&&p.status!=='installed').map(p=>({
    id:p.id,name:p.name,status:p.status,days:Math.floor((now-p.changedAt)/day)
  })).filter(p=>p.days>=3).sort((a,b)=>b.days-a.days).slice(0,8);

  $('bottleneckList').innerHTML=bottlenecks.length?bottlenecks.map(b=>{
    const level=b.days>=7?'':'warning';
    return '<div class="bottleneck-item '+level+'"><span class="bottleneck-name">'+esc(b.name)+'</span><span class="bottleneck-days">'+b.days+'d in '+SLABELS[b.status]+'</span></div>';
  }).join(''):'<div style="color:var(--text3);font-size:12px;padding:12px">No bottlenecks detected</div>';
  
  // Render burndown chart
  renderBurndown();
}

function renderBurndown(){
  const chart=$('burndownChart');
  if(!projectDates.start||!projectDates.end){chart.innerHTML='<div class="burndown-empty" onclick="window.openDates()"><span>ðŸ“…</span><span>Set project dates</span></div>';$('burndownDates').innerHTML='';return}
  const start=new Date(projectDates.start),end=new Date(projectDates.end);
  const totalDays=Math.max(1,(end-start)/86400000);
  const w=550,h=270,pad={top:16,right:16,bottom:40,left:36};
  const chartW=w-pad.left-pad.right,chartH=h-pad.top-pad.bottom;
  const xScale=x=>pad.left+(x/totalDays)*chartW;
  const yScale=y=>pad.top+(1-y/100)*chartH;
  
  // If no history, create a point for today
  let workingHistory = history.length > 0 ? history : [{date: new Date().toISOString().split('T')[0], pct: calcOverallProgress()}];
  
  let points=workingHistory.filter(pt=>{const d=new Date(pt.date);return d>=start&&d<=end}).map(pt=>{const d=new Date(pt.date),dayNum=(d-start)/86400000;return{x:xScale(dayNum),y:yScale(pt.pct),pct:pt.pct,dayNum,date:pt.date}});
  points.sort((a,b) => a.dayNum - b.dayNum);
  
  // Ensure we have at least 2 points to draw a line
  if(points.length === 0){
    // No points in range - add project start at 0% and today
    const todayDate = new Date();
    const todayDayNum = (todayDate - start) / 86400000;
    const currentPct = calcOverallProgress();
    points = [
      {x: xScale(0), y: yScale(0), pct: 0, dayNum: 0, date: projectDates.start},
      {x: xScale(todayDayNum), y: yScale(currentPct), pct: currentPct, dayNum: todayDayNum, date: todayDate.toISOString().split('T')[0]}
    ];
  } else if(points.length === 1){
    // Only 1 point - add project start at 0%
    if(points[0].dayNum > 0){
      points.unshift({x: xScale(0), y: yScale(0), pct: 0, dayNum: 0, date: projectDates.start});
    } else {
      // Point is at start, add today
      const todayDate = new Date();
      const todayDayNum = (todayDate - start) / 86400000;
      const currentPct = calcOverallProgress();
      points.push({x: xScale(todayDayNum), y: yScale(currentPct), pct: currentPct, dayNum: todayDayNum, date: todayDate.toISOString().split('T')[0]});
    }
  }
  
  let svg='<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="xMidYMid meet">';
  
  // Grid lines
  [0,25,50,75,100].forEach(g=>{const y=yScale(g);svg+='<line x1="'+pad.left+'" y1="'+y+'" x2="'+(w-pad.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="1"/><text x="'+(pad.left-6)+'" y="'+(y+4)+'" fill="var(--text3)" font-size="10" text-anchor="end">'+g+'</text>'});
  
  // X-axis date labels
  const formatMonth = d => d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
  svg += '<text x="'+pad.left+'" y="'+(h-10)+'" fill="var(--text3)" font-size="9" text-anchor="start">'+formatMonth(start)+'</text>';
  svg += '<text x="'+(w/2)+'" y="'+(h-10)+'" fill="var(--text3)" font-size="9" text-anchor="middle">'+formatMonth(new Date(start.getTime()+(end-start)/2))+'</text>';
  svg += '<text x="'+(w-pad.right)+'" y="'+(h-10)+'" fill="var(--text3)" font-size="9" text-anchor="end">'+formatMonth(end)+'</text>';
  
  // Today marker
  const today = new Date();
  if(today >= start && today <= end) {
    const todayX = xScale((today - start) / 86400000);
    svg += '<line x1="'+todayX+'" y1="'+pad.top+'" x2="'+todayX+'" y2="'+(h-pad.bottom)+'" stroke="var(--accent)" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>';
  }
  
  // Target line
  svg+='<line x1="'+xScale(0)+'" y1="'+yScale(0)+'" x2="'+xScale(totalDays)+'" y2="'+yScale(100)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="4,3"/>';
  
  // Progress lines
  for(let i=0;i<points.length-1;i++){const p1=points[i],p2=points[i+1];const idealY1=(p1.dayNum/totalDays)*100,idealY2=(p2.dayNum/totalDays)*100;const above1=p1.pct>=idealY1,above2=p2.pct>=idealY2;const col1=above1?'var(--green)':'var(--red)';const col2=above2?'var(--green)':'var(--red)';if(above1===above2){svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>'}else{const t=(idealY1-p1.pct)/((p2.pct-p1.pct)-(idealY2-idealY1));const ix=p1.x+t*(p2.x-p1.x),iy=p1.y+t*(p2.y-p1.y);svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+ix+'" y2="'+iy+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/><line x1="'+ix+'" y1="'+iy+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col2+'" stroke-width="2.5" stroke-linecap="round"/>'}}
  
  // Prediction line with tooltip - use current progress and calculate from today
  if(points.length>=1){
    const lastPt=points[points.length-1];
    const forecast=getVelocityForecast();
    const currentPct=calcOverallProgress();
    const today=new Date();
    today.setHours(0,0,0,0);
    const todayDayNum=Math.round((today-start)/86400000);
    
    if(forecast&&forecast.rate>0&&currentPct<100){
      const remaining=100-currentPct;
      const daysTo100=remaining/forecast.rate;
      const dayAt100=todayDayNum+daysTo100;
      const estDate=new Date(today.getTime()+daysTo100*86400000);
      const estStr=estDate.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
      if(dayAt100<=totalDays){
        const x100=xScale(dayAt100),y100=yScale(100);
        svg+='<line x1="'+lastPt.x+'" y1="'+lastPt.y+'" x2="'+x100+'" y2="'+y100+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" opacity="0.7"><title>Forecasted finish: '+estStr+'</title></line>';
        svg+='<circle cx="'+x100+'" cy="'+y100+'" r="4" fill="var(--bg2)" stroke="var(--text3)" stroke-width="1.5" opacity="0.9" style="cursor:pointer"><title>Forecasted finish: '+estStr+'</title></circle>';
      }else{
        const daysRem=totalDays-todayDayNum;
        const predPct=currentPct+(forecast.rate*daysRem);
        svg+='<line x1="'+lastPt.x+'" y1="'+lastPt.y+'" x2="'+xScale(totalDays)+'" y2="'+yScale(predPct)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" opacity="0.7"><title>Forecasted finish: '+estStr+' (after deadline)</title></line>';
      }
    }else if(forecast&&forecast.rate<=0&&currentPct<100){
      svg+='<line x1="'+lastPt.x+'" y1="'+lastPt.y+'" x2="'+xScale(totalDays)+'" y2="'+lastPt.y+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" opacity="0.5"><title>Progress stalled</title></line>';
    }
  }
  
  // Data points with tooltips
  points.forEach(p=>{
    const idealY=(p.dayNum/totalDays)*100;
    const dateStr=new Date(p.date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const dotColor = p.pct>=idealY ? 'var(--green)' : 'var(--red)';
    svg+='<circle cx="'+p.x+'" cy="'+p.y+'" r="4" fill="'+dotColor+'" style="cursor:pointer"><title>'+dateStr+': '+Math.round(p.pct)+'%</title></circle>';
  });
  
  // Deadline marker (drawn last to appear on top)
  const deadlineX = xScale(totalDays) - 2; // Slightly inset to ensure visibility
  svg += '<line x1="'+deadlineX+'" y1="'+(pad.top-4)+'" x2="'+deadlineX+'" y2="'+(h-pad.bottom+4)+'" stroke="#ff453a" stroke-width="2" stroke-dasharray="5,4"/>';
  
  svg+='</svg>';chart.innerHTML=svg;
  $('burndownDates').innerHTML='';
}

function renderAsm(r){
  const a=r.item,progress=calcAsmProgress(a.id);
  const pColor=progress<20?'var(--red)':progress<40?'var(--orange)':'var(--green)';
  const count=(filterStage||filterAssignee||filterPO)?r.match+'/'+r.kids:r.kids;
  const priorityBtns='<div class="asm-priority" onclick="event.stopPropagation()"><button class="asm-priority-btn" onclick="window.moveAsmUp(\''+a.id+'\')" title="Move up">â–²</button><button class="asm-priority-btn" onclick="window.moveAsmDown(\''+a.id+'\')" title="Move down">â–¼</button></div>';
  const ganttBtn='<button class="sm-btn gantt-link-btn" onclick="window.goToGanttAsm(\''+a.id+'\',event)" title="View in Timeline"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg></button>';
  return '<div class="asm-row parts-grid" data-asm-id="'+a.id+'" onclick="window.toggleAsmRow(event,\''+a.id+'\')"><div class="asm-toggle">'+(r.exp?'â–¼':'â–¶')+'</div><div class="asm-name-cell">'+priorityBtns+'<span class="asm-name">'+esc(a.name)+'</span> <span class="asm-meta">('+count+')</span></div><div></div><div></div><div></div><div></div><div onclick="event.stopPropagation()">'+ganttBtn+'</div><div class="asm-progress"><div class="asm-bar"><div class="asm-bar-fill" style="width:'+progress+'%;background:'+pColor+';"></div></div><span class="asm-pct" style="color:'+pColor+'">'+progress+'%</span></div><div></div><div class="notes-cell" title="'+(a.notes?esc(a.notes):'')+'">'+(a.notes?esc(a.notes):'â€”')+'</div><div class="asm-actions" onclick="event.stopPropagation()"><button class="sm-btn" onclick="window.editAsm(\''+a.id+'\',event)">âœŽ</button><button class="del-btn" onclick="window.confirmDelete(\''+a.id+'\',\'assembly\',event)" style="margin-left:4px">Ã—</button></div></div>';
}

function renderPart(r){
  const p=r.item;
  const partStages=getPartStages(p);
  const si=partStages.indexOf(p.status);
  const isInstalled=p.status==='installed';
  const stageDots=partStages.map((s,i)=>'<div class="stage-dot'+((i<si||isInstalled)?' done':(i===si?' current':'')+'" title="'+SLABELS[s])+'"></div>').join('');
  
  // Determine indent level
  const depth=r.depth||0;
  const indent=depth*24;
  
  // Add sub-part button (appears on hover)
  const addSubBtn='<button class="subpart-add" onclick="window.addSubPart(\''+p.id+'\',event)" title="Add sub-part">+</button>';
  
  // ETA and PO handling
  let etaHtml='';
  let etaDate='',etaClass='historical',poHtml='';
  
  // Only show arrival date if not installed
  if(p.status!=='installed'){
    if(p.expectedArrival){
      etaDate=formatDateShort(p.expectedArrival);
      etaClass='user-set';
    }else if(p.status==='ordered'||p.status==='to-order'){
      const eta=getPartETA(p);
      if(eta.type==='predicted'){
        etaDate=eta.display;
        etaClass='historical';
      }else if(eta.type==='manual'){
        etaDate=eta.display;
        etaClass='user-set';
      }else{
        etaDate='?';
        etaClass='historical';
      }
    }else{
      etaDate='?';
      etaClass='historical';
    }
  }
  
  // Always show PO number if exists
  if(p.poNumber){
    const isFiltered=filterPO===p.poNumber;
    poHtml='<span class="eta-po'+(isFiltered?' active':'')+'" onclick="window.showPODetails(\''+esc(p.poNumber)+'\',event)" title="Click to view PO details">'+esc(p.poNumber)+'</span>';
  }
  
  if(etaDate||poHtml){
    etaHtml='<div class="eta-cell">'+(etaDate?'<span class="eta-date '+etaClass+'" onclick="window.openEtaModal(\''+p.id+'\',event)" title="Click to edit">'+etaDate+'</span>':'')+(poHtml||'')+'</div>';
  }else{
    etaHtml='<span style="color:var(--text3)">â€”</span>';
  }
  
  // Notes/Comments - clickable cell that opens chat popover
  const commentCount=p.comments?.length||0;
  const lastComment=p.comments&&p.comments.length?p.comments[p.comments.length-1]:null;
  const maxLen=commentCount>1?28:42;
  const commentPreview=lastComment?esc(lastComment.text).substring(0,maxLen)+(lastComment.text.length>maxLen?'â€¦':''):'';
  const notesHtml='<div class="notes-chat-cell" onclick="window.openNotesChat(\''+p.id+'\',event)"><span class="comment-text">'+(commentPreview||'<span class="add-note">add note</span>')+'</span>'+(commentCount>1?'<span class="comment-badge">+'+(commentCount-1)+'</span>':'')+'</div>';
  
  const depthClass=depth>0?' depth-'+Math.min(depth,3):'';
  const childClass=r.child?' child'+depthClass:'';
  
  // Checkbox for bulk selection
  const isSelected=selectedParts.has(String(p.id));
  const checkbox='<input type="checkbox" class="part-checkbox" data-part-id="'+p.id+'" '+(isSelected?'checked':'')+' onclick="window.togglePartSelection(\''+p.id+'\',event)">';
  
  // Status badge with has-note indicator for pending parts
  const hasNoteClass=(p.status==='waiting'&&p.pendingNote)?' has-note':'';
  
  // Calculate days in current stage
  const now=Date.now();
  const day=86400000;
  const daysInStage=p.changedAt?Math.floor((now-p.changedAt)/day):0;
  let daysClass='fresh';
  if(daysInStage>=14)daysClass='stuck';
  else if(daysInStage>=7)daysClass='aging';
  else if(daysInStage>=3)daysClass='normal';
  const alwaysShow=daysInStage>=20?' always-show':'';
  const daysBadge=p.status!=='installed'?'<span class="days-badge '+daysClass+alwaysShow+'">'+daysInStage+'d</span>':'';
  
  const statusBadge='<span class="status-badge '+p.status+hasNoteClass+'" onclick="window.openStatusPopover(\''+p.id+'\',event)" style="cursor:pointer" '+(p.pendingNote?'title="'+esc(p.pendingNote)+'"':'')+'>'+SLABELS[p.status]+daysBadge+'</span>';
  
  return '<div class="part-row parts-grid'+childClass+(isSelected?' selected':'')+'" data-part-id="'+p.id+'" data-depth="'+depth+'" onclick="window.handleRowClick(event)"><div>'+checkbox+'</div><div class="part-name-cell" style="padding-left:'+indent+'px"><span class="cell" onclick="window.editCell(event,\''+p.id+'\',\'name\')">'+esc(p.name)+'</span>'+addSubBtn+'</div><div class="cell muted" onclick="window.editCellAutocomplete(event,\''+p.id+'\',\'code\')">'+(p.code?esc(p.code):'â€”')+'</div><div class="cell muted" onclick="window.editCellAutocomplete(event,\''+p.id+'\',\'mfr\')">'+(p.mfr?esc(p.mfr):'â€”')+'</div><div class="cell muted" onclick="window.editCellAssignee(event,\''+p.id+'\')">'+(p.assignee?esc(p.assignee):'â€”')+'</div><div class="cell muted" onclick="window.editCell(event,\''+p.id+'\',\'qty\')">'+(p.qty||1)+'</div><div>'+statusBadge+'</div><div class="stage-dots">'+stageDots+'</div><div>'+etaHtml+'</div><div>'+notesHtml+'</div><div class="part-actions" onclick="event.stopPropagation()"><button class="print-label-btn" onclick="window.openLabelModal(\''+p.id+'\',event)" title="Print label">ðŸ·ï¸</button><button class="del-btn" onclick="window.confirmDelete(\''+p.id+'\',\'part\',event)">Ã—</button></div></div>';
}

let ganttZoom='day'; // day, week
let ganttExpanded={};
let ganttBarColors={}; // Store custom bar colors
let ganttResourceFilter=''; // Filter by assignee
let _ganttRenderState = null; // Store state for dependency arrow re-rendering

// Detect resource conflicts (same person assigned to overlapping date ranges)
function detectResourceConflicts(rows){
  const conflicts=new Map(); // rowId -> [{id, name, start, end, assignee}]
  
  for(let i=0;i<rows.length;i++){
    const a=rows[i];
    if(!a.assignee||!a.startDate||!a.endDate)continue;
    
    for(let j=i+1;j<rows.length;j++){
      const b=rows[j];
      if(!b.assignee||!b.startDate||!b.endDate)continue;
      if(a.assignee!==b.assignee)continue;
      
      // Check overlap: A starts before B ends AND A ends after B starts
      if(a.startDate<=b.endDate&&a.endDate>=b.startDate){
        if(!conflicts.has(a.id))conflicts.set(a.id,[]);
        if(!conflicts.has(b.id))conflicts.set(b.id,[]);
        conflicts.get(a.id).push({id:b.id,name:b.name,start:b.startDate,end:b.endDate,assignee:a.assignee});
        conflicts.get(b.id).push({id:a.id,name:a.name,start:a.startDate,end:a.endDate,assignee:a.assignee});
      }
    }
  }
  return conflicts;
}

// Build conflict description HTML for popover
function buildConflictPopoverHtml(conflicts, rows){
  if(conflicts.size === 0) return '';
  
  // Group conflicts by assignee to make popover more readable
  const byAssignee = new Map(); // assignee -> [{task1, task2}]
  const seen = new Set(); // Track pairs we've already recorded
  
  conflicts.forEach((conflictList, rowId) => {
    const row = rows.find(r => r.id === rowId);
    if(!row) return;
    
    conflictList.forEach(c => {
      const pairKey = [rowId, c.id].sort().join('-');
      if(seen.has(pairKey)) return;
      seen.add(pairKey);
      
      const assignee = c.assignee || row.assignee;
      if(!byAssignee.has(assignee)) byAssignee.set(assignee, []);
      byAssignee.get(assignee).push({
        task1: row.name,
        task2: c.name
      });
    });
  });
  
  // Build popover HTML
  let html = '<div class="gantt-conflict-popover-title">âš ï¸ Resource Conflicts</div>';
  
  byAssignee.forEach((pairs, assignee) => {
    html += '<div class="gantt-conflict-item">';
    html += '<div class="gantt-conflict-resource">' + esc(assignee) + '</div>';
    html += '<div class="gantt-conflict-tasks">';
    pairs.forEach((p, i) => {
      if(i > 0) html += '<br>';
      html += '"' + esc(p.task1) + '" overlaps with "' + esc(p.task2) + '"';
    });
    html += '</div></div>';
  });
  
  return html;
}

function renderGantt(){
  // Update resource filter dropdown with team members
  updateResourceFilter();
  
  const asms=getAsms();
  const parts=getParts();
  if(!asms.length){
    $('ganttSidebar').innerHTML='<div style="padding:40px 20px;text-align:center;color:var(--text3)"><div style="font-size:24px;margin-bottom:8px">ðŸ“¦</div><div style="font-size:12px;margin-bottom:16px">No assemblies yet</div><button class="btn btn-primary" onclick="window.addNewAssembly()" style="display:inline-flex;font-size:12px">+ Add Assembly</button></div>';
    $('ganttTimelineHeader').innerHTML='';
    $('ganttTimelineBody').innerHTML='';
    return;
  }

  const dayMs=86400000;
  
  // Create today's date normalized to local midnight
  const today=new Date();
  today.setHours(0,0,0,0);
  const todayStr=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');
  
  // Parse project dates as local dates (not UTC)
  const parseLocalDate=(str)=>{
    if(!str)return null;
    const parts=str.split('-');
    return new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]));
  };
  
  const projStart=projectDates.start?parseLocalDate(projectDates.start):new Date(today);
  const projEnd=projectDates.end?parseLocalDate(projectDates.end):new Date(today.getTime()+90*dayMs);
  
  // Use projectDates for timeline range
  const startDate = projStart;
  const endDate = projEnd;
  
  // Calculate timeline range based on user dates
  // Use the actual start/end dates as the primary range, but ensure today is visible
  let rangeStart=new Date(startDate);
  let rangeEnd=new Date(endDate);
  
  // If today is outside the range, extend the range to include it
  if(today < rangeStart) {
    rangeStart = new Date(today);
  }
  if(today > rangeEnd) {
    rangeEnd = new Date(today);
  }
  
  // Add 1 year buffer on both ends for better visibility
  rangeStart.setDate(rangeStart.getDate()-365);
  rangeEnd.setDate(rangeEnd.getDate()+365);

  // Function to get ISO week number (UTC-based to avoid timezone issues)
  function getISOWeek(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7; // Sunday = 7
    d.setUTCDate(d.getUTCDate() + 4 - dayNum); // Set to Thursday
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }
  
  // Get ISO week year (the year the week belongs to, not the calendar year)
  function getISOWeekYear(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    return d.getUTCFullYear();
  }

  // Generate WEEKS array instead of days
  const weeks=[];
  const weekMs=7*dayMs;
  
  // Align to week start (Monday)
  let weekStart=new Date(rangeStart);
  const dayOfWeek=weekStart.getDay();
  const daysToMonday=dayOfWeek===0?-6:(1-dayOfWeek);
  weekStart.setDate(weekStart.getDate()+daysToMonday);
  weekStart.setHours(0,0,0,0);
  
  while(weekStart<=rangeEnd){
    const weekEnd=new Date(weekStart.getTime()+6*dayMs);
    weekEnd.setHours(23,59,59,999); // End of Sunday, not start
    const containsToday=today>=weekStart&&today<=weekEnd;
    const isoWeekNum=getISOWeek(weekStart);
    weeks.push({
      num:isoWeekNum,
      year:getISOWeekYear(weekStart), // ISO week year
      start:new Date(weekStart),
      end:weekEnd,
      isToday:containsToday
    });
    weekStart=new Date(weekStart.getTime()+weekMs);
  }

  const cellWidth=32;
  const totalWidth=weeks.length*cellWidth;
  const todayWeekIdx=weeks.findIndex(w=>w.isToday);
  
  const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  // Build year row - group weeks by ISO week year
  let yearRowHtml='<div class="gantt-timeline-year-row">';
  let currentYear=null;
  let yearStartIdx=0;
  weeks.forEach((week,i)=>{
    const year=week.year; // Use ISO week year
    if(year!==currentYear){
      if(currentYear!==null){
        const width=(i-yearStartIdx)*cellWidth;
        yearRowHtml+='<div class="gantt-timeline-year-cell" style="width:'+width+'px">'+currentYear+'</div>';
      }
      currentYear=year;
      yearStartIdx=i;
    }
  });
  // Add last year
  if(currentYear!==null){
    const width=(weeks.length-yearStartIdx)*cellWidth;
    yearRowHtml+='<div class="gantt-timeline-year-cell" style="width:'+width+'px">'+currentYear+'</div>';
  }
  yearRowHtml+='</div>';
  
  // Build month row - group weeks by month
  let monthRowHtml='<div class="gantt-timeline-month-row">';
  let currentMonth=null;
  let currentMonthYear=null;
  let monthStartIdx=0;
  weeks.forEach((week,i)=>{
    const month=week.start.getMonth();
    const year=week.start.getFullYear();
    if(month!==currentMonth||year!==currentMonthYear){
      if(currentMonth!==null){
        const width=(i-monthStartIdx)*cellWidth;
        monthRowHtml+='<div class="gantt-timeline-month-cell" style="width:'+width+'px">'+monthNames[currentMonth]+'</div>';
      }
      currentMonth=month;
      currentMonthYear=year;
      monthStartIdx=i;
    }
  });
  // Add last month
  if(currentMonth!==null){
    const width=(weeks.length-monthStartIdx)*cellWidth;
    monthRowHtml+='<div class="gantt-timeline-month-cell" style="width:'+width+'px">'+monthNames[currentMonth]+'</div>';
  }
  monthRowHtml+='</div>';

  // Build week row
  let weekRowHtml='<div class="gantt-timeline-week-row">';
  weeks.forEach((week,i)=>{
    const classes=['gantt-timeline-day'];
    if(week.isToday)classes.push('today');
    weekRowHtml+='<div class="'+classes.join(' ')+'" style="min-width:'+cellWidth+'px;width:'+cellWidth+'px"><div style="font-size:9px;font-weight:500">'+week.num+'</div></div>';
  });
  weekRowHtml+='</div>';
  
  // Combine header rows
  let headerHtml=yearRowHtml+monthRowHtml+weekRowHtml;
  
  $('ganttTimelineHeader').innerHTML=headerHtml;

  // Color palette for assemblies (cycling through pleasant colors)
  const asmColors=['#5a8fd8','#6aaa6a','#d87756','#9b6bb5','#c07070','#b8a050','#5ab5b5','#7a8fa0','#aa6a8a','#6a9a5a'];

  // Build assembly rows with calculated dates
  let rows=[];
  const totalDuration=Math.ceil((endDate-startDate)/dayMs);
  
  asms.forEach((asm,asmIdx)=>{
    const asmParts=parts.filter(p=>String(p.parentId)===String(asm.id));
    const asmProgress=calcAsmProgress(asm.id);
    
    // Use custom dates if set, otherwise calculate
    let asmStart, asmEnd;
    
    // Check for custom gantt dates on assembly
    if(asm.ganttStart){
      asmStart=parseLocalDate(asm.ganttStart);
    }
    if(asm.ganttEnd){
      asmEnd=parseLocalDate(asm.ganttEnd);
    }
    
    // If no custom dates, try to calculate from parts
    if(!asmStart||!asmEnd){
      if(asmParts.length>0){
        // Find earliest start from parts
        const partStarts=asmParts.map(p=>{
          if(p.orderedAt)return new Date(p.orderedAt);
          if(p.changedAt)return new Date(p.changedAt);
          return null;
        }).filter(d=>d);
        
        // Find latest end from parts  
        const partEnds=asmParts.map(p=>{
          if(p.expectedArrival)return new Date(p.expectedArrival);
          if(p.arrivedAt)return new Date(p.arrivedAt);
          if(p.changedAt)return new Date(p.changedAt+14*dayMs);
          return null;
        }).filter(d=>d);
        
        if(!asmStart&&partStarts.length>0){
          asmStart=new Date(Math.min(...partStarts.map(d=>d.getTime())));
        }
        if(!asmEnd&&partEnds.length>0){
          asmEnd=new Date(Math.max(...partEnds.map(d=>d.getTime())));
        }
      }
    }
    
    // If no dates from parts, distribute assemblies in a realistic Gantt pattern
    if(!asmStart||!asmEnd){
      // Stagger assemblies: some overlap, some sequential
      const asmCount=asms.length;
      const avgDuration=Math.floor(totalDuration*0.4); // Each assembly ~40% of project
      const stagger=Math.floor((totalDuration-avgDuration)/(asmCount||1));
      
      const offset=asmIdx*stagger;
      asmStart=new Date(startDate.getTime()+offset*dayMs);
      asmEnd=new Date(asmStart.getTime()+avgDuration*dayMs);
      
      // Don't extend past project end
      if(asmEnd>endDate)asmEnd=new Date(endDate);
    }
    
    // Ensure minimum bar width
    if(asmEnd-asmStart<7*dayMs){
      asmEnd=new Date(asmStart.getTime()+14*dayMs);
    }
    
    rows.push({
      type:'asm',
      id:asm.id,
      name:asm.name,
      assignee:asm.assignee||'',
      dependency:asm.dependency||'',
      startDate:asmStart,
      endDate:asmEnd,
      progress:asmProgress,
      color:ganttBarColors['asm-'+asm.id]||asmColors[asmIdx%asmColors.length],
      partCount:asmParts.length
    });
  });

  // Filter rows by resource if filter is set
  if(ganttResourceFilter){
    rows=rows.filter(r=>r.assignee===ganttResourceFilter);
  }

  // Detect resource conflicts (before filtering changes the array)
  const conflicts=detectResourceConflicts(rows);
  const totalConflicts=conflicts.size;
  const conflictPopoverHtml=buildConflictPopoverHtml(conflicts, rows);

  // Sort: dependency chains first, independent items at bottom
  function dependencySortRows(items) {
    const itemMap = new Map(items.map(r => [r.id, r]));
    const dependents = new Map(items.map(r => [r.id, []]));
    
    // Build adjacency list
    items.forEach(r => {
      if (r.dependency && itemMap.has(r.dependency)) {
        dependents.get(r.dependency).push(r.id);
      }
    });
    
    // Categorize: chain members vs independent
    const hasFollows = new Set(items.filter(r => r.dependency && itemMap.has(r.dependency)).map(r => r.id));
    const isFollowed = new Set();
    items.forEach(r => {
      if (dependents.get(r.id).length > 0) isFollowed.add(r.id);
    });
    
    // Chain members: either follow something OR are followed
    const chainMembers = items.filter(r => hasFollows.has(r.id) || isFollowed.has(r.id));
    // Independent: neither follow nor are followed
    const independent = items.filter(r => !hasFollows.has(r.id) && !isFollowed.has(r.id));
    
    // Topological sort for chain members
    const inDegree = new Map(chainMembers.map(r => [r.id, 0]));
    chainMembers.forEach(r => {
      if (r.dependency && itemMap.has(r.dependency) && inDegree.has(r.dependency)) {
        inDegree.set(r.id, (inDegree.get(r.id) || 0) + 1);
      }
    });
    
    // Start with chain roots (in-degree 0)
    const queue = chainMembers
      .filter(r => inDegree.get(r.id) === 0)
      .sort((a, b) => {
        if (!a.startDate && !b.startDate) return 0;
        if (!a.startDate) return 1;
        if (!b.startDate) return -1;
        return a.startDate.getTime() - b.startDate.getTime();
      });
    
    const result = [];
    const processed = new Set();
    
    while (queue.length > 0) {
      const current = queue.shift();
      if (processed.has(current.id)) continue;
      
      result.push(current);
      processed.add(current.id);
      
      const deps = dependents.get(current.id)
        .map(id => itemMap.get(id))
        .filter(r => r && !processed.has(r.id) && inDegree.has(r.id))
        .sort((a, b) => {
          if (!a.startDate && !b.startDate) return 0;
          if (!a.startDate) return 1;
          if (!b.startDate) return -1;
          return a.startDate.getTime() - b.startDate.getTime();
        });
      
      deps.forEach(dep => {
        const newDegree = inDegree.get(dep.id) - 1;
        inDegree.set(dep.id, newDegree);
        if (newDegree === 0) {
          queue.push(dep);
        }
      });
    }
    
    // Add remaining chain members (cycles)
    chainMembers.forEach(r => {
      if (!processed.has(r.id)) result.push(r);
    });
    
    // Sort independent items by start date and add at bottom
    independent.sort((a, b) => {
      if (!a.startDate && !b.startDate) return 0;
      if (!a.startDate) return 1;
      if (!b.startDate) return -1;
      return a.startDate.getTime() - b.startDate.getTime();
    });
    
    return [...result, ...independent];
  }
  
  rows = dependencySortRows(rows);

  // Render sidebar (assemblies only)
  let sidebarHtml='';
  rows.forEach(row=>{
    const startStr=row.startDate?formatDateShort(row.startDate):'â€”';
    const endStr=row.endDate?formatDateShort(row.endDate):'â€”';
    const duration=row.startDate&&row.endDate?Math.max(1,Math.ceil((row.endDate-row.startDate)/dayMs)):'â€”';
    const startISO=row.startDate?row.startDate.toISOString().split('T')[0]:'';
    const endISO=row.endDate?row.endDate.toISOString().split('T')[0]:'';
    const nameLink='<span class="gantt-asm-link" onclick="window.goToAsm(\''+row.id+'\')">'+esc(row.name)+'</span>';
    
    // Build resource select dropdown
    let resourceOptions='<option value="">â€”</option>';
    team.forEach(t=>{
      const selected=t.name===row.assignee?'selected':'';
      resourceOptions+='<option value="'+esc(t.name)+'" '+selected+'>'+esc(t.name)+'</option>';
    });
    const resourceSelect='<select class="gantt-resource-select" onchange="window.setAsmAssignee(\''+row.id+'\',this.value)">'+resourceOptions+'</select>';
    
    // Build follows select dropdown (other assemblies only)
    let followsOptions='<option value="">â€”</option>';
    rows.forEach(other=>{
      if(other.id===row.id)return; // Can't follow self
      const selected=other.id===row.dependency?'selected':'';
      // Truncate name for dropdown
      const shortName=other.name.length>10?other.name.substring(0,10)+'â€¦':other.name;
      followsOptions+='<option value="'+other.id+'" '+selected+' title="'+esc(other.name)+'">'+esc(shortName)+'</option>';
    });
    const followsSelect='<select class="gantt-follows-select" onchange="window.setAsmDependency(\''+row.id+'\',this.value)" title="'+(row.dependency?esc(rows.find(r=>r.id===row.dependency)?.name||''):'Select predecessor')+'">'+followsOptions+'</select>';
    
    sidebarHtml+='<div class="gantt-sidebar-row asm" data-row-type="asm" data-row-id="'+row.id+'"><div class="gantt-col-name">'+nameLink+'</div><div class="gantt-col-resource">'+resourceSelect+'</div><div class="gantt-col-follows">'+followsSelect+'</div><div class="gantt-col-start" data-field="start" data-date="'+startISO+'">'+startStr+'</div><div class="gantt-col-end" data-field="end" data-date="'+endISO+'">'+endStr+'</div><div class="gantt-col-dur">'+duration+'</div></div>';
  });
  $('ganttSidebar').innerHTML=sidebarHtml;

  // Render timeline body with bars
  let bodyHtml='';

  rows.forEach((row,rowIdx)=>{
    let cellsHtml='';
    weeks.forEach(week=>{
      const classes=['gantt-timeline-cell'];
      if(week.isToday)classes.push('today');
      cellsHtml+='<div class="'+classes.join(' ')+'" style="min-width:'+cellWidth+'px;width:'+cellWidth+'px"></div>';
    });

    // Calculate bar position based on weeks
    let barHtml='';
    if(row.startDate&&row.endDate){
      // Find which week the bar starts and ends in
      let startWeekIdx=-1,endWeekIdx=-1;
      weeks.forEach((week,i)=>{
        if(startWeekIdx<0&&row.startDate<=week.end)startWeekIdx=i;
        if(row.endDate>=week.start)endWeekIdx=i;
      });
      
      if(startWeekIdx>=0){
        // Calculate precise position within week
        const startWeek=weeks[startWeekIdx];
        const daysIntoStartWeek=Math.max(0,Math.floor((row.startDate-startWeek.start)/dayMs));
        const barStart=startWeekIdx*cellWidth+(daysIntoStartWeek/7)*cellWidth;
        
        const endWeek=weeks[Math.min(endWeekIdx,weeks.length-1)];
        const daysIntoEndWeek=Math.min(7,Math.ceil((row.endDate-endWeek.start)/dayMs));
        const barEnd=endWeekIdx*cellWidth+(daysIntoEndWeek/7)*cellWidth;
        
        const barWidth=Math.max(12,barEnd-barStart);
        
        // Progress indicator
        const progressWidth=Math.round(row.progress);
        const incompleteWidth=100-progressWidth;
        const progressHtml=incompleteWidth>0?'<div class="gantt-bar-progress" style="width:'+incompleteWidth+'%"></div>':'';
        
        // Check for conflicts
        const rowConflicts=conflicts.get(row.id);
        const hasConflict=rowConflicts&&rowConflicts.length>0;
        const conflictClass=hasConflict?' has-conflict':'';
        const conflictIcon=hasConflict?'<span class="gantt-bar-conflict">âš ï¸</span>':'';
        
        // Build conflict data for tooltip
        let conflictData='';
        if(hasConflict){
          conflictData=rowConflicts.map(c=>c.name+'|'+formatDateShort(c.start)+'-'+formatDateShort(c.end)).join(';;');
        }
        
        // Check if overdue (end date passed but not 100% complete)
        const isOverdue=row.endDate<today&&row.progress<100;
        const overdueClass=isOverdue?' overdue':'';
        
        // Label shows assembly name + progress
        const label=esc(row.name)+' Â· '+row.progress+'%';
        
        // Resize handles
        const resizeHandles='<div class="gantt-bar-resize gantt-bar-resize-left" data-resize="start"></div><div class="gantt-bar-resize gantt-bar-resize-right" data-resize="end"></div>';
        
        // Data attributes for tooltip
        const startStr=formatDateShort(row.startDate);
        const endStr=formatDateShort(row.endDate);
        const duration=Math.max(1,Math.ceil((row.endDate-row.startDate)/dayMs));
        
        barHtml='<div class="gantt-bar-container" style="left:'+barStart+'px;width:'+barWidth+'px"><div class="gantt-bar gantt-bar-asm'+conflictClass+overdueClass+'" data-bar-type="asm" data-bar-id="'+row.id+'" data-name="'+esc(row.name)+'" data-start="'+startStr+'" data-end="'+endStr+'" data-duration="'+duration+'" data-progress="'+row.progress+'" data-assignee="'+(row.assignee||'')+'" data-parts="'+row.partCount+'" data-conflict="'+conflictData+'" data-overdue="'+(isOverdue?'1':'')+'" style="width:100%;background:'+row.color+'">'+progressHtml+conflictIcon+'<span class="gantt-bar-label">'+label+'</span>'+resizeHandles+'</div></div>';
      }
    }

    bodyHtml+='<div class="gantt-timeline-row" style="width:'+totalWidth+'px">'+cellsHtml+barHtml+'</div>';
  });

  // Add today line
  if(todayWeekIdx>=0){
    const daysIntoWeek=Math.floor((today-weeks[todayWeekIdx].start)/dayMs);
    const todayPos=todayWeekIdx*cellWidth+((daysIntoWeek+0.5)/7)*cellWidth;
    bodyHtml+='<div class="gantt-today-line" style="left:'+todayPos+'px"></div>';
  }

  // Render milestones
  milestones.forEach(m=>{
    const mDate=new Date(m.date);
    if(mDate<rangeStart||mDate>rangeEnd)return;
    
    // Find which week the milestone is in
    let mWeekIdx=-1;
    weeks.forEach((week,i)=>{
      if(mDate>=week.start&&mDate<=week.end)mWeekIdx=i;
    });
    
    if(mWeekIdx>=0){
      const mWeek=weeks[mWeekIdx];
      const daysIntoWeek=Math.floor((mDate-mWeek.start)/dayMs);
      const mPos=mWeekIdx*cellWidth+(daysIntoWeek/7)*cellWidth+cellWidth/14;
      bodyHtml+='<div class="gantt-milestone milestone-'+m.type+'" style="left:'+mPos+'px" data-milestone-id="'+m.id+'" data-name="'+esc(m.name)+'" data-date="'+formatDateShort(mDate)+'" data-type="'+m.type+'"></div>';
    }
  });

  $('ganttTimelineBody').innerHTML=bodyHtml;
  $('ganttTimelineBody').style.width=totalWidth+'px';
  $('ganttTimelineHeader').style.width=totalWidth+'px';
  // Set inner container width to enable horizontal scroll with sticky sidebar
  $('ganttBodyInner').style.width=(490+totalWidth)+'px';
  
  // Store state for dependency arrow re-rendering
  _ganttRenderState = { rows, cellWidth, weeks };
  
  // Render dependency arrows after DOM is fully ready
  // Double requestAnimationFrame ensures paint has completed
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      renderDependencyArrows(rows, cellWidth, weeks);
    });
  });

  // Scroll to today on render
  if(todayWeekIdx>=0&&!window._ganttScrolled){
    const container=$('ganttBodyWrap');
    if(container){
      // Center today in the viewport (accounting for sidebar width)
      const daysIntoWeek=Math.floor((today-weeks[todayWeekIdx].start)/dayMs);
      const todayPos=todayWeekIdx*cellWidth+(daysIntoWeek/7)*cellWidth;
      const scrollPos=Math.max(0,todayPos-container.clientWidth/2+210);
      container.scrollLeft=scrollPos;
      $('ganttTimelineHeaderWrap').scrollLeft=scrollPos;
      window._ganttScrolled=true;
    }
  }
  
  // Update conflict badge
  const badge=$('ganttConflictBadge');
  if(badge){
    if(totalConflicts>0){
      badge.innerHTML='<span class="gantt-conflict-badge" onmouseenter="this.querySelector(\'.gantt-conflict-popover\').classList.add(\'open\')" onmouseleave="this.querySelector(\'.gantt-conflict-popover\').classList.remove(\'open\')">âš ï¸ '+totalConflicts+' conflict'+(totalConflicts>1?'s':'')+
        '<div class="gantt-conflict-popover">'+conflictPopoverHtml+'</div></span>';
      badge.style.display='inline';
    }else{
      badge.style.display='none';
    }
  }
}

function getPartProgress(p){
  const stages=['waiting','to-order','ordered','arrived','installed'];
  const idx=stages.indexOf(p.status);
  if(idx<0)return 0;
  return Math.round((idx/(stages.length-1))*100);
}

// Render dependency arrows between connected bars
function renderDependencyArrows(rows, cellWidth, weeks) {
  // Remove existing SVG layer
  const existingSvg = document.querySelector('.gantt-dependency-layer');
  if (existingSvg) existingSvg.remove();
  
  const timelineBody = $('ganttTimelineBody');
  if (!timelineBody || !rows || !weeks || weeks.length === 0) return;
  
  // Helper to find week index for a date (more robust than boundary checking)
  const findWeekForDate = (date) => {
    if (!date) return -1;
    const dateTime = date.getTime();
    for (let i = 0; i < weeks.length; i++) {
      const weekStart = weeks[i].start.getTime();
      const weekEnd = i < weeks.length - 1 ? weeks[i + 1].start.getTime() : weekStart + 7 * 86400000;
      if (dateTime >= weekStart && dateTime < weekEnd) {
        return i;
      }
    }
    // Check if date is in the last week (including its end)
    if (weeks.length > 0) {
      const lastWeek = weeks[weeks.length - 1];
      if (dateTime >= lastWeek.start.getTime() && dateTime <= lastWeek.end.getTime()) {
        return weeks.length - 1;
      }
    }
    return -1;
  };
  
  // Find dependencies to draw
  const dependencies = [];
  const dayMs = 86400000;
  
  rows.forEach((row, rowIdx) => {
    if (!row.dependency) return;
    const predIdx = rows.findIndex(r => r.id === row.dependency);
    if (predIdx < 0) return;
    
    const pred = rows[predIdx];
    if (!pred.endDate || !row.startDate) return;
    
    // Calculate positions using robust week finding
    const predEndWeekIdx = findWeekForDate(pred.endDate);
    const rowStartWeekIdx = findWeekForDate(row.startDate);
    
    if (predEndWeekIdx < 0 || rowStartWeekIdx < 0) return;
    
    const predEndDaysIntoWeek = Math.max(0, Math.floor((pred.endDate - weeks[predEndWeekIdx].start) / dayMs));
    const predEndX = predEndWeekIdx * cellWidth + (predEndDaysIntoWeek / 7) * cellWidth + cellWidth / 7;
    
    const rowStartDaysIntoWeek = Math.max(0, Math.floor((row.startDate - weeks[rowStartWeekIdx].start) / dayMs));
    const rowStartX = rowStartWeekIdx * cellWidth + (rowStartDaysIntoWeek / 7) * cellWidth;
    
    // Y positions (center of each row, 44px height)
    const predY = predIdx * 44 + 22;
    const rowY = rowIdx * 44 + 22;
    
    dependencies.push({
      fromX: predEndX,
      fromY: predY,
      toX: rowStartX,
      toY: rowY
    });
  });
  
  if (dependencies.length === 0) return;
  
  // Calculate SVG dimensions
  const svgWidth = parseInt(timelineBody.style.width) || timelineBody.offsetWidth || 1000;
  const svgHeight = Math.max(rows.length * 44, timelineBody.offsetHeight, 100);
  
  // Create SVG layer
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.classList.add('gantt-dependency-layer');
  svg.setAttribute('width', svgWidth);
  svg.setAttribute('height', svgHeight);
  svg.style.width = svgWidth + 'px';
  svg.style.height = svgHeight + 'px';
  
  // Draw each dependency
  dependencies.forEach(dep => {
    const { fromX, fromY, toX, toY } = dep;
    
    // Create path - simple right-angle connector
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    
    // Calculate control points for a nice curved line
    const midX = fromX + (toX - fromX) / 2;
    let d;
    
    if (toX > fromX + 10) {
      // Normal case: successor is to the right
      d = `M ${fromX} ${fromY} C ${midX} ${fromY}, ${midX} ${toY}, ${toX - 6} ${toY}`;
    } else {
      // Successor overlaps or is to the left - go around
      const offset = 20;
      d = `M ${fromX} ${fromY} L ${fromX + offset} ${fromY} L ${fromX + offset} ${(fromY + toY) / 2} L ${toX - offset} ${(fromY + toY) / 2} L ${toX - offset} ${toY} L ${toX - 6} ${toY}`;
    }
    
    path.setAttribute('d', d);
    path.classList.add('gantt-dependency-line');
    svg.appendChild(path);
    
    // Arrow head
    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    arrow.setAttribute('points', `${toX - 6},${toY - 4} ${toX},${toY} ${toX - 6},${toY + 4}`);
    arrow.classList.add('gantt-dependency-arrow');
    svg.appendChild(arrow);
  });
  
  timelineBody.appendChild(svg);
}

window.toggleGanttAsm=(asmId,e)=>{
  e&&e.stopPropagation();
  ganttExpanded[String(asmId)]=ganttExpanded[String(asmId)]===false?true:false;
  renderGantt();
};

// Set assembly assignee
window.setAsmAssignee=(asmId,name)=>{
  const asm=data.find(d=>String(d.id)===String(asmId)&&d.isAsm);
  if(asm){
    asm.assignee=name||undefined;
    markAsmChanged(asm.id,['assignee']);
    save();
  }
};

// Check if setting dependency would create circular reference
function wouldCreateCircle(predecessorId, successorId) {
  if (!predecessorId || predecessorId === successorId) return false;
  
  const visited = new Set();
  
  function canReach(fromId, targetId) {
    if (fromId === targetId) return true;
    if (visited.has(fromId)) return false;
    visited.add(fromId);
    
    const asm = data.find(d => String(d.id) === String(fromId) && d.isAsm);
    if (!asm || !asm.dependency) return false;
    return canReach(asm.dependency, targetId);
  }
  
  // If we can reach predecessorId starting from successorId, it's circular
  return canReach(predecessorId, successorId);
}

// Auto-schedule: propagate date changes to dependent tasks
async function propagateDependencies(changedAsmId, _depth = 0) {
  const dayMs = 86400000;
  const changedAsm = data.find(d => String(d.id) === String(changedAsmId) && d.isAsm);
  if (!changedAsm) return 0;
  
  // Parse dates
  const parseDate = (str) => {
    if (!str) return null;
    const parts = str.split('-');
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  };
  const formatDate = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  
  const predecessorEnd = parseDate(changedAsm.ganttEnd);
  if (!predecessorEnd) return 0;
  
  // Find all assemblies that depend on the changed one
  const successors = data.filter(d => d.isAsm && !d._deletedAt && String(d.dependency) === String(changedAsmId));
  
  let rescheduledCount = 0;
  
  for (const successor of successors) {
    const successorStart = parseDate(successor.ganttStart);
    const successorEnd = parseDate(successor.ganttEnd);
    
    // New start is day after predecessor ends
    const newStart = new Date(predecessorEnd.getTime() + dayMs);
    
    // Calculate duration to preserve
    const duration = successorStart && successorEnd ? Math.round((successorEnd - successorStart) / dayMs) : 14;
    const newEnd = new Date(newStart.getTime() + duration * dayMs);
    
    // Check if dates actually need to change
    const newStartISO = formatDate(newStart);
    const newEndISO = formatDate(newEnd);
    
    if (successor.ganttStart !== newStartISO || successor.ganttEnd !== newEndISO) {
      // Update the successor
      successor.ganttStart = newStartISO;
      successor.ganttEnd = newEndISO;
      markAsmChanged(successor.id, ['ganttStart', 'ganttEnd']);
      rescheduledCount++;
      
      // Recursively propagate to this successor's dependents
      rescheduledCount += await propagateDependencies(successor.id, _depth + 1);
    }
  }
  
  return rescheduledCount;
}

// Set assembly dependency (predecessor)
window.setAsmDependency = async (asmId, predecessorId) => {
  const asm = data.find(d => String(d.id) === String(asmId) && d.isAsm);
  if (!asm) return;
  
  // Check for circular dependency
  if (predecessorId && wouldCreateCircle(asmId, predecessorId)) {
    alert('Cannot set this dependency - it would create a circular reference.');
    renderGantt(); // Reset dropdown
    return;
  }
  
  // Set the dependency
  asm.dependency = predecessorId || undefined;
  markAsmChanged(asm.id, ['dependency']);
  
  // If setting a predecessor, auto-schedule this task to start after predecessor ends
  if (predecessorId) {
    const dayMs = 86400000;
    const predecessor = data.find(d => String(d.id) === String(predecessorId) && d.isAsm);
    
    if (predecessor && predecessor.ganttEnd) {
      const parseDate = (str) => {
        if (!str) return null;
        const parts = str.split('-');
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      };
      const formatDate = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
      
      const predecessorEnd = parseDate(predecessor.ganttEnd);
      const currentStart = parseDate(asm.ganttStart);
      const currentEnd = parseDate(asm.ganttEnd);
      
      // New start is day after predecessor ends
      const newStart = new Date(predecessorEnd.getTime() + dayMs);
      
      // Preserve duration (default 14 days if no dates set)
      const duration = currentStart && currentEnd ? Math.round((currentEnd - currentStart) / dayMs) : 14;
      const newEnd = new Date(newStart.getTime() + duration * dayMs);
      
      // Always update dates when setting a dependency
      asm.ganttStart = formatDate(newStart);
      asm.ganttEnd = formatDate(newEnd);
      markAsmChanged(asm.id, ['ganttStart', 'ganttEnd']);
      
      // Propagate to any tasks that depend on this one
      await propagateDependencies(asm.id);
    }
  }
  
  await save();
  renderGantt();
};

// Populate resource filter dropdown
function updateResourceFilter(){
  const select=$('ganttResourceFilter');
  if(!select)return;
  const currentValue=ganttResourceFilter; // Use the variable, not select.value
  let html='<option value="">All Resources</option>';
  team.forEach(t=>{
    const selected=t.name===currentValue?'selected':'';
    html+='<option value="'+esc(t.name)+'" '+selected+'>'+esc(t.name)+'</option>';
  });
  select.innerHTML=html;
}

// Resource filter change handler
$('ganttResourceFilter').addEventListener('change',function(){
  ganttResourceFilter=this.value;
  renderGantt();
});

$('ganttToday').onclick=()=>{
  const container=$('ganttBodyWrap');
  const todayLine=document.querySelector('.gantt-today-line');
  if(container&&todayLine){
    const pos=parseInt(todayLine.style.left)||0;
    const scrollPos=Math.max(0,pos-container.clientWidth/2+210);
    container.scrollTo({left:scrollPos,behavior:'smooth'});
    $('ganttTimelineHeaderWrap').scrollTo({left:scrollPos,behavior:'smooth'});
  }
};

// Export Timeline as PDF
$('ganttExportPdf').onclick=async()=>{
  const btn=$('ganttExportPdf');
  const origText=btn.textContent;
  btn.textContent='Generating...';
  btn.disabled=true;
  
  try{
    // Create a container for the full timeline
    const exportDiv=document.createElement('div');
    exportDiv.style.cssText='position:absolute;left:-9999px;top:0;background:#ffffff;padding:24px;';
    document.body.appendChild(exportDiv);
    
    // Get timeline dimensions
    const header=$('ganttTimelineHeader');
    const sidebar=$('ganttSidebar');
    const body=$('ganttTimelineBody');
    const timelineWidth=parseInt(header.style.width)||1000;
    const sidebarWidth=360;
    const totalWidth=sidebarWidth+timelineWidth+40;
    
    // Build export HTML
    const title=currentProjectName||'Project Timeline';
    const dateStr=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
    
    // Remove today line from header (keep only in body)
    const headerHtml=header.innerHTML.replace(/<div class="gantt-today-line"[^>]*>.*?<\/div>/g,'');
    
    // Process sidebar to convert select elements to text
    let sidebarExport=sidebar.innerHTML;
    // Extract selected values from select elements and replace with text
    sidebarExport=sidebarExport.replace(/<select[^>]*class="gantt-resource-select"[^>]*>([\s\S]*?)<\/select>/g,(match,options)=>{
      const selectedMatch=options.match(/<option[^>]*selected[^>]*>([^<]*)<\/option>/);
      return '<span class="export-col-resource">'+(selectedMatch?selectedMatch[1]:'â€”')+'</span>';
    });
    // Extract follows select values
    sidebarExport=sidebarExport.replace(/<select[^>]*class="gantt-follows-select"[^>]*>([\s\S]*?)<\/select>/g,(match,options)=>{
      const selectedMatch=options.match(/<option[^>]*selected[^>]*>([^<]*)<\/option>/);
      return '<span class="export-col-follows">'+(selectedMatch?selectedMatch[1]:'â€”')+'</span>';
    });
    
    exportDiv.innerHTML=`
      <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#1a1a1a;width:${totalWidth}px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #e5e5e5;">
          <div>
            <div style="font-size:22px;font-weight:600;color:#1a1a1a;">${esc(title)}</div>
            <div style="font-size:12px;color:#666;margin-top:6px;">Exported ${dateStr}</div>
          </div>
        </div>
        <div style="display:flex;">
          <div style="width:${sidebarWidth}px;flex-shrink:0;overflow:hidden;">
            <div style="display:grid;grid-template-columns:1fr 60px 55px 45px 45px 35px;height:42px;border-bottom:2px solid #e5e5e5;font-size:10px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.5px;align-items:center;">
              <div style="padding-left:12px;">Task Name</div>
              <div style="text-align:center;">Resource</div>
              <div style="text-align:center;">Follows</div>
              <div style="text-align:center;">Start</div>
              <div style="text-align:center;">End</div>
              <div style="text-align:center;">Days</div>
            </div>
            ${sidebarExport.replace(/gantt-sidebar-row/g,'export-row').replace(/gantt-col-name/g,'export-col-name').replace(/gantt-col-resource/g,'export-col-resource').replace(/gantt-col-follows/g,'export-col-follows').replace(/gantt-col-start/g,'export-col-start').replace(/gantt-col-end/g,'export-col-end').replace(/gantt-col-dur/g,'export-col-dur').replace(/gantt-asm-link/g,'export-asm-link').replace(/onclick="[^"]*"/g,'').replace(/onchange="[^"]*"/g,'')}
          </div>
          <div style="flex:1;overflow:hidden;">
            <div style="display:flex;border-bottom:2px solid #e5e5e5;height:42px;align-items:center;">
              ${headerHtml.replace(/gantt-timeline-day/g,'export-day')}
            </div>
            <div style="position:relative;">
              ${body.innerHTML.replace(/gantt-timeline-row/g,'export-trow').replace(/gantt-timeline-cell/g,'export-cell').replace(/gantt-bar-container/g,'export-bar-container').replace(/gantt-bar /g,'export-bar ').replace(/gantt-bar-progress/g,'export-bar-progress').replace(/gantt-bar-label/g,'export-bar-label').replace(/gantt-today-line/g,'export-today-line')}
            </div>
          </div>
        </div>
      </div>
      <style>
        *{box-sizing:border-box;}
        .export-row{display:grid;grid-template-columns:1fr 60px 55px 45px 45px 35px;border-bottom:1px solid #eee;font-size:12px;align-items:center;height:44px;}
        .export-row>div,.export-row>span{padding:0 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .export-col-name{padding-left:12px;font-weight:500;}
        .export-col-resource{text-align:center;font-size:10px;color:#666;}
        .export-col-follows{text-align:center;font-size:10px;color:#666;}
        .export-col-start,.export-col-end{text-align:center;font-size:10px;color:#666;}
        .export-col-dur{text-align:center;font-size:10px;color:#888;}
        .export-asm-link{color:#1a1a1a;text-decoration:none;font-weight:500;}
        .export-day{min-width:32px;width:32px;text-align:center;font-size:9px;color:#666;border-right:1px solid #eee;display:inline-flex;flex-direction:column;justify-content:center;background:#fafafa;height:42px;}
        .export-day.today{background:#fff3e0;}
        .export-trow{display:flex;height:44px;border-bottom:1px solid #eee;position:relative;}
        .export-cell{min-width:32px;width:32px;height:44px;border-right:1px solid #eee;display:inline-block;background:#fff;}
        .export-cell.today{background:#fff8e8;}
        .export-bar-container{position:absolute;top:0;bottom:0;display:flex;align-items:center;}
        .export-bar{height:18px;border-radius:4px;font-size:11px;font-weight:500;color:#fff;display:flex;align-items:center;padding:0 10px;position:relative;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.15);}
        .export-bar-progress{position:absolute;right:0;top:0;bottom:0;background:#9a9a9a;border-radius:4px;}
        .export-bar-label{position:relative;z-index:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .export-today-line{position:absolute;top:0;bottom:0;width:2px;background:#cc3300;z-index:10;}
      </style>
    `;
    
    // Wait for render
    await new Promise(r=>setTimeout(r,150));
    
    // Capture with html2canvas at higher resolution
    const canvas=await html2canvas(exportDiv,{
      backgroundColor:'#ffffff',
      scale:3,
      useCORS:true,
      logging:false
    });
    
    // Create PDF
    const {jsPDF}=window.jspdf;
    const imgWidth=canvas.width;
    const imgHeight=canvas.height;
    
    // Calculate PDF dimensions (landscape, fit to width)
    const pdfWidth=Math.min(imgWidth/3,1400);
    const pdfHeight=(imgHeight/imgWidth)*pdfWidth;
    
    const pdf=new jsPDF({
      orientation:pdfWidth>pdfHeight?'landscape':'portrait',
      unit:'px',
      format:[pdfWidth+40,pdfHeight+40]
    });
    
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',20,20,pdfWidth,pdfHeight);
    
    // Download
    const filename=(currentProjectName||'timeline').replace(/[^a-z0-9]/gi,'_')+'_'+new Date().toISOString().split('T')[0]+'.pdf';
    pdf.save(filename);
    
    // Cleanup
    document.body.removeChild(exportDiv);
    
    
  }catch(err){
    console.error('PDF export error:',err);
    
  }finally{
    btn.textContent=origText;
    btn.disabled=false;
  }
};

// Sync horizontal scroll between header and body
$('ganttBodyWrap').addEventListener('scroll',function(){
  $('ganttTimelineHeaderWrap').scrollLeft=this.scrollLeft;
});

// Drag to scroll with momentum
(function(){
  const container=$('ganttBodyWrap');
  if(!container)return;
  
  let isDragging=false;
  let startX=0;
  let scrollStartX=0;
  let velocity=0;
  let lastX=0;
  let lastTime=0;
  let momentumId=null;
  
  container.addEventListener('mousedown',e=>{
    // Don't start drag on interactive elements
    if(e.target.closest('.gantt-bar')||e.target.closest('.gantt-col-start')||e.target.closest('.gantt-col-end')||e.target.closest('select')||e.target.closest('.gantt-col-resource')){return;}
    isDragging=true;
    startX=e.pageX;
    scrollStartX=container.scrollLeft;
    lastX=e.pageX;
    lastTime=Date.now();
    velocity=0;
    container.classList.add('grabbing');
    if(momentumId){cancelAnimationFrame(momentumId);momentumId=null;}
    e.preventDefault();
  });
  
  document.addEventListener('mousemove',e=>{
    if(!isDragging)return;
    const x=e.pageX;
    const walk=startX-x;
    container.scrollLeft=scrollStartX+walk;
    
    // Calculate velocity
    const now=Date.now();
    const dt=now-lastTime;
    if(dt>0){
      velocity=(lastX-x)/dt;
    }
    lastX=x;
    lastTime=now;
  });
  
  document.addEventListener('mouseup',()=>{
    if(!isDragging)return;
    isDragging=false;
    container.classList.remove('grabbing');
    
    // Apply momentum
    if(Math.abs(velocity)>0.1){
      const deceleration=0.95;
      const minVelocity=0.1;
      
      function applyMomentum(){
        if(Math.abs(velocity)<minVelocity){
          momentumId=null;
          return;
        }
        container.scrollLeft+=velocity*16;
        velocity*=deceleration;
        momentumId=requestAnimationFrame(applyMomentum);
      }
      applyMomentum();
    }
  });
  
  // Cancel momentum on new interaction
  container.addEventListener('wheel',()=>{
    if(momentumId){cancelAnimationFrame(momentumId);momentumId=null;}
  });
})();

// Bar dragging to change dates
(function(){
  let dragging=null;
  let resizing=null;
  const weekWidth=32;  // pixels per week
  const dayWidth=weekWidth/7;  // pixels per day
  const dayMs=86400000;
  
  function parseDate(str){
    if(!str)return null;
    const p=str.split('-');
    return new Date(+p[0],+p[1]-1,+p[2]);
  }
  
  function fmtDate(d){
    return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  }
  
  function fmtShort(d){
    return d.getDate()+'.'+(d.getMonth()+1)+'.';
  }

  document.addEventListener('mousedown',function(e){
    const bar=e.target.closest('.gantt-bar');
    if(!bar||bar.dataset.barType!=='asm')return;
    if(!e.target.closest('#ganttTimelineBody'))return;
    
    const id=bar.dataset.barId;
    const row=document.querySelector('.gantt-sidebar-row[data-row-id="'+id+'"]');
    if(!row)return;
    
    const startEl=row.querySelector('.gantt-col-start');
    const endEl=row.querySelector('.gantt-col-end');
    if(!startEl||!endEl||!startEl.dataset.date||!endEl.dataset.date)return;
    
    const container=bar.closest('.gantt-bar-container');
    const resizeHandle=e.target.closest('.gantt-bar-resize');
    
    // Check if clicking on resize handle
    if(resizeHandle){
      const edge=resizeHandle.dataset.resize; // 'start' or 'end'
      resizing={
        bar:bar,
        container:container,
        id:id,
        edge:edge,
        startX:e.clientX,
        origLeft:parseInt(container.style.left)||0,
        origWidth:parseInt(container.style.width)||100,
        origStart:parseDate(startEl.dataset.date),
        origEnd:parseDate(endEl.dataset.date),
        startEl:startEl,
        endEl:endEl,
        lastDays:0
      };
      bar.style.opacity='0.85';
      document.body.style.cursor='ew-resize';
      document.body.style.userSelect='none';
      e.preventDefault();
      e.stopPropagation();
      return;
    }
    
    // Regular drag
    dragging={
      bar:bar,
      container:container,
      id:id,
      startX:e.clientX,
      origLeft:parseInt(container.style.left)||0,
      origStart:parseDate(startEl.dataset.date),
      origEnd:parseDate(endEl.dataset.date),
      startEl:startEl,
      endEl:endEl,
      lastDays:0
    };
    
    bar.style.opacity='0.85';
    bar.style.boxShadow='0 4px 16px rgba(0,0,0,0.3)';
    document.body.style.cursor='grabbing';
    document.body.style.userSelect='none';
    e.preventDefault();
    e.stopPropagation();
  },true);
  
  document.addEventListener('mousemove',function(e){
    // Handle resize
    if(resizing){
      const dx=e.clientX-resizing.startX;
      const days=Math.round(dx/dayWidth);
      
      if(resizing.edge==='end'){
        // Resize end: change width
        const newWidth=Math.max(dayWidth*2,resizing.origWidth+days*dayWidth);
        resizing.container.style.width=newWidth+'px';
        resizing.bar.style.width='100%';
        
        if(days!==resizing.lastDays){
          resizing.lastDays=days;
          const newEnd=new Date(resizing.origEnd.getTime()+days*dayMs);
          resizing.endEl.textContent=fmtShort(newEnd);
        }
      }else{
        // Resize start: change left and width
        const newLeft=resizing.origLeft+days*dayWidth;
        const newWidth=Math.max(dayWidth*2,resizing.origWidth-days*dayWidth);
        resizing.container.style.left=newLeft+'px';
        resizing.container.style.width=newWidth+'px';
        resizing.bar.style.width='100%';
        
        if(days!==resizing.lastDays){
          resizing.lastDays=days;
          const newStart=new Date(resizing.origStart.getTime()+days*dayMs);
          resizing.startEl.textContent=fmtShort(newStart);
        }
      }
      return;
    }
    
    // Handle drag
    if(!dragging)return;
    
    const dx=e.clientX-dragging.startX;
    const days=Math.round(dx/dayWidth);
    
    // Move bar visually
    dragging.container.style.left=(dragging.origLeft+days*dayWidth)+'px';
    
    // Update sidebar dates if days changed
    if(days!==dragging.lastDays){
      dragging.lastDays=days;
      const newStart=new Date(dragging.origStart.getTime()+days*dayMs);
      const newEnd=new Date(dragging.origEnd.getTime()+days*dayMs);
      dragging.startEl.textContent=fmtShort(newStart);
      dragging.endEl.textContent=fmtShort(newEnd);
    }
  });
  
  document.addEventListener('mouseup',function(e){
    // Handle resize complete
    if(resizing){
      const dx=e.clientX-resizing.startX;
      const days=Math.round(dx/dayWidth);
      
      resizing.bar.style.opacity='';
      document.body.style.cursor='';
      document.body.style.userSelect='';
      
      if(days!==0){
        const asm=data.find(d=>String(d.id)===String(resizing.id)&&d.isAsm);
        if(asm){
          if(resizing.edge==='end'){
            const newEnd=new Date(resizing.origEnd.getTime()+days*dayMs);
            asm.ganttEnd=fmtDate(newEnd);
          }else{
            const newStart=new Date(resizing.origStart.getTime()+days*dayMs);
            asm.ganttStart=fmtDate(newStart);
          }
          markAsmChanged(asm.id,['ganttStart','ganttEnd']);
          save();
          // Propagate changes to dependent tasks, always render after
          propagateDependencies(asm.id).catch(e => console.warn('Propagate error:', e)).finally(() => {
            save();
            renderGantt();
          });
        } else {
          renderGantt();
        }
        window._ganttJustDragged=true;
        setTimeout(()=>window._ganttJustDragged=false,100);
      }
      
      resizing=null;
      return;
    }
    
    // Handle drag complete
    if(!dragging)return;
    
    const dx=e.clientX-dragging.startX;
    const days=Math.round(dx/dayWidth);
    
    // Reset visual
    dragging.bar.style.opacity='';
    dragging.bar.style.boxShadow='';
    document.body.style.cursor='';
    document.body.style.userSelect='';
    
    // Save if moved
    if(days!==0){
      const newStart=new Date(dragging.origStart.getTime()+days*dayMs);
      const newEnd=new Date(dragging.origEnd.getTime()+days*dayMs);
      
      const asm=data.find(d=>String(d.id)===String(dragging.id)&&d.isAsm);
      if(asm){
        asm.ganttStart=fmtDate(newStart);
        asm.ganttEnd=fmtDate(newEnd);
        markAsmChanged(asm.id,['ganttStart','ganttEnd']);
        save();
        // Propagate changes to dependent tasks, always render after
        propagateDependencies(asm.id).catch(e => console.warn('Propagate error:', e)).finally(() => {
          save();
          renderGantt();
        });
      } else {
        renderGantt();
      }
      window._ganttJustDragged=true;
      setTimeout(()=>window._ganttJustDragged=false,100);
    }
    
    dragging=null;
  });
})();

// Hover tooltip for bars and milestones
(function(){
  const tooltip=$('ganttTooltip');
  const tooltipTitle=$('ganttTooltipTitle');
  const tooltipBody=$('ganttTooltipBody');
  let hideTimeout=null;
  let showTimeout=null;
  
  function showTooltip(x,y,title,bodyHtml){
    tooltipTitle.textContent=title;
    tooltipBody.innerHTML=bodyHtml;
    
    // Position tooltip
    tooltip.style.left=x+'px';
    tooltip.style.top=y+'px';
    tooltip.classList.add('visible');
    
    // Adjust if off screen
    const rect=tooltip.getBoundingClientRect();
    if(rect.right>window.innerWidth-10){
      tooltip.style.left=(x-rect.width-10)+'px';
    }
    if(rect.bottom>window.innerHeight-10){
      tooltip.style.top=(y-rect.height-10)+'px';
    }
  }
  
  function hideTooltip(){
    tooltip.classList.remove('visible');
  }
  
  function scheduleTooltip(x,y,title,bodyHtml){
    clearTimeout(showTimeout);
    showTimeout=setTimeout(()=>showTooltip(x,y,title,bodyHtml),1000);
  }
  
  // Bar hover
  document.addEventListener('mouseover',function(e){
    const bar=e.target.closest('.gantt-bar[data-bar-type="asm"]');
    if(bar){
      clearTimeout(hideTimeout);
      clearTimeout(showTimeout);
      
      const name=bar.dataset.name||'';
      const start=bar.dataset.start||'';
      const end=bar.dataset.end||'';
      const duration=bar.dataset.duration||'';
      const progress=bar.dataset.progress||'0';
      const assignee=bar.dataset.assignee||'Unassigned';
      const parts=bar.dataset.parts||'0';
      const conflict=bar.dataset.conflict||'';
      const overdue=bar.dataset.overdue==='1';
      
      let bodyHtml='<div class="gantt-tooltip-row"><span>Dates:</span><span>'+start+' â†’ '+end+'</span></div>';
      bodyHtml+='<div class="gantt-tooltip-row"><span>Duration:</span><span>'+duration+' days</span></div>';
      bodyHtml+='<div class="gantt-tooltip-row"><span>Progress:</span><span>'+progress+'%</span></div>';
      bodyHtml+='<div class="gantt-tooltip-row"><span>Assignee:</span><span>'+assignee+'</span></div>';
      bodyHtml+='<div class="gantt-tooltip-row"><span>Parts:</span><span>'+parts+'</span></div>';
      
      if(overdue){
        bodyHtml+='<div class="gantt-tooltip-overdue">âš ï¸ Overdue - past end date</div>';
      }
      
      if(conflict){
        const conflicts=conflict.split(';;').map(c=>{
          const parts=c.split('|');
          return '<div>â€¢ '+parts[0]+' ('+parts[1]+')</div>';
        }).join('');
        bodyHtml+='<div class="gantt-tooltip-conflict">âš ï¸ Resource conflict:<br>'+conflicts+'</div>';
      }
      
      const rect=bar.getBoundingClientRect();
      scheduleTooltip(rect.right+10,rect.top,name,bodyHtml);
      return;
    }
    
    // Milestone hover
    const milestone=e.target.closest('.gantt-milestone');
    if(milestone){
      clearTimeout(hideTimeout);
      clearTimeout(showTimeout);
      
      const name=milestone.dataset.name||'';
      const date=milestone.dataset.date||'';
      const type=milestone.dataset.type||'';
      const typeLabels={deadline:'ðŸ”´ Deadline',delivery:'ðŸŸ¢ Delivery',review:'ðŸŸ  Review',custom:'ðŸŸ£ Custom'};
      
      const bodyHtml='<div class="gantt-tooltip-row"><span>Date:</span><span>'+date+'</span></div><div class="gantt-tooltip-row"><span>Type:</span><span>'+(typeLabels[type]||type)+'</span></div>';
      
      const rect=milestone.getBoundingClientRect();
      scheduleTooltip(rect.right+10,rect.top-20,name,bodyHtml);
      return;
    }
  });
  
  document.addEventListener('mouseout',function(e){
    const bar=e.target.closest('.gantt-bar[data-bar-type="asm"]');
    const milestone=e.target.closest('.gantt-milestone');
    if(bar||milestone){
      clearTimeout(showTimeout);
      hideTimeout=setTimeout(hideTooltip,100);
    }
  });
})();

// Color picker for bars
const ganttColors=['#ff6b6b','#ffa94d','#ffd43b','#69db7c','#38d9a9','#4dabf7','#748ffc','#da77f2','#f783ac','#868e96'];

function renderGanttColorGrid(){
  $('ganttColorGrid').innerHTML=ganttColors.map(c=>'<div class="gantt-color-swatch" data-color="'+c+'" style="background:'+c+'"></div>').join('');
}
renderGanttColorGrid();

let colorPickerTarget=null;

document.addEventListener('click',e=>{
  const bar=e.target.closest('.gantt-bar');
  const popup=$('ganttColorPopup');
  
  // Close popup if clicking outside
  if(!bar&&!popup.contains(e.target)){
    popup.classList.remove('open');
    colorPickerTarget=null;
    return;
  }
  
  // Don't open color picker if we just finished dragging
  if(window._ganttJustDragged)return;
  
  // Open popup for bar click
  if(bar&&!e.target.closest('.gantt-color-popup')){
    const barType=bar.dataset.barType;
    const barId=bar.dataset.barId;
    if(!barType||!barId)return;
    
    colorPickerTarget={type:barType,id:barId};
    const rect=bar.getBoundingClientRect();
    const panelRect=$('ganttPanel').getBoundingClientRect();
    
    popup.style.left=(rect.left-panelRect.left+rect.width/2-80)+'px';
    popup.style.top=(rect.bottom-panelRect.top+8)+'px';
    popup.classList.add('open');
    
    // Highlight current color
    const currentColor=ganttBarColors[barType+'-'+barId];
    document.querySelectorAll('.gantt-color-swatch').forEach(s=>{
      s.classList.toggle('selected',s.dataset.color===currentColor);
    });
  }
});

$('ganttColorGrid').addEventListener('click',e=>{
  const swatch=e.target.closest('.gantt-color-swatch');
  if(!swatch||!colorPickerTarget)return;
  
  const color=swatch.dataset.color;
  const key=colorPickerTarget.type+'-'+colorPickerTarget.id;
  ganttBarColors[key]=color;
  
  // Update the bar immediately
  const bar=document.querySelector('.gantt-bar[data-bar-type="'+colorPickerTarget.type+'"][data-bar-id="'+colorPickerTarget.id+'"]');
  if(bar)bar.style.background=color;
  
  $('ganttColorPopup').classList.remove('open');
  colorPickerTarget=null;
  
  // Save colors
  try{localStorage.setItem('ganttBarColors',JSON.stringify(ganttBarColors))}catch(e){}
});

// Load saved colors
try{
  const saved=localStorage.getItem('ganttBarColors');
  if(saved)ganttBarColors=JSON.parse(saved);
}catch(e){}

// Date picker popup for gantt row dates
let datePickerTarget=null;

$('ganttSidebar').addEventListener('click',e=>{
  // Don't interfere with select dropdowns
  if(e.target.closest('select'))return;
  
  const dateCell=e.target.closest('.gantt-col-start, .gantt-col-end');
  if(!dateCell)return;
  
  const row=dateCell.closest('.gantt-sidebar-row');
  if(!row)return;
  
  const rowType=row.dataset.rowType;
  const rowId=row.dataset.rowId;
  const field=dateCell.dataset.field;
  const currentDate=dateCell.dataset.date||'';
  
  datePickerTarget={type:rowType,id:rowId,field};
  
  $('ganttDatePopupTitle').textContent=field==='start'?'Start Date':'End Date';
  $('ganttDatePopupInput').value=currentDate;
  
  const popup=$('ganttDatePopup');
  const rect=dateCell.getBoundingClientRect();
  const panelRect=$('ganttPanel').getBoundingClientRect();
  
  popup.style.left=(rect.left-panelRect.left)+'px';
  popup.style.top=(rect.bottom-panelRect.top+4)+'px';
  popup.classList.add('open');
  
  setTimeout(()=>$('ganttDatePopupInput').focus(),50);
});

$('ganttDatePopupSave').onclick=()=>{
  if(!datePickerTarget)return;
  const newDate=$('ganttDatePopupInput').value;
  
  if(datePickerTarget.type==='part'){
    const part=data.find(d=>String(d.id)===String(datePickerTarget.id));
    if(part){
      if(datePickerTarget.field==='start'){
        part.orderedAt=newDate?new Date(newDate).getTime():undefined;
      }else{
        part.expectedArrival=newDate||undefined;
      }
      markPartChanged(part.id,['orderedAt','expectedArrival']);
      save();
      renderGantt();
    }
  }else if(datePickerTarget.type==='asm'){
    const asm=data.find(d=>String(d.id)===String(datePickerTarget.id)&&d.isAsm);
    if(asm){
      if(datePickerTarget.field==='start'){
        asm.ganttStart=newDate||undefined;
      }else{
        asm.ganttEnd=newDate||undefined;
      }
      markAsmChanged(asm.id,['ganttStart','ganttEnd']);
      save();
      // Propagate changes to dependent tasks, always render after
      propagateDependencies(asm.id).catch(e => console.warn('Propagate error:', e)).finally(() => {
        save();
        renderGantt();
        
      });
    }
  }
  
  $('ganttDatePopup').classList.remove('open');
  datePickerTarget=null;
};

$('ganttDatePopupClear').onclick=()=>{
  if(!datePickerTarget)return;
  
  if(datePickerTarget.type==='part'){
    const part=data.find(d=>String(d.id)===String(datePickerTarget.id));
    if(part){
      if(datePickerTarget.field==='start'){
        part.orderedAt=undefined;
      }else{
        part.expectedArrival=undefined;
      }
      markPartChanged(part.id,['orderedAt','expectedArrival']);
      save();
      renderGantt();
    }
  }else if(datePickerTarget.type==='asm'){
    const asm=data.find(d=>String(d.id)===String(datePickerTarget.id)&&d.isAsm);
    if(asm){
      if(datePickerTarget.field==='start'){
        asm.ganttStart=undefined;
      }else{
        asm.ganttEnd=undefined;
      }
      markAsmChanged(asm.id,['ganttStart','ganttEnd']);
      save();
      renderGantt();
      
    }
  }
  
  $('ganttDatePopup').classList.remove('open');
  datePickerTarget=null;
};

// Close date popup when clicking outside
document.addEventListener('click',e=>{
  const popup=$('ganttDatePopup');
  if(popup.classList.contains('open')&&!popup.contains(e.target)&&!e.target.closest('.gantt-col-start')&&!e.target.closest('.gantt-col-end')){
    popup.classList.remove('open');
    datePickerTarget=null;
  }
});

function generateAIInsights(){
  const insights=[],parts=getParts();
  const today=new Date().toISOString().split('T')[0];
  const now=Date.now(),day=86400000;
  const pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast();
  // Action plan removed - overdue actions check removed
  if(forecast&&forecast.status==='at-risk'){insights.push({level:'critical',icon:'ðŸ“‰',title:'Completion at risk',desc:'At current rate, finishing '+(forecast.daysToComplete-forecast.daysLeft)+' days late',action:'Review metrics â†’',handler:()=>{window.toggleMetricsPopover({stopPropagation:()=>{}});minimizeCmdWindow()}})}
  if(expected!==null&&pct<expected-10){insights.push({level:'critical',icon:'ðŸ“Š',title:'Behind schedule',desc:(expected-pct)+'% behind target progress',action:'Review metrics â†’',handler:()=>{window.toggleMetricsPopover({stopPropagation:()=>{}});minimizeCmdWindow()}})}
  const stuckParts=parts.filter(p=>p.status==='to-order'&&p.changedAt&&(now-p.changedAt)>5*day);
  if(stuckParts.length>0){insights.push({level:'warning',icon:'â³',title:stuckParts.length+' part'+(stuckParts.length>1?'s':'')+' ready to order >5 days',desc:stuckParts.map(p=>p.name).slice(0,2).join(', '),action:'View parts â†’',handler:()=>{filterStage='to-order';render();minimizeCmdWindow()}})}
  const longTransit=parts.filter(p=>p.status==='ordered'&&p.changedAt&&(now-p.changedAt)>7*day);
  if(longTransit.length>0){insights.push({level:'warning',icon:'ðŸ“¦',title:longTransit.length+' part'+(longTransit.length>1?'s':'')+' in transit >7d',desc:'Follow up with suppliers',action:'View parts â†’',handler:()=>{filterStage='ordered';render();minimizeCmdWindow()}})}
  const missingEta=parts.filter(p=>(p.status==='to-order'||p.status==='ordered')&&getPartETA(p).type==='unknown');
  if(missingEta.length>0){insights.push({level:'warning',icon:'â“',title:missingEta.length+' part'+(missingEta.length>1?'s':'')+' missing ETA',desc:'Add lead time data for planning',action:'Set ETA â†’',handler:()=>{if(missingEta[0])window.openEtaModal(missingEta[0].id);minimizeCmdWindow()}})}
  const otd=calcSupplierOTD();
  if(otd!==null&&otd<80){insights.push({level:'warning',icon:'ðŸšš',title:'Supplier OTD: '+otd+'%',desc:'Consider adding buffer to estimates',action:'View lead times â†’',handler:()=>{renderLeadTimeModal();$('leadtimeModal').classList.add('open');minimizeCmdWindow()}})}
  if(forecast&&forecast.status==='ahead'){insights.push({level:'success',icon:'ðŸŽ¯',title:'Ahead of schedule',desc:'Finishing '+(forecast.daysLeft-forecast.daysToComplete)+' days early',action:null,handler:null})}
  const readyToInstall=parts.filter(p=>p.status==='arrived');
  if(readyToInstall.length>0){insights.push({level:'info',icon:'âœ“',title:readyToInstall.length+' ready to install',desc:readyToInstall.map(p=>p.name).slice(0,3).join(', '),action:'Install now â†’',handler:()=>{filterStage='arrived';render();minimizeCmdWindow()}})}
  if(insights.length===0){insights.push({level:'success',icon:'âœ“',title:'All systems nominal',desc:'No issues detected',action:null,handler:null})}
  return insights;
}

function updateAIAlert(){
  // Just generate insights for caching
  window._aiInsights=generateAIInsights();
}

// ============================================
// Event Logging for AI Learning
// ============================================
const eventLogRef=db.ref('analytics/events');

function logEvent(type,eventData){
  const event={
    timestamp:Date.now(),
    type,
    projectName:currentProjectName,
    ...eventData
  };
  eventLogRef.push(event).catch(e=>console.warn('Event log failed:',e));
}

function logArrival(part,daysInTransit,wasLate,daysDelta){
  logEvent('arrival',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    daysInTransit,
    expectedArrival:part.expectedArrival||null,
    wasLate,
    daysDelta,
    assemblyId:part.parentId,
    assemblyName:getAsms().find(a=>String(a.id)===String(part.parentId))?.name||''
  });
}

function logStuck(part,stage,daysStuck){
  logEvent('stuck',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    stage,
    daysStuck,
    assemblyId:part.parentId
  });
}

function logEtaMiss(part,expectedDate,actualDate,daysDelta){
  logEvent('eta_miss',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    expectedDate,
    actualDate,
    daysDelta
  });
}

function logComment(part,text){
  logEvent('comment',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    assemblyId:part.parentId,
    text:text.slice(0,500),
    partStatus:part.status
  });
}

function logActionOverdue(action,daysOverdue){
  logEvent('action_overdue',{
    actionId:action.id,
    task:action.task,
    assignee:action.assignee||'',
    daysOverdue,
    linkedPartId:action.linkedPartId||null
  });
}

// ============================================
// Activity Log (Audit Trail) - Simplified
// ============================================
let activityData = [];
let activityFilter = 'all';

// Log activity: immediate local update + Firebase persist
function logActivity(type, action, details = {}) {
  if (!currentProjectCode) return;
  const activity = {
    id: 'local_' + Date.now(),
    timestamp: Date.now(),
    type,
    action,
    userId: clientId || 'unknown',
    ...details
  };
  // Immediately add to local array (newest first)
  activityData.unshift(activity);
  // Keep only last 100
  if (activityData.length > 100) activityData.pop();
  // Update UI immediately
  renderActivitySidebar();
  // Persist to Firebase (fire and forget)
  if (isConnected && isAuthenticated) {
    const { id, ...firebaseData } = activity;
    db.ref(`projects/${currentProjectCode}/activity`).push(firebaseData);
  }
}

// Load activity from Firebase (one-time fetch on project load)
function loadActivity() {
  if (!currentProjectCode) return;
  activityData = []; // Clear existing
  renderActivitySidebar();
  if (!isConnected || !isAuthenticated) return;
  db.ref(`projects/${currentProjectCode}/activity`)
    .orderByChild('timestamp')
    .limitToLast(100)
    .once('value')
    .then(snap => {
      const items = [];
      snap.forEach(child => {
        const val = child.val();
        if (val && val.timestamp) {
          items.push({ id: child.key, ...val });
        }
      });
      // Sort newest first
      items.sort((a, b) => b.timestamp - a.timestamp);
      activityData = items;
      renderActivitySidebar();
    })
    .catch(err => console.error('Failed to load activity:', err));
}

function getActivityIcon(type) {
  // Minimal line icons (14px, stroke-based)
  const icons = {
    status: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
    eta: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    part_add: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
    part_delete: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
    part_edit: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
    date: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    assembly: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
    assembly_delete: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>'
  };
  return icons[type] || '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="3"/></svg>';
}

function timeAgo(ts) {
  if (!ts) return '';
  const diff = Date.now() - ts;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  return days + 'd ago';
}

function renderActivitySidebar() {
  const el = $('activityLog');
  if (!el) return;
  const items = activityData.slice(0, 5);
  if (items.length === 0) {
    el.innerHTML = '<div class="activity-empty">No recent activity</div>';
    return;
  }
  el.innerHTML = items.map(a => `
    <div class="activity-item">
      <span class="activity-icon">${getActivityIcon(a.type)}</span>
      <span class="activity-text">${esc(a.action)}</span>
      <span class="activity-time">${timeAgo(a.timestamp)}</span>
    </div>
  `).join('');
}

function renderActivityFull() {
  const el = $('activityFullList');
  if (!el) return;
  let items = activityData;
  if (activityFilter !== 'all') {
    const filterMap = {
      status: ['status'],
      parts: ['part_add', 'part_delete', 'part_edit', 'assembly', 'assembly_delete'],
      dates: ['eta', 'date']
    };
    const types = filterMap[activityFilter] || [];
    items = items.filter(a => types.includes(a.type));
  }
  if (items.length === 0) {
    el.innerHTML = '<div class="activity-empty">No activity matching filter</div>';
    return;
  }
  el.innerHTML = items.map(a => `
    <div class="activity-item">
      <span class="activity-icon">${getActivityIcon(a.type)}</span>
      <span class="activity-text">${esc(a.action)}</span>
      <span class="activity-time">${timeAgo(a.timestamp)}</span>
    </div>
  `).join('');
}

// ============================================
// AI Report Generation (LLM-Powered)
// ============================================
let currentAIMode='quick';
let aiCache={quick:null,standup:null,risks:null};
let aiCacheTime={quick:0,standup:0,risks:0};
const AI_CACHE_TTL=60000; // 1 minute cache
let aiConversation=[];

function detectQuestionType(question){
  if(!question)return 'general';
  const q=question.toLowerCase();
  
  // LOOKUP: specific part/code/PO searches (highest priority)
  if(/code|item\s*#|part\s*#|sku|pn\s|p\/n|find|search|look\s*up|where\s*is|status\s*of|po\s*\d|po-\d/.test(q))return 'lookup';
  
  // Velocity/speed related
  if(/velocit|speed|pace|accelerat|slow|fast|rate|throughput|transition/.test(q))return 'velocity';
  
  // Bottleneck/stuck related
  if(/bottleneck|stuck|block|wait|delay|held up|holding/.test(q))return 'bottleneck';
  
  // Lead time/supplier related
  if(/lead\s*time|supplier|vendor|delivery|ship|transit|eta|arrival|on-?time/.test(q))return 'leadtime';
  
  // Workload/team related
  if(/workload|team|assign|who|balance|capacity|resource/.test(q))return 'workload';
  
  // Progress/forecast related
  if(/progress|forecast|complete|finish|deadline|schedule|behind|ahead|risk|estimat/.test(q))return 'forecast';
  
  // Specific part/assembly query
  if(/which part|what part|show.*part|list.*part/.test(q))return 'parts';
  
  return 'general';
}

function buildProjectContext(question){
  const parts=getParts();
  const asms=getAsms();
  const now=Date.now(),day=86400000;
  const today=new Date().toISOString().split('T')[0];
  const questionType=detectQuestionType(question);
  
  // Helper: convert timestamp to relative days (negative = past, positive = future)
  const relDays=(ts)=>ts?Math.round((ts-now)/day):null;
  const relDate=(dateStr)=>dateStr?Math.round((Date.parse(dateStr)-now)/day):null;
  
  // Status counts
  const byStatus={};
  STAGES.forEach(s=>byStatus[s]=parts.filter(p=>p.status===s).length);
  
  const totalParts=parts.length;
  const installedParts=byStatus.installed||0;
  const velocity=getVelocity();
  const daysLeft=getDaysRemaining();
  
  // Base context - CRITICAL DATA FIRST (in case of truncation)
  const context={
    // Plain English summary FIRST - most important for AI
    summary:`Project "${currentProjectName}" has ${totalParts} parts across ${asms.length} assemblies. Status: ${byStatus.waiting||0} waiting, ${byStatus['to-order']||0} to-order, ${byStatus.ordered||0} ordered, ${byStatus.arrived||0} arrived, ${byStatus.installed||0} installed. Progress: ${calcOverallProgress()}%.`,
    // Project info
    project:{
      name:currentProjectName,
      pct:calcOverallProgress(),
      vel:velocity,
      left:daysLeft,
      start:projectDates.start,
      end:projectDates.end
    },
    // Counts by status
    cnt:{total:totalParts,...byStatus},
    qType:questionType,
    today,
    // Schema for short keys (after critical data)
    _schema:{
      parts:'id,n=name,s=status,asm=assembly,a=assignee,c=code,m=mfr,po,q=qty,days=daysInStatus,ord=orderedDaysAgo,arr=arrivedDaysAgo,eta=expectedDays,nt=notes,pn=pendingNote,cm=comments',
      asms:'id,n=name,pct=progress%,cnt=partCount,a=assignee,pri=priority',
      timelineConflicts:'person=assignee,asm1=firstAssembly,asm1Dates,asm2=secondAssembly,asm2Dates (overlapping date ranges for same person)',
      milestones:'name,date,type(deadline/delivery/review/custom),daysAway'
    },
    // Company context LAST (nice to have, not critical)
    company:{
      name:'Radar Systems Manufacturing',
      location:'Finland',
      customer:'UK sister company',
      rules:['Safety components need full testing','Parts >â‚¬5k need dual approval','RF parts need cal certs','International +7-10d customs'],
      leadTimes:{stock:'3-7d',standard:'10-14d',custom:'3-4wk',rfSpecialized:'4-6wk'}
    }
  };
  
  // TEAM - always include (small, useful for "who" questions)
  if(team.length){
    context.team=team.map(t=>({n:t.name,e:t.email}));
  }
  
  // LEAD TIME DB - historical data per item code
  if(Object.keys(leadTimeDb).length){
    context.leadTimes={};
    Object.entries(leadTimeDb).forEach(([code,lt])=>{
      context.leadTimes[code]={avg:lt.avg,samples:lt.samples.length};
    });
  }
  
  // HISTORY - include action descriptions (all entries, no nulls)
  if(history.length){
    context.hist=history.map(h=>{
      const entry={d:h.date,p:h.pct};
      if(h.action)entry.a=h.action;
      return entry;
    });
  }
  
  // ALL PARTS - optimized, no nulls, short keys
  // Key: id mod:name s:status asm:assembly a:assignee c:code m:mfr po:poNumber q:qty(if>1)
  //      days:daysInStatus(if>0) ord:orderedAt(rel) arr:arrivedAt(rel) eta:expectedArrival(rel)
  //      n:notes pn:pendingNote cmt:commentCount cm:comments
  context.parts=parts.map(p=>{
    const asm=asms.find(a=>String(a.id)===String(p.parentId));
    const part={id:p.id,n:p.name,s:p.status};
    
    // Only include non-empty, non-default values
    if(asm?.name)part.asm=asm.name;
    if(p.assignee)part.a=p.assignee;
    if(p.code)part.c=p.code;
    if(p.mfr)part.m=p.mfr;
    if(p.poNumber)part.po=p.poNumber;
    if(p.qty&&p.qty>1)part.q=p.qty;
    
    const days=p.changedAt?Math.floor((now-p.changedAt)/day):0;
    if(days>0)part.days=days;
    
    // Relative dates (negative=past, positive=future)
    if(p.orderedAt)part.ord=relDays(p.orderedAt);
    if(p.arrivedAt)part.arr=relDays(p.arrivedAt);
    if(p.expectedArrival)part.eta=relDate(p.expectedArrival);
    
    if(p.notes)part.nt=p.notes;
    if(p.pendingNote)part.pn=p.pendingNote;
    
    // Comments - all of them, not just last 3
    if(p.comments?.length){
      part.cmt=p.comments.length;
      part.cm=p.comments.map(c=>({
        by:c.author||'?',
        t:c.text,
        ago:c.timestamp?Math.floor((now-c.timestamp)/day):null
      }));
    }
    return part;
  });
  
  // ASSEMBLIES - with notes and priority
  context.asms=asms.map(a=>{
    const asmParts=parts.filter(p=>String(p.parentId)===String(a.id));
    const obj={id:a.id,n:a.name,pct:calcAsmProgress(a.id),cnt:asmParts.length};
    if(a.assignee)obj.a=a.assignee;
    if(a.priority)obj.pri=a.priority;
    if(a.notes)obj.nt=a.notes;
    return obj;
  });
  
  // VELOCITY STATS (for velocity/general questions)
  if(questionType==='velocity'||questionType==='general'){
    const recentTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)<14*day);
    const weekAgoCount=recentTransitions.filter(p=>(now-p.changedAt)<=7*day).length;
    const priorWeekCount=recentTransitions.filter(p=>{const d=(now-p.changedAt)/day;return d>7&&d<=14}).length;
    context.vel={
      now:velocity,
      thisWk:weekAgoCount,
      lastWk:priorWeekCount,
      trend:priorWeekCount>0?Math.round((weekAgoCount-priorWeekCount)/priorWeekCount*100):0
    };
  }
  
  // BOTTLENECK STATS (for bottleneck/general questions)
  if(questionType==='bottleneck'||questionType==='general'){
    const stageDwell={};
    STAGES.forEach(s=>{
      const inStage=parts.filter(p=>p.status===s&&p.changedAt);
      if(inStage.length>0){
        const avgDays=Math.round(inStage.reduce((sum,p)=>sum+(now-p.changedAt),0)/inStage.length/day);
        const maxDays=Math.round(Math.max(...inStage.map(p=>(now-p.changedAt)/day)));
        stageDwell[s]={cnt:inStage.length,avg:avgDays,max:maxDays};
      }
    });
    context.dwell=stageDwell;
  }
  
  // LEAD TIME STATS (for leadtime/general questions)
  if(questionType==='leadtime'||questionType==='general'){
    const arrivedWithDates=parts.filter(p=>p.orderedAt&&p.arrivedAt);
    if(arrivedWithDates.length>=2){
      const leadTimes=arrivedWithDates.map(p=>Math.round((p.arrivedAt-p.orderedAt)/day));
      const avgLead=Math.round(leadTimes.reduce((a,b)=>a+b,0)/leadTimes.length);
      
      const mfrPerf={};
      parts.filter(p=>p.mfr).forEach(p=>{
        if(!mfrPerf[p.mfr])mfrPerf[p.mfr]={tot:0,transit:0,leads:[]};
        mfrPerf[p.mfr].tot++;
        if(p.status==='ordered')mfrPerf[p.mfr].transit++;
        if(p.orderedAt&&p.arrivedAt)mfrPerf[p.mfr].leads.push(Math.round((p.arrivedAt-p.orderedAt)/day));
      });
      
      context.lead={
        avg:avgLead,
        byMfr:Object.entries(mfrPerf).map(([m,d])=>({
          m,tot:d.tot,transit:d.transit,
          avg:d.leads.length?Math.round(d.leads.reduce((a,b)=>a+b,0)/d.leads.length):null
        }))
      };
    }
  }
  
  // WORKLOAD STATS (for workload/general questions)  
  if(questionType==='workload'||questionType==='general'){
    const assigneeWork={};
    parts.filter(p=>p.status!=='installed').forEach(p=>{
      const assignee=p.assignee||'Unassigned';
      if(!assigneeWork[assignee])assigneeWork[assignee]={tot:0,by:{}};
      assigneeWork[assignee].tot++;
      assigneeWork[assignee].by[p.status]=(assigneeWork[assignee].by[p.status]||0)+1;
    });
    context.work=Object.entries(assigneeWork)
      .map(([n,d])=>({n,tot:d.tot,by:d.by}))
      .sort((a,b)=>b.tot-a.tot);
  }
  
  // FORECAST STATS (for forecast/general questions)
  if(questionType==='forecast'||questionType==='general'){
    context.forecast=getVelocityForecast();
  }
  
  // TIMELINE CONFLICTS - resource scheduling conflicts
  const timelineConflicts=[];
  const asmWithDates=asms.filter(a=>a.ganttStart||a.ganttEnd).map(a=>{
    const asmParts=parts.filter(p=>String(p.parentId)===String(a.id));
    let startDate=a.ganttStart?new Date(a.ganttStart):null;
    let endDate=a.ganttEnd?new Date(a.ganttEnd):null;
    if(!startDate||!endDate){
      const orderedDates=asmParts.filter(p=>p.orderedAt).map(p=>p.orderedAt);
      const arrivedDates=asmParts.filter(p=>p.arrivedAt).map(p=>p.arrivedAt);
      if(!startDate&&orderedDates.length)startDate=new Date(Math.min(...orderedDates));
      if(!endDate&&arrivedDates.length)endDate=new Date(Math.max(...arrivedDates));
    }
    return {id:a.id,name:a.name,assignee:a.assignee,startDate,endDate};
  }).filter(a=>a.assignee&&a.startDate&&a.endDate);
  
  for(let i=0;i<asmWithDates.length;i++){
    const a=asmWithDates[i];
    for(let j=i+1;j<asmWithDates.length;j++){
      const b=asmWithDates[j];
      if(a.assignee!==b.assignee)continue;
      if(a.startDate<=b.endDate&&a.endDate>=b.startDate){
        timelineConflicts.push({
          person:a.assignee,
          asm1:a.name,
          asm1Dates:formatDateShort(a.startDate)+' - '+formatDateShort(a.endDate),
          asm2:b.name,
          asm2Dates:formatDateShort(b.startDate)+' - '+formatDateShort(b.endDate)
        });
      }
    }
  }
  if(timelineConflicts.length){
    context.timelineConflicts=timelineConflicts;
    context.summary+=` TIMELINE CONFLICTS: ${timelineConflicts.length} resource scheduling conflict(s) detected.`;
  }
  
  // MILESTONES - project milestones
  if(milestones.length){
    context.milestones=milestones.map(m=>({
      name:m.name,
      date:m.date,
      type:m.type,
      daysAway:Math.round((new Date(m.date)-new Date())/(86400000))
    }));
  }
  
  return context;
}

function getDaysRemaining(){
  if(!projectDates.end)return null;
  const end=new Date(projectDates.end);
  const now=new Date();
  return Math.max(0,Math.ceil((end-now)/(86400000)));
}

function getVelocity(){
  // Returns velocity as %/day (consistent with all other velocity metrics)
  if(history.length<2)return null;
  const recent=history.slice(-7);
  if(recent.length<2)return null;
  const days=Math.max(1,(new Date(recent[recent.length-1].date)-new Date(recent[0].date))/(86400000));
  const pctPerDay=(recent[recent.length-1].pct-recent[0].pct)/days;
  return Math.round(pctPerDay*10)/10;
}

async function generateAIReport(mode,question){
  // Use the SAME context builder as the working Opus report
  const context=buildFullProjectContext();
  if(question) context.question=question;
  
  // Quick mode uses local generation (instant, no API call)
  if(mode==='quick'){
    return generateLocalReport(mode,context);
  }
  
  // AI modes use Claude via Cloud Function
  try{
    console.log('Calling Cloud Function for mode:',mode);
    if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML='<span class="thinking-pulse">thinking...</span>';
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const payload={
      mode,
      projectContext:context,
      maxChars:1000,
      style:'concise',
      model:selectedAIModel
    };
    if(question)payload.question=question;
    
    const result=await generateInsights(payload);
    
    // Log model verification
    const requestedModel=selectedAIModel;
    const returnedModel=result.data?.model||'unknown';
    console.log('ðŸ¤– AI Model Verification:');
    console.log('   Requested:', requestedModel);
    console.log('   Returned:', returnedModel);
    console.log('   Match:', requestedModel===returnedModel ? 'âœ… YES' : 'âŒ NO');
    
    if(result.data?.success){
      // Use the RETURNED model from API, not the requested one
      const actualModel=result.data.model||selectedAIModel;
      const modelName=AI_MODELS[actualModel]?.name||actualModel;
      if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML=modelName+' <span style="opacity:0.5">â–¾</span>';
      lastUsedModel=actualModel;
      return formatClaudeResponse(result.data.content,mode,actualModel);
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Cloud function failed:',e);
    if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML='offline <span style="opacity:0.5">â–¾</span>';
    return '<div class="ai-prose"><p>Unable to connect to AI service. Please try again.</p></div>';
  }
}

function formatClaudeResponse(text,mode,usedModel){
  let html=text;
  
  // Check for SVG response - sanitize with DOMPurify
  if(html.trim().startsWith('<svg')){
    if(typeof DOMPurify !== 'undefined') {
      const sanitized = DOMPurify.sanitize(html, {
        USE_PROFILES: { svg: true },
        ADD_TAGS: ['svg'],
        ADD_ATTR: ['viewBox', 'preserveAspectRatio', 'xmlns']
      });
      return '<div class="ai-visual">'+sanitized+'</div>';
    } else {
      // Fallback: strip dangerous content with regex (less secure)
      const sanitized = html
        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
        .replace(/\s*on\w+\s*=\s*["'][^"']*["']/gi, '')
        .replace(/javascript:/gi, '');
      return '<div class="ai-visual">'+sanitized+'</div>';
    }
  }
  
  // Check for structured action response [ACTION:type:param]
  // Validate stage is a known status to prevent injection
  const validStages = ['waiting','ordered','arrived','installed'];
  html=html.replace(/\[ACTION:filter:([^\]]+)\]/g,(match,stage)=>{
    const cleanStage = stage.trim().toLowerCase();
    if(!validStages.includes(cleanStage)) return match; // Don't render invalid stages
    return '<button class="ai-action-btn" onclick="window.aiFilterStage(\''+cleanStage+'\')"><span>Show '+cleanStage.replace('-',' ')+' parts</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>';
  });
  
  // Validate IDs are numeric/alphanumeric only (Firebase push keys are alphanumeric with -)
  html=html.replace(/\[ACTION:highlight:([^\]]+)\]/g,(match,ids)=>{
    const cleanIds = ids.replace(/[^a-zA-Z0-9,\-_]/g, ''); // Strip anything suspicious
    if(!cleanIds) return match;
    return '<button class="ai-action-btn" onclick="window.highlightParts(['+cleanIds.split(',').map(id=>'\''+id.trim()+'\'').join(',')+'])"><span>Highlight these parts</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>';
  });
  
  // Check for mini chart markers [CHART:type:data]
  html=html.replace(/\[CHART:bar:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)||0};
      });
      if(!items.length||items.every(i=>!i.val))return '';
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*40+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 340 '+h+'" style="width:340px;height:'+h+'px;display:block;margin:8px 0">';
      items.forEach((item,i)=>{
        const w=Math.max(Math.round(item.val/max*180),4);
        const y=i*40+10;
        svg+='<text x="8" y="'+(y+24)+'" style="font-size:13px;fill:#9b9991">'+esc(item.label)+'</text>';
        svg+='<rect x="130" y="'+(y+8)+'" width="'+w+'" height="24" rx="6" style="fill:#5a9ac8;opacity:0.75"/>';
        svg+='<text x="'+(140+w)+'" y="'+(y+26)+'" style="font-size:14px;fill:#faf9f5;font-weight:500">'+item.val+'</text>';
      });
      svg+='</svg>';
      return '<div class="ai-visual">'+svg+'</div>';
    }catch(e){console.error('Chart error:',e);return '';}
  });
  
  // Funnel chart for pipeline
  html=html.replace(/\[CHART:funnel:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)||0};
      });
      if(!items.length||items.every(i=>!i.val))return '';
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*44+20;
      const colors=['#c07070','#d87756','#b8a050','#9888aa','#6aa0aa','#6aaa6a'];
      let svg='<svg class="ai-mini-chart" viewBox="0 0 360 '+h+'" style="width:360px;height:'+h+'px;display:block;margin:8px 0">';
      items.forEach((item,i)=>{
        const w=Math.max(Math.round(item.val/max*180),4);
        const x=(180-w)/2+100;
        const y=i*44+10;
        svg+='<text x="8" y="'+(y+26)+'" style="font-size:12px;fill:#9b9991">'+esc(item.label)+'</text>';
        svg+='<rect x="'+x+'" y="'+(y+8)+'" width="'+w+'" height="28" rx="6" style="fill:'+colors[i%6]+';opacity:0.85"/>';
        svg+='<text x="300" y="'+(y+28)+'" style="font-size:14px;fill:#faf9f5;font-weight:600">'+item.val+'</text>';
      });
      svg+='</svg>';
      return '<div class="ai-visual">'+svg+'</div>';
    }catch(e){console.error('Funnel error:',e);return '';}
  });
  
  // Escape HTML first (but preserve our generated HTML)
  const visualParts=[];
  html=html.replace(/<div class="ai-visual">[\s\S]*?<\/div>/g,(match)=>{
    visualParts.push(match);
    return '{{VISUAL'+(visualParts.length-1)+'}}';
  });
  const btnParts=[];
  html=html.replace(/<button class="ai-action-btn"[^>]*>.*?<\/button>/g,(match)=>{
    btnParts.push(match);
    return '{{BTN'+(btnParts.length-1)+'}}';
  });
  
  html=esc(html);
  
  // Restore visual parts
  visualParts.forEach((v,i)=>{html=html.replace('{{VISUAL'+i+'}}',v);});
  btnParts.forEach((b,i)=>{html=html.replace('{{BTN'+i+'}}',b);});
  
  // Replace [[Part Name]] with clickable links
  html=html.replace(/\[\[([^\]]+)\]\]/g,(match,partName)=>{
    // Try exact match first (case-insensitive)
    let part=getParts().find(p=>p.name.toLowerCase()===partName.toLowerCase().trim());
    
    // If no exact match, try partial match (part name contains the linked text or vice versa)
    if(!part){
      const searchName=partName.toLowerCase().trim();
      part=getParts().find(p=>
        p.name.toLowerCase().includes(searchName) || 
        searchName.includes(p.name.toLowerCase())
      );
    }
    
    // If still no match, try matching just the first word
    if(!part){
      const firstWord=partName.toLowerCase().trim().split(/\s+/)[0];
      if(firstWord.length>3){
        part=getParts().find(p=>p.name.toLowerCase().startsWith(firstWord));
      }
    }
    
    if(part){
      return '<a class="ai-part-link" href="#" onclick="window.aiGoToPart(\''+part.id+'\',event);return false;">'+partName+'</a>';
    }
    return partName;
  });
  
  // Replace {{Assembly Name}} with clickable links  
  html=html.replace(/\{\{([^\}]+)\}\}/g,(match,asmName)=>{
    const asm=getAsms().find(a=>a.name.toLowerCase()===asmName.toLowerCase());
    if(asm){
      return '<a class="ai-asm-link" href="#" onclick="window.aiGoToAsm(\''+asm.id+'\');return false;">'+asmName+'</a>';
    }
    return asmName;
  });
  
  // Replace **bold** with <strong>
  html=html.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  
  // Process line by line
  const lines=html.split('\n');
  let result=[];
  let inList=false;
  let listItems=[];
  
  const flushList=()=>{
    if(listItems.length){
      result.push('<ul>'+listItems.map(li=>'<li>'+li+'</li>').join('')+'</ul>');
      listItems=[];
    }
    inList=false;
  };
  
  lines.forEach(line=>{
    const trimmed=line.trim();
    if(!trimmed)return;
    
    // Check for section header (ALL CAPS followed by colon)
    if(/^[A-Z][A-Z\s]+:$/.test(trimmed)){
      flushList();
      result.push('<h4 class="ai-section-header">'+trimmed.replace(':','')+'</h4>');
      return;
    }
    
    // Check for bullet point
    if(/^[â€¢\-\*]\s/.test(trimmed)){
      inList=true;
      listItems.push(trimmed.replace(/^[â€¢\-\*]\s*/,''));
      return;
    }
    
    // Check for numbered item
    if(/^\d+[\.\)]\s/.test(trimmed)){
      inList=true;
      listItems.push(trimmed.replace(/^\d+[\.\)]\s*/,''));
      return;
    }
    
    // Regular text - flush any pending list and add as paragraph
    flushList();
    result.push('<p>'+trimmed+'</p>');
  });
  
  flushList();
  
  // Add model attribution
  const modelAttribution=usedModel?'<div class="ai-model-attribution" title="Response generated by '+usedModel+'">'+( AI_MODELS[usedModel]?.name||usedModel)+'</div>':'';
  
  return '<div class="ai-prose">'+result.join('')+modelAttribution+'</div>';
}

// Navigation functions for AI links
let currentPartInfoId=null;

window.aiGoToPart=function(partId,e){
  if(e)e.preventDefault();
  const part=data.find(d=>String(d.id)===String(partId));
  if(!part)return;
  
  // Minimize console instead of closing (preserves history)
  minimizeCmdWindow();
  closeAIWorkspace();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  
  // Expand parent assembly
  if(part.parentId){
    expanded[String(part.parentId)]=true;
  }
  render();
  
  setTimeout(()=>{
    const row=document.querySelector('[data-part-id="'+partId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.classList.add('ai-highlight');
      setTimeout(()=>row.classList.remove('ai-highlight'),5000);
    }
  },100);
};

window.goToPartFromPopover=function(){
  if(!currentPartInfoId)return;
  const partId=currentPartInfoId;
  $('partInfoPopover').classList.remove('open');
  closeAIWorkspace();
  minimizeCmdWindow();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  const part=data.find(d=>String(d.id)===String(partId));
  if(part&&part.parentId){
    expanded[String(part.parentId)]=true;
  }
  render();
  setTimeout(()=>{
    const row=document.querySelector('[data-part-id="'+partId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.classList.add('ai-highlight');
      setTimeout(()=>row.classList.remove('ai-highlight'),5000);
    }
  },100);
};

// Close part info popover when clicking outside
document.addEventListener('click',e=>{
  const popover=$('partInfoPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.ai-part-link')){
    popover.classList.remove('open');
  }
});

window.highlightParts=function(partIds){
  closeAIWorkspace();
  minimizeCmdWindow();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  // Expand all parent assemblies
  partIds.forEach(id=>{
    const part=data.find(d=>String(d.id)===String(id));
    if(part&&part.parentId)expanded[String(part.parentId)]=true;
  });
  render();
  setTimeout(()=>{
    partIds.forEach((id,i)=>{
      const row=document.querySelector('[data-part-id="'+id+'"]');
      if(row){
        row.classList.add('ai-highlight');
        if(i===0)row.scrollIntoView({behavior:'smooth',block:'center'});
        setTimeout(()=>row.classList.remove('ai-highlight'),5000);
      }
    });
  },100);
};

window.aiGoToAsm=function(asmId){
  closeAIWorkspace();
  minimizeCmdWindow();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  expanded[String(asmId)]=true;
  render();
  setTimeout(()=>{
    // Highlight the assembly row
    const row=document.querySelector('[data-asm-id="'+asmId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.classList.add('ai-highlight');
      setTimeout(()=>row.classList.remove('ai-highlight'),5000);
    }
    // Recursively get all children (parts and sub-parts)
    function getAllChildren(parentId){
      const children=data.filter(d=>!d.isAsm&&!d._deletedAt&&String(d.parentId)===String(parentId));
      let all=[...children];
      children.forEach(c=>{
        all=all.concat(getAllChildren(c.id));
      });
      return all;
    }
    // Highlight all child parts within this assembly
    const allChildren=getAllChildren(asmId);
    allChildren.forEach(p=>{
      const partRow=document.querySelector('[data-part-id="'+p.id+'"]');
      if(partRow){
        partRow.classList.add('ai-highlight');
        setTimeout(()=>partRow.classList.remove('ai-highlight'),5000);
      }
    });
  },100);
};

window.aiFilterStage=function(stage){
  closeAIWorkspace();
  minimizeCmdWindow();
  
  // Handle special filter cases
  if(stage==='stuck'){
    // Show parts stuck more than 5 days
    const stuckIds=getParts().filter(p=>{
      const days=Math.floor((Date.now()-(p.changedAt||Date.now()))/(1000*60*60*24));
      return days>5&&p.status!=='installed';
    }).map(p=>p.id);
    if(stuckIds.length>0){
      highlightParts(stuckIds);
    }else{
      
    }
    return;
  }
  
  filterStage=stage;
  render();
};

// AI Model Selection
let selectedAIModel='claude-sonnet-4-5-20250929';
let lastUsedModel=null;

// Debug helper - call window.checkAIModel() in console to see current model
window.checkAIModel=function(){
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ¤– AI Model Status');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Selected model:', selectedAIModel);
  console.log('Display name:', AI_MODELS[selectedAIModel]?.name || 'unknown');
  console.log('Last used model:', lastUsedModel || 'none yet');
  if(lastUsedModel){
    console.log('Last response from:', AI_MODELS[lastUsedModel]?.name || lastUsedModel);
  }
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  return {selected: selectedAIModel, lastUsed: lastUsedModel};
};
const AI_MODELS={
  'claude-haiku-4-5-20251001':{name:'haiku-4.5',label:'Haiku 4.5'},
  'claude-sonnet-4-5-20250929':{name:'sonnet-4.5',label:'Sonnet 4.5'},
  'claude-opus-4-5-20251101':{name:'opus-4.5',label:'Opus 4.5'}
};

window.toggleModelSelector=function(e){
  e.stopPropagation();
  if($('aiModelDropdown'))$('aiModelDropdown').classList.toggle('open');
};

window.selectAIModel=function(btn){
  const model=btn.dataset.model;
  selectedAIModel=model;
  if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML=AI_MODELS[model].name+' <span style="opacity:0.5">â–¾</span>';
  if($('cmdModelSelect'))$('cmdModelSelect').value=model;
  // Update active state
  document.querySelectorAll('.ai-model-option').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.ai-model-option[data-model="'+model+'"]').forEach(b=>b.classList.add('active'));
  if($('aiModelDropdown'))$('aiModelDropdown').classList.remove('open');
};

window.toggleModelSelectorWs=function(e){
  e.stopPropagation();
  $('aiModelDropdownWs').classList.toggle('open');
};

window.selectAIModelWs=function(btn){
  const model=btn.dataset.model;
  selectedAIModel=model;
  if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML=AI_MODELS[model].name+' <span style="opacity:0.5">â–¾</span>';
  if($('cmdModelSelect'))$('cmdModelSelect').value=model;
  // Update active state in both dropdowns
  document.querySelectorAll('.ai-model-option').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.ai-model-option[data-model="'+model+'"]').forEach(b=>b.classList.add('active'));
  $('aiModelDropdownWs').classList.remove('open');
};

// Close dropdown when clicking outside
document.addEventListener('click',e=>{
  if(!e.target.closest('.ai-model-selector')){
    if($('aiModelDropdown'))$('aiModelDropdown').classList.remove('open');
  }
  if(!e.target.closest('.ai-model-selector-ws')){
    $('aiModelDropdownWs').classList.remove('open');
  }
});

async function askAI(question){
  const partsCheck = getParts();
  if(partsCheck.length === 0) {
    return '<div class="ai-prose"><p><strong>No project data loaded.</strong> Click â˜° â†’ Load Sample Data to get started.</p></div>';
  }
  
  // Use the SAME context builder as the working report
  const context=buildFullProjectContext();
  // Add the question for context
  context.question=question;
  
  console.log('ðŸ¤– askAI context: parts=', context.allParts?.length, 'asms=', context.assemblies?.length);
  
  try{
    if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML='<span class="thinking-pulse">thinking...</span>';
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({
      mode:'ask',
      projectContext:context,
      question,
      maxChars:2000,  // Match the report setting
      style:'concise',
      model:selectedAIModel
    });
    
    // Log model verification
    const requestedModel=selectedAIModel;
    const returnedModel=result.data?.model||'unknown';
    console.log('ðŸ¤– AI Model Verification:');
    console.log('   Requested:', requestedModel);
    console.log('   Returned:', returnedModel);
    console.log('   Match:', requestedModel===returnedModel ? 'âœ… YES' : 'âŒ NO');
    
    if(result.data?.success){
      // Use the RETURNED model from API, not the requested one
      const actualModel=result.data.model||selectedAIModel;
      const modelName=AI_MODELS[actualModel]?.name||actualModel;
      if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML=modelName+' <span style="opacity:0.5">â–¾</span>';
      lastUsedModel=actualModel;
      return formatClaudeResponse(result.data.content,'ask',actualModel);
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Ask failed:',e);
    if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML='offline <span style="opacity:0.5">â–¾</span>';
    return '<div class="ai-prose"><p>Unable to get response. Please try again.</p></div>';
  }
}

function generateLocalReport(mode,ctx){
  const today=new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});
  
  if(mode==='quick'){
    return renderQuickInsights();
  }
  
  if(mode==='standup'){
    let html='<div class="ai-summary"><strong>'+ctx.project.name+'</strong><br>'+today+'<br><br>';
    html+='<strong>'+ctx.project.progress+'%</strong> complete';
    if(ctx.project.daysLeft!==null)html+=' Â· <strong>'+ctx.project.daysLeft+'</strong> days left';
    if(ctx.project.velocity)html+=' Â· <strong>'+ctx.project.velocity+'</strong>%/day';
    html+='</div>';
    
    // Blockers
    if(ctx.overdue.length||ctx.stuck.filter(s=>s.status==='to-order').length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ”´</span> Blockers</div><div class="ai-report-items">';
      ctx.overdue.forEach(a=>{
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(a.task)+'</strong><div class="ai-report-meta">'+a.daysOverdue+' day'+(a.daysOverdue!==1?'s':'')+' overdue Â· '+esc(a.assignee)+'</div></div></div>';
      });
      ctx.stuck.filter(s=>s.status==='to-order').slice(0,3).forEach(p=>{
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(p.name)+'</strong> ready to order<div class="ai-report-meta">'+p.days+' days Â· '+(p.mfr?esc(p.mfr):'No supplier')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Needs Attention
    const arrivedCount=ctx.counts.arrived||0;
    const inTransit=ctx.stuck.filter(s=>s.status==='ordered');
    if(arrivedCount||inTransit.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸŸ¡</span> Needs Attention</div><div class="ai-report-items">';
      if(arrivedCount){
        html+='<div class="ai-report-item warning"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+arrivedCount+' part'+(arrivedCount!==1?'s':'')+' arrived</strong> - awaiting next step</div></div>';
      }
      inTransit.slice(0,3).forEach(p=>{
        html+='<div class="ai-report-item warning"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(p.name)+'</strong> in transit '+p.days+' days<div class="ai-report-meta">'+(p.mfr?esc(p.mfr):'Unknown supplier')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Due Soon
    if(ctx.upcoming.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ“‹</span> Due This Week</div><div class="ai-report-items">';
      ctx.upcoming.slice(0,5).forEach(a=>{
        const dueDate=new Date(a.due).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text">'+esc(a.task)+'<div class="ai-report-meta">'+dueDate+' Â· '+esc(a.assignee)+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Focus
    html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸŽ¯</span> Focus Today</div><div class="ai-report-items">';
    const focuses=[];
    if(ctx.overdue.length)focuses.push('Clear '+ctx.overdue.length+' overdue action'+(ctx.overdue.length!==1?'s':''));
    if(arrivedCount>=3)focuses.push('Process '+arrivedCount+' arrived parts');
    if(ctx.stuck.filter(s=>s.status==='to-order').length>=3)focuses.push('Place orders for stuck parts');
    if(inTransit.length)focuses.push('Follow up on long-transit items');
    if(!focuses.length)focuses.push('Continue steady progress');
    focuses.slice(0,3).forEach((f,i)=>{
      html+='<div class="ai-report-item success"><span class="ai-report-bullet">'+(i+1)+'.</span><div class="ai-report-text">'+f+'</div></div>';
    });
    html+='</div></div>';
    
    return html;
  }
  
  if(mode==='risks'){
    let html='<div class="ai-summary"><strong>Risk Analysis</strong><br>'+ctx.project.name+'<br>'+today+'</div>';
    
    // Schedule Risk
    const forecast=ctx.forecast;
    if(forecast){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ“Š</span> Schedule Risk</div><div class="ai-report-items">';
      if(forecast.status==='at-risk'){
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>Behind Schedule</strong><div class="ai-report-meta">At current velocity, completion '+(forecast.daysToComplete-forecast.daysLeft)+' days late</div></div></div>';
      }else if(forecast.status==='ahead'){
        html+='<div class="ai-report-item success"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>Ahead of Schedule</strong><div class="ai-report-meta">Finishing '+(forecast.daysLeft-forecast.daysToComplete)+' days before deadline</div></div></div>';
      }else{
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>On Track</strong><div class="ai-report-meta">Current velocity matches target</div></div></div>';
      }
      html+='</div></div>';
    }
    
    // Supplier Risks
    const riskySuppliers=ctx.suppliers.filter(s=>s.inTransit>=2);
    if(riskySuppliers.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸšš</span> Supplier Exposure</div><div class="ai-report-items">';
      riskySuppliers.forEach(s=>{
        const level=s.inTransit>=4?'critical':s.inTransit>=2?'warning':'info';
        html+='<div class="ai-report-item '+level+'"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(s.mfr)+'</strong><div class="ai-report-meta">'+s.inTransit+' parts in transit'+(s.avgLead?' Â· avg '+s.avgLead+'d lead time':'')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Assembly Risks (lowest progress)
    const atRiskAsms=ctx.asmProgress.filter(a=>a.progress<40);
    if(atRiskAsms.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">âš ï¸</span> Assemblies Behind</div><div class="ai-report-items">';
      atRiskAsms.slice(0,5).forEach(a=>{
        const level=a.progress<20?'critical':a.progress<40?'warning':'info';
        html+='<div class="ai-report-item '+level+'"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(a.name)+'</strong><div class="ai-report-meta">'+a.progress+'% complete Â· '+a.parts+' parts</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Recent Comments (may indicate issues)
    if(ctx.recentComments.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ’¬</span> Recent Notes</div><div class="ai-report-items">';
      ctx.recentComments.slice(0,5).forEach(c=>{
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text">"'+esc(c.text.slice(0,100))+(c.text.length>100?'...':'')+'"<div class="ai-report-meta">'+esc(c.partName)+' Â· '+c.date+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Mitigations
    html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ›¡ï¸</span> Recommended Actions</div><div class="ai-report-items">';
    const mitigations=[];
    if(ctx.overdue.length)mitigations.push('Clear overdue actions to unblock progress');
    if(riskySuppliers.length)mitigations.push('Contact '+riskySuppliers[0].mfr+' for delivery status');
    if(atRiskAsms.length)mitigations.push('Prioritize '+atRiskAsms[0].name+' assembly');
    if(ctx.counts['waiting']>10)mitigations.push('Reduce ordering backlog ('+ctx.counts['waiting']+' pending)');
    if(!mitigations.length)mitigations.push('Continue monitoring - no critical actions needed');
    mitigations.slice(0,4).forEach((m,i)=>{
      html+='<div class="ai-report-item success"><span class="ai-report-bullet">'+(i+1)+'.</span><div class="ai-report-text">'+m+'</div></div>';
    });
    html+='</div></div>';
    
    return html;
  }
  
  return '<div class="ai-error"><div class="ai-error-icon">â“</div><div class="ai-error-msg">Unknown report mode</div></div>';
}

function renderQuickInsights(){
  const insights=window._aiInsights||generateAIInsights();
  return insights.map((ins,i)=>'<div class="ai-insight '+ins.level+'" data-idx="'+i+'"><div class="ai-insight-icon">'+ins.icon+'</div><div class="ai-insight-content"><div class="ai-insight-title">'+ins.title+'</div><div class="ai-insight-desc">'+ins.desc+'</div>'+(ins.action?'<div class="ai-insight-action">'+ins.action+'</div>':'')+'</div></div>').join('');
}

let aiWorkspaceOpen=false;
let aiWorkspaceConversation=[];

function toggleAIWorkspace(){
  if(aiWorkspaceOpen){
    closeAIWorkspace();
  }else{
    openAIWorkspace();
  }
}

function openAIWorkspace(){
  aiWorkspaceOpen=true;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  $('aiWorkspace').classList.add('active');
  const btn=$('aiAlert');
  btn.classList.remove('decelerating');
  btn.classList.add('active');
  // After acceleration animation (2s), switch to fast spinning dot
  setTimeout(()=>{
    if(aiWorkspaceOpen)btn.classList.add('spinning');
  },1950);
  renderWorkspaceConversation();
  $('aiWorkspaceQuestion').focus();
}

function closeAIWorkspace(){
  if(!aiWorkspaceOpen)return;
  aiWorkspaceOpen=false;
  $('aiWorkspace').classList.remove('active');
  const btn=$('aiAlert');
  btn.classList.remove('active','spinning');
  btn.classList.add('decelerating');
  // Remove decelerating class after animation completes
  setTimeout(()=>{
    btn.classList.remove('decelerating');
  },2000);
  const activeTab=document.querySelector('.tab.active')||document.querySelector('[data-tab="list"]');
  if(activeTab){
    activeTab.classList.add('active');
    $(activeTab.dataset.tab+'Panel').classList.add('active');
  }else{
    document.querySelector('[data-tab="list"]').classList.add('active');
    $('listPanel').classList.add('active');
  }
}

function renderWorkspaceConversation(){
  const container=$('aiWorkspaceConversation');
  if(aiWorkspaceConversation.length===0){
    // Show insights dashboard when empty
    const insights=generateInsights();
    let html='<div class="ai-workspace-conversation-inner">';
    html+='<div class="ai-welcome-minimal">What would you like to know?</div>';
    if(insights.length>0){
      html+='<div class="ai-welcome-insights">';
      insights.slice(0,4).forEach(ins=>{
        html+='<div class="ai-welcome-insight '+ins.level+'" data-question="'+escapeAttr(ins.question||ins.title)+'">';
        html+='<span class="ai-welcome-insight-icon">'+ins.icon+'</span>';
        html+='<div class="ai-welcome-insight-text">';
        html+='<div class="ai-welcome-insight-title">'+esc(ins.title)+'</div>';
        html+='<div class="ai-welcome-insight-desc">'+esc(ins.desc)+'</div>';
        html+='</div>';
        html+='</div>';
      });
      html+='</div>';
    }
    html+='<div class="ai-welcome-suggestions">';
    html+='<button class="ai-suggest-btn" data-q="What\'s blocking progress?">What\'s blocking progress?</button>';
    html+='<button class="ai-suggest-btn" data-q="Which parts need attention?">Parts needing attention</button>';
    html+='<button class="ai-suggest-btn" data-q="Summarize supplier performance">Supplier performance</button>';
    html+='<button class="ai-suggest-btn" data-q="What should I focus on today?">Today\'s priorities</button>';
    html+='</div>';
    html+='</div>';
    container.innerHTML=html;
    // Bind click handlers
    container.querySelectorAll('.ai-welcome-insight').forEach(el=>{
      el.onclick=()=>{
        const q=el.dataset.question;
        if(q){$('aiWorkspaceQuestion').value=q;handleWorkspaceAsk();}
      };
    });
    container.querySelectorAll('.ai-suggest-btn').forEach(btn=>{
      btn.onclick=()=>{
        const q=btn.dataset.q;
        if(q){$('aiWorkspaceQuestion').value=q;handleWorkspaceAsk();}
      };
    });
    return;
  }
  let html='<div class="ai-workspace-conversation-inner">';
  html+=aiWorkspaceConversation.map(msg=>{
    if(msg.role==='user'){
      return '<div class="ai-msg ai-msg-user"><div class="ai-msg-content">'+esc(msg.content)+'</div></div>';
    }else{
      if(msg.isThinking){
        return '<div class="ai-msg ai-msg-assistant ai-msg-thinking">'+msg.content+'</div>';
      }
      // Sanitize AI response HTML with DOMPurify
      const sanitized = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(msg.content, {
        ALLOWED_TAGS: ['p','br','strong','em','ul','ol','li','h1','h2','h3','h4','div','span','a','table','thead','tbody','tr','th','td','code','pre','button','svg','path','line','polyline','rect','circle','text','tspan','g'],
        ALLOWED_ATTR: ['class','style','href','onclick','data-q','data-question','viewBox','width','height','fill','stroke','stroke-width','stroke-linecap','stroke-linejoin','d','x','y','x1','y1','x2','y2','cx','cy','r','rx','ry','points','font-size','font-weight','opacity','transform'],
        ALLOW_DATA_ATTR: true
      }) : msg.content;
      return '<div class="ai-msg ai-msg-assistant"><div class="ai-msg-content">'+sanitized+'</div></div>';
    }
  }).join('');
  html+='</div>';
  container.innerHTML=html;
  container.scrollTop=container.scrollHeight;
}

function escapeAttr(str){return str.replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

function generateInsights(){
  const parts=data.filter(d=>!d.isAsm&&!d._deletedAt);
  const total=parts.length;
  if(total===0)return [];
  
  const insights=[];
  const now=Date.now();
  const day=86400000;
  
  // Stuck parts
  const stuckParts=parts.filter(p=>p.status!=='installed'&&p.changedAt&&(now-p.changedAt)>5*day);
  if(stuckParts.length>0){
    insights.push({level:'warning',icon:'â³',title:stuckParts.length+' parts stuck >5 days',desc:stuckParts.slice(0,2).map(p=>p.name).join(', '),question:'Which parts are stuck and why?'});
  }
  
  // Progress
  const installed=parts.filter(p=>p.status==='installed').length;
  const pct=Math.round(installed/total*100);
  if(pct<50){
    insights.push({level:'info',icon:'ðŸ“Š',title:pct+'% complete',desc:'Progress update',question:'How is the project progressing?'});
  }
  
  // Ready to install
  const readyToInstall=parts.filter(p=>p.status==='arrived');
  if(readyToInstall.length>0){
    insights.push({level:'success',icon:'âœ“',title:readyToInstall.length+' ready to install',desc:readyToInstall.slice(0,2).map(p=>p.name).join(', '),question:'Which parts are ready to install?'});
  }
  
  // Workload
  const assignees={};
  parts.forEach(p=>{if(p.assignee)assignees[p.assignee]=(assignees[p.assignee]||0)+1;});
  const sorted=Object.entries(assignees).sort((a,b)=>b[1]-a[1]);
  if(sorted.length>0&&sorted[0][1]>total*0.5){
    insights.push({level:'warning',icon:'ðŸ‘¤',title:sorted[0][0]+' has '+sorted[0][1]+' parts',desc:'Workload may be unbalanced',question:'How is workload distributed across the team?'});
  }
  
  // In transit
  const inTransit=parts.filter(p=>p.status==='ordered');
  if(inTransit.length>5){
    insights.push({level:'info',icon:'ðŸ“¦',title:inTransit.length+' parts in transit',desc:'Awaiting delivery',question:'Which parts are in transit and when will they arrive?'});
  }
  
  return insights;
}

const AI_THINKING_ICON='<div class="ai-thinking-orb"><div class="ai-thinking-plus"></div></div>';

async function handleWorkspaceAsk(){
  const input=$('aiWorkspaceQuestion');
  const question=input.value.trim();
  if(!question)return;
  
  aiWorkspaceConversation.push({role:'user',content:esc(question)});
  renderWorkspaceConversation();
  input.value='';
  input.style.height='auto';
  
  aiWorkspaceConversation.push({role:'assistant',content:AI_THINKING_ICON,isThinking:true});
  renderWorkspaceConversation();
  
  const response=await askAI(question);
  
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'');
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].isThinking=false;
  renderWorkspaceConversation();
}

async function handleWorkspaceTell(){
  aiWorkspaceConversation.push({role:'user',content:'Tell me about the project status'});
  renderWorkspaceConversation();
  
  aiWorkspaceConversation.push({role:'assistant',content:AI_THINKING_ICON,isThinking:true});
  renderWorkspaceConversation();
  
  const response=await generateAIReport('straight');
  
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'');
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].isThinking=false;
  renderWorkspaceConversation();
}

function openAIModal(){
  showPopoverModal($('aiModal'),$('aiAlert'));
  if(aiConversation.length===0){
    if($('aiContent'))$('aiContent').innerHTML=renderAIDashboard();
  }else{
    renderConversation();
  }
  if($('aiQuestion'))$('aiQuestion').focus();
}

function renderAIDashboard(){
  const parts=data.filter(d=>!d.isAsm&&!d._deletedAt);
  const asms=data.filter(d=>d.isAsm&&!d._deletedAt);
  const total=parts.length;
  if(total===0)return '<div class="ai-welcome"><p>No parts in this project yet. Add assemblies and parts to see analysis.</p></div>';
  
  const now=Date.now();
  const day=86400000;
  const week=7*day;
  
  // Calculate stage transitions for velocity
  const recentTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)<week).length;
  const olderTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)>=week&&(now-p.changedAt)<2*week).length;
  const velocityTrend=olderTransitions>0?Math.round((recentTransitions-olderTransitions)/olderTransitions*100):0;
  const velocityDir=velocityTrend>10?'accelerating':velocityTrend<-10?'slowing':'steady';
  
  // Bottleneck detection - find stage with longest average dwell time
  const stages=['waiting','to-order','ordered','arrived','installed'];
  const stageLabels={'waiting':'Waiting','to-order':'To Order','ordered':'Ordered','arrived':'Arrived','installed':'Installed'};
  const stageDwellTimes={};
  stages.forEach(s=>{
    const inStage=parts.filter(p=>p.status===s&&p.changedAt);
    if(inStage.length>0){
      const avgDwell=inStage.reduce((sum,p)=>sum+(now-p.changedAt),0)/inStage.length/day;
      stageDwellTimes[s]={avg:avgDwell,count:inStage.length};
    }
  });
  let bottleneck=null,maxDwell=0;
  Object.entries(stageDwellTimes).forEach(([stage,data])=>{
    if(stage!=='installed'&&data.avg>maxDwell&&data.count>=2){
      maxDwell=data.avg;bottleneck=stage;
    }
  });
  
  // Lead time analysis (order to arrival)
  const completedOrders=parts.filter(p=>p.orderedAt&&p.arrivedAt);
  let avgLeadTime=0,leadTimeVariance=0;
  if(completedOrders.length>=2){
    const leadTimes=completedOrders.map(p=>(p.arrivedAt-p.orderedAt)/day);
    avgLeadTime=Math.round(leadTimes.reduce((a,b)=>a+b,0)/leadTimes.length);
    const mean=avgLeadTime;
    leadTimeVariance=Math.round(Math.sqrt(leadTimes.reduce((sum,lt)=>sum+Math.pow(lt-mean,2),0)/leadTimes.length));
  }
  
  // Workload imbalance
  const assignees={};
  parts.filter(p=>p.assignee&&p.status!=='installed').forEach(p=>{
    assignees[p.assignee]=(assignees[p.assignee]||0)+1;
  });
  const assigneeList=Object.entries(assignees).sort((a,b)=>b[1]-a[1]);
  const maxWorkload=assigneeList[0]?assigneeList[0][1]:0;
  const minWorkload=assigneeList.length>1?assigneeList[assigneeList.length-1][1]:maxWorkload;
  const workloadImbalance=maxWorkload>0?(maxWorkload-minWorkload)/maxWorkload:0;
  
  // Stalled items (no change in 7+ days, not installed)
  const stalledParts=parts.filter(p=>p.status!=='installed'&&p.changedAt&&(now-p.changedAt)>week);
  
  // Arriving soon accuracy (parts that arrived vs their ETA)
  const arrivedWithEta=parts.filter(p=>p.arrivedAt&&p.expectedArrival);
  let onTimeRate=null,avgDelay=0;
  if(arrivedWithEta.length>=3){
    const onTime=arrivedWithEta.filter(p=>p.arrivedAt<=new Date(p.expectedArrival).getTime()+day);
    onTimeRate=Math.round(onTime.length/arrivedWithEta.length*100);
    avgDelay=Math.round(arrivedWithEta.reduce((sum,p)=>{
      const expected=new Date(p.expectedArrival).getTime();
      return sum+(p.arrivedAt-expected)/day;
    },0)/arrivedWithEta.length);
  }
  
  // Completion forecast based on velocity
  const installed=parts.filter(p=>p.status==='installed').length;
  const remaining=total-installed;
  const dailyVelocity=recentTransitions/7;
  const daysToComplete=dailyVelocity>0?Math.ceil(remaining/dailyVelocity):null;
  
  // Risk score (0-100)
  let riskScore=0;
  if(stalledParts.length>total*0.2)riskScore+=30;
  else if(stalledParts.length>total*0.1)riskScore+=15;
  if(velocityDir==='slowing')riskScore+=20;
  if(bottleneck&&maxDwell>5)riskScore+=25;
  else if(bottleneck&&maxDwell>3)riskScore+=10;
  if(onTimeRate!==null&&onTimeRate<70)riskScore+=25;
  else if(onTimeRate!==null&&onTimeRate<85)riskScore+=10;
  
  // Build insights array
  const insights=[];
  
  // Velocity insight
  if(recentTransitions>0||olderTransitions>0){
    const velIcon=velocityDir==='accelerating'?'â†‘':velocityDir==='slowing'?'â†“':'â†’';
    const velClass=velocityDir==='accelerating'?'positive':velocityDir==='slowing'?'negative':'neutral';
    insights.push({
      icon:velIcon,
      cls:velClass,
      title:'Velocity '+velocityDir,
      detail:recentTransitions+' transitions this week'+(velocityTrend!==0?' ('+(velocityTrend>0?'+':'')+velocityTrend+'%)':''),
      prompt:'Velocity is '+velocityDir+'. One cause, one fix. Max 2 sentences.'
    });
  }
  
  // Bottleneck insight
  if(bottleneck&&maxDwell>2){
    insights.push({
      icon:'âŠ˜',
      cls:'warning',
      title:'Bottleneck: '+stageLabels[bottleneck],
      detail:stageDwellTimes[bottleneck].count+' parts stuck avg '+Math.round(maxDwell)+'d',
      prompt:'Bottleneck at '+stageLabels[bottleneck]+' ('+stageDwellTimes[bottleneck].count+' parts, '+Math.round(maxDwell)+'d avg). Root cause and action. Show [ACTION:filter:'+bottleneck+'] button.'
    });
  }
  
  // Lead time insight
  if(avgLeadTime>0){
    const reliability=leadTimeVariance<avgLeadTime*0.3?'consistent':'variable';
    insights.push({
      icon:'â—·',
      cls:reliability==='consistent'?'neutral':'warning',
      title:'Lead time: '+avgLeadTime+'d avg',
      detail:'Â±'+leadTimeVariance+'d variance ('+reliability+')',
      prompt:'Lead time '+avgLeadTime+'d Â±'+leadTimeVariance+'d. What buffer to add? One number answer with brief reason.'
    });
  }
  
  // Forecast insight
  if(daysToComplete!==null&&remaining>0){
    const forecastDate=new Date(now+daysToComplete*day);
    const dateStr=forecastDate.getDate()+'/'+(forecastDate.getMonth()+1);
    insights.push({
      icon:'â—Ž',
      cls:daysToComplete>30?'warning':'neutral',
      title:'Forecasted finish: '+dateStr,
      detail:daysToComplete+' days at current velocity ('+remaining+' remaining)',
      prompt:'Completion forecast: '+daysToComplete+' days, '+remaining+' parts left. Top risk to this date? One sentence.'
    });
  }
  
  // Stalled items insight
  if(stalledParts.length>0){
    const pct=Math.round(stalledParts.length/total*100);
    const stalledIds=stalledParts.slice(0,5).map(p=>p.id).join(',');
    insights.push({
      icon:'â—¼',
      cls:pct>20?'negative':'warning',
      title:stalledParts.length+' stalled parts ('+pct+'%)',
      detail:'No movement in 7+ days',
      prompt:stalledParts.length+' parts stalled 7+ days. Pattern or common cause? Include [ACTION:highlight:'+stalledIds+'] to show them.'
    });
  }
  
  // On-time delivery insight
  if(onTimeRate!==null){
    insights.push({
      icon:'â—‡',
      cls:onTimeRate>=85?'positive':onTimeRate>=70?'warning':'negative',
      title:'On-time delivery: '+onTimeRate+'%',
      detail:avgDelay>0?'Avg '+Math.round(avgDelay)+'d late':'Avg '+Math.abs(Math.round(avgDelay))+'d early',
      prompt:'Supplier OTD '+onTimeRate+'%. '+(avgDelay>0?'Avg '+Math.round(avgDelay)+'d late.':'')+' Should I add buffer? Yes/no + days.'
    });
  }
  
  // Workload imbalance insight
  if(assigneeList.length>=2&&workloadImbalance>0.4){
    insights.push({
      icon:'âš–',
      cls:'warning',
      title:'Workload imbalance',
      detail:assigneeList[0][0]+' has '+assigneeList[0][1]+' items vs '+assigneeList[assigneeList.length-1][1]+' for '+assigneeList[assigneeList.length-1][0],
      prompt:'Workload: '+assigneeList[0][0]+'='+assigneeList[0][1]+', '+assigneeList[assigneeList.length-1][0]+'='+assigneeList[assigneeList.length-1][1]+'. Rebalance suggestion in one sentence.'
    });
  }
  
  // Risk score insight
  if(insights.length>0){
    const riskLabel=riskScore>=50?'High':riskScore>=25?'Moderate':'Low';
    const riskCls=riskScore>=50?'negative':riskScore>=25?'warning':'positive';
    insights.unshift({
      icon:'â—',
      cls:riskCls,
      title:'Risk level: '+riskLabel,
      detail:'Score: '+riskScore+'/100 based on '+insights.length+' factors',
      prompt:'Risk score '+riskScore+'/100. Top 3 risks as bullet points, max 5 words each.'
    });
  }
  
  // Build HTML
  let html='<div class="ai-dashboard">';
  
  if(insights.length===0){
    html+='<div class="ai-welcome"><p>Not enough data yet for analysis. As parts move through stages, insights will appear here.</p></div>';
  }else{
    html+='<div class="ai-insights-list">';
    insights.forEach((ins,idx)=>{
      html+='<div class="ai-insight-card '+ins.cls+'" data-prompt-idx="'+idx+'">';
      html+='<div class="ai-insight-icon">'+ins.icon+'</div>';
      html+='<div class="ai-insight-body"><div class="ai-insight-title">'+esc(ins.title)+'</div>';
      html+='<div class="ai-insight-detail">'+esc(ins.detail)+'</div></div>';
      html+='<div class="ai-insight-arrow">â†’</div></div>';
    });
    html+='</div>';
    html+='<div class="ai-dashboard-hint">Click any insight to explore with AI</div>';
  }
  
  html+='</div>';
  
  // Store prompts globally for click handlers
  window._aiPrompts=insights.map(i=>i.prompt);
  
  // Add click handlers after render
  setTimeout(()=>{
    document.querySelectorAll('.ai-insight-card[data-prompt-idx]').forEach(card=>{
      card.onclick=()=>{
        const idx=parseInt(card.dataset.promptIdx);
        if(window._aiPrompts&&window._aiPrompts[idx]){
          askAIQuestion(window._aiPrompts[idx]);
        }
      };
    });
  },0);
  
  return html;
}

function askAIQuestion(prompt){
  $('aiQuestion').value=prompt;
  handleAskSubmit();
}
window.askAIQuestion=askAIQuestion;

function renderConversation(){
  let html='<div class="ai-conversation">';
  aiConversation.forEach(msg=>{
    if(msg.role==='user'){
      html+='<div class="ai-message user"><span class="ai-user-label">You:</span> '+msg.content+'</div>';
    }else{
      // Sanitize AI response HTML with DOMPurify
      const sanitized = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(msg.content, {
        ALLOWED_TAGS: ['p','br','strong','em','ul','ol','li','h1','h2','h3','h4','div','span','a','table','thead','tbody','tr','th','td','code','pre','button','svg','path','line','polyline','rect','circle','text','tspan','g'],
        ALLOWED_ATTR: ['class','style','href','onclick','data-q','data-question','viewBox','width','height','fill','stroke','stroke-width','stroke-linecap','stroke-linejoin','d','x','y','x1','y1','x2','y2','cx','cy','r','rx','ry','points','font-size','font-weight','opacity','transform'],
        ALLOW_DATA_ATTR: true
      }) : msg.content;
      html+='<div class="ai-message assistant">'+sanitized+'</div>';
    }
  });
  html+='</div>';
  $('aiContent').innerHTML=html;
  // Scroll to bottom
  const content=$('aiContent');
  content.scrollTop=content.scrollHeight;
}

async function handleAskSubmit(){
  const input=$('aiQuestion');
  const question=input.value.trim();
  if(!question)return;
  
  // Add user message
  aiConversation.push({role:'user',content:esc(question)});
  renderConversation();
  input.value='';
  
  // Add loading indicator
  aiConversation.push({role:'assistant',content:'<span class="ai-loading-text">Thinking...</span>'});
  renderConversation();
  
  // Get AI response
  const response=await askAI(question);
  
  // Replace loading with actual response - preserve paragraph breaks
  aiConversation[aiConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'').replace(/<\/p>\s*<p>/g,'</p><p>');
  renderConversation();
}

async function handleStraight(){
  // Add system indicator
  aiConversation.push({role:'user',content:'Tell me'});
  renderConversation();
  
  // Add loading indicator
  aiConversation.push({role:'assistant',content:'<span class="ai-loading-text">Analyzing...</span>'});
  renderConversation();
  
  // Get AI response
  const response=await generateAIReport('straight');
  
  // Replace loading with actual response - preserve paragraph breaks
  aiConversation[aiConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'').replace(/<\/p>\s*<p>/g,'</p><p>');
  renderConversation();
}

function bindQuickInsightHandlers(){
  const insights=window._aiInsights||[];
  document.querySelectorAll('.ai-insight').forEach(el=>{
    const idx=parseInt(el.dataset.idx);
    const ins=insights[idx];
    if(ins&&ins.handler)el.onclick=ins.handler;
  });
}

function renderLeadTimeModal(){const codes=Object.keys(leadTimeDb).sort();if(!codes.length){$('ltBody').innerHTML='<p style="color:var(--text3);text-align:center;padding:20px">No lead time data yet.</p>';return}$('ltBody').innerHTML=codes.map(code=>{const lt=leadTimeDb[code];return'<div class="lt-item"><div class="lt-code">'+esc(code)+'</div><div class="lt-stats"><span class="lt-stat-val">'+lt.avg+'d</span><span style="color:var(--text2);margin-left:8px">avg lead time</span><span class="lt-samples" style="margin-left:auto">'+lt.samples.length+' sample'+(lt.samples.length!==1?'s':'')+'</span></div></div>'}).join('')}

function openEtaModal(partId,e){const part=data.find(d=>String(d.id)===String(partId));if(!part)return;editEtaPartId=partId;$('etaPartName').textContent=part.name;$('etaCode').textContent=part.code?'Item Code: '+part.code:'No item code set';const lt=getLeadTimeHistory(part.code);let histHtml='<div class="eta-popover-history-title">Historical Data</div>';if(lt&&lt.samples.length){histHtml+=lt.samples.slice(-5).reverse().map(s=>'<div class="eta-popover-history-item"><span>'+s.date+'</span><span>'+s.days+' days</span></div>').join('');histHtml+='<div class="eta-popover-avg"><span>Average</span><span>'+lt.avg+' days</span></div>'}else{histHtml+='<div class="eta-popover-history-empty">No historical data</div>'}$('etaHistory').innerHTML=histHtml;$('etaDateInput').value=part.expectedArrival||'';const popover=$('etaPopover');if(e){const rect=e.target.getBoundingClientRect();popover.style.visibility='hidden';popover.classList.add('open');const popoverHeight=popover.offsetHeight||280;const popoverWidth=popover.offsetWidth||320;popover.classList.remove('open');popover.style.visibility='';let top=rect.bottom+8;if(top+popoverHeight>window.innerHeight-20){top=rect.top-popoverHeight-8;if(top<20)top=20}let left=rect.left;if(left+popoverWidth>window.innerWidth-20){left=window.innerWidth-popoverWidth-20}if(left<20)left=20;popover.style.top=top+'px';popover.style.left=left+'px'}closeAllPopovers();popover.classList.add('open')}
window.openEtaModal=openEtaModal;

function updateSelects(){const opts='<option value="">â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');$('pmAssignee').innerHTML=opts;$('amAssignee').innerHTML=opts;$('assigneeFilter').innerHTML='<option value="">All</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');if(filterAssignee)$('assigneeFilter').value=filterAssignee}
function updateExpandToggle(){const btn=$('expandToggle');if(!btn)return;const asms=getAsms();const expandedCount=asms.filter(a=>expanded[String(a.id)]).length;allExpanded=expandedCount>asms.length/2;btn.innerHTML=allExpanded?'<span class="arrow">â–²</span> Collapse':'<span class="arrow">â–¼</span> Expand';btn.title=allExpanded?'Collapse all assemblies':'Expand all assemblies';btn.classList.toggle('expanded',allExpanded)}

function renderTeamList(){$('teamList').innerHTML=!team.length?'<p style="color:var(--text3);text-align:center;padding:12px;font-size:10px">No team members</p>':team.map((t,i)=>'<div class="team-item"><div class="team-item-info"><div style="font-weight:600">'+esc(t.name)+'</div><div style="font-size:10px;color:var(--text3)">'+esc(t.email)+'</div></div><button class="team-item-del" onclick="window.delTeam('+i+',event)">Ã—</button></div>').join('')}
function renderBomList(){if(!savedBoms.length){$('bomList').innerHTML='<p style="color:var(--text3);text-align:center;padding:20px">No saved specifications</p>';return}$('bomList').innerHTML=savedBoms.map(b=>'<div class="bom-item" onclick="window.loadBom(\''+b.id+'\')"><div class="bom-item-info"><div class="bom-item-name">'+esc(b.name)+'</div><div class="bom-item-meta">'+b.items.filter(i=>i.isAsm).length+' asm, '+b.items.filter(i=>!i.isAsm).length+' parts</div></div><button class="bom-item-del" onclick="event.stopPropagation();window.delBom(\''+b.id+'\',event)">Ã—</button></div>').join('')}

window.toggleAsmRow=function(e,id){if(e.target.closest('.asm-actions')||e.target.closest('.cell')||e.target.closest('.asm-priority'))return;expanded[String(id)]=!expanded[String(id)];saveExpanded();render()};
window.moveAsmUp=function(id){
  const asms=getAsms();
  const idx=asms.findIndex(a=>String(a.id)===String(id));
  if(idx<=0)return;
  const current=asms[idx],prev=asms[idx-1];
  const tempPriority=current.priority;
  current.priority=prev.priority;
  prev.priority=tempPriority;
  save();render();
};
window.moveAsmDown=function(id){
  const asms=getAsms();
  const idx=asms.findIndex(a=>String(a.id)===String(id));
  if(idx<0||idx>=asms.length-1)return;
  const current=asms[idx],next=asms[idx+1];
  const tempPriority=current.priority;
  current.priority=next.priority;
  next.priority=tempPriority;
  save();render();
};
window.addNewAsm=function(){const id=generateId(),asms=getAsms();const maxP=asms.length?Math.max(...asms.map(a=>a.priority||0)):0;data.push({id,name:'New Assembly',isAsm:true,assignee:'',priority:maxP+1});expanded[String(id)]=true;dirtyAsms.add(id);logActivity('assembly','Added assembly "New Assembly"',{partId:id,partName:'New Assembly'});save();render();setTimeout(()=>{editAsmId=id;$('amTitle').textContent='Edit Assembly';$('amName').value='New Assembly';$('amAssignee').value='';$('amNotes').value='';$('amNotify').disabled=true;showPopoverModal($('asmModal'),null);$('amName').select()},50)};
window.addNewAssembly=window.addNewAsm; // Alias for empty state button
window.addNewPart=function(parentId){const id=generateId();data.push({id,name:'New Part',code:'',mfr:'',qty:1,assignee:'',parentId:String(parentId),status:'waiting',changedAt:Date.now(),_fieldTs:{}});const serverTime=getServerAlignedTime();['name','status','parentId'].forEach(f=>data[data.length-1]._fieldTs[f]=serverTime);dirtyParts.add(id);expanded[String(parentId)]=true;logActivity('part_add','Added part "New Part"',{partId:id,partName:'New Part'});save();highlightPartId=id;render();setTimeout(()=>{const row=document.querySelector('[data-part-id="'+id+'"] .cell');if(row)row.click()},50)};
window.addSubPart=function(parentPartId,e){if(e)e.stopPropagation();const parentPart=data.find(d=>String(d.id)===String(parentPartId));if(!parentPart)return;const id=generateId();data.push({id,name:'New Sub-Part',code:'',mfr:'',qty:1,assignee:parentPart.assignee||'',parentId:parentPartId,status:'waiting',changedAt:Date.now()});dirtyParts.add(id);logActivity('part_add','Added part "New Sub-Part"',{partId:id,partName:'New Sub-Part'});save();highlightPartId=id;render();setTimeout(()=>{const nameCell=document.querySelector('[data-part-id="'+id+'"] .part-name-cell .cell');if(nameCell){nameCell.click();setTimeout(()=>{const input=nameCell.querySelector('input');if(input)input.select()},10)}},50)};

window.toggleMetricsPopover=function(e){
  e.stopPropagation();
  const popover=$('metricsPopover');
  const isOpen=popover.classList.contains('open');
  if(isOpen){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
    return;
  }
  updateMetricsPopover();
  const btn=$('headerMetrics');
  const rect=btn.getBoundingClientRect();
  popover.style.top=(rect.bottom+8)+'px';
  popover.style.right=(window.innerWidth-rect.right)+'px';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>{
    const closeHandler=(ev)=>{
      if(!popover.contains(ev.target)&&!btn.contains(ev.target)){
        popover.classList.remove('open');
        $('popoverBackdrop').classList.remove('active');
        document.removeEventListener('click',closeHandler);
      }
    };
    document.addEventListener('click',closeHandler);
  },0);
};

function updateMetricsPopover(){
  const daysLeft=getDaysLeft(),pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast(),otd=calcSupplierOTD(),avgLead=calcAvgLeadTime();
  const parts=getParts();
  const inTransit=parts.filter(p=>p.status==='ordered').length;
  const toOrder=parts.filter(p=>p.status==='to-order').length;
  
  // Set deadline label on progress chart
  if(projectDates.end){
    $('mpDeadlineLabel').textContent='Deadline: '+formatDateShort(projectDates.end);
  }else{
    $('mpDeadlineLabel').textContent='';
  }
  
  // Velocity forecast
  let forecastHtml='';
  if(forecast&&forecast.estDate&&forecast.rate>0){
    let label='on time',labelColor='var(--text2)';
    const deadlineDate=projectDates.end?formatDateShort(projectDates.end):'â€”';
    if(forecast.daysLeft!==null&&forecast.daysToComplete!==null){
      const diff=forecast.daysLeft-forecast.daysToComplete;
      if(diff>0){label=diff+' days early';labelColor='var(--green)'}
      else if(diff<0){label=Math.abs(diff)+' days late';labelColor='var(--red)'}
    }
    forecastHtml='<div><span class="mp-forecast-date">'+formatDateShort(forecast.estDate)+'</span><span class="mp-forecast-label" style="color:'+labelColor+'"> '+label+'</span></div><div class="mp-forecast-detail">At '+forecast.rate.toFixed(1)+'%/day â€¢ '+forecast.daysToComplete+'d to complete</div>';
    if(projectDates.end){
      forecastHtml+='<div class="mp-forecast-detail" style="color:var(--text-muted);margin-top:2px">Deadline: '+deadlineDate+'</div>';
    }
  }else{
    forecastHtml='<div style="color:var(--text3);font-size:11px">Not enough data</div>';
  }
  $('mpForecast').innerHTML=forecastHtml;
  
  // Progress chart (burn-up)
  renderMetricsChart();
}

function renderMetricsChart(){
  const chart=$('mpChart');
  if(!projectDates.end){
    chart.innerHTML='<div class="mp-chart-empty" onclick="window.openDates()"><span>ðŸ“…</span><span>Set project end date to see chart</span></div>';
    return;
  }
  
  const dayMs = 86400000;
  const projectEndT = Date.parse(projectDates.end);
  const projectStartT = projectDates.start ? Date.parse(projectDates.start) : null;
  const todayT = Date.now();
  const todayStr = new Date().toISOString().split('T')[0];
  
  // Build working history - always include at least today's progress
  let workingHistory = history.length > 0 
    ? [...history] 
    : [{date: todayStr, pct: calcOverallProgress()}];
  
  // Sort by date and dedupe points too close together (< 3 days apart)
  workingHistory.sort((a, b) => Date.parse(a.date) - Date.parse(b.date));
  workingHistory = workingHistory.filter((h, i, arr) => {
    if (i === arr.length - 1) return true;
    const gap = (Date.parse(arr[i + 1].date) - Date.parse(h.date)) / dayMs;
    return gap >= 3;
  });
  
  // Chart X range: from earliest data to max(latest data, project end, today)
  const earliestT = Date.parse(workingHistory[0].date);
  const latestDataT = Date.parse(workingHistory[workingHistory.length - 1].date);
  const chartStartT = earliestT;
  const chartEndT = Math.max(latestDataT, projectEndT, todayT);
  const chartTotalDays = Math.max(1, (chartEndT - chartStartT) / dayMs);
  
  // For target line calculations
  const projectDuration = projectStartT ? (projectEndT - projectStartT) / dayMs : chartTotalDays;
  
  // Chart dimensions (larger chart)
  const w = 560, h = 255;
  const pad = {top: 14, right: 14, bottom: 38, left: 34};
  const chartW = w - pad.left - pad.right;
  const chartH = h - pad.top - pad.bottom;
  const xScale = t => pad.left + ((t - chartStartT) / dayMs / chartTotalDays) * chartW;
  const yScale = pct => pad.top + (1 - pct / 100) * chartH;
  
  // Map history to chart points
  const points = workingHistory.map(h => ({
    x: xScale(Date.parse(h.date)),
    y: yScale(h.pct),
    pct: h.pct,
    t: Date.parse(h.date),
    date: h.date
  }));
  
  // Get forecast for prediction line
  const forecast = getVelocityForecast();
  let forecastData = null;
  
  // Start SVG
  let svg = '<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="xMidYMid meet">';
  
  // Grid lines
  [0, 25, 50, 75, 100].forEach(g => {
    const y = yScale(g);
    svg += '<line x1="'+pad.left+'" y1="'+y+'" x2="'+(w-pad.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="1"/>';
    svg += '<text x="'+(pad.left-6)+'" y="'+(y+3)+'" fill="var(--text3)" font-size="9" text-anchor="end">'+g+'</text>';
  });
  
  // X-axis labels
  const formatLabel = t => new Date(t).toLocaleDateString('en-US', {month:'short', day:'numeric'});
  svg += '<text x="'+pad.left+'" y="'+(h-8)+'" fill="var(--text3)" font-size="9" text-anchor="start">'+formatLabel(chartStartT)+'</text>';
  svg += '<text x="'+(w/2)+'" y="'+(h-8)+'" fill="var(--text3)" font-size="9" text-anchor="middle">'+formatLabel(chartStartT + (chartEndT - chartStartT)/2)+'</text>';
  svg += '<text x="'+(w-pad.right)+'" y="'+(h-8)+'" fill="var(--text3)" font-size="9" text-anchor="end">'+formatLabel(chartEndT)+'</text>';
  
  // Today marker
  if (todayT >= chartStartT && todayT <= chartEndT) {
    svg += '<line x1="'+xScale(todayT)+'" y1="'+pad.top+'" x2="'+xScale(todayT)+'" y2="'+(h-pad.bottom)+'" stroke="var(--accent)" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>';
  }
  
  // Target line (if we have project start)
  if (projectStartT && projectEndT > projectStartT) {
    const tStartX = Math.max(pad.left, xScale(projectStartT));
    const tEndX = Math.min(w - pad.right, xScale(projectEndT));
    const startPct = projectStartT < chartStartT ? ((chartStartT - projectStartT) / dayMs / projectDuration) * 100 : 0;
    const endPct = projectEndT > chartEndT ? ((chartEndT - projectStartT) / dayMs / projectDuration) * 100 : 100;
    svg += '<line x1="'+tStartX+'" y1="'+yScale(startPct)+'" x2="'+tEndX+'" y2="'+yScale(endPct)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.6"/>';
  }
  
  // Helper: ideal progress at time t
  const getIdealPct = t => {
    if (!projectStartT) return 0;
    const elapsed = (t - projectStartT) / dayMs;
    return Math.max(0, Math.min(100, (elapsed / projectDuration) * 100));
  };
  
  // Progress line segments
  for (let i = 0; i < points.length - 1; i++) {
    const p1 = points[i], p2 = points[i + 1];
    const ideal1 = getIdealPct(p1.t), ideal2 = getIdealPct(p2.t);
    const ahead1 = p1.pct >= ideal1, ahead2 = p2.pct >= ideal2;
    const col1 = ahead1 ? 'var(--green)' : 'var(--red)';
    const col2 = ahead2 ? 'var(--green)' : 'var(--red)';
    
    if (ahead1 === ahead2) {
      svg += '<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>';
    } else {
      const t = (ideal1 - p1.pct) / ((p2.pct - p1.pct) - (ideal2 - ideal1));
      const ix = p1.x + t * (p2.x - p1.x), iy = p1.y + t * (p2.y - p1.y);
      svg += '<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+ix+'" y2="'+iy+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>';
      svg += '<line x1="'+ix+'" y1="'+iy+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col2+'" stroke-width="2.5" stroke-linecap="round"/>';
    }
  }
  
  // Prediction line - use current progress and calculate from today (consistent with velocity forecast)
  const lastPt = points[points.length - 1];
  const currentPct = calcOverallProgress();
  const todayForForecast = new Date();
  todayForForecast.setHours(0,0,0,0);
  const todayT_forecast = todayForForecast.getTime();
  
  if (forecast && forecast.rate > 0 && currentPct < 100) {
    // Use current progress, not last recorded point
    const remaining = 100 - currentPct;
    const daysTo100 = remaining / forecast.rate;
    const estFinishT = todayT_forecast + daysTo100 * dayMs;
    const estFinishStr = new Date(estFinishT).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    const afterDeadline = projectEndT ? estFinishT > projectEndT : false;
    const daysEarly = (afterDeadline || !projectEndT) ? null : Math.round((projectEndT - estFinishT) / dayMs);
    
    forecastData = { estDate: estFinishStr, rate: forecast.rate, daysToComplete: Math.round(daysTo100), afterDeadline, daysEarly };
    
    // Draw forecast line from last recorded point to estimated finish
    const forecastStartX = lastPt.x;
    const forecastStartY = lastPt.y;
    const targetX = Math.min(xScale(estFinishT), w - pad.right);
    const targetPct = estFinishT <= chartEndT ? 100 : currentPct + forecast.rate * ((chartEndT - todayT_forecast) / dayMs);
    
    svg += '<line x1="'+forecastStartX+'" y1="'+forecastStartY+'" x2="'+targetX+'" y2="'+yScale(Math.min(100, targetPct))+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" stroke-linecap="round" opacity="0.7"/>';
    
    if (estFinishT <= chartEndT) {
      svg += '<circle class="forecast-dot" cx="'+xScale(estFinishT)+'" cy="'+yScale(100)+'" r="5" fill="var(--bg2)" stroke="var(--text3)" stroke-width="1.5" style="cursor:pointer" data-tooltip="Forecasted finish: '+estFinishStr+'"/>';
    }
  } else if (forecast && forecast.rate <= 0 && currentPct < 100) {
    svg += '<line x1="'+lastPt.x+'" y1="'+lastPt.y+'" x2="'+(w-pad.right)+'" y2="'+lastPt.y+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" stroke-linecap="round" opacity="0.5"/>';
  }
  
  // Data points
  points.forEach(p => {
    const idealPct = getIdealPct(p.t);
    const dotColor = p.pct >= idealPct ? 'var(--green)' : 'var(--red)';
    const dateStr = new Date(p.date).toLocaleDateString('en-US', {month:'short', day:'numeric'});
    svg += '<circle class="data-dot" cx="'+p.x+'" cy="'+p.y+'" r="3.5" fill="'+dotColor+'" style="cursor:pointer" data-tooltip="'+dateStr+': '+Math.round(p.pct)+'%"/>';
  });
  
  // Deadline marker (red dashed vertical line at project end date)
  if (projectEndT && projectEndT >= chartStartT && projectEndT <= chartEndT) {
    const deadlineX = xScale(projectEndT);
    svg += '<line x1="'+deadlineX+'" y1="'+pad.top+'" x2="'+deadlineX+'" y2="'+(h-pad.bottom)+'" stroke="var(--red)" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>';
  }
  
  svg += '</svg>';
  chart.innerHTML = svg;
  
  // Custom tooltips (instant, no delay)
  const tooltip = $('mpChartTooltip');
  const wrapper = chart.parentElement;
  
  chart.querySelectorAll('[data-tooltip]').forEach(el => {
    el.addEventListener('mouseenter', e => {
      tooltip.textContent = e.target.getAttribute('data-tooltip');
      tooltip.classList.add('visible');
      const r = e.target.getBoundingClientRect(), w = wrapper.getBoundingClientRect();
      tooltip.style.left = (r.left - w.left + r.width/2 - tooltip.offsetWidth/2) + 'px';
      tooltip.style.top = (r.top - w.top - 28) + 'px';
    });
    el.addEventListener('mouseleave', () => tooltip.classList.remove('visible'));
  });
  
  // Forecast dot click â†’ popover
  const forecastDot = chart.querySelector('.forecast-dot');
  if (forecastDot && forecastData) {
    forecastDot.addEventListener('click', e => {
      e.stopPropagation();
      const popover = $('mpForecastPopover');
      const r = forecastDot.getBoundingClientRect(), w = wrapper.getBoundingClientRect();
      
      $('mpForecastPopoverTitle').textContent = forecastData.estDate;
      $('mpForecastPopoverTitle').style.color = forecastData.afterDeadline ? 'var(--red)' : 'var(--green)';
      
      let content = '<div class="mp-forecast-popover-stat"><span>Velocity</span><span>'+forecastData.rate.toFixed(1)+'%/day</span></div>';
      content += '<div class="mp-forecast-popover-stat"><span>Days to complete</span><span>'+forecastData.daysToComplete+'d</span></div>';
      if (forecastData.daysEarly) {
        content += '<div class="mp-forecast-popover-stat"><span>Status</span><span style="color:var(--green)">'+forecastData.daysEarly+' days early</span></div>';
      } else if (forecastData.afterDeadline) {
        content += '<div class="mp-forecast-popover-stat"><span>Status</span><span style="color:var(--red)">After deadline</span></div>';
      }
      const historyDays = Math.round((Date.parse(history[history.length-1].date) - Date.parse(history[0].date)) / dayMs);
      content += '<div style="margin-top:8px;font-size:11px;color:var(--text3)">Based on '+history.length+' data points over '+historyDays+' days</div>';
      
      $('mpForecastPopoverContent').innerHTML = content;
      popover.style.display = 'block';
      popover.style.left = Math.max(10, r.left - w.left - 100) + 'px';
      popover.style.top = (r.bottom - w.top + 8) + 'px';
    });
  }
}

window.editCell=function(e,id,field){e.stopPropagation();const cell=e.currentTarget;if(cell.classList.contains('editing'))return;const item=data.find(d=>String(d.id)===String(id));if(!item)return;const currentValue=item[field]||'';cell.classList.add('editing');const inputType=field==='qty'?'number':'text';cell.innerHTML='<input type="'+inputType+'" value="'+esc(currentValue)+'" '+(field==='qty'?'min="1"':'')+'>';const input=cell.querySelector('input');input.focus();input.select();const saveValue=()=>{const newValue=field==='qty'?parseInt(input.value)||1:input.value.trim();if(item[field]!==newValue){item[field]=newValue;updateFieldTimestamp(item,field);markPartChanged(id,[field])}save();render()};input.onblur=saveValue;input.onkeydown=ev=>{if(ev.key==='Enter'){ev.preventDefault();saveValue()}if(ev.key==='Escape')render()}};

window.editCellAutocomplete=function(e,id,field){
  e.stopPropagation();
  const cell=e.currentTarget;
  if(cell.classList.contains('editing'))return;
  const item=data.find(d=>String(d.id)===String(id));
  if(!item)return;
  const currentValue=item[field]||'';
  const suggestions=field==='code'?getAllCodes():getAllMfrs();
  
  cell.classList.add('editing');
  cell.innerHTML='<div class="autocomplete-wrapper"><input type="text" value="'+esc(currentValue)+'" placeholder="Type to search..."><div class="autocomplete-list"></div></div>';
  const wrapper=cell.querySelector('.autocomplete-wrapper');
  const input=cell.querySelector('input');
  const list=cell.querySelector('.autocomplete-list');
  let selectedIdx=-1;
  
  function positionList(){
    const rect=wrapper.getBoundingClientRect();
    list.style.top=(rect.bottom+2)+'px';
    list.style.left=rect.left+'px';
    list.style.width=Math.max(rect.width,180)+'px';
  }
  
  function filterSuggestions(val){
    if(!val||!val.trim())return suggestions.slice(0,10);
    const v=val.toLowerCase();
    return suggestions.filter(s=>s.toLowerCase().includes(v)).slice(0,10);
  }
  
  function renderList(filtered,val){
    if(!filtered.length){list.classList.remove('open');list.innerHTML='';return}
    list.innerHTML=filtered.map((s,i)=>{
      let highlighted=esc(s);
      if(val&&val.trim()){
        const idx=s.toLowerCase().indexOf(val.toLowerCase());
        if(idx>=0)highlighted=esc(s.substring(0,idx))+'<em>'+esc(s.substring(idx,idx+val.length))+'</em>'+esc(s.substring(idx+val.length));
      }
      return '<div class="autocomplete-item'+(i===selectedIdx?' selected':'')+'" data-val="'+esc(s)+'">'+highlighted+'</div>';
    }).join('');
    positionList();
    list.classList.add('open');
    list.querySelectorAll('.autocomplete-item').forEach((el,i)=>{
      el.onmousedown=ev=>{ev.preventDefault();ev.stopPropagation();input.value=el.dataset.val;saveValue()};
    });
  }
  
  input.focus();input.select();
  
  // Find existing part with same code to auto-fill name and mfr
  function findMatchingPart(code){
    if(!code)return null;
    return data.find(d=>!d.isAsm&&d.id!==id&&d.code&&d.code.toLowerCase()===code.toLowerCase());
  }
  
  const saveValue=()=>{
    list.classList.remove('open');
    const newValue=input.value.trim();
    item[field]=newValue;
    if(newValue){
      if(field==='code'){
        addGlobalCode(newValue);
        // Auto-fill name and mfr from existing part with same code
        const match=findMatchingPart(newValue);
        if(match){
          if(match.name&&(!item.name||item.name==='New Part'))item.name=match.name;
          if(match.mfr&&!item.mfr)item.mfr=match.mfr;
        }
      }else if(field==='mfr'){
        addGlobalMfr(newValue);
      }
    }
    save();render();
  };
  
  input.oninput=()=>{selectedIdx=-1;renderList(filterSuggestions(input.value),input.value)};
  input.onfocus=()=>{renderList(filterSuggestions(input.value),input.value)};
  input.onblur=()=>setTimeout(saveValue,200);
  input.onkeydown=ev=>{
    const filtered=filterSuggestions(input.value);
    if(ev.key==='ArrowDown'){ev.preventDefault();selectedIdx=Math.min(selectedIdx+1,filtered.length-1);renderList(filtered,input.value)}
    else if(ev.key==='ArrowUp'){ev.preventDefault();selectedIdx=Math.max(selectedIdx-1,-1);renderList(filtered,input.value)}
    else if(ev.key==='Enter'){ev.preventDefault();if(selectedIdx>=0&&filtered[selectedIdx])input.value=filtered[selectedIdx];saveValue()}
    else if(ev.key==='Escape')render();
    else if(ev.key==='Tab'&&selectedIdx>=0&&filtered[selectedIdx]){input.value=filtered[selectedIdx]}
  };
  // Show suggestions immediately on open
  setTimeout(()=>renderList(filterSuggestions(currentValue),currentValue),50);
};

window.editCellAssignee=function(e,id){e.stopPropagation();const cell=e.currentTarget;if(cell.classList.contains('editing'))return;const item=data.find(d=>String(d.id)===String(id));if(!item)return;cell.classList.add('editing');const opts='<option value="">â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(t.name===item.assignee?' selected':'')+'>'+esc(t.name)+'</option>').join('');cell.innerHTML='<select>'+opts+'</select>';const select=cell.querySelector('select');select.focus();let saved=false;const saveValue=()=>{if(saved)return;saved=true;select.onblur=null;select.onchange=null;if(item.assignee!==select.value){item.assignee=select.value;updateFieldTimestamp(item,'assignee');markPartChanged(id,['assignee'])}save();render()};select.onblur=saveValue;select.onchange=saveValue;select.onkeydown=ev=>{if(ev.key==='Escape'){saved=true;render()}}};

function generateReport(){
  const today=new Date();const dateStr=today.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const parts=getParts(),asms=getAsms();
  const pct=calcOverallProgress(),expected=getExpectedProgress(),daysLeft=getDaysLeft();
  const toOrder=parts.filter(p=>p.status==='to-order');
  const ordered=parts.filter(p=>p.status==='ordered');
  const installed=parts.filter(p=>p.status==='installed');
  const forecast=getVelocityForecast();const otd=calcSupplierOTD();

  let status='ðŸŸ¢ ON TRACK',statusDetail='Project progressing as planned.';
  if(expected&&pct<expected-10){status='ðŸ”´ BEHIND SCHEDULE';statusDetail='Project is '+(expected-pct)+'% behind expected progress.'}
  else if(expected&&pct>=expected+5){status='ðŸŸ¢ AHEAD OF SCHEDULE';statusDetail='Project is '+(pct-expected)+'% ahead of target.'}

  let report=currentProjectName.toUpperCase()+'\nPROJECT STATUS REPORT\n'+'â•'.repeat(52)+'\n'+dateStr+'\n\nEXECUTIVE SUMMARY\n'+'â”€'.repeat(36)+'\nStatus: '+status+'\n'+statusDetail+'\n\nPROGRESS METRICS\n'+'â”€'.repeat(36)+'\nOverall Completion: '+pct+'%\n  â””â”€ '+installed.length+' of '+parts.length+' parts installed\n\n';
  if(expected!==null)report+='Expected Progress: '+expected+'%\nVariance: '+(pct>=expected?'+':'')+(pct-expected)+'%\n';
  if(daysLeft!==null)report+='Days Remaining: '+daysLeft+'\n';
  report+='\nVELOCITY FORECAST\n'+'â”€'.repeat(36)+'\n';
  if(forecast&&forecast.rate>0)report+='Current Rate: '+forecast.rate.toFixed(1)+'% per day\nEst. Completion: '+formatDateShort(forecast.estDate)+'\nDays Required: '+forecast.daysToComplete+'\n'+(daysLeft!==null?'Buffer: '+(forecast.daysToComplete<=daysLeft?'+':'')+(daysLeft-forecast.daysToComplete)+' days\n':'')+'\nStatus: '+(forecast.status==='ahead'?'âœ“ Ahead of schedule':forecast.status==='on-track'?'âœ“ On track':forecast.status==='behind'?'âš  Slightly behind':'âš  At risk')+'\n';
  else report+='Insufficient data for velocity forecast\n';
  report+='\nSUPPLIER PERFORMANCE\n'+'â”€'.repeat(36)+'\nOn-Time Delivery: '+(otd!==null?otd+'%':'No data yet')+'\nAverage Lead Time: '+(calcAvgLeadTime()||'â€”')+' days\n';
  report+='\nASSEMBLY STATUS\n'+'â”€'.repeat(36)+'\n'+asms.map(a=>{const prog=calcAsmProgress(a.id);const statusIcon=prog===100?'âœ“':prog>=50?'â—':'â—‹';return statusIcon+' '+a.name.substring(0,30).padEnd(30)+' '+String(prog).padStart(3)+'%'}).join('\n')+'\n';
  if(toOrder.length)report+='\nâš  AWAITING ORDER ('+toOrder.length+')\n'+'â”€'.repeat(36)+'\n'+toOrder.slice(0,8).map(p=>'  â€¢ '+p.name+(p.code?' ['+p.code+']':'')).join('\n')+(toOrder.length>8?'\n  ... and '+(toOrder.length-8)+' more':'')+'\n';
  if(ordered.length)report+='\nðŸ“¦ IN TRANSIT ('+ordered.length+')\n'+'â”€'.repeat(36)+'\n'+ordered.slice(0,8).map(p=>{const eta=getPartETA(p);return'  â€¢ '+p.name+' â€” ETA: '+eta.display}).join('\n')+(ordered.length>8?'\n  ... and '+(ordered.length-8)+' more':'')+'\n';
  report+='\n'+'â•'.repeat(52)+'\nGenerated: '+new Date().toLocaleString();
  return report;
}


window.loadBom=function(bomId){const bom=savedBoms.find(b=>String(b.id)===String(bomId));if(!bom)return;if(!confirm('Load "'+bom.name+'"?'))return;currentProjectName=bom.name;data=[];expanded={};history=[];const asmMap={};bom.items.filter(i=>i.isAsm).forEach((item,idx)=>{const asmId=generateId();asmMap[item.name]=asmId;data.push({id:asmId,name:item.name,isAsm:true,assignee:'',priority:idx+1});expanded[String(asmId)]=true;dirtyAsms.add(asmId)});bom.items.filter(i=>!i.isAsm).forEach(item=>{const parentId=asmMap[item.parent]||null;const partId=generateId();data.push({id:partId,name:item.name,code:item.code||'',mfr:item.mfr||'',qty:item.qty||1,assignee:'',parentId,status:'waiting',changedAt:Date.now()});dirtyParts.add(partId)});dirtyMeta=true;save();render();closeModal('bomModal');};
window.delBom=function(bomId,e){
  deleteTarget={id:bomId,type:'bom'};
  const bom=savedBoms.find(b=>String(b.id)===String(bomId));
  const name=bom?bom.name:'Specification';
  $('deleteMsg').innerHTML='Delete "<strong>'+esc(name)+'</strong>"?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};
window.saveBom=function(){const name=$('bomName').value.trim();if(!name){return}const items=[];const asms=getAsms();asms.forEach(asm=>{items.push({name:asm.name,isAsm:true});data.filter(d=>!d._deletedAt&&String(d.parentId)===String(asm.id)).forEach(p=>{items.push({name:p.name,code:p.code,mfr:p.mfr,qty:p.qty,parent:asm.name})})});savedBoms.push({id:generateId(),name,items});saveBoms();closeModal('bomModal');};

window.clearStageFilter=()=>{filterStage='';render()};
window.clearAssigneeFilter=()=>{filterAssignee='';$('assigneeFilter').value='';render()};
window.clearPOFilter=()=>{filterPO='';render()};
window.togglePOFilter=(po,e)=>{e&&e.stopPropagation();filterPO=filterPO===po?'':po;render()};

window.showPODetails=(po,e)=>{
  e&&e.stopPropagation();
  const parts=data.filter(p=>p.poNumber===po);
  if(!parts.length)return;
  
  // Get first part's data for header info
  const firstPart=parts.find(p=>p.orderedAt)||parts[0];
  const supplier=parts.find(p=>p.supplier)?.supplier||'';
  const orderedDate=firstPart.orderedAt?new Date(firstPart.orderedAt).toLocaleDateString():'-';
  const expectedDate=firstPart.expectedArrival?new Date(firstPart.expectedArrival).toLocaleDateString():'-';
  
  $('poDetailsNumber').textContent=po;
  $('poDetailsSupplier').textContent=supplier;
  $('poDetailsOrdered').innerHTML='<strong>Ordered:</strong> '+orderedDate;
  $('poDetailsExpected').innerHTML='<strong>Expected:</strong> '+expectedDate;
  
  // Build items list
  let received=0,total=parts.length;
  let html='';
  parts.forEach(p=>{
    const isReceived=p.status!=='waiting'&&p.status!=='ordered';
    if(isReceived)received++;
    const recDate=p.arrivedAt?new Date(p.arrivedAt).toLocaleDateString().split('/').slice(0,2).join('.'):'â€”';
    html+='<div class="po-details-row">';
    html+='<div class="item-name"><span>'+esc(p.name)+'</span>'+(p.code?'<span class="item-code">'+esc(p.code)+'</span>':'')+'</div>';
    html+='<div class="qty">'+(p.qty||1)+'</div>';
    html+='<div class="status '+(isReceived?'received':'pending')+'">'+(isReceived?'<span>'+recDate+'</span> âœ“':'â€”')+'</div>';
    html+='</div>';
  });
  $('poDetailsList').innerHTML=html;
  
  // Summary
  const pct=Math.round((received/total)*100);
  $('poDetailsSummary').innerHTML='<span>'+received+' of '+total+' lines complete</span><div class="progress-bar"><div class="progress-fill" style="width:'+pct+'%"></div></div><span>'+pct+'%</span>';
  
  // Show/hide receive button
  const canReceive=parts.some(p=>p.status==='ordered');
  $('poDetailsReceiveAll').style.display=canReceive?'block':'none';
  $('poDetailsReceiveAll').onclick=()=>{
    const toReceive=parts.filter(p=>p.status==='ordered');
    if(!confirm('Receive '+toReceive.length+' item'+(toReceive.length>1?'s':'')+'?'))return;
    toReceive.forEach(p=>{
      p.status='arrived';
      p.arrivedAt=Date.now();
      p.changedAt=Date.now();
      logActivity('status',p.name+' â†’ Arrived',{partId:p.id,partName:p.name,oldValue:'ordered',newValue:'arrived'});
    });
    save();render();
    closeAllPopovers();

  };
  
  // Position and show popover
  const popover=$('poDetailsPopover');
  const rect=e.target.getBoundingClientRect();
  
  // Calculate popover height (estimate if not yet visible)
  popover.style.visibility='hidden';
  popover.classList.add('open');
  const popoverHeight=popover.offsetHeight||300;
  const popoverWidth=popover.offsetWidth||360;
  popover.classList.remove('open');
  popover.style.visibility='';
  
  // Position vertically - show above if not enough space below
  let top=rect.bottom+8;
  if(top+popoverHeight>window.innerHeight-20){
    top=rect.top-popoverHeight-8;
    if(top<20)top=20; // Don't go above viewport
  }
  
  // Position horizontally
  let left=rect.left;
  if(left+popoverWidth>window.innerWidth-20){
    left=window.innerWidth-popoverWidth-20;
  }
  if(left<20)left=20;
  
  popover.style.top=top+'px';
  popover.style.left=left+'px';
  closeAllPopovers();
  popover.classList.add('open');
};
$('poDetailsClose').onclick=()=>$('poDetailsPopover').classList.remove('open');
document.addEventListener('click',e=>{
  const popover=$('poDetailsPopover');
  if(popover&&popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.eta-po')){
    popover.classList.remove('open');
  }
  const etaPop=$('etaPopover');
  if(etaPop&&etaPop.classList.contains('open')&&!etaPop.contains(e.target)&&!e.target.closest('.eta-date')){
    etaPop.classList.remove('open');editEtaPartId=null;
  }
});
function closeAllPopovers(){
  // Close popover modals
  ['partModal','asmModal','aiModal'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  // Close other popovers
  ['themeModal','reportModal','receivePOModal','commentsPopover','deletePopover','statusPopover','pendingPopover','poDetailsPopover','etaPopover','bulkStatusPopover','bulkAssigneePopover','bulkPOPopover','bulkDeletePopover','partInfoPopover'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  // Close gantt popups
  ['ganttColorPopup','ganttDatePopup'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  $('popoverBackdrop').classList.remove('active');
}
function showPopoverModal(modal,btn){
  closeAllPopovers();
  $('popoverBackdrop').classList.add('active');
  if(btn){
    const rect=btn.getBoundingClientRect();
    const mw=320,mh=Math.min(modal.scrollHeight||400,window.innerHeight-100);
    let top=rect.top;
    let left=rect.right-mw-10;
    // Keep in viewport
    if(left<16)left=16;
    if(left+mw>window.innerWidth-16)left=window.innerWidth-mw-16;
    if(top+mh>window.innerHeight-50)top=Math.max(50,window.innerHeight-mh-50);
    modal.style.top=top+'px';
    modal.style.left=left+'px';
  }else{
    modal.style.top='50%';
    modal.style.left='50%';
    modal.style.transform='translate(-50%,-50%) scale(1)';
  }
  modal.classList.add('open');
}
function hidePopoverModal(modal){
  modal.classList.remove('open');
  modal.style.transform='';
  $('popoverBackdrop').classList.remove('active');
}
$('popoverBackdrop').onclick=(e)=>{
  // Only handle if click was directly on the backdrop, not on elements above it
  if(e.target!==$('popoverBackdrop'))return;
  hidePopoverModal($('partModal'));editId=null;
  hidePopoverModal($('asmModal'));editAsmId=null;
  if($('actionModal'))hidePopoverModal($('actionModal'));editActId=null;
  closeCmdWindow();
  $('themeModal').classList.remove('open');
  $('reportModal').classList.remove('open');
  $('receivePOModal').classList.remove('open');
  $('metricsPopover').classList.remove('open');
  $('insightsPanel').classList.remove('open','ai-mode');$('insightsAIBtn').classList.remove('active');
  $('poModal').classList.remove('open');pendingAdvPartId=null;
  $('labelModal').classList.remove('open');$('labelModal').style.transform='';
  $('commentsPopover').classList.remove('open');currentCommentPartId=null;
  $('deletePopover').classList.remove('open');deleteTarget={id:null,type:null};
  $('popoverBackdrop').classList.remove('active');
  $('mpForecastPopover').style.display='none';
};
// Close forecast popover when clicking outside
document.addEventListener('click',e=>{
  if(!e.target.closest('.mp-forecast-popover')&&!e.target.closest('.forecast-dot')){
    $('mpForecastPopover').style.display='none';
  }
});
window.editAsm=(id,e)=>{const a=data.find(d=>String(d.id)===String(id));if(!a)return;editAsmId=id;$('amTitle').textContent='Edit Assembly';$('amName').value=a.name;$('amAssignee').value=a.assignee||'';$('amNotes').value=a.notes||'';$('amNotify').disabled=!getTeamEmail(a.assignee);showPopoverModal($('asmModal'),e?e.target.closest('button'):null)};
window.editPart=(id,e)=>{const p=data.find(d=>String(d.id)===String(id));if(!p)return;editId=id;$('pmTitle').textContent='Edit Part';$('pmName').value=p.name;$('pmCode').value=p.code||'';$('pmMfr').value=p.mfr||'';$('pmQty').value=p.qty||1;$('pmAssignee').value=p.assignee||'';$('pmStatus').value=p.status;$('pmParent').value=p.parentId||'';$('pmNotes').value=p.notes||'';$('pmNotify').disabled=!getTeamEmail(p.assignee);showPopoverModal($('partModal'),e?e.target.closest('button'):null)};

let statusPopoverPartId=null;
window.openStatusPopover=(id,e)=>{
  e.stopPropagation();
  const p=data.find(d=>String(d.id)===String(id));if(!p)return;
  statusPopoverPartId=id;
  
  // Special handling for waiting status (previously pending)
  if(p.status==='waiting'){
    const popover=$('pendingPopover');
    $('pendingNoteInput').value=p.pendingNote||'';
    const rect=e.target.getBoundingClientRect();
    let top=rect.bottom+6;
    let left=rect.left;
    if(left+280>window.innerWidth)left=window.innerWidth-290;
    if(top+200>window.innerHeight)top=rect.top-210;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
    popover.classList.add('open');
    setTimeout(()=>$('pendingNoteInput').focus(),50);
    return;
  }
  
  const popover=$('statusPopover');
  const rect=e.target.getBoundingClientRect();
  let top=rect.bottom+6;
  let left=rect.left;
  if(left+140>window.innerWidth)left=window.innerWidth-150;
  if(top+200>window.innerHeight)top=rect.top-210;
  popover.style.top=Math.max(10,top)+'px';
  popover.style.left=Math.max(10,left)+'px';
  // Generate status options
  $('statusPopoverOptions').innerHTML=STAGES.map(s=>{
    const active=s===p.status?' style="background:var(--accent);color:#fff"':'';
    return '<div class="dropdown-item"'+active+' onclick="window.setPartStatus(\''+id+'\',\''+s+'\')">'+SLABELS[s]+'</div>';
  }).join('');
  popover.classList.add('open');
};

// Pending popover handlers
$('pendingYes').onclick=()=>{
  const p=data.find(d=>String(d.id)===String(statusPopoverPartId));
  if(!p)return;
  const note=$('pendingNoteInput').value.trim();
  if(note)p.pendingNote=note;
  const oldStatus=p.status;
  // Move to "to-order" status (no PO modal needed yet)
  p.status='to-order';
  p.changedAt=Date.now();
  updateFieldTimestamp(p,'status');
  markPartChanged(statusPopoverPartId,['status']);
  logActivity('status',p.name+' â†’ To-order',{partId:p.id,partName:p.name,oldValue:oldStatus,newValue:'to-order'});
  $('pendingPopover').classList.remove('open');
  save();render();

};

$('pendingNo').onclick=()=>{
  const p=data.find(d=>String(d.id)===String(statusPopoverPartId));
  if(!p)return;
  const note=$('pendingNoteInput').value.trim();
  if(note){
    p.pendingNote=note;
    updateFieldTimestamp(p,'pendingNote');
    markPartChanged(statusPopoverPartId,['pendingNote']);
    save();render();
    
  }
  $('pendingPopover').classList.remove('open');
};

window.setPartStatus=(id,status)=>{
  const p=data.find(d=>String(d.id)===String(id));if(!p)return;
  const now=Date.now();
  const oldStatus=p.status;
  if(oldStatus===status){$('statusPopover').classList.remove('open');return;}
  $('statusPopover').classList.remove('open');
  
  // If moving to "ordered" from "to-order", show PO popover
  if(oldStatus==='to-order'&&status==='ordered'){
    pendingAdvPartId=id;
    $('poPartName').textContent=p.name+(p.code?' ('+p.code+')':'');
    $('poNumber').value=p.poNumber||'';
    $('poArrivalDate').value=p.expectedArrival||'';
    const popover=$('poModal');
    // Position near the status badge
    const badge=document.querySelector('[data-part-id="'+id+'"] .status-badge');
    if(badge){
      const rect=badge.getBoundingClientRect();
      let top=rect.bottom+8;
      let left=rect.left;
      if(left+320>window.innerWidth)left=window.innerWidth-330;
      if(top+300>window.innerHeight)top=rect.top-310;
      popover.style.top=Math.max(10,top)+'px';
      popover.style.left=Math.max(10,left)+'px';
    }
    popover.classList.add('open');
    $('popoverBackdrop').classList.add('active');
    setTimeout(()=>$('poNumber').focus(),100);
    return;
  }
  
  if(oldStatus==='ordered'&&status==='arrived'&&p.orderedAt&&p.code){
    const days=Math.round((now-p.orderedAt)/86400000);
    if(days>0)recordLeadTime(p.code,days);
    p.arrivedAt=now;
  }
  if(status==='ordered'&&oldStatus!=='ordered')p.orderedAt=now;
  p.status=status;
  p.changedAt=now;
  updateFieldTimestamp(p,'status');
  markPartChanged(id,['status']);
  logActivity('status', p.name + ' â†’ ' + status.charAt(0).toUpperCase() + status.slice(1), { partId: p.id, partName: p.name, oldValue: oldStatus, newValue: status });
  save();render();

};

// Close status popover on outside click
document.addEventListener('click',e=>{
  const popover=$('statusPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.status-badge')){
    popover.classList.remove('open');
  }
});

// Close pending popover on outside click
document.addEventListener('click',e=>{
  const popover=$('pendingPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.status-badge')){
    popover.classList.remove('open');
  }
});

let pendingAdvPartId=null;
window.advPart=(id,e)=>{
  const p=data.find(d=>String(d.id)===String(id));if(!p)return;
  const si=STAGES.indexOf(p.status),next=STAGES[si+1];
  if(!next)return;
  // If moving to "ordered" from "to-order", show PO popover
  if(p.status==='to-order'&&next==='ordered'){
    pendingAdvPartId=id;
    $('poPartName').textContent=p.name+(p.code?' ('+p.code+')':'');
    $('poNumber').value=p.poNumber||'';
    $('poArrivalDate').value=p.expectedArrival||'';
    const popover=$('poModal');
    if(e&&e.target){
      const rect=e.target.getBoundingClientRect();
      let top=rect.bottom+8;
      let left=rect.left;
      // Ensure it stays on screen
      if(left+320>window.innerWidth)left=window.innerWidth-330;
      if(top+300>window.innerHeight)top=rect.top-310;
      popover.style.top=Math.max(10,top)+'px';
      popover.style.left=Math.max(10,left)+'px';
    }
    popover.classList.add('open');
    $('popoverBackdrop').classList.add('active');
    setTimeout(()=>$('poNumber').focus(),100);
    return;
  }
  // Normal advancement
  advancePartStatus(id);
};

function advancePartStatus(id){
  const p=data.find(d=>String(d.id)===String(id));if(!p)return;
  const next=getNextStage(p);
  if(!next)return;
  const oldStatus=p.status;
  // Record lead time when transitioning from ordered to arrived
  if(p.status==='ordered'&&next==='arrived'&&p.orderedAt){
    const days=Math.round((Date.now()-p.orderedAt)/86400000);
    if(p.code&&days>0)recordLeadTime(p.code,days);
    p.arrivedAt=Date.now();
    // Log arrival event
    const wasLate=p.expectedArrival&&new Date(p.expectedArrival)<new Date();
    const daysDelta=p.expectedArrival?Math.round((Date.now()-new Date(p.expectedArrival).getTime())/86400000):null;
    logArrival(p,days,wasLate,daysDelta);
    // Log ETA miss if late
    if(wasLate&&p.expectedArrival){
      logEtaMiss(p,p.expectedArrival,new Date().toISOString().split('T')[0],daysDelta);
    }
  }
  if(next==='ordered')p.orderedAt=Date.now();
  p.status=next;p.changedAt=Date.now();
  logActivity('status', p.name + ' â†’ ' + next.charAt(0).toUpperCase() + next.slice(1), { partId: p.id, partName: p.name, oldValue: oldStatus, newValue: next });
  save();render();
}

let deleteTarget={id:null,type:null};
window.confirmDelete=(id,type,e)=>{
  if(e)e.stopPropagation();
  deleteTarget={id,type};
  const item=data.find(d=>String(d.id)===String(id));
  const name=item?item.name:'Item';
  let msg='Delete "<strong>'+esc(name)+'</strong>"?';
  if(type==='assembly'){
    const kids=data.filter(d=>!d._deletedAt&&String(d.parentId)===String(id));
    if(kids.length)msg+='<br><span style="color:var(--text3);font-size:11px">+'+kids.length+' part'+(kids.length>1?'s':'')+'</span>';
  }else if(type==='part'){
    const subParts=data.filter(d=>!d._deletedAt&&String(d.parentId)===String(id));
    if(subParts.length)msg+='<br><span style="color:var(--text3);font-size:11px">+'+subParts.length+' sub-part'+(subParts.length>1?'s':'')+'</span>';
  }
  $('deleteMsg').innerHTML=msg;
  
  // Position popover near the button
  const popover=$('deletePopover');
  popover.style.transform=''; // Reset any previous transform
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left;
    // Keep in viewport
    if(left+220>window.innerWidth)left=window.innerWidth-230;
    if(left<10)left=10;
    if(top+150>window.innerHeight)top=rect.top-160;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
  }else{
    popover.style.top='50%';
    popover.style.left='50%';
    popover.style.transform='translate(-50%,-50%)';
  }
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
};

window.copyPO=(po,e)=>{
  e.stopPropagation();
  navigator.clipboard.writeText(po);
  
};

window.delTeam=(idx,e)=>{
  deleteTarget={id:idx,type:'team'};
  const member=team[idx];
  const name=member?member.name:'Member';
  $('deleteMsg').innerHTML='Remove "<strong>'+esc(name)+'</strong>" from team?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};
window.openDates=()=>{$('startDate').value=projectDates.start||'';$('endDate').value=projectDates.end||'';$('datesModal').classList.add('open')};

function sendNotify(item,isAsm){const email=getTeamEmail(item.assignee);if(!email)return;const status=isAsm?calcAsmProgress(item.id)+'%':SLABELS[item.status],subject=encodeURIComponent('Action Required: '+item.name),body=encodeURIComponent('Hi '+item.assignee+',\n\nItem: '+item.name+'\nStatus: '+status+'\n'+(item.notes?'Notes: '+item.notes+'\n':'')+'\nThanks!');window.location.href='mailto:'+email+'?subject='+subject+'&body='+body}

window.goToPart=partId=>{$('metricsPopover').classList.remove('open');document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="list"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('listPanel').classList.add('active');const part=data.find(d=>String(d.id)===String(partId));if(part&&part.parentId)expanded[String(part.parentId)]=true;highlightPartId=partId;render();setTimeout(()=>{const row=document.querySelector('[data-part-id="'+partId+'"]');if(row)row.scrollIntoView({behavior:'smooth',block:'center'})},50)};

// Navigate to part/assembly from report and highlight for 3 seconds
window.goToReportItem=function(id,isAsm){
  // Close report modal
  $('reportModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  
  // Switch to list view
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  
  if(isAsm){
    // Expand the assembly and scroll to it
    expanded[String(id)]=true;
    render();
    setTimeout(()=>{
      const row=document.querySelector('[data-asm-id="'+id+'"]');
      if(row){
        row.scrollIntoView({behavior:'smooth',block:'center'});
        row.classList.add('highlight');
        setTimeout(()=>row.classList.remove('highlight'),3000);
      }
    },50);
  }else{
    // Find the part and expand its parent
    const part=data.find(d=>String(d.id)===String(id));
    if(part&&part.parentId)expanded[String(part.parentId)]=true;
    highlightPartId=id;
    render();
    setTimeout(()=>{
      const row=document.querySelector('[data-part-id="'+id+'"]');
      if(row){
        row.scrollIntoView({behavior:'smooth',block:'center'});
        row.classList.add('highlight');
        setTimeout(()=>row.classList.remove('highlight'),3000);
      }
    },50);
  }
};
window.goToAsm=asmId=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="list"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('listPanel').classList.add('active');expanded[String(asmId)]=true;highlightAsmId=asmId;render();setTimeout(()=>{const row=document.querySelector('[data-asm-id="'+asmId+'"]');if(row){row.scrollIntoView({behavior:'smooth',block:'center'});row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),5000)}},50)};
window.goToGanttAsm=(asmId,e)=>{e&&e.stopPropagation();document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="gantt"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('ganttPanel').classList.add('active');ganttExpanded[String(asmId)]=true;window._ganttScrolled=false;if(!sidebarCollapsed)toggleSidebar(true);setTimeout(()=>{renderGantt();const row=document.querySelector('.gantt-sidebar-row[data-row-id="'+asmId+'"]');if(row){row.scrollIntoView({behavior:'smooth',block:'center'});row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),5000)}},50)};
let highlightAsmId=null;

const closeModal=id=>{const el=$(id);if(el)el.classList.remove('open')};
const openModal=id=>{const el=$(id);if(el)el.classList.add('open');else console.error('Modal not found:',id)};

// ============================================
// Command Prompt Window
// ============================================
let cmdWindowState={
  open:false,
  minimized:false,
  x:null,
  y:null,
  width:2100,
  height:1200,
  version:6
};

function openCmdWindow(){
  const win=$('cmdWindow');
  const btn=$('aiAlert');
  
  // Position in center-left area if not set
  if(cmdWindowState.x===null||cmdWindowState.x===undefined){
    // Position roughly 250px from left edge, 80px from top
    cmdWindowState.x=250;
    cmdWindowState.y=80;
  }
  
  // Ensure window stays within viewport
  const maxX=window.innerWidth-cmdWindowState.width-20;
  const maxY=window.innerHeight-cmdWindowState.height-20;
  cmdWindowState.x=Math.max(10,Math.min(cmdWindowState.x,maxX));
  cmdWindowState.y=Math.max(10,Math.min(cmdWindowState.y,maxY));
  
  // Apply position and size explicitly
  win.style.left=cmdWindowState.x+'px';
  win.style.top=cmdWindowState.y+'px';
  win.style.width=cmdWindowState.width+'px';
  win.style.height=cmdWindowState.height+'px';
  
  win.classList.add('open');
  win.classList.remove('minimized');
  $('cmdMinimized').classList.remove('active');
  cmdWindowState.open=true;
  cmdWindowState.minimized=false;
  
  // Button state - just add active class (rotates + to X)
  btn.classList.add('active');
  
  // Show suggested questions when opening
  const suggestions=$('cmdSuggestions');
  if(suggestions)suggestions.style.display='flex';
  
  $('cmdInput').focus();
  saveCmdWindowState();
}

function closeCmdWindow(){
  const win=$('cmdWindow');
  win.classList.remove('open');
  $('cmdMinimized').classList.remove('active');
  cmdWindowState.open=false;
  cmdWindowState.minimized=false;
  
  // Button state - remove active (rotates X back to +)
  const btn=$('aiAlert');
  btn.classList.remove('active');
  
  saveCmdWindowState();
}

function minimizeCmdWindow(){
  const win=$('cmdWindow');
  win.classList.remove('open');
  win.classList.add('minimized');
  $('cmdMinimized').classList.add('active');
  cmdWindowState.minimized=true;
  
  // Button stays active (X visible)
  saveCmdWindowState();
}

function restoreCmdWindow(){
  const win=$('cmdWindow');
  win.classList.add('open');
  win.classList.remove('minimized');
  $('cmdMinimized').classList.remove('active');
  cmdWindowState.minimized=false;
  
  $('cmdInput').focus();
  saveCmdWindowState();
}

function toggleCmdWindow(){
  if(cmdWindowState.open&&!cmdWindowState.minimized){
    closeCmdWindow();
  }else if(cmdWindowState.minimized){
    restoreCmdWindow();
  }else{
    openCmdWindow();
    // Show initial dashboard if no conversation
    if($('cmdBody').querySelectorAll('.cmd-line').length<=1){
      renderCmdDashboard();
    }
  }
}

function saveCmdWindowState(){
  try{
    localStorage.setItem('ebs-cmd-window',JSON.stringify(cmdWindowState));
  }catch(e){}
}

function loadCmdWindowState(){
  try{
    const saved=localStorage.getItem('ebs-cmd-window');
    if(saved){
      const s=JSON.parse(saved);
      // If version mismatch, clear old settings and use new defaults
      if(!s.version||s.version<6){
        localStorage.removeItem('ebs-cmd-window');
        return;
      }
      // Same version - use saved values
      if(s.x!==null&&s.x!==undefined)cmdWindowState.x=s.x;
      if(s.y!==null&&s.y!==undefined)cmdWindowState.y=s.y;
      if(s.width&&s.width>=800)cmdWindowState.width=s.width;
      if(s.height&&s.height>=500)cmdWindowState.height=s.height;
    }
  }catch(e){
    console.error('loadCmdWindowState error:',e);
  }
}
loadCmdWindowState();

// Drag functionality
let cmdDragging=false,cmdDragOffset={x:0,y:0};

function initCmdDrag(){
  const titlebar=$('cmdTitlebar');
  if(!titlebar)return;
  
  titlebar.addEventListener('mousedown',function(e){
    // Don't drag if clicking on controls
    if(e.target.closest('.cmd-controls'))return;
    if(e.target.tagName==='SELECT')return;
    if(e.target.tagName==='BUTTON')return;
    
    e.preventDefault();
    cmdDragging=true;
    const win=$('cmdWindow');
    const rect=win.getBoundingClientRect();
    cmdDragOffset.x=e.clientX-rect.left;
    cmdDragOffset.y=e.clientY-rect.top;
    document.body.style.userSelect='none';
    document.body.style.cursor='move';
  });
}
initCmdDrag();

document.addEventListener('mousemove',function(e){
  if(!cmdDragging)return;
  e.preventDefault();
  const win=$('cmdWindow');
  const newX=e.clientX-cmdDragOffset.x;
  const newY=e.clientY-cmdDragOffset.y;
  
  // Keep within bounds
  cmdWindowState.x=Math.max(0,Math.min(window.innerWidth-100,newX));
  cmdWindowState.y=Math.max(0,Math.min(window.innerHeight-50,newY));
  
  win.style.left=cmdWindowState.x+'px';
  win.style.top=cmdWindowState.y+'px';
});

document.addEventListener('mouseup',function(){
  if(cmdDragging){
    cmdDragging=false;
    document.body.style.userSelect='';
    document.body.style.cursor='';
    saveCmdWindowState();
  }
});

// Track resize
const cmdResizeObserver=new ResizeObserver(entries=>{
  for(const entry of entries){
    cmdWindowState.width=entry.contentRect.width;
    cmdWindowState.height=entry.contentRect.height;
    saveCmdWindowState();
  }
});
cmdResizeObserver.observe($('cmdWindow'));

// Render dashboard in cmd style
function renderCmdDashboard(){
  const parts=getParts();
  const asms=getAsms();
  const body=$('cmdBody');
  
  if(parts.length===0){
    body.innerHTML='<div class="cmd-line muted">No parts in project. Add assemblies and parts to see analysis.</div>';
    updateCmdSuggestions([]);
    return;
  }
  
  const pct=calcOverallProgress();
  const daysLeft=getDaysLeft();
  const byStatus={};
  parts.forEach(p=>byStatus[p.status]=(byStatus[p.status]||0)+1);
  
  let html='';
  html+='<div class="cmd-line">C:\\PROJECT\\'+currentProjectName.toUpperCase().replace(/\s+/g,'-')+'&gt;</div>';
  html+='<div class="cmd-line"></div>';
  html+='<div class="cmd-line">Project: <span class="cmd-link" onclick="window.scrollTo(0,0)">"'+esc(currentProjectName)+'"</span> - '+pct+'% complete</div>';
  html+='<div class="cmd-line">â”œâ”€ '+(byStatus.waiting||0)+' waiting, '+(byStatus['to-order']||0)+' to-order, '+(byStatus.ordered||0)+' ordered</div>';
  html+='<div class="cmd-line">â”œâ”€ '+(byStatus.arrived||0)+' arrived, '+(byStatus.installed||0)+' installed</div>';
  if(daysLeft!==null)html+='<div class="cmd-line">â””â”€ '+daysLeft+' days until deadline</div>';
  html+='<div class="cmd-line"></div>';
  
  // Insights as text with clickable actions
  const insights=generateAIInsights();
  window._cmdInsights=insights; // Store for click handlers
  if(insights.length>0&&!(insights.length===1&&insights[0].title==='All systems nominal')){
    insights.forEach((ins,idx)=>{
      if(ins.title==='All systems nominal')return;
      const colorClass=ins.level==='critical'?'error':ins.level==='warning'?'warning':ins.level==='success'?'success':'info';
      let line='[!] '+ins.title;
      if(ins.action&&ins.handler){
        line+=' <a class="cmd-link" href="#" onclick="window._cmdInsights['+idx+'].handler();return false;">'+ins.action+'</a>';
      }
      html+='<div class="cmd-line '+colorClass+'">'+line+'</div>';
      if(ins.desc)html+='<div class="cmd-line muted">    '+ins.desc+'</div>';
    });
  }else{
    html+='<div class="cmd-line success">[OK] All systems nominal</div>';
  }
  
  html+='<div class="cmd-line"></div>';
  html+='<div class="cmd-line muted">Click a suggestion or type your own question.</div>';
  
  body.innerHTML=html;
  body.scrollTop=body.scrollHeight;
  
  // Generate context-aware suggestions
  updateCmdSuggestions(generateCmdSuggestions(byStatus,daysLeft,insights));
}

function generateCmdSuggestions(byStatus,daysLeft,insights){
  const suggestions=[];
  
  // Always include general status
  suggestions.push('Give me a project status summary');
  
  // Based on current state
  if((byStatus['to-order']||0)>0){
    suggestions.push('Which parts should I order first?');
  }
  if((byStatus.ordered||0)>0){
    suggestions.push('Any parts arriving soon?');
  }
  if((byStatus.arrived||0)>0){
    suggestions.push('What parts are ready to install?');
  }
  if((byStatus.waiting||0)>3){
    suggestions.push('Why are so many parts waiting?');
  }
  
  // Based on insights
  const hasOverdue=insights.some(i=>i.title.includes('overdue')||i.title.includes('>5 days')||i.title.includes('>7d'));
  if(hasOverdue){
    suggestions.push('What are the biggest blockers?');
  }
  
  // Deadline-based
  if(daysLeft!==null&&daysLeft<14){
    suggestions.push('Will we meet the deadline?');
  }
  
  // Limit to 5 suggestions
  return suggestions.slice(0,5);
}

function updateCmdSuggestions(suggestions){
  const container=$('cmdSuggestions');
  if(!container)return;
  if(!suggestions||suggestions.length===0){
    container.innerHTML='';
    return;
  }
  container.innerHTML=suggestions.map(s=>
    '<button class="cmd-suggestion" onclick="window.askCmdQuestion(\''+esc(s).replace(/'/g,"\\'")+'\')">'+esc(s)+'</button>'
  ).join('');
}

window.askCmdQuestion=function(question){
  $('cmdInput').value=question;
  handleCmdAsk();
};

function addCmdLine(text,className){
  const body=$('cmdBody');
  const line=document.createElement('div');
  line.className='cmd-line'+(className?' '+className:'');
  line.innerHTML=text;
  body.appendChild(line);
  body.scrollTop=body.scrollHeight;
}

async function handleCmdAsk(){
  const input=$('cmdInput');
  const question=input.value.trim();
  if(!question)return;
  
  // Hide suggestions after first question
  const suggestions=$('cmdSuggestions');
  if(suggestions)suggestions.style.display='none';
  
  addCmdLine('&gt; '+esc(question),'prompt');
  input.value='';
  addCmdLine('Thinking...','muted');
  
  try{
    const response=await askAI(question);
    
    // Remove "Thinking..."
    const body=$('cmdBody');
    if(body.lastChild)body.removeChild(body.lastChild);
    
    // Format response for readability
    formatCmdResponse(response);
    addCmdLine('','');
  }catch(e){
    console.error('handleCmdAsk error:',e);
    const body=$('cmdBody');
    if(body.lastChild)body.removeChild(body.lastChild);
    addCmdLine('Error: Unable to get response. Please try again.','error');
  }
}

function formatCmdResponse(html){
  const tempDiv=document.createElement('div');
  tempDiv.innerHTML=html;
  
  // Check for ai-prose wrapper
  const prose=tempDiv.querySelector('.ai-prose');
  const content=prose||tempDiv;
  
  // Convert AI links to cmd-link style but preserve onclick handlers
  content.querySelectorAll('a.ai-part-link,a.ai-asm-link').forEach(link=>{
    link.className='cmd-link';
  });
  
  // Convert action buttons to cmd style
  content.querySelectorAll('.ai-action-btn').forEach(btn=>{
    btn.className='cmd-suggestion';
    btn.style.marginTop='4px';
    btn.style.display='inline-block';
  });
  
  // Try to parse structured content
  const paragraphs=content.querySelectorAll('p');
  const lists=content.querySelectorAll('ul,ol');
  const headings=content.querySelectorAll('h1,h2,h3,h4,h5,h6');
  
  addCmdLine('');
  
  // Helper to get HTML content preserving links
  function getContentWithLinks(node){
    // Clone node to avoid modifying original
    const clone=node.cloneNode(true);
    // Convert any remaining ai links
    clone.querySelectorAll('a').forEach(a=>{
      a.className='cmd-link';
    });
    return clone.innerHTML;
  }
  
  if(paragraphs.length>0||lists.length>0||headings.length>0){
    // Process structured HTML
    const processNode=(node)=>{
      if(node.nodeType===Node.TEXT_NODE){
        const text=node.textContent.trim();
        if(text)addCmdLine(text);
      }else if(node.nodeName==='P'){
        const hasLinks=node.querySelector('a');
        const hasButtons=node.querySelector('button,.ai-action-btn');
        if(hasLinks||hasButtons){
          // Preserve HTML for links
          addCmdLine('  '+getContentWithLinks(node));
        }else{
          const text=node.textContent.trim();
          if(text){
            const strong=node.querySelector('strong,b');
            if(strong&&node.textContent.startsWith(strong.textContent)){
              addCmdLine('â–º '+text,'info');
            }else{
              addCmdLine('  '+text);
            }
          }
        }
      }else if(node.nodeName==='UL'||node.nodeName==='OL'){
        node.querySelectorAll('li').forEach(li=>{
          const hasLinks=li.querySelector('a');
          if(hasLinks){
            addCmdLine('  â€¢ '+getContentWithLinks(li));
          }else{
            const text=li.textContent.trim();
            const strong=li.querySelector('strong,b');
            if(strong){
              addCmdLine('  â€¢ '+strong.textContent,'info');
              const rest=text.replace(strong.textContent,'').trim();
              if(rest)addCmdLine('    '+rest,'muted');
            }else{
              addCmdLine('  â€¢ '+text);
            }
          }
        });
      }else if(node.nodeName.match(/^H[1-6]$/)){
        addCmdLine('');
        addCmdLine('â•â•â• '+node.textContent.trim().toUpperCase()+' â•â•â•','warning');
        addCmdLine('');
      }else if(node.nodeName==='STRONG'||node.nodeName==='B'){
        addCmdLine('â–º '+node.textContent.trim(),'info');
      }else if(node.nodeName==='DIV'){
        const hasLinks=node.querySelector('a');
        const hasButtons=node.querySelector('button,.ai-action-btn');
        if(hasLinks||hasButtons){
          addCmdLine(getContentWithLinks(node));
        }else{
          node.childNodes.forEach(processNode);
        }
      }else if(node.nodeName==='BR'){
        addCmdLine('');
      }else if(node.nodeName==='A'){
        // Standalone link
        const clone=node.cloneNode(true);
        clone.className='cmd-link';
        addCmdLine(clone.outerHTML);
      }else if(node.nodeName==='BUTTON'){
        // Action button
        const clone=node.cloneNode(true);
        clone.className='cmd-suggestion';
        clone.style.cssText='margin-top:4px;display:inline-block';
        addCmdLine(clone.outerHTML);
      }
    };
    
    content.childNodes.forEach(processNode);
  }else{
    // Plain text fallback - but check for links first
    const hasLinks=content.querySelector('a');
    if(hasLinks){
      addCmdLine('  '+getContentWithLinks(content));
    }else{
      let text=content.textContent||content.innerText||'';
      text=text.replace(/\s+/g,' ').trim();
      
      const sentences=text.split(/(?<=[.!?])\s+/);
      let lineBuffer='';
      
      sentences.forEach(sentence=>{
        sentence=sentence.trim();
        if(!sentence)return;
        
        if(sentence.match(/^\d+\./)||sentence.match(/^[-â€¢*]/)){
          if(lineBuffer){
            addCmdLine('  '+lineBuffer);
            lineBuffer='';
          }
          addCmdLine('  '+sentence);
          return;
        }
        
        if(lineBuffer.length+sentence.length>70){
          if(lineBuffer)addCmdLine('  '+lineBuffer);
          lineBuffer=sentence;
        }else{
          lineBuffer+=(lineBuffer?' ':'')+sentence;
        }
      });
      
      if(lineBuffer)addCmdLine('  '+lineBuffer);
    }
  }
  
  addCmdLine('');
}

async function handleCmdTell(){
  // Hide suggestions after first question
  const suggestions=$('cmdSuggestions');
  if(suggestions)suggestions.style.display='none';
  
  addCmdLine('&gt; Tell me','prompt');
  addCmdLine('Analyzing project...','muted');
  
  try{
    const response=await generateAIReport('straight');
    
    // Remove "Analyzing..."
    const body=$('cmdBody');
    if(body.lastChild)body.removeChild(body.lastChild);
    
    // Convert HTML response to cmd-style text
    const tempDiv=document.createElement('div');
    tempDiv.innerHTML=response;
    
    // Helper to get content preserving links
    function getContentWithLinks(node){
      const clone=node.cloneNode(true);
      clone.querySelectorAll('a').forEach(a=>{
        a.className='cmd-link';
      });
      clone.querySelectorAll('.ai-action-btn').forEach(btn=>{
        btn.className='cmd-suggestion';
        btn.style.cssText='margin:4px 4px 0 0;display:inline-block';
      });
      return clone.innerHTML;
    }
    
    // Process sections
    const sections=tempDiv.querySelectorAll('.ai-report-section');
    if(sections.length>0){
      addCmdLine('');
      sections.forEach(section=>{
        const header=section.querySelector('.ai-report-header');
        if(header){
          addCmdLine('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”','muted');
          addCmdLine('â”‚  '+header.textContent.trim().padEnd(39)+'â”‚','info');
          addCmdLine('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜','muted');
        }
        section.querySelectorAll('.ai-report-item').forEach(item=>{
          const text=item.querySelector('.ai-report-text');
          if(text){
            const hasLinks=text.querySelector('a');
            const level=item.classList.contains('critical')?'error':
                        item.classList.contains('warning')?'warning':
                        item.classList.contains('success')?'success':'';
            
            if(hasLinks){
              // Preserve HTML with links
              addCmdLine('  â€¢ '+getContentWithLinks(text),level);
            }else{
              const strong=text.querySelector('strong');
              const meta=text.querySelector('.ai-report-meta');
              let mainText=strong?strong.textContent:'';
              addCmdLine('  â€¢ '+mainText,level);
              if(meta)addCmdLine('    '+meta.textContent,'muted');
            }
          }
        });
        addCmdLine('');
      });
    }else{
      // Use the general formatter
      formatCmdResponse(response);
    }
    addCmdLine('');
  }catch(e){
    console.error('handleCmdTell error:',e);
    const body=$('cmdBody');
    if(body.lastChild)body.removeChild(body.lastChild);
    addCmdLine('Error: Unable to get response. Please try again.','error');
  }
}

// Event listeners for cmd window
function initCmdWindowHandlers(){
  const closeBtn=$('cmdClose');
  const minBtn=$('cmdMinimize');
  const minBar=$('cmdMinimized');
  const askBtn=$('cmdAsk');
  const tellBtn=$('cmdTell');
  const input=$('cmdInput');
  const modelSel=$('cmdModelSelect');
  
  if(closeBtn)closeBtn.addEventListener('click',closeCmdWindow);
  if(minBtn)minBtn.addEventListener('click',minimizeCmdWindow);
  if(minBar)minBar.addEventListener('click',restoreCmdWindow);
  if(askBtn)askBtn.addEventListener('click',handleCmdAsk);
  if(tellBtn)tellBtn.addEventListener('click',handleCmdTell);
  if(input)input.addEventListener('keydown',e=>{if(e.key==='Enter')handleCmdAsk()});
  if(modelSel)modelSel.addEventListener('change',function(){selectedAIModel=this.value});
}
initCmdWindowHandlers();

// ============================================
// INSIGHTS PANEL
// ============================================
function openInsightsPanel(){
  const panel=$('insightsPanel');
  const btn=$('insightsBtn');
  const rect=btn.getBoundingClientRect();
  panel.style.top=Math.min(rect.bottom+8,window.innerHeight-panel.offsetHeight-20)+'px';
  panel.style.right=(window.innerWidth-rect.right)+'px';
  renderInsightsPanel();
  // Sync model dropdown with global selection
  if($('insightsAIModel'))$('insightsAIModel').value=selectedAIModel;
  panel.classList.add('open');
  $('popoverBackdrop').classList.add('active');
}
function closeInsightsPanel(){
  $('insightsPanel').classList.remove('open','ai-mode');
  $('insightsAIBtn').classList.remove('active');
  $('popoverBackdrop').classList.remove('active');
}
$('insightsBtn').onclick=()=>openInsightsPanel();
$('insightsClose').onclick=()=>closeInsightsPanel();
// Close insights panel when clicking outside
document.addEventListener('click',(e)=>{
  const panel=$('insightsPanel');
  if(!panel.classList.contains('open'))return;
  if(panel.contains(e.target))return;
  if(e.target.closest('#insightsBtn'))return;
  closeInsightsPanel();
});

// Insights AI Chat - Command Prompt Style
function toggleInsightsAI(){
  const panel=$('insightsPanel');
  const btn=$('insightsAIBtn');
  panel.classList.toggle('ai-mode');
  btn.classList.toggle('active');
}

// Navigate to part by name from AI chat
window.goToPartByName=function(name){
  const parts=data.filter(d=>!d.isAsm&&!d._deletedAt);
  // Try exact match first, then case-insensitive, then partial
  let part=parts.find(p=>p.name===name);
  if(!part)part=parts.find(p=>p.name&&p.name.toLowerCase()===name.toLowerCase());
  if(!part)part=parts.find(p=>p.name&&p.name.toLowerCase().includes(name.toLowerCase()));
  if(!part)part=parts.find(p=>p.name&&name.toLowerCase().includes(p.name.toLowerCase()));
  if(part){
    closeInsightsPanel();
    // Switch to list view and highlight part (without showing AI Console)
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelector('[data-tab="list"]').classList.add('active');
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    $('listPanel').classList.add('active');
    if(part.parentId)expanded[String(part.parentId)]=true;
    render();
    setTimeout(()=>{
      const row=document.querySelector('[data-part-id="'+part.id+'"]');
      if(row){
        row.classList.add('ai-highlight');
        row.scrollIntoView({behavior:'smooth',block:'center'});
        setTimeout(()=>row.classList.remove('ai-highlight'),5000);
      }
    },100);
  }
};

function formatInsightsAIResponse(text){
  if(!text)return'';
  // Build part name lookup for linking
  const partNames=data.filter(d=>!d.isAsm&&!d._deletedAt&&d.name).map(p=>p.name).sort((a,b)=>b.length-a.length);

  let html=text
    // Headers (must be before other replacements)
    .replace(/^### (.+)$/gm,'</p><h4>$1</h4><p>')
    .replace(/^## (.+)$/gm,'</p><h3>$1</h3><p>')
    .replace(/^# (.+)$/gm,'</p><h2>$1</h2><p>')
    // Bold
    .replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
    // Bullet points
    .replace(/^[-â€¢]\s+(.+)$/gm,'<li>$1</li>')
    // Numbered lists
    .replace(/^\d+\.\s+(.+)$/gm,'<li>$1</li>')
    // Paragraphs
    .replace(/\n\n+/g,'</p><p>')
    .replace(/\n/g,'<br>');
  if(html&&!html.startsWith('<'))html='<p>'+html;
  if(html&&!html.endsWith('</p>')&&!html.endsWith('</li>')&&!html.endsWith('</h2>')&&!html.endsWith('</h3>')&&!html.endsWith('</h4>'))html+='</p>';
  html=html.replace(/(<li>[\s\S]*?<\/li>)+/g,'<ul>$&</ul>');
  // Remove <br> tags inside lists
  html=html.replace(/<ul>([\s\S]*?)<\/ul>/g,(m,inner)=>'<ul>'+inner.replace(/<br>/g,'')+'</ul>');
  html=html.replace(/<p>\s*<\/p>/g,'');
  html=html.replace(/<p><\/p>/g,'');

  // Link part names (after HTML structure is built, avoid replacing inside tags)
  partNames.forEach(name=>{
    if(name.length<3)return; // Skip very short names
    const escaped=name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const regex=new RegExp('(?<!<[^>]*)\\b('+escaped+')\\b(?![^<]*>)','gi');
    html=html.replace(regex,'<span class="ai-part-link" onclick="goToPartByName(\''+name.replace(/'/g,"\\'")+'\')">$1</span>');
  });

  return html;
}

function appendInsightsOutput(prompt,model,isThinking=false){
  const output=$('insightsAIOutput');
  // User message bubble
  output.innerHTML+=`<div class="ai-user-msg">${esc(prompt)}</div>`;
  // AI response container
  let html=`<div class="ai-response" data-model="${model}">`;
  if(isThinking){
    html+=`<span class="insights-ai-thinking">Thinking</span>`;
  }
  html+=`</div>`;
  output.innerHTML+=html;
  output.scrollTop=output.scrollHeight;
}

function updateLastInsightsResponse(response,actualModel){
  const output=$('insightsAIOutput');
  const lastResponse=output.querySelector('.ai-response:last-child');
  if(lastResponse){
    lastResponse.innerHTML=formatInsightsAIResponse(response);
    output.scrollTop=output.scrollHeight;
  }
}

async function insightsAIAsk(){
  const input=$('insightsAIInput');
  const question=input.value.trim();
  if(!question)return;
  input.value='';

  const btn=$('insightsAIBtn');
  const model=$('insightsAIModel').value;
  btn.classList.add('spinning');
  appendInsightsOutput(question,model,true);

  try{
    const context=buildFullProjectContext();
    context.question=question;
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({
      mode:'ask',
      projectContext:context,
      question,
      maxChars:2000,
      style:'natural',
      model
    });
    const actualModel=result.data?.model||model;
    updateLastInsightsResponse(result.data?.success?result.data.content:'Sorry, I couldn\'t process that request.',actualModel);
  }catch(e){
    console.error('AI error:',e);
    updateLastInsightsResponse('Something went wrong. Please try again.',model);
  }
  btn.classList.remove('spinning');
}

async function insightsAISummary(){
  const btn=$('insightsAIBtn');
  const model=$('insightsAIModel').value;
  btn.classList.add('spinning');
  appendInsightsOutput('Give me a project status summary',model,true);

  try{
    const context=buildFullProjectContext();
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({
      mode:'tell',
      projectContext:context,
      maxChars:2000,
      style:'natural',
      model
    });
    const actualModel=result.data?.model||model;
    updateLastInsightsResponse(result.data?.success?result.data.content:'Sorry, I couldn\'t generate the summary.',actualModel);
  }catch(e){
    console.error('AI error:',e);
    updateLastInsightsResponse('Something went wrong. Please try again.',model);
  }
  btn.classList.remove('spinning');
}

function clearInsightsAI(){
  $('insightsAIOutput').innerHTML='';
}

$('insightsAIBtn').onclick=toggleInsightsAI;
$('insightsAIAskBtn').onclick=insightsAIAsk;
$('insightsAISummaryBtn').onclick=insightsAISummary;
$('insightsAIClear').onclick=clearInsightsAI;
$('insightsAIInput').onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();insightsAIAsk();}};

function renderInsightsPanel(){
  const parts=getParts();
  const asms=getAsms();
  const total=parts.length;
  if(total===0){
    $('insightsBody').innerHTML='<div class="insights-empty">Add parts to see insights</div>';
    return;
  }

  // Calculate all metrics
  const timeline=calcTimelineForecast(parts);
  const bottlenecks=calcBottlenecks(parts);
  const suppliers=calcSupplierScorecard(parts);
  const alerts=calcSmartAlerts(parts,asms);
  const quality=calcDataQuality(parts,asms);
  const upcoming=calcUpcomingWeek(parts);
  const risks=calcRiskFlags(parts,asms);
  const velocity=calcVelocityTrend();

  let html='<div class="insights-grid">';

  // Card 1: Timeline Forecast
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><div class="insights-card-title">Forecast</div></div>';
  html+='<div class="insights-card-body">';
  // Velocity comparison (% per day)
  if(timeline.requiredVelocity!==null){
    const velRatio=timeline.velocity/Math.max(0.01,timeline.requiredVelocity);
    const velStatus=velRatio>=1.2?'good':velRatio>=0.9?'warning':'critical';
    html+='<div class="insights-velocity-compare">';
    html+='<div class="insights-vel-item"><div class="insights-vel-value">'+timeline.velocity.toFixed(1)+'</div><div class="insights-vel-label">Current</div></div>';
    html+='<div class="insights-vel-vs '+velStatus+'">'+(velRatio>=1?'âœ“':'âš ')+'</div>';
    html+='<div class="insights-vel-item"><div class="insights-vel-value">'+timeline.requiredVelocity.toFixed(1)+'</div><div class="insights-vel-label">Required</div></div>';
    html+='</div>';
    html+='<div class="insights-metric-label" style="margin-top:4px">'+timeline.remaining.toFixed(0)+'% remaining Â· %/day</div>';
  }else{
    html+='<div class="insights-metric"><span class="insights-metric-value">'+timeline.velocity.toFixed(1)+'</span><span class="insights-metric-unit">%/day</span></div>';
    html+='<div class="insights-metric-label">'+timeline.remaining.toFixed(0)+'% remaining</div>';
  }
  html+='<div class="insights-forecast">';
  html+='<div class="insights-forecast-item"><div class="insights-forecast-date">'+timeline.optimistic+'</div><div class="insights-forecast-label">Optimistic</div></div>';
  html+='<div class="insights-forecast-item highlight"><div class="insights-forecast-date">'+timeline.likely+'</div><div class="insights-forecast-label">Most Likely</div></div>';
  html+='<div class="insights-forecast-item"><div class="insights-forecast-date">'+timeline.conservative+'</div><div class="insights-forecast-label">Conservative</div></div>';
  html+='</div>';
  if(timeline.deadline){
    const dl=timeline.deadline;
    const statusCls=dl.status==='good'?'green':dl.status==='tight'?'yellow':'red';
    const statusText=dl.daysAhead>0?(dl.daysAhead+' days buffer'):(Math.abs(dl.daysAhead)+' days late');
    html+='<div class="insights-deadline-compare"><span class="insights-deadline-label">Deadline: '+dl.date+'</span><span class="insights-deadline-status '+statusCls+'">'+statusText+'</span></div>';
  }
  html+='</div></div>';

  // Card 2: Smart Alerts
  const alertBadge=alerts.critical>0?'critical':alerts.warning>0?'warning':'good';
  const alertCount=alerts.critical+alerts.warning+alerts.info;
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><div class="insights-card-title">Alerts</div><span class="insights-card-badge '+alertBadge+'">'+alertCount+'</span></div>';
  html+='<div class="insights-card-body"><div class="insights-list">';
  if(alerts.items.length===0){
    html+='<div class="insights-empty">No alerts</div>';
  }else{
    // Sort by severity: red (critical) > yellow (warning) > blue (info)
    const severityOrder={red:0,yellow:1,blue:2};
    alerts.items.sort((a,b)=>(severityOrder[a.level]||3)-(severityOrder[b.level]||3)).slice(0,5).forEach(a=>{
      html+='<div class="insights-list-item" onclick="window.highlightPart(\''+a.partId+'\')"><span class="insights-list-dot '+a.level+'"></span><span class="insights-list-text">'+esc(a.text)+'</span><span class="insights-list-meta">'+esc(a.meta)+'</span></div>';
    });
  }
  html+='</div></div></div>';

  // Card 3: Bottleneck Detection
  html+='<div class="insights-card">';
  const maxDwell=Math.max(...bottlenecks.map(b=>b.days),1);
  const bottleneckStage=bottlenecks.length>0?bottlenecks.reduce((a,b)=>a.days>b.days?a:b).stage:null;
  html+='<div class="insights-card-header"><div class="insights-card-title">Stage Dwell Time</div>';
  if(bottleneckStage && maxDwell>3)html+='<span class="insights-card-badge critical">'+esc(bottleneckStage)+'</span>';
  html+='</div>';
  html+='<div class="insights-card-body"><div class="insights-stage-bars">';
  bottlenecks.forEach(b=>{
    const pct=Math.round(b.days/maxDwell*100);
    const cls=b.days>10?'slow':b.days>5?'medium':'fast';
    const isBottleneck=b.stage===bottleneckStage && b.days>3;
    html+='<div class="insights-stage-row'+(isBottleneck?' bottleneck':'')+'"><span class="insights-stage-name">'+esc(b.stage)+'</span><div class="insights-stage-bar"><div class="insights-stage-fill '+cls+'" style="width:'+pct+'%"></div><span class="insights-stage-value">'+b.days.toFixed(1)+'d</span></div></div>';
  });
  html+='</div></div></div>';

  // Card 4: Data Quality
  const qualityBadge=quality.score>=90?'good':quality.score>=70?'warning':'critical';
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><div class="insights-card-title">Data Quality</div><span class="insights-card-badge '+qualityBadge+'">'+quality.score+'%</span></div>';
  html+='<div class="insights-card-body">';
  html+='<div class="insights-bar"><div class="insights-bar-fill '+(quality.score>=90?'green':quality.score>=70?'yellow':'red')+'" style="width:'+quality.score+'%"></div></div>';
  html+='<div class="insights-list">';
  quality.issues.slice(0,3).forEach(i=>{
    html+='<div class="insights-list-item"><span class="insights-list-dot yellow"></span><span class="insights-list-text">'+esc(i)+'</span></div>';
  });
  html+='</div></div></div>';

  // Card 5: Upcoming Week
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><div class="insights-card-title">Upcoming Arrivals</div>';
  if(upcoming.total>0)html+='<span class="insights-card-badge">'+upcoming.total+'</span>';
  html+='</div>';
  html+='<div class="insights-card-body">';
  if(upcoming.total===0){
    html+='<div class="insights-empty">No arrivals expected this week</div>';
  }else{
    html+='<div class="insights-week-grid">';
    upcoming.days.forEach(d=>{
      const hasArrivals=d.count>0;
      html+='<div class="insights-week-day'+(hasArrivals?' has-arrivals':'')+'" title="'+(d.arrivals.map(a=>a.name).join(', ')||'None')+'">';
      html+='<div class="insights-week-count">'+(d.count||'â€“')+'</div>';
      html+='<div class="insights-week-label">'+d.label+'</div>';
      html+='</div>';
    });
    html+='</div>';
  }
  html+='</div></div>';

  // Card 6: Risk Flags
  const riskBadge=risks.critical>0?'critical':risks.warning>0?'warning':'good';
  const riskCount=risks.critical+risks.warning;
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><div class="insights-card-title">Risks</div>';
  if(riskCount>0)html+='<span class="insights-card-badge '+riskBadge+'">'+riskCount+'</span>';
  html+='</div>';
  html+='<div class="insights-card-body"><div class="insights-list">';
  if(risks.items.length===0){
    html+='<div class="insights-empty">No risks identified</div>';
  }else{
    risks.items.slice(0,5).forEach(r=>{
      const dotCls=r.level==='critical'?'red':'yellow';
      html+='<div class="insights-list-item" onclick="window.highlightPart(\''+r.partId+'\')"><span class="insights-list-dot '+dotCls+'"></span><span class="insights-list-text">'+esc(r.text)+'</span></div>';
    });
  }
  html+='</div></div></div>';

  html+='</div>';
  $('insightsBody').innerHTML=html;
}

// Timeline Forecast Calculation (uses %/day velocity, consistent with Progress Chart)
function calcTimelineForecast(parts){
  const currentPct=calcOverallProgress();
  const remaining=100-currentPct;

  // Calculate velocity from history (% per day)
  let velocity=0;
  if(history.length>=2){
    const recent=history.slice(-14);
    if(recent.length>=2){
      const first=recent[0],last=recent[recent.length-1];
      const daysDiff=Math.max(1,(new Date(last.date)-new Date(first.date))/86400000);
      const progressDiff=(last.pct||0)-(first.pct||0);
      velocity=progressDiff/daysDiff;
    }
  }
  // Fallback: estimate from current progress / days elapsed
  if(velocity<=0&&currentPct>0){
    const elapsed=getDaysElapsed();
    velocity=elapsed>0?currentPct/elapsed:1;
  }
  if(velocity<=0)velocity=1;

  const daysToComplete=remaining/Math.max(0.1,velocity);
  const now=new Date();
  const formatForecast=days=>{
    const d=new Date(now.getTime()+days*86400000);
    return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  };

  // Calculate deadline status and required velocity
  let deadlineStatus=null;
  let requiredVelocity=null;
  if(projectDates.end){
    const deadline=new Date(projectDates.end);
    const likelyDate=new Date(now.getTime()+daysToComplete*86400000);
    const daysAhead=Math.round((deadline-likelyDate)/86400000);
    const daysUntilDeadline=Math.max(1,(deadline-now)/86400000);
    // Required velocity = remaining % / days until deadline
    requiredVelocity=remaining/daysUntilDeadline;
    deadlineStatus={
      date:deadline.toLocaleDateString('en-US',{month:'short',day:'numeric'}),
      daysAhead:daysAhead,
      status:daysAhead>=7?'good':daysAhead>=0?'tight':'late'
    };
  }

  return {
    velocity:velocity,
    requiredVelocity:requiredVelocity,
    remaining:remaining,
    optimistic:formatForecast(daysToComplete*0.7),
    likely:formatForecast(daysToComplete),
    conservative:formatForecast(daysToComplete*1.4),
    deadline:deadlineStatus
  };
}

// Bottleneck Detection
function calcBottlenecks(parts){
  const stages=['Waiting','To-Order','Ordered','Arrived','Tested','Configured'];
  const stageKeys=['waiting','to-order','ordered','arrived','tested','configured'];
  const stageDwell={};
  stageKeys.forEach(s=>stageDwell[s]={total:0,count:0});

  parts.forEach(p=>{
    if(p.changedAt && p.status!=='installed'){
      const days=(Date.now()-p.changedAt)/86400000;
      if(stageDwell[p.status]){
        stageDwell[p.status].total+=days;
        stageDwell[p.status].count++;
      }
    }
  });

  return stageKeys.map((key,i)=>({
    stage:stages[i],
    days:stageDwell[key].count>0?stageDwell[key].total/stageDwell[key].count:0
  })).filter(b=>b.days>0);
}

// Supplier Scorecard
function calcSupplierScorecard(parts){
  const suppliers={};
  parts.forEach(p=>{
    const mfr=p.mfr||'Unknown';
    if(!suppliers[mfr])suppliers[mfr]={name:mfr,onTime:0,late:0,totalLead:0,count:0};
    suppliers[mfr].count++;
    if(p.expectedArrival&&p.actualArrival){
      const expected=new Date(p.expectedArrival);
      const actual=new Date(p.actualArrival);
      if(actual<=expected)suppliers[mfr].onTime++;
      else suppliers[mfr].late++;
      const lead=(actual-new Date(p.orderedAt||p.createdAt||Date.now()))/86400000;
      if(lead>0)suppliers[mfr].totalLead+=lead;
    }
  });

  return Object.values(suppliers)
    .filter(s=>s.count>=2 && s.name!=='Unknown')
    .map(s=>({
      name:s.name,
      otd:s.onTime+s.late>0?Math.round(s.onTime/(s.onTime+s.late)*100):100,
      lead:s.totalLead>0?Math.round(s.totalLead/s.count):0,
      count:s.count
    }))
    .sort((a,b)=>b.count-a.count)
    .slice(0,10);
}

// Smart Alerts
function calcSmartAlerts(parts,asms){
  const alerts={critical:0,warning:0,info:0,items:[]};
  const now=Date.now();
  const day=86400000;

  // Overdue parts (ordered >30 days)
  parts.filter(p=>p.status==='ordered'&&p.changedAt&&(now-p.changedAt)>30*day).forEach(p=>{
    alerts.critical++;
    alerts.items.push({level:'red',text:p.name+' ordered >30 days ago',meta:'Overdue',partId:p.id});
  });

  // Stuck parts (>7 days in same stage)
  parts.filter(p=>p.status!=='installed'&&p.changedAt&&(now-p.changedAt)>7*day&&p.status!=='ordered').forEach(p=>{
    alerts.warning++;
    const days=Math.round((now-p.changedAt)/day);
    alerts.items.push({level:'yellow',text:p.name+' stuck '+days+' days',meta:SLABELS[p.status]||p.status,partId:p.id});
  });

  // Missing ETA
  parts.filter(p=>p.status==='ordered'&&!p.expectedArrival).forEach(p=>{
    alerts.warning++;
    alerts.items.push({level:'yellow',text:p.name+' missing ETA',meta:'No ETA',partId:p.id});
  });

  // Ready to advance
  parts.filter(p=>(p.status==='arrived'||p.status==='tested'||p.status==='configured')&&p.changedAt&&(now-p.changedAt)>2*day).forEach(p=>{
    alerts.info++;
    alerts.items.push({level:'blue',text:p.name+' ready to advance',meta:'Ready',partId:p.id});
  });

  return alerts;
}

// Data Quality Score
function calcDataQuality(parts,asms){
  const issues=[];
  let score=100;

  const noCode=parts.filter(p=>!p.code).length;
  const noMfr=parts.filter(p=>!p.mfr).length;
  const noAssignee=parts.filter(p=>!p.assignee).length;
  const noEta=parts.filter(p=>p.status==='ordered'&&!p.expectedArrival).length;

  if(noCode>0){issues.push(noCode+' parts without item code');score-=Math.min(15,noCode*2);}
  if(noMfr>0){issues.push(noMfr+' parts without manufacturer');score-=Math.min(10,noMfr);}
  if(noAssignee>0){issues.push(noAssignee+' parts without assignee');score-=Math.min(10,noAssignee);}
  if(noEta>0){issues.push(noEta+' ordered parts without ETA');score-=Math.min(15,noEta*3);}

  if(!projectDates.start)issues.push('Project start date not set');
  if(!projectDates.end)issues.push('Project end date not set');
  if(!projectDates.start||!projectDates.end)score-=10;

  return {score:Math.max(0,score),issues};
}

// Velocity Trend
function calcVelocityTrend(){
  const data=[],labels=[];
  if(history.length<2)return {data,labels,trend:0};

  const recent=history.slice(-14);
  recent.forEach((h,i)=>{
    if(i>0){
      const prev=recent[i-1];
      // Use pct (progress %) - history stores {date, pct}
      const diff=(h.pct||0)-(prev.pct||0);
      data.push(Math.max(0,diff));
      labels.push(new Date(h.date).toLocaleDateString('en-US',{month:'short',day:'numeric'}));
    }
  });

  // Calculate trend (this week vs last week)
  let trend=0;
  if(data.length>=7){
    const thisWeek=data.slice(-7).reduce((a,b)=>a+b,0);
    const lastWeek=data.slice(-14,-7).reduce((a,b)=>a+b,0);
    if(lastWeek>0)trend=Math.round((thisWeek-lastWeek)/lastWeek*100);
  }

  return {data,labels,trend};
}

// Upcoming Week - arrivals expected in next 7 days
function calcUpcomingWeek(parts){
  const days=[];
  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const now=new Date();
  const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());

  // Initialize 7 days
  for(let i=0;i<7;i++){
    const d=new Date(today.getTime()+i*86400000);
    days.push({
      date:d,
      label:i===0?'Today':i===1?'Tomorrow':dayNames[d.getDay()],
      dateStr:d.toISOString().split('T')[0],
      arrivals:[],
      count:0
    });
  }

  // Find parts with expectedArrival in this week
  parts.filter(p=>p.status==='ordered'&&p.expectedArrival).forEach(p=>{
    const eta=new Date(p.expectedArrival);
    const etaDate=new Date(eta.getFullYear(),eta.getMonth(),eta.getDate());
    const dayIdx=Math.round((etaDate-today)/86400000);
    if(dayIdx>=0&&dayIdx<7){
      days[dayIdx].arrivals.push({id:p.id,name:p.name});
      days[dayIdx].count++;
    }
  });

  const total=days.reduce((s,d)=>s+d.count,0);
  return {days,total};
}

// Risk Flags - identify potential problems
function calcRiskFlags(parts,asms){
  const risks=[];
  const now=Date.now();
  const day=86400000;

  // 1. Long lead items not yet ordered (in waiting/to-order for >14 days)
  parts.filter(p=>(p.status==='waiting'||p.status==='to-order')&&p.changedAt&&(now-p.changedAt)>14*day).forEach(p=>{
    risks.push({level:'warning',type:'not-ordered',text:p.name+' not ordered ('+Math.round((now-p.changedAt)/day)+'d)',partId:p.id});
  });

  // 2. Ordered parts with no ETA
  parts.filter(p=>p.status==='ordered'&&!p.expectedArrival).forEach(p=>{
    const days=p.changedAt?Math.round((now-p.changedAt)/day):0;
    if(days>7){
      risks.push({level:'critical',type:'no-eta',text:p.name+' ordered '+days+'d ago, no ETA',partId:p.id});
    }
  });

  // 3. Overdue arrivals (expectedArrival passed but still ordered)
  parts.filter(p=>p.status==='ordered'&&p.expectedArrival).forEach(p=>{
    const eta=new Date(p.expectedArrival);
    const daysLate=Math.round((now-eta.getTime())/day);
    if(daysLate>0){
      risks.push({level:'critical',type:'overdue',text:p.name+' '+daysLate+'d overdue',partId:p.id});
    }
  });

  // 4. Parts blocking near-complete assemblies
  asms.forEach(asm=>{
    const children=parts.filter(p=>String(p.parentId)===String(asm.id));
    if(children.length>0){
      const installed=children.filter(p=>p.status==='installed').length;
      const pct=Math.round(installed/children.length*100);
      if(pct>=80&&pct<100){
        const blocking=children.filter(p=>p.status!=='installed'&&['waiting','to-order','ordered'].includes(p.status));
        blocking.forEach(p=>{
          risks.push({level:'warning',type:'blocking',text:p.name+' blocking '+asm.name+' ('+pct+'% done)',partId:p.id});
        });
      }
    }
  });

  // Sort by level (critical first)
  const levelOrder={critical:0,warning:1,info:2};
  risks.sort((a,b)=>(levelOrder[a.level]||2)-(levelOrder[b.level]||2));

  return {
    items:risks.slice(0,8),
    critical:risks.filter(r=>r.level==='critical').length,
    warning:risks.filter(r=>r.level==='warning').length
  };
}

// ============================================================
// MASTER SCHEDULE INSIGHTS
// ============================================================

function calcPortfolioHealth(projects){
  const now=new Date();
  const day=86400000;
  const results={total:0,onTrack:0,atRisk:0,behind:0,avgProgress:0,items:[]};

  projects.filter(p=>!p.archived).forEach(p=>{
    results.total++;
    const progress=p.progress||0;
    const endDate=p.endDate?new Date(p.endDate):null;
    const startDate=p.startDate?new Date(p.startDate):null;

    let status='on-track';
    let reason='';

    if(endDate&&startDate){
      const totalDays=Math.max(1,(endDate-startDate)/day);
      const elapsed=Math.max(0,(now-startDate)/day);
      const expectedProgress=Math.min(100,Math.round((elapsed/totalDays)*100));
      const daysLeft=Math.max(0,(endDate-now)/day);

      if(daysLeft<=0&&progress<100){
        status='behind';
        reason='Overdue';
      }else if(progress<expectedProgress-15){
        status='behind';
        reason=Math.round(expectedProgress-progress)+'% behind schedule';
      }else if(progress<expectedProgress-5||daysLeft<14){
        status='at-risk';
        reason=daysLeft<14?Math.round(daysLeft)+'d left':'Slightly behind';
      }
    }else if(!endDate){
      status='at-risk';
      reason='No deadline set';
    }

    if(status==='on-track')results.onTrack++;
    else if(status==='at-risk')results.atRisk++;
    else results.behind++;

    results.items.push({id:p.id,name:p.name,progress,status,reason,endDate:p.endDate});
  });

  results.avgProgress=results.total>0?Math.round(results.items.reduce((s,p)=>s+p.progress,0)/results.total):0;
  return results;
}

function calcDeadlineRisks(projects){
  const now=new Date();
  const day=86400000;
  const risks=[];

  projects.filter(p=>!p.archived&&p.endDate).forEach(p=>{
    const endDate=new Date(p.endDate);
    const startDate=p.startDate?new Date(p.startDate):null;
    const progress=p.progress||0;
    const daysLeft=Math.round((endDate-now)/day);

    // Check for deadline within 30 days
    if(daysLeft<=30&&daysLeft>0&&progress<100){
      const remainingWork=100-progress;
      const requiredDaily=remainingWork/daysLeft;

      // Estimate current velocity (rough)
      let velocity=0;
      if(startDate){
        const elapsed=Math.max(1,(now-startDate)/day);
        velocity=(progress/elapsed)*(7/5); // Working days adjustment
      }

      const level=daysLeft<=7?'critical':daysLeft<=14?'warning':'info';
      risks.push({
        id:p.id,
        name:p.name,
        daysLeft,
        progress,
        level,
        requiredDaily:requiredDaily.toFixed(1),
        currentVelocity:velocity.toFixed(1),
        velocityOk:velocity>=requiredDaily
      });
    }

    // Already overdue
    if(daysLeft<0&&progress<100){
      risks.push({
        id:p.id,
        name:p.name,
        daysLeft,
        progress,
        level:'critical',
        overdue:true
      });
    }
  });

  // Sort by days left (most urgent first)
  risks.sort((a,b)=>a.daysLeft-b.daysLeft);
  return {items:risks.slice(0,6),count:risks.length};
}

function calcPortfolioDeadlines(projects){
  const now=new Date();
  const day=86400000;
  const weeks=[];

  // Build 4 weeks
  for(let w=0;w<4;w++){
    const weekStart=new Date(now.getTime()+w*7*day);
    const weekEnd=new Date(weekStart.getTime()+6*day);
    weeks.push({
      label:w===0?'This Week':w===1?'Next Week':'Week '+(w+1),
      start:weekStart,
      end:weekEnd,
      projects:[]
    });
  }

  projects.filter(p=>!p.archived&&p.endDate).forEach(p=>{
    const endDate=new Date(p.endDate);
    const daysFromNow=Math.round((endDate-now)/day);

    if(daysFromNow>=0&&daysFromNow<28){
      const weekIdx=Math.floor(daysFromNow/7);
      if(weekIdx<4){
        weeks[weekIdx].projects.push({
          id:p.id,
          name:p.name,
          progress:p.progress||0,
          endDate:p.endDate
        });
      }
    }
  });

  return {weeks,total:weeks.reduce((s,w)=>s+w.projects.length,0)};
}

function calcStalledProjects(projects){
  const now=Date.now();
  const day=86400000;
  const stalled=[];

  projects.filter(p=>!p.archived).forEach(p=>{
    const progress=p.progress||0;
    if(progress>=100)return; // Complete

    // Check if project has old lastUpdated or no progress
    const lastUpdated=p.lastUpdated||p.updatedAt;
    if(lastUpdated){
      const daysSinceUpdate=Math.round((now-lastUpdated)/day);
      if(daysSinceUpdate>7){
        stalled.push({
          id:p.id,
          name:p.name,
          progress,
          daysSinceUpdate,
          level:daysSinceUpdate>14?'critical':'warning'
        });
      }
    }
  });

  // Sort by days stalled (most stalled first)
  stalled.sort((a,b)=>b.daysSinceUpdate-a.daysSinceUpdate);
  return {items:stalled.slice(0,5),count:stalled.length};
}

// Fetch parts from all active projects for aggregated stats
async function fetchPortfolioParts(projectIds){
  const allParts=[];
  const day=86400000;
  const now=Date.now();

  for(const pid of projectIds.slice(0,20)){ // Limit to 20 projects
    try{
      const snap=await db.ref('projects/'+pid+'/parts').once('value');
      const parts=snap.val();
      if(parts){
        Object.entries(parts).forEach(([id,p])=>{
          if(p&&!p.isAssembly){
            allParts.push({...p,id,projectId:pid});
          }
        });
      }
    }catch(e){console.warn('Failed to load parts for',pid);}
  }
  return allParts;
}

function calcPortfolioDwellTimes(parts){
  // Exclude 'installed' - those are complete
  const stages=['waiting','to-order','ordered','arrived','tested','configured'];
  const stageLabels=['Waiting','To Order','Ordered','Arrived','Tested','Config'];
  const dwellTotals={};
  const dwellCounts={};
  const now=Date.now();
  const day=86400000;

  stages.forEach(s=>{dwellTotals[s]=0;dwellCounts[s]=0;});

  parts.forEach(p=>{
    const status=p.status||'waiting';
    const changedAt=p.changedAt||p.createdAt||now;
    const dwell=(now-changedAt)/day;
    if(stages.includes(status)&&dwell>0&&dwell<365){
      dwellTotals[status]+=dwell;
      dwellCounts[status]++;
    }
  });

  const result=stages.map((s,i)=>({
    stage:stageLabels[i],
    key:s,
    days:dwellCounts[s]>0?dwellTotals[s]/dwellCounts[s]:0,
    count:dwellCounts[s]
  })).filter(s=>s.count>0);

  const maxDwell=Math.max(...result.map(r=>r.days),1);
  const bottleneck=result.length>0?result.reduce((a,b)=>a.days>b.days?a:b):null;

  return {stages:result,maxDwell,bottleneck};
}

function calcPortfolioArrivals(parts){
  const days=[];
  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const now=new Date();
  const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const day=86400000;

  for(let i=0;i<7;i++){
    const d=new Date(today.getTime()+i*day);
    days.push({
      date:d,
      label:i===0?'Today':i===1?'Tmrw':dayNames[d.getDay()],
      dateStr:d.toISOString().split('T')[0],
      arrivals:[],
      count:0
    });
  }

  parts.filter(p=>p.status==='ordered'&&p.expectedArrival).forEach(p=>{
    const eta=new Date(p.expectedArrival);
    const etaDate=new Date(eta.getFullYear(),eta.getMonth(),eta.getDate());
    const dayIdx=Math.round((etaDate-today)/day);
    if(dayIdx>=0&&dayIdx<7){
      days[dayIdx].arrivals.push({id:p.id,name:p.name,projectId:p.projectId});
      days[dayIdx].count++;
    }
  });

  const total=days.reduce((s,d)=>s+d.count,0);
  return {days,total};
}

function calcPortfolioPipeline(parts){
  const stages=[
    {key:'waiting',label:'Waiting',color:'var(--text3)'},
    {key:'to-order',label:'To Order',color:'var(--yellow)'},
    {key:'ordered',label:'Ordered',color:'var(--accent)'},
    {key:'arrived',label:'Arrived',color:'var(--blue)'},
    {key:'tested',label:'Tested',color:'var(--purple)'},
    {key:'configured',label:'Config',color:'var(--orange)'},
    {key:'installed',label:'Installed',color:'var(--green)'}
  ];

  const counts={};
  stages.forEach(s=>counts[s.key]=0);

  parts.forEach(p=>{
    const status=p.status||'waiting';
    if(counts[status]!==undefined)counts[status]++;
  });

  const total=parts.length;
  const installed=counts.installed||0;
  const remaining=total-installed;
  const progress=total>0?Math.round(installed/total*100):0;

  return {
    stages:stages.map(s=>({...s,count:counts[s.key],pct:total>0?Math.round(counts[s.key]/total*100):0})),
    total,
    installed,
    remaining,
    progress
  };
}

// Work remaining: days to deadline + parts not installed + burndown trend
function calcWorkRemaining(projects, parts){
  const now=Date.now();
  const day=86400000;

  // Parts remaining (not installed)
  const partsRemaining=parts.filter(p=>(p.status||'waiting')!=='installed').length;
  const partsInstalled=parts.filter(p=>p.status==='installed').length;
  const totalParts=parts.length;
  const completionPct=totalParts>0?Math.round(partsInstalled/totalParts*100):0;

  // Days to deadlines - check various date field names
  let nearestDeadline=null;
  let urgentProjects=[];
  let totalDays=0;
  let projectsWithDeadlines=0;

  projects.forEach(p=>{
    // Try various field names for end date
    const endDateStr=p.end||p.endDate||p.deadline||p.dueDate;
    if(endDateStr){
      const endDate=new Date(endDateStr).getTime();
      if(!isNaN(endDate)){
        const daysLeft=Math.round((endDate-now)/day);
        totalDays+=daysLeft;
        projectsWithDeadlines++;
        if(nearestDeadline===null||daysLeft<nearestDeadline){
          nearestDeadline=daysLeft;
        }
        if(daysLeft<=30){
          urgentProjects.push({name:p.name,daysLeft,progress:p.progress||0});
        }
      }
    }
  });

  const avgDaysLeft=projectsWithDeadlines>0?Math.round(totalDays/projectsWithDeadlines):null;

  urgentProjects.sort((a,b)=>a.daysLeft-b.daysLeft);

  // 14-day burndown trend (parts remaining each day)
  const burndownTrend=[];
  for(let i=13;i>=0;i--){
    const dayEnd=now-(i*day);
    // Count parts that were NOT installed by this day
    let remaining=0;
    parts.forEach(p=>{
      const status=p.status||'waiting';
      if(status!=='installed'){
        remaining++;
      }else if(p.changedAt&&p.changedAt>dayEnd){
        // Was installed after this day, so count as remaining
        remaining++;
      }
    });
    burndownTrend.push(remaining);
  }

  // Calculate velocity based on ALL status changes in last 7 days
  // Count parts that changed status (progressed) in the last 7 days
  let statusChanges7d=0;
  const sevenDaysAgo=now-(7*day);
  parts.forEach(p=>{
    if(p.changedAt&&p.changedAt>=sevenDaysAgo&&p.status!=='waiting'){
      statusChanges7d++;
    }
  });
  const velocity=statusChanges7d/7;

  // Projected days to complete at current velocity
  // Use installed rate for projection (more conservative)
  const installedLast7=burndownTrend[6]-burndownTrend[13]; // parts installed in last 7 days
  const installRate=Math.max(installedLast7,0)/7;
  const projectedDays=installRate>0?Math.ceil(partsRemaining/installRate):null;

  return {
    partsRemaining,
    partsInstalled,
    totalParts,
    completionPct,
    nearestDeadline,
    avgDaysLeft,
    urgentProjects:urgentProjects.slice(0,5),
    burndownTrend,
    velocity:velocity.toFixed(1),
    projectedDays
  };
}

// Stage progress weights (0-100%)
const STAGE_PROGRESS={
  'waiting':0,
  'to-order':17,
  'ordered':33,
  'arrived':50,
  'tested':67,
  'configured':83,
  'installed':100
};

function calcPortfolioVelocity(parts){
  const day=86400000;
  const now=Date.now();
  const days=[];

  // Build 30-day array
  for(let i=29;i>=0;i--){
    const d=new Date(now-i*day);
    const dateStr=d.toISOString().split('T')[0];
    days.push({
      date:d,
      dateStr,
      label:i===0?'Today':i===1?'Yest':(d.getMonth()+1)+'/'+d.getDate(),
      count:0,        // Raw count of status changes
      progress:0      // Weighted progress points
    });
  }

  // Count ALL status changes (any part that changed status on that day)
  // Weight by the progress value of the stage they moved TO
  parts.filter(p=>p.changedAt&&p.status!=='waiting').forEach(p=>{
    const changedDate=new Date(p.changedAt);
    const changedStr=changedDate.toISOString().split('T')[0];
    const dayEntry=days.find(d=>d.dateStr===changedStr);
    if(dayEntry){
      dayEntry.count++;
      // Add weighted progress (stage they moved TO)
      dayEntry.progress+=STAGE_PROGRESS[p.status]||0;
    }
  });

  // Calculate stats - use raw count for display, progress for trend analysis
  const totalCount=days.reduce((s,d)=>s+d.count,0);
  const totalProgress=days.reduce((s,d)=>s+d.progress,0);
  const avgCount=totalCount/30;
  const maxCount=Math.max(...days.map(d=>d.count),1);

  // 7-day moving average for trend (based on progress points)
  const recent7Progress=days.slice(-7).reduce((s,d)=>s+d.progress,0);
  const prev7Progress=days.slice(-14,-7).reduce((s,d)=>s+d.progress,0);
  const recent7Count=days.slice(-7).reduce((s,d)=>s+d.count,0)/7;
  const trend=recent7Progress>prev7Progress*1.1?'up':recent7Progress<prev7Progress*0.9?'down':'flat';

  return {
    days,
    total:totalCount,
    totalProgress,
    avg:avgCount.toFixed(1),
    max:maxCount,
    trend,
    recent7:recent7Count.toFixed(1)
  };
}

function calcVelocityTrend6Months(parts){
  const now=new Date();
  const months=[];

  // Build 6 months array (oldest to newest)
  for(let i=5;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    const monthStart=d.getTime();
    const nextMonth=new Date(d.getFullYear(),d.getMonth()+1,1).getTime();
    const label=d.toLocaleDateString('en-US',{month:'short'});
    months.push({label,monthStart,nextMonth,count:0});
  }

  // Count parts that changed status in each month
  parts.filter(p=>p.changedAt&&p.status!=='waiting').forEach(p=>{
    const ts=p.changedAt;
    months.forEach(m=>{
      if(ts>=m.monthStart&&ts<m.nextMonth)m.count++;
    });
  });

  // Calculate delta vs last month
  const currentMonth=months[5].count;
  const lastMonth=months[4].count;
  const delta=lastMonth>0?Math.round((currentMonth-lastMonth)/lastMonth*100):null;

  // Average per day this month
  const daysInMonth=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  const dayOfMonth=now.getDate();
  const avg=dayOfMonth>0?currentMonth/dayOfMonth:0;

  return {months,currentMonth,lastMonth,delta,avg};
}

let _portfolioPartsCache=null;
let _portfolioPartsCacheTime=0;

async function renderMasterInsightsPanel(){
  const state=_masterRenderState;
  if(!state||!state.projects){
    $('masterInsightsBody').innerHTML='<div class="insights-empty">No project data available</div>';
    return;
  }

  const projects=state.projects.filter(p=>!p.archived);
  const risks=calcDeadlineRisks(projects);
  const deadlines=calcPortfolioDeadlines(projects);

  // Show initial content with loading indicator for parts data
  $('masterInsightsBody').innerHTML='<div class="insights-grid"><div class="insights-loading">Loading portfolio data...</div></div>';

  // Fetch parts (with 5min cache)
  const cacheAge=Date.now()-_portfolioPartsCacheTime;
  let allParts=_portfolioPartsCache;
  if(!allParts||cacheAge>300000){
    const projectIds=projects.map(p=>p.id);
    allParts=await fetchPortfolioParts(projectIds);
    _portfolioPartsCache=allParts;
    _portfolioPartsCacheTime=Date.now();
  }

  const dwellTimes=calcPortfolioDwellTimes(allParts);
  const arrivals=calcPortfolioArrivals(allParts);
  const pipeline=calcPortfolioPipeline(allParts);
  const workRemaining=calcWorkRemaining(projects,allParts);
  const velocity=calcPortfolioVelocity(allParts);

  let html='<div class="insights-grid">';

  // Card 1: Deadline Risk
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><span class="insights-card-label">DEADLINE RISK</span></div>';
  html+='<div class="insights-card-body">';
  if(risks.items.length===0){
    html+='<div class="insights-empty-card">No urgent deadlines</div>';
  }else{
    html+='<div class="insights-risk-list">';
    risks.items.forEach(r=>{
      const icon=r.overdue?'âš ':'â±';
      const levelClass=r.level==='critical'?'critical':r.level==='warning'?'warning':'';
      const daysText=r.overdue?Math.abs(r.daysLeft)+'d overdue':r.daysLeft+'d left';
      html+='<div class="insights-risk-item '+levelClass+'" onclick="window.scrollToMasterProject(\''+r.id+'\')">';
      html+='<span class="insights-risk-name">'+esc(r.name)+'</span>';
      html+='<span class="insights-risk-detail">'+r.progress+'% Â· '+daysText+'</span>';
      html+='</div>';
    });
    html+='</div>';
  }
  html+='</div></div>';

  // Card 3: Upcoming Deadlines
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><span class="insights-card-label">UPCOMING DEADLINES</span></div>';
  html+='<div class="insights-card-body">';
  if(deadlines.total===0){
    html+='<div class="insights-empty-card">No deadlines in next 4 weeks</div>';
  }else{
    html+='<div class="insights-deadline-weeks">';
    deadlines.weeks.forEach(w=>{
      html+='<div class="insights-deadline-week">';
      html+='<div class="insights-week-label">'+w.label+'</div>';
      if(w.projects.length===0){
        html+='<div class="insights-week-empty">â€”</div>';
      }else{
        w.projects.forEach(p=>{
          html+='<div class="insights-week-project" onclick="window.scrollToMasterProject(\''+p.id+'\')">'+esc(p.name)+' <span class="insights-week-pct">'+p.progress+'%</span></div>';
        });
      }
      html+='</div>';
    });
    html+='</div>';
  }
  html+='</div></div>';

  // Card 4: Velocity Trend (6 months sparkline)
  const trend6m=calcVelocityTrend6Months(allParts);
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><span class="insights-card-label">VELOCITY TREND</span>';
  if(trend6m.delta!==null){
    const deltaClass=trend6m.delta>=0?'green':'red';
    const deltaSign=trend6m.delta>=0?'+':'';
    html+='<span class="insights-card-badge '+deltaClass+'">'+deltaSign+trend6m.delta+'% vs last month</span>';
  }
  html+='</div>';
  html+='<div class="insights-card-body">';
  html+='<div class="insights-sparkline">';
  const sparkMax=Math.max(...trend6m.months.map(m=>m.count),1);
  trend6m.months.forEach((m,i)=>{
    const h=Math.max(4,(m.count/sparkMax)*100);
    const isLast=i===trend6m.months.length-1;
    html+='<div class="insights-spark-bar'+(isLast?' current':'')+'" style="height:'+h+'%" data-tip="'+m.label+': '+m.count+' parts" onmouseenter="showBarTip(this)" onmouseleave="hideBarTip()"></div>';
  });
  html+='</div>';
  html+='<div class="insights-spark-labels">';
  trend6m.months.forEach(m=>html+='<span>'+m.label.slice(0,3)+'</span>');
  html+='</div>';
  html+='<div class="insights-spark-summary">'+trend6m.currentMonth+' parts this month Â· '+trend6m.avg.toFixed(1)+'/day avg</div>';
  html+='</div></div>';

  // Card 5: Stage Dwell Times (aggregated)
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><span class="insights-card-label">AVG STAGE DWELL TIME</span>';
  if(dwellTimes.bottleneck&&dwellTimes.bottleneck.days>5)html+='<span class="insights-card-badge critical">'+esc(dwellTimes.bottleneck.stage)+'</span>';
  html+='</div>';
  html+='<div class="insights-card-body">';
  if(dwellTimes.stages.length===0){
    html+='<div class="insights-empty-card">No dwell data available</div>';
  }else{
    html+='<div class="insights-stage-bars">';
    dwellTimes.stages.forEach(s=>{
      const pct=Math.round(s.days/dwellTimes.maxDwell*100);
      const cls=s.days>10?'slow':s.days>5?'medium':'fast';
      const isBottleneck=dwellTimes.bottleneck&&s.key===dwellTimes.bottleneck.key&&s.days>5;
      html+='<div class="insights-stage-row'+(isBottleneck?' bottleneck':'')+'"><span class="insights-stage-name">'+esc(s.stage)+'</span><div class="insights-stage-bar"><div class="insights-stage-fill '+cls+'" style="width:'+pct+'%"></div><span class="insights-stage-value">'+s.days.toFixed(1)+'d</span></div></div>';
    });
    html+='</div>';
    html+='<div class="insights-metric-label" style="margin-top:8px;text-align:center">'+allParts.length+' parts across '+projects.length+' projects</div>';
  }
  html+='</div></div>';

  // Card 6: Upcoming Arrivals (aggregated)
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><span class="insights-card-label">UPCOMING ARRIVALS</span>';
  if(arrivals.total>0)html+='<span class="insights-card-badge">'+arrivals.total+'</span>';
  html+='</div>';
  html+='<div class="insights-card-body">';
  if(arrivals.total===0){
    html+='<div class="insights-empty-card">No arrivals expected this week</div>';
  }else{
    html+='<div class="insights-week-grid">';
    arrivals.days.forEach(d=>{
      const hasArrivals=d.count>0;
      const tooltip=d.arrivals.slice(0,5).map(a=>a.name).join(', ')+(d.arrivals.length>5?' +'+( d.arrivals.length-5)+' more':'');
      html+='<div class="insights-week-day'+(hasArrivals?' has-arrivals':'')+'" title="'+(tooltip||'None')+'">';
      html+='<div class="insights-week-count">'+(d.count||'â€“')+'</div>';
      html+='<div class="insights-week-label">'+d.label+'</div>';
      html+='</div>';
    });
    html+='</div>';
  }
  html+='</div></div>';

  // Card 7: Portfolio Pipeline (horizontal bars like dwell times)
  const maxPipelineCount=Math.max(...pipeline.stages.map(s=>s.count),1);
  html+='<div class="insights-card">';
  html+='<div class="insights-card-header"><span class="insights-card-label">PORTFOLIO PIPELINE</span>';
  html+='<span class="insights-card-badge">'+pipeline.total+' parts</span>';
  html+='</div>';
  html+='<div class="insights-card-body">';
  html+='<div class="insights-stage-bars">';
  pipeline.stages.forEach(s=>{
    const pct=Math.round(s.count/maxPipelineCount*100);
    html+='<div class="insights-stage-row"><span class="insights-stage-name">'+esc(s.label)+'</span><div class="insights-stage-bar"><div class="insights-stage-fill" style="width:'+pct+'%;background:'+s.color+'"></div><span class="insights-stage-value">'+s.count+'</span></div></div>';
  });
  html+='</div>';
  html+='<div class="insights-metric-label" style="margin-top:8px;text-align:center">'+pipeline.progress+'% complete Â· '+pipeline.remaining+' remaining</div>';
  html+='</div></div>';

  // Card 8: Work Remaining (Parts with burndown)
  html+='<div class="insights-card insights-card-wide">';
  html+='<div class="insights-card-header"><span class="insights-card-label">WORK REMAINING</span>';
  if(workRemaining.projectedDays)html+='<span class="insights-card-badge">~'+workRemaining.projectedDays+'d at current pace</span>';
  html+='</div>';
  html+='<div class="insights-card-body">';
  // Summary row
  html+='<div class="insights-work-summary">';
  html+='<div class="insights-work-stat"><span class="insights-work-value">'+workRemaining.partsRemaining+'</span><span class="insights-work-label">Parts Left</span></div>';
  html+='<div class="insights-work-stat"><span class="insights-work-value">'+workRemaining.completionPct+'%</span><span class="insights-work-label">Complete</span></div>';
  html+='<div class="insights-work-stat"><span class="insights-work-value">'+workRemaining.velocity+'</span><span class="insights-work-label">Parts/Day</span></div>';
  html+='</div>';
  // Burndown bars (14 days)
  const bdMax=Math.max(...workRemaining.burndownTrend,1);
  html+='<div class="insights-bars">';
  const bdToday=new Date();
  workRemaining.burndownTrend.forEach((val,i)=>{
    const h=Math.max(2,(val/bdMax)*100);
    const cls=i===13?'insights-bar today':'insights-bar';
    const d=new Date(bdToday);d.setDate(d.getDate()-(13-i));
    const lbl=(d.getMonth()+1)+'/'+d.getDate()+': '+val+' left';
    html+='<div class="'+cls+'" style="height:'+h+'%" data-tip="'+lbl+'" onmouseenter="showBarTip(this)" onmouseleave="hideBarTip()"></div>';
  });
  html+='</div>';
  html+='<div class="insights-chart-xaxis"><span>14d ago</span><span>7d ago</span><span>Today</span></div>';
  html+='</div></div>';

  // Card 9: Portfolio Velocity (30-day chart)
  const trendIcon=velocity.trend==='up'?'â†‘':velocity.trend==='down'?'â†“':'â†’';
  const trendClass=velocity.trend==='up'?'up':velocity.trend==='down'?'down':'';
  html+='<div class="insights-card insights-card-wide">';
  html+='<div class="insights-card-header"><span class="insights-card-label">PORTFOLIO VELOCITY</span>';
  html+='<span class="insights-velocity-trend '+trendClass+'">'+trendIcon+' '+velocity.recent7+'/day</span>';
  html+='</div>';
  html+='<div class="insights-card-body">';
  html+='<div class="insights-velocity-stats">';
  html+='<span>30-day total: <strong>'+velocity.total+'</strong> parts</span>';
  html+='<span>Average: <strong>'+velocity.avg+'</strong>/day</span>';
  html+='</div>';
  // Velocity bars (30 days)
  const velMax=Math.max(velocity.max,1);
  html+='<div class="insights-bars">';
  velocity.days.forEach((d,i)=>{
    const h=Math.max(2,(d.count/velMax)*100);
    const cls=i===29?'insights-bar today':'insights-bar';
    const lbl=d.label+': '+d.count+' parts';
    html+='<div class="'+cls+'" style="height:'+h+'%" data-tip="'+lbl+'" onmouseenter="showBarTip(this)" onmouseleave="hideBarTip()"></div>';
  });
  html+='</div>';
  html+='<div class="insights-chart-xaxis"><span>'+velocity.days[0].label+'</span><span>'+velocity.days[14].label+'</span><span>Today</span></div>';
  html+='</div></div>';

  html+='</div>';
  $('masterInsightsBody').innerHTML=html;
}

window.showBarTip=function(el,e){
  const tip=el.getAttribute('data-tip');
  const tooltip=$('barTooltip');
  if(tooltip&&tip){
    tooltip.textContent=tip;
    const rect=el.getBoundingClientRect();
    tooltip.style.left=(rect.left+rect.width/2)+'px';
    tooltip.style.top=(rect.top-8)+'px';
    tooltip.style.transform='translate(-50%,-100%)';
    tooltip.classList.add('visible');
  }
};
window.hideBarTip=function(){
  const tooltip=$('barTooltip');
  if(tooltip)tooltip.classList.remove('visible');
};

window.scrollToMasterProject=function(projectId){
  closeMasterInsightsPanel();
  const row=document.querySelector('.master-sidebar-row[data-project-id="'+projectId+'"]');
  if(row){
    row.scrollIntoView({behavior:'smooth',block:'center'});
    row.classList.add('highlight');
    setTimeout(()=>row.classList.remove('highlight'),2000);
  }
};

window.openMasterInsightsPanel=function(){
  const panel=$('masterInsightsPanel');
  const btn=$('masterInsightsBtn');
  if(!panel||!btn)return;
  const rect=btn.getBoundingClientRect();
  panel.style.top=Math.min(rect.bottom+8,window.innerHeight-panel.offsetHeight-20)+'px';
  panel.style.right=Math.max(20,window.innerWidth-rect.right)+'px';
  renderMasterInsightsPanel();
  panel.classList.add('open');
};

window.closeMasterInsightsPanel=function(){
  $('masterInsightsPanel').classList.remove('open');
};

// Close master insights panel on outside click
document.addEventListener('click',e=>{
  const panel=$('masterInsightsPanel');
  if(panel&&panel.classList.contains('open')&&!panel.contains(e.target)&&!e.target.closest('#masterInsightsBtn')){
    panel.classList.remove('open');
  }
});

function getDaysElapsed(){
  if(!projectDates.start)return 30;
  return Math.max(1,(Date.now()-new Date(projectDates.start).getTime())/86400000);
}

window.highlightPart=function(partId){
  closeInsightsPanel();
  highlightPartId=partId;
  const part=data.find(d=>String(d.id)===String(partId));
  if(part&&part.parentId){
    expanded[String(part.parentId)]=true;
  }
  render();
};

if($('aiAlert'))$('aiAlert').onclick=(e)=>{toggleCmdWindow()};

// AI Workspace handlers
$('aiWorkspaceAskBtn').onclick=handleWorkspaceAsk;
$('aiWorkspaceTellBtn').onclick=handleWorkspaceTell;
$('aiWorkspaceQuestion').onkeydown=e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleWorkspaceAsk()}
};
$('aiWorkspaceQuestion').oninput=function(){
  this.style.height='auto';
  this.style.height=Math.min(this.scrollHeight,150)+'px';
};

$('reportBtn').onclick=async(e)=>{
  $('menuDrop').classList.remove('open'); // Close menu
  const popover=$('reportModal');
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  
  // Display cached report if available, otherwise show empty state
  if(cachedReport && cachedReport.status){
    displayCachedReport();
  } else {
    showReportEmptyState();
  }
};

function showReportEmptyState(){
  $('reportModelBadge').textContent='';
  $('reportRefresh').disabled=true;
  $('reportContent').innerHTML=`
    <div class="report-empty">
      <button class="report-generate-btn" onclick="event.stopPropagation(); window.generateOpusReport()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 3v3m0 12v3m-9-9h3m12 0h3m-4.6-7.4l-2.1 2.1m-5.7 5.7l-2.1 2.1m0-9.9l2.1 2.1m5.7 5.7l2.1 2.1"/></svg>
        Generate Status Report
      </button>
    </div>
  `;
}

window.generateOpusReport=async function(){
  const selectedModel = $('reportModelSelect').value;
  const modelName = AI_MODELS[selectedModel]?.name || selectedModel;
  
  $('reportContent').innerHTML='<div class="report-loading"><div class="report-loading-spinner"></div><div class="report-loading-text">Generating report with '+modelName+'...</div></div>';
  $('reportModelBadge').textContent='thinking...';
  $('reportRefresh').disabled=false;
  $('reportRefresh').classList.add('spinning');
  
  // Use evidence-based context builder
  const context = buildReportContext();
  
  try{
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({
      mode:'structured-report',
      projectContext:context,
      model: selectedModel
    });
    
    console.log('ðŸ¤– Report Model Verification:');
    console.log('   Requested:', selectedModel);
    console.log('   Returned:', result.data?.model||'unknown');
    
    if(result.data?.success){
      const actualModel=result.data.model||selectedModel;
      $('reportModelBadge').textContent=AI_MODELS[actualModel]?.name||actualModel;
      
      // Parse JSON response
      let reportData;
      try {
        // Handle both raw JSON and stringified JSON
        const content = result.data.content;
        if (typeof content === 'string') {
          // Try multiple extraction methods
          let jsonStr = content;

          // Method 1: Extract from markdown code blocks
          const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) ||
                           content.match(/```\s*([\s\S]*?)\s*```/);
          if (jsonMatch) {
            jsonStr = jsonMatch[1];
          } else {
            // Method 2: Find JSON object boundaries (first { to last })
            const firstBrace = content.indexOf('{');
            const lastBrace = content.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace > firstBrace) {
              jsonStr = content.substring(firstBrace, lastBrace + 1);
            }
          }

          // Clean up common issues
          jsonStr = jsonStr.trim();

          reportData = JSON.parse(jsonStr);
        } else {
          reportData = content;
        }
        
        // Validate required fields
        if (!reportData.status || !reportData.summary) {
          throw new Error('Invalid report structure');
        }
        
        // Cache report data for continuity
        cachedReport = {
          generatedAt: new Date().toISOString(),
          model: actualModel,
          ...reportData
        };
        
        // Save to Firebase (syncs to all clients)
        saveReportToFirebase(cachedReport);
        
        // Render structured report
        $('reportContent').innerHTML = renderReportHTML(reportData, context);
        lastReportContent = JSON.stringify(reportData, null, 2);
        
      } catch (parseError) {
        console.warn('JSON parse failed, falling back to markdown:', parseError);
        console.warn('Raw content:', result.data.content);
        // Fallback - try to display as clean text
        let fallbackContent = result.data.content;
        // Strip code blocks
        fallbackContent = fallbackContent.replace(/```json\s*/g, '').replace(/```\s*/g, '');
        // Try to extract and format summary if present
        const summaryMatch = fallbackContent.match(/"summary"\s*:\s*"([^"]+)"/);
        if (summaryMatch) {
          $('reportContent').innerHTML = '<div class="report-prose"><p>' + esc(summaryMatch[1]).replace(/\\n/g, '</p><p>') + '</p></div>';
        } else {
          $('reportContent').innerHTML = formatReportResponse(fallbackContent);
        }
        lastReportContent = result.data.content;
      }
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Report generation failed:',e);
    $('reportModelBadge').textContent='offline';
    // Fallback to local report
    const localReport=generateReport();
    $('reportContent').innerHTML='<div class="report-prose"><p style="color:var(--text3);margin-bottom:12px;font-size:12px">âš  AI unavailable - showing local report</p><pre style="white-space:pre-wrap;font-family:inherit;font-size:13px">'+esc(localReport)+'</pre></div>';
    lastReportContent=localReport;
  }
  
  $('reportRefresh').classList.remove('spinning');
}

function buildFullProjectContext(){
  const parts=getParts(),asms=getAsms();
  const pct=calcOverallProgress(),expected=getExpectedProgress(),daysLeft=getDaysLeft();
  const forecast=getVelocityForecast();
  const otd=calcSupplierOTD();
  const now=Date.now(),day=86400000;
  
  // Build comprehensive context
  const ctx={
    // Company context (condensed)
    company:{
      name:'Radar Systems Manufacturing',
      location:'Finland',
      customer:'UK sister company',
      rules:['Safety components need full testing','Parts >â‚¬5k need dual approval','RF parts need cal certs','International shipments +7-10d customs'],
      leadTimes:{stock:'3-7d',standard:'10-14d',custom:'3-4wk',rfSpecialized:'4-6wk'}
    },
    project:{
      name:currentProjectName,
      progress:pct,
      expected:expected,
      daysLeft:daysLeft,
      startDate:projectDates.start||null,
      endDate:projectDates.end||null,
      today:new Date().toISOString().split('T')[0],
      daysElapsed:projectDates.start?Math.max(0,Math.floor((Date.now()-new Date(projectDates.start))/day)):null,
      totalDuration:projectDates.start&&projectDates.end?Math.ceil((new Date(projectDates.end)-new Date(projectDates.start))/day):null,
      timelinePercent:expected,
      scheduleStatus:expected!==null?(pct>=expected?'on-track or ahead':'behind'):'unknown',
      totalParts:parts.length,
      totalAssemblies:asms.length
    },
    counts:{
      waiting:parts.filter(p=>p.status==='waiting').length,
      'to-order':parts.filter(p=>p.status==='to-order').length,
      ordered:parts.filter(p=>p.status==='ordered').length,
      arrived:parts.filter(p=>p.status==='arrived').length,
      installed:parts.filter(p=>p.status==='installed').length,
      total:parts.length
    },
    assemblies:asms.map(a=>({
      name:a.name,
      progress:calcAsmProgress(a.id),
      partCount:parts.filter(p=>String(p.parentId)===String(a.id)).length,
      priority:a.priority||999
    })).sort((a,b)=>a.priority-b.priority),
    // ALL parts with full details (only non-empty fields)
    allParts:parts.map(p=>{
      const asm=asms.find(a=>String(a.id)===String(p.parentId));
      const daysInStatus=p.changedAt?Math.floor((now-p.changedAt)/day):0;
      const part={id:p.id,name:p.name,status:p.status,daysInStatus};
      if(asm?.name)part.assembly=asm.name;
      if(p.assignee)part.assignee=p.assignee;
      if(p.poNumber)part.poNumber=p.poNumber;
      if(p.mfr)part.mfr=p.mfr;
      if(p.code)part.code=p.code;
      if(p.qty&&p.qty>1)part.qty=p.qty;
      if(p.expectedArrival)part.expectedArrival=p.expectedArrival;
      if(p.pendingNote)part.pendingNote=p.pendingNote;
      if(p.notes)part.notes=p.notes;
      return part;
    }),
    stuck:parts.filter(p=>{
      const days=Math.floor((now-(p.changedAt||now))/day);
      return days>5&&p.status!=='installed';
    }).map(p=>({
      name:p.name,
      status:p.status,
      days:Math.floor((now-(p.changedAt||now))/day),
      assembly:asms.find(a=>String(a.id)===String(p.parentId))?.name||'Unassigned',
      assignee:p.assignee||''
    })),
    velocity:forecast?{
      rate:forecast.rate,
      daysToComplete:forecast.daysToComplete,
      status:forecast.status,
      estDate:forecast.estDate
    }:null,
    suppliers:getSupplierStats(),
    otdRate:otd,
    workload:getWorkloadStats(),
    recentActivity:history.filter(h=>h.action&&h.item).slice(-20).map(h=>({
      action:h.action,
      item:h.item,
      time:new Date(h.ts).toLocaleDateString()
    })),
    team:team.map(t=>({name:t.name,email:t.email}))
  };
  
  // TIMELINE CONFLICTS - resource scheduling conflicts
  const timelineConflicts=[];
  const asmWithDates=asms.filter(a=>a.ganttStart||a.ganttEnd||a.assignee).map(a=>{
    const asmParts=parts.filter(p=>String(p.parentId)===String(a.id));
    let startDate=a.ganttStart?new Date(a.ganttStart):null;
    let endDate=a.ganttEnd?new Date(a.ganttEnd):null;
    if(!startDate||!endDate){
      const orderedDates=asmParts.filter(p=>p.orderedAt).map(p=>p.orderedAt);
      const arrivedDates=asmParts.filter(p=>p.arrivedAt).map(p=>p.arrivedAt);
      if(!startDate&&orderedDates.length)startDate=new Date(Math.min(...orderedDates));
      if(!endDate&&arrivedDates.length)endDate=new Date(Math.max(...arrivedDates));
      if(!startDate)startDate=new Date();
      if(!endDate)endDate=new Date(startDate.getTime()+14*day);
    }
    return {id:a.id,name:a.name,assignee:a.assignee,startDate,endDate};
  }).filter(a=>a.assignee&&a.startDate&&a.endDate);
  
  for(let i=0;i<asmWithDates.length;i++){
    const a=asmWithDates[i];
    for(let j=i+1;j<asmWithDates.length;j++){
      const b=asmWithDates[j];
      if(a.assignee!==b.assignee)continue;
      if(a.startDate<=b.endDate&&a.endDate>=b.startDate){
        timelineConflicts.push({
          person:a.assignee,
          assembly1:a.name,
          dates1:a.startDate.toLocaleDateString()+' - '+a.endDate.toLocaleDateString(),
          assembly2:b.name,
          dates2:b.startDate.toLocaleDateString()+' - '+b.endDate.toLocaleDateString()
        });
      }
    }
  }
  if(timelineConflicts.length){
    ctx.timelineConflicts=timelineConflicts;
  }
  
  // MILESTONES
  if(milestones&&milestones.length){
    ctx.milestones=milestones.map(m=>({
      name:m.name,
      date:m.date,
      type:m.type,
      daysAway:Math.round((new Date(m.date)-new Date())/day)
    }));
  }
  
  // Portfolio data (all projects for Master Schedule context)
  if(typeof projectIndex !== 'undefined' && projectIndex){
    ctx.portfolio = Object.entries(projectIndex).filter(([id, p]) => !p.archived).map(([id, p]) => ({
      id,
      name: p.name,
      startDate: p.startDate || null,
      endDate: p.endDate || null,
      progress: p.progress || 0,
      dependency: p.dependency || null,
      daysRemaining: p.endDate ? Math.max(0, Math.ceil((new Date(p.endDate) - new Date()) / day)) : null
    }));
  }
  
  // Site trips for team availability context
  if(typeof siteTrips !== 'undefined' && siteTrips && siteTrips.length > 0){
    ctx.siteTrips = siteTrips.map(t => ({
      teamMember: t.assignee,
      site: t.site,
      startDate: t.startDate,
      endDate: t.endDate,
      daysUntil: t.startDate ? Math.ceil((new Date(t.startDate) - new Date()) / day) : null
    }));
  }
  
  return ctx;
}

// Build optimized context for status reports (evidence slices instead of all parts)
function buildReportContext(){
  const parts=getParts(),asms=getAsms();
  const now=Date.now(),day=86400000;
  const today=new Date().toISOString().split('T')[0];
  const todayTs=new Date(today).getTime();
  
  // Build assembly lookup map (O(1) access)
  const asmById={};
  asms.forEach(a=>asmById[String(a.id)]=a);
  
  // Pre-compute daysInStatus for all parts
  const partsWithDays=parts.map(p=>({
    ...p,
    daysInStatus:p.changedAt?Math.floor((now-p.changedAt)/day):0
  }));
  
  // Evidence row builder
  function buildRow(p){
    const asm=asmById[String(p.parentId)];
    const row={
      id:p.id,
      name:p.name,
      assembly:asm?.name||'Unassigned',
      status:p.status,
      daysInStatus:p.daysInStatus
    };
    
    // Critical path flag
    if(p.notes&&/critical|safety|block/i.test(p.notes))row.isCriticalPath=true;
    if(p.mfr==='CPI'||p.mfr==='Cobham')row.isCriticalPath=true;
    
    if(p.assignee)row.assignee=p.assignee;
    if(p.mfr)row.mfr=p.mfr;
    if(p.poNumber)row.poNumber=p.poNumber;
    if(p.expectedArrival)row.expectedArrival=p.expectedArrival;
    
    // Truncate notes
    const note=p.pendingNote||p.notes||'';
    if(note)row.note=note.slice(0,120);
    
    // Risk flags
    const flags={};
    if(p.status==='ordered'&&!p.expectedArrival)flags.missingETA=true;
    if(p.status==='ordered'&&p.expectedArrival){
      const etaTs=new Date(p.expectedArrival).getTime();
      if(etaTs<todayTs)flags.overdueETA=true;
    }
    if(!p.assignee)flags.noAssignee=true;
    if(Object.keys(flags).length)row.flags=flags;
    
    return row;
  }
  
  // Evidence slices
  const toOrder=partsWithDays
    .filter(p=>p.status==='to-order')
    .sort((a,b)=>b.daysInStatus-a.daysInStatus)
    .slice(0,25)
    .map(buildRow);
  
  const orderedAtRisk=partsWithDays
    .filter(p=>{
      if(p.status!=='ordered')return false;
      if(!p.expectedArrival)return true;
      const etaTs=new Date(p.expectedArrival).getTime();
      if(etaTs<todayTs)return true;
      if(p.notes&&/customs|export|approv|licen|block/i.test(p.notes))return true;
      if(p.daysInStatus>14)return true;
      return false;
    })
    .sort((a,b)=>{
      const aEtaTs=a.expectedArrival?new Date(a.expectedArrival).getTime():Infinity;
      const bEtaTs=b.expectedArrival?new Date(b.expectedArrival).getTime():Infinity;
      const aOver=aEtaTs<todayTs?1:0;
      const bOver=bEtaTs<todayTs?1:0;
      if(bOver!==aOver)return bOver-aOver;
      return b.daysInStatus-a.daysInStatus;
    })
    .slice(0,25)
    .map(buildRow);
  
  const arrivedStuck=partsWithDays
    .filter(p=>p.status==='arrived'&&p.daysInStatus>3)
    .sort((a,b)=>b.daysInStatus-a.daysInStatus)
    .slice(0,20)
    .map(buildRow);
  
  const waitingBlockers=partsWithDays
    .filter(p=>{
      if(p.status!=='waiting')return false;
      if(p.pendingNote)return true;
      if(p.notes&&/block|wait|hold|need|missing/i.test(p.notes))return true;
      return false;
    })
    .sort((a,b)=>b.daysInStatus-a.daysInStatus)
    .slice(0,15)
    .map(buildRow);
  
  const waitingMissingInfo=partsWithDays
    .filter(p=>{
      if(p.status!=='waiting')return false;
      if(p.pendingNote||(p.notes&&/block|wait|hold/i.test(p.notes)))return false;
      if(!p.assignee||!p.code)return true;
      return false;
    })
    .sort((a,b)=>b.daysInStatus-a.daysInStatus)
    .slice(0,10)
    .map(buildRow);
  
  // Assembly data
  const asmData=asms.map(a=>{
    const asmParts=partsWithDays.filter(p=>String(p.parentId)===String(a.id));
    return {
      name:a.name,
      progress:calcAsmProgress(a.id),
      partCount:asmParts.length,
      stuckCount:asmParts.filter(p=>p.daysInStatus>5&&p.status!=='installed').length,
      overdueCount:asmParts.filter(p=>{
        if(p.status!=='ordered'||!p.expectedArrival)return false;
        return new Date(p.expectedArrival).getTime()<todayTs;
      }).length
    };
  });
  
  // Counts
  const counts={
    waiting:parts.filter(p=>p.status==='waiting').length,
    toOrder:parts.filter(p=>p.status==='to-order').length,
    ordered:parts.filter(p=>p.status==='ordered').length,
    arrived:parts.filter(p=>p.status==='arrived').length,
    tested:parts.filter(p=>p.status==='tested').length,
    configured:parts.filter(p=>p.status==='configured').length,
    installed:parts.filter(p=>p.status==='installed').length,
    total:parts.length
  };
  
  // Overdue/stuck counts for metrics line
  const orderedOverdue=parts.filter(p=>{
    if(p.status!=='ordered'||!p.expectedArrival)return false;
    return new Date(p.expectedArrival).getTime()<todayTs;
  }).length;
  
  const arrivedStuckCount=parts.filter(p=>
    p.status==='arrived'&&p.changedAt&&Math.floor((now-p.changedAt)/day)>3
  ).length;
  
  // Forecast slip
  const forecast=getVelocityForecast();
  let forecastSlipDays=null;
  if(forecast?.estDate&&projectDates.end){
    forecastSlipDays=Math.ceil((new Date(forecast.estDate)-new Date(projectDates.end))/day);
  }
  
  // Build context object
  const ctx={
    meta:{today,generatedAt:new Date().toISOString()},
    
    project:{
      name:currentProjectName,
      startDate:projectDates.start||null,
      endDate:projectDates.end||null,
      daysLeft:getDaysLeft(),
      progressPct:calcOverallProgress(),
      expectedPct:getExpectedProgress()
    },
    
    counts,
    orderedOverdue,
    arrivedStuckCount,
    forecastSlipDays,
    
    evidence:{
      toOrder,
      orderedAtRisk,
      arrivedStuck,
      waitingBlockers,
      waitingMissingInfo
    },
    
    assemblies:{
      total:asms.length,
      bottomByProgress:[...asmData].sort((a,b)=>a.progress-b.progress).slice(0,5),
      atRisk:asmData.filter(a=>a.stuckCount>0||a.overdueCount>0).slice(0,5)
    },
    
    team:team.map(t=>t.name)
  };
  
  // Add milestones (next 30 days only)
  if(milestones&&milestones.length){
    ctx.milestones=milestones.map(m=>({
      name:m.name,
      date:m.date,
      daysAway:Math.round((new Date(m.date)-new Date())/day)
    })).filter(m=>m.daysAway>=0&&m.daysAway<=30);
  }
  
  // Add previous report for continuity
  if(cachedReport){
    ctx.previousReport={
      generatedAt:cachedReport.generatedAt,
      summary:cachedReport.summary,
      topIssues:cachedReport.topIssues?.slice(0,3)
    };
  }
  
  return ctx;
}

// Render JSON report to human-readable HTML (with XSS protection)
function renderReportHTML(json,ctx){
  const e=s=>esc(String(s||''));
  const p=ctx.project;
  const c=ctx.counts;
  
  // Build lookup maps for parts and assemblies by name
  const partsByName={};
  const asmsByName={};
  getParts().forEach(part=>{
    partsByName[part.name.toLowerCase()]=part.id;
  });
  getAsms().forEach(asm=>{
    asmsByName[asm.name.toLowerCase()]=asm.id;
  });
  
  // Helper: make part/assembly names clickable
  function linkify(text){
    if(!text)return'';
    let result=e(text);
    
    // Try to find and link part names (check longer names first to avoid partial matches)
    const allNames=[...Object.keys(partsByName),...Object.keys(asmsByName)].sort((a,b)=>b.length-a.length);
    
    allNames.forEach(name=>{
      const escapedName=name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const regex=new RegExp('\\b('+escapedName+')\\b','i');
      const id=partsByName[name]||asmsByName[name];
      const isAsm=!!asmsByName[name];
      if(id){
        const match=result.match(regex);
        if(match&&!result.includes('onclick="window.goToReportItem(\''+id+'\'')){
          // Replace only first occurrence that isn't already linked
          result=result.replace(regex,'<span class="report-part-link" onclick="window.goToReportItem(\''+id+'\','+isAsm+')" title="Click to view">$1</span>');
        }
      }
    });
    
    return result;
  }
  
  // Status class
  const statusClass=json.status==='critical'?'status-critical':
    json.status==='behind'?'status-behind':'status-on-track';
  
  // Progress percentage
  const progress=p.progressPct||0;
  const expected=p.expectedPct||0;
  const daysLeft=p.daysLeft||0;
  
  let html='';
  
  // Header
  html+='<div class="report-header">';
  html+='<div class="report-title">'+e(p.name)+'</div>';
  html+='<div class="report-header-row">';
  html+='<span class="report-status-badge '+statusClass+'">'+e(json.status)+'</span>';
  html+='<span class="report-date">'+e(ctx.meta.today)+'</span>';
  if(daysLeft>0)html+='<span class="report-days-left">'+daysLeft+' days left</span>';
  html+='</div>';
  
  // Progress Bar
  html+='<div class="report-progress-container">';
  html+='<div class="report-progress-bar">';
  html+='<div class="report-progress-fill '+statusClass+'" style="width:'+Math.min(progress,100)+'%"></div>';
  if(expected>0)html+='<div class="report-progress-expected" style="left:'+Math.min(expected,100)+'%"></div>';
  html+='</div>';
  html+='<div class="report-progress-labels">';
  html+='<span class="report-progress-current">'+progress+'% complete</span>';
  if(expected>0)html+='<span class="report-progress-target">'+expected+'% expected</span>';
  html+='</div>';
  html+='</div>';
  html+='</div>';
  
  // Pipeline Funnel
  const maxCount=Math.max(c.waiting||0,c.toOrder||0,c.ordered||0,c.arrived||0,c.tested||0,c.configured||0,c.installed||0,1);
  html+='<div class="report-pipeline">';
  html+='<div class="report-pipeline-title">Pipeline</div>';
  const stages=[
    {key:'waiting',label:'Waiting',count:c.waiting||0},
    {key:'to-order',label:'To Order',count:c.toOrder||0},
    {key:'ordered',label:'Ordered',count:c.ordered||0},
    {key:'arrived',label:'Arrived',count:c.arrived||0,note:ctx.arrivedStuckCount?' ('+ctx.arrivedStuckCount+' stuck)':''},
    {key:'tested',label:'Tested',count:c.tested||0},
    {key:'configured',label:'Configured',count:c.configured||0},
    {key:'installed',label:'Installed',count:c.installed||0}
  ];
  stages.forEach(s=>{
    const pct=Math.round((s.count/maxCount)*100);
    html+='<div class="report-pipeline-row">';
    html+='<span class="report-pipeline-label">'+s.label+'</span>';
    html+='<div class="report-pipeline-bar-container"><div class="report-pipeline-bar s-'+s.key+'" style="width:'+pct+'%"></div></div>';
    html+='<span class="report-pipeline-count">'+s.count+'</span>';
    if(s.note)html+='<span class="report-pipeline-note">'+s.note+'</span>';
    html+='</div>';
  });
  html+='</div>';
  
  // Summary
  // Summary (handle paragraphs)
  const summaryHtml = linkify(json.summary).replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
  html+='<div class="report-summary"><p>'+summaryHtml+'</p></div>';
  
  // Top Issues with Severity
  if(json.topIssues&&json.topIssues.length){
    html+='<div class="report-section">';
    html+='<div class="report-section-header">';
    html+='<svg class="report-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
    html+='<span class="report-section-title">Top Issues</span>';
    html+='</div>';
    html+='<div class="report-issues">';
    json.topIssues.forEach(issue=>{
      const text=typeof issue==='string'?issue:issue.text;
      const severity=typeof issue==='object'&&issue.severity?issue.severity:'medium';
      html+='<div class="report-issue">';
      html+='<div class="report-severity '+severity+'"></div>';
      html+='<div class="report-issue-text">'+linkify(text)+'</div>';
      html+='</div>';
    });
    html+='</div></div>';
  }
  
  // Next Moves grouped by owner
  if(json.nextMoves&&json.nextMoves.length){
    html+='<div class="report-section">';
    html+='<div class="report-section-header">';
    html+='<svg class="report-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';
    html+='<span class="report-section-title">Next Moves</span>';
    html+='</div>';
    
    // Group by owner
    const movesByOwner={};
    json.nextMoves.forEach(move=>{
      let owner,action;
      if(typeof move==='string'){
        // Parse "Owner: action" or "Owner â€” action" format
        const match=move.match(/^([^:â€”]+)[:\â€”]\s*(.+)$/);
        if(match){owner=match[1].trim();action=match[2].trim();}
        else{owner='Team';action=move;}
      }else{
        owner=move.owner||'Team';
        action=move.action||'';
      }
      if(!movesByOwner[owner])movesByOwner[owner]=[];
      movesByOwner[owner].push(action);
    });
    
    // Render grouped
    Object.entries(movesByOwner).forEach(([owner,actions])=>{
      const initials=owner.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
      html+='<div class="report-moves-group">';
      html+='<div class="report-moves-owner">';
      html+='<div class="report-moves-avatar">'+initials+'</div>';
      html+='<span class="report-moves-name">'+e(owner)+'</span>';
      if(actions.length>1)html+='<span class="report-moves-count">'+actions.length+' actions</span>';
      html+='</div>';
      html+='<div class="report-moves-list">';
      actions.forEach(action=>{
        html+='<div class="report-move-item">'+linkify(action)+'</div>';
      });
      html+='</div></div>';
    });
    html+='</div>';
  }
  
  // Lookahead Timeline
  if(json.lookahead&&json.lookahead.length){
    html+='<div class="report-section">';
    html+='<div class="report-section-header">';
    html+='<svg class="report-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';
    html+='<span class="report-section-title">Lookahead</span>';
    html+='</div>';
    html+='<div class="report-timeline">';
    html+='<div class="report-timeline-line"></div>';
    html+='<div class="report-timeline-items">';
    json.lookahead.forEach((item,i)=>{
      let date,event;
      if(typeof item==='string'){
        const match=item.match(/^([^:]+):\s*(.+)$/);
        if(match){date=match[1].trim();event=match[2].trim();}
        else{date='';event=item;}
      }else{
        date=item.date||'';
        event=item.event||'';
      }
      html+='<div class="report-timeline-item">';
      html+='<div class="report-timeline-dot'+(i===0?' today':'')+'"></div>';
      html+='<div class="report-timeline-date">'+e(date)+'</div>';
      html+='<div class="report-timeline-event">'+linkify(event)+'</div>';
      html+='</div>';
    });
    html+='</div></div></div>';
  }
  
  // Missing Info
  if(json.missingInfo&&json.missingInfo.length){
    html+='<div class="report-section">';
    html+='<div class="report-section-header">';
    html+='<svg class="report-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
    html+='<span class="report-section-title">Missing Info</span>';
    html+='</div>';
    html+='<div class="report-missing">';
    json.missingInfo.forEach(item=>{
      html+='<div class="report-missing-item">'+linkify(item)+'</div>';
    });
    html+='</div></div>';
  }
  
  // Timestamp
  html+='<div class="report-timestamp">Generated '+new Date(ctx.meta.generatedAt).toLocaleString()+'</div>';
  
  return html;
}

// ============================================================
// PORTFOLIO REPORT FUNCTIONS
// ============================================================

let cachedPortfolioReport = null;
let portfolioReportListener = null;

// Setup listener for portfolio report from Firebase
function setupPortfolioReportListener() {
  if (portfolioReportListener) return;
  
  portfolioReportListener = db.ref('portfolio/report').on('value', snap => {
    const report = snap.val();
    if (report) {
      cachedPortfolioReport = report;
      console.log('ðŸ“Š Portfolio report synced from Firebase:', new Date(report.generatedAt).toLocaleString());
      
      // Update modal if open
      if ($('portfolioReportModal').classList.contains('open')) {
        displayCachedPortfolioReport();
      }
    }
  });
}

// Call this when global data is loaded
function initPortfolioReportListener() {
  if (globalDataLoaded) {
    setupPortfolioReportListener();
  }
}

// Build context for portfolio report by loading all projects' data
async function buildPortfolioReportContext() {
  const today = new Date().toISOString().split('T')[0];
  const todayTs = new Date(today).getTime();
  const dayMs = 86400000;
  
  // Get active projects only
  const projectList = Object.entries(projectIndex)
    .map(([id, p]) => ({ id, ...p }))
    .filter(p => !p.archived)
    .sort((a, b) => {
      // Sort by end date (earliest first)
      if (a.endDate && b.endDate) return a.endDate.localeCompare(b.endDate);
      if (a.endDate) return -1;
      if (b.endDate) return 1;
      return (a.name || '').localeCompare(b.name || '');
    });
  
  if (!projectList.length) {
    return null;
  }
  
  // Load detailed data for each project
  const projectsData = [];
  const aggregateCounts = { waiting: 0, toOrder: 0, ordered: 0, arrived: 0, tested: 0, configured: 0, installed: 0, total: 0 };
  const allBottlenecks = [];
  let totalWeightedProgress = 0;
  let totalParts = 0;
  
  for (const proj of projectList) {
    try {
      // Load project data from Firebase
      const snap = await db.ref('projects/' + proj.id).once('value');
      const projData = snap.val() || {};
      
      // Get parts (exclude deleted)
      const partsRaw = projData.parts ? Object.entries(projData.parts).map(([id, p]) => ({ id, ...p })) : [];
      const parts = partsRaw.filter(p => !p._deletedAt);
      
      if (!parts.length) {
        projectsData.push({
          code: proj.id,
          name: proj.name || proj.id,
          status: 'on-track',
          progress: 0,
          expected: 0,
          daysLeft: null,
          endDate: proj.endDate || null,
          stuckCount: 0,
          topBlocker: 'No parts data'
        });
        continue;
      }
      
      // Calculate progress (same algorithm as calcOverallProgress)
      const stages = ['waiting', 'to-order', 'ordered', 'arrived', 'tested', 'configured', 'installed'];
      const partProgress = parts.reduce((acc, p) => acc + stages.indexOf(p.status) / (stages.length - 1), 0);
      const progress = Math.round(partProgress / parts.length * 100);
      
      // Calculate expected progress
      let expected = 0;
      if (proj.startDate && proj.endDate) {
        const start = new Date(proj.startDate).getTime();
        const end = new Date(proj.endDate).getTime();
        const elapsed = todayTs - start;
        const total = end - start;
        if (total > 0 && elapsed >= 0) {
          expected = Math.min(100, Math.round(elapsed / total * 100));
        }
      }
      
      // Calculate days left
      let daysLeft = null;
      if (proj.endDate) {
        const end = new Date(proj.endDate).getTime();
        daysLeft = Math.ceil((end - todayTs) / dayMs);
      }
      
      // Determine status
      let status = 'on-track';
      if (expected > 0) {
        const diff = progress - expected;
        if (diff < -10) status = 'critical';
        else if (diff < 0) status = 'behind';
      }
      
      // Count parts by status
      const counts = {
        waiting: parts.filter(p => p.status === 'waiting').length,
        toOrder: parts.filter(p => p.status === 'to-order').length,
        ordered: parts.filter(p => p.status === 'ordered').length,
        arrived: parts.filter(p => p.status === 'arrived').length,
        tested: parts.filter(p => p.status === 'tested').length,
        configured: parts.filter(p => p.status === 'configured').length,
        installed: parts.filter(p => p.status === 'installed').length
      };
      
      // Aggregate counts
      Object.keys(aggregateCounts).forEach(k => {
        if (k !== 'total') aggregateCounts[k] += counts[k] || 0;
      });
      aggregateCounts.total += parts.length;
      
      // Track for weighted average
      totalWeightedProgress += progress * parts.length;
      totalParts += parts.length;
      
      // Find stuck parts (arrived/tested/configured for >7 days)
      const stuckParts = parts.filter(p => {
        if (!['arrived', 'tested', 'configured'].includes(p.status)) return false;
        if (!p.changedAt) return false;
        const daysInStatus = Math.floor((todayTs - p.changedAt) / dayMs);
        return daysInStatus > 7;
      });
      
      // Identify bottleneck
      let topBlocker = '';
      if (stuckParts.length > 0) {
        const byStatus = {};
        stuckParts.forEach(p => {
          byStatus[p.status] = (byStatus[p.status] || 0) + 1;
        });
        const maxStatus = Object.entries(byStatus).sort((a, b) => b[1] - a[1])[0];
        if (maxStatus) {
          const statusLabel = maxStatus[0] === 'arrived' ? 'testing' : maxStatus[0] === 'tested' ? 'configuration' : 'installation';
          topBlocker = maxStatus[1] + ' parts awaiting ' + statusLabel;
          
          // Add to global bottlenecks
          allBottlenecks.push({
            project: proj.name || proj.id,
            projectCode: proj.id,
            type: statusLabel,
            count: maxStatus[1],
            oldestDays: Math.max(...stuckParts.filter(p => p.status === maxStatus[0]).map(p => Math.floor((todayTs - p.changedAt) / dayMs)))
          });
        }
      } else if (counts.ordered > 0) {
        topBlocker = counts.ordered + ' parts on order';
      } else if (counts.toOrder > 0) {
        topBlocker = counts.toOrder + ' parts to order';
      } else {
        topBlocker = 'On track';
      }
      
      projectsData.push({
        code: proj.id,
        name: proj.name || proj.id,
        status,
        progress,
        expected,
        daysLeft,
        endDate: proj.endDate || null,
        stuckCount: stuckParts.length,
        topBlocker
      });
      
    } catch (e) {
      console.warn('Failed to load project:', proj.id, e);
      projectsData.push({
        code: proj.id,
        name: proj.name || proj.id,
        status: 'on-track',
        progress: proj.progress || 0,
        expected: 0,
        daysLeft: null,
        endDate: proj.endDate || null,
        stuckCount: 0,
        topBlocker: 'Could not load data'
      });
    }
  }
  
  // Calculate overall portfolio progress (weighted by parts count)
  const overallProgress = totalParts > 0 ? Math.round(totalWeightedProgress / totalParts) : 0;
  
  // Calculate overall expected (average of projects with dates)
  const projectsWithExpected = projectsData.filter(p => p.expected > 0);
  const overallExpected = projectsWithExpected.length > 0
    ? Math.round(projectsWithExpected.reduce((acc, p) => acc + p.expected, 0) / projectsWithExpected.length)
    : 0;
  
  // Count statuses
  const statusCounts = {
    onTrack: projectsData.filter(p => p.status === 'on-track').length,
    behind: projectsData.filter(p => p.status === 'behind').length,
    critical: projectsData.filter(p => p.status === 'critical').length
  };
  
  // Aggregate bottlenecks by type
  const bottlenecksByType = {};
  allBottlenecks.forEach(b => {
    if (!bottlenecksByType[b.type]) {
      bottlenecksByType[b.type] = {
        type: b.type,
        projects: [],
        totalCount: 0,
        oldestDays: 0
      };
    }
    bottlenecksByType[b.type].projects.push(b.project);
    bottlenecksByType[b.type].totalCount += b.count;
    bottlenecksByType[b.type].oldestDays = Math.max(bottlenecksByType[b.type].oldestDays, b.oldestDays);
  });
  
  const aggregatedBottlenecks = Object.values(bottlenecksByType)
    .sort((a, b) => b.totalCount - a.totalCount)
    .slice(0, 5);
  
  // Upcoming deadlines (next 60 days)
  const upcomingDeadlines = projectsData
    .filter(p => p.endDate && p.daysLeft !== null && p.daysLeft > 0 && p.daysLeft <= 60)
    .sort((a, b) => a.daysLeft - b.daysLeft)
    .slice(0, 6)
    .map(p => ({
      project: p.name,
      code: p.code,
      date: p.endDate,
      daysLeft: p.daysLeft,
      status: p.status
    }));
  
  return {
    meta: {
      today,
      generatedAt: new Date().toISOString()
    },
    
    portfolio: {
      activeProjects: projectsData.length,
      onTrack: statusCounts.onTrack,
      behind: statusCounts.behind,
      critical: statusCounts.critical,
      totalParts: aggregateCounts.total,
      overallProgress,
      overallExpected
    },
    
    projects: projectsData,
    
    aggregatePipeline: aggregateCounts,
    
    bottlenecks: aggregatedBottlenecks,
    
    upcomingDeadlines,
    
    previousReport: cachedPortfolioReport ? {
      generatedAt: cachedPortfolioReport.generatedAt,
      summary: cachedPortfolioReport.summary
    } : null
  };
}

// Render portfolio report HTML
function renderPortfolioReportHTML(json, ctx) {
  const e = s => esc(String(s || ''));
  const pf = ctx.portfolio;
  const c = ctx.aggregatePipeline;
  
  // Status class
  const statusClass = json.status === 'critical' ? 'status-critical' :
    json.status === 'at-risk' ? 'status-behind' : 'status-on-track';
  const statusLabel = json.status === 'at-risk' ? 'AT RISK' : json.status.toUpperCase();
  
  let html = '';
  
  // Header
  html += '<div class="report-header">';
  html += '<div class="report-title">Master Schedule</div>';
  html += '<div class="report-header-row">';
  html += '<span class="report-status-badge ' + statusClass + '">' + statusLabel + '</span>';
  html += '<span class="report-date">' + e(ctx.meta.today) + '</span>';
  html += '<span class="report-days-left">' + pf.activeProjects + ' active projects</span>';
  html += '</div>';
  
  // Portfolio stats
  html += '<div class="portfolio-stats">';
  html += '<span class="portfolio-stat"><strong>' + pf.onTrack + '</strong> on track</span>';
  if (pf.behind > 0) html += '<span class="portfolio-stat"><strong>' + pf.behind + '</strong> behind</span>';
  if (pf.critical > 0) html += '<span class="portfolio-stat"><strong>' + pf.critical + '</strong> critical</span>';
  html += '<span class="portfolio-stat"><strong>' + pf.totalParts + '</strong> total parts</span>';
  html += '</div>';
  
  // Progress Bar
  html += '<div class="report-progress-container">';
  html += '<div class="report-progress-bar">';
  html += '<div class="report-progress-fill ' + statusClass + '" style="width:' + Math.min(pf.overallProgress, 100) + '%"></div>';
  if (pf.overallExpected > 0) html += '<div class="report-progress-expected" style="left:' + Math.min(pf.overallExpected, 100) + '%"></div>';
  html += '</div>';
  html += '<div class="report-progress-labels">';
  html += '<span class="report-progress-current">' + pf.overallProgress + '% complete</span>';
  if (pf.overallExpected > 0) html += '<span class="report-progress-target">' + pf.overallExpected + '% expected</span>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  
  // Aggregate Pipeline
  const maxCount = Math.max(c.waiting || 0, c.toOrder || 0, c.ordered || 0, c.arrived || 0, c.tested || 0, c.configured || 0, c.installed || 0, 1);
  html += '<div class="report-pipeline">';
  html += '<div class="report-pipeline-title">Aggregate Pipeline</div>';
  const stages = [
    { key: 'waiting', label: 'Waiting', count: c.waiting || 0 },
    { key: 'to-order', label: 'To Order', count: c.toOrder || 0 },
    { key: 'ordered', label: 'Ordered', count: c.ordered || 0 },
    { key: 'arrived', label: 'Arrived', count: c.arrived || 0 },
    { key: 'tested', label: 'Tested', count: c.tested || 0 },
    { key: 'configured', label: 'Configured', count: c.configured || 0 },
    { key: 'installed', label: 'Installed', count: c.installed || 0 }
  ];
  stages.forEach(s => {
    const pct = Math.round((s.count / maxCount) * 100);
    html += '<div class="report-pipeline-row">';
    html += '<span class="report-pipeline-label">' + s.label + '</span>';
    html += '<div class="report-pipeline-bar-container"><div class="report-pipeline-bar s-' + s.key + '" style="width:' + pct + '%"></div></div>';
    html += '<span class="report-pipeline-count">' + s.count + '</span>';
    html += '</div>';
  });
  html += '</div>';
  
  // Summary (handle paragraphs)
  if (json.summary) {
    const summaryHtml = e(json.summary).replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
    html += '<div class="report-summary"><p>' + summaryHtml + '</p></div>';
  }
  
  // Projects Section
  if (json.projectHighlights && json.projectHighlights.length) {
    html += '<div class="report-section">';
    html += '<div class="report-section-header">';
    html += '<svg class="report-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="4" rx="1"/><rect x="3" y="10" width="13" height="4" rx="1"/><rect x="3" y="16" width="16" height="4" rx="1"/></svg>';
    html += '<span class="report-section-title">Projects</span>';
    html += '</div>';
    html += '<div class="report-projects">';
    
    json.projectHighlights.forEach(ph => {
      const proj = ctx.projects.find(p => p.code === ph.code) || {};
      const pStatus = ph.status || proj.status || 'on-track';
      const pProgress = proj.progress || 0;
      const pDays = proj.daysLeft;
      
      html += '<div class="report-project-card" onclick="window.openProjectFromReport(\'' + e(ph.code) + '\')">';
      html += '<div class="report-project-status ' + pStatus + '"></div>';
      html += '<div class="report-project-content">';
      html += '<div class="report-project-header">';
      html += '<span class="report-project-name">' + e(proj.name || ph.code) + '</span>';
      html += '<div class="report-project-progress">';
      html += '<div class="report-project-bar"><div class="report-project-bar-fill ' + pStatus + '" style="width:' + pProgress + '%"></div></div>';
      html += '<span class="report-project-pct">' + pProgress + '%</span>';
      if (pDays !== null && pDays > 0) html += '<span class="report-project-days">' + pDays + 'd</span>';
      html += '</div>';
      html += '</div>';
      html += '<div class="report-project-highlight">' + e(ph.highlight || proj.topBlocker) + '</div>';
      html += '</div>';
      html += '<div class="report-project-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>';
      html += '</div>';
    });
    
    html += '</div></div>';
  }
  
  // Top Issues
  if (json.topIssues && json.topIssues.length) {
    html += '<div class="report-section">';
    html += '<div class="report-section-header">';
    html += '<svg class="report-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
    html += '<span class="report-section-title">Top Issues</span>';
    html += '</div>';
    html += '<div class="report-issues">';
    json.topIssues.forEach(issue => {
      const text = typeof issue === 'string' ? issue : issue.text;
      const severity = typeof issue === 'object' && issue.severity ? issue.severity : 'medium';
      html += '<div class="report-issue">';
      html += '<div class="report-severity ' + severity + '"></div>';
      html += '<div class="report-issue-text">' + e(text) + '</div>';
      html += '</div>';
    });
    html += '</div></div>';
  }
  
  // Upcoming Deadlines
  if (json.upcomingDeadlines && json.upcomingDeadlines.length) {
    html += '<div class="report-section">';
    html += '<div class="report-section-header">';
    html += '<svg class="report-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';
    html += '<span class="report-section-title">Upcoming Deadlines (60 days)</span>';
    html += '</div>';
    html += '<div class="report-timeline">';
    html += '<div class="report-timeline-line"></div>';
    html += '<div class="report-timeline-items">';
    json.upcomingDeadlines.forEach((dl, i) => {
      const risk = dl.risk || 'low';
      const dateStr = dl.date || '';
      
      // Handle both "Mar 15" and "2026-03-15" formats
      let dateFormatted = dateStr;
      if (dateStr && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
        // ISO format - parse and format
        const d = new Date(dateStr + 'T00:00:00');
        if (!isNaN(d.getTime())) {
          dateFormatted = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
      }
      // Otherwise use as-is (e.g., "Mar 15")
      
      html += '<div class="report-deadline-item">';
      html += '<div class="report-timeline-dot' + (i === 0 ? ' today' : '') + '"></div>';
      html += '<div class="report-timeline-date">' + e(dateFormatted) + '</div>';
      html += '<div class="report-timeline-event">' + e(dl.project) + '</div>';
      html += '<span class="report-deadline-risk ' + risk + '">' + risk.toUpperCase() + ' RISK</span>';
      html += '</div>';
    });
    html += '</div></div></div>';
  }
  
  // Missing Info
  if (json.missingInfo && json.missingInfo.length) {
    html += '<div class="report-section">';
    html += '<div class="report-section-header">';
    html += '<svg class="report-section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
    html += '<span class="report-section-title">Missing Info</span>';
    html += '</div>';
    html += '<div class="report-missing">';
    json.missingInfo.forEach(item => {
      html += '<div class="report-missing-item">' + e(item) + '</div>';
    });
    html += '</div></div>';
  }
  
  // Timestamp
  html += '<div class="report-timestamp">Generated ' + new Date(ctx.meta.generatedAt).toLocaleString() + '</div>';
  
  return html;
}

// Navigate to project from portfolio report
window.openProjectFromReport = function(projectCode) {
  // Close the portfolio report modal
  $('portfolioReportModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');

  // Close master schedule and insights panel
  closeMasterInsightsPanel();
  $('masterScheduleOverlay').classList.remove('open');

  // Navigate to the project
  setProjectCode(projectCode);
};

// Generate portfolio report
// Generate portfolio report
window.generatePortfolioReport = async function() {
  const modelSelect = $('portfolioModelSelect');
  const selectedModel = modelSelect.value;
  const modelName = modelSelect.options[modelSelect.selectedIndex].text;
  
  $('portfolioReportContent').innerHTML = '<div class="report-loading"><div class="report-loading-spinner"></div><div class="report-loading-text">Loading project data...</div></div>';
  
  try {
    // Build context (this loads all projects' data)
    const ctx = await buildPortfolioReportContext();
    
    if (!ctx) {
      $('portfolioReportContent').innerHTML = '<div class="report-empty-state"><p>No active projects found.</p></div>';
      return;
    }
    
    $('portfolioReportContent').innerHTML = '<div class="report-loading"><div class="report-loading-spinner"></div><div class="report-loading-text">Generating report with ' + modelName + '...</div></div>';
    
    // Call Cloud Function
    const generateInsights = firebase.functions().httpsCallable('generateInsights');
    const result = await generateInsights({
      mode: 'master-report',
      model: selectedModel,
      projectContext: ctx
    });
    
    if (!result.data.success) {
      throw new Error(result.data.error || 'Failed to generate report');
    }
    
    // Parse JSON response
    let reportData;
    try {
      let content = result.data.content;
      console.log('ðŸ“Š Raw AI response:', content);
      
      // Remove markdown code blocks if present
      if (content.includes('```json')) {
        content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '');
      } else if (content.includes('```')) {
        content = content.replace(/```\n?/g, '');
      }
      
      // Try to extract JSON if wrapped in other text
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        content = jsonMatch[0];
      }
      
      console.log('ðŸ“Š Cleaned content:', content.substring(0, 200) + '...');
      reportData = JSON.parse(content.trim());
    } catch (parseError) {
      console.error('Failed to parse report JSON:', parseError);
      console.error('Raw content was:', result.data.content);
      throw new Error('Failed to parse AI response');
    }
    
    // Validate required fields
    if (!reportData.status || !reportData.summary) {
      throw new Error('Invalid report format');
    }
    
    // Cache the report
    cachedPortfolioReport = {
      ...reportData,
      generatedAt: Date.now(),
      model: selectedModel
    };
    
    // Save to Firebase
    await db.ref('portfolio/report').set(cachedPortfolioReport);
    
    // Update badge
    $('portfolioModelBadge').textContent = modelName.toLowerCase().replace(' ', '-');
    
    // Render
    $('portfolioReportContent').innerHTML = renderPortfolioReportHTML(reportData, ctx);
    
  } catch (error) {
    console.error('Portfolio report generation failed:', error);
    $('portfolioReportContent').innerHTML = '<div class="report-empty-state"><p>Failed to generate report: ' + esc(error.message) + '</p><button class="btn btn-primary" onclick="event.stopPropagation(); generatePortfolioReport()">Try Again</button></div>';
  }
}

// Display cached portfolio report
async function displayCachedPortfolioReport() {
  if (!cachedPortfolioReport) {
    showPortfolioEmptyState();
    return;
  }
  
  $('portfolioReportContent').innerHTML = '<div class="report-loading"><div class="report-loading-spinner"></div><div class="report-loading-text">Loading...</div></div>';
  
  try {
    const ctx = await buildPortfolioReportContext();
    if (!ctx) {
      showPortfolioEmptyState();
      return;
    }
    
    // Update model badge
    if (cachedPortfolioReport.model) {
      const modelName = cachedPortfolioReport.model.includes('opus') ? 'opus-4.5' : 'sonnet-4.5';
      $('portfolioModelBadge').textContent = modelName;
    }
    
    $('portfolioReportContent').innerHTML = renderPortfolioReportHTML(cachedPortfolioReport, ctx);
  } catch (error) {
    console.error('Failed to display cached report:', error);
    showPortfolioEmptyState();
  }
}

// Show empty state for portfolio report
function showPortfolioEmptyState() {
  $('portfolioReportContent').innerHTML = `
    <div class="report-empty-state">
      <div class="report-empty-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="4" width="18" height="4" rx="1"/>
          <rect x="3" y="10" width="13" height="4" rx="1"/>
          <rect x="3" y="16" width="16" height="4" rx="1"/>
        </svg>
      </div>
      <p class="report-empty-title">No portfolio report yet</p>
      <p class="report-empty-desc">Generate a comprehensive status report across all active projects.</p>
      <button class="btn btn-primary" onclick="event.stopPropagation(); generatePortfolioReport()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 3v3m0 12v3m-9-9h3m12 0h3m-4.6-7.4l-2.1 2.1m-5.7 5.7l-2.1 2.1m0-9.9l2.1 2.1m5.7 5.7l2.1 2.1"/></svg>
        Generate Portfolio Report
      </button>
    </div>
  `;
}

function getSupplierStats(){
  const parts=getParts();
  const suppliers={};
  parts.forEach(p=>{
    if(p.mfr){
      if(!suppliers[p.mfr])suppliers[p.mfr]={total:0,installed:0,ordered:0};
      suppliers[p.mfr].total++;
      if(p.status==='installed')suppliers[p.mfr].installed++;
      if(p.status==='ordered')suppliers[p.mfr].ordered++;
    }
  });
  return Object.entries(suppliers).map(([name,s])=>({
    name,
    total:s.total,
    installed:s.installed,
    pending:s.ordered
  })).sort((a,b)=>b.total-a.total).slice(0,8);
}

function getWorkloadStats(){
  const parts=getParts();
  const workload={};
  parts.forEach(p=>{
    const assignee=p.assignee||'Unassigned';
    if(!workload[assignee])workload[assignee]={total:0,installed:0,pending:0};
    workload[assignee].total++;
    if(p.status==='installed')workload[assignee].installed++;
    else workload[assignee].pending++;
  });
  return Object.entries(workload).map(([name,w])=>({
    name,
    total:w.total,
    installed:w.installed,
    pending:w.pending
  })).sort((a,b)=>b.pending-a.pending).slice(0,6);
}

function formatReportResponse(text){
  let html=text;
  
  // Process charts BEFORE escaping
  // Bar chart
  html=html.replace(/\[CHART:bar:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)};
      });
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*40+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 400 '+h+'" width="400" style="margin:16px 0">';
      items.forEach((item,i)=>{
        const w=Math.round(item.val/max*200);
        const y=i*40+10;
        svg+='<text x="8" y="'+(y+24)+'" font-size="13" fill="var(--text2)">'+item.label+'</text>';
        svg+='<rect x="140" y="'+(y+8)+'" width="'+w+'" height="24" rx="6" fill="var(--accent)" opacity="0.75"/>';
        svg+='<text x="'+(150+w)+'" y="'+(y+26)+'" font-size="14" fill="var(--text)" font-weight="500">'+item.val+'</text>';
      });
      svg+='</svg>';
      return svg;
    }catch(e){return '';}
  });
  
  // Funnel chart
  html=html.replace(/\[CHART:funnel:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)};
      });
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*44+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 420 '+h+'" width="420" style="margin:16px 0">';
      items.forEach((item,i)=>{
        const w=Math.round(item.val/max*200);
        const x=(200-w)/2+120;
        const y=i*44+10;
        svg+='<text x="8" y="'+(y+26)+'" font-size="12" fill="var(--text3)">'+item.label+'</text>';
        svg+='<rect x="'+x+'" y="'+(y+8)+'" width="'+w+'" height="28" rx="6" fill="var(--s'+((i%6)+1)+')" opacity="0.85"/>';
        svg+='<text x="340" y="'+(y+28)+'" font-size="14" fill="var(--text)" font-weight="600">'+item.val+'</text>';
      });
      svg+='</svg>';
      return svg;
    }catch(e){return '';}
  });
  
  // Extract SVGs before escaping
  const svgParts=[];
  html=html.replace(/<svg[\s\S]*?<\/svg>/g,(match)=>{
    svgParts.push(match);
    return '{{SVG'+(svgParts.length-1)+'}}';
  });
  
  // Escape HTML
  html=esc(html);
  
  // Restore SVGs
  svgParts.forEach((v,i)=>{html=html.replace('{{SVG'+i+'}}',v);});
  
  // Replace [[Part Name]] with clickable links
  html=html.replace(/\[\[([^\]]+)\]\]/g,(match,partName)=>{
    // Try exact match first (case-insensitive)
    let part=getParts().find(p=>p.name.toLowerCase()===partName.toLowerCase().trim());
    
    // If no exact match, try partial match
    if(!part){
      const searchName=partName.toLowerCase().trim();
      part=getParts().find(p=>
        p.name.toLowerCase().includes(searchName) || 
        searchName.includes(p.name.toLowerCase())
      );
    }
    
    // If still no match, try matching just the first word
    if(!part){
      const firstWord=partName.toLowerCase().trim().split(/\s+/)[0];
      if(firstWord.length>3){
        part=getParts().find(p=>p.name.toLowerCase().startsWith(firstWord));
      }
    }
    
    if(part){
      return '<a class="ai-part-link" href="#" onclick="window.aiGoToPart(\''+part.id+'\',event);return false;">'+partName+'</a>';
    }
    return '<strong>'+partName+'</strong>';
  });
  
  // Replace {{Assembly Name}} with clickable links  
  html=html.replace(/\{\{([^\}]+)\}\}/g,(match,asmName)=>{
    // Skip our SVG placeholders
    if(asmName.startsWith('SVG'))return match;
    const asm=getAsms().find(a=>a.name.toLowerCase()===asmName.toLowerCase());
    if(asm){
      return '<a class="ai-asm-link" href="#" onclick="window.aiGoToAsm(\''+asm.id+'\');return false;">'+asmName+'</a>';
    }
    return '<strong>'+asmName+'</strong>';
  });
  
  // Replace **bold** with <strong>
  html=html.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  
  // Replace headers
  html=html.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  html=html.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  html=html.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  
  // Replace --- with divider
  html=html.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid var(--border);margin:20px 0">');
  
  // Replace bullet points
  html=html.replace(/^[â€¢\-\*] (.+)$/gm,'<li>$1</li>');
  
  // Wrap consecutive li elements in ul
  html=html.replace(/(<li>.*<\/li>\n?)+/g,(match)=>'<ul>'+match+'</ul>');
  
  // Replace numbered lists
  html=html.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
  
  // Handle ALL CAPS headers
  html=html.replace(/^([A-Z][A-Z\s&]+):?\s*$/gm,'<h2 style="margin-top:24px">$1</h2>');
  
  // Paragraphs - split by double newline
  const parts=html.split(/\n\n+/);
  const processed=parts.map(p=>{
    p=p.trim();
    if(!p)return '';
    if(p.startsWith('<'))return p;
    return '<p>'+p.replace(/\n/g,' ')+'</p>';
  }).filter(p=>p).join('\n');
  
  return '<div class="report-prose">'+processed+'</div>';
}

$('reportRefresh').onclick=async()=>{
  await window.generateOpusReport();
};
$('reportClose').onclick=()=>{$('reportModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
document.addEventListener('click',e=>{
  const popover=$('reportModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#reportBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});
$('reportCreatePDF').onclick=async()=>{
  const btn=$('reportCreatePDF');
  const originalText=btn.innerHTML;
  btn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;animation:spin 1s linear infinite"><path d="M12 2v4m0 12v4m-10-10h4m12 0h4"/></svg>Creating...';
  btn.disabled=true;
  
  try{
    const projectName=currentProjectName||'Project';
    const dateStr=new Date().toISOString().split('T')[0];
    const filename=projectName.replace(/[^a-zA-Z0-9]/g,'-')+'-Report-'+dateStr+'.pdf';
    
    const{jsPDF}=window.jspdf;
    const pdf=new jsPDF('p','mm','a4');
    const pageWidth=210;
    const pageHeight=297;
    const margin=15;
    const contentWidth=pageWidth-margin*2;
    let y=margin;
    
    // Colors
    const colors={
      black:[26,26,26],
      gray:[107,114,128],
      lightGray:[245,245,245],
      accent:[216,119,86],
      green:[34,197,94],
      yellow:[245,158,11],
      red:[239,68,68],
      blue:[37,99,235]
    };
    
    // Helper: check page break
    function checkPage(needed){
      if(y+needed>pageHeight-margin){
        pdf.addPage();
        y=margin;
        return true;
      }
      return false;
    }
    
    // Helper: draw rounded rect
    function roundedRect(x,y,w,h,r,fill,stroke){
      pdf.setFillColor(...fill);
      if(stroke)pdf.setDrawColor(...stroke);
      pdf.roundedRect(x,y,w,h,r,r,stroke?'FD':'F');
    }
    
    // Helper: wrap text
    function wrapText(text,maxWidth,fontSize){
      pdf.setFontSize(fontSize);
      const words=text.split(' ');
      const lines=[];
      let line='';
      words.forEach(word=>{
        const test=line?line+' '+word:word;
        if(pdf.getTextWidth(test)>maxWidth){
          if(line)lines.push(line);
          line=word;
        }else{
          line=test;
        }
      });
      if(line)lines.push(line);
      return lines;
    }
    
    // Get report data
    const report=cachedReport;
    if(!report){
      alert('No report to export');
      btn.innerHTML=originalText;
      btn.disabled=false;
      return;
    }
    const ctx=buildReportContext();
    const p=ctx.project;
    const c=ctx.counts;
    
    // === TITLE ===
    pdf.setFont('helvetica','bold');
    pdf.setFontSize(20);
    pdf.setTextColor(...colors.black);
    pdf.text(p.name||projectName,margin,y+7);
    y+=14;
    
    // === STATUS BADGE & DATE ===
    const status=report.status||'on-track';
    const statusColors={
      'on-track':{bg:[220,252,231],text:[22,101,52]},
      'behind':{bg:[254,243,199],text:[180,83,9]},
      'critical':{bg:[254,226,226],text:[185,28,28]}
    };
    const sc=statusColors[status]||statusColors['on-track'];
    const statusText=status.toUpperCase();
    pdf.setFontSize(9);
    const statusWidth=pdf.getTextWidth(statusText)+8;
    roundedRect(margin,y,statusWidth,6,1.5,sc.bg);
    pdf.setTextColor(...sc.text);
    pdf.setFont('helvetica','bold');
    pdf.text(statusText,margin+4,y+4.3);
    
    pdf.setFont('helvetica','normal');
    pdf.setTextColor(...colors.gray);
    pdf.setFontSize(10);
    pdf.text(ctx.meta.today,margin+statusWidth+6,y+4.3);
    
    const daysLeft=p.daysLeft||0;
    if(daysLeft>0){
      const daysText=daysLeft+' days left';
      pdf.text(daysText,pageWidth-margin-pdf.getTextWidth(daysText),y+4.3);
    }
    y+=12;
    
    // === PROGRESS BAR ===
    const progress=p.progressPct||0;
    const expected=p.expectedPct||0;
    const barHeight=4;
    const barY=y;
    
    // Background
    roundedRect(margin,barY,contentWidth,barHeight,2,colors.lightGray);
    
    // Fill
    const fillWidth=Math.min(progress,100)/100*contentWidth;
    const fillColor=status==='critical'?colors.red:status==='behind'?colors.yellow:colors.green;
    if(fillWidth>0)roundedRect(margin,barY,fillWidth,barHeight,2,fillColor);
    
    // Expected marker
    if(expected>0){
      const expectedX=margin+(Math.min(expected,100)/100*contentWidth);
      pdf.setDrawColor(...colors.gray);
      pdf.setLineWidth(0.5);
      pdf.line(expectedX,barY-2,expectedX,barY+barHeight+2);
      pdf.setFontSize(7);
      pdf.setTextColor(...colors.gray);
      pdf.text('Expected',expectedX,barY-3,{align:'center'});
    }
    
    y+=barHeight+4;
    pdf.setFontSize(10);
    pdf.setTextColor(...colors.black);
    pdf.setFont('helvetica','bold');
    pdf.text(progress+'% complete',margin,y+3);
    if(expected>0){
      pdf.setFont('helvetica','normal');
      pdf.setTextColor(...colors.gray);
      const expText=expected+'% expected';
      pdf.text(expText,pageWidth-margin-pdf.getTextWidth(expText),y+3);
    }
    y+=10;
    
    // === PIPELINE ===
    checkPage(50);
    roundedRect(margin,y,contentWidth,48,3,colors.lightGray);
    y+=4;
    pdf.setFontSize(8);
    pdf.setFont('helvetica','bold');
    pdf.setTextColor(...colors.gray);
    pdf.text('PIPELINE',margin+6,y+4);
    y+=8;
    
    const stages=[
      {label:'Waiting',count:c.waiting||0},
      {label:'To Order',count:c.toOrder||0},
      {label:'Ordered',count:c.ordered||0},
      {label:'Arrived',count:c.arrived||0,note:ctx.arrivedStuckCount?' ('+ctx.arrivedStuckCount+' stuck)':''},
      {label:'Tested',count:c.tested||0},
      {label:'Configured',count:c.configured||0},
      {label:'Installed',count:c.installed||0}
    ];
    const maxCount=Math.max(...stages.map(s=>s.count),1);
    const barStartX=margin+28;
    const barW=contentWidth-65;
    
    stages.forEach(s=>{
      pdf.setFontSize(9);
      pdf.setFont('helvetica','normal');
      pdf.setTextColor(...colors.gray);
      pdf.text(s.label,margin+6,y+3);
      
      // Bar background
      pdf.setFillColor(230,230,230);
      pdf.roundedRect(barStartX,y-1,barW,4,1,1,'F');
      
      // Bar fill
      const fillW=(s.count/maxCount)*barW;
      if(fillW>0){
        pdf.setFillColor(...colors.blue);
        pdf.roundedRect(barStartX,y-1,fillW,4,1,1,'F');
      }
      
      // Count
      pdf.setTextColor(...colors.black);
      pdf.setFont('helvetica','bold');
      const countX=barStartX+barW+4;
      pdf.text(String(s.count),countX,y+3);
      
      if(s.note){
        pdf.setFont('helvetica','normal');
        pdf.setTextColor(...colors.yellow);
        pdf.setFontSize(8);
        pdf.text(s.note,countX+10,y+3);
      }
      
      y+=5.5;
    });
    y+=6;
    
    // === SUMMARY ===
    checkPage(40);
    const summaryText=report.summary||'';
    const paragraphs=summaryText.split(/\n\n+/).filter(p=>p.trim());
    
    // Calculate total height needed
    let totalLines=0;
    const paraData=paragraphs.map(para=>{
      const lines=wrapText(para.replace(/\n/g,' ').trim(),contentWidth-18,10);
      totalLines+=lines.length;
      return lines;
    });
    const summaryHeight=totalLines*5+(paragraphs.length-1)*4+16;
    
    roundedRect(margin,y,contentWidth,summaryHeight,3,colors.lightGray);
    pdf.setFillColor(...colors.accent);
    pdf.rect(margin,y+3,1.5,summaryHeight-6,'F');
    
    pdf.setFont('helvetica','normal');
    pdf.setFontSize(10);
    pdf.setTextColor(...colors.black);
    let sy=y+9;
    paraData.forEach((lines,pi)=>{
      lines.forEach(line=>{
        pdf.text(line,margin+10,sy);
        sy+=5;
      });
      if(pi<paraData.length-1)sy+=4; // paragraph spacing
    });
    y+=summaryHeight+6;
    
    // === TOP ISSUES ===
    if(report.topIssues&&report.topIssues.length){
      checkPage(20);
      y+=6;
      pdf.setFontSize(9);
      pdf.setFont('helvetica','bold');
      pdf.setTextColor(...colors.gray);
      pdf.text('âš   TOP ISSUES',margin,y+3);
      y+=10;
      
      report.topIssues.forEach(issue=>{
        checkPage(12);
        const text=typeof issue==='string'?issue:issue.text;
        const severity=typeof issue==='object'&&issue.severity?issue.severity:'medium';
        const sevColor=severity==='high'?colors.red:severity==='medium'?colors.yellow:colors.green;
        
        const lines=wrapText(text,contentWidth-18,10);
        const boxH=Math.max(lines.length*5+8,14);
        roundedRect(margin,y,contentWidth,boxH,2,colors.lightGray);
        
        // Severity dot - aligned with first line of text
        pdf.setFillColor(...sevColor);
        pdf.circle(margin+6,y+7,2,'F');
        
        pdf.setFont('helvetica','normal');
        pdf.setFontSize(10);
        pdf.setTextColor(...colors.black);
        let ty=y+6.5;
        lines.forEach(line=>{
          pdf.text(line,margin+14,ty);
          ty+=5;
        });
        y+=boxH+3;
      });
    }
    
    // === NEXT MOVES ===
    if(report.nextMoves&&report.nextMoves.length){
      checkPage(20);
      y+=6;
      pdf.setFontSize(9);
      pdf.setFont('helvetica','bold');
      pdf.setTextColor(...colors.gray);
      pdf.text('â†’  NEXT MOVES',margin,y+3);
      y+=10;
      
      // Group by owner
      const movesByOwner={};
      report.nextMoves.forEach(move=>{
        let owner,action;
        if(typeof move==='string'){
          const match=move.match(/^([^:â€”]+)[:\â€”]\s*(.+)$/);
          if(match){owner=match[1].trim();action=match[2].trim();}
          else{owner='Team';action=move;}
        }else{
          owner=move.owner||'Team';
          action=move.action||'';
        }
        if(!movesByOwner[owner])movesByOwner[owner]=[];
        movesByOwner[owner].push(action);
      });
      
      Object.entries(movesByOwner).forEach(([owner,actions])=>{
        checkPage(15);
        const initials=owner.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
        
        // Avatar circle
        pdf.setFillColor(...colors.accent);
        pdf.circle(margin+5,y+3,4,'F');
        pdf.setFont('helvetica','bold');
        pdf.setFontSize(7);
        pdf.setTextColor(255,255,255);
        pdf.text(initials,margin+5,y+4.2,{align:'center'});
        
        // Name
        pdf.setFont('helvetica','bold');
        pdf.setFontSize(11);
        pdf.setTextColor(...colors.black);
        pdf.text(owner,margin+12,y+4.5);
        
        if(actions.length>1){
          pdf.setFont('helvetica','normal');
          pdf.setTextColor(...colors.gray);
          pdf.setFontSize(9);
          const nameWidth=pdf.getTextWidth(owner);
          pdf.text(actions.length+' actions',margin+14+nameWidth,y+4.5);
        }
        y+=12;
        
        actions.forEach(action=>{
          checkPage(12);
          const lines=wrapText(action,contentWidth-28,10);
          const boxH=Math.max(lines.length*5+8,12);
          roundedRect(margin+12,y,contentWidth-12,boxH,2,colors.lightGray);
          
          pdf.setFont('helvetica','normal');
          pdf.setFontSize(10);
          pdf.setTextColor(...colors.black);
          let ty=y+6;
          lines.forEach(line=>{
            pdf.text(line,margin+16,ty);
            ty+=5;
          });
          y+=boxH+3;
        });
        y+=5;
      });
    }
    
    // === LOOKAHEAD ===
    if(report.lookahead&&report.lookahead.length){
      checkPage(35);
      y+=6;
      pdf.setFontSize(9);
      pdf.setFont('helvetica','bold');
      pdf.setTextColor(...colors.gray);
      pdf.text('ðŸ“…  LOOKAHEAD',margin,y+3);
      y+=12;
      
      const itemWidth=contentWidth/report.lookahead.length;
      const lineY=y+3;
      
      // Timeline line
      pdf.setDrawColor(200,200,200);
      pdf.setLineWidth(0.5);
      pdf.line(margin+10,lineY,pageWidth-margin-10,lineY);
      
      report.lookahead.forEach((item,i)=>{
        let date,event;
        if(typeof item==='string'){
          const match=item.match(/^([^:]+):\s*(.+)$/);
          if(match){date=match[1].trim();event=match[2].trim();}
          else{date='';event=item;}
        }else{
          date=item.date||'';
          event=item.event||'';
        }
        
        const cx=margin+itemWidth*i+itemWidth/2;
        
        // Dot
        if(i===0)pdf.setFillColor(...colors.accent);
        else pdf.setFillColor(180,180,180);
        pdf.circle(cx,lineY,3,'F');
        
        // Date
        pdf.setFont('helvetica','bold');
        pdf.setFontSize(9);
        pdf.setTextColor(...colors.black);
        pdf.text(date,cx,lineY+9,{align:'center'});
        
        // Event (wrapped)
        pdf.setFont('helvetica','normal');
        pdf.setFontSize(8);
        pdf.setTextColor(...colors.gray);
        const eventLines=wrapText(event,itemWidth-6,8);
        let ey=lineY+14;
        eventLines.slice(0,3).forEach(line=>{
          pdf.text(line,cx,ey,{align:'center'});
          ey+=4;
        });
      });
      y+=40;
    }
    
    // === MISSING INFO ===
    if(report.missingInfo&&report.missingInfo.length){
      checkPage(20);
      y+=6;
      pdf.setFontSize(9);
      pdf.setFont('helvetica','bold');
      pdf.setTextColor(...colors.gray);
      pdf.text('â“  MISSING INFO',margin,y+3);
      y+=10;
      
      report.missingInfo.forEach(item=>{
        checkPage(14);
        const lines=wrapText(item,contentWidth-16,10);
        const boxH=Math.max(lines.length*5+8,12);
        roundedRect(margin,y,contentWidth,boxH,2,colors.lightGray);
        
        // Yellow left border
        pdf.setFillColor(...colors.yellow);
        pdf.rect(margin,y+2,2,boxH-4,'F');
        
        pdf.setFont('helvetica','normal');
        pdf.setFontSize(10);
        pdf.setTextColor(...colors.black);
        let ty=y+6.5;
        lines.forEach(line=>{
          pdf.text(line,margin+8,ty);
          ty+=5;
        });
        y+=boxH+3;
      });
    }
    
    // === FOOTER ===
    checkPage(15);
    y+=10;
    pdf.setDrawColor(200,200,200);
    pdf.setLineWidth(0.3);
    pdf.line(margin,y,pageWidth-margin,y);
    y+=8;
    pdf.setFontSize(9);
    pdf.setFont('helvetica','normal');
    pdf.setTextColor(...colors.gray);
    const genText='Generated '+new Date(report.generatedAt||Date.now()).toLocaleString();
    pdf.text(genText,pageWidth/2,y,{align:'center'});
    pdf.text(genText,pageWidth/2,y,{align:'center'});
    
    pdf.save(filename);
  }catch(e){
    console.error('PDF creation failed:',e);
    alert('Failed to create PDF: '+e.message);
  }
  
  btn.innerHTML=originalText;
  btn.disabled=false;
};

// ============================================================
// PORTFOLIO REPORT EVENT LISTENERS
// ============================================================

$('portfolioReportBtn').onclick = async () => {
  $('portfolioReportModal').classList.add('open');
  $('popoverBackdrop').classList.add('active');
  
  // Check if we have a cached report
  if (cachedPortfolioReport) {
    await displayCachedPortfolioReport();
  } else {
    showPortfolioEmptyState();
  }
};

$('portfolioReportClose').onclick = () => {
  $('portfolioReportModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
};

$('portfolioRefresh').onclick = async () => {
  await generatePortfolioReport();
};

// Close portfolio modal on outside click
document.addEventListener('click', e => {
  const popover = $('portfolioReportModal');
  if (popover.classList.contains('open') && !popover.contains(e.target) && !e.target.closest('#portfolioReportBtn')) {
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});

// Portfolio PDF Export
$('portfolioCreatePDF').onclick = async () => {
  const btn = $('portfolioCreatePDF');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:-2px;animation:spin 1s linear infinite"><path d="M12 2v4m0 12v4m-10-10h4m12 0h4"/></svg>Creating...';
  btn.disabled = true;
  
  try {
    const dateStr = new Date().toISOString().split('T')[0];
    const filename = 'Portfolio-Report-' + dateStr + '.pdf';
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = 210;
    const pageHeight = 297;
    const margin = 15;
    const contentWidth = pageWidth - margin * 2;
    let y = margin;
    
    // Colors
    const colors = {
      black: [26, 26, 26],
      gray: [107, 114, 128],
      lightGray: [245, 245, 245],
      accent: [216, 119, 86],
      green: [34, 197, 94],
      yellow: [245, 158, 11],
      red: [239, 68, 68],
      blue: [37, 99, 235]
    };
    
    // Helper: check page break
    function checkPage(needed) {
      if (y + needed > pageHeight - margin) {
        pdf.addPage();
        y = margin;
        return true;
      }
      return false;
    }
    
    // Helper: draw rounded rect
    function roundedRect(x, ry, w, h, r, fill, stroke) {
      pdf.setFillColor(...fill);
      if (stroke) pdf.setDrawColor(...stroke);
      pdf.roundedRect(x, ry, w, h, r, r, stroke ? 'FD' : 'F');
    }
    
    // Helper: wrap text
    function wrapText(text, maxWidth, fontSize) {
      pdf.setFontSize(fontSize);
      const words = text.split(' ');
      const lines = [];
      let line = '';
      words.forEach(word => {
        const test = line ? line + ' ' + word : word;
        if (pdf.getTextWidth(test) > maxWidth) {
          if (line) lines.push(line);
          line = word;
        } else {
          line = test;
        }
      });
      if (line) lines.push(line);
      return lines;
    }
    
    // Get report data
    const report = cachedPortfolioReport;
    if (!report) {
      alert('No report to export');
      btn.innerHTML = originalText;
      btn.disabled = false;
      return;
    }
    
    const ctx = await buildPortfolioReportContext();
    if (!ctx) {
      alert('No portfolio data available');
      btn.innerHTML = originalText;
      btn.disabled = false;
      return;
    }
    
    const pf = ctx.portfolio;
    
    // === TITLE ===
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(20);
    pdf.setTextColor(...colors.black);
    pdf.text('Master Schedule', margin, y + 7);
    y += 14;
    
    // === STATUS BADGE & DATE ===
    const status = report.status || 'healthy';
    const statusColors = {
      'healthy': { bg: [220, 252, 231], text: [22, 101, 52] },
      'at-risk': { bg: [254, 243, 199], text: [180, 83, 9] },
      'critical': { bg: [254, 226, 226], text: [185, 28, 28] }
    };
    const sc = statusColors[status] || statusColors['healthy'];
    const statusText = status === 'at-risk' ? 'AT RISK' : status.toUpperCase();
    pdf.setFontSize(9);
    const statusWidth = pdf.getTextWidth(statusText) + 8;
    roundedRect(margin, y, statusWidth, 6, 1.5, sc.bg);
    pdf.setTextColor(...sc.text);
    pdf.setFont('helvetica', 'bold');
    pdf.text(statusText, margin + 4, y + 4.3);
    
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...colors.gray);
    pdf.setFontSize(10);
    pdf.text(ctx.meta.today, margin + statusWidth + 6, y + 4.3);
    
    const projectsText = pf.activeProjects + ' active projects';
    pdf.text(projectsText, pageWidth - margin - pdf.getTextWidth(projectsText), y + 4.3);
    y += 12;
    
    // Portfolio stats
    pdf.setFontSize(10);
    pdf.setTextColor(...colors.gray);
    let statsX = margin;
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...colors.black);
    pdf.text(String(pf.onTrack), statsX, y + 3);
    statsX += pdf.getTextWidth(String(pf.onTrack)) + 1;
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...colors.gray);
    pdf.text(' on track', statsX, y + 3);
    statsX += pdf.getTextWidth(' on track') + 8;
    
    if (pf.behind > 0) {
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...colors.black);
      pdf.text(String(pf.behind), statsX, y + 3);
      statsX += pdf.getTextWidth(String(pf.behind)) + 1;
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...colors.gray);
      pdf.text(' behind', statsX, y + 3);
      statsX += pdf.getTextWidth(' behind') + 8;
    }
    
    if (pf.critical > 0) {
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...colors.black);
      pdf.text(String(pf.critical), statsX, y + 3);
      statsX += pdf.getTextWidth(String(pf.critical)) + 1;
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...colors.gray);
      pdf.text(' critical', statsX, y + 3);
      statsX += pdf.getTextWidth(' critical') + 8;
    }
    
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...colors.black);
    pdf.text(String(pf.totalParts), statsX, y + 3);
    statsX += pdf.getTextWidth(String(pf.totalParts)) + 1;
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...colors.gray);
    pdf.text(' total parts', statsX, y + 3);
    y += 10;
    
    // === PROGRESS BAR ===
    const progress = pf.overallProgress || 0;
    const expected = pf.overallExpected || 0;
    const barHeight = 4;
    const barY = y;
    
    roundedRect(margin, barY, contentWidth, barHeight, 2, colors.lightGray);
    
    const fillWidth = Math.min(progress, 100) / 100 * contentWidth;
    const fillColor = status === 'critical' ? colors.red : status === 'at-risk' ? colors.yellow : colors.green;
    if (fillWidth > 0) roundedRect(margin, barY, fillWidth, barHeight, 2, fillColor);
    
    if (expected > 0) {
      const expectedX = margin + (Math.min(expected, 100) / 100 * contentWidth);
      pdf.setDrawColor(...colors.gray);
      pdf.setLineWidth(0.5);
      pdf.line(expectedX, barY - 2, expectedX, barY + barHeight + 2);
      pdf.setFontSize(7);
      pdf.setTextColor(...colors.gray);
      pdf.text('Expected', expectedX, barY - 3, { align: 'center' });
    }
    
    y += barHeight + 4;
    pdf.setFontSize(10);
    pdf.setTextColor(...colors.black);
    pdf.setFont('helvetica', 'bold');
    pdf.text(progress + '% complete', margin, y + 3);
    if (expected > 0) {
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...colors.gray);
      const expText = expected + '% expected';
      pdf.text(expText, pageWidth - margin - pdf.getTextWidth(expText), y + 3);
    }
    y += 10;
    
    // === AGGREGATE PIPELINE ===
    checkPage(55);
    const c = ctx.aggregatePipeline;
    roundedRect(margin, y, contentWidth, 52, 3, colors.lightGray);
    y += 4;
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...colors.gray);
    pdf.text('AGGREGATE PIPELINE', margin + 6, y + 4);
    y += 8;
    
    const stages = [
      { label: 'Waiting', count: c.waiting || 0 },
      { label: 'To Order', count: c.toOrder || 0 },
      { label: 'Ordered', count: c.ordered || 0 },
      { label: 'Arrived', count: c.arrived || 0 },
      { label: 'Tested', count: c.tested || 0 },
      { label: 'Configured', count: c.configured || 0 },
      { label: 'Installed', count: c.installed || 0 }
    ];
    const maxCount = Math.max(...stages.map(s => s.count), 1);
    const barStartX = margin + 28;
    const barW = contentWidth - 65;
    
    stages.forEach(s => {
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...colors.gray);
      pdf.text(s.label, margin + 6, y + 3);
      
      pdf.setFillColor(230, 230, 230);
      pdf.roundedRect(barStartX, y - 1, barW, 4, 1, 1, 'F');
      
      const fillW = (s.count / maxCount) * barW;
      if (fillW > 0) {
        pdf.setFillColor(...colors.blue);
        pdf.roundedRect(barStartX, y - 1, fillW, 4, 1, 1, 'F');
      }
      
      pdf.setTextColor(...colors.black);
      pdf.setFont('helvetica', 'bold');
      pdf.text(String(s.count), barStartX + barW + 4, y + 3);
      
      y += 5.5;
    });
    y += 8;
    
    // === SUMMARY ===
    if (report.summary) {
      checkPage(40);
      const summaryText = report.summary || '';
      const paragraphs = summaryText.split(/\n\n+/).filter(p => p.trim());
      
      let totalLines = 0;
      const paraData = paragraphs.map(para => {
        const lines = wrapText(para.replace(/\n/g, ' ').trim(), contentWidth - 18, 10);
        totalLines += lines.length;
        return lines;
      });
      const summaryHeight = totalLines * 5 + (paragraphs.length - 1) * 4 + 16;
      
      roundedRect(margin, y, contentWidth, summaryHeight, 3, colors.lightGray);
      pdf.setFillColor(...colors.accent);
      pdf.rect(margin, y + 3, 1.5, summaryHeight - 6, 'F');
      
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(10);
      pdf.setTextColor(...colors.black);
      let sy = y + 9;
      paraData.forEach((lines, pi) => {
        lines.forEach(line => {
          pdf.text(line, margin + 10, sy);
          sy += 5;
        });
        if (pi < paraData.length - 1) sy += 4;
      });
      y += summaryHeight + 6;
    }
    
    // === PROJECTS ===
    if (report.projectHighlights && report.projectHighlights.length) {
      checkPage(20);
      y += 6;
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...colors.gray);
      pdf.text('ðŸ“Š  PROJECTS', margin, y + 3);
      y += 10;
      
      report.projectHighlights.forEach(ph => {
        checkPage(18);
        const proj = ctx.projects.find(p => p.code === ph.code) || {};
        const pStatus = ph.status || proj.status || 'on-track';
        const pProgress = proj.progress || 0;
        const pDays = proj.daysLeft;
        const highlight = ph.highlight || proj.topBlocker || '';
        
        const highlightLines = wrapText(highlight, contentWidth - 80, 9);
        const boxH = Math.max(highlightLines.length * 4 + 14, 18);
        
        roundedRect(margin, y, contentWidth, boxH, 3, colors.lightGray);
        
        // Status stripe
        const stripeColor = pStatus === 'critical' ? colors.red : pStatus === 'behind' ? colors.yellow : colors.green;
        pdf.setFillColor(...stripeColor);
        pdf.rect(margin, y + 2, 2, boxH - 4, 'F');
        
        // Project name
        pdf.setFont('helvetica', 'bold');
        pdf.setFontSize(11);
        pdf.setTextColor(...colors.black);
        const projName = (proj.name || ph.code).substring(0, 30);
        pdf.text(projName, margin + 8, y + 7);
        
        // Progress bar
        const pbX = margin + 90;
        const pbW = 40;
        pdf.setFillColor(230, 230, 230);
        pdf.roundedRect(pbX, y + 4, pbW, 3, 1, 1, 'F');
        if (pProgress > 0) {
          pdf.setFillColor(...stripeColor);
          pdf.roundedRect(pbX, y + 4, (pProgress / 100) * pbW, 3, 1, 1, 'F');
        }
        
        // Progress %
        pdf.setFont('helvetica', 'bold');
        pdf.setFontSize(10);
        pdf.setTextColor(...colors.black);
        pdf.text(pProgress + '%', pbX + pbW + 4, y + 7);
        
        // Days left
        if (pDays !== null && pDays > 0) {
          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(9);
          pdf.setTextColor(...colors.gray);
          pdf.text(pDays + 'd', pbX + pbW + 20, y + 7);
        }
        
        // Highlight text
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(9);
        pdf.setTextColor(...colors.gray);
        let hy = y + 13;
        highlightLines.slice(0, 2).forEach(line => {
          pdf.text(line, margin + 8, hy);
          hy += 4;
        });
        
        y += boxH + 3;
      });
    }
    
    // === TOP ISSUES ===
    if (report.topIssues && report.topIssues.length) {
      checkPage(20);
      y += 6;
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...colors.gray);
      pdf.text('âš   TOP ISSUES', margin, y + 3);
      y += 10;
      
      report.topIssues.forEach(issue => {
        checkPage(14);
        const text = typeof issue === 'string' ? issue : issue.text;
        const severity = typeof issue === 'object' && issue.severity ? issue.severity : 'medium';
        const sevColor = severity === 'high' ? colors.red : severity === 'medium' ? colors.yellow : colors.green;
        
        const lines = wrapText(text, contentWidth - 18, 10);
        const boxH = Math.max(lines.length * 5 + 8, 14);
        roundedRect(margin, y, contentWidth, boxH, 2, colors.lightGray);
        
        pdf.setFillColor(...sevColor);
        pdf.circle(margin + 6, y + 7, 2, 'F');
        
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(10);
        pdf.setTextColor(...colors.black);
        let ty = y + 6.5;
        lines.forEach(line => {
          pdf.text(line, margin + 14, ty);
          ty += 5;
        });
        y += boxH + 3;
      });
    }
    
    // === UPCOMING DEADLINES ===
    if (report.upcomingDeadlines && report.upcomingDeadlines.length) {
      checkPage(40);
      y += 6;
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...colors.gray);
      pdf.text('ðŸ“…  UPCOMING DEADLINES (60 days)', margin, y + 3);
      y += 12;
      
      const itemWidth = contentWidth / report.upcomingDeadlines.length;
      const lineY = y + 3;
      
      pdf.setDrawColor(200, 200, 200);
      pdf.setLineWidth(0.5);
      pdf.line(margin + 10, lineY, pageWidth - margin - 10, lineY);
      
      report.upcomingDeadlines.forEach((dl, i) => {
        const risk = dl.risk || 'low';
        const dateStr = dl.date || '';
        
        // Handle both "Mar 15" and "2026-03-15" formats
        let dateFormatted = dateStr;
        if (dateStr && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
          const d = new Date(dateStr + 'T00:00:00');
          if (!isNaN(d.getTime())) {
            dateFormatted = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }
        }
        
        const cx = margin + itemWidth * i + itemWidth / 2;
        
        if (i === 0) pdf.setFillColor(...colors.accent);
        else pdf.setFillColor(180, 180, 180);
        pdf.circle(cx, lineY, 3, 'F');
        
        pdf.setFont('helvetica', 'bold');
        pdf.setFontSize(9);
        pdf.setTextColor(...colors.black);
        pdf.text(dateFormatted, cx, lineY + 9, { align: 'center' });
        
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(8);
        pdf.setTextColor(...colors.gray);
        const projLines = wrapText(dl.project || '', itemWidth - 6, 8);
        let py = lineY + 14;
        projLines.slice(0, 2).forEach(line => {
          pdf.text(line, cx, py, { align: 'center' });
          py += 4;
        });
        
        // Risk badge
        const riskColor = risk === 'high' ? colors.red : risk === 'medium' ? colors.yellow : colors.green;
        pdf.setFontSize(7);
        const riskText = risk.toUpperCase() + ' RISK';
        const riskWidth = pdf.getTextWidth(riskText) + 4;
        pdf.setFillColor(...riskColor);
        pdf.roundedRect(cx - riskWidth / 2, py, riskWidth, 4, 1, 1, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFont('helvetica', 'bold');
        pdf.text(riskText, cx, py + 3, { align: 'center' });
      });
      y += 45;
    }
    
    // === MISSING INFO ===
    if (report.missingInfo && report.missingInfo.length) {
      checkPage(20);
      y += 6;
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...colors.gray);
      pdf.text('â“  MISSING INFO', margin, y + 3);
      y += 10;
      
      report.missingInfo.forEach(item => {
        checkPage(14);
        const lines = wrapText(item, contentWidth - 16, 10);
        const boxH = Math.max(lines.length * 5 + 8, 12);
        roundedRect(margin, y, contentWidth, boxH, 2, colors.lightGray);
        
        pdf.setFillColor(...colors.yellow);
        pdf.rect(margin, y + 2, 2, boxH - 4, 'F');
        
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(10);
        pdf.setTextColor(...colors.black);
        let ty = y + 6.5;
        lines.forEach(line => {
          pdf.text(line, margin + 8, ty);
          ty += 5;
        });
        y += boxH + 3;
      });
    }
    
    // === FOOTER ===
    checkPage(15);
    y += 10;
    pdf.setDrawColor(200, 200, 200);
    pdf.setLineWidth(0.3);
    pdf.line(margin, y, pageWidth - margin, y);
    y += 8;
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...colors.gray);
    const genText = 'Generated ' + new Date(report.generatedAt || Date.now()).toLocaleString();
    pdf.text(genText, pageWidth / 2, y, { align: 'center' });
    
    pdf.save(filename);
  } catch (e) {
    console.error('Portfolio PDF creation failed:', e);
    alert('Failed to create PDF: ' + e.message);
  }
  
  btn.innerHTML = originalText;
  btn.disabled = false;
};

$('etaSave').onclick=()=>{if(!editEtaPartId)return;const part=data.find(d=>String(d.id)===String(editEtaPartId));if(!part)return;const oldEta=part.expectedArrival;const val=$('etaDateInput').value;part.expectedArrival=val||undefined;part.manualEta=undefined;updateFieldTimestamp(part,'expectedArrival');markPartChanged(editEtaPartId,['expectedArrival']);if(oldEta!==part.expectedArrival)logActivity('eta','ETA updated for "'+part.name+'"',{partId:part.id,partName:part.name,oldValue:oldEta||'none',newValue:val||'none'});save();render();$('etaPopover').classList.remove('open');editEtaPartId=null;};
$('etaClear').onclick=()=>{if(!editEtaPartId)return;const part=data.find(d=>String(d.id)===String(editEtaPartId));if(!part)return;const oldEta=part.expectedArrival;part.expectedArrival=undefined;part.manualEta=undefined;updateFieldTimestamp(part,'expectedArrival');markPartChanged(editEtaPartId,['expectedArrival']);if(oldEta)logActivity('eta','ETA cleared for "'+part.name+'"',{partId:part.id,partName:part.name,oldValue:oldEta,newValue:'none'});save();render();$('etaPopover').classList.remove('open');editEtaPartId=null;};

$('bomClose').onclick=$('bomCancel').onclick=()=>closeModal('bomModal');
$('bomModal').onclick=e=>{if(e.target.id==='bomModal')closeModal('bomModal')};
$('bomSave').onclick=window.saveBom;

$('leadtimeBtn').onclick=()=>{renderLeadTimeModal();$('leadtimeModal').classList.add('open')};
$('ltClose').onclick=$('ltDone').onclick=()=>closeModal('leadtimeModal');
$('leadtimeModal').onclick=e=>{if(e.target.id==='leadtimeModal')closeModal('leadtimeModal')};
$('ltClear').onclick=()=>{if(confirm('Clear all?')){leadTimeDb={};saveLeadTime();renderLeadTimeModal();}};

// Item Code Configuration Modal
function renderItemConfigModal(){
  const codes=Object.keys(itemCodeConfig).sort();
  if(!codes.length){
    $('icList').innerHTML='<div class="itemconfig-empty">No item codes configured yet.<br>Add a code above to customize testing & configuration requirements.</div>';
    return;
  }
  let html='';
  codes.forEach(code=>{
    const cfg=itemCodeConfig[code];
    html+='<div class="itemconfig-item" data-code="'+esc(code)+'">';
    html+='<div class="itemconfig-item-header"><span class="itemconfig-code">'+esc(code)+'</span><button class="itemconfig-del" onclick="window.deleteItemConfig(\''+esc(code)+'\')">Ã—</button></div>';
    html+='<div class="itemconfig-options">';
    html+='<div class="itemconfig-opt"><label>Testing Required</label><input type="checkbox" '+(cfg.requiresTesting?'checked':'')+' onchange="window.updateItemConfig(\''+esc(code)+'\',\'requiresTesting\',this.checked)"></div>';
    html+='<div class="itemconfig-opt"><label>Tester</label><select onchange="window.updateItemConfig(\''+esc(code)+'\',\'tester\',this.value)"><option value="">â€” Any â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(cfg.tester===t.name?' selected':'')+'>'+esc(t.name)+'</option>').join('')+'</select></div>';
    html+='<div class="itemconfig-opt"><label>Config Required</label><input type="checkbox" '+(cfg.requiresConfig?'checked':'')+' onchange="window.updateItemConfig(\''+esc(code)+'\',\'requiresConfig\',this.checked)"></div>';
    html+='<div class="itemconfig-opt"><label>Configured By</label><select onchange="window.updateItemConfig(\''+esc(code)+'\',\'configuredBy\',this.value)"><option value="">â€” Any â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(cfg.configuredBy===t.name?' selected':'')+'>'+esc(t.name)+'</option>').join('')+'</select></div>';
    html+='</div></div>';
  });
  $('icList').innerHTML=html;
}

window.updateItemConfig=function(code,field,value){
  if(!itemCodeConfig[code])itemCodeConfig[code]={requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  itemCodeConfig[code][field]=value;
  saveItemCodeConfig();
  render(); // Re-render to update stage dots
};

window.deleteItemConfig=function(code){
  delete itemCodeConfig[code];
  saveItemCodeConfig();
  renderItemConfigModal();
  render();
  
};

window.addItemConfig=function(){
  const input=$('icNewCode');
  const code=input.value.trim().toUpperCase();
  if(!code){return}
  if(itemCodeConfig[code]){return}
  itemCodeConfig[code]={requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  saveItemCodeConfig();
  input.value='';
  renderItemConfigModal();
  
};

$('itemConfigBtn').onclick=()=>{renderItemConfigModal();$('itemConfigModal').classList.add('open')};
$('icClose').onclick=$('icDone').onclick=()=>closeModal('itemConfigModal');
$('itemConfigModal').onclick=e=>{if(e.target.id==='itemConfigModal')closeModal('itemConfigModal')};
$('icAddBtn').onclick=window.addItemConfig;
$('icNewCode').onkeydown=e=>{if(e.key==='Enter')window.addItemConfig()};

// OTD Modal
window.showOTDModal=function(){
  const mfrData=calcOTDByMfr();
  const overallOTD=calcSupplierOTD();
  const avgLead=calcAvgLeadTime();
  
  let html='';
  if(!mfrData.length){
    html='<div class="otd-empty">No delivery data yet.<br><span style="font-size:11px">Data is collected when parts move from Ordered â†’ Arrived</span></div>';
  }else{
    // Overall summary
    html+='<div class="otd-item" style="background:var(--bg3);margin-bottom:16px"><div class="otd-mfr">Overall</div><div class="otd-stats"><div class="otd-stat"><span class="otd-stat-val" style="color:'+(overallOTD>=90?'var(--green)':overallOTD>=70?'var(--yellow)':'var(--red)')+'">'+(overallOTD||0)+'%</span><span class="otd-stat-label">OTD</span></div><div class="otd-stat"><span class="otd-stat-val">'+(avgLead||0)+'d</span><span class="otd-stat-label">Avg Lead</span></div></div></div>';
    // Per manufacturer
    mfrData.forEach(m=>{
      const color=m.otd>=90?'var(--green)':m.otd>=70?'var(--yellow)':'var(--red)';
      html+='<div class="otd-item"><div class="otd-mfr">'+esc(m.mfr)+'</div><div class="otd-stats"><div class="otd-stat"><span class="otd-stat-val" style="color:'+color+'">'+m.otd+'%</span><span class="otd-stat-label">OTD</span></div><div class="otd-stat"><span class="otd-stat-val">'+m.avgLead+'d</span><span class="otd-stat-label">Lead</span></div><div class="otd-stat"><span class="otd-stat-val" style="font-size:13px">'+m.total+'</span><span class="otd-stat-label">Parts</span></div><div class="otd-bar"><div class="otd-bar-fill" style="width:'+m.otd+'%;background:'+color+'"></div></div></div></div>';
    });
  }
  $('otdBody').innerHTML=html;
  $('otdModal').classList.add('open');
};

// OTD inline functions removed - suppliers section removed

$('otdClose').onclick=$('otdDone').onclick=()=>closeModal('otdModal');
$('otdModal').onclick=e=>{if(e.target.id==='otdModal')closeModal('otdModal')};

$('pmClose').onclick=$('pmCancel').onclick=()=>{hidePopoverModal($('partModal'));editId=null};
$('pmSave').onclick=()=>{
  const name=$('pmName').value.trim();if(!name){return}
  const now=Date.now();
  if(editId){
    const p=data.find(d=>String(d.id)===String(editId));
    if(p){
      const changedFields=[];
      const oldStatus=p.status;
      const oldName=p.name;
      const oldQty=p.qty;
      const oldNotes=p.notes||'';
      const newName=$('pmName').value.trim();
      const newCode=$('pmCode').value.trim();
      const newMfr=$('pmMfr').value.trim();
      const newQty=parseInt($('pmQty').value)||1;
      const newAssignee=$('pmAssignee').value;
      const newParentId=$('pmParent').value||null;  // Keep as string
      const newNotes=$('pmNotes').value.trim();
      const newStatus=$('pmStatus').value;

      if(p.name!==newName){p.name=newName;changedFields.push('name');logActivity('part_edit','Renamed "'+oldName+'" â†’ "'+newName+'"',{partId:p.id,partName:newName,oldValue:oldName,newValue:newName});}
      if(p.code!==newCode){p.code=newCode;changedFields.push('code');}
      if(p.mfr!==newMfr){p.mfr=newMfr;changedFields.push('mfr');}
      if(p.qty!==newQty){p.qty=newQty;changedFields.push('qty');logActivity('part_edit','Qty changed for "'+p.name+'": '+oldQty+' â†’ '+newQty,{partId:p.id,partName:p.name,oldValue:String(oldQty),newValue:String(newQty)});}
      if(p.assignee!==newAssignee){p.assignee=newAssignee;changedFields.push('assignee');}
      if(String(p.parentId)!==String(newParentId)){p.parentId=newParentId;changedFields.push('parentId');}
      if(p.notes!==newNotes){p.notes=newNotes;changedFields.push('notes');if(newNotes&&!oldNotes)logActivity('part_edit','Note added to "'+p.name+'"',{partId:p.id,partName:p.name});else if(newNotes!==oldNotes)logActivity('part_edit','Note updated for "'+p.name+'"',{partId:p.id,partName:p.name});}
      
      if(oldStatus!==newStatus){
        if(oldStatus==='ordered'&&newStatus==='arrived'&&p.orderedAt&&p.code){
          const days=Math.round((now-p.orderedAt)/86400000);
          if(days>0)recordLeadTime(p.code,days);
        }
        if(newStatus==='ordered')p.orderedAt=now;
        p.status=newStatus;
        p.changedAt=now;
        changedFields.push('status');
        // Log activity
        history.push({ts:now,action:'Status â†’ '+SLABELS[newStatus],item:p.name,partId:p.id});
      }
      
      changedFields.forEach(f=>updateFieldTimestamp(p,f));
      if(changedFields.length)markPartChanged(editId,changedFields);
    }
    
  }else{
    const id=generateId();
    const parentId=$('pmParent').value||null;  // Keep as string
    const part={id,name,code:$('pmCode').value.trim(),mfr:$('pmMfr').value.trim(),qty:parseInt($('pmQty').value)||1,assignee:$('pmAssignee').value,status:$('pmStatus').value,parentId,notes:$('pmNotes').value.trim(),changedAt:now,_fieldTs:{}};
    const serverTime=getServerAlignedTime();
    ['name','code','mfr','qty','assignee','status','parentId','notes'].forEach(f=>{if(part[f])part._fieldTs[f]=serverTime;});
    if(part.status==='ordered')part.orderedAt=now;
    data.push(part);
    dirtyParts.add(id);
    // Log activity
    history.push({ts:now,action:'Part added',item:name,partId:id});
    logActivity('part_add', 'Added part "' + name + '"', { partId: id, partName: name });

  }
  save();render();hidePopoverModal($('partModal'));editId=null;
};


$('amClose').onclick=$('amCancel').onclick=()=>{hidePopoverModal($('asmModal'));editAsmId=null};
$('amSave').onclick=()=>{
  const name=$('amName').value.trim();if(!name){return}
  const now=Date.now();
  if(editAsmId){
    const a=data.find(d=>String(d.id)===String(editAsmId));
    if(a){
      const oldName=a.name;
      const oldNotes=a.notes||'';
      const newNotes=$('amNotes').value.trim();
      if(a.name!==name)logActivity('assembly','Renamed assembly "'+oldName+'" â†’ "'+name+'"',{partId:a.id,partName:name,oldValue:oldName,newValue:name});
      if(oldNotes!==newNotes){if(newNotes&&!oldNotes)logActivity('assembly','Note added to assembly "'+name+'"',{partId:a.id,partName:name});else if(newNotes!==oldNotes)logActivity('assembly','Note updated for assembly "'+name+'"',{partId:a.id,partName:name});}
      a.name=name;a.assignee=$('amAssignee').value;a.notes=newNotes;
      markAsmChanged(editAsmId,['name','assignee','notes']);
    }
    
  }else{
    const asms=getAsms(),maxP=asms.length?Math.max(...asms.map(a=>a.priority||0)):0;
    const id=generateId();
    data.push({id,name,isAsm:true,assignee:$('amAssignee').value,notes:$('amNotes').value.trim(),priority:maxP+1});
    expanded[String(id)]=true;
    dirtyAsms.add(id);
    // Log activity
    history.push({ts:now,action:'Assembly added',item:name});
    logActivity('assembly', 'Added assembly "' + name + '"', { partId: id, partName: name });

  }
  save();render();hidePopoverModal($('asmModal'));editAsmId=null;
};


$('amNotify').onclick=()=>{if(editAsmId){const a=data.find(d=>String(d.id)===String(editAsmId));if(a)sendNotify(a,true)}};
$('amAssignee').onchange=()=>{$('amNotify').disabled=!getTeamEmail($('amAssignee').value)};
$('pmAssignee').onchange=()=>{$('pmNotify').disabled=!getTeamEmail($('pmAssignee').value)};
$('pmNotify').onclick=()=>{if(editId){const p=data.find(d=>String(d.id)===String(editId));if(p)sendNotify(p,false)}};

$('teamBtn').onclick=()=>{renderTeamList();$('teamModal').classList.add('open')};
$('teamClose').onclick=$('teamDone').onclick=()=>closeModal('teamModal');
$('teamModal').onclick=e=>{if(e.target.id==='teamModal')closeModal('teamModal')};
$('teamAdd').onclick=()=>{const name=$('teamName').value.trim(),email=$('teamEmail').value.trim();if(!name||!email.includes('@')){return}if(team.find(t=>t.name===name)){return}team.push({name,email});saveTeam();$('teamName').value='';$('teamEmail').value='';renderTeamList();updateSelects();};

// Milestones modal handlers
function renderMilestoneList(){
  $('milestoneList').innerHTML=!milestones.length?'<p style="color:var(--text3);text-align:center;padding:12px;font-size:10px">No milestones</p>':milestones.map((m,i)=>{
    const typeColors={deadline:'#e53935',delivery:'#4caf50',review:'#ff9800',custom:'#9c27b0'};
    const typeIcons={deadline:'ðŸ”´',delivery:'ðŸŸ¢',review:'ðŸŸ ',custom:'ðŸŸ£'};
    return '<div class="team-item"><div style="width:8px;height:8px;border-radius:2px;background:'+typeColors[m.type]+';margin-right:8px"></div><div class="team-item-info"><div style="font-weight:600">'+esc(m.name)+'</div><div style="font-size:10px;color:var(--text3)">'+formatDateShort(new Date(m.date))+' Â· '+typeIcons[m.type]+' '+m.type+'</div></div><button class="team-item-del" onclick="window.delMilestone('+i+',event)">Ã—</button></div>';
  }).join('');
}
$('milestonesBtn').onclick=()=>{renderMilestoneList();$('milestonesModal').classList.add('open')};
$('milestonesClose').onclick=$('milestonesDone').onclick=()=>closeModal('milestonesModal');
$('milestonesModal').onclick=e=>{if(e.target.id==='milestonesModal')closeModal('milestonesModal')};
$('milestoneAdd').onclick=()=>{
  const name=$('milestoneName').value.trim();
  const date=$('milestoneDate').value;
  const type=$('milestoneType').value;
  if(!name||!date){return}
  milestones.push({id:Date.now(),name,date,type});
  dirtyMeta=true;
  save();
  $('milestoneName').value='';
  $('milestoneDate').value='';
  renderMilestoneList();
  renderGantt();
  
};
window.delMilestone=(idx,e)=>{
  e&&e.stopPropagation();
  milestones.splice(idx,1);
  dirtyMeta=true;
  save();
  renderMilestoneList();
  renderGantt();
  
};

$('datesBtn').onclick=$('burndownEdit').onclick=window.openDates;
$('datesClose').onclick=$('datesCancel').onclick=()=>closeModal('datesModal');
$('datesSave').onclick=()=>{
  const oldStart=projectDates.start,oldEnd=projectDates.end;
  const newStart=$('startDate').value,newEnd=$('endDate').value;
  projectDates.start=newStart;projectDates.end=newEnd;dirtyMeta=true;
  if(oldStart!==newStart)logActivity('date','Project start date changed',{oldValue:oldStart||'none',newValue:newStart||'none'});
  if(oldEnd!==newEnd)logActivity('date','Project end date changed',{oldValue:oldEnd||'none',newValue:newEnd||'none'});
  save();updateProjectIndex();render();renderGantt();closeModal('datesModal');
};
$('datesModal').onclick=e=>{if(e.target.id==='datesModal')closeModal('datesModal')};

// PO Modal handlers
$('poClose').onclick=$('poCancel').onclick=()=>{$('poModal').classList.remove('open');$('popoverBackdrop').classList.remove('active');pendingAdvPartId=null};
$('poSave').onclick=()=>{
  if(pendingAdvPartId){
    const p=data.find(d=>String(d.id)===String(pendingAdvPartId));
    if(p){
      p.poNumber=$('poNumber').value.trim()||null;
      p.expectedArrival=$('poArrivalDate').value||null;
      updateFieldTimestamp(p,'poNumber');
      updateFieldTimestamp(p,'expectedArrival');
      markPartChanged(pendingAdvPartId,['poNumber','expectedArrival']);
      advancePartStatus(pendingAdvPartId);
    }
  }
  $('poModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  pendingAdvPartId=null;
};

// Receive PO Modal handlers
function updatePOSuggestions(){
  const poNumbers=[...new Set(data.filter(d=>d.poNumber&&d.status==='ordered').map(d=>d.poNumber))];
  $('poSuggestions').innerHTML=poNumbers.map(po=>'<option value="'+esc(po)+'">').join('');
}
function updateReceivePOPreview(){
  const po=$('receivePONumber').value.trim();
  if(!po){
    $('receivePOPreview').innerHTML='<div class="receive-po-empty">Enter a PO number to see matching parts</div>';
    $('receivePOConfirm').disabled=true;
    return;
  }
  const matchingParts=data.filter(d=>d.poNumber===po&&d.status==='ordered');
  if(!matchingParts.length){
    $('receivePOPreview').innerHTML='<div class="receive-po-empty">No ordered parts found with PO: '+esc(po)+'</div>';
    $('receivePOConfirm').disabled=true;
    return;
  }
  $('receivePOPreview').innerHTML='<div class="receive-po-count"><span>'+matchingParts.length+'</span> part'+(matchingParts.length!==1?'s':'')+' will be marked as arrived</div><div class="receive-po-list">'+matchingParts.map(p=>'<div class="receive-po-item"><span class="receive-po-item-name">'+esc(p.name)+'</span><span class="receive-po-item-status ordered">Ordered</span></div>').join('')+'</div>';
  $('receivePOConfirm').disabled=false;
}
$('receivePOBtn').onclick=(e)=>{
  updatePOSuggestions();
  $('receivePONumber').value='';
  updateReceivePOPreview();
  const popover=$('receivePOModal');
  $('menuDrop').classList.remove('open');
  popover.style.top='60px';
  popover.style.right='16px';
  popover.style.left='auto';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>$('receivePONumber').focus(),100);
};
$('receivePONumber').oninput=updateReceivePOPreview;
$('receivePOClose').onclick=$('receivePOCancel').onclick=()=>{$('receivePOModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
$('receivePOConfirm').onclick=()=>{
  const po=$('receivePONumber').value.trim();
  if(!po)return;
  const matchingParts=data.filter(d=>d.poNumber===po&&d.status==='ordered');
  if(!matchingParts.length)return;
  const today=new Date().toISOString().split('T')[0];
  matchingParts.forEach(p=>{
    // Record lead time if we have orderedDate
    if(p.orderedDate&&p.code){
      const orderDate=new Date(p.orderedDate);
      const arriveDate=new Date(today);
      const days=Math.round((arriveDate-orderDate)/(86400000));
      if(days>0&&days<365)recordLeadTime(p.code,days);
    }
    p.status='arrived';
    p.arrivedDate=today;
    p.changedAt=Date.now();
    updateFieldTimestamp(p,'status');
    markPartChanged(p.id,['status']);
    logActivity('status',p.name+' â†’ Arrived',{partId:p.id,partName:p.name,oldValue:'ordered',newValue:'arrived'});
  });
  save();
  render();
  $('receivePOModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
};
// Close receive PO popover when clicking outside
document.addEventListener('click',e=>{
  const popover=$('receivePOModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#receivePOBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});

// Delete confirmation popover handlers
function closeDeletePopover(){$('deletePopover').classList.remove('open');$('popoverBackdrop').classList.remove('active');deleteTarget={id:null,type:null}}
$('deleteCancel').onclick=(e)=>{e.stopPropagation();closeDeletePopover()};
$('deleteConfirm').onclick=(e)=>{
  e.stopPropagation();
  e.preventDefault();
  
  // Capture values immediately before any async operations could reset them
  const targetId=deleteTarget.id;
  const targetType=deleteTarget.type;
  
  if(targetId===null||targetId===undefined){
    closeDeletePopover();
    return;
  }
  
  const now=Date.now();
  
  if(targetType==='team'){
    const member=team[targetId];
    if(member)history.push({ts:now,action:'Team member removed',item:member.name});
    team.splice(targetId,1);
    saveTeam();renderTeamList();updateSelects();
  }else if(targetType==='bom'){
    savedBoms=savedBoms.filter(b=>String(b.id)!==String(targetId));
    saveBoms();renderBomList();
  }else{
    const item=data.find(d=>String(d.id)===String(targetId));
    if(item){
      // Log activity
      history.push({ts:now,action:item.isAsm?'Assembly deleted':'Part deleted',item:item.name});
      
      // Mark for deletion (writes tombstone to Firebase)
      if(item.isAsm){
        markDeleted('asm',targetId);
        item._deletedAt = now;
        logActivity('assembly_delete', 'Deleted assembly "' + item.name + '"', { partId: targetId, partName: item.name });
        // Also mark child parts for deletion
        data.filter(d=>String(d.parentId)===String(targetId)).forEach(child=>{
          markDeleted('part',child.id);
          child._deletedAt = now;
        });
        // Clean up any dependencies pointing to this assembly
        data.filter(d=>d.isAsm && !d._deletedAt && String(d.dependency)===String(targetId)).forEach(asm=>{
          asm.dependency = undefined;
          markAsmChanged(asm.id, ['dependency']);
        });
      }else{
        markDeleted('part',targetId);
        item._deletedAt = now;
        logActivity('part_delete', 'Deleted part "' + item.name + '"', { partId: targetId, partName: item.name });
        // Also mark sub-parts for deletion
        data.filter(d=>String(d.parentId)===String(targetId)).forEach(child=>{
          markDeleted('part',child.id);
          child._deletedAt = now;
        });
      }
      delete expanded[String(targetId)];
      save();render();
    }
  }
  
  closeDeletePopover();
};
// Delete close handled by backdrop

$('menuBtn').onclick=e=>{
  e.stopPropagation();
  $('menuDrop').classList.toggle('open');
};
document.addEventListener('click',e=>{
  if($('menuDrop').classList.contains('open')&&!e.target.closest('.dropdown')){
    $('menuDrop').classList.remove('open');
  }
  // Close project dropdown when clicking outside
  if($('projectDropdown').classList.contains('open')&&!e.target.closest('.project-selector')&&!e.target.closest('.project-dropdown')&&!e.target.closest('#masterToolbarTitle')){
    closeProjectDropdown();
  }
});

// Project selector handlers
$('projectSelectorBtn').onclick=e=>{
  e.stopPropagation();
  toggleProjectDropdown();
};

$('projectName').onclick=e=>{
  e.stopPropagation();
  toggleProjectDropdown();
};

$('projectDropdownList').onclick=e=>{
  const item=e.target.closest('.project-dropdown-item');
  if(item){
    const projectId=item.dataset.projectId;
    if(projectId)switchProject(projectId);
  }
};

// Master Schedule item in dropdown
$('projectDropdownMaster').onclick=()=>{
  closeProjectDropdown();
  teamAssignmentsLoaded = false;
  masterScrollPos = 0;
  $('masterScheduleOverlay').classList.add('open');
  renderMasterSchedule();
  // Scroll to today after layout
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      scrollMasterToToday();
    });
  });
};

// Clickable title in Master Schedule view - opens project dropdown
window.openProjectDropdownFromMaster = function(e) {
  e.stopPropagation();
  e.preventDefault();
  const dropdown = $('projectDropdown');
  const titleEl = $('masterToolbarTitle');
  if (dropdown.classList.contains('open')) {
    closeProjectDropdown();
  } else {
    const rect = titleEl.getBoundingClientRect();
    // Move dropdown to body to escape header's stacking context
    document.body.appendChild(dropdown);
    dropdown.style.position = 'fixed';
    dropdown.style.top = (rect.bottom + 8) + 'px';
    dropdown.style.left = rect.left + 'px';
    dropdown.style.zIndex = '10000';
    dropdown.classList.add('open');
    dropdown.dataset.movedToBody = 'true';
    updateProjectDropdown();
    updateMasterScheduleActive();
  }
};

$('newProjectBtn').onclick=()=>{
  closeProjectDropdown();
  openModal('newProjectModal');
};

$('manageProjectsBtn').onclick=()=>{
  closeProjectDropdown();
  openModal('manageProjectsModal');
  renderManageProjectsList();
};

// New Project Modal handlers
$('newProjectModal').onclick=e=>{if(e.target.id==='newProjectModal')closeModal('newProjectModal')};
$('newProjectClose').onclick=()=>closeModal('newProjectModal');
$('newProjectCancel').onclick=()=>closeModal('newProjectModal');
$('newProjectCreate').onclick=async ()=>{
  const name=$('newProjectName').value.trim();
  if(!name){return}
  
  // Generate new project ID
  const projectId=generateProjectId();
  console.log('Creating project:', projectId, name);
  
  // Create project in Firebase
  const newProjectRef=db.ref('projects/'+projectId);
  
  try{
    // Initialize project with minimal data
    console.log('Writing to projects/'+projectId+'/meta...');
    await newProjectRef.child('meta').set({
      name:name,
      projectDates:{start:'',end:''},
      milestones:[],
      schemaVersion:2,
      createdAt:firebase.database.ServerValue.TIMESTAMP,
      updatedAt:firebase.database.ServerValue.TIMESTAMP
    });
    console.log('Meta written successfully');
    
    // Add to project index
    console.log('Writing to global/projectIndex/'+projectId+'...');
    await globalRef.child('projectIndex/'+projectId).set({
      name:name,
      archived:false,
      progress:0,
      createdAt:firebase.database.ServerValue.TIMESTAMP,
      updatedAt:firebase.database.ServerValue.TIMESTAMP
    });
    console.log('Project index written successfully');
    
    closeModal('newProjectModal');
    $('newProjectName').value='';
    
    
    // Switch to new project
    switchProject(projectId);
    
  }catch(e){
    console.error('Failed to create project:',e);
    console.error('Error code:', e.code);
    console.error('Error message:', e.message);
  }
};

// Manage Projects Modal handlers
$('manageProjectsModal').onclick=e=>{if(e.target.id==='manageProjectsModal')closeModal('manageProjectsModal')};
$('manageProjectsClose').onclick=()=>closeModal('manageProjectsModal');
$('manageProjectsDone').onclick=()=>closeModal('manageProjectsModal');
$('showArchivedProjects').onchange=()=>renderManageProjectsList();

let renameProjectId=null;
let deleteProjectId=null;

function renderManageProjectsList(){
  const list=$('manageProjectsList');
  const showArchived=$('showArchivedProjects').checked;
  
  const projects=Object.entries(projectIndex)
    .map(([id,proj])=>({id,...proj}))
    .filter(p=>showArchived||!p.archived)
    .sort((a,b)=>{
      if(a.archived!==b.archived)return a.archived?1:-1;
      return(a.name||'').localeCompare(b.name||'');
    });
  
  if(projects.length===0){
    list.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px">No projects</div>';
    return;
  }
  
  list.innerHTML=projects.map(proj=>{
    const isActive=proj.id===currentProjectCode;
    const archivedBadge=proj.archived?'<span class="manage-project-item-archived">Archived</span>':'';
    const archiveBtn=proj.archived
      ?'<button onclick="window.unarchiveProject(\''+proj.id+'\')" title="Unarchive">ðŸ“¤</button>'
      :'<button onclick="window.archiveProject(\''+proj.id+'\')" title="Archive">ðŸ“¥</button>';
    const dateStr=proj.createdAt?new Date(proj.createdAt).toLocaleDateString():'';
    
    return '<div class="manage-project-item">'+
      '<div style="flex:1">'+
        '<div class="manage-project-item-name">'+esc(proj.name||'Untitled')+archivedBadge+(isActive?' <span style="color:var(--accent);font-size:11px">(current)</span>':'')+'</div>'+
        '<div class="manage-project-item-date">Created: '+dateStr+'</div>'+
      '</div>'+
      '<div class="manage-project-item-actions">'+
        '<button onclick="window.renameProject(\''+proj.id+'\',\''+esc(proj.name||'').replace(/'/g,"\\'")+'\')" title="Rename">âœï¸</button>'+
        archiveBtn+
        (isActive?'':'<button class="danger" onclick="window.confirmDeleteProject(\''+proj.id+'\',\''+esc(proj.name||'').replace(/'/g,"\\'")+'\')" title="Delete">ðŸ—‘ï¸</button>')+
      '</div>'+
    '</div>';
  }).join('');
}

window.renameProject=(id,currentName)=>{
  renameProjectId=id;
  $('renameProjectName').value=currentName;
  openModal('renameProjectModal');
};

window.archiveProject=async(id)=>{
  try{
    await globalRef.child('projectIndex/'+id+'/archived').set(true);
    
    renderManageProjectsList();
    updateProjectDropdown();
  }catch(e){
    
  }
};

window.unarchiveProject=async(id)=>{
  try{
    await globalRef.child('projectIndex/'+id+'/archived').set(false);
    
    renderManageProjectsList();
    updateProjectDropdown();
  }catch(e){
    
  }
};

window.confirmDeleteProject=(id,name)=>{
  deleteProjectId=id;
  $('deleteProjectDisplayName').textContent=name;
  $('deleteProjectConfirmName').value='';
  $('deleteProjectConfirm').disabled=true;
  openModal('deleteProjectModal');
};

// Rename Project Modal handlers
$('renameProjectModal').onclick=e=>{if(e.target.id==='renameProjectModal')closeModal('renameProjectModal')};
$('renameProjectClose').onclick=()=>closeModal('renameProjectModal');
$('renameProjectCancel').onclick=()=>closeModal('renameProjectModal');
$('renameProjectSave').onclick=async()=>{
  const newName=$('renameProjectName').value.trim();
  if(!newName){return}
  
  try{
    await globalRef.child('projectIndex/'+renameProjectId+'/name').set(newName);
    await globalRef.child('projectIndex/'+renameProjectId+'/updatedAt').set(firebase.database.ServerValue.TIMESTAMP);
    
    // If renaming current project, update local state
    if(renameProjectId===currentProjectCode){
      currentProjectName=newName;
      updateProjectName();
    }
    
    closeModal('renameProjectModal');
    
    renderManageProjectsList();
    updateProjectDropdown();
  }catch(e){
    
  }
};

// Delete Project Modal handlers
$('deleteProjectModal').onclick=e=>{if(e.target.id==='deleteProjectModal')closeModal('deleteProjectModal')};
$('deleteProjectClose').onclick=()=>closeModal('deleteProjectModal');
$('deleteProjectCancel').onclick=()=>closeModal('deleteProjectModal');
$('deleteProjectConfirmName').oninput=()=>{
  const expected=$('deleteProjectDisplayName').textContent;
  const entered=$('deleteProjectConfirmName').value;
  $('deleteProjectConfirm').disabled=entered!==expected;
};
$('deleteProjectConfirm').onclick=async()=>{
  if(!deleteProjectId)return;
  
  try{
    // Clean up any dependencies pointing to this project
    for (const [projId, proj] of Object.entries(projectIndex)) {
      if (proj.dependency === deleteProjectId) {
        proj.dependency = undefined;
        await globalRef.child('projectIndex/' + projId + '/dependency').set(null);
      }
    }
    
    // Delete project data
    await db.ref('projects/'+deleteProjectId).set(null);
    
    // Remove from index
    await globalRef.child('projectIndex/'+deleteProjectId).set(null);
    
    closeModal('deleteProjectModal');
    closeModal('manageProjectsModal');
    
    
    // If deleted current project, switch to another
    if(deleteProjectId===currentProjectCode){
      const remaining=Object.keys(projectIndex).filter(id=>id!==deleteProjectId);
      if(remaining.length>0){
        switchProject(remaining[0]);
      }else{
        // No projects left - create a new one
        location.reload();
      }
    }
    
    updateProjectDropdown();
  }catch(e){
    
  }
};

// ============================================
// Template System (Phase 4)
// ============================================

// Generate template ID
function generateTemplateId() {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let id = 't_';
  for (let i = 0; i < 6; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return id;
}

// Save as Template Modal handlers
$('saveTemplateBtn').onclick=()=>{
  $('menuDrop').classList.remove('open');
  
  // Calculate stats
  const asms = data.filter(d => d.isAsm);
  const parts = data.filter(d => !d.isAsm);
  $('saveTemplateStats').textContent = 'Will save ' + asms.length + ' assemblies and ' + parts.length + ' parts';
  $('saveTemplateName').value = currentProjectName + ' Template';
  $('saveTemplateDesc').value = '';
  
  openModal('saveTemplateModal');
};

$('saveTemplateClose').onclick=()=>closeModal('saveTemplateModal');
$('saveTemplateCancel').onclick=()=>closeModal('saveTemplateModal');

$('saveTemplateSave').onclick=async()=>{
  const name = $('saveTemplateName').value.trim();
  if(!name) {  return; }
  
  const desc = $('saveTemplateDesc').value.trim();
  const templateId = generateTemplateId();
  
  // Build template data - assemblies and parts structure only (no status, dates, PO data)
  const asms = data.filter(d => d.isAsm);
  const parts = data.filter(d => !d.isAsm);
  
  const templateAsms = {};
  const templateParts = {};
  
  asms.forEach(asm => {
    templateAsms[asm.id] = {
      id: asm.id,
      name: asm.name,
      isAsm: true,
      priority: asm.priority || 0
    };
  });
  
  parts.forEach(part => {
    templateParts[part.id] = {
      id: part.id,
      name: part.name,
      code: part.code || '',
      mfr: part.mfr || '',
      qty: part.qty || 1,
      parentId: part.parentId || null,
      notes: part.notes || ''
    };
  });
  
  try {
    const templateRef = db.ref('templates/' + templateId);
    
    await templateRef.set({
      meta: {
        name: name,
        description: desc,
        asmCount: asms.length,
        partCount: parts.length,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        createdBy: firebaseUser ? firebaseUser.uid : null,
        sourceProject: currentProjectCode
      },
      assemblies: templateAsms,
      parts: templateParts
    });
    
    closeModal('saveTemplateModal');
    
    
  } catch(e) {
    console.error('Failed to save template:', e);
  }
};

// Manage Templates Modal handlers
$('manageTemplatesBtn').onclick=()=>{
  $('menuDrop').classList.remove('open');
  renderTemplatesList();
  openModal('manageTemplatesModal');
};

$('manageTemplatesClose').onclick=()=>closeModal('manageTemplatesModal');
$('manageTemplatesDone').onclick=()=>closeModal('manageTemplatesModal');

function renderTemplatesList() {
  const list = $('templatesList');
  
  const templates = Object.entries(templatesIndex)
    .map(([id, meta]) => ({ id, ...meta }))
    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  
  if (templates.length === 0) {
    list.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px">No templates yet. Use "Save as Template" from the menu to create one.</div>';
    return;
  }
  
  list.innerHTML = templates.map(tmpl => {
    const dateStr = tmpl.createdAt ? new Date(tmpl.createdAt).toLocaleDateString() : '';
    const stats = (tmpl.asmCount || 0) + ' assemblies, ' + (tmpl.partCount || 0) + ' parts';
    
    return '<div class="template-item">' +
      '<div class="template-item-info">' +
        '<div class="template-item-name">' + esc(tmpl.name || 'Untitled') + '</div>' +
        (tmpl.description ? '<div class="template-item-desc">' + esc(tmpl.description) + '</div>' : '') +
        '<div class="template-item-meta">' + stats + ' â€¢ Created ' + dateStr + '</div>' +
      '</div>' +
      '<div class="template-item-actions">' +
        '<button onclick="window.useTemplate(\'' + tmpl.id + '\')" title="Create project from this template">ðŸ“„</button>' +
        '<button class="danger" onclick="window.deleteTemplate(\'' + tmpl.id + '\',\'' + esc(tmpl.name || '').replace(/'/g, "\\'") + '\')" title="Delete">ðŸ—‘ï¸</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

window.useTemplate = (templateId) => {
  closeModal('manageTemplatesModal');
  $('newProjectTemplate').value = templateId;
  $('newProjectName').value = '';
  openModal('newProjectModal');
};

window.deleteTemplate = async (templateId, templateName) => {
  if (!confirm('Delete template "' + templateName + '"? This cannot be undone.')) return;
  
  try {
    await db.ref('templates/' + templateId).set(null);
    
    renderTemplatesList();
  } catch(e) {
    
  }
};

// ============================================
// Master Schedule (Portfolio View)
// ============================================

$('masterScheduleClose').onclick = () => {
  closeMasterInsightsPanel();
  $('masterScheduleOverlay').classList.remove('open');
};

$('masterShowArchived').onchange = () => {
  renderMasterSchedule();
};

// Master Insights button handlers
$('masterInsightsBtn').onclick = () => {
  openMasterInsightsPanel();
};

$('masterInsightsClose').onclick = () => {
  closeMasterInsightsPanel();
};

// Store master schedule week data for bar dragging
let masterWeeks = [];
let masterCellWidth = 28; // Compact view for portfolio overview
let masterScrollPos = 0;

// Project bar colors - same as Gantt timeline assembly colors
const projectColors = ['#5a8fd8','#6aaa6a','#d87756','#9b6bb5','#c07070','#b8a050','#5ab5b5','#7a8fa0','#aa6a8a','#6a9a5a'];

function getProjectColor(index) {
  return projectColors[index % projectColors.length];
}

function renderMasterSchedule() {
  const showArchived = $('masterShowArchived').checked;
  const sidebar = $('masterSidebar');
  const headerEl = $('masterTimelineHeader');
  const bodyEl = $('masterTimelineBody');
  
  // Get projects
  let projects = Object.entries(projectIndex)
    .map(([id, p]) => ({ id, ...p }))
    .filter(p => showArchived || !p.archived);
  
  // Sort: dependency chains first, independent items at bottom
  function dependencySort(items) {
    const itemMap = new Map(items.map(p => [p.id, p]));
    const dependents = new Map(items.map(p => [p.id, []]));
    
    // Build adjacency list (who depends on whom)
    items.forEach(p => {
      if (p.dependency && itemMap.has(p.dependency)) {
        dependents.get(p.dependency).push(p.id);
      }
    });
    
    // Categorize: chain members vs independent
    const hasFollows = new Set(items.filter(p => p.dependency && itemMap.has(p.dependency)).map(p => p.id));
    const isFollowed = new Set();
    items.forEach(p => {
      if (dependents.get(p.id).length > 0) isFollowed.add(p.id);
    });
    
    // Chain members: either follow something OR are followed by something
    const chainMembers = items.filter(p => hasFollows.has(p.id) || isFollowed.has(p.id));
    // Independent: neither follow nor are followed
    const independent = items.filter(p => !hasFollows.has(p.id) && !isFollowed.has(p.id));
    
    // Topological sort for chain members
    const inDegree = new Map(chainMembers.map(p => [p.id, 0]));
    chainMembers.forEach(p => {
      if (p.dependency && itemMap.has(p.dependency) && inDegree.has(p.dependency)) {
        inDegree.set(p.id, (inDegree.get(p.id) || 0) + 1);
      }
    });
    
    // Start with chain roots (in-degree 0, but part of a chain)
    const queue = chainMembers
      .filter(p => inDegree.get(p.id) === 0)
      .sort((a, b) => {
        if (a.startDate && b.startDate) return a.startDate.localeCompare(b.startDate);
        if (a.startDate) return -1;
        if (b.startDate) return 1;
        return (a.name || '').localeCompare(b.name || '');
      });
    
    const result = [];
    const processed = new Set();
    
    while (queue.length > 0) {
      const current = queue.shift();
      if (processed.has(current.id)) continue;
      
      result.push(current);
      processed.add(current.id);
      
      // Get dependents and sort by start date
      const deps = dependents.get(current.id)
        .map(id => itemMap.get(id))
        .filter(p => p && !processed.has(p.id) && inDegree.has(p.id))
        .sort((a, b) => {
          if (a.startDate && b.startDate) return a.startDate.localeCompare(b.startDate);
          if (a.startDate) return -1;
          if (b.startDate) return 1;
          return 0;
        });
      
      deps.forEach(dep => {
        const newDegree = inDegree.get(dep.id) - 1;
        inDegree.set(dep.id, newDegree);
        if (newDegree === 0) {
          queue.push(dep);
        }
      });
    }
    
    // Add any remaining chain members (cycles)
    chainMembers.forEach(p => {
      if (!processed.has(p.id)) result.push(p);
    });
    
    // Sort independent items by start date and add at bottom
    independent.sort((a, b) => {
      if (a.startDate && b.startDate) return a.startDate.localeCompare(b.startDate);
      if (a.startDate) return -1;
      if (b.startDate) return 1;
      return (a.name || '').localeCompare(b.name || '');
    });
    
    return [...result, ...independent];
  }
  
  projects = dependencySort(projects);
  
  if (!projects.length) {
    sidebar.innerHTML = '<div class="master-schedule-empty">No projects yet</div>';
    headerEl.innerHTML = '';
    bodyEl.innerHTML = '';
    return;
  }
  
  const dayMs = 86400000;
  const today = new Date();
  today.setHours(12, 0, 0, 0); // Use noon to avoid timezone edge cases
  
  const parseLocalDate = (str) => {
    if (!str) return null;
    const parts = str.split('-');
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  };
  
  const formatDateShort = (d) => d.getDate() + '.' + (d.getMonth() + 1) + '.';
  const formatDateISO = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  
  // Find earliest and latest dates from projects
  let rangeStart = new Date(today);
  let rangeEnd = new Date(today);
  
  projects.forEach(p => {
    if (p.startDate) {
      const d = parseLocalDate(p.startDate);
      if (d && d < rangeStart) rangeStart = new Date(d);
    }
    if (p.endDate) {
      const d = parseLocalDate(p.endDate);
      if (d && d > rangeEnd) rangeEnd = new Date(d);
    }
  });
  
  // Add 1 year buffer on both ends
  rangeStart.setDate(rangeStart.getDate() - 365);
  rangeEnd.setDate(rangeEnd.getDate() + 365);
  
  // Get ISO week number (UTC-based to avoid timezone issues)
  function getISOWeek(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7; // Sunday = 7
    d.setUTCDate(d.getUTCDate() + 4 - dayNum); // Set to Thursday
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }
  
  // Get ISO week year (the year the week belongs to, not the calendar year)
  function getISOWeekYear(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    return d.getUTCFullYear();
  }
  
  // Generate weeks array (aligned to Monday)
  const weeks = [];
  let weekStart = new Date(rangeStart);
  const dayOfWeek = weekStart.getDay();
  const daysToMonday = dayOfWeek === 0 ? -6 : (1 - dayOfWeek);
  weekStart.setDate(weekStart.getDate() + daysToMonday);
  weekStart.setHours(0, 0, 0, 0);
  
  while (weekStart <= rangeEnd) {
    const weekEnd = new Date(weekStart.getTime() + 6 * dayMs);
    weekEnd.setHours(23, 59, 59, 999); // End of Sunday, not start
    const containsToday = today >= weekStart && today <= weekEnd;
    const isMonthStart = weekStart.getDate() <= 7;
    weeks.push({
      num: getISOWeek(weekStart),
      year: getISOWeekYear(weekStart), // Use ISO week year, not calendar year
      month: weekStart.getMonth(),
      start: new Date(weekStart),
      end: weekEnd,
      isToday: containsToday,
      isMonthStart: isMonthStart
    });
    weekStart = new Date(weekStart.getTime() + 7 * dayMs);
  }
  
  masterWeeks = weeks;
  const cellWidth = masterCellWidth;
  const totalWidth = weeks.length * cellWidth;

  // Find today's week index robustly
  let todayWeekIdx = -1;
  const nowCheck = new Date();
  nowCheck.setHours(12, 0, 0, 0);
  for (let i = 0; i < weeks.length; i++) {
    if (nowCheck >= weeks[i].start && nowCheck <= weeks[i].end) {
      todayWeekIdx = i;
      break;
    }
  }
  // Fallback: find closest
  if (todayWeekIdx < 0) {
    let minDiff = Infinity;
    for (let i = 0; i < weeks.length; i++) {
      const diff = Math.abs(nowCheck - weeks[i].start);
      if (diff < minDiff) { minDiff = diff; todayWeekIdx = i; }
    }
  }
  
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  
  // Build year row - group weeks by year
  let yearRowHtml = '<div class="master-year-row">';
  let currentYear = null;
  let yearStartIdx = 0;
  weeks.forEach((week, i) => {
    const year = week.year;
    if (year !== currentYear) {
      if (currentYear !== null) {
        const width = (i - yearStartIdx) * cellWidth;
        yearRowHtml += '<div class="master-year-cell" style="width:' + width + 'px">' + currentYear + '</div>';
      }
      currentYear = year;
      yearStartIdx = i;
    }
  });
  // Add last year
  if (currentYear !== null) {
    const width = (weeks.length - yearStartIdx) * cellWidth;
    yearRowHtml += '<div class="master-year-cell" style="width:' + width + 'px">' + currentYear + '</div>';
  }
  yearRowHtml += '</div>';
  
  // Build month row - group weeks by month
  let monthRowHtml = '<div class="master-month-row">';
  let currentMonth = null;
  let currentMonthYear = null;
  let monthStartIdx = 0;
  weeks.forEach((week, i) => {
    const month = week.month;
    const year = week.year;
    if (month !== currentMonth || year !== currentMonthYear) {
      if (currentMonth !== null) {
        const width = (i - monthStartIdx) * cellWidth;
        monthRowHtml += '<div class="master-month-cell" style="width:' + width + 'px">' + monthNames[currentMonth] + '</div>';
      }
      currentMonth = month;
      currentMonthYear = year;
      monthStartIdx = i;
    }
  });
  // Add last month
  if (currentMonth !== null) {
    const width = (weeks.length - monthStartIdx) * cellWidth;
    monthRowHtml += '<div class="master-month-cell" style="width:' + width + 'px">' + monthNames[currentMonth] + '</div>';
  }
  monthRowHtml += '</div>';
  
  // Build week row
  let weekRowHtml = '<div class="master-weeks-row">';
  weeks.forEach((week, i) => {
    const classes = ['master-timeline-week'];
    if (week.isToday) classes.push('today');
    if (week.isMonthStart) classes.push('month-start');
    weekRowHtml += '<div class="' + classes.join(' ') + '" title="W' + week.num + ': ' + week.start.getDate() + '/' + (week.start.getMonth() + 1) + '/' + week.year + '">' + week.num + '</div>';
  });
  weekRowHtml += '</div>';
  
  // Combine header rows
  let headerHtml = yearRowHtml + monthRowHtml + weekRowHtml;
  
  headerEl.innerHTML = headerHtml;
  headerEl.style.width = totalWidth + 'px';
  
  // Render sidebar with Follows column
  let sidebarHtml = '';
  projects.forEach((p, idx) => {
    const startDate = p.startDate ? parseLocalDate(p.startDate) : null;
    const endDate = p.endDate ? parseLocalDate(p.endDate) : null;
    const startStr = startDate ? formatDateShort(startDate) : 'â€”';
    const endStr = endDate ? formatDateShort(endDate) : 'â€”';
    const duration = startDate && endDate ? Math.max(1, Math.ceil((endDate - startDate) / dayMs)) : 'â€”';
    const startISO = startDate ? formatDateISO(startDate) : '';
    const endISO = endDate ? formatDateISO(endDate) : '';
    
    // Build follows select dropdown (other projects only)
    let followsOptions = '<option value="">â€”</option>';
    projects.forEach(other => {
      if (other.id === p.id) return; // Can't follow self
      const selected = other.id === p.dependency ? 'selected' : '';
      const shortName = (other.name || 'Untitled').length > 10 ? (other.name || 'Untitled').substring(0, 10) + 'â€¦' : (other.name || 'Untitled');
      followsOptions += '<option value="' + other.id + '" ' + selected + ' title="' + esc(other.name || 'Untitled') + '">' + esc(shortName) + '</option>';
    });
    const followsSelect = '<select class="master-follows-select" onchange="window.setProjectDependency(\'' + p.id + '\',this.value)" title="' + (p.dependency ? esc(projects.find(pr => pr.id === p.dependency)?.name || '') : 'Select predecessor') + '">' + followsOptions + '</select>';
    
    sidebarHtml += '<div class="master-sidebar-row" data-project-id="' + p.id + '">';
    sidebarHtml += '<div class="master-col-name" onclick="window.openProjectFromMaster(\'' + p.id + '\')" title="' + esc(p.name) + '">' + esc(p.name || 'Untitled') + '</div>';
    sidebarHtml += '<div class="master-col-follows">' + followsSelect + '</div>';
    sidebarHtml += '<div class="master-col-start" data-field="start" data-date="' + startISO + '">' + startStr + '</div>';
    sidebarHtml += '<div class="master-col-end" data-field="end" data-date="' + endISO + '">' + endStr + '</div>';
    sidebarHtml += '<div class="master-col-dur">' + duration + '</div>';
    sidebarHtml += '</div>';
  });
  sidebar.innerHTML = sidebarHtml;
  
  // Render timeline body
  let bodyHtml = '';
  projects.forEach((p, idx) => {
    const startDate = p.startDate ? parseLocalDate(p.startDate) : null;
    const endDate = p.endDate ? parseLocalDate(p.endDate) : null;
    const barColor = getProjectColor(idx);
    
    // Build week cells
    let cellsHtml = '';
    weeks.forEach((week, i) => {
      const classes = ['master-timeline-cell'];
      if (week.isToday) classes.push('today');
      if (week.isMonthStart) classes.push('month-start');
      cellsHtml += '<div class="' + classes.join(' ') + '"></div>';
    });
    
    // Build bar
    let barHtml = '';
    if (startDate && endDate && startDate <= endDate) {
      let startWeekIdx = -1, endWeekIdx = -1;
      for (let i = 0; i < weeks.length; i++) {
        const week = weeks[i];
        if (startWeekIdx < 0 && startDate <= week.end) startWeekIdx = i;
        if (endDate >= week.start) endWeekIdx = i;
      }
      
      if (startWeekIdx >= 0 && endWeekIdx >= 0) {
        const startWeek = weeks[startWeekIdx];
        const endWeek = weeks[endWeekIdx];
        const daysIntoStartWeek = Math.max(0, Math.floor((startDate - startWeek.start) / dayMs));
        const barStart = startWeekIdx * cellWidth + (daysIntoStartWeek / 7) * cellWidth;
        const daysIntoEndWeek = Math.min(7, Math.ceil((endDate - endWeek.start) / dayMs) + 1);
        const barEnd = endWeekIdx * cellWidth + (daysIntoEndWeek / 7) * cellWidth;
        const barWidth = Math.max(cellWidth, barEnd - barStart);
        
        // Get project progress - show incomplete portion darkened
        const progress = p.progress || 0;
        const incomplete = 100 - progress;
        const progressHtml = incomplete > 0 ? '<div class="master-bar-progress" style="width:' + incomplete + '%"></div>' : '';
        const labelText = esc(p.name) + ' Â· ' + progress + '%';
        
        const archivedClass = p.archived ? ' archived' : '';
        const resizeHandles = '<div class="master-bar-resize master-bar-resize-left" data-resize="start"></div><div class="master-bar-resize master-bar-resize-right" data-resize="end"></div>';
        
        barHtml = '<div class="master-bar-container" style="left:' + barStart + 'px;width:' + barWidth + 'px">';
        barHtml += '<div class="master-bar' + archivedClass + '" data-project-id="' + p.id + '" data-name="' + esc(p.name) + '" data-color-idx="' + idx + '" data-progress="' + progress + '" style="width:100%;background:' + barColor + '">' + progressHtml + '<span style="position:relative;z-index:1">' + labelText + '</span>' + resizeHandles + '</div>';
        barHtml += '</div>';
      }
    }
    
    bodyHtml += '<div class="master-timeline-row" data-project-id="' + p.id + '" style="width:' + totalWidth + 'px">' + cellsHtml + barHtml + '</div>';
  });
  
  // Add today line
  if (todayWeekIdx >= 0) {
    // Use day of week: Mon=0, Tue=1, ... Sun=6
    const dow = nowCheck.getDay(); // JS: 0=Sun, 1=Mon...
    const daysIntoWeek = dow === 0 ? 6 : dow - 1;
    const todayPos = todayWeekIdx * cellWidth + ((daysIntoWeek + 0.5) / 7) * cellWidth;
    bodyHtml += '<div class="master-today-line" style="left:' + todayPos + 'px"></div>';
  }
  
  bodyEl.innerHTML = bodyHtml;
  bodyEl.style.width = totalWidth + 'px';
  
  // Render team availability
  renderTeamAvailability(weeks, cellWidth, totalWidth, todayWeekIdx);
  
  // Scroll handled by scrollMasterToToday() after overlay opens
  
  // Store state for dependency arrow rendering
  _masterRenderState = { projects, cellWidth, weeks };
  
  // Render dependency arrows after DOM is ready
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      renderMasterDependencyArrows(projects, cellWidth, weeks);
    });
  });
}

let _masterRenderState = null;

// Scroll Master Schedule to center on today
function scrollMasterToToday() {
  if (!masterWeeks || masterWeeks.length === 0) return;

  const bodyWrap = $('masterBodyWrap');
  const headerWrap = $('masterTimelineHeaderWrap');
  if (!bodyWrap) return;

  // If width not ready, retry
  if (bodyWrap.clientWidth === 0) {
    setTimeout(scrollMasterToToday, 100);
    return;
  }

  // Find today's week by checking date ranges
  const now = new Date();
  now.setHours(12, 0, 0, 0); // Noon to avoid edge cases

  let todayWeekIdx = -1;
  for (let i = 0; i < masterWeeks.length; i++) {
    const w = masterWeeks[i];
    if (now >= w.start && now <= w.end) {
      todayWeekIdx = i;
      break;
    }
  }

  // Fallback: find closest week to today
  if (todayWeekIdx < 0) {
    let minDiff = Infinity;
    for (let i = 0; i < masterWeeks.length; i++) {
      const diff = Math.abs(now - masterWeeks[i].start);
      if (diff < minDiff) {
        minDiff = diff;
        todayWeekIdx = i;
      }
    }
  }

  if (todayWeekIdx < 0) return;

  const scrollPos = Math.max(0, todayWeekIdx * masterCellWidth - bodyWrap.clientWidth / 2);
  bodyWrap.scrollLeft = scrollPos;
  headerWrap.scrollLeft = scrollPos;
  masterScrollPos = scrollPos;
}

// Check if setting project dependency would create circular reference
function wouldCreateProjectCircle(predecessorId, successorId) {
  if (!predecessorId || predecessorId === successorId) return false;
  
  const visited = new Set();
  
  function canReach(fromId, targetId) {
    if (fromId === targetId) return true;
    if (visited.has(fromId)) return false;
    visited.add(fromId);
    
    const proj = projectIndex[fromId];
    if (!proj || !proj.dependency) return false;
    return canReach(proj.dependency, targetId);
  }
  
  // If we can reach predecessorId starting from successorId, it's circular
  return canReach(predecessorId, successorId);
}

// Auto-schedule: propagate date changes to dependent projects
async function propagateProjectDependencies(changedProjectId, _depth = 0) {
  const dayMs = 86400000;
  const changedProj = projectIndex[changedProjectId];
  if (!changedProj) return 0;
  
  const parseDate = (str) => {
    if (!str) return null;
    const parts = str.split('-');
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  };
  const formatDate = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  
  const predecessorEnd = parseDate(changedProj.endDate);
  if (!predecessorEnd) return 0;
  
  // Find all projects that depend on the changed one
  const successors = Object.entries(projectIndex).filter(([id, p]) => !p.archived && p.dependency === changedProjectId);
  
  let rescheduledCount = 0;
  
  for (const [successorId, successor] of successors) {
    const successorStart = parseDate(successor.startDate);
    const successorEnd = parseDate(successor.endDate);
    
    // New start is day after predecessor ends
    const newStart = new Date(predecessorEnd.getTime() + dayMs);
    
    // Calculate duration to preserve
    const duration = successorStart && successorEnd ? Math.round((successorEnd - successorStart) / dayMs) : 30;
    const newEnd = new Date(newStart.getTime() + duration * dayMs);
    
    // Check if dates actually need to change
    const newStartISO = formatDate(newStart);
    const newEndISO = formatDate(newEnd);
    
    if (successor.startDate !== newStartISO || successor.endDate !== newEndISO) {
      // Update the successor
      successor.startDate = newStartISO;
      successor.endDate = newEndISO;
      
      // Save to Firebase
      await globalRef.child('projectIndex/' + successorId).update({
        startDate: successor.startDate,
        endDate: successor.endDate
      });
      
      rescheduledCount++;
      
      // Recursively propagate to this successor's dependents
      rescheduledCount += await propagateProjectDependencies(successorId, _depth + 1);
    }
  }
  
  return rescheduledCount;
}

// Set project dependency (predecessor)
window.setProjectDependency = async (projectId, predecessorId) => {
  const proj = projectIndex[projectId];
  if (!proj) return;
  
  // Check for circular dependency
  if (predecessorId && wouldCreateProjectCircle(projectId, predecessorId)) {
    alert('Cannot set this dependency - it would create a circular reference.');
    renderMasterSchedule(); // Reset dropdown
    return;
  }
  
  // Set the dependency
  proj.dependency = predecessorId || undefined;
  
  // Save dependency to Firebase
  await globalRef.child('projectIndex/' + projectId + '/dependency').set(proj.dependency || null);
  
  // If setting a predecessor, auto-schedule this project to start after predecessor ends
  if (predecessorId) {
    const dayMs = 86400000;
    const predecessor = projectIndex[predecessorId];
    
    if (predecessor && predecessor.endDate) {
      const parseDate = (str) => {
        if (!str) return null;
        const parts = str.split('-');
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      };
      const formatDate = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
      
      const predecessorEnd = parseDate(predecessor.endDate);
      const currentStart = parseDate(proj.startDate);
      const currentEnd = parseDate(proj.endDate);
      
      // New start is day after predecessor ends
      const newStart = new Date(predecessorEnd.getTime() + dayMs);
      
      // Preserve duration (default 30 days if no dates set)
      const duration = currentStart && currentEnd ? Math.round((currentEnd - currentStart) / dayMs) : 30;
      const newEnd = new Date(newStart.getTime() + duration * dayMs);
      
      // Always update dates when setting a dependency
      proj.startDate = formatDate(newStart);
      proj.endDate = formatDate(newEnd);
      
      // Save dates to Firebase
      await globalRef.child('projectIndex/' + projectId).update({
        startDate: proj.startDate,
        endDate: proj.endDate
      });
      
      // Propagate to any projects that depend on this one
      await propagateProjectDependencies(projectId);
    }
  }
  
  renderMasterSchedule();
};

// Render dependency arrows between connected project bars
function renderMasterDependencyArrows(projects, cellWidth, weeks) {
  // Remove existing SVG layer
  const existingSvg = document.querySelector('.master-dependency-layer');
  if (existingSvg) existingSvg.remove();
  
  const timelineBody = $('masterTimelineBody');
  if (!timelineBody || !projects || !weeks || weeks.length === 0) return;
  
  const dayMs = 86400000;
  
  // Helper to find week index for a date
  const findWeekForDate = (date) => {
    if (!date) return -1;
    const dateTime = date.getTime();
    for (let i = 0; i < weeks.length; i++) {
      const weekStart = weeks[i].start.getTime();
      const weekEnd = i < weeks.length - 1 ? weeks[i + 1].start.getTime() : weekStart + 7 * dayMs;
      if (dateTime >= weekStart && dateTime < weekEnd) {
        return i;
      }
    }
    if (weeks.length > 0) {
      const lastWeek = weeks[weeks.length - 1];
      if (dateTime >= lastWeek.start.getTime() && dateTime <= lastWeek.end.getTime()) {
        return weeks.length - 1;
      }
    }
    return -1;
  };
  
  const parseLocalDate = (str) => {
    if (!str) return null;
    const parts = str.split('-');
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  };
  
  // Find dependencies to draw
  const dependencies = [];
  const rowHeight = 43;
  
  projects.forEach((proj, projIdx) => {
    if (!proj.dependency) return;
    const predIdx = projects.findIndex(p => p.id === proj.dependency);
    if (predIdx < 0) return;
    
    const pred = projects[predIdx];
    const predEnd = parseLocalDate(pred.endDate);
    const projStart = parseLocalDate(proj.startDate);
    if (!predEnd || !projStart) return;
    
    // Calculate positions
    const predEndWeekIdx = findWeekForDate(predEnd);
    const projStartWeekIdx = findWeekForDate(projStart);
    
    if (predEndWeekIdx < 0 || projStartWeekIdx < 0) return;
    
    const predEndDaysIntoWeek = Math.max(0, Math.floor((predEnd - weeks[predEndWeekIdx].start) / dayMs));
    const predEndX = predEndWeekIdx * cellWidth + (predEndDaysIntoWeek / 7) * cellWidth + cellWidth / 7;
    
    const projStartDaysIntoWeek = Math.max(0, Math.floor((projStart - weeks[projStartWeekIdx].start) / dayMs));
    const projStartX = projStartWeekIdx * cellWidth + (projStartDaysIntoWeek / 7) * cellWidth;
    
    // Y positions (center of each row)
    const predY = predIdx * rowHeight + rowHeight / 2;
    const projY = projIdx * rowHeight + rowHeight / 2;
    
    dependencies.push({
      fromX: predEndX,
      fromY: predY,
      toX: projStartX,
      toY: projY
    });
  });
  
  if (dependencies.length === 0) return;
  
  // Calculate SVG dimensions
  const svgWidth = parseInt(timelineBody.style.width) || timelineBody.offsetWidth || 1000;
  const svgHeight = Math.max(projects.length * rowHeight, timelineBody.offsetHeight, 100);
  
  // Create SVG layer
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.classList.add('master-dependency-layer');
  svg.setAttribute('width', svgWidth);
  svg.setAttribute('height', svgHeight);
  svg.style.width = svgWidth + 'px';
  svg.style.height = svgHeight + 'px';
  
  // Draw each dependency
  dependencies.forEach(dep => {
    const { fromX, fromY, toX, toY } = dep;
    
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const midX = fromX + (toX - fromX) / 2;
    let d;
    
    if (toX > fromX + 10) {
      d = `M ${fromX} ${fromY} C ${midX} ${fromY}, ${midX} ${toY}, ${toX - 6} ${toY}`;
    } else {
      const offset = 20;
      d = `M ${fromX} ${fromY} L ${fromX + offset} ${fromY} L ${fromX + offset} ${(fromY + toY) / 2} L ${toX - offset} ${(fromY + toY) / 2} L ${toX - offset} ${toY} L ${toX - 6} ${toY}`;
    }
    
    path.setAttribute('d', d);
    path.classList.add('master-dependency-line');
    svg.appendChild(path);
    
    // Arrow head
    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    arrow.setAttribute('points', `${toX - 6},${toY - 4} ${toX},${toY} ${toX - 6},${toY + 4}`);
    arrow.classList.add('master-dependency-arrow');
    svg.appendChild(arrow);
  });
  
  timelineBody.appendChild(svg);
}

// Load team assignments across all projects - based on Gantt timeline (assemblies)
async function loadTeamAssignments() {
  teamAssignments = {};
  
  // Initialize with team members
  team.forEach(m => {
    const name = m.name || m;
    teamAssignments[name] = [];
  });
  
  // Also add anyone with site trips
  siteTrips.forEach(t => {
    if (t.assignee && !teamAssignments[t.assignee]) {
      teamAssignments[t.assignee] = [];
    }
  });
  
  // Query each project for assemblies with assignee and dates
  for (const [projId, projMeta] of Object.entries(projectIndex)) {
    if (projMeta.archived) continue;
    
    try {
      let assemblies;
      
      // Use local data for current project (most up-to-date)
      if (projId === currentProjectId) {
        assemblies = {};
        data.filter(d => d.isAsm && !d._deletedAt).forEach(asm => {
          assemblies[asm.id] = asm;
        });
      } else {
        const asmSnap = await db.ref('projects/' + projId + '/assemblies').once('value');
        assemblies = asmSnap.val();
      }
      
      if (!assemblies) continue;
      
      // Check each assembly for assignee and dates
      Object.values(assemblies).forEach(asm => {
        if (!asm.assignee) return;
        // Check for ganttStart/ganttEnd or startDate/endDate
        const startDate = asm.ganttStart || asm.startDate;
        const endDate = asm.ganttEnd || asm.endDate;
        if (!startDate || !endDate) return;
        
        // Add assignee if not already tracked
        if (!teamAssignments[asm.assignee]) {
          teamAssignments[asm.assignee] = [];
        }
        
        teamAssignments[asm.assignee].push({
          projectId: projId,
          projectName: projMeta.name || 'Unnamed Project',
          assemblyName: asm.name,
          startDate: startDate,
          endDate: endDate
        });
      });
    } catch (e) {
      console.warn('Failed to load assemblies for project', projId, e);
    }
  }
  
  teamAssignmentsLoaded = true;
}

function renderTeamAvailability(weeks, cellWidth, totalWidth, todayWeekIdx) {
  const teamContent = $('masterTeamContent');
  const showTeam = $('masterShowTeam').checked;
  
  if (!showTeam || !team.length) {
    teamContent.innerHTML = '';
    return;
  }
  
  const dayMs = 86400000;
  
  // Parse date as local
  const parseLocalDate = (str) => {
    if (!str) return null;
    const parts = str.split('-');
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  };
  
  const formatDateShort = (d) => d.getDate() + '.' + (d.getMonth() + 1) + '.';
  
  // Show loading if assignments not yet loaded
  if (!teamAssignmentsLoaded) {
    teamContent.innerHTML = '<div class="master-team-section"><div class="master-team-header">Team Availability</div><div style="padding:20px;color:var(--text3);font-size:12px">Loading assignments...</div></div>';
    loadTeamAssignments().then(() => {
      renderTeamAvailability(weeks, cellWidth, totalWidth, todayWeekIdx);
    });
    return;
  }
  
  // Get all unique people: from team AND from site trips
  const allPeopleSet = new Set();
  team.forEach(m => allPeopleSet.add(m.name || m));
  siteTrips.forEach(t => { if(t.assignee) allPeopleSet.add(t.assignee); });
  const allPeople = Array.from(allPeopleSet).sort();
  
  if (!allPeople.length) {
    teamContent.innerHTML = '';
    return;
  }
  
  let html = '<div class="master-team-section">';
  html += '<div class="master-team-header">Team Availability</div>';
  
  // Header row with columns
  html += '<div class="master-team-header-row">';
  html += '<div class="master-team-sidebar-header">';
  html += '<div class="master-col-name">Team Member</div>';
  html += '<div class="master-col-start">Start</div>';
  html += '<div class="master-col-end">End</div>';
  html += '<div class="master-col-dur">Days</div>';
  html += '</div>';
  html += '<div style="flex:1"></div>';
  html += '</div>';
  
  html += '<div class="master-team-body" id="masterTeamBody"><div class="master-team-inner">';
  
  allPeople.forEach(memberName => {
    const memberTrips = siteTrips.filter(t => t.assignee === memberName);
    const memberProjects = teamAssignments[memberName] || [];
    
    // Check for conflicts
    const tripConflicts = new Set();
    
    // Site trip vs site trip
    for (let i = 0; i < memberTrips.length; i++) {
      for (let j = i + 1; j < memberTrips.length; j++) {
        const t1 = memberTrips[i], t2 = memberTrips[j];
        if (!t1.startDate || !t1.endDate || !t2.startDate || !t2.endDate) continue;
        if (t1.startDate <= t2.endDate && t1.endDate >= t2.startDate) {
          tripConflicts.add(t1.id);
          tripConflicts.add(t2.id);
        }
      }
    }
    
    // Site trip vs project assignment
    memberTrips.forEach(trip => {
      if (!trip.startDate || !trip.endDate) return;
      memberProjects.forEach(proj => {
        if (!proj.startDate || !proj.endDate) return;
        if (trip.startDate <= proj.endDate && trip.endDate >= proj.startDate) {
          tripConflicts.add(trip.id);
        }
      });
    });
    
    const hasConflict = tripConflicts.size > 0;
    
    // Calculate earliest and latest trip dates
    let earliestDate = null;
    let latestDate = null;
    let totalDays = 0;
    
    memberTrips.forEach(trip => {
      if (!trip.startDate || !trip.endDate) return;
      const start = parseLocalDate(trip.startDate);
      const end = parseLocalDate(trip.endDate);
      if (!earliestDate || start < earliestDate) earliestDate = start;
      if (!latestDate || end > latestDate) latestDate = end;
      totalDays += Math.max(1, Math.ceil((end - start) / dayMs));
    });
    
    const startStr = earliestDate ? formatDateShort(earliestDate) : 'â€”';
    const endStr = latestDate ? formatDateShort(latestDate) : 'â€”';
    const daysStr = totalDays > 0 ? totalDays : 'â€”';
    
    // Sort trips and assign vertical offsets
    const sortedTrips = [...memberTrips].filter(t => t.startDate && t.endDate).sort((a, b) => a.startDate.localeCompare(b.startDate));
    const tripOffsets = {};
    const activeRows = [];
    
    sortedTrips.forEach(trip => {
      let row = 0;
      for (let r = 0; r < 10; r++) {
        const blocked = activeRows.some(ar => ar.row === r && ar.endDate >= trip.startDate);
        if (!blocked) { row = r; break; }
      }
      tripOffsets[trip.id] = row;
      activeRows.push({ endDate: trip.endDate, row });
    });
    
    const maxRow = Math.max(0, ...Object.values(tripOffsets));
    const rowHeight = 43 + (maxRow * 22);
    
    html += '<div class="master-team-row" data-member="' + esc(memberName) + '" style="min-height:' + rowHeight + 'px">';
    
    // Sidebar with columns
    html += '<div class="master-team-sidebar">';
    html += '<div class="master-col-name"><div class="master-team-name">' + esc(memberName) + (hasConflict ? ' <span style="color:#c75959">âš </span>' : '') + '</div>';
    if (hasConflict) {
      html += '<div class="master-team-meta has-conflict">âš  Overlapping</div>';
    } else {
      html += '<div class="master-team-meta">' + memberTrips.length + ' trip' + (memberTrips.length !== 1 ? 's' : '') + '</div>';
    }
    html += '</div>';
    html += '<div class="master-col-start">' + startStr + '</div>';
    html += '<div class="master-col-end">' + endStr + '</div>';
    html += '<div class="master-col-dur">' + daysStr + '</div>';
    html += '</div>';
    
    // Timeline
    html += '<div class="master-team-timeline" style="width:' + totalWidth + 'px;min-height:' + (34 + maxRow * 22) + 'px">';
    
    // Week cells background
    weeks.forEach((week, i) => {
      const classes = ['master-timeline-cell'];
      if (week.isToday) classes.push('today');
      html += '<div class="' + classes.join(' ') + '" style="position:absolute;left:' + (i * cellWidth) + 'px;top:0;bottom:0"></div>';
    });
    
    // Today line
    if (todayWeekIdx >= 0) {
      const nowLine = new Date();
      const dow = nowLine.getDay(); // JS: 0=Sun, 1=Mon...
      const daysIntoWeek = dow === 0 ? 6 : dow - 1;
      const todayPos = todayWeekIdx * cellWidth + ((daysIntoWeek + 0.5) / 7) * cellWidth;
      html += '<div class="master-today-line" style="left:' + todayPos + 'px"></div>';
    }
    
    // Render site trips with resize handles
    memberTrips.forEach(trip => {
      if (!trip.startDate || !trip.endDate) return;
      
      const tripStart = parseLocalDate(trip.startDate);
      const tripEnd = parseLocalDate(trip.endDate);
      
      // Find week indices
      let startWeekIdx = -1, endWeekIdx = -1;
      for (let i = 0; i < weeks.length; i++) {
        const week = weeks[i];
        if (startWeekIdx < 0 && tripStart <= week.end) startWeekIdx = i;
        if (tripEnd >= week.start) endWeekIdx = i;
      }
      
      if (startWeekIdx < 0 || endWeekIdx < 0) return;
      
      const startWeek = weeks[startWeekIdx];
      const endWeek = weeks[endWeekIdx];
      const daysIntoStartWeek = Math.max(0, Math.floor((tripStart - startWeek.start) / dayMs));
      const barStart = startWeekIdx * cellWidth + (daysIntoStartWeek / 7) * cellWidth;
      const daysIntoEndWeek = Math.min(7, Math.ceil((tripEnd - endWeek.start) / dayMs) + 1);
      const barEnd = endWeekIdx * cellWidth + (daysIntoEndWeek / 7) * cellWidth;
      const barWidth = Math.max(22, barEnd - barStart);
      
      const isConflict = tripConflicts.has(trip.id);
      const barClass = isConflict ? 'conflict' : 'site-trip';
      const offset = tripOffsets[trip.id] || 0;
      const topOffset = 12 + (offset * 22);
      
      const resizeHandles = '<div class="master-trip-bar-resize master-trip-bar-resize-left" data-resize="start"></div><div class="master-trip-bar-resize master-trip-bar-resize-right" data-resize="end"></div>';
      
      html += '<div class="master-timeline-bar ' + barClass + '" data-trip-id="' + trip.id + '" data-assignee="' + esc(trip.assignee) + '" data-site="' + esc(trip.site || '') + '" data-start="' + trip.startDate + '" data-end="' + trip.endDate + '" style="left:' + barStart + 'px;width:' + barWidth + 'px;top:' + topOffset + 'px" title="' + esc(trip.site) + ' (' + trip.startDate + ' â†’ ' + trip.endDate + ')' + (isConflict ? ' âš  CONFLICT' : '') + '">' + esc(trip.site || 'Site Trip') + resizeHandles + '</div>';
    });
    
    html += '</div>';
    html += '</div>';
  });
  
  html += '</div></div>'; // Close master-team-inner and master-team-body
  html += '</div>';
  teamContent.innerHTML = html;
  
  // Sync team body scroll with main body wrap
  const teamBody = $('masterTeamBody');
  const bodyWrap = $('masterBodyWrap');
  if (teamBody && bodyWrap) {
    // Set initial scroll position
    teamBody.scrollLeft = bodyWrap.scrollLeft;
    
    // Sync scroll from team to body
    teamBody.onscroll = function() {
      const scrollLeft = this.scrollLeft;
      bodyWrap.scrollLeft = scrollLeft;
      $('masterTimelineHeaderWrap').scrollLeft = scrollLeft;
      masterScrollPos = scrollLeft;
    };
  }
}

$('masterShowTeam').onchange = () => {
  teamAssignmentsLoaded = false; // Force reload when toggling
  renderMasterSchedule();
};

// Today button
$('masterToday').onclick = () => {
  const todayWeekIdx = masterWeeks.findIndex(w => w.isToday);
  if (todayWeekIdx >= 0) {
    const bodyWrap = $('masterBodyWrap');
    const scrollPos = Math.max(0, todayWeekIdx * masterCellWidth - bodyWrap.clientWidth / 2);
    
    // Animate scroll
    const startPos = bodyWrap.scrollLeft;
    const distance = scrollPos - startPos;
    const duration = 300;
    const startTime = performance.now();
    
    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeProgress = 1 - Math.pow(1 - progress, 3); // ease-out cubic
      const currentPos = startPos + distance * easeProgress;
      
      bodyWrap.scrollLeft = currentPos;
      $('masterTimelineHeaderWrap').scrollLeft = currentPos;
      const teamBody = $('masterTeamBody');
      if (teamBody) teamBody.scrollLeft = currentPos;
      masterScrollPos = currentPos;
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    }
    requestAnimationFrame(animate);
  }
};

// Sync horizontal scroll and vertical scroll
$('masterBodyWrap').addEventListener('scroll', function() {
  const scrollLeft = this.scrollLeft;
  const scrollTop = this.scrollTop;
  $('masterTimelineHeaderWrap').scrollLeft = scrollLeft;
  $('masterSidebar').scrollTop = scrollTop;
  const teamBody = $('masterTeamBody');
  if (teamBody) teamBody.scrollLeft = scrollLeft;
  masterScrollPos = scrollLeft;
});

// Sync vertical scroll from sidebar to body
$('masterSidebar').addEventListener('scroll', function() {
  $('masterBodyWrap').scrollTop = this.scrollTop;
});

// Master Schedule Bar Dragging
(function() {
  let dragState = null;
  
  const parseLocalDate = (str) => {
    if (!str) return null;
    const parts = str.split('-');
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  };
  
  const formatDateISO = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  
  const formatDateShort = (d) => d.getDate() + '.' + (d.getMonth() + 1) + '.';
  
  function getDateFromPosition(x) {
    const dayMs = 86400000;
    const weekIdx = Math.floor(x / masterCellWidth);
    const dayInWeek = Math.round(((x % masterCellWidth) / masterCellWidth) * 7);
    if (weekIdx < 0 || weekIdx >= masterWeeks.length) return null;
    const week = masterWeeks[weekIdx];
    return new Date(week.start.getTime() + dayInWeek * dayMs);
  }
  
  function onMouseDown(e) {
    const bar = e.target.closest('.master-bar');
    if (!bar) return;
    
    const projectId = bar.dataset.projectId;
    if (!projectId) return;
    
    const project = projectIndex[projectId];
    if (!project || !project.startDate || !project.endDate) return;
    
    const resizeHandle = e.target.closest('.master-bar-resize');
    const mode = resizeHandle ? resizeHandle.dataset.resize : 'move';
    
    const container = bar.closest('.master-bar-container');
    const row = bar.closest('.master-timeline-row');
    const rect = container.getBoundingClientRect();
    const rowRect = row.getBoundingClientRect();
    
    dragState = {
      projectId,
      mode,
      bar,
      container,
      row,
      startX: e.clientX,
      origLeft: parseFloat(container.style.left),
      origWidth: parseFloat(container.style.width),
      origStartDate: parseLocalDate(project.startDate),
      origEndDate: parseLocalDate(project.endDate),
      scrollContainer: $('masterBodyWrap')
    };
    
    bar.style.opacity = '0.8';
    bar.style.cursor = mode === 'move' ? 'grabbing' : 'ew-resize';
    document.body.style.cursor = mode === 'move' ? 'grabbing' : 'ew-resize';
    document.body.style.userSelect = 'none';
    
    e.preventDefault();
  }
  
  function onMouseMove(e) {
    if (!dragState) return;
    
    const dx = e.clientX - dragState.startX;
    const dayMs = 86400000;
    
    if (dragState.mode === 'move') {
      // Move entire bar
      const newLeft = Math.max(0, dragState.origLeft + dx);
      dragState.container.style.left = newLeft + 'px';
      
      // Calculate new dates
      const newStartDate = getDateFromPosition(newLeft);
      const duration = Math.round((dragState.origEndDate - dragState.origStartDate) / dayMs);
      if (newStartDate) {
        const newEndDate = new Date(newStartDate.getTime() + duration * dayMs);
        updateSidebarDates(dragState.projectId, newStartDate, newEndDate, duration);
      }
    } else if (dragState.mode === 'start') {
      // Resize from start
      const newLeft = Math.max(0, dragState.origLeft + dx);
      const newWidth = Math.max(masterCellWidth / 2, dragState.origWidth - dx);
      dragState.container.style.left = newLeft + 'px';
      dragState.container.style.width = newWidth + 'px';
      
      const newStartDate = getDateFromPosition(newLeft);
      if (newStartDate && newStartDate < dragState.origEndDate) {
        const duration = Math.round((dragState.origEndDate - newStartDate) / dayMs);
        updateSidebarDates(dragState.projectId, newStartDate, dragState.origEndDate, duration);
      }
    } else if (dragState.mode === 'end') {
      // Resize from end
      const newWidth = Math.max(masterCellWidth / 2, dragState.origWidth + dx);
      dragState.container.style.width = newWidth + 'px';
      
      const newEndDate = getDateFromPosition(dragState.origLeft + newWidth);
      if (newEndDate && newEndDate > dragState.origStartDate) {
        const duration = Math.round((newEndDate - dragState.origStartDate) / dayMs);
        updateSidebarDates(dragState.projectId, dragState.origStartDate, newEndDate, duration);
      }
    }
  }
  
  function updateSidebarDates(projectId, startDate, endDate, duration) {
    const sidebarRow = $('masterSidebar').querySelector('[data-project-id="' + projectId + '"]');
    if (!sidebarRow) return;
    
    const startCell = sidebarRow.querySelector('.master-col-start');
    const endCell = sidebarRow.querySelector('.master-col-end');
    const durCell = sidebarRow.querySelector('.master-col-dur');
    
    if (startCell) {
      startCell.textContent = formatDateShort(startDate);
      startCell.dataset.date = formatDateISO(startDate);
    }
    if (endCell) {
      endCell.textContent = formatDateShort(endDate);
      endCell.dataset.date = formatDateISO(endDate);
    }
    if (durCell) {
      durCell.textContent = duration;
    }
  }
  
  async function onMouseUp(e) {
    if (!dragState) return;
    
    const dx = e.clientX - dragState.startX;
    const dayMs = 86400000;
    let newStartDate, newEndDate;
    
    if (dragState.mode === 'move') {
      const newLeft = Math.max(0, dragState.origLeft + dx);
      newStartDate = getDateFromPosition(newLeft);
      const duration = Math.round((dragState.origEndDate - dragState.origStartDate) / dayMs);
      newEndDate = newStartDate ? new Date(newStartDate.getTime() + duration * dayMs) : null;
    } else if (dragState.mode === 'start') {
      const newLeft = Math.max(0, dragState.origLeft + dx);
      newStartDate = getDateFromPosition(newLeft);
      newEndDate = dragState.origEndDate;
      if (newStartDate >= newEndDate) newStartDate = null;
    } else if (dragState.mode === 'end') {
      const newWidth = Math.max(masterCellWidth / 2, dragState.origWidth + dx);
      newStartDate = dragState.origStartDate;
      newEndDate = getDateFromPosition(dragState.origLeft + newWidth);
      if (newEndDate <= newStartDate) newEndDate = null;
    }
    
    // Save to Firebase if dates changed
    if (newStartDate && newEndDate) {
      const startISO = formatDateISO(newStartDate);
      const endISO = formatDateISO(newEndDate);
      const projectId = dragState.projectId;
      const oldStart = projectIndex[projectId]?.startDate;
      const oldEnd = projectIndex[projectId]?.endDate;

      // Update projectIndex
      if (projectIndex[projectId]) {
        projectIndex[projectId].startDate = startISO;
        projectIndex[projectId].endDate = endISO;
      }

      // Update current project if this is it
      if (projectId === currentProjectId) {
        projectDates.start = startISO;
        projectDates.end = endISO;
        if(oldStart!==startISO)logActivity('date','Project start date changed',{oldValue:oldStart||'none',newValue:startISO});
        if(oldEnd!==endISO)logActivity('date','Project end date changed',{oldValue:oldEnd||'none',newValue:endISO});
      }

      // Save to Firebase
      try {
        await globalRef.child('projectIndex/' + projectId + '/startDate').set(startISO);
        await globalRef.child('projectIndex/' + projectId + '/endDate').set(endISO);
        await db.ref('projects/' + projectId + '/projectDates').set({ start: startISO, end: endISO });
        
        // Propagate changes to dependent projects
        await propagateProjectDependencies(projectId);
      } catch (err) {
        console.error('Failed to save project dates:', err);
      }
    }
    
    // Cleanup
    dragState.bar.style.opacity = '';
    dragState.bar.style.cursor = '';
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    
    dragState = null;
    
    // Re-render to update bar positions properly
    renderMasterSchedule();
  }
  
  // Attach listeners
  document.addEventListener('mousedown', (e) => {
    if (e.target.closest('.master-bar') && $('masterScheduleOverlay').classList.contains('open')) {
      onMouseDown(e);
    }
  });
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
})();

// Drag to scroll with momentum for Master Schedule
(function() {
  let isDragging = false;
  let startX = 0;
  let scrollStartX = 0;
  let velocity = 0;
  let lastX = 0;
  let lastTime = 0;
  let momentumId = null;
  
  function syncScroll(scrollLeft) {
    const bodyWrap = $('masterBodyWrap');
    const headerWrap = $('masterTimelineHeaderWrap');
    const teamBody = $('masterTeamBody');
    
    if (bodyWrap) bodyWrap.scrollLeft = scrollLeft;
    if (headerWrap) headerWrap.scrollLeft = scrollLeft;
    if (teamBody) teamBody.scrollLeft = scrollLeft;
    masterScrollPos = scrollLeft;
  }
  
  function handleMouseDown(e, container) {
    // Don't start drag on interactive elements
    if (e.target.closest('.master-bar') || e.target.closest('.master-timeline-bar') || e.target.closest('.master-sidebar-row') || e.target.closest('.master-team-sidebar') || e.target.closest('select') || e.target.closest('button')) {
      return;
    }
    
    isDragging = true;
    startX = e.pageX;
    scrollStartX = container.scrollLeft;
    lastX = e.pageX;
    lastTime = Date.now();
    velocity = 0;
    
    container.classList.add('grabbing');
    $('masterTimelineHeaderWrap').classList.add('grabbing');
    const teamBody = $('masterTeamBody');
    if (teamBody) teamBody.classList.add('grabbing');
    
    if (momentumId) {
      cancelAnimationFrame(momentumId);
      momentumId = null;
    }
    e.preventDefault();
  }
  
  document.addEventListener('mousemove', e => {
    if (!isDragging) return;
    
    const x = e.pageX;
    const walk = startX - x;
    syncScroll(scrollStartX + walk);
    
    // Calculate velocity
    const now = Date.now();
    const dt = now - lastTime;
    if (dt > 0) {
      velocity = (lastX - x) / dt;
    }
    lastX = x;
    lastTime = now;
  });
  
  document.addEventListener('mouseup', () => {
    if (!isDragging) return;
    isDragging = false;
    
    $('masterBodyWrap').classList.remove('grabbing');
    $('masterTimelineHeaderWrap').classList.remove('grabbing');
    const teamBody = $('masterTeamBody');
    if (teamBody) teamBody.classList.remove('grabbing');
    
    // Apply momentum
    if (Math.abs(velocity) > 0.1) {
      const deceleration = 0.95;
      const minVelocity = 0.1;
      const bodyWrap = $('masterBodyWrap');
      
      function applyMomentum() {
        if (Math.abs(velocity) < minVelocity) {
          momentumId = null;
          return;
        }
        syncScroll(bodyWrap.scrollLeft + velocity * 16);
        velocity *= deceleration;
        momentumId = requestAnimationFrame(applyMomentum);
      }
      applyMomentum();
    }
  });
  
  // Attach to body wrap
  document.addEventListener('mousedown', e => {
    const bodyWrap = $('masterBodyWrap');
    const headerWrap = $('masterTimelineHeaderWrap');
    const teamBody = $('masterTeamBody');
    
    if (!$('masterScheduleOverlay').classList.contains('open')) return;
    
    if (bodyWrap && bodyWrap.contains(e.target)) {
      handleMouseDown(e, bodyWrap);
    } else if (headerWrap && headerWrap.contains(e.target)) {
      handleMouseDown(e, $('masterBodyWrap'));
    } else if (teamBody && teamBody.contains(e.target)) {
      handleMouseDown(e, teamBody);
    }
  });
})();

// Site Trip Bar Dragging (move and resize)
(function() {
  let dragState = null;
  
  const parseLocalDate = (str) => {
    if (!str) return null;
    const parts = str.split('-');
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  };
  
  const formatDateISO = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  
  const formatDateShort = (d) => d.getDate() + '.' + (d.getMonth() + 1) + '.';
  
  function getDateFromPosition(pos) {
    const cellWidth = masterCellWidth;
    const weekIdx = Math.floor(pos / cellWidth);
    const dayOffset = Math.round((pos % cellWidth) / cellWidth * 7);
    
    if (weekIdx < 0 || weekIdx >= masterWeeks.length) return null;
    
    const week = masterWeeks[weekIdx];
    const date = new Date(week.start.getTime() + dayOffset * 86400000);
    return date;
  }
  
  function onMouseDown(e) {
    const bar = e.target.closest('.master-timeline-bar');
    if (!bar || !bar.dataset.tripId) return;
    
    const tripId = bar.dataset.tripId;
    const trip = siteTrips.find(t => t.id === tripId);
    if (!trip) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const container = bar.closest('.master-team-timeline');
    const rect = container.getBoundingClientRect();
    const barRect = bar.getBoundingClientRect();
    
    const isResize = e.target.classList.contains('master-trip-bar-resize');
    const resizeDir = isResize ? e.target.dataset.resize : null;
    
    dragState = {
      tripId,
      trip,
      bar,
      container,
      mode: isResize ? resizeDir : 'move',
      startX: e.clientX,
      origLeft: parseFloat(bar.style.left) || 0,
      origWidth: parseFloat(bar.style.width) || 50,
      origStartDate: parseLocalDate(trip.startDate),
      origEndDate: parseLocalDate(trip.endDate),
      containerLeft: rect.left + $('masterTeamBody').scrollLeft
    };
    
    bar.style.opacity = '0.8';
    bar.style.cursor = dragState.mode === 'move' ? 'grabbing' : 'ew-resize';
    document.body.style.cursor = dragState.mode === 'move' ? 'grabbing' : 'ew-resize';
    document.body.style.userSelect = 'none';
  }
  
  function onMouseMove(e) {
    if (!dragState) return;
    
    const dx = e.clientX - dragState.startX;
    const dayMs = 86400000;
    
    if (dragState.mode === 'move') {
      const newLeft = Math.max(0, dragState.origLeft + dx);
      dragState.bar.style.left = newLeft + 'px';
    } else if (dragState.mode === 'start') {
      const maxDx = dragState.origWidth - masterCellWidth / 2;
      const clampedDx = Math.min(dx, maxDx);
      const newLeft = Math.max(0, dragState.origLeft + clampedDx);
      const newWidth = dragState.origWidth - clampedDx;
      dragState.bar.style.left = newLeft + 'px';
      dragState.bar.style.width = Math.max(masterCellWidth / 2, newWidth) + 'px';
    } else if (dragState.mode === 'end') {
      const newWidth = Math.max(masterCellWidth / 2, dragState.origWidth + dx);
      dragState.bar.style.width = newWidth + 'px';
    }
  }
  
  async function onMouseUp(e) {
    if (!dragState) return;
    
    const dx = e.clientX - dragState.startX;
    const dayMs = 86400000;
    let newStartDate, newEndDate;
    
    if (dragState.mode === 'move') {
      const newLeft = Math.max(0, dragState.origLeft + dx);
      newStartDate = getDateFromPosition(newLeft);
      const duration = Math.round((dragState.origEndDate - dragState.origStartDate) / dayMs);
      newEndDate = newStartDate ? new Date(newStartDate.getTime() + duration * dayMs) : null;
    } else if (dragState.mode === 'start') {
      const newLeft = Math.max(0, dragState.origLeft + dx);
      newStartDate = getDateFromPosition(newLeft);
      newEndDate = dragState.origEndDate;
      if (newStartDate >= newEndDate) newStartDate = null;
    } else if (dragState.mode === 'end') {
      const newWidth = Math.max(masterCellWidth / 2, dragState.origWidth + dx);
      newStartDate = dragState.origStartDate;
      newEndDate = getDateFromPosition(dragState.origLeft + newWidth);
      if (newEndDate <= newStartDate) newEndDate = null;
    }
    
    // Save to Firebase if dates changed
    if (newStartDate && newEndDate) {
      const startISO = formatDateISO(newStartDate);
      const endISO = formatDateISO(newEndDate);
      const tripId = dragState.tripId;
      
      // Update local siteTrips array
      const tripIdx = siteTrips.findIndex(t => t.id === tripId);
      if (tripIdx >= 0) {
        siteTrips[tripIdx].startDate = startISO;
        siteTrips[tripIdx].endDate = endISO;
      }
      
      // Save to Firebase
      try {
        await db.ref('siteTrips/' + tripId + '/startDate').set(startISO);
        await db.ref('siteTrips/' + tripId + '/endDate').set(endISO);
      } catch (err) {
        console.error('Failed to save site trip dates:', err);
      }
    }
    
    // Cleanup
    dragState.bar.style.opacity = '';
    dragState.bar.style.cursor = '';
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    
    dragState = null;
    
    // Re-render to update bar positions and sidebar
    renderMasterSchedule();
  }
  
  // Attach listeners for site trip bars
  document.addEventListener('mousedown', (e) => {
    if (e.target.closest('.master-timeline-bar') && $('masterScheduleOverlay').classList.contains('open')) {
      onMouseDown(e);
    }
  });
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
})();

// Project Dependency Tooltip on Hover
(function() {
  let tooltip = null;
  
  function createTooltip() {
    if (tooltip) return tooltip;
    tooltip = document.createElement('div');
    tooltip.className = 'master-bar-tooltip';
    tooltip.style.cssText = 'position:fixed;z-index:600;background:var(--bg);border:1px solid var(--border);border-radius:6px;box-shadow:0 4px 16px rgba(0,0,0,0.15);padding:10px 12px;font-size:12px;pointer-events:none;opacity:0;transition:opacity 0.15s;max-width:260px';
    document.body.appendChild(tooltip);
    return tooltip;
  }
  
  function showTooltip(projectId, bar) {
    const project = projectIndex[projectId];
    if (!project) return;
    
    const tip = createTooltip();
    
    // Build tooltip content
    let html = '<div style="font-weight:600;color:var(--text);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + esc(project.name || 'Untitled') + '</div>';
    
    // Date range
    if (project.startDate && project.endDate) {
      const formatDate = (str) => {
        const parts = str.split('-');
        return parts[2] + '.' + parts[1] + '.' + parts[0];
      };
      html += '<div style="color:var(--text3);font-size:11px;margin-bottom:6px">' + formatDate(project.startDate) + ' â†’ ' + formatDate(project.endDate) + '</div>';
    }
    
    // Dependency info
    const follows = project.dependency ? projectIndex[project.dependency] : null;
    const blockedBy = Object.values(projectIndex).filter(p => p.dependency === projectId && !p.archived);
    
    if (follows || blockedBy.length > 0) {
      html += '<div style="border-top:1px solid var(--border);padding-top:6px;margin-top:2px">';
      if (follows) {
        html += '<div style="color:var(--text2);font-size:11px">Follows: <span style="color:var(--accent)">' + esc(follows.name || 'Untitled') + '</span></div>';
      }
      if (blockedBy.length > 0) {
        const names = blockedBy.slice(0, 3).map(p => esc(p.name || 'Untitled')).join(', ');
        const more = blockedBy.length > 3 ? ' +' + (blockedBy.length - 3) + ' more' : '';
        html += '<div style="color:var(--text2);font-size:11px">Blocks: <span style="color:var(--text)">' + names + more + '</span></div>';
      }
      html += '</div>';
    }
    
    tip.innerHTML = html;
    
    // Position tooltip
    const barRect = bar.getBoundingClientRect();
    let left = barRect.left + barRect.width / 2 - 130;
    let top = barRect.bottom + 6;
    
    if (left < 10) left = 10;
    if (left + 260 > window.innerWidth - 10) left = window.innerWidth - 270;
    if (top + 100 > window.innerHeight) top = barRect.top - 80;
    
    tip.style.left = left + 'px';
    tip.style.top = top + 'px';
    tip.style.opacity = '1';
  }
  
  function hideTooltip() {
    if (tooltip) tooltip.style.opacity = '0';
  }
  
  // Mouse enter on project bar
  document.addEventListener('mouseover', e => {
    const bar = e.target.closest('.master-bar');
    if (!bar || !$('masterScheduleOverlay').classList.contains('open')) return;
    
    const projectId = bar.dataset.projectId;
    if (projectId) showTooltip(projectId, bar);
  });
  
  // Mouse leave from project bar
  document.addEventListener('mouseout', e => {
    const bar = e.target.closest('.master-bar');
    if (bar) hideTooltip();
  });
  
  // Hide when scrolling
  document.addEventListener('scroll', hideTooltip, true);
})();

// Site Trips Management
$('manageSiteTripsBtn').onclick = () => {
  renderSiteTripAssigneeSelect();
  renderSiteTripsList();
  $('siteTripSite').value = '';
  $('siteTripStart').value = '';
  $('siteTripEnd').value = '';
  openModal('siteTripsModal');
};

$('siteTripsClose').onclick = () => closeModal('siteTripsModal');
$('siteTripsDone').onclick = () => {
  closeModal('siteTripsModal');
  renderMasterSchedule();
};
$('siteTripsModal').onclick = e => { if(e.target.id === 'siteTripsModal') closeModal('siteTripsModal'); };

function renderSiteTripAssigneeSelect() {
  const select = $('siteTripAssignee');
  select.innerHTML = '<option value="">Select team member...</option>' + 
    team.map(m => '<option value="' + esc(m.name) + '">' + esc(m.name) + '</option>').join('');
}

function renderSiteTripsList() {
  const list = $('siteTripList');
  if (!siteTrips.length) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:12px">No site trips scheduled</div>';
    return;
  }
  
  // Sort by start date
  const sorted = [...siteTrips].sort((a, b) => (a.startDate || '').localeCompare(b.startDate || ''));
  
  list.innerHTML = sorted.map(trip => {
    const startStr = trip.startDate ? new Date(trip.startDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '?';
    const endStr = trip.endDate ? new Date(trip.endDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '?';
    return '<div class="site-trip-item">' +
      '<div class="site-trip-item-info">' +
      '<div class="site-trip-item-site">' + esc(trip.assignee) + ' â†’ ' + esc(trip.site || 'Unknown site') + '</div>' +
      '<div class="site-trip-item-dates">' + startStr + ' â†’ ' + endStr + '</div>' +
      '</div>' +
      '<button class="site-trip-item-delete" onclick="window.deleteSiteTrip(\'' + trip.id + '\')" title="Delete">Ã—</button>' +
      '</div>';
  }).join('');
}

$('siteTripAdd').onclick = async () => {
  const assignee = $('siteTripAssignee').value;
  const site = $('siteTripSite').value.trim();
  const startDate = $('siteTripStart').value;
  const endDate = $('siteTripEnd').value;
  
  if (!assignee) { alert('Select a team member'); return; }
  if (!site) { alert('Enter a site/customer name'); return; }
  if (!startDate || !endDate) { alert('Enter start and end dates'); return; }
  if (startDate > endDate) { alert('End date must be after start date'); return; }
  
  const tripId = 'trip_' + Date.now().toString(36);
  await globalRef.child('siteTrips/' + tripId).set({
    assignee,
    site,
    startDate,
    endDate,
    createdAt: firebase.database.ServerValue.TIMESTAMP
  });
  
  $('siteTripSite').value = '';
  $('siteTripStart').value = '';
  $('siteTripEnd').value = '';
  renderSiteTripsList();
};

window.deleteSiteTrip = async (tripId) => {
  if (!confirm('Delete this site trip?')) return;
  await globalRef.child('siteTrips/' + tripId).remove();
  renderSiteTripsList();
};

// Edit Site Trip functionality
let currentEditTripId = null;

window.editSiteTrip = async (tripId) => {
  const trip = siteTrips.find(t => t.id === tripId);
  if (!trip) return;
  
  currentEditTripId = tripId;
  $('editTripAssignee').textContent = trip.assignee;
  $('editTripSite').value = trip.site || '';
  $('editTripStart').value = trip.startDate || '';
  $('editTripEnd').value = trip.endDate || '';
  
  // Show loading state for conflicts
  $('tripConflictInfo').innerHTML = '<div style="color:var(--text3);font-size:12px">Checking for conflicts...</div>';
  
  openModal('editSiteTripModal');
  
  // Check for conflicts asynchronously
  await checkTripConflicts(trip);
};

async function checkTripConflicts(trip) {
  const conflicts = [];
  const tripStart = new Date(trip.startDate);
  const tripEnd = new Date(trip.endDate);
  
  // 1. Check against other site trips for same person
  siteTrips.forEach(other => {
    if (other.id === trip.id) return;
    if (other.assignee !== trip.assignee) return;
    if (!other.startDate || !other.endDate) return;
    const otherStart = new Date(other.startDate);
    const otherEnd = new Date(other.endDate);
    if (tripStart <= otherEnd && tripEnd >= otherStart) {
      conflicts.push({
        type: 'site-trip',
        name: other.site,
        dates: other.startDate + ' â†’ ' + other.endDate
      });
    }
  });
  
  // 2. Check against Gantt timeline tasks (assemblies) across all projects
  for (const [projId, projMeta] of Object.entries(projectIndex)) {
    if (projMeta.archived) continue;
    
    try {
      let assemblies;
      
      // Use local data for current project (most up-to-date)
      if (projId === currentProjectId) {
        assemblies = {};
        data.filter(d => d.isAsm && !d._deletedAt).forEach(asm => {
          assemblies[asm.id] = asm;
        });
      } else {
        const asmSnap = await db.ref('projects/' + projId + '/assemblies').once('value');
        assemblies = asmSnap.val();
      }
      
      if (!assemblies) continue;
      
      // Check each assembly assigned to this person
      Object.values(assemblies).forEach(asm => {
        if (asm.assignee !== trip.assignee) return;
        
        // Check for ganttStart/ganttEnd or startDate/endDate
        const startDate = asm.ganttStart || asm.startDate;
        const endDate = asm.ganttEnd || asm.endDate;
        if (!startDate || !endDate) return;
        
        const asmStart = new Date(startDate);
        const asmEnd = new Date(endDate);
        
        if (tripStart <= asmEnd && tripEnd >= asmStart) {
          conflicts.push({
            type: 'project',
            name: asm.name,
            projectId: projId,
            projectName: projMeta.name || 'Unnamed Project',
            dates: startDate + ' â†’ ' + endDate
          });
        }
      });
    } catch (e) {
      console.warn('Failed to check project', projId, e);
    }
  }
  
  // Render conflicts
  renderTripConflicts(conflicts);
}

function renderTripConflicts(conflicts) {
  const container = $('tripConflictInfo');
  
  if (!conflicts.length) {
    container.innerHTML = '<div style="padding:12px;background:var(--green);background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;color:var(--green);font-size:12px">âœ“ No conflicts detected</div>';
    return;
  }
  
  let html = '<div style="padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px">';
  html += '<div style="font-weight:600;color:var(--red);margin-bottom:8px;font-size:12px">âš  ' + conflicts.length + ' conflict' + (conflicts.length > 1 ? 's' : '') + ' detected</div>';
  
  conflicts.forEach(c => {
    if (c.type === 'site-trip') {
      html += '<div style="font-size:11px;color:var(--text2);padding:6px 0;border-top:1px solid rgba(239,68,68,0.2)">';
      html += '<strong>Site Trip:</strong> ' + esc(c.name) + '<br>';
      html += '<span style="color:var(--text3)">' + c.dates + '</span>';
      html += '</div>';
    } else if (c.type === 'project') {
      html += '<div onclick="window.goToConflictProject(\'' + c.projectId + '\', \'' + esc(c.name).replace(/'/g, "\\'") + '\')" style="font-size:11px;color:var(--text2);padding:8px 6px;margin:4px -6px;border-top:1px solid rgba(239,68,68,0.2);cursor:pointer;border-radius:4px;transition:background .1s"';
      html += ' onmouseover="this.style.background=\'rgba(239,68,68,0.15)\'" onmouseout="this.style.background=\'transparent\'">';
      html += '<strong>' + esc(c.name) + '</strong> <span style="color:var(--text3)">(' + esc(c.projectName) + ')</span> <span style="color:var(--accent);font-size:10px">â†’ Go to project</span><br>';
      html += '<span style="color:var(--text3)">Timeline: ' + c.dates + '</span>';
      html += '</div>';
    }
  });
  
  html += '</div>';
  container.innerHTML = html;
}

let pendingConflictHighlight = null; // Assembly name to highlight after project loads

window.goToConflictProject = (projectId, assemblyName) => {
  closeModal('editSiteTripModal');
  closeMasterInsightsPanel();
  $('masterScheduleOverlay').classList.remove('open');
  pendingConflictHighlight = assemblyName || null;
  switchProject(projectId);
  
  // Switch to Gantt view and highlight after a short delay for data to load
  setTimeout(() => {
    const ganttTab = document.querySelector('[data-tab="gantt"]');
    if (ganttTab) ganttTab.click();
    setTimeout(() => highlightConflictTask(), 500);
  }, 500);
};

function highlightConflictTask() {
  if (!pendingConflictHighlight) return;
  
  const taskName = pendingConflictHighlight;
  pendingConflictHighlight = null;
  
  // Find the bar with matching name
  const bars = document.querySelectorAll('.gantt-bar[data-name]');
  for (const bar of bars) {
    if (bar.dataset.name === taskName) {
      // Scroll into view
      bar.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
      
      // Add highlight class to bar
      bar.classList.add('conflict-highlight');
      
      // Also highlight the sidebar row
      const barId = bar.dataset.barId;
      if (barId) {
        const sidebarRow = document.querySelector('.gantt-sidebar-row[data-row-id="' + barId + '"]');
        if (sidebarRow) {
          sidebarRow.classList.add('highlight');
          setTimeout(() => sidebarRow.classList.remove('highlight'), 5000);
        }
      }
      
      // Remove bar highlight after 5 seconds
      setTimeout(() => {
        bar.classList.remove('conflict-highlight');
      }, 5000);
      
      break;
    }
  }
}

$('editSiteTripClose').onclick = () => closeModal('editSiteTripModal');
$('editTripCancel').onclick = () => closeModal('editSiteTripModal');
$('editSiteTripModal').onclick = e => { if(e.target.id === 'editSiteTripModal') closeModal('editSiteTripModal'); };

$('editTripSave').onclick = async () => {
  if (!currentEditTripId) return;
  
  const site = $('editTripSite').value.trim();
  const startDate = $('editTripStart').value;
  const endDate = $('editTripEnd').value;
  
  if (!site) { alert('Enter a site/customer name'); return; }
  if (!startDate || !endDate) { alert('Enter start and end dates'); return; }
  if (startDate > endDate) { alert('End date must be after start date'); return; }
  
  await globalRef.child('siteTrips/' + currentEditTripId).update({
    site,
    startDate,
    endDate
  });
  
  // Also update local array immediately to avoid race condition
  const tripIndex = siteTrips.findIndex(t => t.id === currentEditTripId);
  if (tripIndex >= 0) {
    siteTrips[tripIndex].site = site;
    siteTrips[tripIndex].startDate = startDate;
    siteTrips[tripIndex].endDate = endDate;
  }
  
  closeModal('editSiteTripModal');
  renderMasterSchedule();
};

$('editTripDelete').onclick = async () => {
  if (!currentEditTripId) return;
  if (!confirm('Delete this site trip?')) return;
  
  await globalRef.child('siteTrips/' + currentEditTripId).remove();
  
  // Also update local array immediately
  const tripIndex = siteTrips.findIndex(t => t.id === currentEditTripId);
  if (tripIndex >= 0) {
    siteTrips.splice(tripIndex, 1);
  }
  
  closeModal('editSiteTripModal');
  renderMasterSchedule();
};

// Re-check conflicts when dates change in edit modal
$('editTripStart').onchange = $('editTripEnd').onchange = () => {
  if (!currentEditTripId) return;
  const trip = siteTrips.find(t => t.id === currentEditTripId);
  if (!trip) return;
  
  // Create temporary trip object with new dates
  const tempTrip = {
    ...trip,
    startDate: $('editTripStart').value,
    endDate: $('editTripEnd').value
  };
  
  if (tempTrip.startDate && tempTrip.endDate) {
    checkTripConflicts(tempTrip);
  }
};

window.openProjectFromMaster = (projectId) => {
  closeMasterInsightsPanel();
  $('masterScheduleOverlay').classList.remove('open');
  switchProject(projectId);
};

// ============================================
// Site Trips & Team Availability
// ============================================

$('manageSiteTripsBtn').onclick = () => {
  renderSiteTripsList();
  updateSiteTripAssigneeSelect();
  $('siteTripSite').value = '';
  $('siteTripStart').value = '';
  $('siteTripEnd').value = '';
  $('siteTripsModal').classList.add('open');
};

$('siteTripsClose').onclick = $('siteTripsDone').onclick = () => {
  closeModal('siteTripsModal');
  renderMasterSchedule();
};

$('siteTripsModal').onclick = e => { if (e.target.id === 'siteTripsModal') closeModal('siteTripsModal'); };

function updateSiteTripAssigneeSelect() {
  const select = $('siteTripAssignee');
  select.innerHTML = '<option value="">Select team member</option>' +
    team.map(t => '<option value="' + esc(t.name) + '">' + esc(t.name) + '</option>').join('');
}

function renderSiteTripsList() {
  const list = $('siteTripList');
  if (!siteTrips.length) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:12px">No site trips scheduled</div>';
    return;
  }
  
  const sorted = [...siteTrips].sort((a, b) => (a.startDate || '').localeCompare(b.startDate || ''));
  list.innerHTML = sorted.map(trip => {
    const startStr = trip.startDate ? new Date(trip.startDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : 'â€”';
    const endStr = trip.endDate ? new Date(trip.endDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : 'â€”';
    return '<div class="site-trip-item">' +
      '<div class="site-trip-item-info">' +
        '<div class="site-trip-item-site">' + esc(trip.assignee) + ' â†’ ' + esc(trip.site || 'Unknown site') + '</div>' +
        '<div class="site-trip-item-dates">' + startStr + ' â€“ ' + endStr + '</div>' +
      '</div>' +
      '<button class="site-trip-item-delete" onclick="window.deleteSiteTrip(\'' + trip.id + '\')" title="Delete">Ã—</button>' +
    '</div>';
  }).join('');
}

$('siteTripAdd').onclick = async () => {
  const assignee = $('siteTripAssignee').value;
  const site = $('siteTripSite').value.trim();
  const startDate = $('siteTripStart').value;
  const endDate = $('siteTripEnd').value;
  
  if (!assignee) { alert('Select a team member'); return; }
  if (!site) { alert('Enter site/customer name'); return; }
  if (!startDate || !endDate) { alert('Enter start and end dates'); return; }
  if (startDate > endDate) { alert('End date must be after start date'); return; }
  
  const tripId = 'trip_' + Date.now().toString(36);
  await globalRef.child('siteTrips/' + tripId).set({
    assignee,
    site,
    startDate,
    endDate
  });
  
  $('siteTripSite').value = '';
  $('siteTripStart').value = '';
  $('siteTripEnd').value = '';
  renderSiteTripsList();
};

window.deleteSiteTrip = async (tripId) => {
  if (!confirm('Delete this site trip?')) return;
  await globalRef.child('siteTrips/' + tripId).remove();
  renderSiteTripsList();
};

// Update newProjectCreate to handle templates
const originalNewProjectCreate = $('newProjectCreate').onclick;
$('newProjectCreate').onclick = async () => {
  const name = $('newProjectName').value.trim();
  if (!name) {  return; }
  
  const templateId = $('newProjectTemplate').value;
  const projectId = generateProjectId();
  
  console.log('Creating project:', projectId, name, 'from template:', templateId || '(empty)');
  
  const newProjectRef = db.ref('projects/' + projectId);
  
  try {
    // Initialize project meta
    await newProjectRef.child('meta').set({
      name: name,
      projectDates: { start: '', end: '' },
      milestones: [],
      schemaVersion: 2,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP,
      fromTemplate: templateId || null
    });
    
    // Add to project index
    await globalRef.child('projectIndex/' + projectId).set({
      name: name,
      archived: false,
      progress: 0,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
    
    // If template selected, copy its structure
    if (templateId) {
      console.log('Loading template data...');
      const templateSnap = await db.ref('templates/' + templateId).once('value');
      const templateData = templateSnap.val();
      
      if (templateData) {
        // Build ID map for both assemblies AND parts first
        const idMap = {}; // old ID -> new ID
        
        // Generate new IDs for assemblies
        if (templateData.assemblies) {
          Object.values(templateData.assemblies).forEach(asm => {
            idMap[asm.id] = generateId();
          });
        }
        
        // Generate new IDs for parts (needed for nested parts)
        if (templateData.parts) {
          Object.values(templateData.parts).forEach(part => {
            idMap[part.id] = generateId();
          });
        }
        
        // Now create assemblies with mapped IDs
        if (templateData.assemblies) {
          const newAsms = {};
          Object.values(templateData.assemblies).forEach(asm => {
            const newId = idMap[asm.id];
            newAsms[newId] = {
              id: newId,
              name: asm.name,
              isAsm: true,
              priority: asm.priority || 0,
              assignee: '',
              _updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
          });
          await newProjectRef.child('assemblies').set(newAsms);
          console.log('Copied', Object.keys(newAsms).length, 'assemblies');
        }
        
        // Copy parts with mapped IDs and parentIds
        if (templateData.parts) {
          const newParts = {};
          Object.values(templateData.parts).forEach(part => {
            const newId = idMap[part.id];
            newParts[newId] = {
              id: newId,
              name: part.name,
              code: part.code || '',
              mfr: part.mfr || '',
              qty: part.qty || 1,
              parentId: part.parentId ? (idMap[part.parentId] || null) : null,
              status: 'waiting',
              assignee: '',
              notes: part.notes || '',
              changedAt: Date.now(),
              _updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
          });
          await newProjectRef.child('parts').set(newParts);
          console.log('Copied', Object.keys(newParts).length, 'parts');
        }
      }
    }
    
    closeModal('newProjectModal');
    $('newProjectName').value = '';
    $('newProjectTemplate').value = '';
    
    
    // Switch to new project
    switchProject(projectId);
    
  } catch(e) {
    console.error('Failed to create project:', e);
  }
};

$('sampleBtn').onclick=()=>{if(confirm('Load sample data? This will replace all current data.')){
  // Clear existing data first
  if(projectRef) {
    projectRef.set(null).then(() => {
      createAndSaveSampleData();
      saveAllToGranular().then(() => {
        
        render();
      });
    });
  } else {
    createAndSaveSampleData();
    
    render();
  }
}};

// Generate 5 Test Projects
$('generateTestProjectsBtn').onclick=async()=>{
  if(!confirm('Generate 5 test projects with ~150 parts each? This will create new projects but not affect existing ones.')) return;
  
  $('menuDrop').classList.remove('open');
  
  
  try {
    await generateTestProjects();
    
  } catch(e) {
    console.error('Failed to generate test projects:', e);
  }
};

async function generateTestProjects() {
  // Team members (shared across projects)
  const testTeam = [
    { name: 'Antti Korhonen', email: 'antti.korhonen@company.fi' },
    { name: 'Sari Virtanen', email: 'sari.virtanen@company.fi' },
    { name: 'Mikko Lahtinen', email: 'mikko.lahtinen@company.fi' },
    { name: 'Tuomas Niemi', email: 'tuomas.niemi@company.fi' },
    { name: 'Jukka Heikkinen', email: 'jukka.heikkinen@company.fi' },
    { name: 'Kaisa MÃ¤kinen', email: 'kaisa.makinen@company.fi' },
    { name: 'Pekka JÃ¤rvinen', email: 'pekka.jarvinen@company.fi' },
    { name: 'Laura Salo', email: 'laura.salo@company.fi' }
  ];
  
  const assemblyTemplates = {
    radar: ['Antenna Array', 'RF Transmitter Module', 'RF Receiver Module', 'Signal Processor', 'Power Distribution Unit', 'Cooling System', 'Control Interface', 'Data Processor', 'Waveguide Assembly', 'Rotary Joint', 'Pedestal Mount', 'Radome', 'Cable Harness Main', 'EMI Shielding', 'Test Interface Panel'],
    communication: ['Transceiver Unit', 'Antenna System', 'Modem Assembly', 'Encryption Module', 'Power Amplifier', 'Low Noise Amplifier', 'Frequency Synthesizer', 'Digital Backend', 'Cooling Assembly', 'Power Supply Unit', 'Control Panel', 'Cable Assembly', 'RF Filter Bank', 'Diplexer Unit', 'Housing Enclosure'],
    sensor: ['Sensor Head', 'Processing Unit', 'Power Module', 'Interface Board', 'Optics Assembly', 'Detector Array', 'Thermal Management', 'Calibration Unit', 'Data Acquisition', 'Signal Conditioning', 'Environmental Sealing', 'Mount Assembly', 'Wiring Harness', 'Test Connector Panel', 'Protective Housing'],
    control: ['Main Controller', 'I/O Module', 'Communication Interface', 'Power Management', 'Display Unit', 'User Interface Panel', 'Safety System', 'Diagnostic Module', 'Data Storage', 'Network Switch', 'Backup Controller', 'Sensor Interface', 'Actuator Driver', 'Emergency Stop', 'Enclosure Assembly'],
    power: ['Rectifier Unit', 'Inverter Module', 'Battery Bank', 'Charge Controller', 'Distribution Panel', 'Protection Circuit', 'Monitoring System', 'Cooling System', 'Transfer Switch', 'Surge Suppressor', 'Grounding Assembly', 'Cable Tray', 'Control Interface', 'Metering Unit', 'Enclosure']
  };
  
  const partTemplates = [
    { name: 'Capacitor Bank 100uF', code: 'CAP-100UF', mfr: 'Murata' },
    { name: 'Capacitor Array 10uF', code: 'CAP-10UF', mfr: 'TDK' },
    { name: 'Resistor Network 10K', code: 'RES-10K', mfr: 'Vishay' },
    { name: 'Power MOSFET', code: 'FET-PWR', mfr: 'Infineon' },
    { name: 'FPGA Module', code: 'FPGA-01', mfr: 'Xilinx' },
    { name: 'DSP Processor', code: 'DSP-TI', mfr: 'Texas Instruments' },
    { name: 'ADC 16-bit', code: 'ADC-16B', mfr: 'Analog Devices' },
    { name: 'DAC 14-bit', code: 'DAC-14B', mfr: 'Analog Devices' },
    { name: 'Op-Amp Quad', code: 'OPAMP-4', mfr: 'Texas Instruments' },
    { name: 'Voltage Regulator 5V', code: 'VREG-5V', mfr: 'Linear Tech' },
    { name: 'RF Amplifier 10W', code: 'RFA-10W', mfr: 'Qorvo' },
    { name: 'LNA Module', code: 'LNA-01', mfr: 'Mini-Circuits' },
    { name: 'RF Switch SP4T', code: 'RFSW-4', mfr: 'Analog Devices' },
    { name: 'RF Mixer', code: 'MIX-01', mfr: 'Mini-Circuits' },
    { name: 'RF Filter 2.4GHz', code: 'RFF-2G4', mfr: 'Johanson' },
    { name: 'VCO Module', code: 'VCO-01', mfr: 'Analog Devices' },
    { name: 'Aluminum Bracket', code: 'BRK-AL', mfr: 'Custom' },
    { name: 'Heat Sink Assembly', code: 'HS-ASM', mfr: 'Aavid' },
    { name: 'Fan Assembly 80mm', code: 'FAN-80', mfr: 'Delta' },
    { name: 'Thermal Pad', code: 'THERM-P', mfr: '3M' },
    { name: 'SMA Connector Male', code: 'SMA-M', mfr: 'Amphenol' },
    { name: 'N-Type Connector', code: 'N-CON', mfr: 'Amphenol' },
    { name: 'D-Sub 25 Connector', code: 'DSUB-25', mfr: 'TE Connectivity' },
    { name: 'Circular Connector 12P', code: 'CIRC-12', mfr: 'Amphenol' },
    { name: 'Coax Cable RG-58', code: 'CBL-RG58', mfr: 'Times Microwave' },
    { name: 'Power Cable 12AWG', code: 'CBL-12A', mfr: 'Alpha Wire' },
    { name: 'Main Controller PCB', code: 'PCB-CTRL', mfr: 'PCBWAY' },
    { name: 'Power Supply PCB', code: 'PCB-PWR', mfr: 'PCBWAY' },
    { name: 'RF Frontend PCB', code: 'PCB-RF', mfr: 'Rogers' },
    { name: 'Gasket Seal', code: 'GSK-01', mfr: 'Parker' }
  ];
  
  const projects = [
    { id: 'proj_mrs450', name: 'MRS-450 Marine Radar', type: 'radar', startDate: '2025-08-01', endDate: '2026-03-15', progress: 85 },
    { id: 'proj_satcom', name: 'SATCOM Terminal v2', type: 'communication', startDate: '2025-11-15', endDate: '2026-06-30', progress: 55 },
    { id: 'proj_eovis', name: 'EO-VIS Sensor Suite', type: 'sensor', startDate: '2026-01-10', endDate: '2026-08-20', progress: 20 },
    { id: 'proj_scada', name: 'SCADA Controller Unit', type: 'control', startDate: '2026-03-01', endDate: '2026-09-30', progress: 5 },
    { id: 'proj_ups500', name: 'UPS-500 Power System', type: 'power', startDate: '2026-05-15', endDate: '2026-12-15', progress: 0 }
  ];
  
  function getStatusForProgress(progress) {
    const rand = Math.random() * 100;
    if (progress >= 85) {
      if (rand < 70) return 'installed';
      if (rand < 80) return 'configured';
      if (rand < 90) return 'tested';
      return 'arrived';
    } else if (progress >= 50) {
      if (rand < 30) return 'installed';
      if (rand < 45) return 'configured';
      if (rand < 60) return 'tested';
      if (rand < 75) return 'arrived';
      if (rand < 85) return 'ordered';
      return rand < 95 ? 'to-order' : 'waiting';
    } else if (progress >= 20) {
      if (rand < 10) return 'installed';
      if (rand < 35) return 'tested';
      if (rand < 50) return 'arrived';
      if (rand < 70) return 'ordered';
      return rand < 85 ? 'to-order' : 'waiting';
    } else if (progress >= 5) {
      if (rand < 15) return 'arrived';
      if (rand < 30) return 'ordered';
      return rand < 50 ? 'to-order' : 'waiting';
    }
    return 'waiting';
  }
  
  function addDays(dateStr, days) {
    const d = new Date(dateStr);
    d.setDate(d.getDate() + days);
    return d.toISOString().split('T')[0];
  }
  
  function randomDays(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }
  
  function randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
  
  // Save team
  await globalRef.child('team').set(testTeam);
  team = testTeam;
  
  for (const proj of projects) {
    console.log('Generating:', proj.name);
    
    const projectRef = db.ref('projects/' + proj.id);
    const assemblies = assemblyTemplates[proj.type];
    const asmData = {};
    const partsData = {};
    
    let currentAsmStart = proj.startDate;
    
    for (let i = 0; i < assemblies.length; i++) {
      const asmId = generateId();
      const asmName = assemblies[i];
      const assignee = randomChoice(testTeam).name;
      
      const staggerDays = i === 0 ? 0 : randomDays(3, 14);
      const asmStartDate = addDays(currentAsmStart, staggerDays);
      const asmDuration = randomDays(21, 45);
      const asmEndDate = addDays(asmStartDate, asmDuration);
      currentAsmStart = asmStartDate;
      
      asmData[asmId] = {
        id: asmId,
        name: asmName,
        isAsm: true,
        assignee: assignee,
        priority: i + 1,
        startDate: asmStartDate,
        endDate: asmEndDate,
        _updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
      
      const numParts = randomDays(8, 12);
      const shuffled = [...partTemplates].sort(() => Math.random() - 0.5);
      
      for (let j = 0; j < numParts; j++) {
        const partId = generateId();
        const partTemplate = shuffled[j % shuffled.length];
        const status = getStatusForProgress(proj.progress);
        
        let poNumber = '', poDate = '', eta = '';
        if (['ordered', 'arrived', 'tested', 'configured', 'installed'].includes(status)) {
          poNumber = 'PO-2026-' + String(1000 + Math.floor(Math.random() * 9000));
          poDate = addDays(proj.startDate, randomDays(0, 30));
          eta = addDays(poDate, randomDays(7, 28));
        }
        
        partsData[partId] = {
          id: partId,
          name: partTemplate.name + (j >= partTemplates.length ? ' #' + Math.ceil(j / partTemplates.length) : ''),
          code: partTemplate.code + '-' + String(100 + j),
          mfr: partTemplate.mfr,
          qty: randomDays(1, 5),
          parentId: asmId,
          assignee: randomChoice(testTeam).name,
          status: status,
          poNumber: poNumber,
          poDate: poDate,
          eta: eta,
          changedAt: Date.now() - randomDays(0, 60) * 86400000,
          _updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
      }
    }
    
    const projDuration = Math.ceil((new Date(proj.endDate) - new Date(proj.startDate)) / 86400000);
    
    // Generate history data (weekly progress points)
    const historyData = {};
    const projStartDate = new Date(proj.startDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Generate weekly points from project start until today (or project end if in future)
    let currentDate = new Date(projStartDate);
    let currentPct = 0;
    const weeklyIncrease = proj.progress / Math.max(1, Math.ceil((Math.min(today, new Date(proj.endDate)) - projStartDate) / (7 * 86400000)));
    
    while (currentDate <= today && currentDate <= new Date(proj.endDate)) {
      const dateStr = currentDate.toISOString().split('T')[0];
      historyData[dateStr] = {
        date: dateStr,
        pct: Math.min(Math.round(currentPct), proj.progress)
      };
      currentPct += weeklyIncrease + (Math.random() * 3 - 1); // Add some variance
      currentDate.setDate(currentDate.getDate() + 7);
    }
    
    // Add today's actual progress
    const todayStr = today.toISOString().split('T')[0];
    if (today >= projStartDate) {
      historyData[todayStr] = { date: todayStr, pct: proj.progress };
    }
    
    await projectRef.set({
      meta: {
        name: proj.name,
        projectDates: { start: proj.startDate, end: proj.endDate },
        milestones: [
          { id: generateId(), name: 'Design Review', date: addDays(proj.startDate, 30), color: '#8ABADC' },
          { id: generateId(), name: 'First Article', date: addDays(proj.startDate, Math.floor(projDuration * 0.5)), color: '#D4A574' },
          { id: generateId(), name: 'Final Delivery', date: proj.endDate, color: '#27AE60' }
        ],
        schemaVersion: 2,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      },
      assemblies: asmData,
      parts: partsData,
      history: historyData
    });
    
    await globalRef.child('projectIndex/' + proj.id).set({
      name: proj.name,
      archived: false,
      startDate: proj.startDate,
      endDate: proj.endDate,
      progress: proj.progress,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
  }
  
  // Switch to first project
  switchProject('proj_mrs450');
}

// MSSR BOM Template Import
$('importMssrBtn').onclick = async () => {
  if(!confirm('Import MSSR Production BOM as a template?\n\nThis will add a template with 17 assemblies and 291 parts (4-level hierarchy) that you can use to create new projects.')) return;
  
  $('menuDrop').classList.remove('open');
  
  
  try {
    await importMssrTemplate();
    
  } catch(e) {
    console.error('Failed to import MSSR template:', e);
  }
};

async function importMssrTemplate() {
  const MSSR = {
    assemblies: [
      {id:'t0002',name:'MSSR Test Transponder',priority:1},
      {id:'t0024',name:'Low beam HF line',priority:2},
      {id:'t0057',name:'HF Frame',priority:3},
      {id:'t0083',name:'Control signal driver V2',priority:4},
      {id:'t0089',name:'Anemometer - Weather Transmitter WXT530',priority:5},
      {id:'t0090',name:'MSSR interrogator',priority:6},
      {id:'t0152',name:'PTC',priority:7},
      {id:'t0188',name:'RSCC',priority:8},
      {id:'t0239',name:'ADS-B/Telecom cabinet',priority:9},
      {id:'t0242',name:'RESU-AR',priority:10},
      {id:'t0251',name:'Distribution Box',priority:11},
      {id:'t0258',name:'PC equipment (Remote CMS)',priority:12},
      {id:'t0263',name:'Triton half-height rack (misc.)',priority:13},
      {id:'t0270',name:'Tower comms rack',priority:14},
      {id:'t0288',name:'Other',priority:15},
      {id:'t0292',name:'Network equipment sundries',priority:16},
      {id:'t0304',name:'Packing material',priority:17}
    ],
    parts: [
      {id:'t0003',n:'DDC-TT V4 Components board',c:'N.469535.170-05',m:'Jopaco',q:2,p:'t0002'},
      {id:'t0004',n:'Osc',c:'3HPK5361-A-80.00',m:'Euroquartz',q:2,p:'t0003'},
      {id:'t0005',n:'Transceiver-TT',c:'N.469535.169',m:'Jopaco',q:2,p:'t0003'},
      {id:'t0006',n:'RF switch SPDT',c:'R516312100',m:'Radiall',q:4,p:'t0003'},
      {id:'t0007',n:'Oscillator',c:'AXIOM 15-50-10-1B 121.1(1)MHz',m:'Axtal',q:2,p:'t0003'},
      {id:'t0008',n:'Transistor',c:'AFIC10275GNR1',m:'NXP',q:2,p:'t0003'},
      {id:'t0009',n:'FR filter',c:'KFF6415A',m:'CTS',q:2,p:'t0003'},
      {id:'t0010',n:'FR filter',c:'KFF6384A',m:'CTS',q:4,p:'t0003'},
      {id:'t0011',n:'FR filter',c:'KR2882',m:'KR Filters',q:2,p:'t0003'},
      {id:'t0012',n:'FR filter',c:'KR2537',m:'KR Filters',q:2,p:'t0003'},
      {id:'t0013',n:'MBP44RC1090S15C',c:'MBP44RC1090S15C',m:'Sangshin',q:2,p:'t0003'},
      {id:'t0014',n:'ATC load 50 Ohm',c:'LT1 2010',m:'ATC',q:2,p:'t0003'},
      {id:'t0015',n:'JID1030T1090M10C-NRP',c:'JID1030T1090M10C-NRP',m:'',q:2,p:'t0003'},
      {id:'t0016',n:'JCD1030T1090M15-PK',c:'JCD1030T1090M15-PK',m:'',q:2,p:'t0003'},
      {id:'t0017',n:'Embedded SBC Intel Atom x6413E',c:'CAPA322-x6413E-B',m:'Axiomtek',q:2,p:'t0003'},
      {id:'t0018',n:'RAM Module',c:'DDR4 3200 SO-DIMM 8GB',m:'EG',q:2,p:'t0003'},
      {id:'t0019',n:'SSD Module',c:'M.2 NVMe SSD 64GB',m:'EG',q:2,p:'t0003'},
      {id:'t0020',n:'Power inlet BVA01-Z0000-01',c:'313-6152',m:'',q:2,p:'t0003'},
      {id:'t0021',n:'Fuse Glass Quick blow 3.15A',c:'112-3176',m:'',q:2,p:'t0003'},
      {id:'t0022',n:'Set of cables for TT antenna',c:'',m:'',q:2,p:'t0002'},
      {id:'t0023',n:'TT antenna 1000-1120 MHz LP28V',c:'120.516.183',m:'ElettroMagnetic',q:1,p:'t0002'},
      {id:'t0025',n:'Base',c:'N.301314.058',m:'Kamri',q:1,p:'t0024'},
      {id:'t0026',n:'Base',c:'N.301314.059',m:'Kamri',q:1,p:'t0024'},
      {id:'t0027',n:'Support',c:'N.301314.060',m:'Kamri',q:2,p:'t0024'},
      {id:'t0028',n:'Support',c:'N.301314.060-01',m:'Kamri',q:1,p:'t0024'},
      {id:'t0029',n:'Sealing section PCB',c:'N.741124.134',m:'',q:1,p:'t0024'},
      {id:'t0030',n:'Limiter',c:'N.434832.010',m:'Matrel',q:2,p:'t0024'},
      {id:'t0031',n:'Microsemi Diode',c:'GC4750-115-2',m:'Microsemi',q:8,p:'t0030'},
      {id:'t0032',n:'Limiter board',c:'N.469535.105',m:'Jopaco',q:2,p:'t0030'},
      {id:'t0033',n:'ATC resistor 50 Ohms',c:'CT13725T0050J02',m:'ATC',q:4,p:'t0030'},
      {id:'t0034',n:'Power detector',c:'N.468214.014',m:'Sanmina',q:2,p:'t0024'},
      {id:'t0035',n:'Waveguide',c:'N.468551.027',m:'a1Microwave',q:1,p:'t0024'},
      {id:'t0036',n:'Waveguide',c:'N.468551.028',m:'a1Microwave',q:1,p:'t0024'},
      {id:'t0037',n:'Waveguide with pipe',c:'N.468564.024',m:'a1Microwave',q:1,p:'t0024'},
      {id:'t0038',n:'Low noise amplifier',c:'N.468742.028',m:'Sanmina',q:2,p:'t0024'},
      {id:'t0039',n:'Microsemi Diode',c:'GC4701-35',m:'Microsemi',q:2,p:'t0038'},
      {id:'t0040',n:'Microsemi Diode',c:'GC4721-35',m:'Microsemi',q:2,p:'t0038'},
      {id:'t0041',n:'Adaptor angle HUBER+SUHNER',c:'53N-50-0-4/133NE',m:'Orbis',q:2,p:'t0024'},
      {id:'t0042',n:'Adaptor Spinner Plug-Plug type N',c:'BN 293650',m:'Spinner',q:2,p:'t0024'},
      {id:'t0043',n:'Type-N WG coax adapter',c:'284-253HPA-1',m:'ATM Microwave',q:1,p:'t0024'},
      {id:'t0044',n:'Type-N directional coupler',c:'715-10-3.100',m:'MECA',q:1,p:'t0024'},
      {id:'t0045',n:'ATM Waveguide gasket',c:'G284A1H',m:'Alroy Microwave',q:50,p:'t0024'},
      {id:'t0046',n:'Apollo Circulator WR284',c:'18931-02 CPR284G',m:'Apollo',q:1,p:'t0024'},
      {id:'t0047',n:'Apollo Dual loop coupler WR284',c:'18182-05 20W',m:'Apollo',q:1,p:'t0024'},
      {id:'t0048',n:'Switch',c:'R570013005',m:'Radiall',q:1,p:'t0024'},
      {id:'t0049',n:'LLP Switch',c:'N.468364.026',m:'Sanmina',q:1,p:'t0024'},
      {id:'t0050',n:'LLP Switch Adapter',c:'N.745312.062',m:'Kamri',q:1,p:'t0049'},
      {id:'t0051',n:'Switch component',c:'R731 117N',m:'Ramet',q:6,p:'t0049'},
      {id:'t0052',n:'Cavity BPF with N connectors',c:'WVC-2800B-200M03',m:'Wevercomm',q:2,p:'t0024'},
      {id:'t0053',n:'Coaxial cables',c:'Various',m:'Easat FIN',q:1,p:'t0024'},
      {id:'t0054',n:'Coaxial Connector N R/A',c:'R161152107',m:'Radiall',q:5,p:'t0024'},
      {id:'t0055',n:'Coaxial Connector N Straight',c:'R161052000',m:'Radiall',q:13,p:'t0024'},
      {id:'t0056',n:'Coaxial cable',c:'SUCOFORM_141_CU_FEP',m:'HUBER+SUHNER',q:1,p:'t0024'},
      {id:'t0058',n:'Plate',c:'N.741134.091',m:'Kamri',q:1,p:'t0057'},
      {id:'t0059',n:'Plate',c:'N.741134.092',m:'Kamri',q:1,p:'t0057'},
      {id:'t0060',n:'Supporting arm',c:'N.745412.014',m:'Kamri',q:2,p:'t0057'},
      {id:'t0061',n:'Supporting arm',c:'N.745422.058',m:'Kamri',q:6,p:'t0057'},
      {id:'t0062',n:'Low noise amplifier',c:'N.468742.028',m:'Sanmina',q:3,p:'t0057'},
      {id:'t0063',n:'Microsemi Diode',c:'GC4701-35',m:'Microsemi',q:3,p:'t0062'},
      {id:'t0064',n:'Microsemi Diode',c:'GC4721-35',m:'Microsemi',q:3,p:'t0062'},
      {id:'t0065',n:'Meteo Limiter',c:'N.434832.011',m:'PCBWay',q:1,p:'t0057'},
      {id:'t0066',n:'Meteo limiter board',c:'N.469535.188',m:'PCBCart',q:1,p:'t0065'},
      {id:'t0067',n:'Microsemi Diode',c:'GC4750-115-2',m:'Microsemi',q:1,p:'t0065'},
      {id:'t0068',n:'Microsemi Diode',c:'GC4721-149',m:'Microsemi',q:1,p:'t0065'},
      {id:'t0069',n:'RF N Panel Receptacle Plug',c:'Amphenol 172118',m:'Amphenol',q:2,p:'t0065'},
      {id:'t0070',n:'Adaptor Spinner Plug-Plug type N',c:'BN 293650',m:'Spinner',q:4,p:'t0057'},
      {id:'t0071',n:'Adaptor angle HUBER+SUHNER',c:'53N-50-0-4/133NE',m:'Orbis',q:2,p:'t0057'},
      {id:'t0072',n:'Power splitter 1 to 4',c:'D4-49FN',m:'Microlab',q:1,p:'t0057'},
      {id:'t0073',n:'Switch',c:'R570013005',m:'Radiall',q:1,p:'t0057'},
      {id:'t0074',n:'LLP Switch',c:'N.468364.026',m:'Sanmina',q:1,p:'t0057'},
      {id:'t0075',n:'Termination 2W',c:'KARN-50+',m:'Mini-Circuits',q:1,p:'t0057'},
      {id:'t0076',n:'Cavity BPF',c:'WVC-2800B-200M02',m:'Wevercomm',q:2,p:'t0057'},
      {id:'t0077',n:'Power and signal Line for HF Frame',c:'Various',m:'Easat FIN',q:1,p:'t0057'},
      {id:'t0078',n:'Coaxial cables',c:'Various',m:'Easat FIN',q:1,p:'t0057'},
      {id:'t0079',n:'Coaxial Connector N R/A',c:'R161152107',m:'Radiall',q:6,p:'t0057'},
      {id:'t0080',n:'Coaxial Connector N Straight',c:'R161052000',m:'Radiall',q:4,p:'t0057'},
      {id:'t0081',n:'Coaxial cable',c:'SUCOFORM_141_CU_FEP',m:'HUBER+SUHNER',q:1,p:'t0057'},
      {id:'t0082',n:'Spacer bolt 18mm x 8mm M4',c:'148-00-759',m:'Elfa',q:4,p:'t0057'},
      {id:'t0084',n:'Coaxial cables CSD-Interrogator',c:'',m:'Easat FIN',q:1,p:'t0083'},
      {id:'t0085',n:'Generator 1090MHz',c:'AXMW1090GYT-01',m:'AXTAL',q:1,p:'t0083'},
      {id:'t0086',n:'GPS sensors',c:'Acutime 360 106406-00',m:'Trimble',q:2,p:'t0083'},
      {id:'t0087',n:'GPS interface cable 50ft',c:'60148',m:'EG',q:2,p:'t0083'},
      {id:'t0088',n:'GPS antenna holder',c:'R733260N RAL 7035',m:'Ramet',q:1,p:'t0083'},
      {id:'t0091',n:'Cabinet',c:'N.301445.032',m:'Sanmina',q:1,p:'t0090'},
      {id:'t0092',n:'SSR-5T',c:'N.464223.006',m:'Sanmina',q:2,p:'t0090'},
      {id:'t0093',n:'Amplifier Freescale/NXP',c:'AFIC10275N',m:'NXP',q:4,p:'t0092'},
      {id:'t0094',n:'Transistor Ampleon 600W',c:'BLA6H1011-600',m:'Ampleon',q:16,p:'t0092'},
      {id:'t0095',n:'Isolator JQL clockwise',c:'JID1030T1090S6',m:'JQL',q:10,p:'t0092'},
      {id:'t0096',n:'Isolator JQL counter clockwise',c:'JID1030T1090S6C',m:'JQL',q:10,p:'t0092'},
      {id:'t0097',n:'AXIOM 15-50-10',c:'AXIOM 15-50-10 114.4MHz',m:'Axtal',q:2,p:'t0092'},
      {id:'t0098',n:'SSR-5T Control Board',c:'N.469535.121',m:'Sanmina',q:2,p:'t0092'},
      {id:'t0099',n:'Base with boards 600W',c:'N.301414.016',m:'Sanmina',q:16,p:'t0092'},
      {id:'t0100',n:'BPF 1030MHz',c:'MBP44RC1030S15C',m:'Sangshin',q:2,p:'t0092'},
      {id:'t0101',n:'RESU-S V2',c:'N.468157.029',m:'Sanmina',q:2,p:'t0090'},
      {id:'t0102',n:'SubRack RESU-S',c:'N.301363.016',m:'Sanmina',q:2,p:'t0101'},
      {id:'t0103',n:'Cross-RESU V2',c:'N.468363.006',m:'Sanmina',q:2,p:'t0102'},
      {id:'t0104',n:'Receiver Fan',c:'RG125-19/14N',m:'Ebmpapst',q:1,p:'t0102'},
      {id:'t0105',n:'Panel with components V2',c:'N.301412.028',m:'Sanmina',q:2,p:'t0101'},
      {id:'t0106',n:'Component board',c:'N.469535.048',m:'Sanmina',q:2,p:'t0105'},
      {id:'t0107',n:'Toggle switch SS-21',c:'',m:'Switronic',q:2,p:'t0105'},
      {id:'t0108',n:'PSU V2',c:'N.436434.006',m:'Sanmina',q:2,p:'t0101'},
      {id:'t0109',n:'MR-S V2',c:'N.464334.004',m:'Sanmina',q:2,p:'t0101'},
      {id:'t0110',n:'Oscillator',c:'AXIOM 15-50-10 113MHz',m:'Axtal',q:2,p:'t0109'},
      {id:'t0111',n:'DDC-S V2',c:'N.467747.004-01',m:'Sanmina',q:4,p:'t0101'},
      {id:'t0112',n:'SF-S V2',c:'N.468129.003',m:'Sanmina',q:2,p:'t0101'},
      {id:'t0113',n:'AXIOM45-12-10 93.33MHz',c:'AXIOM45-12-10_Rev.5',m:'Axtal',q:2,p:'t0112'},
      {id:'t0114',n:'DSPC-S1',c:'N.468152.021',m:'Sanmina',q:2,p:'t0101'},
      {id:'t0115',n:'Starter kit',c:'TMDSDSK 6416-TE',m:'Spectrum Digital',q:2,p:'t0114'},
      {id:'t0116',n:'RCB-S V2',c:'N.468214.011-01',m:'Sanmina',q:2,p:'t0101'},
      {id:'t0117',n:'L2+ Ethernet switch SFP',c:'TL-SG3210',m:'TP-Link',q:2,p:'t0090'},
      {id:'t0118',n:'SSR ConU',c:'N.468364.020',m:'Sanmina',q:1,p:'t0090'},
      {id:'t0119',n:'Cross ConU',c:'N.468363.015',m:'Sanmina',q:1,p:'t0118'},
      {id:'t0120',n:'SSR CB',c:'N.468213.015',m:'Sanmina',q:1,p:'t0118'},
      {id:'t0121',n:'RCB',c:'N.468213.012-01',m:'Sanmina',q:1,p:'t0118'},
      {id:'t0122',n:'IB',c:'N.467845.002',m:'Sanmina',q:1,p:'t0118'},
      {id:'t0123',n:'AIP',c:'N.468152.016-01',m:'Sanmina',q:2,p:'t0118'},
      {id:'t0124',n:'Cavity BPF',c:'WVC-1090B-26M01',m:'Wevercomm',q:3,p:'t0090'},
      {id:'t0125',n:'Bandpass filter',c:'N.468844.008',m:'TMP',q:1,p:'t0090'},
      {id:'t0126',n:'Power supply unit',c:'N.436434.007-01',m:'Kamri',q:2,p:'t0090'},
      {id:'t0127',n:'PSU Lambda HWS300-24',c:'285-1322-ND',m:'Lambda',q:4,p:'t0126'},
      {id:'t0128',n:'PSU Lambda HWS1500-48',c:'285-1292-ND',m:'Lambda',q:4,p:'t0126'},
      {id:'t0129',n:'MSSR LLP Switch',c:'N.468364.025',m:'Sanmina',q:1,p:'t0090'},
      {id:'t0130',n:'RF cables',c:'Various',m:'Orbis',q:1,p:'t0090'},
      {id:'t0131',n:'Port server',c:'NPort 6650-32-48V',m:'MOXA',q:2,p:'t0090'},
      {id:'t0132',n:'RF power switch',c:'R577043005',m:'Radiall',q:2,p:'t0090'},
      {id:'t0133',n:'Circulator',c:'JCC1030T1090NFFM5-PK',m:'JQL',q:2,p:'t0090'},
      {id:'t0134',n:'50 Watt RF Load',c:'PE6TR029',m:'Pasternack',q:2,p:'t0090'},
      {id:'t0135',n:'Adaptor angle HUBER+SUHNER',c:'53N-50-0-4/133NE',m:'Orbis',q:2,p:'t0134'},
      {id:'t0136',n:'LCD USB Console',c:'PS-CV-751',m:'Austin-Hughes',q:1,p:'t0090'},
      {id:'t0137',n:'Ethernet switch',c:'EDS-510E-3GTXSFP',m:'MOXA',q:2,p:'t0090'},
      {id:'t0138',n:'Secure Router',c:'EDR-810-2GSFP',m:'MOXA',q:1,p:'t0090'},
      {id:'t0139',n:'Serial Converter',c:'Sunhillo RICI 6000',m:'Sunhillo',q:1,p:'t0090'},
      {id:'t0140',n:'DVI KVM switch',c:'CS1768',m:'Aten',q:1,p:'t0090'},
      {id:'t0141',n:'RHP',c:'N.466219.012',m:'Data Group',q:2,p:'t0090'},
      {id:'t0142',n:'RHP HDD',c:'SSD',m:'',q:1,p:'t0090'},
      {id:'t0143',n:'CMS Server Software Backup',c:'SSD',m:'',q:1,p:'t0090'},
      {id:'t0144',n:'Distribution plank',c:'N.469119.024',m:'Easat FIN',q:1,p:'t0090'},
      {id:'t0145',n:'CAT6a 1m Black',c:'93685',m:'Easat FIN',q:1,p:'t0090'},
      {id:'t0146',n:'CAT6a 1m Orange',c:'93683',m:'Easat FIN',q:3,p:'t0090'},
      {id:'t0147',n:'CAT6a 3m Black',c:'93787',m:'Easat FIN',q:3,p:'t0090'},
      {id:'t0148',n:'CAT6a 3m Orange',c:'93785',m:'Easat FIN',q:1,p:'t0090'},
      {id:'t0149',n:'CAT6a 5m Black',c:'93820',m:'Easat FIN',q:3,p:'t0090'},
      {id:'t0150',n:'CAT6a 5m Orange',c:'93818',m:'Easat FIN',q:3,p:'t0090'},
      {id:'t0151',n:'Wire harness for Interrogator',c:'',m:'Easat FIN',q:1,p:'t0090'},
      {id:'t0153',n:'Cabinet',c:'N.301445.015',m:'Matrel',q:1,p:'t0152'},
      {id:'t0154',n:'Transmitter Fan',c:'SK 3243.700',m:'Rittal',q:1,p:'t0153'},
      {id:'t0155',n:'Pre-amplifier',c:'N.468742.025',m:'Jopaco/Matrel',q:2,p:'t0152'},
      {id:'t0156',n:'Skyworks isolator PA-60',c:'SKYFR-000778',m:'Skyworks',q:6,p:'t0155'},
      {id:'t0157',n:'Transistor Integra 10W PA-60',c:'IGN2731L10',m:'Integra',q:2,p:'t0155'},
      {id:'t0158',n:'Transistor Integra 65W PA-60',c:'IGN2730M65',m:'Integra',q:2,p:'t0155'},
      {id:'t0159',n:'PA-1600',c:'N.468742.024',m:'Jopaco/Matrel',q:12,p:'t0152'},
      {id:'t0160',n:'Base with transistors',c:'N.301414.008',m:'TMP/Jopaco',q:48,p:'t0159'},
      {id:'t0161',n:'CREE Transistors',c:'CGH31240F',m:'Cree',q:108,p:'t0159'},
      {id:'t0162',n:'Skyworks isolator',c:'MAFR-000430',m:'Skyworks',q:144,p:'t0159'},
      {id:'t0163',n:'Microsemi Diode',c:'GC4711-149',m:'Microsemi',q:12,p:'t0159'},
      {id:'t0164',n:'Transistor Integra',c:'ILT2731M15',m:'Integra',q:12,p:'t0159'},
      {id:'t0165',n:'PTC Power Control Unit',c:'N.468213.017',m:'',q:1,p:'t0152'},
      {id:'t0166',n:'Power control board',c:'N.468213.018',m:'PCBCart',q:1,p:'t0165'},
      {id:'t0167',n:'MiiNePort E1',c:'MiiNePort E1',m:'MOXA',q:2,p:'t0165'},
      {id:'t0168',n:'Lid',c:'N.745222.052',m:'Matrel',q:1,p:'t0165'},
      {id:'t0169',n:'Base',c:'N.745418.005',m:'Matrel',q:1,p:'t0165'},
      {id:'t0170',n:'PTC Power supply',c:'N.436434.008',m:'Kamri',q:5,p:'t0152'},
      {id:'t0171',n:'Emerson PSU',c:'ADN40-24-3PM-C',m:'Emerson',q:10,p:'t0170'},
      {id:'t0172',n:'Base',c:'N.301314.062',m:'Matrel',q:5,p:'t0152'},
      {id:'t0173',n:'Filter',c:'N.305122.002',m:'Matrel',q:1,p:'t0152'},
      {id:'t0174',n:'Cooler unit',c:'N.305243.004',m:'Matrel',q:3,p:'t0152'},
      {id:'t0175',n:'Fan',c:'D3G 146-HQ13-62',m:'Ebmpapst',q:3,p:'t0174'},
      {id:'t0176',n:'RF cables',c:'Various',m:'Orbis',q:1,p:'t0152'},
      {id:'t0177',n:'Power divider 2 ways',c:'PS2-10-450/3N',m:'Pulsar',q:1,p:'t0152'},
      {id:'t0178',n:'RF power switch',c:'R577013005',m:'Radiall',q:1,p:'t0152'},
      {id:'t0179',n:'Bulkhead adaptor N-SMA',c:'R191381000',m:'Radiall',q:2,p:'t0152'},
      {id:'t0180',n:'Cavity BPF',c:'WVC-2800B-200M02',m:'Wevercomm',q:1,p:'t0152'},
      {id:'t0181',n:'Coaxial Termination N 25W',c:'407-2',m:'MECA',q:1,p:'t0152'},
      {id:'t0182',n:'Adaptor Spinner N',c:'BN 293650',m:'Spinner',q:1,p:'t0181'},
      {id:'t0183',n:'MECA 1-12 Splitter N',c:'812-4-1.900',m:'MECA',q:1,p:'t0152'},
      {id:'t0184',n:'Combiner 12 to 1',c:'N.468523.016',m:'',q:1,p:'t0152'},
      {id:'t0185',n:'Waveguide combiner',c:'N.468521.004',m:'a1Microwave',q:1,p:'t0184'},
      {id:'t0186',n:'Combiner 6 to 1',c:'N.468523.018',m:'Matrel',q:2,p:'t0184'},
      {id:'t0187',n:'Waveguide',c:'N.685159.018',m:'a1Microwave',q:2,p:'t0186'},
      {id:'t0189',n:'Cabinet',c:'N.301445.024',m:'Sanmina',q:1,p:'t0188'},
      {id:'t0190',n:'RESU-P',c:'N.468157.030',m:'Sanmina',q:2,p:'t0188'},
      {id:'t0191',n:'SubRack RESU-P',c:'N.301363.017',m:'Sanmina',q:2,p:'t0190'},
      {id:'t0192',n:'Cross RESU-P',c:'N.468363.007',m:'Sanmina',q:2,p:'t0191'},
      {id:'t0193',n:'Panel with components',c:'N.301412.030',m:'Sanmina',q:2,p:'t0190'},
      {id:'t0194',n:'Component board',c:'N.469535.048',m:'Sanmina',q:2,p:'t0193'},
      {id:'t0195',n:'Toggle switch SS-21',c:'',m:'Switronic',q:2,p:'t0193'},
      {id:'t0196',n:'MR-P',c:'N.464334.011',m:'',q:2,p:'t0190'},
      {id:'t0197',n:'Oscillator 100 MHz',c:'ECOC-2522-100',m:'ECS',q:2,p:'t0196'},
      {id:'t0198',n:'Synthesizer',c:'HFS-3130-01',m:'EM Research',q:2,p:'t0196'},
      {id:'t0199',n:'DDC-P V2',c:'N.467747.004',m:'Sanmina',q:2,p:'t0190'},
      {id:'t0200',n:'SF-P',c:'N.468129.004',m:'Sanmina',q:2,p:'t0190'},
      {id:'t0201',n:'AXIOM 40MHz',c:'AXIOM45-12-10-1B_Rev.8',m:'AXTAL',q:2,p:'t0200'},
      {id:'t0202',n:'PSU V2',c:'N.436434.006',m:'Sanmina',q:2,p:'t0190'},
      {id:'t0203',n:'DSPC-P',c:'N.468152.023',m:'Sanmina',q:2,p:'t0190'},
      {id:'t0204',n:'RCB',c:'N.468214.011',m:'Sanmina',q:2,p:'t0190'},
      {id:'t0205',n:'RESU-M',c:'N.468157.031',m:'Sanmina',q:2,p:'t0188'},
      {id:'t0206',n:'SubRack RESU-P',c:'N.301363.017',m:'Sanmina',q:2,p:'t0205'},
      {id:'t0207',n:'Cross RESU-P',c:'N.468363.007',m:'Sanmina',q:2,p:'t0206'},
      {id:'t0208',n:'Panel with components',c:'N.301412.031',m:'Sanmina',q:2,p:'t0205'},
      {id:'t0209',n:'Component board',c:'N.469535.048',m:'Sanmina',q:2,p:'t0208'},
      {id:'t0210',n:'Toggle switch SS-21',c:'',m:'Switronic',q:2,p:'t0208'},
      {id:'t0211',n:'MR-M',c:'N.464412.004',m:'Sanmina',q:2,p:'t0205'},
      {id:'t0212',n:'DDC-P V2',c:'N.467747.004',m:'Sanmina',q:2,p:'t0205'},
      {id:'t0213',n:'SF-P',c:'N.468129.004',m:'Sanmina',q:2,p:'t0205'},
      {id:'t0214',n:'AXIOM 40MHz',c:'AXIOM45-12-10-1B_Rev.8',m:'Axtal',q:2,p:'t0213'},
      {id:'t0215',n:'PSU V2',c:'N.436434.006',m:'Sanmina',q:2,p:'t0205'},
      {id:'t0216',n:'DSPC-P',c:'N.468152.023',m:'Sanmina',q:2,p:'t0205'},
      {id:'t0217',n:'RCB',c:'N.468214.011',m:'Sanmina',q:2,p:'t0205'},
      {id:'t0218',n:'PSR ComU',c:'N.468363.016',m:'Sanmina',q:1,p:'t0188'},
      {id:'t0219',n:'Meteo ComU',c:'N.468363.009',m:'Sanmina',q:1,p:'t0188'},
      {id:'t0220',n:'PC ConU',c:'N.468364.022',m:'Sanmina',q:1,p:'t0188'},
      {id:'t0221',n:'Cross ConU',c:'N.468363.015',m:'Sanmina',q:1,p:'t0220'},
      {id:'t0222',n:'PC CB',c:'N.468213.011',m:'Sanmina',q:1,p:'t0220'},
      {id:'t0223',n:'Power supply',c:'CP10.241-R2-C1',m:'Puls',q:4,p:'t0188'},
      {id:'t0224',n:'Power supply',c:'DNR60 US 12',m:'XP Power',q:2,p:'t0188'},
      {id:'t0225',n:'LLP Switch',c:'N.468364.026',m:'Sanmina',q:2,p:'t0188'},
      {id:'t0226',n:'Power divider 2 ways',c:'PS2-10-450/3N',m:'Pulsar',q:6,p:'t0188'},
      {id:'t0227',n:'Attenuator low power',c:'ZVA2N-4-30A',m:'RFLambda',q:5,p:'t0188'},
      {id:'t0228',n:'Switch block',c:'N.468364.011',m:'Sanmina',q:1,p:'t0188'},
      {id:'t0229',n:'Attenuator 30 dB',c:'R417330130',m:'Radiall',q:1,p:'t0188'},
      {id:'t0230',n:'Attenuator 30 dB 1W',c:'UNAT-30A+',m:'Mini-Circuits',q:1,p:'t0188'},
      {id:'t0231',n:'Set of cables',c:'N.468959.020',m:'Orbis',q:1,p:'t0188'},
      {id:'t0232',n:'Coaxial cable',c:'N.685661.037',m:'Easat FIN',q:7,p:'t0231'},
      {id:'t0233',n:'Coaxial Cable Connector',c:'R125153000',m:'Easat FIN',q:14,p:'t0232'},
      {id:'t0234',n:'NPort',c:'NPort 6650-32-48V',m:'MOXA',q:2,p:'t0188'},
      {id:'t0235',n:'Coaxial circulator',c:'JCC2700T2900NFNFNM10',m:'JQL',q:1,p:'t0188'},
      {id:'t0236',n:'Coaxial isolator',c:'JIC2700T2900NFNM1',m:'JQL',q:1,p:'t0188'},
      {id:'t0237',n:'Coaxial isolator',c:'JIC2700T2900NMNF1',m:'JQL',q:1,p:'t0188'},
      {id:'t0238',n:'Wire harness for RSCC',c:'',m:'Easat FIN',q:1,p:'t0188'},
      {id:'t0240',n:'Lid',c:'N.741124.181',m:'Rittal',q:1,p:'t0239'},
      {id:'t0241',n:'Pressurizer',c:'LAB4',m:'Easat UK',q:1,p:'t0239'},
      {id:'t0243',n:'Section',c:'N.301363.011',m:'Sanmina',q:1,p:'t0242'},
      {id:'t0244',n:'Backplane',c:'N.468363.014',m:'Sanmina',q:2,p:'t0243'},
      {id:'t0245',n:'Cross RESU-AL',c:'N.468363.013',m:'Sanmina',q:2,p:'t0244'},
      {id:'t0246',n:'MR-AL',c:'N.464334.009',m:'Sanmina',q:2,p:'t0242'},
      {id:'t0247',n:'PR-AR',c:'N.466219.010',m:'Sanmina',q:2,p:'t0242'},
      {id:'t0248',n:'DDC-AR',c:'N.467747.005-01',m:'Sanmina',q:2,p:'t0242'},
      {id:'t0249',n:'ADS-B OMNI antenna',c:'CC1090/8-P',m:'VINNANT',q:2,p:'t0242'},
      {id:'t0250',n:'Ribbon Cable',c:'N.685611.023',m:'',q:1,p:'t0242'},
      {id:'t0252',n:'Power supply',c:'PIC480.241D',m:'Puls',q:2,p:'t0251'},
      {id:'t0253',n:'ioThinx I/O',c:'IOTHINX 4510',m:'MOXA',q:2,p:'t0251'},
      {id:'t0254',n:'DI Module 16ch',c:'45MR-1600',m:'MOXA',q:6,p:'t0251'},
      {id:'t0255',n:'AI Module 8ch',c:'45MR-3810',m:'MOXA',q:1,p:'t0251'},
      {id:'t0256',n:'Muller Counter',c:'BG7018-1248',m:'Muller',q:1,p:'t0251'},
      {id:'t0257',n:'Cables MCB materials',c:'N.436114.011BOM',m:'Easat FIN',q:1,p:'t0251'},
      {id:'t0259',n:'Desktop PC Mouse Keyboard',c:'Lenovo desktop',m:'Lenovo',q:2,p:'t0258'},
      {id:'t0260',n:'Display',c:'E27Q-40',m:'Lenovo',q:2,p:'t0258'},
      {id:'t0261',n:'Desktop PC Mouse Keyboard',c:'Lenovo desktop',m:'Lenovo',q:1,p:'t0258'},
      {id:'t0262',n:'Display 29in',c:'29WQ600',m:'LG',q:1,p:'t0258'},
      {id:'t0264',n:'Cabinet wall',c:'RBA-18-AS5-CAX-A1',m:'Triton',q:1,p:'t0263'},
      {id:'t0265',n:'Distribution panel 1U',c:'RAB-PD-X04-A1',m:'Triton',q:1,p:'t0263'},
      {id:'t0266',n:'Blanking panel 4U',c:'RAB-ZP-X05-A1',m:'Triton',q:1,p:'t0263'},
      {id:'t0267',n:'Blanking panel 1U',c:'RAB-ZP-X01-A1',m:'Triton',q:2,p:'t0263'},
      {id:'t0268',n:'Cable mgmt panel 1U',c:'RAB-VP-X13-A1',m:'Triton',q:2,p:'t0263'},
      {id:'t0269',n:'Cabinet shelf',c:'RAC-UP-450-A1',m:'Triton',q:2,p:'t0263'},
      {id:'t0271',n:'Cabinet',c:'VX 8886.000',m:'Rittal',q:1,p:'t0270'},
      {id:'t0272',n:'Cabinet parts',c:'Various',m:'Rittal',q:1,p:'t0270'},
      {id:'t0273',n:'Side panels',c:'side panels',m:'Rittal',q:2,p:'t0270'},
      {id:'t0274',n:'Network equipment',c:'',m:'',q:1,p:'t0270'},
      {id:'t0275',n:'ODF frame',c:'200-483 Excel',m:'',q:1,p:'t0274'},
      {id:'t0276',n:'Media converter',c:'IMC-21GA-LX-SC',m:'MOXA',q:2,p:'t0274'},
      {id:'t0277',n:'Switch Cisco',c:'C9200-48T-4X-A',m:'Cisco',q:2,p:'t0274'},
      {id:'t0278',n:'SFP module',c:'SFP',m:'Cisco',q:4,p:'t0277'},
      {id:'t0279',n:'Patch panel',c:'100-726 Excel',m:'',q:1,p:'t0274'},
      {id:'t0280',n:'NTP Server',c:'T550-00',m:'TimeTools',q:1,p:'t0274'},
      {id:'t0281',n:'Surge Suppressor GPS',c:'SPP-GPS',m:'TimeTools',q:1,p:'t0280'},
      {id:'t0282',n:'Power supply unit',c:'CP10.241-R2-C1',m:'Puls',q:2,p:'t0274'},
      {id:'t0283',n:'Cable Mgmt Bar',c:'HSFP-1U',m:'',q:2,p:'t0274'},
      {id:'t0284',n:'Cable Mgmt Bar',c:'100-582 Excel',m:'',q:2,p:'t0274'},
      {id:'t0285',n:'ATM equipment TERN',c:'',m:'',q:1,p:'t0270'},
      {id:'t0286',n:'KVM display 19in',c:'Atem Console',m:'TERN',q:1,p:'t0285'},
      {id:'t0287',n:'MFP Server',c:'Dell R660',m:'TERN',q:2,p:'t0285'},
      {id:'t0289',n:'Silver film',c:'CF3350-002',m:'Elektronika',q:168,p:'t0288'},
      {id:'t0290',n:'Indium foil 50um',c:'',m:'Shanghai Metal',q:1,p:'t0288'},
      {id:'t0291',n:'Termination',c:'KARN-50+',m:'Mini-Circuits',q:1,p:'t0288'},
      {id:'t0293',n:'SC-SC 1m SM',c:'200-261',m:'Easat UK',q:14,p:'t0292'},
      {id:'t0294',n:'Pigtail SC 2m',c:'200-554',m:'Easat UK',q:48,p:'t0292'},
      {id:'t0295',n:'Cable Tester',c:'3293-120',m:'Easat UK',q:1,p:'t0292'},
      {id:'t0296',n:'Patch 0.5m Blue',c:'RJ-600B',m:'Easat UK',q:30,p:'t0292'},
      {id:'t0297',n:'Patch 0.5m Red',c:'RJ-600R',m:'Easat UK',q:30,p:'t0292'},
      {id:'t0298',n:'Patch 0.5m Black',c:'RJ-600K',m:'Easat UK',q:10,p:'t0292'},
      {id:'t0299',n:'Patch 1m Blue',c:'RJ-601B',m:'Easat UK',q:30,p:'t0292'},
      {id:'t0300',n:'Patch 1m Red',c:'RJ-601R',m:'Easat UK',q:30,p:'t0292'},
      {id:'t0301',n:'Patch 1.5m Blue',c:'RJ-601.5B',m:'Easat UK',q:30,p:'t0292'},
      {id:'t0302',n:'Patch 1.5m Red',c:'RJ-601.5R',m:'Easat UK',q:30,p:'t0292'},
      {id:'t0303',n:'Cable 305m Box',c:'100-065',m:'Easat UK',q:1,p:'t0292'},
      {id:'t0305',n:'PTC wooden box',c:'',m:'',q:1,p:'t0304'},
      {id:'t0306',n:'MSSR wooden box',c:'',m:'',q:1,p:'t0304'},
      {id:'t0307',n:'RSCC wooden box',c:'',m:'',q:1,p:'t0304'},
      {id:'t0308',n:'RESU boxes set',c:'',m:'',q:4,p:'t0304'},
      {id:'t0309',n:'PA-1600 box',c:'',m:'Vindea',q:16,p:'t0304'}
    ]
  };
  
  const templateId = 't_mssr_' + Date.now().toString(36);
  
  const asmObj = {};
  MSSR.assemblies.forEach(a => {
    asmObj[a.id] = { id: a.id, name: a.name, isAsm: true, priority: a.priority };
  });
  
  const partsObj = {};
  MSSR.parts.forEach(p => {
    partsObj[p.id] = { id: p.id, name: p.n, code: p.c, mfr: p.m, qty: p.q, parentId: p.p, notes: '' };
  });
  
  await db.ref('templates/' + templateId).set({
    meta: {
      name: 'MSSR Production BOM',
      description: 'Full MSSR radar system - 17 assemblies, 291 parts with 4-level hierarchy',
      asmCount: MSSR.assemblies.length,
      partCount: MSSR.parts.length,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      sourceProject: 'excel_import'
    },
    assemblies: asmObj,
    parts: partsObj
  });
}

// NAV Import functionality
let navImportData=[];
$('navImportBtn').onclick=()=>{
  navImportData=[];
  $('navFileInput').value='';
  $('navFileName').textContent='';
  $('navPreview').style.display='none';
  $('navImportApply').disabled=true;
  $('navImportModal').classList.add('open');
};
$('navImportClose').onclick=$('navImportCancel').onclick=()=>$('navImportModal').classList.remove('open');
$('navFileBtn').onclick=()=>$('navFileInput').click();
$('navFileInput').onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  $('navFileName').textContent=file.name;
  const reader=new FileReader();
  reader.onload=ev=>{
    parseNavCSV(ev.target.result);
  };
  reader.readAsText(file);
};

function parseNavCSV(csvText){
  const lines=csvText.trim().split('\n');
  if(lines.length<2){return}
  
  // Parse header to find columns - flexible matching
  const header=lines[0].split(/[,;\t]/).map(h=>h.trim().toLowerCase().replace(/['"]/g,''));
  const colMap={};
  header.forEach((h,i)=>{
    if(h.includes('item')&&h.includes('no')||h==='itemno'||h==='item_no'||h==='item number')colMap.itemNo=i;
    else if(h.includes('description')||h==='desc')colMap.desc=i;
    else if(h.includes('po')&&h.includes('no')||h==='pono'||h==='po_no'||h==='po number'||h==='document no')colMap.po=i;
    else if(h.includes('quantity')||h==='qty')colMap.qty=i;
    else if(h.includes('expected')&&h.includes('date')||h.includes('eta')||h.includes('arrival')||h.includes('receipt date'))colMap.eta=i;
    else if(h.includes('status')||h.includes('received')||h.includes('qty received')||h.includes('quantity received'))colMap.status=i;
    else if(h.includes('vendor')||h.includes('supplier'))colMap.vendor=i;
  });
  
  // Fallback: if no specific PO column, check for 'no' or 'document'
  if(colMap.po===undefined){
    header.forEach((h,i)=>{
      if((h.includes('document')||h==='no')&&colMap.po===undefined)colMap.po=i;
    });
  }
  
  navImportData=[];
  const delimiter=lines[0].includes('\t')?'\t':lines[0].includes(';')?';':',';
  
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(delimiter).map(c=>c.trim().replace(/^["']|["']$/g,''));
    if(cols.length<2)continue;
    
    const itemNo=colMap.itemNo!==undefined?cols[colMap.itemNo]:'';
    const desc=colMap.desc!==undefined?cols[colMap.desc]:'';
    const po=colMap.po!==undefined?cols[colMap.po]:'';
    const qty=colMap.qty!==undefined?parseInt(cols[colMap.qty])||1:1;
    const eta=colMap.eta!==undefined?cols[colMap.eta]:'';
    const statusRaw=colMap.status!==undefined?cols[colMap.status]:'';
    const vendor=colMap.vendor!==undefined?cols[colMap.vendor]:'';
    
    // Determine if item is received (check qty received or status text)
    let isReceived=false;
    if(statusRaw){
      const sl=statusRaw.toLowerCase();
      if(sl==='received'||sl==='yes'||sl==='true'||sl==='arrived')isReceived=true;
      // If it's a number (qty received), check if >0
      const qtyRec=parseInt(statusRaw);
      if(!isNaN(qtyRec)&&qtyRec>0)isReceived=true;
    }
    
    // Try to match with existing parts by item code or description
    let matchedPart=null;
    if(itemNo){
      matchedPart=data.find(p=>!p.isAsm&&p.code&&p.code.toLowerCase()===itemNo.toLowerCase());
    }
    if(!matchedPart&&desc){
      // Try exact match first, then partial
      matchedPart=data.find(p=>!p.isAsm&&p.name&&p.name.toLowerCase()===desc.toLowerCase());
      if(!matchedPart){
        matchedPart=data.find(p=>!p.isAsm&&p.name&&(p.name.toLowerCase().includes(desc.toLowerCase())||desc.toLowerCase().includes(p.name.toLowerCase())));
      }
    }
    
    navImportData.push({
      itemNo,desc,po,qty,eta,isReceived,vendor,
      matchedPartId:matchedPart?matchedPart.id:null,
      matchedPartName:matchedPart?matchedPart.name:null
    });
  }
  
  renderNavPreview();
}

function renderNavPreview(){
  const list=$('navPreviewList');
  const matched=navImportData.filter(d=>d.matchedPartId);
  const unmatched=navImportData.filter(d=>!d.matchedPartId);
  
  $('navMatchCount').textContent=matched.length+' of '+navImportData.length+' items matched to parts';
  
  let html='';
  // Show matched first
  matched.forEach(d=>{
    const etaDisplay=d.eta?new Date(d.eta).toLocaleDateString():'â€”';
    const statusClass=d.isReceived?'will-receive':'will-update';
    const statusText=d.isReceived?'Will receive':'Will update PO';
    html+='<div class="nav-preview-item"><div class="nav-preview-name">'+esc(d.matchedPartName)+'<span class="match">âœ“ matched</span></div>';
    if(d.po)html+='<div class="nav-preview-po">'+esc(d.po)+'</div>';
    if(d.eta)html+='<div class="nav-preview-eta">ETA: '+etaDisplay+'</div>';
    html+='<div class="nav-preview-status '+statusClass+'">'+statusText+'</div></div>';
  });
  
  // Show a few unmatched
  if(unmatched.length>0){
    const showUnmatched=unmatched.slice(0,5);
    showUnmatched.forEach(d=>{
      html+='<div class="nav-preview-item no-match"><div class="nav-preview-name">'+esc(d.desc||d.itemNo||'Unknown')+'<span class="no-match">no match</span></div>';
      if(d.po)html+='<div class="nav-preview-po">'+esc(d.po)+'</div>';
      html+='<div class="nav-preview-status">Skipped</div></div>';
    });
    if(unmatched.length>5){
      html+='<div class="nav-preview-item no-match" style="justify-content:center;color:var(--text3);font-size:11px">+'+(unmatched.length-5)+' more unmatched items</div>';
    }
  }
  
  if(html==='')html='<div style="padding:16px;text-align:center;color:var(--text3)">No data found in CSV</div>';
  
  list.innerHTML=html;
  $('navPreview').style.display='block';
  $('navImportApply').disabled=matched.length===0;
}

$('navImportApply').onclick=()=>{
  const autoReceive=$('navAutoReceive').checked;
  let updated=0,received=0;
  
  navImportData.filter(d=>d.matchedPartId).forEach(d=>{
    const part=data.find(p=>String(p.id)===String(d.matchedPartId));
    if(!part)return;
    
    const changedFields=[];
    
    // Update PO number
    if(d.po&&d.po!==part.poNumber){
      part.poNumber=d.po;
      changedFields.push('poNumber');
      updated++;
    }
    
    // Update vendor/supplier
    if(d.vendor&&!part.supplier){
      part.supplier=d.vendor;
      changedFields.push('supplier');
    }
    
    // Update expected arrival date
    if(d.eta){
      const etaDate=new Date(d.eta);
      if(!isNaN(etaDate.getTime())){
        part.expectedArrival=etaDate.toISOString().split('T')[0];
        changedFields.push('expectedArrival');
      }
    }
    
    // Auto-receive if enabled and item is marked as received
    if(autoReceive&&d.isReceived&&part.status==='ordered'){
      part.status='arrived';
      part.arrivedAt=Date.now();
      part.changedAt=Date.now();
      changedFields.push('status');
      logActivity('status',part.name+' â†’ Arrived',{partId:part.id,partName:part.name,oldValue:'ordered',newValue:'arrived'});
      received++;
    }

    // If part was to-order and now has PO, mark as ordered
    if(d.po&&part.status==='to-order'){
      part.status='ordered';
      part.orderedAt=Date.now();
      part.changedAt=Date.now();
      changedFields.push('status');
      logActivity('status',part.name+' â†’ Ordered',{partId:part.id,partName:part.name,oldValue:'to-order',newValue:'ordered'});
    }
    
    if(changedFields.length){
      changedFields.forEach(f=>updateFieldTimestamp(part,f));
      markPartChanged(part.id,changedFields);
    }
  });
  
  save();render();
  $('navImportModal').classList.remove('open');
  
  let msg='Import complete: '+updated+' parts updated';
  if(received>0)msg+=', '+received+' received';
  
};

$('expandToggle').onclick=()=>{
  const asms=getAsms();
  if(allExpanded){expanded={};allExpanded=false}
  else{asms.forEach(a=>expanded[String(a.id)]=true);allExpanded=true}
  save();render();
};

$('clearBtn').onclick=()=>{if(confirm('Delete ALL data? This cannot be undone.')){
  // Actually delete everything from Firebase (not tombstones)
  if(projectRef) {
    projectRef.set(null).then(() => {
      console.log('Firebase data deleted');
      data=[];team=[];expanded={};history=[];projectDates={start:'',end:''};milestones=[];currentProjectName='New Project';
      localStorage.removeItem(LOCAL_STORAGE_KEY);
      
      setTimeout(() => location.reload(), 500);
    }).catch(err => {
      console.error('Failed to clear Firebase:', err);
      
    });
  } else {
    data=[];team=[];expanded={};history=[];projectDates={start:'',end:''};milestones=[];currentProjectName='New Project';
    localStorage.removeItem(LOCAL_STORAGE_KEY);
    
    render();
  }
}};
$('signOutBtn').onclick=()=>{if(confirm('Sign out?'))logout()};

// Header search (debounced)
let searchDebounceTimeout=null;
$('headerSearch').oninput=e=>{
  searchQ=e.target.value;
  $('headerSearchClear').classList.toggle('visible',searchQ.length>0);
  clearTimeout(searchDebounceTimeout);
  searchDebounceTimeout=setTimeout(()=>render(),150);
};
$('headerSearchClear').onclick=()=>{
  $('headerSearch').value='';
  searchQ='';
  $('headerSearchClear').classList.remove('visible');
  render();
};

$('assigneeFilter').onchange=e=>{filterAssignee=e.target.value;render()};

document.querySelectorAll('.pipe').forEach(p=>p.onclick=()=>{filterStage=filterStage===p.dataset.s?'':p.dataset.s;document.querySelector('[data-tab="list"]').click();render()});

// Sidebar collapse/expand
let sidebarCollapsed = false;
let userCollapsedSidebar = false; // Track if user manually collapsed
const sidebar = $('sidebar');

function toggleSidebar(collapse) {
  if (collapse === undefined) collapse = !sidebarCollapsed;
  sidebarCollapsed = collapse;
  if (collapse) {
    sidebar.classList.add('collapsed');
  } else {
    sidebar.classList.remove('collapsed');
  }
}

$('sidebarToggle').onclick = () => {
  userCollapsedSidebar = !sidebarCollapsed; // If expanding, user didn't collapse; if collapsing, user collapsed
  toggleSidebar();
};

document.querySelectorAll('.tab').forEach(tab=>tab.onclick=()=>{
  closeAIWorkspace();
  const wasGantt = document.querySelector('.tab.active')?.dataset.tab === 'gantt';
  const goingToGantt = tab.dataset.tab === 'gantt';

  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $(tab.dataset.tab+'Panel').classList.add('active');

  // Auto-collapse sidebar when going to Timeline
  if (goingToGantt && !sidebarCollapsed) {
    toggleSidebar(true);
  }
  // Auto-expand sidebar when leaving Timeline (unless user had collapsed it)
  if (wasGantt && !goingToGantt && sidebarCollapsed && !userCollapsedSidebar) {
    toggleSidebar(false);
  }

  if(tab.dataset.tab==='gantt'){
    window._ganttScrolled=false;
    setTimeout(()=>{
      renderGantt();
      // Force scroll after render
      setTimeout(()=>{
        const todayLine=document.querySelector('.gantt-today-line');
        const container=$('ganttBodyWrap');
        if(todayLine&&container){
          const pos=parseInt(todayLine.style.left)||0;
          container.scrollLeft=Math.max(0,pos-container.clientWidth/2+210);
          $('ganttTimelineHeaderWrap').scrollLeft=container.scrollLeft;
        }
        // Refresh dependency arrows after scroll
        if(_ganttRenderState){
          renderDependencyArrows(_ganttRenderState.rows, _ganttRenderState.cellWidth, _ganttRenderState.weeks);
        }
      },50);
    },10);
  }
});

document.onkeydown=e=>{if(e.key==='Escape'){closeAIWorkspace();['teamModal','datesModal','leadtimeModal','bomModal','otdModal','itemConfigModal','newProjectModal','manageProjectsModal','renameProjectModal','deleteProjectModal'].forEach(closeModal);$('themeModal').classList.remove('open');$('receivePOModal').classList.remove('open');$('reportModal').classList.remove('open');$('portfolioReportModal').classList.remove('open');$('metricsPopover').classList.remove('open');$('insightsPanel').classList.remove('open');$('masterInsightsPanel').classList.remove('open');$('poModal').classList.remove('open');$('menuDrop').classList.remove('open');$('ganttColorPopup').classList.remove('open');$('ganttDatePopup').classList.remove('open');$('etaPopover').classList.remove('open');hidePopoverModal($('partModal'));hidePopoverModal($('asmModal'));closeCmdWindow();closeDeletePopover();$('commentsPopover').classList.remove('open');$('popoverBackdrop').classList.remove('active');closeProjectDropdown();currentCommentPartId=null;editId=editAsmId=editActId=editEtaPartId=pendingAdvPartId=null}};

// Comments on parts
let currentCommentPartId=null;

window.openComments=window.openNotesChat=function(partId,e){
  currentCommentPartId=partId;
  const part=data.find(d=>String(d.id)===String(partId));
  $('commentsTitle').textContent=part?part.name.substring(0,25):'Notes';
  
  // Position near clicked element
  const popover=$('commentsPopover');
  const target=e?e.target.closest('.notes-chat-cell')||e.target.closest('button')||e.target:null;
  if(target){
    const rect=target.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left;
    if(left+320>window.innerWidth)left=window.innerWidth-330;
    if(top+400>window.innerHeight)top=rect.top-400-8;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
  }
  
  loadComments(partId);
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>$('commentInput').focus(),100);
};

function loadComments(partId){
  const part=data.find(d=>String(d.id)===String(partId));
  const comments=part?.comments||[];
  if(comments.length===0){
    $('commentsList').innerHTML='<div class="comments-empty">No notes yet.<br>Add the first one below.</div>';
  }else{
    $('commentsList').innerHTML=comments.map(c=>{
      const time=new Date(c.ts||c.timestamp).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      return '<div class="comment-item"><div class="comment-author">'+esc(c.author)+'</div><div class="comment-text">'+esc(c.text)+'</div><div class="comment-time">'+time+'</div></div>';
    }).join('');
  }
}

$('commentsClose').onclick=()=>{
  $('commentsPopover').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  currentCommentPartId=null;
};

// Close comments - handled by backdrop

$('commentAdd').onclick=()=>{
  const input=$('commentInput');
  const text=input.value.trim();
  if(!text||!currentCommentPartId)return;
  
  const part=data.find(d=>String(d.id)===String(currentCommentPartId));
  if(!part)return;
  
  // Get or prompt for username
  let author=localStorage.getItem('ebs-username');
  if(!author){
    author=prompt('Enter your name for comments:','');
    if(author)localStorage.setItem('ebs-username',author);
  }
  if(!author)author='Anonymous';
  
  if(!part.comments)part.comments=[];
  part.comments.push({
    author:author,
    text:text,
    ts:Date.now()
  });
  
  // Track the comment change
  updateFieldTimestamp(part,'comments');
  markPartChanged(currentCommentPartId,['comments']);
  
  // Log comment event
  logComment(part,text);
  
  save();
  loadComments(currentCommentPartId);
  input.value='';
  render(); // Update comment count
};

$('commentInput').onkeydown=e=>{if(e.key==='Enter')$('commentAdd').click()};

// ============================================
// BULK OPERATIONS
// ============================================
function updateBulkBar(){
  const bar=$('bulkBar');
  const count=selectedParts.size;
  $('bulkCount').textContent=count;
  
  if(count>0){
    bar.classList.add('active');
  }else{
    bar.classList.remove('active');
  }
}

function clearSelection(){
  selectedParts.clear();
  lastSelectedPartId=null;
  updateBulkBar();
  render();
}

window.togglePartSelection=function(partId,e){
  e.stopPropagation();
  const parts=getParts().filter(matchPart);
  
  // Ensure partId is string for consistent comparison
  partId = String(partId);
  
  // Shift+click for range selection
  if(e.shiftKey&&lastSelectedPartId!==null){
    const ids=parts.map(p=>String(p.id));
    const startIdx=ids.indexOf(String(lastSelectedPartId));
    const endIdx=ids.indexOf(partId);
    if(startIdx>=0&&endIdx>=0){
      const [from,to]=[Math.min(startIdx,endIdx),Math.max(startIdx,endIdx)];
      for(let i=from;i<=to;i++){
        selectedParts.add(ids[i]);
      }
    }
  }else{
    if(selectedParts.has(partId)){
      selectedParts.delete(partId);
    }else{
      selectedParts.add(partId);
    }
    lastSelectedPartId=partId;
  }
  updateBulkBar();
  render();
};

window.toggleSelectAll=function(e){
  const parts=getParts().filter(matchPart);
  if(selectedParts.size===parts.length){
    selectedParts.clear();
  }else{
    parts.forEach(p=>selectedParts.add(String(p.id)));
  }
  updateBulkBar();
  render();
};

// Click on empty space in parts table to deselect
$('partsList').addEventListener('click',function(e){
  // If click is directly on the table body (not on a part row or its children)
  if(e.target===this||e.target.classList.contains('add-row')||e.target.classList.contains('add-row-text')){
    if(selectedParts.size>0){
      clearSelection();
    }
  }
});

// Click on table container background to deselect
$('partsTable').addEventListener('click',function(e){
  if(e.target===this){
    if(selectedParts.size>0){
      clearSelection();
    }
  }
});

// Handle clicks on row background/padding to deselect
window.handleRowClick=function(e){
  if(!selectedParts.size)return;
  // Check if click is on the row itself (padding area) or on an empty child div
  const row=e.currentTarget;
  // If clicked directly on the row (padding area)
  if(e.target===row){
    clearSelection();
    return;
  }
  // If clicked on an empty div that's a direct child of the row
  if(e.target.parentElement===row&&e.target.tagName==='DIV'){
    // Check if this div has no interactive content
    const hasContent=e.target.textContent.trim()||e.target.querySelector('input,button,span.status-badge,span.eta-po,span.eta-date,.cell,.stage-dot,.comment-btn,.adv-btn,.sm-btn');
    if(!hasContent){
      clearSelection();
      return;
    }
  }
};

// Click on partsList background (between rows) to deselect
$('partsList').addEventListener('click',function(e){
  if(!selectedParts.size)return;
  if(e.target===this){
    clearSelection();
  }
});

function positionBulkPopover(popover,btn){
  const rect=btn.getBoundingClientRect();
  let top=rect.bottom+8;
  let left=rect.left;
  if(left+320>window.innerWidth)left=window.innerWidth-330;
  if(top+300>window.innerHeight)top=rect.top-310;
  popover.style.top=Math.max(10,top)+'px';
  popover.style.left=Math.max(10,left)+'px';
}

function renderBulkPreview(containerId){
  const container=$(containerId);
  const parts=Array.from(selectedParts).map(id=>data.find(d=>String(d.id)===String(id))).filter(Boolean);
  if(parts.length<=5){
    container.innerHTML=parts.map(p=>'<div style="padding:4px 0;font-size:11px;border-bottom:1px solid var(--bg4)">'+esc(p.name)+'</div>').join('');
  }else{
    container.innerHTML=parts.slice(0,3).map(p=>'<div style="padding:4px 0;font-size:11px;border-bottom:1px solid var(--bg4)">'+esc(p.name)+'</div>').join('')+'<div style="padding:4px 0;font-size:11px;color:var(--text3)">...and '+(parts.length-3)+' more</div>';
  }
}

function closeBulkPopovers(){
  ['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
}

window.openBulkStatusModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkStatusPreview');
  $('bulkStatusSelect').value='';
  $('bulkStatusPO').value='';
  $('bulkStatusETA').value='';
  $('bulkPOFields').style.display='none';
  positionBulkPopover($('bulkStatusModal'),e.target);
  $('bulkStatusModal').classList.add('open');
};

window.openBulkAssignModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkAssignPreview');
  $('bulkAssignSelect').innerHTML='<option value="">Select assignee...</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');
  positionBulkPopover($('bulkAssignModal'),e.target);
  $('bulkAssignModal').classList.add('open');
};

window.openBulkPOModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkPOPreview');
  $('bulkPOInput').value='';
  positionBulkPopover($('bulkPOModal'),e.target);
  $('bulkPOModal').classList.add('open');
  setTimeout(()=>$('bulkPOInput').focus(),100);
};

window.openBulkDeleteModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkDeletePreview');
  positionBulkPopover($('bulkDeleteModal'),e.target);
  $('bulkDeleteModal').classList.add('open');
};

window.applyBulkStatus=function(){
  const status=$('bulkStatusSelect').value;
  if(!status)return;
  const now=Date.now();
  const po=$('bulkStatusPO').value.trim();
  const eta=$('bulkStatusETA').value;
  const count=selectedParts.size;
  
  selectedParts.forEach(id=>{
    const p=data.find(d=>String(d.id)===String(id));
    if(p){
      const oldStatus=p.status;
      const changedFields=['status'];
      if(p.status==='ordered'&&status==='arrived'&&p.orderedAt&&p.code){
        const days=Math.round((now-p.orderedAt)/86400000);
        if(days>0)recordLeadTime(p.code,days);
        p.arrivedAt=now;
      }
      if(status==='ordered'&&p.status!=='ordered'){
        p.orderedAt=now;
        if(po){p.poNumber=po;changedFields.push('poNumber');}
        if(eta){p.expectedArrival=eta;changedFields.push('expectedArrival');}
      }
      p.status=status;
      p.changedAt=now;
      changedFields.forEach(f=>updateFieldTimestamp(p,f));
      markPartChanged(id,changedFields);
      logActivity('status', p.name + ' â†’ ' + status.charAt(0).toUpperCase() + status.slice(1), { partId: p.id, partName: p.name, oldValue: oldStatus, newValue: status });
    }
  });
  save();
  $('bulkStatusModal').classList.remove('open');
  clearSelection();
  render();
  
};

// Show/hide PO fields based on status selection
$('bulkStatusSelect').onchange=function(){
  const showPO=this.value==='ordered';
  $('bulkPOFields').style.display=showPO?'block':'none';
};

window.applyBulkAssign=function(){
  const assignee=$('bulkAssignSelect').value;
  if(!assignee)return;
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    const p=data.find(d=>String(d.id)===String(id));
    if(p){
      p.assignee=assignee;
      updateFieldTimestamp(p,'assignee');
      markPartChanged(id,['assignee']);
    }
  });
  save();
  $('bulkAssignModal').classList.remove('open');
  clearSelection();
  render();
  
};

window.applyBulkPO=function(){
  const po=$('bulkPOInput').value.trim();
  if(!po)return;
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    const p=data.find(d=>String(d.id)===String(id));
    if(p){
      p.poNumber=po;
      updateFieldTimestamp(p,'poNumber');
      markPartChanged(id,['poNumber']);
    }
  });
  save();
  $('bulkPOModal').classList.remove('open');
  clearSelection();
  render();
  
};

window.applyBulkDelete=function(){
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    const item=data.find(d=>String(d.id)===String(id));
    if(item){
      const type=item.isAsm?'assembly':'part_delete';
      logActivity(type, 'Deleted '+(item.isAsm?'assembly':'part')+' "'+item.name+'"', { partId: item.id, partName: item.name });
      if(item.isAsm){
        markDeleted('asm',id);
        // Also mark child parts for deletion
        data.filter(d=>String(d.parentId)===String(id)).forEach(child=>{
          markDeleted('part',child.id);
        });
      }else{
        markDeleted('part',id);
        // Also mark sub-parts for deletion
        data.filter(d=>String(d.parentId)===String(id)).forEach(child=>{
          markDeleted('part',child.id);
        });
      }
    }
    data=data.filter(d=>String(d.id)!==String(id)&&String(d.parentId)!==String(id));
  });
  save();
  $('bulkDeleteModal').classList.remove('open');
  clearSelection();
  render();
  
};

// Close bulk popovers
['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
  $(id).querySelector('.modal-close').onclick=()=>$(id).classList.remove('open');
});

document.addEventListener('click',e=>{
  ['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
    const modal=$(id);
    if(modal.classList.contains('open')&&!modal.contains(e.target)&&!e.target.closest('.bulk-bar')){
      modal.classList.remove('open');
    }
  });
});

// ============================================
// Label Printing System
// ============================================
let labelPartIds = [];

window.openLabelModal = function(partId, e) {
  if (e) e.stopPropagation();
  
  // Check if we have selected parts - use those, otherwise use single part
  if (selectedParts.size > 0) {
    labelPartIds = Array.from(selectedParts);
  } else {
    labelPartIds = [partId];
  }
  
  updateLabelPreview();
  
  // Center the modal on screen (it's too big for standard popover positioning)
  const modal = $('labelModal');
  closeAllPopovers();
  $('popoverBackdrop').classList.add('active');
  modal.style.top = '50%';
  modal.style.left = '50%';
  modal.style.transform = 'translate(-50%, -50%)';
  modal.classList.add('open');
};

window.openBulkLabelModal = function(e) {
  if (selectedParts.size === 0) {
    
    return;
  }
  labelPartIds = Array.from(selectedParts);
  updateLabelPreview();
  
  // Center the modal on screen
  const modal = $('labelModal');
  closeAllPopovers();
  $('popoverBackdrop').classList.add('active');
  modal.style.top = '50%';
  modal.style.left = '50%';
  modal.style.transform = 'translate(-50%, -50%)';
  modal.classList.add('open');
};

function updateLabelPreview() {
  const size = $('labelSize').value;
  const showAssembly = $('labelAssembly').checked;
  const showMfr = $('labelMfr').checked;
  
  // Get first part for preview
  const part = data.find(d => String(d.id) === String(labelPartIds[0]));
  if (!part) return;
  
  // Find assembly name
  const asm = data.find(d => d.isAsm && String(d.id) === String(part.parentId));
  const asmName = asm ? asm.name : '';
  
  // Get project name
  const projectName = currentProjectName || 'Project';
  
  // Update preview text
  $('labelPreviewName').textContent = part.name;
  $('labelPreviewCode').textContent = part.code || 'â€”';
  $('labelPreviewProject').textContent = 'Project: ' + projectName;
  
  let metaText = '';
  if (showAssembly && asmName) metaText += asmName;
  if (showMfr && part.mfr) metaText += (metaText ? ' Â· ' : '') + part.mfr;
  $('labelPreviewMeta').textContent = metaText || '';
  $('labelPreviewMeta').style.display = metaText ? 'block' : 'none';
  
  // Update preview size (29x90 is landscape: 90mm wide x 29mm tall)
  const preview = $('labelPreview');
  const sizes = {
    '29x90': { w: '270px', h: '85px' },
    '102x51': { w: '240px', h: '120px' },
    '62x100': { w: '150px', h: '240px' },
    '62x29': { w: '186px', h: '85px' }
  };
  const s = sizes[size] || sizes['29x90'];
  preview.style.width = s.w;
  preview.style.minHeight = s.h;
  preview.style.flexDirection = 'column';
  preview.style.textAlign = 'left';
  preview.style.justifyContent = 'center';
  
  // Update count info
  if (labelPartIds.length > 1) {
    $('labelCountInfo').textContent = 'Printing ' + labelPartIds.length + ' labels';
    $('labelCountInfo').style.display = 'block';
  } else {
    $('labelCountInfo').style.display = 'none';
  }
}

window.printLabels = function() {
  const size = $('labelSize').value;
  const showAssembly = $('labelAssembly').checked;
  const showMfr = $('labelMfr').checked;
  
  // Get project name
  const projectName = currentProjectName || 'Project';
  
  // Map size to actual dimensions (29x90 is landscape: 90mm wide x 29mm tall)
  const pageSizes = {
    '29x90': { css: '90mm 29mm', w: '90mm', h: '29mm' },
    '102x51': { css: '102mm 51mm', w: '102mm', h: '51mm' },
    '62x100': { css: '62mm 100mm', w: '62mm', h: '100mm' },
    '62x29': { css: '62mm 29mm', w: '62mm', h: '29mm' }
  };
  const ps = pageSizes[size] || pageSizes['29x90'];
  
  // Build labels HTML
  let labelsHtml = '';
  labelPartIds.forEach((partId, idx) => {
    const part = data.find(d => String(d.id) === String(partId));
    if (!part) return;
    
    const asm = data.find(d => d.isAsm && String(d.id) === String(part.parentId));
    const asmName = asm ? asm.name : '';
    
    let metaText = '';
    if (showAssembly && asmName) metaText += esc(asmName);
    if (showMfr && part.mfr) metaText += (metaText ? ' Â· ' : '') + esc(part.mfr);
    
    labelsHtml += '<div class="label">' +
      '<div class="label-inner">' +
      '<div class="label-name">' + esc(part.name) + '</div>' +
      '<div class="label-code">' + esc(part.code || 'â€”') + '</div>' +
      (metaText ? '<div class="label-meta">' + metaText + '</div>' : '') +
      '<div class="label-project">Project: ' + esc(projectName) + '</div>' +
      '</div></div>';
  });
  
  // Create print document (landscape layout, bigger fonts, no QR)
  const printDoc = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Label</title><style>' +
    '@page{size:' + ps.css + ';margin:0;}' +
    '*{margin:0;padding:0;box-sizing:border-box;}' +
    'body{font-family:Arial,sans-serif;}' +
    '.label{width:' + ps.w + ';height:' + ps.h + ';page-break-after:always;background:#fff;}' +
    '.label:last-child{page-break-after:auto;}' +
    '.label-inner{display:flex;flex-direction:column;justify-content:center;padding:2mm 3mm;height:100%;}' +
    '.label-name{font-size:12pt;font-weight:600;margin-bottom:1mm;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}' +
    '.label-code{font-size:14pt;font-weight:700;font-family:Consolas,monospace;margin-bottom:1mm;}' +
    '.label-meta{font-size:9pt;color:#333;margin-bottom:1mm;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}' +
    '.label-project{font-size:8pt;color:#666;}' +
    '</style></head><body>' + labelsHtml + '<script>window.print();<\/script></body></html>';
  
  // Open print window
  const printWin = window.open('', '_blank', 'width=400,height=200');
  if (printWin) {
    printWin.document.write(printDoc);
    printWin.document.close();
    
    // Close modal
    $('labelModal').classList.remove('open');
    $('labelModal').style.transform = '';
    $('popoverBackdrop').classList.remove('active');
    clearSelection();
  }
};

// Label modal event handlers
$('labelSize').onchange = updateLabelPreview;
$('labelAssembly').onchange = updateLabelPreview;
$('labelMfr').onchange = updateLabelPreview;
$('labelClose').onclick = () => { $('labelModal').classList.remove('open'); $('labelModal').style.transform=''; $('popoverBackdrop').classList.remove('active'); };
$('labelCancel').onclick = () => { $('labelModal').classList.remove('open'); $('labelModal').style.transform=''; $('popoverBackdrop').classList.remove('active'); };

// Theme System
const THEMES=[
  {id:'default',name:'Claude Dark',colors:{bg:'#302e2b',bg2:'#282624',accent:'#8abadc',green:'#7fb87f',red:'#c08080'}},
  {id:'claude-light',name:'Claude Light',colors:{bg:'#ffffff',bg2:'#faf9f5',accent:'#1a66b2',green:'#1a7a1a',red:'#b04545'}}
];
let currentTheme=localStorage.getItem('ebs-theme')||'default';

function applyTheme(themeId){
  if(themeId==='default')document.documentElement.removeAttribute('data-theme');
  else document.documentElement.setAttribute('data-theme',themeId);
  currentTheme=themeId;
  localStorage.setItem('ebs-theme',themeId);
  renderThemeGrid();
}

function renderThemeGrid(){
  const grid=$('themeGrid');
  const lightThemes=['claude-light'];
  grid.innerHTML=THEMES.map(t=>{
    const isActive=t.id===currentTheme;
    const isLight=lightThemes.includes(t.id);
    return '<div class="theme-card'+(isActive?' active':'')+'" data-theme-id="'+t.id+'" style="background:'+t.colors.bg+';color:'+(isLight?'#2d2d2d':'#e8e8ec')+'"><div class="theme-name">'+t.name+'</div><div class="theme-preview"><span style="background:'+t.colors.bg2+'"></span><span style="background:'+t.colors.accent+'"></span><span style="background:'+t.colors.green+'"></span><span style="background:'+t.colors.red+'"></span></div></div>';
  }).join('');
  grid.querySelectorAll('.theme-card').forEach(card=>{
    card.onclick=()=>applyTheme(card.dataset.themeId);
  });
}

$('themeBtn').onclick=(e)=>{
  renderThemeGrid();
  const popover=$('themeModal');
  $('menuDrop').classList.remove('open');
  popover.style.top='60px';
  popover.style.right='16px';
  popover.style.left='auto';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
};
$('themeClose').onclick=()=>{$('themeModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
document.addEventListener('click',e=>{
  const popover=$('themeModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#themeBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});

// Activity Log Modal
$('activityViewAll').onclick=()=>{
  renderActivityFull();
  $('activityModal').classList.add('open');
  $('popoverBackdrop').classList.add('active');
};
$('activityClose').onclick=()=>{
  $('activityModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
};
document.querySelectorAll('.activity-filter').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.activity-filter').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    activityFilter=btn.dataset.filter;
    renderActivityFull();
  };
});
document.addEventListener('click',e=>{
  const popover=$('activityModal');
  if(popover&&popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#activityViewAll')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});

// Item Code Configuration
function renderItemConfigList(){
  const codes=Object.keys(itemCodeConfig).sort();
  if(codes.length===0){
    $('icList').innerHTML='<div class="item-config-empty">No item codes configured yet.<br>Add configurations above to customize phase requirements.</div>';
    return;
  }
  let html='<div class="item-config-row header"><div>Item Code</div><div>Phases</div><div></div></div>';
  codes.forEach(code=>{
    const cfg=itemCodeConfig[code];
    let badges='';
    badges+=cfg.requiresConfig?'<span class="item-config-badge active">Config'+(cfg.configuredBy?' ('+esc(cfg.configuredBy)+')':'')+'</span>':'<span class="item-config-badge skip">Config</span>';
    badges+=cfg.requiresTesting?'<span class="item-config-badge active">Test'+(cfg.tester?' ('+esc(cfg.tester)+')':'')+'</span>':'<span class="item-config-badge skip">Test</span>';
    html+='<div class="item-config-row"><div class="item-config-code">'+esc(code)+'</div><div class="item-config-badges">'+badges+'</div><div class="item-config-actions"><button onclick="window.editItemConfig(\''+esc(code)+'\')">Edit</button><button onclick="window.deleteItemConfig(\''+esc(code)+'\')">Ã—</button></div></div>';
  });
  $('icList').innerHTML=html;
}

function updateItemConfigSelects(){
  const teamOpts='<option value="">Anyone</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');
  $('icConfigBy').innerHTML=teamOpts;
  $('icTestBy').innerHTML=teamOpts;
}

function clearItemConfigForm(){
  $('icCode').value='';
  $('icReqConfig').checked=false;
  $('icReqTest').checked=true;
  $('icConfigBy').value='';
  $('icTestBy').value='';
}

window.editItemConfig=function(code){
  const cfg=itemCodeConfig[code]||{};
  $('icCode').value=code;
  $('icReqConfig').checked=cfg.requiresConfig||false;
  $('icReqTest').checked=cfg.requiresTesting!==false;
  $('icConfigBy').value=cfg.configuredBy||'';
  $('icTestBy').value=cfg.tester||'';
};

window.deleteItemConfig=function(code){
  if(!confirm('Remove configuration for "'+code+'"?'))return;
  delete itemCodeConfig[code];
  saveItemCodeConfig();
  renderItemConfigList();
  render();
  
};

$('itemConfigBtn').onclick=()=>{
  updateItemConfigSelects();
  renderItemConfigList();
  clearItemConfigForm();
  $('itemConfigModal').classList.add('open');
};

$('icClose').onclick=$('icDone').onclick=()=>closeModal('itemConfigModal');
$('itemConfigModal').onclick=e=>{if(e.target.id==='itemConfigModal')closeModal('itemConfigModal')};

$('icSave').onclick=()=>{
  const code=$('icCode').value.trim().toUpperCase();
  if(!code){return}
  itemCodeConfig[code]={
    requiresConfig:$('icReqConfig').checked,
    configuredBy:$('icConfigBy').value,
    requiresTesting:$('icReqTest').checked,
    tester:$('icTestBy').value
  };
  saveItemCodeConfig();
  renderItemConfigList();
  clearItemConfigForm();
  render();
  
};

$('icClear').onclick=clearItemConfigForm;

$('icExport').onclick=()=>{
  const json=JSON.stringify(itemCodeConfig,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='item-code-config.json';a.click();
  URL.revokeObjectURL(url);
  
};

// Bulk operations button handlers
$('bulkStatusBtn').onclick=window.openBulkStatusModal;
$('bulkAssignBtn').onclick=window.openBulkAssignModal;
$('bulkPOBtn').onclick=window.openBulkPOModal;
$('bulkPrintBtn').onclick=window.openBulkLabelModal;
$('bulkDeleteBtn').onclick=window.openBulkDeleteModal;
$('bulkClearBtn').onclick=clearSelection;
$('selectAllParts').onclick=window.toggleSelectAll;
$('bulkStatusApply').onclick=window.applyBulkStatus;
$('bulkAssignApply').onclick=window.applyBulkAssign;
$('bulkPOApply').onclick=window.applyBulkPO;
$('bulkDeleteApply').onclick=window.applyBulkDelete;
$('bulkStatusCancel').onclick=()=>$('bulkStatusModal').classList.remove('open');
$('bulkAssignCancel').onclick=()=>$('bulkAssignModal').classList.remove('open');
$('bulkPOCancel').onclick=()=>$('bulkPOModal').classList.remove('open');
$('bulkDeleteCancel').onclick=()=>$('bulkDeleteModal').classList.remove('open');

// Initialize
applyTheme(currentTheme);
loadExpanded();
loadItemCodeConfig();

// Initialize auth and check for existing session
(async function initSession() {
  // First, initialize Firebase anonymous auth
  await initAuth();
  
  // Then check if we have a stored project code AND valid auth
  const storedCode = sessionStorage.getItem('ebs-project-code');
  if(storedCode && firebaseUser) {
    setProjectCode(storedCode);
    isAuthenticated = true;
    $('loginScreen').style.display = 'none';
    initFirebaseListeners();
  }
})();


// ===== MOBILE APP (completely separate from desktop) =====
(function(){
  const SLABELS={waiting:'Waiting','to-order':'To Order',ordered:'Ordered',arrived:'Arrived',installed:'Installed'};
  let mobFilterStatus='';
  let mobEditPartId=null;
  let mobExpanded={};
  
  // Render mobile parts list
  function renderMobParts(){
    const parts=data.filter(d=>!d.isAsm&&!d._deletedAt);
    const asms=data.filter(d=>d.isAsm&&!d._deletedAt);
    
    // Update pipeline counts
    const counts={waiting:0,'to-order':0,ordered:0,arrived:0,tested:0,configured:0,installed:0};
    parts.forEach(p=>counts[p.status]=(counts[p.status]||0)+1);
    if($('mobP0'))$('mobP0').textContent=counts.waiting;
    if($('mobP1'))$('mobP1').textContent=counts['to-order'];
    if($('mobP2'))$('mobP2').textContent=counts.ordered;
    if($('mobP3'))$('mobP3').textContent=counts.arrived;
    if($('mobP4'))$('mobP4').textContent=counts.tested;
    if($('mobP5'))$('mobP5').textContent=counts.configured;
    if($('mobP6'))$('mobP6').textContent=counts.installed;
    
    // Update active state on pipes
    document.querySelectorAll('.mob-pipe').forEach(p=>{
      p.classList.toggle('active',p.dataset.status===mobFilterStatus);
    });
    
    // Filter parts
    let filteredParts=parts;
    if(mobFilterStatus)filteredParts=parts.filter(p=>p.status===mobFilterStatus);
    
    // Group by assembly
    let html='';
    asms.forEach(asm=>{
      const asmParts=filteredParts.filter(p=>String(p.parentId)===String(asm.id));
      if(asmParts.length===0&&mobFilterStatus)return;
      
      const allAsmParts=parts.filter(p=>String(p.parentId)===String(asm.id));
      const installed=allAsmParts.filter(p=>p.status==='installed').length;
      const pct=allAsmParts.length?Math.round(installed/allAsmParts.length*100):0;
      const isExpanded=mobExpanded[asm.id];
      
      html+='<div class="mob-asm'+(isExpanded?' expanded':'')+'" data-asm-id="'+asm.id+'">';
      html+='<div class="mob-asm-header">';
      html+='<span class="mob-asm-toggle">â–¶</span>';
      html+='<div class="mob-asm-info"><div class="mob-asm-name">'+esc(asm.name)+'</div><div class="mob-asm-meta">'+asmParts.length+' parts</div></div>';
      html+='<div class="mob-asm-progress"><div class="mob-asm-progress-bar" style="width:'+pct+'%"></div></div>';
      html+='<div class="mob-asm-pct">'+pct+'%</div>';
      html+='</div>';
      html+='<div class="mob-parts">';
      asmParts.forEach(p=>{
        html+='<div class="mob-part" data-part-id="'+p.id+'">';
        html+='<div class="mob-part-info"><div class="mob-part-name">'+esc(p.name)+'</div>';
        html+='<div class="mob-part-meta">';
        if(p.assignee)html+='<span>@'+esc(p.assignee)+'</span>';
        if(p.poNumber)html+='<span>PO: '+esc(p.poNumber)+'</span>';
        html+='</div></div>';
        html+='<span class="mob-status '+p.status+'">'+SLABELS[p.status]+'</span>';
        html+='<span class="mob-part-arrow">â€º</span>';
        html+='</div>';
      });
      html+='</div></div>';
    });
    
    if(!html)html='<div class="mob-empty">No parts found</div>';
    $('mobPartsList').innerHTML=html;
    
    // Attach events
    document.querySelectorAll('.mob-asm-header').forEach(h=>{
      h.onclick=()=>{
        const asm=h.closest('.mob-asm');
        const asmId=asm.dataset.asmId;
        mobExpanded[asmId]=!mobExpanded[asmId];
        asm.classList.toggle('expanded');
      };
    });
    
    document.querySelectorAll('.mob-part').forEach(p=>{
      p.onclick=(e)=>{
        e.stopPropagation();
        openMobPartModal(p.dataset.partId);
      };
    });
  }
  
  // Open part modal
  function openMobPartModal(partId){
    const part=data.find(d=>String(d.id)===String(partId));
    if(!part)return;
    mobEditPartId=partId;
    $('mobPartTitle').textContent=part.name;
    $('mobPartName').value=part.name||'';
    $('mobPartStatus').value=part.status||'waiting';
    $('mobPartPO').value=part.poNumber||'';
    
    // Populate assignee dropdown
    let assigneeHtml='<option value="">â€” Unassigned â€”</option>';
    team.forEach(t=>{
      assigneeHtml+='<option value="'+esc(t.name)+'"'+(part.assignee===t.name?' selected':'')+'>'+esc(t.name)+'</option>';
    });
    $('mobPartAssignee').innerHTML=assigneeHtml;
    
    $('mobPartModal').classList.add('open');
  }
  
  // Save part from modal
  function saveMobPart(){
    if(!mobEditPartId)return;
    const part=data.find(d=>String(d.id)===String(mobEditPartId));
    if(!part)return;
    
    const newStatus=$('mobPartStatus').value;
    const oldStatus=part.status;
    
    part.name=$('mobPartName').value;
    part.status=newStatus;
    part.assignee=$('mobPartAssignee').value;
    part.poNumber=$('mobPartPO').value;
    
    if(newStatus!==oldStatus){
      part.changedAt=Date.now();
      history.push({ts:Date.now(),action:'Status â†’ '+SLABELS[newStatus],item:part.name,partId:part.id});
    }
    
    markPartChanged(part.id, ['name', 'status', 'assignee', 'poNumber']);
    save();
    $('mobPartModal').classList.remove('open');
    mobEditPartId=null;
    renderMobParts();
    render(); // Sync desktop
  }
  
  // Mobile render function
  function renderMobile(){
    if(!$('mobileApp'))return;
    $('mobLogo').textContent=currentProjectName||'EF Final Assembly';
    renderMobParts();
  }
  
  // Hook into main render
  const origRender=window.render||render;
  if(typeof render==='function'){
    const _origRender=render;
    window.render=function(){
      _origRender.apply(this,arguments);
      renderMobile();
    };
  }
  
  // Initialize mobile events
  document.addEventListener('DOMContentLoaded',()=>{
    // Pipeline filter
    document.querySelectorAll('.mob-pipe').forEach(p=>{
      p.onclick=()=>{
        const status=p.dataset.status;
        mobFilterStatus=mobFilterStatus===status?'':status;
        renderMobParts();
      };
    });
    
    // Part modal
    $('mobPartBack').onclick=()=>$('mobPartModal').classList.remove('open');
    $('mobPartCancel').onclick=()=>$('mobPartModal').classList.remove('open');
    $('mobPartSave').onclick=saveMobPart;
    
    // Menu
    $('mobMenuBtn').onclick=()=>$('mobMenuModal').classList.add('open');
    $('mobMenuBack').onclick=()=>$('mobMenuModal').classList.remove('open');
    $('mobSampleBtn').onclick=()=>{
      $('mobMenuModal').classList.remove('open');
      if(typeof loadSampleData==='function')loadSampleData();
    };
    $('mobSignOutBtn').onclick=()=>{
      $('mobMenuModal').classList.remove('open');
      if(typeof signOut==='function')signOut();
    };
    
    // Initial render
    setTimeout(renderMobile,100);
  });
})();

})();
</script>
</body>
</html>
