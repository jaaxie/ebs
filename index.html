<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>EBS v4 - Cloud</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<style>
:root{--bg:#2f2f2f;--bg2:#3d3d3d;--bg3:#4a4a4a;--bg4:#5a5a5a;--border:#4a4a4a;--text:#ececec;--text2:#a0a0a0;--text3:#707070;--accent:#da7756;--green:#5cb85c;--yellow:#f0c36d;--orange:#e89a5a;--red:#d9534f;--cyan:#5bc0de;--purple:#a87fd1;--s1:#d9534f;--s2:#e89a5a;--s3:#f0c36d;--s4:#a87fd1;--s5:#5bc0de;--s6:#5cb85c}
[data-theme="claude-light"]{--bg:#f5f4f2;--bg2:#ffffff;--bg3:#eae8e4;--bg4:#ddd9d4;--border:#d4d0ca;--text:#2d2d2d;--text2:#6b6b6b;--text3:#9a9a9a;--accent:#da7756;--green:#3d8c40;--yellow:#c49a30;--orange:#c67840;--red:#c44540;--cyan:#3a8ea8;--purple:#7c5aad;--s1:#c44540;--s2:#c67840;--s3:#c49a30;--s4:#7c5aad;--s5:#3a8ea8;--s6:#3d8c40}
[data-theme="graphite"]{--bg:#1c1c1e;--bg2:#2c2c2e;--bg3:#3a3a3c;--bg4:#48484a;--border:#38383a;--text:#f5f5f7;--text2:#a1a1a6;--text3:#636366;--accent:#98989d;--green:#30d158;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#64d2ff;--purple:#bf5af2}
[data-theme="midnight"]{--bg:#0a1628;--bg2:#0f1f33;--bg3:#152840;--bg4:#1c334d;--border:#234060;--text:#e0e8f0;--text2:#8aa4c0;--text3:#506880;--accent:#0a84ff;--green:#30d158;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#64d2ff;--purple:#bf5af2}
[data-theme="forest"]{--bg:#161d14;--bg2:#1e271a;--bg3:#283422;--bg4:#32402a;--border:#3d4d32;--text:#e8f0e6;--text2:#9db396;--text3:#6a8060;--accent:#30d158;--green:#32d74b;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#64d2ff;--purple:#bf5af2}
[data-theme="sunset"]{--bg:#1e1614;--bg2:#2a1e1a;--bg3:#382822;--bg4:#46322a;--border:#5a4035;--text:#f5ebe8;--text2:#c4a69a;--text3:#8a6a5c;--accent:#ff9f0a;--green:#30d158;--yellow:#ffd60a;--orange:#ff9500;--red:#ff453a;--cyan:#64d2ff;--purple:#bf5af2}
[data-theme="ocean"]{--bg:#0f1a1e;--bg2:#152228;--bg3:#1c2c34;--bg4:#243640;--border:#2d4250;--text:#e6f2f5;--text2:#8fc4d4;--text3:#4a8a9e;--accent:#64d2ff;--green:#30d158;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#5ac8fa;--purple:#bf5af2}
[data-theme="lavender"]{--bg:#1a181e;--bg2:#242028;--bg3:#302a36;--bg4:#3c3444;--border:#4a4058;--text:#f5f0fa;--text2:#b8a8d0;--text3:#7a6890;--accent:#bf5af2;--green:#30d158;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#64d2ff;--purple:#da8aff}
[data-theme="highcontrast"]{--bg:#000000;--bg2:#1c1c1e;--bg3:#2c2c2e;--bg4:#3a3a3c;--border:#545456;--text:#ffffff;--text2:#ebebf0;--text3:#aeaeb2;--accent:#409cff;--green:#30db5b;--yellow:#ffd426;--orange:#ffb340;--red:#ff6961;--cyan:#70d7ff;--purple:#da8fff}

/* Login Screen - Modern Google Auth */
.login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:rgba(255,255,255,0.03);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:24px;padding:48px 40px;text-align:center;max-width:380px;width:90%;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)}
.login-logo{font-size:48px;margin-bottom:8px}
.login-title{font-size:28px;font-weight:700;color:#fff;margin-bottom:6px;letter-spacing:-0.5px}
.login-subtitle{font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:36px}
.login-google-btn{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:14px 24px;background:#fff;border:none;border-radius:12px;font-size:15px;font-weight:600;color:#1f1f1f;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 14px rgba(0,0,0,0.15)}
.login-google-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.2)}
.login-google-btn:active{transform:translateY(0)}
.login-google-btn svg{width:20px;height:20px}
.login-divider{display:flex;align-items:center;gap:16px;margin:28px 0;color:rgba(255,255,255,0.3);font-size:12px}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.1)}
.login-info{font-size:12px;color:rgba(255,255,255,0.4);line-height:1.6}
.login-info a{color:rgba(255,255,255,0.6);text-decoration:none}
.login-info a:hover{text-decoration:underline}
.login-error{margin-top:16px;padding:12px;background:rgba(255,69,58,0.15);border-radius:8px;color:#ff6b6b;font-size:13px;display:none}
.login-error.visible{display:block}
.login-loading{display:none;flex-direction:column;align-items:center;gap:12px;color:rgba(255,255,255,0.7);font-size:14px}
.login-loading.visible{display:flex}
.login-spinner{width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* User avatar in header */
.user-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);cursor:pointer}
.user-menu{position:relative}
.user-dropdown{position:absolute;top:100%;right:0;margin-top:8px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:500;display:none;overflow:hidden}
.user-dropdown.open{display:block}
.user-dropdown-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.user-dropdown-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
.user-dropdown-info{flex:1;min-width:0}
.user-dropdown-name{font-weight:600;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-dropdown-email{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-dropdown-item{padding:12px 16px;font-size:13px;color:var(--text);cursor:pointer;transition:background 0.15s;display:flex;align-items:center;gap:10px}
.user-dropdown-item:hover{background:var(--bg3)}
.user-dropdown-item.danger{color:var(--red)}
.user-dropdown-item svg{width:16px;height:16px;opacity:0.7}

/* Notification Bell */
.notif-btn{position:relative;width:36px;height:36px;background:var(--bg3);border:none;border-radius:10px;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.notif-btn:hover{background:var(--bg4);color:var(--text)}
.notif-btn svg{width:18px;height:18px}
.notif-badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:var(--red);color:#fff;border-radius:9px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 4px;animation:notifPulse 2s ease-in-out infinite}
@keyframes notifPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.notif-badge:empty,.notif-badge[data-count="0"]{display:none}

/* Notification Panel */
.notif-panel{position:absolute;top:100%;right:0;margin-top:8px;width:320px;max-height:400px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,0.4);z-index:500;display:none;flex-direction:column;overflow:hidden}
.notif-panel.open{display:flex}
.notif-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.notif-title{font-weight:600;font-size:14px}
.notif-clear{font-size:12px;color:var(--accent);background:none;border:none;cursor:pointer}
.notif-clear:hover{text-decoration:underline}
.notif-list{flex:1;overflow-y:auto;max-height:320px}
.notif-item{padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s}
.notif-item:hover{background:var(--bg3)}
.notif-item:last-child{border-bottom:none}
.notif-item.unread{background:rgba(10,132,255,0.08)}
.notif-item-header{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.notif-item-avatar{width:24px;height:24px;border-radius:50%;object-fit:cover}
.notif-item-name{font-weight:600;font-size:12px;color:var(--accent)}
.notif-item-time{font-size:10px;color:var(--text3);margin-left:auto}
.notif-item-text{font-size:12px;color:var(--text);line-height:1.4}
.notif-item-context{font-size:11px;color:var(--text3);margin-top:4px;display:flex;align-items:center;gap:4px}
.notif-empty{padding:40px 20px;text-align:center;color:var(--text3);font-size:13px}

/* @Mention styles in comments */
.mention{color:var(--accent);font-weight:600;background:rgba(218,119,86,0.15);padding:1px 4px;border-radius:4px}
.mention-dropdown{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:10px;max-height:180px;overflow-y:auto;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,0.4);min-width:160px;display:none}
.mention-dropdown.open{display:block}
.mention-item{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;transition:background 0.15s}
.mention-item:hover,.mention-item.selected{background:var(--bg4)}
.mention-item-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;background:var(--bg4)}
.mention-item-name{font-size:13px;font-weight:500}

/* Online presence - improved */
.online-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg3);border-radius:8px;font-size:12px;color:var(--text2);position:relative;cursor:pointer}
.online-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.online-hover{position:absolute;top:100%;right:0;margin-top:8px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:8px;min-width:200px;box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:400;display:none}
.online-badge:hover .online-hover{display:block}
.online-user{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;transition:background 0.15s}
.online-user:hover{background:var(--bg3)}
.online-user-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;background:var(--bg4)}
.online-user-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}
.online-user-info{flex:1;min-width:0}
.online-user-name{font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.online-user-time{font-size:10px;color:var(--text3)}

/* Rest of existing styles */
.theme-popover{width:280px}
.theme-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.theme-card{padding:14px;border-radius:12px;cursor:pointer;border:2px solid transparent;background:var(--bg3);transition:all .2s;position:relative}
.theme-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.theme-card.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(10,132,255,.3)}
.theme-card.active::after{content:'âœ“';position:absolute;top:10px;right:12px;font-size:14px;font-weight:bold;color:var(--accent)}
.theme-name{font-size:12px;font-weight:600;margin-bottom:8px}
.theme-preview{display:flex;gap:4px;height:24px;border-radius:6px;overflow:hidden}
.theme-preview span{flex:1;border-radius:4px}
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:var(--bg4) transparent}
*::-webkit-scrollbar{width:6px;height:6px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
*::-webkit-scrollbar-thumb:hover{background:var(--text3)}
html,body{height:100%;overflow:hidden;overflow-x:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","SF Pro Text",system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:13px;-webkit-font-smoothing:antialiased;line-height:1.5}
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 18px;display:flex;align-items:center;position:fixed;top:0;left:0;right:0;z-index:100;height:54px;gap:12px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.logo{font-weight:600;font-size:15px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:140px;max-width:280px;letter-spacing:-0.2px;flex-shrink:0}
.header-search{position:relative;width:220px;flex-shrink:0}
.header-search input{width:100%;height:32px;padding:0 32px 0 12px;font-size:13px;color:var(--text);background:var(--bg3);border:none;border-radius:8px}
.header-search input:focus{outline:none;box-shadow:0 0 0 2px rgba(10,132,255,.3)}
.header-search input::placeholder{color:var(--text3)}
.header-search-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:18px;height:18px;background:var(--bg4);border:none;border-radius:50%;color:var(--text3);font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center}
.header-search-clear.visible{display:flex}
.header-search-clear:hover{background:var(--text3);color:var(--bg)}
.ai-console-btn{display:flex;align-items:center;gap:10px;padding:6px 14px 6px 6px;background:transparent;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:400;color:var(--text);transition:all .15s;flex-shrink:0}
.ai-console-btn:hover{background:rgba(255,255,255,0.06)}
.ai-console-icon{width:26px;height:26px;border-radius:50%;background:#d4776b;display:flex;align-items:center;justify-content:center;font-size:18px;color:white;font-weight:300;line-height:1;animation:ai-pulse 3s ease-in-out infinite}
@keyframes ai-pulse{0%,100%{box-shadow:0 0 0 0 rgba(212,119,107,0);transform:scale(1)}50%{box-shadow:0 0 12px 4px rgba(212,119,107,0.35);transform:scale(1.05)}}
.header-spacer{flex:1}
.header-metrics{display:flex;align-items:center;gap:8px}
.hm{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border-radius:10px}
.hm-label{font-size:10px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px}
.hm-value{font-size:15px;font-weight:600;letter-spacing:-0.3px}
.hm-progress{min-width:180px}
.hm-bar{width:100px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.hm-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.header-btns{display:flex;gap:8px;align-items:center}
.version-badge{font-size:8px;color:var(--text3);opacity:0.5;padding:2px 4px;margin-left:4px;font-family:monospace}
.btn{height:34px;padding:0 16px;font-size:13px;font-weight:500;color:var(--text);background:var(--bg3);border:none;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:all .2s}
.btn:hover{background:var(--bg4)}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent);filter:brightness(1.1)}
.btn-report{background:var(--bg3);color:var(--text)}
.btn-report:hover{background:var(--bg4)}
.btn-receive{background:#2d4a3e;color:#6ee7b7}
.btn-receive:hover{background:#365949}
.btn-save{background:var(--bg3);color:var(--text)}
.btn-save:hover{background:var(--bg4)}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:var(--red);filter:brightness(1.1)}

/* Sync indicator */
.sync-indicator{position:fixed;top:60px;right:18px;display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text2);z-index:99;opacity:0;transform:translateY(-10px);transition:all .3s;pointer-events:none}
.sync-indicator.active{opacity:1;transform:translateY(0)}
.sync-indicator.syncing .sync-dot{background:var(--yellow);animation:pulse .8s infinite}
.sync-indicator.synced .sync-dot{background:var(--green)}
.sync-indicator.offline .sync-dot{background:var(--red)}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--text3)}

/* Toast */
.toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:12px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;font-size:13px;color:var(--text);box-shadow:0 8px 24px rgba(0,0,0,.3);animation:toastIn .3s ease}
.toast.err{border-color:var(--red);color:var(--red)}
.toast.success{border-color:var(--green)}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* Main layout */
.main{padding:14px 18px;padding-top:68px;max-width:1600px;margin:0 auto;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.pipeline{display:flex;gap:6px;margin-bottom:10px;flex-shrink:0}
.pipe{flex:1;background:var(--bg2);border:none;border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;position:relative;transition:all .15s}
.pipe::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0;opacity:.8}
.pipe[data-s="to-order"]::before{background:var(--s1)}.pipe[data-s="ordered"]::before{background:var(--s2)}.pipe[data-s="arrived"]::before{background:var(--s3)}.pipe[data-s="configured"]::before{background:var(--s4)}.pipe[data-s="tested"]::before{background:var(--s5)}.pipe[data-s="installed"]::before{background:var(--s6)}
.pipe:hover{background:var(--bg3)}.pipe.active{background:var(--bg3)}
.pipe-count{font-size:18px;font-weight:600;letter-spacing:-0.5px}
.pipe[data-s="to-order"] .pipe-count{color:var(--s1)}.pipe[data-s="ordered"] .pipe-count{color:var(--s2)}.pipe[data-s="arrived"] .pipe-count{color:var(--s3)}.pipe[data-s="configured"] .pipe-count{color:var(--s4)}.pipe[data-s="tested"] .pipe-count{color:var(--s5)}.pipe[data-s="installed"] .pipe-count{color:var(--s6)}
.pipe-label{font-size:10px;font-weight:500;color:var(--text2);text-transform:uppercase;letter-spacing:0.3px;margin-top:2px}
.tabs{display:flex;background:var(--bg2);border:none;border-radius:10px;padding:3px;margin-bottom:10px;gap:2px;flex-shrink:0}
.tab{flex:1;height:30px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:500;color:var(--text2);background:transparent;border:none;border-radius:8px;cursor:pointer;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{background:var(--bg4);color:var(--text);font-weight:600}
.toolbar{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-shrink:0}
.search{flex:1;height:34px;padding:0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:none;border-radius:10px}
.search:focus{outline:none;box-shadow:0 0 0 3px rgba(10,132,255,.3)}

/* Data table */
.data-table{background:var(--bg2);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;flex:1;min-height:0}
.table-header{display:grid;gap:1px;padding:0 12px;background:var(--bg3);font-size:11px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px;height:36px;align-items:center;flex-shrink:0}
.table-body{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.parts-grid{grid-template-columns:22px 22px minmax(80px,1fr) 100px 100px 60px 30px 62px 70px 100px minmax(100px,180px) 32px 32px 32px 32px}
.panel{display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden}
.panel.active{display:flex}

/* Assembly and part rows */
.asm-row{display:grid;gap:1px;padding:0 12px;background:var(--bg3);height:40px;align-items:center;cursor:pointer;transition:background .15s;grid-template-columns:22px 22px 28px minmax(80px,1fr) 100px 100px 60px 30px 62px 240px minmax(100px,180px) 44px 32px}
.asm-row:hover{background:var(--bg4)}
.asm-toggle{width:20px;height:20px;background:transparent;border:none;color:var(--text2);font-size:10px;cursor:pointer;pointer-events:none}
.asm-name{font-weight:600;font-size:13px;color:var(--accent);pointer-events:none}
.asm-meta{font-size:11px;color:var(--text3);pointer-events:none}
.asm-progress{display:flex;align-items:center;gap:8px}
.asm-bar{width:180px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;display:block}
.asm-bar-fill{height:100%;border-radius:3px;display:block}
.asm-pct{font-size:12px;font-weight:600;min-width:40px}
.part-row{display:grid;gap:1px;padding:0 12px;background:var(--bg2);height:38px;align-items:center;transition:background .15s}
.part-row:hover{background:var(--bg3)}
.part-row.child{background:var(--bg)}
.part-row.child:hover{background:var(--bg3)}
.cell{font-size:13px;color:var(--text);padding:4px 6px;border-radius:6px;cursor:text;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:20px;display:flex;align-items:center}
.cell:hover{background:var(--bg4)}
.cell.editing{background:var(--bg);padding:0;overflow:visible;position:relative;z-index:50}
.cell input,.cell select{width:100%;height:26px;padding:0 8px;font-size:13px;color:var(--text);background:var(--bg);border:2px solid var(--accent);border-radius:6px;outline:none}
.status-badge{font-size:10px;font-weight:600;padding:4px 8px;border-radius:6px;text-align:center;display:inline-block}
.status-badge.to-order{background:rgba(255,69,58,.15);color:var(--s1)}
.status-badge.ordered{background:rgba(255,159,10,.15);color:var(--s2)}
.status-badge.arrived{background:rgba(255,214,10,.15);color:var(--s3)}
.status-badge.configured{background:rgba(168,127,209,.15);color:var(--s4)}
.status-badge.tested{background:rgba(100,210,255,.15);color:var(--s5)}
.status-badge.installed{background:rgba(48,209,88,.15);color:var(--s6)}
.adv-btn{width:24px;height:24px;font-size:12px;font-weight:600;color:var(--text2);background:var(--bg3);border:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.adv-btn:hover{background:var(--bg4);color:var(--text);transform:scale(1.05)}
.adv-btn.done{color:var(--green);cursor:default}
.adv-btn.done:hover{transform:none}
.sm-btn{width:24px;height:24px;background:var(--bg4);border:none;border-radius:6px;color:var(--text3);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.sm-btn:hover{background:var(--bg);color:var(--text);transform:scale(1.05)}
.sm-btn.red{color:var(--red);opacity:0.7}
.sm-btn.red:hover{opacity:1;background:rgba(255,69,58,.15);transform:scale(1.05)}
.add-row{display:flex;align-items:center;padding:8px 12px;background:var(--bg)}
.add-row-btn{width:24px;height:24px;background:var(--bg3);border:none;border-radius:8px;color:var(--text3);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-right:10px;transition:all .15s}
.add-row-btn:hover{background:var(--accent);color:#fff}
.add-row-text{font-size:12px;color:var(--text3)}
.empty{padding:40px 20px;text-align:center;color:var(--text3);font-size:13px;flex:1;display:flex;align-items:center;justify-content:center}

/* Comments button and popover */
.comment-btn{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;padding:2px 4px;border-radius:4px;display:flex;align-items:center;gap:3px}
.comment-btn:hover{color:var(--accent);background:var(--bg4)}
.comment-btn.has-comments{color:var(--accent)}
.comment-count{font-size:10px}
.comments-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:1002;width:300px;max-height:400px;display:flex;flex-direction:column;opacity:0;transform:scale(0.95);transition:all 0.15s ease;pointer-events:none}
.comments-popover.open{opacity:1;transform:scale(1);pointer-events:auto}
.comments-header{padding:12px 14px;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.comments-header button{background:none;border:none;color:var(--text3);font-size:16px;cursor:pointer}
.comments-list{flex:1;overflow-y:auto;padding:10px;max-height:220px}
.comment-item{padding:10px;background:var(--bg3);border-radius:10px;margin-bottom:8px;font-size:12px}
.comment-item:last-child{margin-bottom:0}
.comment-author{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.comment-author-avatar{width:22px;height:22px;border-radius:50%;object-fit:cover;background:var(--bg4)}
.comment-author-name{font-weight:600;color:var(--accent)}
.comment-text{color:var(--text);line-height:1.5}
.comment-time{font-size:10px;color:var(--text3);margin-top:6px}
.comments-input{padding:10px;border-top:1px solid var(--border);display:flex;gap:8px}
.comments-input input{flex:1;height:34px;padding:0 12px;font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)}
.comments-input input:focus{outline:none;border-color:var(--accent)}
.comments-input button{padding:0 14px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:500;cursor:pointer}
.comments-input button:hover{filter:brightness(1.1)}
.comments-empty{text-align:center;color:var(--text3);padding:30px 20px;font-size:12px}

/* Chat panel */
.chat-toggle{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:var(--accent);color:#fff;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.3);z-index:300;transition:transform .2s;display:flex;align-items:center;justify-content:center}
.chat-toggle:hover{transform:scale(1.1)}
.chat-toggle svg{width:24px;height:24px}
.chat-badge{position:absolute;top:-4px;right:-4px;min-width:20px;height:20px;background:#ff3b30;color:#fff;border-radius:10px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 5px;box-shadow:0 2px 6px rgba(0,0,0,.3);animation:badgePulse 2s ease-in-out infinite}
@keyframes badgePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.chat-panel{position:fixed;bottom:80px;right:20px;width:320px;height:420px;background:var(--bg2);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:300;display:none;flex-direction:column;overflow:hidden}
.chat-panel.open{display:flex}
.chat-header{padding:12px 14px;background:var(--bg3);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.chat-title{font-weight:600;font-size:13px}
.chat-close{width:26px;height:26px;border-radius:50%;background:var(--bg4);border:none;color:var(--text2);font-size:16px;cursor:pointer}
.chat-close:hover{background:var(--border);color:var(--text)}
.chat-messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px;-webkit-overflow-scrolling:touch}
.chat-msg{max-width:85%;padding:8px 10px;border-radius:10px;font-size:12px;line-height:1.4;word-wrap:break-word}
.chat-msg.mine{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.chat-msg.other{background:var(--bg3);color:var(--text);align-self:flex-start;border-bottom-left-radius:4px}
.chat-msg-name{font-size:10px;font-weight:600;margin-bottom:2px;opacity:0.8}
.chat-msg-time{font-size:9px;opacity:0.5;margin-top:3px}
.chat-input-area{padding:10px;background:var(--bg3);border-top:1px solid var(--border);display:flex;gap:6px}
.chat-input{flex:1;height:34px;padding:0 12px;font-size:12px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:17px;outline:none}
.chat-input:focus{border-color:var(--accent)}
.chat-send{width:34px;height:34px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:14px;cursor:pointer}
.chat-send:hover{filter:brightness(1.1)}
.chat-empty{text-align:center;color:var(--text3);padding:40px 20px;font-size:12px}

/* Dropdown menu */
.dropdown{position:relative}
.dropdown-menu{position:absolute;top:100%;right:0;margin-top:8px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;min-width:180px;box-shadow:0 8px 32px rgba(0,0,0,.3);z-index:200;display:none;overflow:hidden}
.dropdown-menu.open{display:block}
.dropdown-item{padding:12px 16px;font-size:13px;color:var(--text);cursor:pointer;transition:background .15s}
.dropdown-item:hover{background:var(--bg3)}
.dropdown-item.danger{color:var(--red)}
.dropdown-div{height:1px;background:var(--border);margin:4px 0}

/* Filter */
.filter-select{height:34px;padding:0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:none;border-radius:10px;cursor:pointer}
.filter-select:focus{outline:none;box-shadow:0 0 0 3px rgba(10,132,255,.3)}
.filter-badges{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.filter-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:var(--accent);color:#fff;border-radius:6px;font-size:11px;font-weight:500}
.filter-badge button{background:none;border:none;color:rgba(255,255,255,.7);font-size:14px;cursor:pointer;padding:0;line-height:1}
.filter-badge button:hover{color:#fff}
.toggle-btn{height:34px;padding:0 14px;font-size:12px;font-weight:500;color:var(--text2);background:var(--bg2);border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:6px}
.toggle-btn:hover{background:var(--bg3);color:var(--text)}
.toggle-btn .arrow{font-size:10px}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border-radius:16px;width:90%;max-width:400px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:16px;font-weight:600}
.modal-close{width:28px;height:28px;background:var(--bg3);border:none;border-radius:50%;color:var(--text2);font-size:18px;cursor:pointer}
.modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-body{padding:20px}
.modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

/* Popover modal */
.popover-modal{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:1001;width:320px;max-height:80vh;overflow-y:auto;display:none;flex-direction:column}
.popover-modal.open{display:flex}

/* Form elements */
.form-group{margin-bottom:16px}
.form-group:last-child{margin-bottom:0}
.form-label{display:block;font-size:12px;font-weight:500;color:var(--text2);margin-bottom:6px}
.form-input{width:100%;height:38px;padding:0 12px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:8px}
.form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(10,132,255,.2)}
.form-textarea{width:100%;min-height:80px;padding:10px 12px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:8px;resize:vertical;font-family:inherit}
.form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(10,132,255,.2)}

/* Progress card styles */
.progress-layout-full{display:flex;flex-direction:column;gap:12px;flex:1;overflow-y:auto}
.progress-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media(max-width:1100px){.progress-row{grid-template-columns:1fr}}
.card{background:var(--bg2);border:none;border-radius:14px;padding:16px;display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.card-title{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.card-title a{font-size:12px;color:var(--accent);cursor:pointer;text-transform:none;font-weight:500}
.insights-grid{display:flex;flex-direction:column;gap:8px}
.ins-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)}
.ins-row:last-child{border-bottom:none}
.ins-label{font-size:12px;color:var(--text2)}
.ins-val{font-size:13px;font-weight:600;color:var(--text)}
.ins-val.green{color:var(--green)}
.ins-val.red{color:var(--red)}
.ins-val.yellow{color:var(--yellow)}

/* Burndown chart */
.burndown-container{background:var(--bg);border-radius:10px;padding:12px;flex:1;display:flex;align-items:center;justify-content:center;min-height:180px}
.burndown-container svg{display:block;width:100%;height:100%}
.burndown-dates{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-top:8px}
.burndown-legend{display:flex;gap:16px;margin-top:8px;justify-content:center}
.legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text2)}
.legend-dot{width:10px;height:10px;border-radius:50%}
.legend-dot.green{background:var(--green)}
.legend-dot.red{background:var(--red)}
.legend-dot.gray{background:var(--text3)}

/* Mobile responsive */
@media(max-width:768px){
  .header{padding:0 12px;gap:8px}
  .logo{min-width:100px;max-width:140px;font-size:14px}
  .header-metrics{display:none}
  .header-search{width:140px}
  .main{padding:10px 12px;padding-top:64px}
  .pipeline{gap:4px}
  .pipe{padding:8px 4px}
  .pipe-count{font-size:14px}
  .pipe-label{font-size:8px}
  .chat-panel{width:calc(100vw - 32px);right:16px;bottom:80px;height:60vh}
  .chat-toggle{width:46px;height:46px}
  .parts-grid{grid-template-columns:20px 20px minmax(60px,1fr) 70px 70px 50px 28px 54px 60px 80px minmax(60px,100px) 28px 28px 28px 28px}
  .notif-panel{width:calc(100vw - 32px);right:0}
}

/* Safe area for notched devices */
@supports(padding:max(0px)){
  .header{padding-left:max(12px,env(safe-area-inset-left));padding-right:max(12px,env(safe-area-inset-right))}
  .main{padding-left:max(10px,env(safe-area-inset-left));padding-right:max(10px,env(safe-area-inset-right));padding-bottom:max(10px,env(safe-area-inset-bottom))}
  .modal{margin-bottom:env(safe-area-inset-bottom)}
}
</style>
</head>
<body>
<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
<div class="login-logo">ðŸ“¦</div>
<div class="login-title">EBS Cloud</div>
<div class="login-subtitle">Parts Pipeline Tracker</div>
<button class="login-google-btn" id="googleSignInBtn">
<svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
Sign in with Google
</button>
<div class="login-divider">secure authentication</div>
<div class="login-info">Your Google account is safe. We only access your name, email, and profile photo for identification.</div>
<div class="login-error" id="loginError"></div>
<div class="login-loading" id="loginLoading"><div class="login-spinner"></div>Signing in...</div>
</div>
</div>

<!-- Sync Indicator -->
<div class="sync-indicator" id="syncIndicator"><div class="sync-dot"></div><span id="syncText">Synced</span></div>

<!-- Header -->
<header class="header">
<div class="logo" id="projectName">EBS v4</div>
<button class="ai-console-btn" id="aiAlert" title="AI Console"><div class="ai-console-icon">+</div>AI Console</button>
<div class="header-spacer"></div>
<div class="online-badge" id="onlineBadge"><div class="online-dot"></div><span id="onlineCount">1 online</span><div class="online-hover" id="onlineHover"><div id="onlineUserList"></div></div></div>
<div class="header-spacer"></div>
<div class="header-search"><input type="text" id="headerSearch" placeholder="Search parts..."><button class="header-search-clear" id="headerSearchClear">Ã—</button></div>
<div class="header-spacer"></div>
<div class="header-metrics">
<div class="hm"><div><div class="hm-label">Ready</div><div class="hm-value" id="sReady">0/0</div></div></div>
<div class="hm" id="hmDays" style="display:none"><div><div class="hm-label">Days</div><div class="hm-value" id="sDays">â€”</div></div></div>
<div class="hm hm-progress" id="hmProgress"><div><div class="hm-label">Progress</div><div class="hm-value" id="sPct">0%</div></div><div class="hm-bar"><div class="hm-bar-fill" id="sBar"></div></div></div>
</div>
<div class="header-btns">
<!-- Notification Bell -->
<div style="position:relative">
<button class="notif-btn" id="notifBtn" title="Notifications">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
<span class="notif-badge" id="notifBadge"></span>
</button>
<div class="notif-panel" id="notifPanel">
<div class="notif-header"><span class="notif-title">Notifications</span><button class="notif-clear" id="notifClear">Mark all read</button></div>
<div class="notif-list" id="notifList"><div class="notif-empty">No notifications</div></div>
</div>
</div>
<button class="btn" id="themeBtn">ðŸŽ¨</button>
<button class="btn btn-receive" id="receivePOBtn">ðŸ“¦ <span>Receive</span></button>
<button class="btn btn-report" id="reportBtn">ðŸ“‹ <span>Report</span></button>
<div class="dropdown"><button class="btn" id="menuBtn">â˜°</button><div class="dropdown-menu" id="menuDrop"><div class="dropdown-item" id="teamBtn">Team</div><div class="dropdown-item" id="datesBtn">Project Dates</div><div class="dropdown-item" id="leadtimeBtn">Lead Time Data</div><div class="dropdown-item" id="itemConfigBtn">Item Code Config</div><div class="dropdown-div"></div><div class="dropdown-item" id="sampleBtn">Reset to Sample Data</div><div class="dropdown-div"></div><div class="dropdown-item danger" id="clearBtn">Clear All</div></div></div>
<!-- User Menu -->
<div class="user-menu" id="userMenu">
<img class="user-avatar" id="userAvatar" src="" alt="User">
<div class="user-dropdown" id="userDropdown">
<div class="user-dropdown-header">
<img class="user-dropdown-avatar" id="userDropdownAvatar" src="" alt="">
<div class="user-dropdown-info">
<div class="user-dropdown-name" id="userDropdownName"></div>
<div class="user-dropdown-email" id="userDropdownEmail"></div>
</div>
</div>
<div class="user-dropdown-item" id="signOutBtn">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
Sign out
</div>
</div>
</div>
<div class="version-badge">v4.0</div>
</div>
</header>

<main class="main">
<div class="pipeline">
<div class="pipe" data-s="to-order"><div class="pipe-count" id="p1">0</div><div class="pipe-label">To Order</div></div>
<div class="pipe" data-s="ordered"><div class="pipe-count" id="p2">0</div><div class="pipe-label">Ordered</div></div>
<div class="pipe" data-s="arrived"><div class="pipe-count" id="p3">0</div><div class="pipe-label">Arrived</div></div>
<div class="pipe" data-s="configured"><div class="pipe-count" id="p4">0</div><div class="pipe-label">Configured</div></div>
<div class="pipe" data-s="tested"><div class="pipe-count" id="p5">0</div><div class="pipe-label">Tested</div></div>
<div class="pipe" data-s="installed"><div class="pipe-count" id="p6">0</div><div class="pipe-label">Installed</div></div>
</div>
<div class="tabs">
<button class="tab active" data-tab="list">Parts List</button>
<button class="tab" data-tab="actions">Action Plan</button>
<button class="tab" data-tab="progress">Progress</button>
<button class="tab" data-tab="gantt">Gantt</button>
</div>
<div class="panel active" id="listPanel">
<div class="toolbar"><select class="filter-select" id="assigneeFilter"><option value="">All Assignees</option></select><button class="toggle-btn" id="expandToggle"><span class="arrow">â–¼</span> Expand</button></div>
<div class="filter-badges" id="filterBadges"></div>
<div class="data-table" id="partsTable"><div class="table-header parts-grid"><div></div><div></div><div>Name</div><div>Code</div><div>Mfr</div><div>Assignee</div><div>Qty</div><div>Status</div><div>Prog</div><div>ETA / PO</div><div>Notes</div><div></div><div></div><div></div><div></div></div><div class="table-body" id="partsList"></div></div>
<div class="empty" id="emptyList" style="display:none;">No items found</div>
</div>
<div class="panel" id="actionsPanel">
<div class="toolbar"><input type="text" class="search" id="actionSearchBox" placeholder="Search actions..."><select class="filter-select" id="actionAssigneeFilter"><option value="">All Assignees</option></select><button class="btn btn-primary" id="addActionBtn">+ Action</button></div>
<div class="data-table" id="actionsTable"><div class="table-header action-grid"><div>Task</div><div>Linked Part</div><div>Created</div><div>Progress</div><div>Due Date</div><div>Assignee</div><div>Status</div><div></div></div><div class="table-body" id="actionsList"></div></div>
<div class="empty" id="emptyActions" style="display:none;">No actions yet</div>
</div>
<div class="panel" id="progressPanel">
<div class="progress-layout-full">
<div class="progress-row">
<div class="card"><div class="card-title">Burndown Chart <a id="burndownEdit">Edit Dates</a></div><div class="burndown-container" id="burndownChart"></div><div class="burndown-dates" id="burndownDates"></div><div class="burndown-legend"><div class="legend-item"><div class="legend-dot green"></div> Ahead</div><div class="legend-item"><div class="legend-dot red"></div> Behind</div><div class="legend-item"><div class="legend-dot gray"></div> Target</div></div></div>
<div class="card"><div class="card-title">Schedule</div><div class="insights-grid">
<div class="ins-row"><span class="ins-label">Days Left</span><span class="ins-val" id="insDays">â€”</span></div>
<div class="ins-row"><span class="ins-label">Status</span><span class="ins-val" id="insStatus">â€”</span></div>
<div class="ins-row"><span class="ins-label">Expected Progress</span><span class="ins-val" id="insExpected">â€”</span></div>
<div class="ins-row"><span class="ins-label">Actual Progress</span><span class="ins-val" id="insActual">â€”</span></div>
<div class="ins-row"><span class="ins-label">Velocity</span><span class="ins-val" id="insRate">â€”</span></div>
<div class="ins-row"><span class="ins-label">Est. Completion</span><span class="ins-val" id="insEst">â€”</span></div>
</div></div>
<div class="card"><div class="card-title">Suppliers</div><div class="insights-grid">
<div class="ins-row"><span class="ins-label">ðŸšš On-Time Delivery</span><span class="ins-val" id="insOTD">â€”</span></div>
<div class="ins-row"><span class="ins-label">ðŸ“¦ Avg Lead Time</span><span class="ins-val" id="insAvgLead">â€”</span></div>
<div class="ins-row"><span class="ins-label">Parts In Transit</span><span class="ins-val" id="insInTransit">â€”</span></div>
<div class="ins-row"><span class="ins-label">Awaiting Order</span><span class="ins-val" id="insToOrder">â€”</span></div>
</div></div>
</div>
</div>
</div>
<div class="panel" id="ganttPanel"></div>
</main>

<!-- Comments Popover -->
<div class="comments-popover" id="commentsPopover">
<div class="comments-header"><span id="commentsTitle">Comments</span><button id="commentsClose">Ã—</button></div>
<div class="comments-list" id="commentsList"></div>
<div class="comments-input"><input type="text" id="commentInput" placeholder="Add a comment... Use @ to mention"><button id="commentAdd">Post</button></div>
</div>

<!-- Mention Dropdown -->
<div class="mention-dropdown" id="mentionDropdown"></div>

<!-- Chat Toggle and Panel -->
<button class="chat-toggle" id="chatToggle" title="Team Chat"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg><span class="chat-badge" id="chatBadge" style="display:none">0</span></button>
<div class="chat-panel" id="chatPanel">
<div class="chat-header"><span class="chat-title">Team Chat</span><button class="chat-close" id="chatClose">Ã—</button></div>
<div class="chat-messages" id="chatMessages" style="display:none"></div>
<div class="chat-input-area" id="chatInputArea" style="display:none"><input type="text" class="chat-input" id="chatInput" placeholder="Type a message..."><button class="chat-send" id="chatSend">â†‘</button></div>
</div>

<!-- Theme Popover -->
<div class="popover-modal theme-popover" id="themeModal">
<div class="modal-header"><span class="modal-title">Theme</span><button class="modal-close" id="themeClose">Ã—</button></div>
<div class="modal-body"><div class="theme-grid" id="themeGrid"></div></div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastBox"></div>

<script>
// ============================================
// Firebase Configuration
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyBxVLT8C-2-Ikp-or2O59Pq4o6bRhKAmLY",
  authDomain: "cloud-eff90.firebaseapp.com",
  databaseURL: "https://cloud-eff90-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cloud-eff90",
  storageBucket: "cloud-eff90.firebasestorage.app",
  messagingSenderId: "70538130924",
  appId: "1:70538130924:web:9e34e90b56e4f3f72ebcc9"
};

// ============================================
// Initialize Firebase
// ============================================
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const projectRef = db.ref('project');

// ============================================
// Current User State
// ============================================
let currentUser = null; // { uid, displayName, email, photoURL }

// ============================================
// App State
// ============================================
const STAGES=['to-order','ordered','arrived','configured','tested','installed'];
const SLABELS={'to-order':'To Order','ordered':'Ordered','arrived':'Arrived','configured':'Configured','tested':'Tested','installed':'Installed'};
const ASTAGES=['not-started','in-progress','completed'];
const ALABELS={'not-started':'Not Started','in-progress':'In Progress','completed':'Completed'};

let data=[],team=[],expanded={},history=[],projectDates={start:'',end:''},actions=[],leadTimeDb={},savedBoms=[],currentProjectName='New Project',allExpanded=false;
let notifications=[]; // {id, type, from:{uid,name,photo}, text, partId, partName, timestamp, read}
let globalCodes=[],globalMfrs=[];
let editId=null,editAsmId=null,editActId=null,editEtaPartId=null,filterStage='',filterAssignee='',filterPO='',searchQ='',actionSearchQ='',actionAssigneeFilter='',highlightActionId=null,highlightPartId=null,bomMode='save';
let isAuthenticated=false,isConnected=false,isSyncing=false;

const $=id=>document.getElementById(id);
const esc=s=>s?String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'):'';
const toast=(msg,e)=>{const t=document.createElement('div');t.className='toast '+(e?'err':'success');t.textContent=msg;$('toastBox').appendChild(t);setTimeout(()=>t.remove(),2500)};

// ============================================
// Date Utilities - NORMALIZED TO EPOCH MS
// ============================================
function toEpoch(dateVal) {
  if (!dateVal) return null;
  if (typeof dateVal === 'number') return dateVal;
  if (typeof dateVal === 'string') return new Date(dateVal).getTime();
  if (dateVal instanceof Date) return dateVal.getTime();
  return null;
}

function formatDateShort(d) {
  if (!d) return 'â€”';
  const dt = new Date(toEpoch(d) || d);
  if (isNaN(dt.getTime())) return 'â€”';
  return dt.getDate() + '.' + (dt.getMonth() + 1) + '.';
}

function formatDateISO(epochMs) {
  if (!epochMs) return '';
  const dt = new Date(epochMs);
  return dt.toISOString().split('T')[0];
}

// ============================================
// Sync Indicator
// ============================================
function showSync(status, text) {
  const ind = $('syncIndicator');
  const txt = $('syncText');
  ind.className = 'sync-indicator active ' + status;
  txt.textContent = text || status;
  if (status === 'synced') setTimeout(() => ind.classList.remove('active'), 2000);
}

// ============================================
// Firebase Data Operations - CRITICAL FIX: Separate save from render
// ============================================
let saveTimeout = null;
let isSaving = false;
let lastSyncShow = 0;
const clientId = 'client-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
const SYNC_SHOW_INTERVAL = 10000;

// CRITICAL FIX: save() no longer calls render() - mutations call both explicitly
function save() {
  if (!isAuthenticated || !currentUser) return;
  
  // Always save to localStorage first
  saveToLocalStorage();
  
  clearTimeout(saveTimeout);
  
  saveTimeout = setTimeout(() => {
    if (isSaving) return;
    isSaving = true;
    
    const now = Date.now();
    const showIndicator = now - lastSyncShow > SYNC_SHOW_INTERVAL;
    if (showIndicator) showSync('syncing', 'Syncing...');
    
    // Use update() for safer multi-user concurrency
    projectRef.child('main').update({
      data, team, history, projectDates, actions, 
      projectName: currentProjectName,
      updatedAt: firebase.database.ServerValue.TIMESTAMP,
      lastEditBy: { uid: currentUser.uid, name: currentUser.displayName }
    }).then(() => {
      isSaving = false;
      recordProgress();
      if (showIndicator) {
        lastSyncShow = Date.now();
        showSync('synced', 'Synced âœ“');
        setTimeout(() => $('syncIndicator').classList.remove('active'), 1500);
      }
    }).catch(e => {
      isSaving = false;
      showSync('offline', 'Save failed');
      console.error(e);
    });
  }, 500);
}

function saveLeadTime() {
  if (!isAuthenticated) return;
  projectRef.child('leadTime').update(leadTimeDb).catch(console.error);
}

function saveBoms() {
  if (!isAuthenticated) return;
  projectRef.child('boms').set(savedBoms).catch(console.error);
}

function saveGlobalCodes() {
  if (!isAuthenticated) return;
  projectRef.child('globalCodes').set(globalCodes).catch(console.error);
}

function saveGlobalMfrs() {
  if (!isAuthenticated) return;
  projectRef.child('globalMfrs').set(globalMfrs).catch(console.error);
}

function saveExpanded() {
  try { localStorage.setItem('ebs-expanded', JSON.stringify(expanded)); } catch (e) {}
}

function loadExpanded() {
  try { const s = localStorage.getItem('ebs-expanded'); if (s) expanded = JSON.parse(s); } catch (e) { expanded = {}; }
}

// ============================================
// Google Authentication
// ============================================
function signInWithGoogle() {
  $('loginLoading').classList.add('visible');
  $('googleSignInBtn').style.display = 'none';
  $('loginError').classList.remove('visible');
  
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });
  
  auth.signInWithPopup(provider).catch(err => {
    console.error('Sign in error:', err);
    $('loginLoading').classList.remove('visible');
    $('googleSignInBtn').style.display = 'flex';
    $('loginError').textContent = err.message || 'Sign in failed. Please try again.';
    $('loginError').classList.add('visible');
  });
}

function signOut() {
  auth.signOut().then(() => {
    location.reload();
  }).catch(err => {
    console.error('Sign out error:', err);
    toast('Sign out failed', true);
  });
}

// Auth state listener
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = {
      uid: user.uid,
      displayName: user.displayName || 'Anonymous',
      email: user.email || '',
      photoURL: user.photoURL || ''
    };
    isAuthenticated = true;
    
    // Update UI
    $('loginScreen').style.display = 'none';
    $('userAvatar').src = currentUser.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23666"/><text x="50" y="65" text-anchor="middle" fill="white" font-size="40">' + (currentUser.displayName?.charAt(0) || '?') + '</text></svg>';
    $('userDropdownAvatar').src = currentUser.photoURL || '';
    $('userDropdownName').textContent = currentUser.displayName;
    $('userDropdownEmail').textContent = currentUser.email;
    
    // Initialize app
    initFirebaseListeners();
    loadNotifications();
  } else {
    currentUser = null;
    isAuthenticated = false;
    $('loginScreen').style.display = 'flex';
    $('loginLoading').classList.remove('visible');
    $('googleSignInBtn').style.display = 'flex';
  }
});

$('googleSignInBtn').onclick = signInWithGoogle;
$('signOutBtn').onclick = signOut;

// User dropdown toggle
$('userAvatar').onclick = () => $('userDropdown').classList.toggle('open');
document.addEventListener('click', e => {
  if (!e.target.closest('#userMenu')) $('userDropdown').classList.remove('open');
});

// ============================================
// Firebase Real-time Listeners
// ============================================
const LOCAL_STORAGE_KEY = 'ebs-v4-data';
let dataInitialized = false;

function initFirebaseListeners() {
  showSync('syncing', 'Loading...');
  
  const localData = loadFromLocalStorage();
  
  if (localData) {
    dataInitialized = true;
    showSync('synced', 'Loaded');
    setTimeout(() => $('syncIndicator').classList.remove('active'), 1500);
    tryFirebaseSync();
  } else {
    tryFirebaseFirst();
  }
}

function tryFirebaseFirst() {
  const timeout = setTimeout(() => {
    console.log('Firebase timeout, creating local sample');
    createAndSaveSampleData();
  }, 3000);
  
  projectRef.child('main').once('value').then(snapshot => {
    clearTimeout(timeout);
    const val = snapshot.val();
    const hasData = val && val.data && (Array.isArray(val.data) ? val.data.length > 0 : Object.keys(val.data).length > 0);
    
    if (hasData) {
      loadFromSnapshot(val);
      saveToLocalStorage();
      dataInitialized = true;
      showSync('synced', 'Connected');
      setTimeout(() => $('syncIndicator').classList.remove('active'), 1500);
      setupRealtimeListener();
      initChat();
      setupPresence();
    } else {
      createAndSaveSampleData();
      projectRef.child('main').set({
        data, team, history, projectDates, actions, projectName: currentProjectName,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
      setupRealtimeListener();
      initChat();
      setupPresence();
    }
  }).catch(err => {
    clearTimeout(timeout);
    console.log('Firebase error:', err);
    createAndSaveSampleData();
  });
}

function tryFirebaseSync() {
  projectRef.child('main').once('value').then(snapshot => {
    const val = snapshot.val();
    if (val && val.data) {
      console.log('Firebase connected, setting up sync');
    }
    setupRealtimeListener();
    initChat();
    setupPresence();
  }).catch(err => {
    console.log('Firebase unavailable');
  });
}

function loadFromLocalStorage() {
  try {
    const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
    if (saved) {
      const val = JSON.parse(saved);
      if (val.data && val.data.length > 0) {
        data = val.data;
        team = val.team || [];
        history = val.history || [];
        actions = val.actions || [];
        projectDates = val.projectDates || { start: '', end: '' };
        currentProjectName = val.projectName || 'EBS Project';
        updateProjectName();
        render();
        return true;
      }
    }
  } catch (e) {
    console.error('localStorage read error:', e);
  }
  return false;
}

function saveToLocalStorage() {
  try {
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
      data, team, history, actions, projectDates, projectName: currentProjectName
    }));
  } catch (e) {
    console.error('localStorage save error:', e);
  }
}

function loadFromSnapshot(val) {
  if (Array.isArray(val.data)) {
    data = val.data;
  } else if (val.data) {
    data = Object.values(val.data);
  }
  team = val.team ? (Array.isArray(val.team) ? val.team : Object.values(val.team)) : [];
  history = val.history ? (Array.isArray(val.history) ? val.history : Object.values(val.history)) : [];
  actions = val.actions ? (Array.isArray(val.actions) ? val.actions : Object.values(val.actions)) : [];
  projectDates = val.projectDates || { start: '', end: '' };
  currentProjectName = val.projectName || 'EBS Project';
  updateProjectName();
  render();
}

function setupRealtimeListener() {
  projectRef.child('main').on('value', snapshot => {
    const val = snapshot.val();
    if (!val) return;
    
    // Skip if this is our own save echoing back
    if (val.lastEditBy && val.lastEditBy.uid === currentUser?.uid) {
      const timeDiff = Date.now() - (val.updatedAt || 0);
      if (timeDiff < 3000) return;
    }
    
    loadFromSnapshot(val);
    saveToLocalStorage();
  });
}

function createAndSaveSampleData() {
  createSampleData();
  saveToLocalStorage();
  dataInitialized = true;
  showSync('synced', 'Ready');
  setTimeout(() => $('syncIndicator').classList.remove('active'), 1500);
  toast('Project initialized with sample data');
}

function createSampleData() {
  const now = Date.now(), day = 86400000;
  
  currentProjectName = 'Industrial Automation Line - Phase 2';
  team = [
    { name: 'Marisa', email: 'marisa@company.com' },
    { name: 'John', email: 'john@company.com' },
    { name: 'Sarah', email: 'sarah@company.com' },
    { name: 'Mike', email: 'mike@company.com' }
  ];
  
  const start = new Date(); start.setDate(start.getDate() - 14);
  const end = new Date(); end.setDate(end.getDate() + 45);
  projectDates = { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] };
  
  // Sample assemblies and parts
  data = [
    { id: 1, name: 'Control Panel', isAsm: true, assignee: 'John', priority: 1 },
    { id: 2, name: 'PLC CPU', code: '6ES7-1500', mfr: 'Siemens', qty: 1, status: 'arrived', parentId: 1, assignee: 'John', orderedAt: now - day * 5, arrivedAt: now - day * 1 },
    { id: 3, name: 'HMI Panel', code: 'KTP700', mfr: 'Siemens', qty: 1, status: 'ordered', parentId: 1, assignee: 'Sarah', orderedAt: now - day * 3, expectedArrival: now + day * 4 },
    { id: 4, name: 'Power Supply 24V', code: 'PS307', mfr: 'Siemens', qty: 2, status: 'to-order', parentId: 1, assignee: 'Mike' },
    { id: 5, name: 'Robot Cell', isAsm: true, assignee: 'Sarah', priority: 2 },
    { id: 6, name: 'Robot Arm 6-Axis', code: 'LR-Mate', mfr: 'Fanuc', qty: 1, status: 'ordered', parentId: 5, assignee: 'Sarah', orderedAt: now - day * 10, expectedArrival: now + day * 10 },
    { id: 7, name: 'Robot Controller', code: 'R-30iB', mfr: 'Fanuc', qty: 1, status: 'to-order', parentId: 5, assignee: 'Sarah' },
    { id: 8, name: 'Safety Scanner', code: 'S300', mfr: 'SICK', qty: 2, status: 'installed', parentId: 5, assignee: 'Mike', orderedAt: now - day * 20, arrivedAt: now - day * 10, installedAt: now - day * 2 },
    { id: 9, name: 'Conveyor System', isAsm: true, assignee: 'Mike', priority: 3 },
    { id: 10, name: 'Belt Conveyor 3m', code: 'BC-3000', mfr: 'Dorner', qty: 2, status: 'tested', parentId: 9, assignee: 'Mike', orderedAt: now - day * 15, arrivedAt: now - day * 5, testedAt: now - day * 1 },
    { id: 11, name: 'Motor Drive VFD', code: 'ATV320', mfr: 'Schneider', qty: 2, status: 'arrived', parentId: 9, assignee: 'John', orderedAt: now - day * 8, arrivedAt: now - day * 2 },
    { id: 12, name: 'Proximity Sensors', code: 'E2E', mfr: 'Omron', qty: 8, status: 'to-order', parentId: 9, assignee: 'Marisa' }
  ];
  
  actions = [
    { id: 1, task: 'Review PLC program with customer', status: 'in-progress', assignee: 'John', dueDate: formatDateISO(now + day * 3), progress: 60, linkedPartId: 2, createdAt: now - day * 5 },
    { id: 2, task: 'Order safety equipment', status: 'not-started', assignee: 'Mike', dueDate: formatDateISO(now + day * 7), progress: 0, createdAt: now - day * 2 }
  ];
  
  history = [];
  updateProjectName();
  render();
}

function updateProjectName() {
  $('projectName').textContent = (currentProjectName || 'EBS Cloud') + ' â˜ï¸';
}

// ============================================
// Online Presence with User Photos
// ============================================
let myPresenceRef = null;

function setupPresence() {
  if (!currentUser) return;
  
  myPresenceRef = projectRef.child('presence').child(currentUser.uid);
  
  const userData = {
    uid: currentUser.uid,
    name: currentUser.displayName,
    photo: currentUser.photoURL || '',
    lastSeen: firebase.database.ServerValue.TIMESTAMP
  };
  
  myPresenceRef.set(userData);
  myPresenceRef.onDisconnect().remove();
  
  // Update presence every 30s
  setInterval(() => {
    if (isAuthenticated && myPresenceRef) {
      myPresenceRef.update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
    }
  }, 30000);
  
  // Listen for online users
  projectRef.child('presence').on('value', snapshot => {
    const users = snapshot.val();
    const now = Date.now();
    let onlineUsers = [];
    
    if (users) {
      Object.values(users).forEach(u => {
        if (u.lastSeen && now - u.lastSeen < 120000) { // 2 min timeout
          onlineUsers.push({
            uid: u.uid,
            name: u.name || 'Anonymous',
            photo: u.photo || '',
            lastSeen: u.lastSeen,
            isMe: u.uid === currentUser?.uid
          });
        }
      });
    }
    
    if (onlineUsers.length === 0 && currentUser) {
      onlineUsers.push({ uid: currentUser.uid, name: 'You', photo: currentUser.photoURL, lastSeen: now, isMe: true });
    }
    
    $('onlineCount').textContent = onlineUsers.length === 1 ? '1 online' : onlineUsers.length + ' online';
    
    // Update hover card with avatars
    $('onlineUserList').innerHTML = onlineUsers.map(u => {
      const ago = Math.floor((now - u.lastSeen) / 1000);
      const timeStr = ago < 60 ? 'now' : ago < 3600 ? Math.floor(ago / 60) + 'm ago' : Math.floor(ago / 3600) + 'h ago';
      const avatarSrc = u.photo || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23666"/><text x="50" y="65" text-anchor="middle" fill="white" font-size="40">' + (u.name?.charAt(0) || '?') + '</text></svg>';
      return '<div class="online-user"><img class="online-user-avatar" src="' + avatarSrc + '" alt=""><div class="online-user-info"><div class="online-user-name">' + esc(u.name) + (u.isMe ? ' (you)' : '') + '</div><div class="online-user-time">' + timeStr + '</div></div></div>';
    }).join('');
  });
}

// ============================================
// Notifications System
// ============================================
function loadNotifications() {
  if (!currentUser) return;
  
  projectRef.child('notifications').child(currentUser.uid).orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
    const val = snapshot.val();
    notifications = val ? Object.entries(val).map(([id, n]) => ({ id, ...n })).reverse() : [];
    updateNotifBadge();
    renderNotifications();
  });
}

function updateNotifBadge() {
  const unread = notifications.filter(n => !n.read).length;
  $('notifBadge').textContent = unread > 99 ? '99+' : unread;
  $('notifBadge').dataset.count = unread;
}

function renderNotifications() {
  if (notifications.length === 0) {
    $('notifList').innerHTML = '<div class="notif-empty">No notifications</div>';
    return;
  }
  
  $('notifList').innerHTML = notifications.slice(0, 20).map(n => {
    const time = new Date(n.timestamp).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    const avatarSrc = n.from?.photo || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23666"/><text x="50" y="65" text-anchor="middle" fill="white" font-size="40">' + (n.from?.name?.charAt(0) || '?') + '</text></svg>';
    return '<div class="notif-item' + (n.read ? '' : ' unread') + '" data-id="' + n.id + '" data-part="' + (n.partId || '') + '"><div class="notif-item-header"><img class="notif-item-avatar" src="' + avatarSrc + '"><span class="notif-item-name">' + esc(n.from?.name || 'Someone') + '</span><span class="notif-item-time">' + time + '</span></div><div class="notif-item-text">' + esc(n.text) + '</div>' + (n.partName ? '<div class="notif-item-context">ðŸ“¦ ' + esc(n.partName) + '</div>' : '') + '</div>';
  }).join('');
  
  // Click handlers
  $('notifList').querySelectorAll('.notif-item').forEach(el => {
    el.onclick = () => {
      const id = el.dataset.id;
      const partId = parseInt(el.dataset.part);
      
      // Mark as read
      projectRef.child('notifications').child(currentUser.uid).child(id).update({ read: true });
      
      // Navigate to part if applicable
      if (partId) {
        highlightPartId = partId;
        const part = data.find(d => d.id === partId);
        if (part && part.parentId) {
          expanded[part.parentId] = true;
          saveExpanded();
        }
        render();
        $('notifPanel').classList.remove('open');
      }
    };
  });
}

function sendNotification(toUid, text, partId, partName) {
  if (!currentUser || toUid === currentUser.uid) return;
  
  projectRef.child('notifications').child(toUid).push({
    type: 'mention',
    from: { uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL },
    text: text,
    partId: partId || null,
    partName: partName || null,
    timestamp: firebase.database.ServerValue.TIMESTAMP,
    read: false
  });
}

// Notification panel toggle
$('notifBtn').onclick = e => {
  e.stopPropagation();
  $('notifPanel').classList.toggle('open');
};

$('notifClear').onclick = () => {
  if (!currentUser) return;
  notifications.forEach(n => {
    if (!n.read) {
      projectRef.child('notifications').child(currentUser.uid).child(n.id).update({ read: true });
    }
  });
};

document.addEventListener('click', e => {
  if (!e.target.closest('#notifBtn') && !e.target.closest('#notifPanel')) {
    $('notifPanel').classList.remove('open');
  }
});

// ============================================
// Chat System
// ============================================
let lastMessageId = null;
let chatOpen = false;
let unreadChatCount = 0;
let chatInitialized = false;

function updateChatBadge() {
  const badge = $('chatBadge');
  if (unreadChatCount > 0) {
    badge.textContent = unreadChatCount > 99 ? '99+' : unreadChatCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

function initChat() {
  if (!currentUser) return;
  
  showChatInterface();
  
  // Load initial messages
  projectRef.child('chat').orderByChild('timestamp').limitToLast(50).once('value', snapshot => {
    setTimeout(() => { chatInitialized = true; }, 500);
  });
  
  // Listen for new messages
  projectRef.child('chat').orderByChild('timestamp').limitToLast(50).on('child_added', snapshot => {
    const msg = snapshot.val();
    if (msg && currentUser) {
      addMessageToUI(msg, snapshot.key);
      if (chatInitialized && !chatOpen && msg.uid !== currentUser.uid) {
        unreadChatCount++;
        updateChatBadge();
      }
    }
  });
}

function showChatInterface() {
  $('chatMessages').style.display = 'flex';
  $('chatInputArea').style.display = 'flex';
  
  unreadChatCount = 0;
  updateChatBadge();
  
  projectRef.child('chat').orderByChild('timestamp').limitToLast(50).once('value', snapshot => {
    const msgs = snapshot.val();
    if (msgs) {
      $('chatMessages').innerHTML = '';
      Object.entries(msgs).forEach(([key, msg]) => addMessageToUI(msg, key));
      scrollChatToBottom();
    } else {
      $('chatMessages').innerHTML = '<div class="chat-empty">No messages yet.<br>Start the conversation!</div>';
    }
  });
}

function addMessageToUI(msg, key) {
  if (lastMessageId === key) return;
  lastMessageId = key;
  
  const container = $('chatMessages');
  const empty = container.querySelector('.chat-empty');
  if (empty) empty.remove();
  
  const isMine = msg.uid === currentUser?.uid;
  const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  const div = document.createElement('div');
  div.className = 'chat-msg ' + (isMine ? 'mine' : 'other');
  div.innerHTML = (isMine ? '' : '<div class="chat-msg-name">' + esc(msg.name) + '</div>') + esc(msg.text) + '<div class="chat-msg-time">' + time + '</div>';
  container.appendChild(div);
  scrollChatToBottom();
}

function scrollChatToBottom() {
  const container = $('chatMessages');
  container.scrollTop = container.scrollHeight;
}

function sendMessage() {
  const input = $('chatInput');
  const text = input.value.trim();
  if (!text || !currentUser) return;
  
  projectRef.child('chat').push({
    uid: currentUser.uid,
    name: currentUser.displayName,
    photo: currentUser.photoURL,
    text: text,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
  
  input.value = '';
}

$('chatToggle').onclick = () => {
  chatOpen = !chatOpen;
  $('chatPanel').classList.toggle('open', chatOpen);
  if (chatOpen) {
    unreadChatCount = 0;
    updateChatBadge();
    scrollChatToBottom();
  }
};

$('chatClose').onclick = () => {
  chatOpen = false;
  $('chatPanel').classList.remove('open');
};

$('chatSend').onclick = sendMessage;
$('chatInput').onkeydown = e => { if (e.key === 'Enter') sendMessage(); };

// ============================================
// Comments with @Mentions
// ============================================
let currentCommentPartId = null;
let mentionQuery = '';
let mentionStart = -1;
let mentionSelectedIdx = 0;

function getMentionableUsers() {
  // Combine team + online users
  const users = [];
  const seen = new Set();
  
  // Add team members
  team.forEach(t => {
    if (!seen.has(t.name)) {
      seen.add(t.name);
      users.push({ name: t.name, email: t.email, photo: '' });
    }
  });
  
  return users;
}

function showMentionDropdown(query, inputEl) {
  const users = getMentionableUsers().filter(u => u.name.toLowerCase().includes(query.toLowerCase()));
  
  if (users.length === 0) {
    $('mentionDropdown').classList.remove('open');
    return;
  }
  
  const rect = inputEl.getBoundingClientRect();
  const dropdown = $('mentionDropdown');
  dropdown.style.left = rect.left + 'px';
  dropdown.style.top = (rect.top - Math.min(users.length, 5) * 48 - 8) + 'px';
  
  dropdown.innerHTML = users.slice(0, 5).map((u, i) => {
    const avatarSrc = u.photo || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23666"/><text x="50" y="65" text-anchor="middle" fill="white" font-size="40">' + (u.name?.charAt(0) || '?') + '</text></svg>';
    return '<div class="mention-item' + (i === mentionSelectedIdx ? ' selected' : '') + '" data-name="' + esc(u.name) + '"><img class="mention-item-avatar" src="' + avatarSrc + '"><span class="mention-item-name">' + esc(u.name) + '</span></div>';
  }).join('');
  
  dropdown.classList.add('open');
  
  dropdown.querySelectorAll('.mention-item').forEach(el => {
    el.onclick = () => insertMention(el.dataset.name);
  });
}

function hideMentionDropdown() {
  $('mentionDropdown').classList.remove('open');
  mentionStart = -1;
  mentionQuery = '';
  mentionSelectedIdx = 0;
}

function insertMention(name) {
  const input = $('commentInput');
  const before = input.value.substring(0, mentionStart);
  const after = input.value.substring(input.selectionStart);
  input.value = before + '@' + name + ' ' + after;
  input.focus();
  hideMentionDropdown();
}

$('commentInput').oninput = e => {
  const val = e.target.value;
  const pos = e.target.selectionStart;
  
  // Check for @ trigger
  const beforeCursor = val.substring(0, pos);
  const atIdx = beforeCursor.lastIndexOf('@');
  
  if (atIdx >= 0 && (atIdx === 0 || beforeCursor[atIdx - 1] === ' ')) {
    const query = beforeCursor.substring(atIdx + 1);
    if (!query.includes(' ')) {
      mentionStart = atIdx;
      mentionQuery = query;
      showMentionDropdown(query, e.target);
      return;
    }
  }
  
  hideMentionDropdown();
};

$('commentInput').onkeydown = e => {
  const dropdown = $('mentionDropdown');
  
  if (dropdown.classList.contains('open')) {
    const items = dropdown.querySelectorAll('.mention-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      mentionSelectedIdx = Math.min(mentionSelectedIdx + 1, items.length - 1);
      items.forEach((el, i) => el.classList.toggle('selected', i === mentionSelectedIdx));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      mentionSelectedIdx = Math.max(mentionSelectedIdx - 1, 0);
      items.forEach((el, i) => el.classList.toggle('selected', i === mentionSelectedIdx));
    } else if (e.key === 'Enter' || e.key === 'Tab') {
      e.preventDefault();
      const selected = items[mentionSelectedIdx];
      if (selected) insertMention(selected.dataset.name);
    } else if (e.key === 'Escape') {
      hideMentionDropdown();
    }
  } else if (e.key === 'Enter') {
    $('commentAdd').click();
  }
};

window.openComments = function(partId, e) {
  currentCommentPartId = partId;
  const part = data.find(d => d.id === partId);
  $('commentsTitle').textContent = 'Comments: ' + (part ? part.name.substring(0, 20) : 'Part');
  
  const popover = $('commentsPopover');
  const btn = e ? e.target.closest('button') : null;
  if (btn) {
    const rect = btn.getBoundingClientRect();
    let top = rect.bottom + 8;
    let left = rect.left;
    if (left + 300 > window.innerWidth) left = window.innerWidth - 310;
    if (top + 400 > window.innerHeight) top = rect.top - 400 - 8;
    popover.style.top = Math.max(10, top) + 'px';
    popover.style.left = Math.max(10, left) + 'px';
  }
  
  loadComments(partId);
  popover.classList.add('open');
};

function loadComments(partId) {
  const part = data.find(d => d.id === partId);
  const comments = part?.comments || [];
  
  if (comments.length === 0) {
    $('commentsList').innerHTML = '<div class="comments-empty">No comments yet.<br>Use @name to mention someone.</div>';
  } else {
    $('commentsList').innerHTML = comments.map(c => {
      const time = new Date(c.ts || c.timestamp).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      const avatarSrc = c.photo || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23666"/><text x="50" y="65" text-anchor="middle" fill="white" font-size="40">' + (c.author?.charAt(0) || '?') + '</text></svg>';
      // Render mentions with highlight
      const textWithMentions = esc(c.text).replace(/@(\w+)/g, '<span class="mention">@$1</span>');
      return '<div class="comment-item"><div class="comment-author"><img class="comment-author-avatar" src="' + avatarSrc + '"><span class="comment-author-name">' + esc(c.author) + '</span></div><div class="comment-text">' + textWithMentions + '</div><div class="comment-time">' + time + '</div></div>';
    }).join('');
  }
}

$('commentsClose').onclick = () => {
  $('commentsPopover').classList.remove('open');
  currentCommentPartId = null;
  hideMentionDropdown();
};

document.addEventListener('click', e => {
  const popover = $('commentsPopover');
  if (popover.classList.contains('open') && !popover.contains(e.target) && !e.target.closest('.comment-btn') && !e.target.closest('#mentionDropdown')) {
    popover.classList.remove('open');
    currentCommentPartId = null;
    hideMentionDropdown();
  }
});

$('commentAdd').onclick = () => {
  const input = $('commentInput');
  const text = input.value.trim();
  if (!text || !currentCommentPartId || !currentUser) return;
  
  const part = data.find(d => d.id === currentCommentPartId);
  if (!part) return;
  
  if (!part.comments) part.comments = [];
  part.comments.push({
    author: currentUser.displayName,
    uid: currentUser.uid,
    photo: currentUser.photoURL,
    text: text,
    ts: Date.now()
  });
  
  // Extract mentions and send notifications
  const mentions = text.match(/@(\w+)/g);
  if (mentions) {
    mentions.forEach(m => {
      const name = m.substring(1);
      const teamMember = team.find(t => t.name.toLowerCase() === name.toLowerCase());
      if (teamMember) {
        // For now, we don't have UIDs for team members, so skip notification
        // In a real app, you'd map team member emails to UIDs
        console.log('Would notify:', name);
      }
    });
  }
  
  save();
  loadComments(currentCommentPartId);
  input.value = '';
  render();
};

// ============================================
// Core Render Function
// ============================================
function getParts() { return data.filter(d => !d.isAsm); }
function getAsms() { return data.filter(d => d.isAsm).sort((a, b) => (a.priority || 0) - (b.priority || 0)); }
function calcProgress(part) {
  const stages = ['to-order', 'ordered', 'arrived', 'configured', 'tested', 'installed'];
  const idx = stages.indexOf(part.status);
  return idx < 0 ? 0 : Math.round((idx / (stages.length - 1)) * 100);
}
function calcOverallProgress() {
  const parts = getParts();
  if (!parts.length) return 0;
  return Math.round(parts.reduce((s, p) => s + calcProgress(p), 0) / parts.length);
}
function getExpectedProgress() {
  if (!projectDates.start || !projectDates.end) return null;
  const start = new Date(projectDates.start), end = new Date(projectDates.end), now = new Date();
  const total = end - start, elapsed = now - start;
  if (total <= 0) return null;
  return Math.min(100, Math.max(0, Math.round((elapsed / total) * 100)));
}
function isOnSchedule() {
  const exp = getExpectedProgress();
  if (exp === null) return true;
  return calcOverallProgress() >= exp - 5;
}
function getScheduleColor() {
  const exp = getExpectedProgress(), act = calcOverallProgress();
  if (exp === null) return 'var(--text)';
  const diff = act - exp;
  if (diff >= 5) return 'var(--green)';
  if (diff <= -10) return 'var(--red)';
  if (diff <= -5) return 'var(--yellow)';
  return 'var(--green)';
}
function getDaysLeft() {
  if (!projectDates.end) return null;
  return Math.ceil((new Date(projectDates.end) - new Date()) / 86400000);
}
function recordProgress() {
  const today = new Date().toISOString().split('T')[0];
  const pct = calcOverallProgress();
  const idx = history.findIndex(h => h.date === today);
  if (idx >= 0) history[idx].pct = pct;
  else history.push({ date: today, pct });
  if (history.length > 100) history = history.slice(-100);
}

function render() {
  try {
    updateProjectName();
    const parts = getParts(), asms = getAsms();
    const pct = calcOverallProgress(), daysLeft = getDaysLeft();
    const readyCount = parts.filter(p => p.status === 'installed').length;

    $('sReady').textContent = readyCount + '/' + parts.length;
    $('sReady').style.color = parts.length ? (readyCount === parts.length ? 'var(--green)' : 'var(--text)') : 'var(--text3)';
    const scheduleColor = getScheduleColor();
    $('sPct').textContent = pct + '%';
    $('sPct').style.color = scheduleColor;
    $('sBar').style.width = pct + '%';
    $('sBar').style.background = scheduleColor;

    if (daysLeft !== null) {
      $('hmDays').style.display = 'block';
      $('sDays').textContent = daysLeft + 'd';
      $('sDays').className = 'hm-value ' + (daysLeft < 3 ? 'red' : daysLeft < 7 ? 'yellow' : '');
    } else {
      $('hmDays').style.display = 'none';
    }

    $('p1').textContent = parts.filter(p => p.status === 'to-order').length;
    $('p2').textContent = parts.filter(p => p.status === 'ordered').length;
    $('p3').textContent = parts.filter(p => p.status === 'arrived').length;
    $('p4').textContent = parts.filter(p => p.status === 'configured').length;
    $('p5').textContent = parts.filter(p => p.status === 'tested').length;
    $('p6').textContent = parts.filter(p => p.status === 'installed').length;

    document.querySelectorAll('.pipe').forEach(p => p.classList.toggle('active', p.dataset.s === filterStage));
    updateSelects();
    updateExpandToggle();
    renderInsights();
    renderActions();

    let badges = '';
    if (filterStage) badges += '<span class="filter-badge">' + SLABELS[filterStage] + ' <button onclick="window.clearStageFilter()">Ã—</button></span>';
    if (filterAssignee) badges += '<span class="filter-badge">' + esc(filterAssignee) + ' <button onclick="window.clearAssigneeFilter()">Ã—</button></span>';
    $('filterBadges').innerHTML = badges;

    let html = '<div class="add-row"><button class="add-row-btn" onclick="window.addNewAsm()">+</button><span class="add-row-text">Add assembly</span></div>';

    asms.forEach(asm => {
      const kids = data.filter(d => d.parentId === asm.id);
      const matchingKids = kids.filter(matchPart);
      const asmMatch = !filterAssignee || asm.assignee === filterAssignee;
      if ((filterStage || filterAssignee) && !matchingKids.length && !asmMatch) return;
      if (searchQ && asm.name.toLowerCase().indexOf(searchQ.toLowerCase()) === -1 && !matchingKids.length) return;
      const isExp = (filterStage || filterAssignee) ? true : expanded[asm.id];
      html += renderAsm({ type: 'asm', item: asm, kids: kids.length, match: matchingKids.length, exp: isExp });
      if (isExp) {
        const visibleKids = (filterStage || filterAssignee) ? matchingKids : kids.filter(matchPart);
        visibleKids.forEach(k => { html += renderPart({ type: 'part', item: k, child: true }); });
        html += '<div class="add-row" style="padding-left:44px"><button class="add-row-btn" onclick="window.addNewPart(' + asm.id + ')">+</button><span class="add-row-text">Add part to ' + esc(asm.name) + '</span></div>';
      }
    });

    data.filter(d => !d.isAsm && !d.parentId).filter(matchPart).forEach(p => { html += renderPart({ type: 'part', item: p, child: false }); });
    $('partsList').innerHTML = html;
    $('partsTable').style.display = 'flex';
    $('emptyList').style.display = 'none';

    if (highlightPartId) {
      setTimeout(() => {
        const row = document.querySelector('[data-part-id="' + highlightPartId + '"]');
        if (row) {
          row.classList.add('highlight');
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => row.classList.remove('highlight'), 1500);
        }
        highlightPartId = null;
      }, 50);
    }
  } catch (err) {
    console.error('Render error:', err);
  }
}

const matchPart = p => {
  if (filterStage && p.status !== filterStage) return false;
  if (filterAssignee && p.assignee !== filterAssignee) return false;
  if (searchQ && [p.name, p.assignee, p.code, p.mfr].join(' ').toLowerCase().indexOf(searchQ.toLowerCase()) === -1) return false;
  return true;
};

function renderAsm(r) {
  const a = r.item;
  const kids = data.filter(d => d.parentId === a.id);
  const pct = kids.length ? Math.round(kids.reduce((s, k) => s + calcProgress(k), 0) / kids.length) : 0;
  const pctColor = pct >= 80 ? 'var(--green)' : pct >= 40 ? 'var(--yellow)' : 'var(--red)';
  const commentCount = kids.reduce((s, k) => s + (k.comments?.length || 0), 0);
  
  return '<div class="asm-row" onclick="window.toggleAsmRow(event,' + a.id + ')" data-asm-id="' + a.id + '"><div class="asm-priority"><button class="asm-priority-btn" onclick="event.stopPropagation();window.moveAsmUp(' + a.id + ')">â–²</button><button class="asm-priority-btn" onclick="event.stopPropagation();window.moveAsmDown(' + a.id + ')">â–¼</button></div><div></div><div class="asm-toggle">' + (r.exp ? 'â–¼' : 'â–¶') + '</div><div class="asm-name">' + esc(a.name) + '</div><div class="asm-meta">' + r.kids + ' parts</div><div></div><div></div><div></div><div></div><div class="asm-progress"><div class="asm-bar"><div class="asm-bar-fill" style="width:' + pct + '%;background-color:' + pctColor + '"></div></div><span class="asm-pct" style="color:' + pctColor + '">' + pct + '%</span></div><div></div><div class="asm-actions"><button class="sm-btn" onclick="event.stopPropagation();window.editAsm(' + a.id + ')">âœï¸</button><button class="sm-btn red" onclick="event.stopPropagation();window.confirmDeleteAsm(' + a.id + ')">ðŸ—‘</button></div><div>' + (commentCount ? '<span style="font-size:11px;color:var(--text3)">' + commentCount + ' ðŸ’¬</span>' : '') + '</div></div>';
}

function renderPart(r) {
  const p = r.item;
  const pct = calcProgress(p);
  const pctColor = pct >= 80 ? 'var(--green)' : pct >= 40 ? 'var(--yellow)' : 'var(--red)';
  const commentCount = p.comments?.length || 0;
  const etaDisplay = p.expectedArrival ? formatDateShort(p.expectedArrival) : (p.poNumber ? '' : 'â€”');
  
  return '<div class="part-row' + (r.child ? ' child' : '') + ' parts-grid" data-part-id="' + p.id + '"><div></div><div class="part-indent">' + (r.child ? 'â””' : '') + '</div><div class="cell" onclick="window.editPartName(' + p.id + ',event)">' + esc(p.name) + '</div><div class="cell muted" onclick="window.editPartCode(' + p.id + ',event)">' + esc(p.code || 'â€”') + '</div><div class="cell muted" onclick="window.editPartMfr(' + p.id + ',event)">' + esc(p.mfr || 'â€”') + '</div><div class="cell muted" onclick="window.editPartAssignee(' + p.id + ',event)">' + esc(p.assignee || 'â€”') + '</div><div class="cell" onclick="window.editPartQty(' + p.id + ',event)">' + (p.qty || 1) + '</div><div><span class="status-badge ' + p.status + '">' + SLABELS[p.status] + '</span></div><div style="display:flex;align-items:center;gap:4px"><div style="width:40px;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden"><div style="width:' + pct + '%;height:100%;background:' + pctColor + '"></div></div><span style="font-size:10px;color:' + pctColor + '">' + pct + '%</span></div><div class="eta-cell"><span class="eta-date">' + etaDisplay + '</span>' + (p.poNumber ? '<span class="eta-po">' + esc(p.poNumber) + '</span>' : '') + '</div><div class="cell note" onclick="window.editPartNotes(' + p.id + ',event)">' + esc(p.notes || '') + '</div><button class="comment-btn' + (commentCount ? ' has-comments' : '') + '" onclick="window.openComments(' + p.id + ',event)">ðŸ’¬' + (commentCount ? '<span class="comment-count">' + commentCount + '</span>' : '') + '</button><button class="adv-btn' + (p.status === 'installed' ? ' done' : '') + '" onclick="window.advancePart(' + p.id + ')" title="' + (p.status === 'installed' ? 'Complete' : 'Advance') + '">' + (p.status === 'installed' ? 'âœ“' : 'â†’') + '</button><button class="sm-btn" onclick="window.editPart(' + p.id + ')">âœï¸</button><button class="sm-btn red" onclick="window.confirmDeletePart(' + p.id + ')">ðŸ—‘</button></div>';
}

function renderInsights() {
  const daysLeft = getDaysLeft(), pct = calcOverallProgress(), expected = getExpectedProgress();
  const parts = getParts();

  $('insDays').textContent = daysLeft !== null ? daysLeft + 'd' : 'â€”';
  $('insDays').className = 'ins-val' + (daysLeft !== null && daysLeft < 3 ? ' red' : daysLeft !== null && daysLeft < 7 ? ' yellow' : '');

  if (expected !== null) {
    const diff = pct - expected;
    if (diff >= 5) { $('insStatus').textContent = 'Ahead'; $('insStatus').className = 'ins-val green'; }
    else if (diff <= -5) { $('insStatus').textContent = 'Behind'; $('insStatus').className = 'ins-val red'; }
    else { $('insStatus').textContent = 'On Track'; $('insStatus').className = 'ins-val green'; }
    $('insExpected').textContent = expected + '%';
  } else {
    $('insStatus').textContent = 'â€”';
    $('insExpected').textContent = 'â€”';
  }

  $('insActual').textContent = pct + '%';
  $('insRate').textContent = 'â€”';
  $('insEst').textContent = 'â€”';
  $('insOTD').textContent = 'â€”';
  $('insAvgLead').textContent = 'â€”';
  $('insInTransit').textContent = parts.filter(p => p.status === 'ordered').length;
  $('insToOrder').textContent = parts.filter(p => p.status === 'to-order').length;
}

function renderActions() {
  const filtered = actions.filter(a => {
    if (actionSearchQ && !a.task.toLowerCase().includes(actionSearchQ.toLowerCase())) return false;
    if (actionAssigneeFilter && a.assignee !== actionAssigneeFilter) return false;
    return true;
  });

  if (!filtered.length) {
    $('actionsList').innerHTML = '';
    $('emptyActions').style.display = 'flex';
    return;
  }

  $('emptyActions').style.display = 'none';
  $('actionsList').innerHTML = filtered.map(a => {
    const linkedPart = a.linkedPartId ? data.find(d => d.id === a.linkedPartId) : null;
    const created = a.createdAt ? formatDateShort(a.createdAt) : 'â€”';
    const pctColor = a.progress >= 80 ? 'var(--green)' : a.progress >= 40 ? 'var(--yellow)' : 'var(--red)';
    return '<div class="action-row action-grid" data-action-id="' + a.id + '"><div class="action-task' + (a.status === 'completed' ? ' completed' : '') + '">' + esc(a.task) + '</div><div class="action-link">' + (linkedPart ? esc(linkedPart.name) : 'â€”') + '</div><div class="action-due">' + created + '</div><div><div class="action-progress-bar"><div class="action-progress-fill" style="width:' + a.progress + '%;background:' + pctColor + '"></div></div></div><div class="action-due">' + (a.dueDate || 'â€”') + '</div><div class="cell muted">' + esc(a.assignee || 'â€”') + '</div><div><span class="action-status ' + a.status + '">' + ALABELS[a.status] + '</span></div><div><button class="sm-btn" onclick="window.editAction(' + a.id + ')">âœï¸</button></div></div>';
  }).join('');
}

function updateSelects() {
  const opts = '<option value="">â€”</option>' + team.map(t => '<option value="' + esc(t.name) + '">' + esc(t.name) + '</option>').join('');
  $('assigneeFilter').innerHTML = '<option value="">All</option>' + team.map(t => '<option value="' + esc(t.name) + '">' + esc(t.name) + '</option>').join('');
  $('actionAssigneeFilter').innerHTML = '<option value="">All Assignees</option>' + team.map(t => '<option value="' + esc(t.name) + '">' + esc(t.name) + '</option>').join('');
}

function updateExpandToggle() {
  const btn = $('expandToggle');
  const asms = getAsms();
  const expandedCount = asms.filter(a => expanded[a.id]).length;
  allExpanded = expandedCount > asms.length / 2;
  btn.innerHTML = allExpanded ? '<span class="arrow">â–²</span> Collapse' : '<span class="arrow">â–¼</span> Expand';
  btn.classList.toggle('expanded', allExpanded);
}

// ============================================
// Event Handlers
// ============================================
window.toggleAsmRow = function(e, id) {
  if (e.target.closest('.asm-actions') || e.target.closest('.cell') || e.target.closest('.asm-priority')) return;
  expanded[id] = !expanded[id];
  saveExpanded();
  render();
};

window.moveAsmUp = function(id) {
  const asms = getAsms();
  const idx = asms.findIndex(a => a.id === id);
  if (idx <= 0) return;
  const current = asms[idx], prev = asms[idx - 1];
  const tempPriority = current.priority;
  current.priority = prev.priority;
  prev.priority = tempPriority;
  save();
  render();
};

window.moveAsmDown = function(id) {
  const asms = getAsms();
  const idx = asms.findIndex(a => a.id === id);
  if (idx < 0 || idx >= asms.length - 1) return;
  const current = asms[idx], next = asms[idx + 1];
  const tempPriority = current.priority;
  current.priority = next.priority;
  next.priority = tempPriority;
  save();
  render();
};

window.addNewAsm = function() {
  const id = Date.now(), asms = getAsms();
  const maxP = asms.length ? Math.max(...asms.map(a => a.priority || 0)) : 0;
  data.push({ id, name: 'New Assembly', isAsm: true, assignee: '', priority: maxP + 1 });
  expanded[id] = true;
  save();
  render();
  toast('Assembly added');
};

window.addNewPart = function(asmId) {
  const id = Date.now();
  data.push({ id, name: 'New Part', parentId: asmId, status: 'to-order', qty: 1 });
  save();
  render();
  toast('Part added');
};

window.advancePart = function(id) {
  const part = data.find(d => d.id === id);
  if (!part) return;
  const stages = STAGES;
  const idx = stages.indexOf(part.status);
  if (idx < stages.length - 1) {
    const newStatus = stages[idx + 1];
    part.status = newStatus;
    
    // Record timestamps - all in epoch ms
    const now = Date.now();
    if (newStatus === 'ordered') part.orderedAt = now;
    else if (newStatus === 'arrived') part.arrivedAt = now;
    else if (newStatus === 'configured') part.configuredAt = now;
    else if (newStatus === 'tested') part.testedAt = now;
    else if (newStatus === 'installed') part.installedAt = now;
    
    save();
    render();
    toast(part.name + ' â†’ ' + SLABELS[newStatus]);
  }
};

window.confirmDeletePart = function(id) {
  if (confirm('Delete this part?')) {
    data = data.filter(d => d.id !== id);
    save();
    render();
    toast('Part deleted');
  }
};

window.confirmDeleteAsm = function(id) {
  const kids = data.filter(d => d.parentId === id);
  if (confirm('Delete this assembly' + (kids.length ? ' and ' + kids.length + ' parts?' : '?'))) {
    data = data.filter(d => d.id !== id && d.parentId !== id);
    save();
    render();
    toast('Assembly deleted');
  }
};

// Inline editing
window.editPartName = function(id, e) {
  const cell = e.target.closest('.cell');
  const part = data.find(d => d.id === id);
  if (!part) return;
  cell.classList.add('editing');
  cell.innerHTML = '<input type="text" value="' + esc(part.name) + '">';
  const input = cell.querySelector('input');
  input.focus();
  input.select();
  input.onblur = () => {
    part.name = input.value.trim() || 'Unnamed';
    cell.classList.remove('editing');
    save();
    render();
  };
  input.onkeydown = e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { cell.classList.remove('editing'); render(); } };
};

window.editPartCode = function(id, e) {
  const cell = e.target.closest('.cell');
  const part = data.find(d => d.id === id);
  if (!part) return;
  cell.classList.add('editing');
  cell.innerHTML = '<input type="text" value="' + esc(part.code || '') + '">';
  const input = cell.querySelector('input');
  input.focus();
  input.onblur = () => {
    part.code = input.value.trim();
    cell.classList.remove('editing');
    save();
    render();
  };
  input.onkeydown = e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { cell.classList.remove('editing'); render(); } };
};

window.editPartMfr = function(id, e) {
  const cell = e.target.closest('.cell');
  const part = data.find(d => d.id === id);
  if (!part) return;
  cell.classList.add('editing');
  cell.innerHTML = '<input type="text" value="' + esc(part.mfr || '') + '">';
  const input = cell.querySelector('input');
  input.focus();
  input.onblur = () => {
    part.mfr = input.value.trim();
    cell.classList.remove('editing');
    save();
    render();
  };
  input.onkeydown = e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { cell.classList.remove('editing'); render(); } };
};

window.editPartAssignee = function(id, e) {
  const cell = e.target.closest('.cell');
  const part = data.find(d => d.id === id);
  if (!part) return;
  cell.classList.add('editing');
  const opts = '<option value="">â€”</option>' + team.map(t => '<option value="' + esc(t.name) + '"' + (part.assignee === t.name ? ' selected' : '') + '>' + esc(t.name) + '</option>').join('');
  cell.innerHTML = '<select>' + opts + '</select>';
  const select = cell.querySelector('select');
  select.focus();
  select.onchange = () => {
    part.assignee = select.value;
    cell.classList.remove('editing');
    save();
    render();
  };
  select.onblur = () => { cell.classList.remove('editing'); render(); };
};

window.editPartQty = function(id, e) {
  const cell = e.target.closest('.cell');
  const part = data.find(d => d.id === id);
  if (!part) return;
  cell.classList.add('editing');
  cell.innerHTML = '<input type="number" min="1" value="' + (part.qty || 1) + '">';
  const input = cell.querySelector('input');
  input.focus();
  input.select();
  input.onblur = () => {
    part.qty = Math.max(1, parseInt(input.value) || 1);
    cell.classList.remove('editing');
    save();
    render();
  };
  input.onkeydown = e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { cell.classList.remove('editing'); render(); } };
};

window.editPartNotes = function(id, e) {
  const cell = e.target.closest('.cell');
  const part = data.find(d => d.id === id);
  if (!part) return;
  cell.classList.add('editing');
  cell.innerHTML = '<input type="text" value="' + esc(part.notes || '') + '" placeholder="Add notes...">';
  const input = cell.querySelector('input');
  input.focus();
  input.onblur = () => {
    part.notes = input.value.trim();
    cell.classList.remove('editing');
    save();
    render();
  };
  input.onkeydown = e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { cell.classList.remove('editing'); render(); } };
};

window.editPart = function(id) { toast('Edit part modal - implement as needed'); };
window.editAsm = function(id) { toast('Edit assembly modal - implement as needed'); };
window.editAction = function(id) { toast('Edit action modal - implement as needed'); };

window.clearStageFilter = function() { filterStage = ''; render(); };
window.clearAssigneeFilter = function() { filterAssignee = ''; render(); };

// Pipeline filter
document.querySelectorAll('.pipe').forEach(p => {
  p.onclick = () => {
    filterStage = filterStage === p.dataset.s ? '' : p.dataset.s;
    render();
  };
});

// Assignee filter
$('assigneeFilter').onchange = e => {
  filterAssignee = e.target.value;
  render();
};

// Expand toggle
$('expandToggle').onclick = () => {
  const asms = getAsms();
  asms.forEach(a => expanded[a.id] = !allExpanded);
  saveExpanded();
  render();
};

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    $(tab.dataset.tab + 'Panel').classList.add('active');
    if (tab.dataset.tab === 'progress') renderBurndown();
  };
});

// Search
$('headerSearch').oninput = e => {
  searchQ = e.target.value;
  $('headerSearchClear').classList.toggle('visible', !!searchQ);
  render();
};
$('headerSearchClear').onclick = () => {
  $('headerSearch').value = '';
  searchQ = '';
  $('headerSearchClear').classList.remove('visible');
  render();
};

// Action search
$('actionSearchBox').oninput = e => {
  actionSearchQ = e.target.value;
  renderActions();
};
$('actionAssigneeFilter').onchange = e => {
  actionAssigneeFilter = e.target.value;
  renderActions();
};

// Menu dropdown
$('menuBtn').onclick = e => {
  e.stopPropagation();
  $('menuDrop').classList.toggle('open');
};
document.addEventListener('click', e => {
  if (!e.target.closest('.dropdown')) $('menuDrop').classList.remove('open');
});

$('sampleBtn').onclick = () => {
  if (confirm('Reset to sample data? This will overwrite current data.')) {
    createSampleData();
    save();
    render();
    toast('Reset to sample data');
    $('menuDrop').classList.remove('open');
  }
};

$('clearBtn').onclick = () => {
  if (confirm('Clear ALL data? This cannot be undone.')) {
    data = [];
    team = [];
    actions = [];
    history = [];
    save();
    render();
    toast('All data cleared');
    $('menuDrop').classList.remove('open');
  }
};

// Theme
const THEMES = [
  { id: 'default', name: 'Claude Dark', colors: { bg: '#2f2f2f', bg2: '#3d3d3d', accent: '#da7756', green: '#5cb85c', red: '#d9534f' } },
  { id: 'claude-light', name: 'Claude Light', colors: { bg: '#f5f4f2', bg2: '#ffffff', accent: '#da7756', green: '#3d8c40', red: '#c44540' } },
  { id: 'graphite', name: 'Graphite', colors: { bg: '#1c1c1e', bg2: '#2c2c2e', accent: '#98989d', green: '#30d158', red: '#ff453a' } },
  { id: 'midnight', name: 'Midnight', colors: { bg: '#0a1628', bg2: '#0f1f33', accent: '#0a84ff', green: '#30d158', red: '#ff453a' } },
  { id: 'forest', name: 'Forest', colors: { bg: '#161d14', bg2: '#1e271a', accent: '#30d158', green: '#32d74b', red: '#ff453a' } },
  { id: 'sunset', name: 'Sunset', colors: { bg: '#1e1614', bg2: '#2a1e1a', accent: '#ff9f0a', green: '#30d158', red: '#ff453a' } },
  { id: 'ocean', name: 'Ocean', colors: { bg: '#0f1a1e', bg2: '#152228', accent: '#64d2ff', green: '#30d158', red: '#ff453a' } },
  { id: 'lavender', name: 'Lavender', colors: { bg: '#1a181e', bg2: '#242028', accent: '#bf5af2', green: '#30d158', red: '#ff453a' } },
  { id: 'highcontrast', name: 'High Contrast', colors: { bg: '#000000', bg2: '#1c1c1e', accent: '#409cff', green: '#30db5b', red: '#ff6961' } }
];
let currentTheme = localStorage.getItem('ebs-theme') || 'default';

function applyTheme(themeId) {
  if (themeId === 'default') document.documentElement.removeAttribute('data-theme');
  else document.documentElement.setAttribute('data-theme', themeId);
  currentTheme = themeId;
  localStorage.setItem('ebs-theme', themeId);
  renderThemeGrid();
}

function renderThemeGrid() {
  const grid = $('themeGrid');
  const lightThemes = ['claude-light'];
  grid.innerHTML = THEMES.map(t => {
    const isActive = t.id === currentTheme;
    const isLight = lightThemes.includes(t.id);
    return '<div class="theme-card' + (isActive ? ' active' : '') + '" data-theme-id="' + t.id + '" style="background:' + t.colors.bg + ';color:' + (isLight ? '#2d2d2d' : '#e8e8ec') + '"><div class="theme-name">' + t.name + '</div><div class="theme-preview"><span style="background:' + t.colors.bg2 + '"></span><span style="background:' + t.colors.accent + '"></span><span style="background:' + t.colors.green + '"></span><span style="background:' + t.colors.red + '"></span></div></div>';
  }).join('');
  grid.querySelectorAll('.theme-card').forEach(card => {
    card.onclick = () => applyTheme(card.dataset.themeId);
  });
}

$('themeBtn').onclick = e => {
  renderThemeGrid();
  const popover = $('themeModal');
  const btn = e.target.closest('button');
  const rect = btn.getBoundingClientRect();
  popover.style.top = (rect.bottom + 8) + 'px';
  popover.style.left = Math.max(10, rect.right - 280) + 'px';
  popover.classList.add('open');
};
$('themeClose').onclick = () => $('themeModal').classList.remove('open');
document.addEventListener('click', e => {
  const popover = $('themeModal');
  if (popover.classList.contains('open') && !popover.contains(e.target) && !e.target.closest('#themeBtn')) {
    popover.classList.remove('open');
  }
});

// Burndown placeholder
function renderBurndown() {
  $('burndownChart').innerHTML = '<div style="color:var(--text3);font-size:12px">Burndown chart - set project dates to enable</div>';
  $('burndownDates').innerHTML = '';
}

// Escape key handler
document.onkeydown = e => {
  if (e.key === 'Escape') {
    $('themeModal').classList.remove('open');
    $('commentsPopover').classList.remove('open');
    $('notifPanel').classList.remove('open');
    $('userDropdown').classList.remove('open');
    hideMentionDropdown();
    currentCommentPartId = null;
  }
};

// Initialize
applyTheme(currentTheme);
loadExpanded();
</script>
</body>
</html>
