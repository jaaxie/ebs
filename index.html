<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>EBS v3 - Cloud</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<!-- DOMPurify for HTML sanitization -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" integrity="sha512-H+rglffZ6f5gF7UJgvH4Naa+fGCgjrHKMgoFOGmcPTRwR6oILo5R+gtzNrpDp7iMV3udbymBVjkeZGNz1Em4rQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- SheetJS for Excel import -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#2f2f2d;--bg2:#252523;--bg3:#1f1e1d;--bg4:#131312;--border:rgba(221,220,208,0.08);--border-strong:rgba(221,220,208,0.12);--text:#faf9f5;--text2:#c1bfb5;--text3:#9b9991;--text-muted:#9b9991;--accent:#5a9ac8;--accent-hover:#6aa8d4;--accent-main:#d87756;--selection:rgba(90,154,200,0.12);--green:#6aaa6a;--yellow:#b8a050;--orange:#d87756;--red:#c07070;--cyan:#6aa0aa;--purple:#9888aa;--s0:#8a8a82;--s1:#c07070;--s2:#d87756;--s3:#b8a050;--s4:#6aa0aa;--s5:#9888aa;--s6:#6aaa6a;--checkbox:#5a9ac8;--btn-primary-bg:#faf9f5;--btn-primary-text:#2f2f2d;--shadow:0 4px 12px rgba(0,0,0,0.15)}
[data-theme="claude-light"]{--bg:#ffffff;--bg2:#faf9f5;--bg3:#f4f4ec;--bg4:#e7e5db;--border:rgba(31,30,29,0.06);--border-strong:rgba(31,30,29,0.10);--text:#131312;--text2:#3c3c39;--text3:#72716b;--text-muted:#72716b;--accent:#1a66b2;--green:#1a7a1a;--yellow:#8a6a20;--orange:#c6603f;--red:#b04545;--cyan:#1a7a90;--purple:#6a4a9a;--s0:#6a6a62;--s1:#b04545;--s2:#c6603f;--s3:#8a6a20;--s4:#1a7a90;--s5:#6a4a9a;--s6:#1a7a1a;--accent-main:#c6603f;--checkbox:#1a66b2;--btn-primary-bg:#131312;--btn-primary-text:#faf9f5;--shadow:0 4px 12px rgba(0,0,0,0.06)}
.theme-popover{width:240px}
.theme-popover .modal-body{padding:16px}
.theme-grid{display:flex;flex-direction:column;gap:6px}
.theme-card{padding:14px 16px;border-radius:12px;cursor:pointer;border:2px solid transparent;background:var(--bg3);transition:all .2s cubic-bezier(0.4,0,0.2,1);position:relative}
.theme-card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
.theme-card.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(138,186,220,.2)}
.theme-card.active::after{content:'âœ“';position:absolute;top:12px;right:14px;font-size:13px;font-weight:600;color:var(--accent)}
.theme-name{font-size:12px;font-weight:600;margin-bottom:8px}
.theme-preview{display:flex;gap:4px;height:24px;border-radius:6px;overflow:hidden}
.theme-preview span{flex:1;border-radius:4px}
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:var(--text-muted) transparent}
*::-webkit-scrollbar{width:8px;height:8px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:var(--text-muted);border-radius:4px;border:2px solid var(--bg)}
*::-webkit-scrollbar-thumb:hover{background:var(--text3)}
html,body{height:100%;overflow:hidden;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);font-size:14px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;line-height:1.5}
.header{background:var(--bg);border-bottom:1px solid var(--border);padding:0 20px;display:flex;align-items:center;position:fixed;top:0;left:0;right:0;z-index:100;height:50px;gap:12px}
.logo{font-weight:500;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:120px;max-width:280px;letter-spacing:-0.2px;flex-shrink:0}
.project-selector{display:flex;align-items:center;gap:4px;flex-shrink:0;position:relative}
.project-selector-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text3);cursor:pointer;transition:all .15s}
.project-selector-btn:hover{background:var(--bg2);border-color:var(--border);color:var(--text)}
.project-selector-btn svg{width:14px;height:14px}
.project-dropdown{position:absolute;top:100%;left:0;margin-top:6px;min-width:280px;max-width:360px;background:var(--bg);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.2);z-index:1000;display:none;overflow:hidden}
.project-dropdown.open{display:block}
.project-dropdown-header{padding:10px 12px;font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border);background:var(--bg2)}
.project-dropdown-list{max-height:320px;overflow-y:auto}
.project-dropdown-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--border)}
.project-dropdown-item:last-child{border-bottom:none}
.project-dropdown-item:hover{background:var(--bg2)}
.project-dropdown-item.active{background:var(--bg3)}
.project-dropdown-item-name{flex:1;font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.project-dropdown-item-check{width:16px;color:var(--accent);font-size:14px}
.project-dropdown-item-archived{font-size:10px;color:var(--text3);background:var(--bg3);padding:2px 6px;border-radius:4px}
.project-dropdown-footer{padding:8px;border-top:1px solid var(--border);background:var(--bg2);display:flex;flex-direction:column;gap:4px}
.project-dropdown-action{display:flex;align-items:center;gap:8px;padding:8px 10px;font-size:12px;color:var(--text2);cursor:pointer;border-radius:6px;transition:all .1s}
.project-dropdown-action:hover{background:var(--bg3);color:var(--text)}
.project-dropdown-action svg{width:14px;height:14px;opacity:0.7}
.manage-project-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border)}
.manage-project-item:last-child{border-bottom:none}
.manage-project-item-name{flex:1;font-size:13px;color:var(--text);font-weight:500}
.manage-project-item-date{font-size:11px;color:var(--text3)}
.manage-project-item-archived{font-size:10px;color:var(--text3);background:var(--bg3);padding:2px 6px;border-radius:4px;margin-left:8px}
.manage-project-item-actions{display:flex;gap:4px}
.manage-project-item-actions button{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text3);cursor:pointer;transition:all .15s;font-size:12px}
.manage-project-item-actions button:hover{background:var(--bg2);border-color:var(--border);color:var(--text)}
.manage-project-item-actions button.danger:hover{color:var(--red);border-color:var(--red)}
.template-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
.template-item:last-child{border-bottom:none}
.template-item-info{flex:1;min-width:0}
.template-item-name{font-size:13px;color:var(--text);font-weight:500}
.template-item-desc{font-size:11px;color:var(--text3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.template-item-meta{font-size:10px;color:var(--text3);margin-top:4px}
.template-item-actions{display:flex;gap:4px}
.template-item-actions button{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text3);cursor:pointer;transition:all .15s;font-size:12px}
.template-item-actions button:hover{background:var(--bg2);border-color:var(--border);color:var(--text)}
.template-item-actions button.danger:hover{color:var(--red);border-color:var(--red)}
.master-schedule-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:500;display:none;flex-direction:column}
.master-schedule-overlay.open{display:flex}
.master-schedule-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;background:var(--bg)}
.master-schedule-title{font-size:18px;font-weight:600;color:var(--text);flex:1}
.master-schedule-close{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);cursor:pointer;font-size:18px;transition:all .15s}
.master-schedule-close:hover{background:var(--bg2);color:var(--text)}
.master-schedule-body{flex:1;overflow:auto;padding:24px}
.master-schedule-empty{text-align:center;padding:60px 20px;color:var(--text3)}
.master-project-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)}
.master-project-row:last-child{border-bottom:none}
.master-project-info{width:200px;min-width:200px;padding-right:16px}
.master-project-name{font-size:13px;font-weight:500;color:var(--text);cursor:pointer;transition:color .15s}
.master-project-name:hover{color:var(--accent)}
.master-project-dates{font-size:10px;color:var(--text3);margin-top:2px}
.master-project-progress{font-size:10px;color:var(--text2);margin-top:2px}
.master-timeline-wrap{flex:1;position:relative;height:32px;background:var(--bg2);border-radius:6px;overflow:hidden}
.master-timeline-bar{position:absolute;top:4px;bottom:4px;background:var(--accent);border-radius:4px;cursor:pointer;display:flex;align-items:center;padding:0 10px;font-size:10px;color:#fff;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:filter .15s;min-width:60px}
.master-timeline-bar:hover{filter:brightness(1.1)}
.master-timeline-bar.archived{background:var(--text3);opacity:0.6}
.master-timeline-bar.no-dates{background:var(--bg3);color:var(--text3)}
.master-timeline-today{position:absolute;top:0;bottom:0;width:2px;background:var(--red);z-index:5}
.master-timeline-header{display:flex;margin-bottom:12px;padding-left:216px}
.master-timeline-month{flex:1;font-size:10px;color:var(--text3);text-align:center;padding:6px 0;border-left:1px solid var(--border)}
.master-timeline-month:first-child{border-left:none}
.master-legend{display:flex;gap:16px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.master-legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text2)}
.master-legend-color{width:12px;height:12px;border-radius:3px}
.header-search{position:relative;width:180px;flex-shrink:0}
.header-search input{width:100%;height:32px;padding:0 32px 0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:16px;transition:all .2s}
.header-search input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,0.08)}
.header-search input::placeholder{color:var(--text-muted)}
.header-search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;background:var(--bg3);border:none;border-radius:50%;color:var(--text3);font-size:9px;cursor:pointer;display:none;align-items:center;justify-content:center;transition:all .15s}
.header-search-clear.visible{display:flex}
.header-search-clear:hover{background:var(--text3);color:var(--bg)}
.ai-console-btn{display:flex;align-items:center;gap:8px;padding:4px 10px 4px 4px;background:transparent;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text);transition:all .15s;flex-shrink:0}
.ai-console-btn:hover{background:var(--bg2)}
.ai-console-btn.active{background:var(--accent-main);color:white}
.ai-console-btn.active .ai-console-icon{background:rgba(255,255,255,0.2)}
.ai-console-btn.active .ai-console-plus{transform:rotate(45deg)}
.ai-console-btn.spinning .ai-console-plus{animation:icon-spin 1s linear infinite}
@keyframes icon-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.ai-console-icon{width:24px;height:24px;border-radius:50%;background:var(--accent-main);display:flex;align-items:center;justify-content:center;transition:all .3s}
.ai-console-plus{width:14px;height:14px;position:relative;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1)}
.ai-console-plus::before,.ai-console-plus::after{content:'';position:absolute;background:white;border-radius:2px;top:50%;left:50%;transform:translate(-50%,-50%)}
.ai-console-plus::before{width:14px;height:2px}
.ai-console-plus::after{width:2px;height:14px}
@keyframes dot-pulse{0%,100%{opacity:0.75;transform:translate(-50%,-50%) scale(0.92)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}}
.header-spacer{flex:1}
.header-metrics{display:flex;align-items:center;gap:8px;cursor:pointer;border-radius:10px;padding:2px;margin:-2px;transition:background .15s}
.header-metrics:hover{background:var(--bg2)}
.hm{display:flex;align-items:center;gap:8px;padding:5px 10px;background:var(--bg2);border-radius:8px;border:1px solid var(--border)}
.hm-label{font-size:9px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.4px}
.hm-value{font-size:13px;font-weight:500;color:var(--text2)}
.hm-progress{min-width:130px}
.hm-bar{width:60px;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
.hm-bar-fill{height:100%;border-radius:2px;background:#7aaa7a;transition:width .4s ease}
.header-btns{display:flex;gap:4px;align-items:center}
.header-btns .btn{background:transparent;border:none;color:var(--text2);height:36px;padding:0 10px;font-size:13px}
.header-btns .btn:hover{background:var(--bg3);color:var(--text)}
.version-badge{font-size:10px;color:var(--text-muted);padding:6px 10px;font-family:ui-monospace,monospace;cursor:pointer;position:relative;border-radius:4px;transition:all .15s}
.version-badge:hover{color:var(--text3);background:var(--bg2)}
.version-info{position:fixed;background:var(--bg3);border:1px solid var(--border-strong);border-radius:8px;padding:12px;font-size:11px;color:var(--text2);opacity:0;visibility:hidden;transform:translateY(4px);transition:all .15s;box-shadow:var(--shadow);z-index:1000;width:240px;font-family:system-ui,-apple-system,sans-serif;pointer-events:none}
.version-info.open{opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto}
.version-info-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;gap:12px}
.version-info-label{color:var(--text-muted);font-size:11px;flex-shrink:0}
.version-info-value{color:var(--text);font-weight:500;font-size:11px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px}
.version-info-divider{height:1px;background:var(--border);margin:8px 0}
.btn{height:34px;padding:0 12px;font-size:12px;font-weight:500;color:var(--text2);background:transparent;border:1px solid var(--border);border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all .15s}
.btn:hover{background:var(--bg2);color:var(--text);border-color:var(--border-strong)}
.btn:active{transform:scale(0.98)}
.btn-primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);border-color:transparent}
.btn-primary:hover{opacity:0.9}
.btn-report{gap:8px}
.btn-receive{gap:8px}
.po-details-actions .btn-receive{background:rgba(127,184,127,0.08);color:var(--green);border:1px solid rgba(127,184,127,0.2)}
.po-details-actions .btn-receive:hover{background:rgba(127,184,127,0.15)}
.btn-save{background:transparent;color:var(--text2)}
.btn-save:hover{background:var(--bg2)}
.btn-danger{background:rgba(192,128,128,0.06);color:var(--red);border-color:transparent}
.btn-danger:hover{background:rgba(192,128,128,0.12)}
.po-popover{width:320px}
.receive-po-popover{width:360px}
.receive-po-preview{margin-top:14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;max-height:220px;overflow-y:auto}
.receive-po-empty{padding:20px;text-align:center;color:var(--text3);font-size:12px}
.receive-po-list{padding:6px 0}
.receive-po-item{display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border)}
.receive-po-item:last-child{border-bottom:none}
.receive-po-item-name{flex:1;font-size:13px;font-weight:500}
.receive-po-item-status{font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg3);color:var(--text2);font-weight:550}
.receive-po-item-status.ordered{background:#3b3000;color:#fbbf24}
.receive-po-item-status.arrived{background:#1a3a2f;color:#6ee7b7}
.receive-po-count{padding:12px 14px;background:var(--bg3);border-radius:10px 10px 0 0;font-size:13px;font-weight:600;color:var(--text2)}
.receive-po-count span{color:var(--accent)}
.po-note{font-size:11px;color:var(--text3);margin-top:6px;font-style:italic}
.delete-modal{max-width:320px}
.notes-cell{font-size:11px;color:var(--text3);font-style:italic;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.eta-cell{display:flex;flex-direction:column;gap:2px;font-size:11px}
.eta-date{cursor:pointer}
.eta-date.historical{color:var(--text3)}
.eta-date.user-set{color:var(--green)}
.eta-po{font-size:10px;color:var(--accent);cursor:pointer;font-weight:500}
.eta-po:hover{text-decoration:underline}
.eta-po.active{background:var(--accent);color:#fff;padding:2px 6px;border-radius:3px}
.autocomplete-wrapper{position:relative;width:100%}
.autocomplete-wrapper input{width:100%;height:26px;padding:2px 8px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--accent);border-radius:4px;outline:none}
.autocomplete-list{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:8px;max-height:180px;overflow-y:auto;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.5);display:none}
.autocomplete-list.open{display:block}
.autocomplete-item{padding:8px 12px;font-size:13px;cursor:pointer;color:var(--text)}
.autocomplete-item:hover,.autocomplete-item.selected{background:var(--bg4)}
.autocomplete-item em{color:var(--accent);font-style:normal;font-weight:600}
.main{padding-top:50px;height:100vh;display:flex;overflow:hidden}
.sidebar{width:200px;min-width:200px;background:var(--bg);border-right:1px solid var(--border);padding:20px 16px;display:flex;flex-direction:column;gap:24px;overflow-y:auto;position:relative;z-index:15}
.sidebar-section{}
.sidebar-label{font-size:11px;font-weight:500;color:var(--text-muted);letter-spacing:0.3px;margin-bottom:12px;padding:0 12px;text-transform:uppercase}
.content{flex:1;padding:12px 16px;display:flex;flex-direction:column;overflow:hidden;position:relative}
.content:has(.ai-workspace.active){padding:0}
.pipeline{display:flex;flex-direction:column;gap:4px}
.pipe{background:transparent;border:none;border-radius:10px;padding:10px 12px;text-align:left;cursor:pointer;position:relative;transition:all .15s;display:flex;align-items:center;gap:12px}
.pipe::before{content:'';width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pipe[data-s="waiting"]::before{background:var(--s0)}.pipe[data-s="to-order"]::before{background:var(--s1)}.pipe[data-s="ordered"]::before{background:var(--s2)}.pipe[data-s="arrived"]::before{background:var(--s3)}.pipe[data-s="tested"]::before{background:var(--s4)}.pipe[data-s="configured"]::before{background:var(--s5)}.pipe[data-s="installed"]::before{background:var(--s6)}
.pipe:hover{background:var(--bg2)}.pipe.active{background:var(--bg2)}
.pipe-count{font-size:14px;font-weight:500;min-width:28px;color:var(--text2)}
.pipe-label{font-size:14px;font-weight:400;color:var(--text3)}
.tabs{display:flex;flex-direction:column;gap:4px}
.tab{height:44px;padding:0 12px;display:flex;align-items:center;gap:14px;font-size:14px;font-weight:400;color:var(--text3);background:transparent;border:none;border-radius:10px;cursor:pointer;transition:all .15s;text-align:left}
.tab-icon{width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:17px;color:var(--text2)}
.tab:hover{color:var(--text);background:var(--bg2)}
.tab:hover .tab-icon{color:var(--text)}
.tab.active{color:var(--text);background:var(--bg2)}
.tab.active .tab-icon{color:var(--text)}
.tab.active::after{display:none}
.toolbar{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-shrink:0}
.search{flex:1;height:34px;padding:0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:8px;transition:all .2s}
.search:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,0.08)}
.search::placeholder{color:var(--text-muted)}
.filter-select{height:34px;padding:0 10px;font-size:12px;color:var(--text);background:var(--bg2);border:1px solid var(--border);border-radius:8px;cursor:pointer}
.toggle-btn{height:34px;padding:0 12px;font-size:12px;font-weight:500;color:var(--text2);background:transparent;border:1px solid var(--border);border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
.toggle-btn:hover{background:var(--bg2);color:var(--text)}
.toggle-btn.expanded{background:var(--bg2);color:var(--text)}
.toggle-btn .arrow{font-size:8px;transition:transform .2s}
.panel{display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden}.panel.active{display:flex}
.filter-badges{margin-bottom:6px;flex-shrink:0}
.filter-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(138,186,220,.06);color:var(--accent);padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500;margin-right:6px}
.filter-badge button{background:rgba(255,255,255,.06);border:none;color:var(--accent);width:16px;height:16px;border-radius:50%;cursor:pointer;font-size:9px}
.data-table{background:var(--bg2);border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
.table-header{display:grid;gap:4px;padding:0 12px;background:transparent;border-bottom:1px solid var(--border);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;height:34px;align-items:center;flex-shrink:0}
.table-body{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden}
.parts-grid{grid-template-columns:28px minmax(200px,1fr) 100px 90px 80px 40px 76px 96px 90px minmax(150px,1fr) 72px}
.part-checkbox{width:14px;height:14px;accent-color:var(--checkbox);cursor:pointer;margin:0}
.part-row.selected{background:var(--selection)!important}
.part-row.selected:hover{background:rgba(138,186,220,0.16)!important}
.bulk-bar{display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);align-items:center;gap:12px;padding:14px 18px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2);z-index:1000;flex-direction:row;width:auto}
.bulk-bar.active{display:flex}
.bulk-bar-count{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap}
.bulk-bar-actions{display:flex;gap:8px}
.bulk-bar .btn{background:var(--bg3);color:var(--text);border:1px solid var(--border);height:32px;padding:0 14px;font-size:12px;border-radius:8px;white-space:nowrap}
.bulk-bar .btn:hover{background:var(--bg4);border-color:var(--border-strong)}
.bulk-bar .btn-danger{background:rgba(192,128,128,0.1);color:var(--red);border-color:transparent}
.bulk-bar .btn-danger:hover{background:rgba(192,128,128,0.2)}
.bulk-bar .btn-clear{background:transparent;color:var(--text3);padding:0 8px}
.bulk-popover{width:320px}
.bulk-preview{background:var(--bg);border-radius:8px;padding:10px;margin-bottom:10px;max-height:120px;overflow-y:auto}
.bulk-preview-item{font-size:12px;color:var(--text2);padding:4px 0}
.add-row{display:flex;align-items:center;padding:4px 12px;background:var(--bg)}
.add-row-btn{width:20px;height:20px;background:var(--bg3);border:none;border-radius:6px;color:var(--text3);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.add-row-btn:hover{background:var(--accent);color:#fff}
.asm-row{display:grid;gap:4px;padding:0 12px;background:var(--bg3);height:40px;align-items:center;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border)}
.asm-row:hover{background:var(--bg4)}
.asm-row.highlight{background:rgba(10,132,255,0.2)!important;animation:asm-row-highlight 5s ease-out}
@keyframes asm-row-highlight{0%{background:rgba(10,132,255,0.4)}80%{background:rgba(10,132,255,0.2)}100%{background:var(--bg3)}}
.asm-priority{display:flex;flex-direction:column;gap:1px;align-items:center}
.asm-priority-btn{width:18px;height:14px;background:transparent;border:none;color:var(--text3);font-size:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:3px;transition:all .15s}
.asm-priority-btn:hover{background:var(--bg4);color:var(--text)}
.asm-priority-btn:active{background:var(--accent);color:#fff}
.asm-toggle{width:20px;height:20px;background:transparent;border:none;color:var(--text2);font-size:10px;cursor:pointer;pointer-events:none}
.asm-name{font-weight:600;font-size:13px;color:var(--accent);pointer-events:none}
.asm-name-cell{display:flex;align-items:center;gap:8px}
.asm-meta{font-size:11px;color:var(--text3);pointer-events:none}
.asm-progress{display:flex;align-items:center;gap:8px}
.asm-bar{width:180px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;display:block}
.asm-bar-fill{height:100%;border-radius:3px;display:block}
.asm-pct{font-size:11px;font-weight:500;min-width:36px;color:var(--text2)}
.stage-dots{display:flex;align-items:center;gap:4px}
.stage-dot{width:6px;height:6px;border-radius:50%;background:var(--bg4)}
.stage-dot.done{background:var(--green)}
.stage-dot.current{background:var(--accent);box-shadow:0 0 0 2px rgba(138,186,220,.12)}
.asm-actions{display:flex;gap:4px}
.sm-btn{width:24px;height:24px;background:transparent;border:none;border-radius:5px;color:var(--text-muted);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.del-btn{width:28px;height:28px;background:transparent;border:none;border-radius:6px;color:var(--text-muted);font-size:16px;font-weight:300;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:all .15s}
.del-btn:hover{background:rgba(192,128,128,.15);color:var(--red)}
.notes-chat-cell{font-size:11px;color:var(--text2);padding:4px 8px;border-radius:6px;cursor:pointer;transition:all .15s;min-height:24px;display:flex;align-items:center;gap:6px;max-width:100%}
.notes-chat-cell:hover{background:var(--bg3);color:var(--text)}
.notes-chat-cell .comment-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}
.add-note{color:var(--text3);font-style:italic}
.notes-chat-cell:hover .add-note{color:var(--text2)}
.comment-badge{background:var(--accent);color:#fff;font-size:9px;padding:1px 5px;border-radius:8px;font-weight:500;flex-shrink:0;line-height:1.3}
.sm-btn:hover{background:var(--bg3);color:var(--text2)}.sm-btn.red{color:var(--red)}.sm-btn.red:hover{background:rgba(192,128,128,.08)}
.part-row{display:grid;gap:4px;padding:0 12px;background:var(--bg2);height:40px;align-items:center;transition:background .15s;border-bottom:1px solid var(--border)}
.part-row.ai-highlight{background:rgba(196,166,122,0.25)!important;animation:ai-pulse 5s ease-out}
@keyframes ai-pulse{0%{background:rgba(196,166,122,0.4)}10%{background:rgba(196,166,122,0.25)}90%{background:rgba(196,166,122,0.25)}100%{background:transparent}}
.asm-row.ai-highlight{background:rgba(196,166,122,0.2)!important;animation:ai-pulse 5s ease-out}
.part-row:last-child{border-bottom:none}
.part-row:hover{background:var(--bg3)}.part-row.child{background:var(--bg)}.part-row.child:hover{background:var(--bg3)}
.part-row.subchild{background:var(--bg)}
.part-row.highlight{background:var(--selection)!important;animation:part-row-highlight 5s ease-out}
@keyframes part-row-highlight{0%{background:rgba(90,154,200,0.3)}10%{background:var(--selection)}90%{background:var(--selection)}100%{background:transparent}}
.part-name-cell{display:flex;align-items:center;gap:8px}
.part-name-cell .cell{flex:1}
.subpart-add{width:18px;height:18px;border-radius:4px;background:transparent;border:1px dashed var(--border);color:var(--text-muted);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;opacity:0;flex-shrink:0}
.part-row:hover .subpart-add{opacity:0.5}
.subpart-add:hover{background:var(--accent);border-color:var(--accent);color:#fff;opacity:1!important}
.part-row.depth-1,.part-row.depth-2,.part-row.depth-3{border-left:3px solid var(--accent)}
.part-row.depth-1{border-left-color:rgba(138,186,220,0.3)}
.part-row.depth-2{border-left-color:rgba(138,186,220,0.5)}
.part-row.depth-3{border-left-color:rgba(138,186,220,0.7)}
.cell{font-size:12px;color:var(--text);padding:3px 5px;border-radius:4px;cursor:text;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:22px;display:flex;align-items:center}
.cell.editing{overflow:visible;position:relative;z-index:100}
.cell.editing{overflow:visible;position:relative;z-index:50}
.cell:hover{background:var(--bg4)}.cell.editing{background:var(--bg);padding:0}
.cell input,.cell select{width:100%;height:26px;padding:0 8px;font-size:12px;color:var(--text);background:var(--bg);border:1px solid var(--accent);border-radius:4px;outline:none}
.cell.muted{color:var(--text2)}.cell.note{font-style:italic;color:var(--text3);font-size:11px;margin-left:4px}
.status-badge{font-size:10px;font-weight:500;padding:3px 7px;border-radius:4px;text-align:center;display:inline-block;position:relative}
.status-badge .days-badge{position:absolute;top:-8px;right:-8px;min-width:18px;height:16px;padding:0 4px;font-size:9px;font-weight:600;border-radius:8px;display:none;align-items:center;justify-content:center;white-space:nowrap;pointer-events:none;box-shadow:0 1px 3px rgba(0,0,0,0.2)}
.status-badge:hover .days-badge{display:flex}
.days-badge.fresh{background:var(--green);color:white}
.days-badge.normal{background:var(--accent);color:white}
.days-badge.aging{background:var(--orange);color:white}
.days-badge.stuck{background:var(--red);color:white}
.status-badge.waiting{background:rgba(138,138,130,.08);color:var(--s0)}.status-badge.to-order{background:rgba(192,112,112,.08);color:var(--s1)}.status-badge.ordered{background:rgba(216,119,86,.08);color:var(--s2)}.status-badge.arrived{background:rgba(184,160,80,.08);color:var(--s3)}.status-badge.tested{background:rgba(106,160,170,.08);color:var(--s4)}.status-badge.configured{background:rgba(152,136,170,.08);color:var(--s5)}.status-badge.installed{background:rgba(106,170,106,.08);color:var(--s6)}
.eta-badge{font-size:10px;padding:3px 7px;border-radius:4px;background:var(--bg3);color:var(--text2);cursor:pointer;font-weight:500}
.eta-badge:hover{background:var(--bg4);color:var(--text)}
.eta-badge.has-data{background:rgba(160,144,180,.08);color:var(--purple)}
.eta-badge.manual{background:rgba(127,184,127,.08);color:var(--green)}
.action-indicator{width:16px;height:16px;background:var(--yellow);color:var(--bg);border-radius:4px;font-size:9px;font-weight:600;display:flex;align-items:center;justify-content:center;cursor:pointer}
.adv-btn{width:24px;height:24px;font-size:11px;font-weight:500;color:var(--text-muted);background:transparent;border:none;border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.adv-btn:hover{background:var(--bg3);color:var(--text2)}.adv-btn.done{color:var(--green);cursor:default}.adv-btn.done:hover{background:transparent}
.empty{padding:40px 16px;text-align:center;color:var(--text-muted);font-size:13px;flex:1;display:flex;align-items:center;justify-content:center}
.action-grid{grid-template-columns:minmax(120px,1fr) 100px 65px 80px 75px 75px 75px 80px}
.action-row{display:grid;gap:6px;padding:0 12px;background:var(--bg2);height:40px;align-items:center;border-bottom:1px solid var(--border)}
.action-row:last-child{border-bottom:none}
.action-row:hover{background:var(--bg3)}
.action-task{font-size:12px}.action-task.completed{text-decoration:line-through;color:var(--text3)}
.action-progress-bar{width:100%;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden}
.action-progress-fill{height:100%;border-radius:2px;transition:width .4s ease}
.action-link{font-size:11px;color:var(--accent);cursor:pointer}.action-link:hover{text-decoration:underline}
.action-due{font-size:12px;color:var(--text2)}.action-due.overdue{color:var(--red);font-weight:600}.action-due.soon{color:var(--yellow)}
.action-status{font-size:10px;font-weight:600;padding:4px 8px;border-radius:6px;text-align:center}
.action-status.not-started{background:rgba(255,69,58,.15);color:var(--s1)}.action-status.in-progress{background:rgba(255,214,10,.15);color:var(--s2)}.action-status.completed{background:rgba(48,209,88,.15);color:var(--s3)}
.progress-layout{display:flex;flex-direction:column;gap:10px;flex:1;overflow-y:auto;overflow-x:hidden}
.progress-top{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:900px){.progress-top{grid-template-columns:1fr}}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;flex-direction:column}
.card-title{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.card-title a{font-size:12px;color:var(--accent);cursor:pointer;text-transform:none;font-weight:500}
.burndown-container{background:var(--bg);border-radius:10px;padding:12px;flex:1;display:flex;align-items:center;justify-content:center;min-height:180px}
.burndown-container svg{display:block;width:100%;height:100%}
.burndown-dates{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-top:8px}
.burndown-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);font-size:13px;cursor:pointer;gap:6px}
.burndown-legend{display:flex;gap:16px;margin-top:10px;font-size:11px;color:var(--text2)}
.legend-item{display:flex;align-items:center;gap:6px}
.legend-dot{width:10px;height:3px;border-radius:2px}
.legend-dot.green{background:var(--green)}.legend-dot.red{background:var(--red)}.legend-dot.gray{background:var(--text3)}
.insights-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ins-group{margin-bottom:12px}.ins-group:last-child{margin-bottom:0}
.ins-group-title{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;padding:0 4px}
.ins-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg);border-radius:8px;font-size:12px}
.ins-label{color:var(--text2)}.ins-val{font-weight:600}
.ins-val.green{color:var(--green)}.ins-val.red{color:var(--red)}.ins-val.yellow{color:var(--yellow)}.ins-val.cyan{color:var(--cyan)}.ins-val.orange{color:var(--orange)}

/* Metrics Popover */
/* Backdrop overlay for popovers */
.popover-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:999;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
.popover-backdrop.active{opacity:1;pointer-events:auto}

.metrics-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:520px;max-width:calc(100vw - 40px);padding:20px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.metrics-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.metrics-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.metrics-row:last-child{margin-bottom:0}
.metrics-popover-title{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;padding:0 4px}
.metrics-popover .ins-row{padding:6px 8px;margin-bottom:4px}
.metrics-popover .ins-row:last-child{margin-bottom:0}
.metrics-section-full{grid-column:span 2;margin-bottom:12px}
.mp-forecast{padding:8px 0}
.mp-forecast-date{font-size:20px;font-weight:600;color:var(--text)}
.mp-forecast-label{font-size:12px;margin-left:8px}
.mp-forecast-detail{font-size:11px;color:var(--text3);margin-top:4px}
.mp-bottlenecks{display:flex;flex-wrap:wrap;gap:8px}
.mp-bottleneck{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg3);border-radius:6px;font-size:11px;cursor:pointer;transition:background .15s}
.mp-bottleneck:hover{background:var(--bg4)}
.mp-bottleneck-name{color:var(--text)}
.mp-bottleneck-info{color:var(--text3)}
.mp-otd-detail{margin-top:8px;padding:8px;background:var(--bg);border-radius:8px}
.mp-otd-content{margin-top:8px;max-height:200px;overflow-y:auto}
.mp-otd-item{display:flex;justify-content:space-between;padding:6px 8px;font-size:12px;border-radius:4px}
.mp-otd-item:nth-child(odd){background:var(--bg3)}
.mp-otd-item-mfr{color:var(--text)}
.mp-otd-item-stats{color:var(--text3)}
.mp-chart-container{background:var(--bg);border-radius:10px;padding:16px;min-height:160px;display:flex;align-items:center;justify-content:center;position:relative}
.mp-chart-container svg{display:block;width:100%;height:100%}
.mp-chart-tooltip{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:11px;color:var(--text);pointer-events:none;white-space:nowrap;z-index:100;opacity:0;transition:opacity 0.1s;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.mp-chart-tooltip.visible{opacity:1}
.mp-forecast-popover{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-size:12px;color:var(--text);z-index:101;box-shadow:0 4px 16px rgba(0,0,0,0.4);max-width:240px;line-height:1.5}
.mp-forecast-popover-title{font-weight:600;margin-bottom:6px;color:var(--green)}
.mp-forecast-popover-close{position:absolute;top:6px;right:8px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:2px 6px}
.mp-forecast-popover-close:hover{color:var(--text)}
.mp-forecast-popover-stat{display:flex;justify-content:space-between;margin:4px 0;color:var(--text2)}
.mp-forecast-popover-stat span:last-child{color:var(--text);font-weight:500}
.mp-chart-legend{display:flex;gap:16px;margin-top:12px;font-size:11px;color:var(--text2);justify-content:center}
.mp-legend-item{display:flex;align-items:center;gap:6px}
.mp-legend-dot{width:8px;height:8px;border-radius:50%}
.mp-chart-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);font-size:12px;gap:6px;cursor:pointer;padding:20px}
.mp-chart-empty:hover{color:var(--text2)}
.metrics-section{margin-bottom:12px}
.metrics-section:last-child{margin-bottom:0}
.metrics-section-title{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;padding:4px 8px;margin-bottom:4px}
.forecast-card{background:var(--bg);border-radius:10px;padding:12px;margin-top:8px;border-left:3px solid var(--purple)}
.forecast-title{font-size:10px;font-weight:600;color:var(--purple);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.forecast-main{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.forecast-date{font-size:20px;font-weight:700;letter-spacing:-0.5px}
.forecast-label{font-size:12px;color:var(--text2)}
.forecast-detail{font-size:11px;color:var(--text3)}
/* Progress Page */
.progress-layout-full{display:flex;flex-direction:column;gap:12px;flex:1;overflow-y:auto}
.progress-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.asm-progress-list{display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto}
.asm-progress-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bg3)}
.asm-progress-item:last-child{border-bottom:none}
.asm-progress-name{flex:1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.asm-progress-bar{width:80px;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden}
.asm-progress-fill{height:100%;border-radius:3px;transition:width 0.3s}
.asm-progress-pct{font-size:11px;font-weight:600;width:36px;text-align:right}
.bottleneck-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto}
.bottleneck-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border-radius:6px;font-size:11px;border-left:3px solid var(--red)}
.bottleneck-item.warning{border-color:var(--yellow)}
.bottleneck-name{flex:1;font-weight:500}
.bottleneck-days{color:var(--text3)}
.forecast-card-inner{padding:8px 0}

/* Gantt Chart - MS Project Style */
.gantt-container{display:flex;flex-direction:column;flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.gantt-toolbar{display:flex;align-items:center;gap:18px;padding:14px 20px;background:transparent;border-bottom:1px solid var(--border)}
.gantt-toolbar-title{font-size:15px;font-weight:500;color:var(--text)}
.gantt-toolbar-dates{display:flex;align-items:center;gap:10px;margin-left:auto}
.gantt-date-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.gantt-date-display{display:flex;flex-direction:column;gap:2px;padding:6px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.15s;min-width:100px}
.gantt-date-display:hover{border-color:var(--accent);background:var(--bg4)}
.gantt-date-value{font-size:13px;font-weight:500;color:var(--text)}
.gantt-date-arrow{color:var(--text-muted);font-size:14px}
.gantt-toolbar-actions{display:flex;align-items:center;gap:8px}
.gantt-filter-select{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:12px;color:var(--text);cursor:pointer;min-width:140px}
.gantt-filter-select:focus{outline:none;border-color:var(--accent)}
.gantt-col-resource{font-size:11px;color:var(--text3);cursor:pointer}
.gantt-resource-select{background:var(--bg3);border:1px solid var(--border);font-size:11px;color:var(--text);cursor:pointer;padding:4px 6px;border-radius:4px;max-width:80px;position:relative;z-index:20;pointer-events:auto}
.gantt-resource-select:hover{background:var(--bg4);border-color:var(--accent)}
.gantt-resource-select:focus{outline:none;border-color:var(--accent)}
.gantt-col-resource{pointer-events:auto;position:relative;z-index:20}
.btn-sm{padding:6px 12px;font-size:12px;height:30px}
.gantt-header-row{display:flex;background:transparent;border-bottom:1px solid var(--border);position:relative}
.gantt-sidebar-header{width:420px;min-width:420px;flex-shrink:0;display:grid;grid-template-columns:1fr 80px 60px 60px 45px;font-size:10px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;border-right:1px solid var(--border);background:var(--bg2);position:sticky;left:0;z-index:10;box-shadow:2px 0 8px rgba(0,0,0,0.1)}
.gantt-sidebar-header>div{padding:12px 10px}
.gantt-col-name{padding-left:20px!important}
.gantt-timeline-header-wrap{flex:1;overflow:hidden}
.gantt-timeline-header{display:flex;position:relative}
.gantt-timeline-day{min-width:70px;width:70px;padding:8px 0;text-align:center;font-size:9px;color:var(--text-muted);border-right:1px solid var(--border)}
.gantt-timeline-day.weekend{background:rgba(0,0,0,0.08)}
.gantt-timeline-day.today{background:rgba(138,186,220,0.1);color:var(--accent);font-weight:500}
.gantt-timeline-day .day-num{font-size:11px;font-weight:500;color:var(--text3)}
.gantt-timeline-day.today .day-num{color:var(--accent)}
.gantt-body-wrap{flex:1;overflow:auto;cursor:grab;position:relative}
.gantt-body-wrap.grabbing{cursor:grabbing}
.gantt-body-wrap.grabbing{cursor:grabbing}
.gantt-body-inner{display:flex;min-height:100%;position:relative}
.gantt-sidebar-body{width:420px;min-width:420px;flex-shrink:0;border-right:1px solid var(--border);background:var(--bg2);position:sticky;left:0;z-index:10;box-shadow:2px 0 8px rgba(0,0,0,0.1)}
.gantt-sidebar-row{display:grid;grid-template-columns:1fr 80px 60px 60px 45px;border-bottom:1px solid var(--border);font-size:13px;align-items:center;height:44px}
.gantt-sidebar-row:hover{background:var(--bg3)}
.gantt-sidebar-row.asm{font-weight:500}
.gantt-sidebar-row>div{padding:0 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gantt-sidebar-row .gantt-col-name{padding-left:20px;display:flex;align-items:center;gap:8px}
.gantt-sidebar-row.part .gantt-col-name{padding-left:32px;color:var(--text2)}
.gantt-sidebar-row .gantt-col-start,.gantt-sidebar-row .gantt-col-end{font-size:11px;color:var(--text3);cursor:pointer;transition:all 0.15s}
.gantt-sidebar-row .gantt-col-start:hover,.gantt-sidebar-row .gantt-col-end:hover{color:var(--accent);background:var(--bg4);border-radius:4px;margin:-2px -4px;padding:2px 14px}
.gantt-sidebar-row .gantt-col-dur{font-size:11px;color:var(--text-muted);text-align:center}
.gantt-toggle{cursor:pointer;font-size:10px;color:var(--text-muted)}
.gantt-asm-link{cursor:pointer;transition:color 0.15s}
.gantt-asm-link:hover{color:var(--accent)}
.gantt-sidebar-row.highlight{background:rgba(138,186,220,0.15)!important;animation:gantt-row-highlight 5s ease-out}
@keyframes gantt-row-highlight{0%{background:rgba(138,186,220,0.3)}80%{background:rgba(138,186,220,0.15)}100%{background:transparent}}
.gantt-link-btn{background:var(--bg3)!important;font-size:12px!important}
.gantt-timeline-body{position:relative;flex-shrink:0}
.gantt-timeline-row{display:flex;height:44px;border-bottom:1px solid var(--border);position:relative}
.gantt-timeline-row:hover{background:var(--bg3)}
.gantt-timeline-cell{min-width:70px;width:70px;border-right:1px solid var(--border)}
.gantt-timeline-cell.weekend{background:rgba(0,0,0,0.06)}
.gantt-bar-container{position:absolute;top:0;bottom:0;display:flex;align-items:center}
.gantt-bar{height:15px;border-radius:4px;font-size:10px;font-weight:500;color:#fff;display:flex;align-items:center;padding:0 8px;min-width:24px;cursor:grab;transition:opacity 0.15s,box-shadow 0.15s;text-shadow:0 1px 2px rgba(0,0,0,0.2);position:relative;overflow:visible}
.gantt-bar:hover{box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.gantt-bar:active{cursor:grabbing}
.gantt-bar-asm{height:15px;border-radius:4px}
.gantt-bar.asm{background:var(--text-muted);height:3px;border-radius:2px;box-shadow:none;min-width:10px}
.gantt-bar.asm:hover{transform:none;height:5px;margin-top:-1px}
.gantt-bar.waiting{background:#8a8a82}
.gantt-bar.to-order{background:#c07070}
.gantt-bar.ordered{background:#d87756}
.gantt-bar.arrived{background:#b8a050;color:#fff}
.gantt-bar.tested{background:#6aa0aa}
.gantt-bar.configured{background:#9888aa}
.gantt-bar.installed{background:#6aaa6a}
.gantt-bar-progress{position:absolute;left:0;top:0;bottom:0;background:rgba(255,255,255,0.2);border-radius:4px 0 0 4px}
.gantt-bar-label{position:relative;z-index:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gantt-bar-conflict{position:absolute;left:4px;top:50%;transform:translateY(-50%);font-size:10px;line-height:1;filter:drop-shadow(0 1px 1px rgba(0,0,0,0.3));z-index:2}
.gantt-bar.has-conflict{padding-left:20px}
.gantt-bar.has-conflict::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:#ff6b35;border-radius:4px 0 0 4px}
.gantt-conflict-badge{background:#ff6b35;color:#fff;font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px;margin-left:8px;cursor:help;position:relative}
.gantt-conflict-popover{position:absolute;top:100%;left:0;margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.25);padding:12px;min-width:280px;max-width:400px;z-index:1000;display:none;text-align:left}
.gantt-conflict-popover.open{display:block}
.gantt-conflict-popover-title{font-size:11px;font-weight:600;color:#ff6b35;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.gantt-conflict-item{padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;color:var(--text)}
.gantt-conflict-item:last-child{border-bottom:none;padding-bottom:0}
.gantt-conflict-item:first-child{padding-top:0}
.gantt-conflict-resource{font-weight:600;color:var(--text);margin-bottom:4px}
.gantt-conflict-tasks{color:var(--text2);font-size:11px;line-height:1.4}
.gantt-bar-resize{position:absolute;top:-2px;bottom:-2px;width:8px;cursor:ew-resize;z-index:5}
.gantt-bar-resize-left{left:-4px;border-radius:4px 0 0 4px}
.gantt-bar-resize-right{right:-4px;border-radius:0 4px 4px 0}
.gantt-bar-resize:hover{background:rgba(255,255,255,0.3)}
.gantt-bar.overdue{box-shadow:0 0 0 2px #e53935,0 2px 8px rgba(229,57,53,0.4)}
.gantt-bar.overdue::after{content:'!';position:absolute;right:-8px;top:-8px;background:#e53935;color:#fff;font-size:9px;font-weight:700;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.3)}
.gantt-tooltip{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;box-shadow:0 8px 24px rgba(0,0,0,0.25);z-index:1000;pointer-events:none;max-width:280px;font-size:12px;line-height:1.5;display:none}
.gantt-tooltip.visible{display:block}
.gantt-tooltip-title{font-weight:600;font-size:13px;margin-bottom:6px;color:var(--text)}
.gantt-tooltip-row{display:flex;justify-content:space-between;gap:12px;margin:3px 0;color:var(--text2)}
.gantt-tooltip-row span:first-child{color:var(--text3)}
.gantt-tooltip-conflict{margin-top:8px;padding-top:8px;border-top:1px solid var(--border);color:#ff6b35;font-weight:500}
.gantt-tooltip-overdue{color:#e53935;font-weight:500}
.gantt-milestone{position:absolute;width:16px;height:16px;transform:rotate(45deg) translateY(-50%);background:var(--accent);border:2px solid var(--bg2);box-shadow:0 2px 6px rgba(0,0,0,0.3);z-index:15;cursor:pointer;top:50%;margin-top:-8px}
.gantt-milestone:hover{transform:rotate(45deg) translateY(-50%) scale(1.15)}
.gantt-milestone.milestone-deadline{background:#e53935}
.gantt-milestone.milestone-delivery{background:#4caf50}
.gantt-milestone.milestone-review{background:#ff9800}
.gantt-milestone.milestone-custom{background:#9c27b0}
.gantt-dependency{position:absolute;pointer-events:none;z-index:5}
.gantt-dependency line{stroke:var(--text-muted);stroke-width:1.5}
.gantt-dependency polygon{fill:var(--text-muted)}
.gantt-today-line{position:absolute;top:0;bottom:0;width:2px;background:#e53935;z-index:20;pointer-events:none}
.gantt-today-marker{position:absolute;top:-20px;background:#e53935;color:#fff;font-size:10px;font-weight:500;padding:3px 8px;border-radius:4px;transform:translateX(-50%);white-space:nowrap}
.gantt-color-popup{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;display:none;min-width:160px}
.gantt-color-popup.open{display:block}
.gantt-date-popup{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;display:none;min-width:180px}
.gantt-date-popup.open{display:block}
.gantt-date-popup-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px}
.gantt-date-popup-input{width:100%;background:var(--bg);border:1px solid var(--bg4);border-radius:6px;padding:8px 10px;font-size:13px;color:var(--text);margin-bottom:10px}
.gantt-date-popup-input:focus{outline:none;border-color:var(--accent)}
.gantt-date-popup-btns{display:flex;gap:8px;justify-content:flex-end}
.gantt-color-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px}
.gantt-color-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.gantt-color-swatch{width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.gantt-color-swatch:hover{transform:scale(1.15);border-color:var(--text)}
.gantt-color-swatch.selected{border-color:var(--text);box-shadow:0 0 0 2px var(--bg2),0 0 0 4px var(--text)}
.ai-modal{max-width:720px;width:95vw}
/* AI Console Window - Matching app design */
.cmd-window{position:fixed;z-index:9500;background:var(--bg2);border:1px solid var(--border-strong);border-radius:12px;box-shadow:var(--shadow),0 0 0 1px var(--border);display:none;flex-direction:column;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;width:2100px;height:1200px;min-width:800px;min-height:500px;resize:both;overflow:hidden}
.cmd-window.open{display:flex}
.cmd-window.minimized{display:none}
.cmd-titlebar{display:flex;align-items:center;background:var(--bg3);padding:10px 16px;cursor:move;user-select:none;border-bottom:1px solid var(--border);flex-shrink:0;border-radius:12px 12px 0 0}
.cmd-icon{color:var(--accent-main);font-size:14px;margin-right:10px}
.cmd-title{flex:1;color:var(--text);font-size:13px;font-weight:500}
.cmd-controls{display:flex;gap:4px;align-items:center}
.cmd-ctrl-btn{background:transparent;border:none;color:var(--text3);width:32px;height:28px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .15s}
.cmd-ctrl-btn:hover{background:var(--bg);color:var(--text)}
.cmd-ctrl-btn:last-child:hover{background:var(--red);color:#fff}
.cmd-body{flex:1;overflow-y:auto;padding:20px 24px;color:var(--text);font-size:13px;line-height:1.6;background:var(--bg2)}
.cmd-body::-webkit-scrollbar{width:8px}
.cmd-body::-webkit-scrollbar-track{background:transparent}
.cmd-body::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:4px}
.cmd-body::-webkit-scrollbar-thumb:hover{background:var(--text3)}
.cmd-line{margin:6px 0;white-space:pre-wrap;word-break:break-word}
.cmd-line.prompt{color:var(--accent);font-weight:500;margin-top:16px}
.cmd-line.response{color:var(--text)}
.cmd-line.error{color:var(--red);background:rgba(192,112,112,0.08);padding:10px 14px;border-radius:8px;border-left:3px solid var(--red)}
.cmd-line.success{color:var(--green)}
.cmd-line.warning{color:var(--yellow)}
.cmd-line.info{color:var(--cyan)}
.cmd-line.muted{color:var(--text3);font-style:italic}
.cmd-link{color:var(--accent);text-decoration:underline;text-decoration-color:rgba(90,154,200,0.4);text-underline-offset:2px;cursor:pointer;transition:all .15s}
.cmd-link:hover{color:var(--accent-hover);text-decoration-color:rgba(90,154,200,0.7)}
.cmd-input-row{display:flex;align-items:center;padding:12px 20px;background:var(--bg3);border-top:1px solid var(--border);flex-shrink:0;gap:12px}
.cmd-prompt{color:var(--accent);font-size:13px;font-weight:500}
.cmd-input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:13px;padding:10px 14px;outline:none;transition:all .15s}
.cmd-input:focus{border-color:var(--accent);background:var(--bg)}
.cmd-input::placeholder{color:var(--text3)}
.cmd-suggestions{display:flex;flex-wrap:wrap;gap:8px;padding:14px 20px;background:var(--bg3);border-top:1px solid var(--border);flex-shrink:0}
.cmd-suggestion{background:var(--bg);border:1px solid var(--border);color:var(--text2);padding:8px 14px;font-size:12px;border-radius:6px;cursor:pointer;font-family:inherit;transition:all .15s}
.cmd-suggestion:hover{background:var(--bg3);border-color:var(--accent);color:var(--text)}
.cmd-btn-row{display:flex;gap:8px;margin-left:auto}
.cmd-btn{background:var(--bg);border:1px solid var(--border);color:var(--text2);padding:8px 16px;font-size:12px;cursor:pointer;font-family:inherit;border-radius:6px;transition:all .15s}
.cmd-btn:hover{background:var(--bg3);color:var(--text)}
.cmd-btn.primary{background:var(--btn-primary-bg);border-color:var(--btn-primary-bg);color:var(--btn-primary-text)}
.cmd-btn.primary:hover{opacity:0.9}
/* Minimized state */
.cmd-minimized{display:none;padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin:8px;cursor:pointer;font-size:11px;color:var(--text2)}
.cmd-minimized:hover{background:var(--bg3);border-color:var(--border-strong)}
.cmd-minimized.active{display:flex;align-items:center;gap:8px}
.cmd-minimized-icon{color:var(--accent-main)}
.cmd-minimized-title{flex:1}
/* Model selector */
.cmd-model-row{display:flex;align-items:center;gap:8px;padding:6px 0;margin-bottom:12px;border-bottom:1px solid var(--border)}
.cmd-model-label{color:var(--text3);font-size:11px}
.cmd-model-select{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-family:inherit;font-size:11px;padding:4px 8px;cursor:pointer}
.cmd-model-select:hover{border-color:var(--border-strong)}
/* Suggested questions */
.cmd-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0;padding:14px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.cmd-suggestion{background:var(--bg);border:1px solid var(--border);color:var(--text2);padding:8px 14px;font-size:12px;cursor:pointer;font-family:inherit;border-radius:6px;transition:all .15s}
.cmd-suggestion:hover{background:var(--bg3);border-color:var(--accent);color:var(--text)}
/* Structured response styles */
.cmd-section{margin:12px 0;padding:12px 0;border-bottom:1px solid var(--border)}
.cmd-section:last-child{border-bottom:none}
.cmd-section-header{color:var(--accent);font-weight:600;margin-bottom:8px;font-size:12px}
.cmd-bullet{color:var(--text3);margin-right:8px}
.ai-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text3)}
.ai-loading-spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
@keyframes spin{to{transform:rotate(360deg)}}
.ai-loading-text{font-size:13px;color:var(--text3)}
.ai-loading-sub{font-size:11px;color:var(--text-muted);margin-top:6px}
.ai-report{font-size:13px;line-height:1.6}
.ai-report-section{margin-bottom:20px}
.ai-report-header{display:flex;align-items:center;gap:10px;font-weight:600;font-size:13px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border);color:var(--text)}
.ai-report-header-icon{font-size:14px}
.ai-report-items{display:flex;flex-direction:column;gap:8px}
.ai-report-item{display:flex;gap:10px;padding:12px 14px;background:var(--bg);border-radius:8px;font-size:12px;align-items:flex-start}
.ai-report-item.critical{border-left:3px solid var(--red)}
.ai-report-item.warning{border-left:3px solid var(--yellow)}
.ai-report-item.info{border-left:3px solid var(--cyan)}
.ai-report-item.success{border-left:3px solid var(--green)}
.ai-report-bullet{flex-shrink:0;margin-top:2px}
.ai-report-text{flex:1;color:var(--text)}
.ai-report-meta{font-size:11px;color:var(--text3);margin-top:4px}
.ai-summary{background:var(--bg);padding:14px 16px;border-radius:8px;margin-bottom:20px;font-size:13px;line-height:1.6;border-left:3px solid var(--accent);color:var(--text)}
.ai-error{text-align:center;padding:30px;color:var(--text3)}
.ai-error-icon{font-size:24px;margin-bottom:8px}
.ai-error-msg{font-size:12px;margin-bottom:12px}
.ai-insights-list{display:flex;flex-direction:column;gap:8px}
.ai-insight{display:flex;gap:10px;padding:10px;background:var(--bg);border-radius:6px;border-left:3px solid var(--border);cursor:pointer}
.ai-insight:hover{background:var(--bg3)}
.ai-insight.critical{border-color:var(--red)}.ai-insight.warning{border-color:var(--yellow)}.ai-insight.info{border-color:var(--cyan)}.ai-insight.success{border-color:var(--green)}
.ai-insight-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.ai-insight.critical .ai-insight-icon{background:rgba(201,74,74,.15);color:var(--red)}.ai-insight.warning .ai-insight-icon{background:rgba(201,162,39,.15);color:var(--yellow)}.ai-insight.info .ai-insight-icon{background:rgba(58,168,168,.15);color:var(--cyan)}.ai-insight.success .ai-insight-icon{background:rgba(61,181,114,.15);color:var(--green)}
.ai-insight-content{flex:1}
.ai-insight-title{font-size:12px;font-weight:600;margin-bottom:2px}
.ai-insight-desc{font-size:10px;color:var(--text2)}
.ai-insight-action{font-size:9px;color:var(--accent);margin-top:4px}
.ai-timestamp{font-size:9px;color:var(--text3);text-align:right;margin-top:12px;padding-top:8px;border-top:1px solid var(--border)}
.ai-source{font-size:10px;color:var(--text3);text-align:center;padding:6px;margin-bottom:12px;background:var(--bg);border-radius:6px}
.report-model-badge{font-size:10px;color:var(--text3);background:var(--bg3);padding:4px 10px;border-radius:6px;font-weight:500}
.report-refresh-btn{background:transparent;border:none;color:var(--text3);font-size:18px;cursor:pointer;width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.report-refresh-btn:hover{background:var(--bg3);color:var(--text)}
.report-refresh-btn.spinning{animation:spin 1s linear infinite}
.report-refresh-btn:disabled{opacity:0.3;cursor:not-allowed}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.report-content{font-size:14px;line-height:1.7;color:var(--text);flex:1;overflow-y:auto;padding:12px 0}
.report-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--text3)}
.report-loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px}
.report-loading-text{font-size:13px}
.report-empty{display:flex;align-items:center;justify-content:center;flex:1}
.report-generate-btn{background:var(--accent-main);color:white;border:none;padding:14px 28px;border-radius:12px;font-size:15px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .2s;box-shadow:0 2px 8px rgba(216,119,86,0.3)}
.report-generate-btn:hover{filter:brightness(1.1);transform:translateY(-1px);box-shadow:0 4px 12px rgba(216,119,86,0.4)}
.report-generate-btn svg{opacity:0.9}
.report-section{margin-bottom:20px}
.report-section-title{font-size:13px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.report-prose{font-size:14px;line-height:1.75;padding:8px 0;flex:1}
.report-prose p{margin-bottom:14px}
.report-prose ul{margin:10px 0;padding-left:24px}
.report-prose li{margin-bottom:8px}
.report-prose strong{color:var(--text)}
.report-prose h1,.report-prose h2,.report-prose h3{color:var(--accent);margin:20px 0 12px 0}
.report-prose h1{font-size:18px}
.report-prose h2{font-size:16px}
.report-prose h3{font-size:14px}
.report-meta{font-size:11px;color:var(--text3);margin-bottom:14px;display:flex;justify-content:space-between;padding:0 2px}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);justify-content:center;align-items:center;z-index:1000;padding:20px}
.modal-bg.open{display:flex}

/* Small contextual popover */
.popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;padding:20px;min-width:220px;max-width:300px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.popover-msg{font-size:14px;margin-bottom:14px;line-height:1.5;color:var(--text)}
.popover-btns{display:flex;gap:10px;justify-content:flex-end}
.popover-btns .btn{padding:8px 14px;font-size:13px;min-width:70px}

/* Backdrop overlay for popovers */
.popover-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:999;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
.popover-backdrop.active{opacity:1;pointer-events:auto}

/* Popover-style modal (positioned near trigger) */
.modal-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:360px;max-width:calc(100vw - 40px);max-height:calc(100vh - 100px);overflow:auto;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.modal-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.modal-popover .modal-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:transparent}
.modal-popover .modal-title{font-size:15px;font-weight:600;letter-spacing:-0.2px}
.modal-popover .modal-close{background:var(--bg3);border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:0;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.modal-popover .modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-popover .modal-body{padding:20px}
.modal-popover .modal-foot{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:transparent}
.modal-popover .field{margin-bottom:16px}
.modal-popover .field-label{font-size:11px;font-weight:600;margin-bottom:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.modal-popover .field-input,.modal-popover .field-select,.modal-popover .field-textarea{width:100%;padding:12px 14px;font-size:14px;font-weight:430;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);transition:border-color .15s,box-shadow .15s}
.modal-popover .field-input:focus,.modal-popover .field-select:focus,.modal-popover .field-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(138,186,220,0.15)}
.modal-popover .field-textarea{min-height:80px;resize:vertical}
.modal-popover .field-row{display:flex;gap:14px}
.modal-popover .field-row .field{flex:1;margin-bottom:16px}
.modal-popover .btn{padding:10px 16px;font-size:13px;font-weight:550;border-radius:10px}
.report-popover{position:fixed;top:51px;right:0;bottom:0;width:calc(100vw - 240px);max-width:1000px;opacity:0;transform:translateX(20px);display:flex;flex-direction:column;border-radius:16px 0 0 16px;border-left:1px solid var(--border);border-top:none;border-right:none;border-bottom:none}
.report-popover.open{transform:translateX(0);opacity:1}
.report-popover .modal-head{gap:8px;flex-shrink:0;border-radius:16px 0 0 0}
.report-popover .modal-body{flex:1;overflow:hidden;display:flex;flex-direction:column;padding:0 20px 10px}
.report-popover .modal-foot{flex-shrink:0;border-radius:0 0 0 16px}
.modal-popover .notify-btn{width:100%;padding:12px;font-size:12px;margin-top:10px}

/* AI popover specific - Claude UI style */
.ai-popover{width:640px;max-width:calc(100vw - 40px);background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.15);max-height:calc(100vh - 100px);display:flex;flex-direction:column}
.ai-popover .modal-body{padding:0;display:flex;flex-direction:column;flex:1;overflow:hidden}
.ai-popover .modal-head{display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);padding:14px 18px;flex-shrink:0;background:var(--bg2)}
.ai-popover .modal-title{flex:1;font-size:15px;font-weight:550;color:var(--text2)}
.ai-popover .modal-close{background:transparent;color:var(--text3);width:28px;height:28px;font-size:16px;border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ai-popover .modal-close:hover{background:var(--bg4);color:var(--text)}
.ai-title-icon{color:#c4956a;font-size:14px;margin-right:4px}
.ai-model-badge{font-size:11px;color:var(--text3);font-family:inherit;background:var(--bg3);padding:6px 12px;border-radius:8px;font-weight:500;border:1px solid var(--border);cursor:pointer;transition:all .15s}
.ai-model-badge:hover{background:var(--bg4);border-color:var(--border-strong)}
.ai-model-selector{position:relative}
.ai-model-dropdown{position:absolute;top:100%;right:0;margin-top:6px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:10;min-width:160px;padding:6px;opacity:0;transform:translateY(-8px);pointer-events:none;transition:all .15s}
.ai-model-dropdown.open{opacity:1;transform:translateY(0);pointer-events:auto}
.ai-model-option{display:flex;flex-direction:column;align-items:flex-start;width:100%;padding:10px 12px;background:transparent;border:none;border-radius:6px;cursor:pointer;text-align:left;transition:all .1s}
.ai-model-option:hover{background:var(--bg3)}
.ai-model-option.active{background:var(--accent);color:#fff}
.ai-model-option .model-name{font-size:12px;font-weight:600;color:var(--text)}
.ai-model-option .model-desc{font-size:10px;color:var(--text3);margin-top:2px}
.ai-model-option.active .model-name,.ai-model-option.active .model-desc{color:#fff}
.thinking-pulse{animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.ai-model-selector-ws{position:relative}
.ai-model-badge-ws{font-size:11px;color:var(--text3);background:transparent;padding:6px 10px;border-radius:8px;font-weight:500;border:none;cursor:pointer;transition:all .15s;white-space:nowrap}
.ai-model-badge-ws:hover{background:var(--bg3);color:var(--text2)}
.ai-model-dropdown-ws{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:8px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:10;min-width:160px;padding:6px;opacity:0;pointer-events:none;transition:all .15s}
.ai-model-dropdown-ws.open{opacity:1;pointer-events:auto}
.ai-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:24px;background:var(--bg);-webkit-overflow-scrolling:touch;min-height:200px}
.ai-welcome{color:var(--text3);font-size:13px;line-height:1.6}
.ai-welcome p{margin:0}
.ai-welcome strong{color:var(--text);font-weight:600}
.ai-dashboard{display:flex;flex-direction:column;gap:8px}
.ai-insights-list{display:flex;flex-direction:column;gap:6px}
.ai-insight-card{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg);border-radius:8px;cursor:pointer;transition:all .15s;border-left:3px solid var(--border)}
.ai-insight-card:hover{background:var(--bg3);transform:translateX(2px)}
.ai-insight-card.positive{border-left-color:var(--green)}
.ai-insight-card.warning{border-left-color:var(--yellow)}
.ai-insight-card.negative{border-left-color:var(--red)}
.ai-insight-card.neutral{border-left-color:var(--accent)}
.ai-insight-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--text2);background:var(--bg2);border-radius:6px;flex-shrink:0}
.ai-insight-card.positive .ai-insight-icon{color:var(--green)}
.ai-insight-card.warning .ai-insight-icon{color:var(--yellow)}
.ai-insight-card.negative .ai-insight-icon{color:var(--red)}
.ai-insight-body{flex:1;min-width:0}
.ai-insight-title{font-size:13px;font-weight:500;color:var(--text);margin-bottom:2px}
.ai-insight-detail{font-size:11px;color:var(--text3)}
.ai-insight-arrow{color:var(--text3);font-size:11px;opacity:0;transition:opacity .15s}
.ai-insight-card:hover .ai-insight-arrow{opacity:1}
.ai-dashboard-hint{font-size:10px;color:var(--text-muted);text-align:center;padding-top:10px;border-top:1px solid var(--border);margin-top:6px}
.ai-prose{font-size:13px;line-height:1.7;color:var(--text)}
.ai-model-attribution{font-size:10px;color:var(--text3);text-align:right;margin-top:14px;padding-top:10px;border-top:1px solid var(--border);cursor:help}
.ai-prose p{margin-bottom:14px}
.ai-prose p:last-child{margin-bottom:0}
.ai-prose strong{color:var(--text);font-weight:600}
.ai-prose ul,.ai-prose ol{margin:12px 0 18px 0;padding-left:0;list-style:none}
.ai-prose li{margin:8px 0;padding:12px 14px 12px 32px;position:relative;line-height:1.6;background:var(--bg);border-radius:8px;border-left:3px solid var(--accent)}
.ai-prose li::before{content:'â†’';position:absolute;left:12px;color:var(--accent);font-size:12px}
.ai-section-header{font-size:11px;font-weight:600;color:var(--accent);letter-spacing:0.5px;text-transform:uppercase;margin:24px 0 12px 0;padding-bottom:6px;border-bottom:1px solid var(--border)}
.ai-section-header:first-child{margin-top:0}
.ai-part-link{color:var(--accent);cursor:pointer;text-decoration:underline;text-decoration-color:rgba(90,154,200,0.4);text-underline-offset:2px;transition:all .15s}
.ai-part-link:hover{color:var(--accent-hover);text-decoration-color:rgba(90,154,200,0.7)}
.ai-asm-link{color:var(--cyan);cursor:pointer;text-decoration:underline;text-decoration-color:rgba(106,160,170,0.4);text-underline-offset:2px;transition:all .15s}
.ai-asm-link:hover{color:var(--cyan);text-decoration-color:rgba(106,160,170,0.7)}
.ai-visual{margin:12px 0;padding:16px;background:var(--bg);border-radius:8px;display:flex;justify-content:center}
.ai-mini-chart{max-width:100%}
.ai-action-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;margin:8px 4px 8px 0;font-size:12px;font-weight:500;color:var(--accent);background:rgba(90,154,200,0.08);border:1px solid rgba(90,154,200,0.2);border-radius:6px;cursor:pointer;transition:all .15s}
.ai-action-btn:hover{background:rgba(90,154,200,0.15);border-color:rgba(90,154,200,0.4)}
.ai-input-row{display:flex;align-items:center;gap:12px;padding:14px 20px;background:var(--bg3);border-radius:0 0 12px 12px;border-top:1px solid var(--border)}
.ai-input-row input{flex:1;height:40px;padding:0 16px;font-size:13px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);transition:all .15s}
.ai-input-row input:focus{outline:none;border-color:var(--accent)}
.ai-input-row input::placeholder{color:var(--text3)}
.ai-input-row .btn{height:36px;padding:0 16px;font-size:13px;font-weight:500;border-radius:8px;min-width:auto}
.ai-input-row .btn:first-of-type{background:transparent;color:var(--text2);border:1px solid var(--border)}
.ai-input-row .btn:first-of-type:hover{background:var(--bg);color:var(--text)}

/* AI Workspace - Full Panel */
.ai-workspace{display:none;flex-direction:column;position:absolute;top:0;left:0;right:0;bottom:0;background:var(--bg2);z-index:10}
.ai-workspace.active{display:flex}
.ai-workspace-conversation{flex:1;overflow-y:auto;padding:32px 24px 24px;display:flex;justify-content:center}
.ai-workspace-conversation-inner{max-width:800px;width:100%}
.ai-welcome-minimal{color:var(--text3);font-size:14px;padding:60px 20px;text-align:center}
.ai-workspace-input-wrap{padding:0 24px 24px;margin-top:20px;width:100%;box-sizing:border-box}
.ai-workspace-input{display:flex;align-items:flex-end;gap:0;max-width:800px;width:100%;margin:0 auto;background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px 12px 10px 18px}
.ai-workspace-input textarea{flex:1;border:none;background:transparent;color:var(--text);font-size:14px;line-height:1.5;resize:none;max-height:140px;padding:8px 0;font-family:inherit}
.ai-workspace-input textarea:focus{outline:none}
.ai-workspace-input textarea::placeholder{color:var(--text3)}
.ai-input-actions{display:flex;align-items:center;gap:4px}
.ai-input-btn{width:34px;height:34px;border-radius:8px;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all .15s}
.ai-input-btn:hover{background:var(--bg3);color:var(--text)}
.ai-send-btn{width:34px;height:34px;border-radius:8px;background:var(--accent);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;transition:all .15s}
.ai-send-btn:hover{background:var(--accent-hover)}
.ai-msg{margin-bottom:24px;display:block;clear:both}
.ai-msg-user{display:flex;justify-content:flex-end}
.ai-msg-user .ai-msg-content{background:var(--bg3);color:var(--text);border-radius:12px;padding:12px 16px;max-width:80%;font-size:13px;line-height:1.5}
.ai-msg-assistant{display:block;margin-top:28px}
.ai-msg-thinking{margin-top:36px}
.ai-msg-assistant .ai-msg-content{color:var(--text);font-size:13px;line-height:1.7}
.ai-msg-assistant .ai-msg-content p{margin:0 0 14px 0}
.ai-msg-assistant .ai-msg-content p:last-child{margin-bottom:0}
.ai-msg-assistant .ai-msg-content ul{margin:12px 0;padding-left:24px}
.ai-msg-assistant .ai-msg-content li{margin:6px 0}
.ai-msg-assistant .ai-msg-content strong{color:var(--text);font-weight:600}
.ai-welcome-insights{display:flex;flex-direction:column;gap:10px;margin:24px 0}
.ai-welcome-insight{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s}
.ai-welcome-insight:hover{background:var(--bg3);border-color:var(--border-strong)}
.ai-welcome-insight.critical{border-left:3px solid var(--red)}
.ai-welcome-insight.warning{border-left:3px solid var(--yellow)}
.ai-welcome-insight.info{border-left:3px solid var(--cyan)}
.ai-welcome-insight.success{border-left:3px solid var(--green)}
.ai-welcome-insight-icon{font-size:16px;line-height:1}
.ai-welcome-insight-text{flex:1}
.ai-welcome-insight-title{font-size:14px;font-weight:500;color:var(--text);margin-bottom:2px}
.ai-welcome-insight-desc{font-size:12px;color:var(--text3)}
.ai-welcome-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:24px;justify-content:center}
.ai-suggest-btn{padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:20px;font-size:13px;color:var(--text2);cursor:pointer;transition:all .15s}
.ai-suggest-btn:hover{background:var(--bg3);color:var(--text);border-color:var(--text3)}

/* Thinking indicator - pulsating dot */
.ai-thinking-orb{position:relative;width:28px;height:28px;border-radius:50%;background:var(--accent-main);display:flex;align-items:center;justify-content:center}
.ai-thinking-plus{width:12px;height:12px;position:relative;animation:icon-spin-fast 0.08s linear infinite}
.ai-thinking-plus::before,.ai-thinking-plus::after{content:'';position:absolute;background:white;border-radius:50%;width:10px;height:10px;top:50%;left:50%;transform:translate(-50%,-50%);animation:dot-pulse 1.5s ease-in-out infinite}

.ai-visual{margin:20px 0;display:block;clear:both}
.ai-mini-chart{background:var(--bg2);border-radius:12px;border:1px solid var(--border);display:block}
.ai-action-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;cursor:pointer;transition:all .15s;margin:8px 8px 8px 0}
.ai-action-btn:hover{background:var(--bg3);border-color:var(--text3)}
.ai-action-btn svg{opacity:0.6;flex-shrink:0}
.ai-action-btn:hover svg{opacity:1}
.ai-part-link,.ai-asm-link{color:var(--accent);text-decoration:none;border-bottom:1px solid transparent}
.ai-part-link:hover,.ai-asm-link:hover{border-bottom-color:var(--accent)}
.btn-tell{background:var(--accent-main);color:white;border:none;border-radius:9px}
.btn-tell:hover{opacity:0.9}
.ai-conversation{display:flex;flex-direction:column;gap:28px}
.ai-message{font-size:15px;line-height:1.8}
.ai-message.user{color:#888;font-size:14px}
.ai-user-label{color:#60a5fa;font-weight:500}
.ai-message.assistant{color:#e0e0e0}
.ai-message.assistant p{margin:0 0 16px 0}
.ai-message.assistant p:last-child{margin-bottom:0}
.modal{background:var(--bg2);width:100%;max-width:400px;max-height:85vh;overflow-y:auto;border-radius:16px;border:none;box-shadow:0 16px 48px rgba(0,0,0,.25);-webkit-overflow-scrolling:touch}
.modal-head{padding:16px 18px;display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px;letter-spacing:-0.2px}
.modal-close{width:28px;height:28px;background:var(--bg3);border:none;border-radius:8px;color:var(--text2);font-size:14px;cursor:pointer;transition:all .15s}
.modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-body{padding:4px 18px 18px}
.modal-foot{padding:14px 18px;background:var(--bg3);display:flex;gap:8px;border-radius:0 0 14px 14px}
.modal-foot .btn{flex:1;height:36px}
.field{margin-bottom:14px}
.field-label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:6px;letter-spacing:0.2px}
.field-input,.field-select,.field-textarea{width:100%;height:38px;padding:0 12px;font-size:14px;color:var(--text);background:var(--bg);border:none;border-radius:10px}
.field-input:focus,.field-select:focus{outline:none;box-shadow:0 0 0 3px rgba(10,132,255,.3)}
.field-input[type="date"]{cursor:pointer;padding-right:12px;color-scheme:dark}
.field-input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer;filter:invert(0.8);opacity:1;width:24px;height:24px;padding:4px;border-radius:4px;background-color:var(--bg3)}
.field-input[type="date"]::-webkit-calendar-picker-indicator:hover{background-color:var(--bg4)}
.field-textarea{height:60px;padding:10px 12px;resize:none}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.notify-btn{width:100%;height:38px;margin-top:14px;background:var(--bg3);border:none;border-radius:10px;color:var(--yellow);font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
.notify-btn:hover{background:var(--bg4)}.notify-btn:disabled{opacity:.4;cursor:not-allowed}
.toast-box{position:fixed;bottom:16px;left:16px;right:16px;z-index:1100;pointer-events:none}

/* Login Screen - Clean minimal style */
.login-screen{position:fixed;inset:0;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;padding:20px}
.login-box{background:#f5f5f4;border-radius:16px;padding:28px 24px;width:100%;max-width:320px;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.login-logo{font-size:15px;font-weight:500;text-align:center;margin-bottom:20px;color:#1a1a1a;letter-spacing:-0.2px}
.login-subtitle{display:none}
.login-icon{display:none}
.login-divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:#888;font-size:12px}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:#ddd}
.login-field{margin-bottom:12px}
.login-field label{display:none}
.login-field input{width:100%;height:44px;padding:0 14px;font-size:14px;color:#1a1a1a;background:#fff;border:1px solid #d4d4d4;border-radius:8px;outline:none;transition:border-color .15s}
.login-field input::placeholder{color:#888}
.login-field input:focus{border-color:#1a1a1a}
.login-btn{width:100%;height:44px;font-size:14px;font-weight:500;color:#fff;background:#1a1a1a;border:none;border-radius:8px;cursor:pointer;transition:all .15s}
.login-btn:hover{background:#333}
.login-btn:active{transform:scale(0.98)}
.login-btn:disabled{opacity:0.5;cursor:not-allowed}
.login-btn-outline{width:100%;height:44px;font-size:14px;font-weight:500;color:#1a1a1a;background:#fff;border:1px solid #d4d4d4;border-radius:8px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px}
.login-btn-outline:hover{background:#f9f9f9;border-color:#bbb}
.login-btn-outline svg{width:18px;height:18px}
.login-footer{font-size:11px;color:#888;text-align:center;margin-top:16px;line-height:1.5}
.login-footer a{color:#666;text-decoration:underline}
.login-error{color:#dc2626;font-size:12px;text-align:center;margin-top:8px;min-height:16px}
.login-status{font-size:11px;color:#888;text-align:center;margin-top:16px}
.sync-indicator{position:fixed;top:62px;right:74px;padding:6px 12px;background:var(--bg2);border-radius:8px;font-size:11px;color:var(--text2);display:flex;align-items:center;gap:6px;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.2);opacity:0;transform:translateY(-5px);transition:opacity 0.4s ease,transform 0.4s ease;pointer-events:none}
.sync-indicator.active{opacity:1;transform:translateY(0);pointer-events:auto}
.sync-indicator.syncing{color:var(--yellow)}
.sync-indicator.syncing .sync-dot{animation:spin 1s linear infinite;border:2px solid var(--yellow);border-top-color:transparent;background:transparent}
.sync-indicator.synced{color:var(--green)}
.sync-indicator.offline{color:var(--red)}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.offline-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:2001;padding:20px}
.offline-overlay.active{display:flex}
.offline-box{background:#f5f5f4;border-radius:20px;padding:40px 32px;width:100%;max-width:360px;box-shadow:0 12px 48px rgba(0,0,0,.3);text-align:center}
.offline-icon{margin-bottom:20px;color:#c07070}
.offline-title{font-size:20px;font-weight:600;color:#1a1a1a;margin-bottom:8px}
.offline-message{font-size:14px;color:#666;margin-bottom:24px}
.offline-spinner{width:32px;height:32px;border:3px solid #e0e0e0;border-top-color:#c07070;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
.offline-hint{font-size:12px;color:#888;line-height:1.5}
.offline-pending{font-size:13px;font-weight:600;color:#1a1a1a;margin-bottom:16px;padding:8px 16px;background:#e8e8e8;border-radius:8px}

/* Online indicator */
.online-badge{display:flex;align-items:center;gap:6px;padding:5px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;font-size:11px;color:var(--text2);position:relative;cursor:pointer}
.online-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* Chat Panel */
/* Online hover card */
.online-hover{position:absolute;top:100%;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:400;display:none}
.online-badge:hover .online-hover{display:block}
.online-user{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px}
.online-user-dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.online-user-name{flex:1;color:var(--text)}
.online-user-time{font-size:10px;color:var(--text3)}

/* Part comments */
.comment-btn{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;padding:2px 4px;border-radius:4px;display:flex;align-items:center;gap:3px}
.comment-btn:hover{color:var(--accent);background:var(--bg4)}
.comment-btn.has-comments{color:var(--accent)}
.comment-count{font-size:10px}
.comments-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);z-index:1001;width:320px;max-height:400px;display:flex;flex-direction:column;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1);pointer-events:none}
.comments-popover.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.comments-header{padding:14px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center;color:var(--text)}
.comments-header button{background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px}
.comments-header button:hover{background:var(--bg3);color:var(--text)}
.comments-list{flex:1;overflow-y:auto;padding:12px;max-height:240px}
.comment-item{padding:10px 12px;background:var(--bg);border-radius:10px;margin-bottom:8px;font-size:12px}
.comment-item:last-child{margin-bottom:0}
.comment-author{font-weight:600;color:var(--accent);margin-bottom:2px}
.comment-text{color:var(--text);line-height:1.4}
.comment-time{font-size:9px;color:var(--text3);margin-top:4px}
.comments-input{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px}
.comments-input input{flex:1;height:36px;padding:0 12px;font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)}
.comments-input input:focus{border-color:var(--accent);outline:none}
.comments-input button{padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:500;cursor:pointer;transition:background .15s}
.comments-input button:hover{background:var(--accent-hover)}
.comments-empty{text-align:center;color:var(--text3);padding:30px 20px;font-size:12px;font-style:italic}

/* Item Code Configuration */
.item-config-list{max-height:300px;overflow-y:auto;margin:12px 0;border:1px solid var(--border);border-radius:8px}
.item-config-row{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);align-items:center}
.item-config-row:last-child{border-bottom:none}
.item-config-row.header{background:var(--bg3);font-weight:600;font-size:11px;color:var(--text2);position:sticky;top:0}
.item-config-code{font-weight:500;font-size:12px}
.item-config-code small{display:block;font-weight:400;color:var(--text3);font-size:10px;margin-top:2px}
.item-config-badges{display:flex;gap:4px;flex-wrap:wrap}
.item-config-badge{padding:2px 6px;border-radius:4px;font-size:10px;background:var(--bg4);color:var(--text2)}
.item-config-badge.active{background:var(--accent);color:#fff}
.item-config-badge.skip{background:var(--bg4);color:var(--text3);text-decoration:line-through}
.item-config-actions button{padding:4px 8px;font-size:11px;background:var(--bg4);border:none;border-radius:4px;color:var(--text2);cursor:pointer}
.item-config-actions button:hover{background:var(--accent);color:#fff}
.item-config-empty{text-align:center;padding:30px;color:var(--text3);font-size:12px}
.item-config-form{display:grid;gap:10px;padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:12px}
.item-config-form label{font-size:11px;color:var(--text2);margin-bottom:2px}
.item-config-form input[type="text"],.item-config-form select{width:100%;padding:8px 10px;font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.item-config-form .checkbox-row{display:flex;align-items:center;gap:8px;padding:6px 0}
.item-config-form .checkbox-row input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.item-config-form .checkbox-row label{font-size:12px;color:var(--text);margin:0}
.item-config-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.item-config-form .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.item-config-form button{padding:8px 16px;font-size:12px;border:none;border-radius:6px;cursor:pointer}
.item-config-form button.primary{background:var(--accent);color:#fff}
.item-config-form button.secondary{background:var(--bg4);color:var(--text2)}

.nav-preview-item{display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);gap:10px}
.nav-preview-item:last-child{border-bottom:none}
.nav-preview-item.no-match{opacity:0.5}
.nav-preview-name{flex:1;font-size:12px;font-weight:500;min-width:0}
.nav-preview-name .match{color:var(--green);font-size:10px;margin-left:6px}
.nav-preview-name .no-match{color:var(--text3);font-size:10px;margin-left:6px}
.nav-preview-po{font-size:11px;color:var(--accent);font-weight:500}
.nav-preview-eta{font-size:10px;color:var(--text2)}
.nav-preview-status{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg3)}
.nav-preview-status.will-receive{background:#1a3a2f;color:#6ee7b7}
.nav-preview-status.will-update{background:#3b3000;color:#fbbf24}

.po-details-popover{min-width:320px;max-width:400px;padding:0}
.po-details-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
.po-details-number{font-weight:600;font-size:14px}
.po-details-supplier{font-size:12px;color:var(--text2)}
.po-details-dates{display:flex;gap:16px;padding:10px 14px;font-size:11px;color:var(--text2);border-bottom:1px solid var(--border)}
.po-details-table{padding:8px 0}
.po-details-thead{display:grid;grid-template-columns:1fr 60px 70px;padding:4px 14px;font-size:10px;color:var(--text3);text-transform:uppercase;border-bottom:1px solid var(--border)}
.po-details-tbody{max-height:180px;overflow-y:auto}
.po-details-row{display:grid;grid-template-columns:1fr 60px 70px;padding:8px 14px;font-size:12px;align-items:center;border-bottom:1px solid var(--bg3)}
.po-details-row:last-child{border-bottom:none}
.po-details-row .item-name{display:flex;flex-direction:column;gap:2px}
.po-details-row .item-code{font-size:10px;color:var(--text3)}
.po-details-row .qty{text-align:center}
.po-details-row .status{display:flex;align-items:center;gap:4px}
.po-details-row .status.received{color:var(--green)}
.po-details-row .status.pending{color:var(--text3)}
.po-details-summary{padding:10px 14px;background:var(--bg3);font-size:12px;display:flex;justify-content:space-between;align-items:center}
.po-details-summary .progress-bar{width:100px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.po-details-summary .progress-fill{height:100%;background:var(--green);border-radius:3px}
.po-details-actions{padding:10px 14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end}
.po-details-actions .btn{font-size:11px;padding:6px 12px}

.toast{padding:14px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;font-size:14px;margin-top:10px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
.toast.success{border-left:3px solid var(--green)}.toast.err{border-left:3px solid var(--red)}
.dropdown{position:relative;z-index:1002}
.dropdown-menu{display:none;position:absolute;top:calc(100% + 8px);right:0;background:var(--bg2);border:1px solid var(--border);border-radius:14px;min-width:220px;z-index:1002;overflow:hidden;box-shadow:0 12px 48px rgba(0,0,0,.35),0 4px 16px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);padding:6px;opacity:0;transform:translateY(-10px) scale(0.98);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1)}
.dropdown-menu.open{display:block;opacity:1;transform:translateY(0) scale(1)}
.dropdown-item{padding:11px 16px;font-size:13px;font-weight:500;cursor:pointer;color:var(--text2);transition:all .15s;display:flex;align-items:center;gap:12px;border-radius:8px;margin:2px 0}
.dropdown-item:hover{background:var(--bg3);color:var(--text)}.dropdown-item.danger{color:var(--red)}
.dropdown-div{height:1px;background:var(--border);margin:8px 10px}
.team-list{margin-top:12px}
.team-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg);border-radius:10px;margin-bottom:6px;font-size:13px}
.team-item-info{flex:1}
.team-item-del{width:22px;height:22px;background:transparent;border:none;border-radius:6px;color:var(--red);cursor:pointer;font-size:12px;transition:all .15s}
.team-item-del:hover{background:rgba(255,69,58,.15)}
.eta-popover{min-width:320px;max-width:380px;padding:0}
.eta-popover-header{display:flex;flex-direction:column;gap:2px;padding:12px 14px;border-bottom:1px solid var(--border)}
.eta-popover-name{font-weight:600;font-size:14px}
.eta-popover-code{font-size:11px;color:var(--text3)}
.eta-popover-history{padding:10px 14px;border-bottom:1px solid var(--border)}
.eta-popover-history-title{font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:8px}
.eta-popover-history-empty{font-size:12px;color:var(--text3);padding:8px 0}
.eta-popover-history-item{display:flex;justify-content:space-between;font-size:12px;color:var(--text2);padding:4px 0}
.eta-popover-avg{display:flex;justify-content:space-between;font-size:12px;font-weight:500;padding:8px 0;margin-top:4px;border-top:1px solid var(--border)}
.eta-popover-input{padding:12px 14px}
.eta-popover-input label{font-size:11px;color:var(--text2);display:block;margin-bottom:6px}
.eta-popover-input input{width:100%;height:34px;padding:0 10px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:6px}
.eta-popover-actions{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.part-info-popover{min-width:300px;max-width:360px;padding:0;z-index:9600}
.part-info-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
.part-info-name{font-weight:600;font-size:14px;color:var(--text)}
.part-info-body{padding:12px 14px;font-size:12px}
.part-info-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
.part-info-row:last-child{border-bottom:none}
.part-info-label{color:var(--text3)}
.part-info-value{color:var(--text);font-weight:500;text-align:right}
.part-info-value.status{padding:2px 8px;border-radius:4px;font-size:11px}
.part-info-value.waiting{background:rgba(138,138,130,.1);color:var(--s0)}
.part-info-value.to-order{background:rgba(192,112,112,.1);color:var(--s1)}
.part-info-value.ordered{background:rgba(216,119,86,.1);color:var(--s2)}
.part-info-value.arrived{background:rgba(184,160,80,.1);color:var(--s3)}
.part-info-value.tested{background:rgba(106,160,170,.1);color:var(--s4)}
.part-info-value.configured{background:rgba(152,136,170,.1);color:var(--s5)}
.part-info-value.installed{background:rgba(106,170,106,.1);color:var(--s6)}
.part-info-notes{margin-top:8px;padding:8px;background:var(--bg);border-radius:6px;font-size:11px;color:var(--text2);line-height:1.5}
.part-info-footer{padding:10px 14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end}
.part-info-footer .btn-sm{height:28px;padding:0 12px;font-size:11px}
.pending-popover{width:280px;padding:0}
.pending-popover-header{padding:14px;font-size:14px;font-weight:600;border-bottom:1px solid var(--border)}
.pending-popover-note{padding:12px}
.pending-popover-note textarea{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;color:var(--text);resize:none;font-family:inherit}
.pending-popover-note textarea:focus{outline:none;border-color:var(--accent)}
.pending-popover-actions{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.pending-popover-actions .btn{height:32px;padding:0 14px;font-size:12px}
.status-badge.waiting.has-note::after{content:'';display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;margin-left:6px;vertical-align:middle}
.bom-modal{max-width:450px}
.bom-list{max-height:200px;overflow-y:auto;margin-bottom:12px}
.bom-item{display:flex;align-items:center;padding:8px 10px;background:var(--bg);border-radius:4px;margin-bottom:4px;cursor:pointer}
.bom-item:hover{background:var(--bg3)}
.bom-item-info{flex:1}
.bom-item-name{font-weight:600;font-size:12px}
.bom-item-meta{font-size:10px;color:var(--text3)}
.bom-item-del{width:20px;height:20px;background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--red);cursor:pointer;font-size:10px}
.leadtime-modal{max-width:500px}
.lt-item{background:var(--bg);border-radius:6px;padding:10px;margin-bottom:8px}
.itemconfig-modal{max-width:600px}
.itemconfig-list{max-height:350px;overflow-y:auto}
.itemconfig-item{background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px}
.itemconfig-item-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.itemconfig-code{font-weight:600;font-size:14px;flex:1;color:var(--accent)}
.itemconfig-del{width:24px;height:24px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--red);cursor:pointer;font-size:12px}
.itemconfig-options{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.itemconfig-opt{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg2);border-radius:6px}
.itemconfig-opt label{font-size:11px;color:var(--text2);flex:1}
.itemconfig-opt input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.itemconfig-opt select{flex:1;padding:4px 6px;font-size:11px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text)}
.itemconfig-add{display:flex;gap:8px;margin-bottom:12px;padding:12px;background:var(--bg);border-radius:8px}
.itemconfig-add input{flex:1;height:32px;padding:0 10px;font-size:12px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.itemconfig-add button{padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer}
.itemconfig-empty{text-align:center;padding:30px;color:var(--text3);font-size:13px}
.otd-modal{max-width:500px}
.otd-item{display:flex;align-items:center;background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px}
.otd-mfr{font-weight:600;font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.otd-stats{display:flex;gap:16px;align-items:center}
.otd-stat{text-align:center}
.otd-stat-val{font-size:16px;font-weight:600;display:block}
.otd-stat-label{font-size:10px;color:var(--text3)}
.otd-bar{width:60px;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}
.otd-bar-fill{height:100%;border-radius:3px}
.otd-empty{text-align:center;color:var(--text3);padding:30px}
.lt-code{font-weight:600;font-size:12px;margin-bottom:6px;color:var(--accent)}
.lt-stats{display:flex;gap:12px;font-size:10px;align-items:center}
.lt-stat-val{font-size:14px;font-weight:700;color:var(--purple)}
.lt-samples{font-size:9px;color:var(--text3)}

/* Tablet styles */
@media(max-width:1024px){
  .header-metrics{gap:6px}
  .hm{padding:6px 10px}
  .hm-progress{min-width:140px}
  .hm-bar{width:80px}
  .header-search{width:180px}
  .ai-console-btn{padding:8px 14px;font-size:12px}
}

/* Mobile styles - HIDE DESKTOP, SHOW MOBILE VIEW */
@media(max-width:768px){
  /* Hide entire desktop layout */
  .main{display:none!important}
  .header{display:none!important}
  /* Show mobile app */
  .mobile-app{display:flex!important}
}

/* ===== MOBILE APP (completely separate from desktop) ===== */
.mobile-app{
  display:none;
  flex-direction:column;
  height:100vh;
  height:100dvh;
  background:var(--bg);
  overflow:hidden;
}
.mob-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  padding-top:max(12px,env(safe-area-inset-top));
  background:var(--bg);
  border-bottom:1px solid var(--border);
  gap:12px;
  flex-shrink:0;
}
.mob-logo{font-size:15px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.mob-header-btns{display:flex;gap:8px}
.mob-btn{
  height:36px;
  padding:0 12px;
  font-size:13px;
  font-weight:500;
  color:var(--text2);
  background:var(--bg2);
  border:1px solid var(--border);
  border-radius:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.mob-btn:active{opacity:0.7;transform:scale(0.96)}
.mob-btn-primary{background:var(--btn-primary-bg);color:var(--btn-primary-text);border:none}
.mob-pipeline{
  display:flex;
  gap:6px;
  padding:12px 16px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  flex-shrink:0;
  background:var(--bg2);
}
.mob-pipe{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
  padding:8px 10px;
  background:var(--bg3);
  border-radius:10px;
  min-width:52px;
  flex-shrink:0;
  cursor:pointer;
  transition:all .15s;
}
.mob-pipe.active{background:var(--accent);color:white}
.mob-pipe.active .mob-pipe-label{color:rgba(255,255,255,0.8)}
.mob-pipe-count{font-size:18px;font-weight:600;color:var(--text)}
.mob-pipe.active .mob-pipe-count{color:white}
.mob-pipe-label{font-size:9px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px}
.mob-tabs{
  display:flex;
  gap:4px;
  padding:8px 16px;
  flex-shrink:0;
}
.mob-tab{
  flex:1;
  height:36px;
  font-size:13px;
  font-weight:500;
  color:var(--text3);
  background:transparent;
  border:none;
  border-radius:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.mob-tab.active{background:var(--bg3);color:var(--text)}
.mob-tab:active{opacity:0.7}
.mob-content{
  flex:1;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding:0 0 env(safe-area-inset-bottom) 0;
}
.mob-list{padding:8px}
.mob-asm{
  background:var(--bg2);
  border-radius:12px;
  margin-bottom:8px;
  overflow:hidden;
}
.mob-asm-header{
  display:flex;
  align-items:center;
  padding:14px 16px;
  gap:12px;
  cursor:pointer;
}
.mob-asm-header:active{background:var(--bg3)}
.mob-asm-toggle{font-size:12px;color:var(--text3);transition:transform .2s}
.mob-asm.expanded .mob-asm-toggle{transform:rotate(90deg)}
.mob-asm-info{flex:1;min-width:0}
.mob-asm-name{font-size:14px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mob-asm-meta{font-size:12px;color:var(--text3);margin-top:2px}
.mob-asm-progress{
  width:50px;
  height:6px;
  background:var(--bg4);
  border-radius:3px;
  overflow:hidden;
}
.mob-asm-progress-bar{height:100%;background:var(--green);border-radius:3px;transition:width .3s}
.mob-asm-pct{font-size:12px;font-weight:600;color:var(--text2);min-width:36px;text-align:right}
.mob-parts{display:none;border-top:1px solid var(--border)}
.mob-asm.expanded .mob-parts{display:block}
.mob-part{
  display:flex;
  align-items:center;
  padding:12px 16px;
  gap:12px;
  border-bottom:1px solid var(--border);
  cursor:pointer;
}
.mob-part:last-child{border-bottom:none}
.mob-part:active{background:var(--bg3)}
.mob-part-info{flex:1;min-width:0}
.mob-part-name{font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mob-part-meta{font-size:11px;color:var(--text3);margin-top:2px;display:flex;gap:8px;flex-wrap:wrap}
.mob-status{
  font-size:10px;
  font-weight:600;
  padding:4px 8px;
  border-radius:6px;
  text-transform:uppercase;
  letter-spacing:0.3px;
  white-space:nowrap;
}
.mob-status.waiting{background:rgba(138,138,130,0.15);color:var(--s0)}
.mob-status.to-order{background:rgba(192,112,112,0.15);color:var(--s1)}
.mob-status.ordered{background:rgba(216,119,86,0.15);color:var(--s2)}
.mob-status.arrived{background:rgba(184,160,80,0.15);color:var(--s3)}
.mob-status.tested{background:rgba(106,160,170,0.15);color:var(--s4)}
.mob-status.configured{background:rgba(152,136,170,0.15);color:var(--s5)}
.mob-status.installed{background:rgba(106,170,106,0.15);color:var(--s6)}
.mob-part-arrow{color:var(--text3);font-size:14px}
.mob-empty{padding:40px 20px;text-align:center;color:var(--text3);font-size:14px}
.mob-actions-list{padding:8px}
.mob-action{
  background:var(--bg2);
  border-radius:12px;
  padding:14px 16px;
  margin-bottom:8px;
  cursor:pointer;
}
.mob-action:active{background:var(--bg3)}
.mob-action-task{font-size:14px;font-weight:500;color:var(--text);margin-bottom:6px}
.mob-action-meta{display:flex;gap:12px;font-size:12px;color:var(--text3);flex-wrap:wrap}
.mob-action-status{
  font-size:10px;
  font-weight:600;
  padding:3px 8px;
  border-radius:5px;
  text-transform:uppercase;
}
.mob-action-status.pending{background:rgba(184,160,80,0.15);color:var(--s3)}
.mob-action-status.in-progress{background:rgba(90,154,200,0.15);color:var(--accent)}
.mob-action-status.completed{background:rgba(106,170,106,0.15);color:var(--s3)}
/* Mobile modal overrides */
.mob-modal{
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:1000;
  display:none;
  flex-direction:column;
}
.mob-modal.open{display:flex}
.mob-modal-header{
  display:flex;
  align-items:center;
  padding:12px 16px;
  padding-top:max(12px,env(safe-area-inset-top));
  border-bottom:1px solid var(--border);
  gap:12px;
}
.mob-modal-back{
  width:36px;
  height:36px;
  background:transparent;
  border:none;
  color:var(--accent);
  font-size:20px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
.mob-modal-title{flex:1;font-size:16px;font-weight:600;color:var(--text)}
.mob-modal-body{flex:1;overflow-y:auto;padding:16px}
.mob-field{margin-bottom:16px}
.mob-field-label{font-size:12px;font-weight:500;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px}
.mob-field-input,.mob-field-select{
  width:100%;
  height:48px;
  padding:0 14px;
  font-size:16px;
  color:var(--text);
  background:var(--bg2);
  border:1px solid var(--border);
  border-radius:10px;
}
.mob-field-input:focus,.mob-field-select:focus{border-color:var(--accent);outline:none}
.mob-modal-footer{
  padding:12px 16px;
  padding-bottom:max(12px,env(safe-area-inset-bottom));
  border-top:1px solid var(--border);
  display:flex;
  gap:10px;
}
.mob-modal-footer .mob-btn{flex:1;height:48px;font-size:15px}

/* Touch improvements */
@media(hover:none){
  .btn:hover,.sm-btn:hover,.adv-btn:hover,.pipe:hover,.tab:hover,.action-row:hover,.part-row:hover,.asm-row:hover{transform:none;filter:none}
  .btn:active,.sm-btn:active,.adv-btn:active{transform:scale(0.95);opacity:0.8}
  .pipe:active,.tab:active{background:var(--bg4)}
}

/* Safe area for notched devices */
@supports(padding:max(0px)){
  .header{padding-left:max(12px,env(safe-area-inset-left));padding-right:max(12px,env(safe-area-inset-right))}
  .main{padding-left:max(10px,env(safe-area-inset-left));padding-right:max(10px,env(safe-area-inset-right));padding-bottom:max(10px,env(safe-area-inset-bottom))}
  .modal{margin-bottom:env(safe-area-inset-bottom)}
}

/* Label Print Modal */
.label-modal{width:480px}
.label-modal .modal-body{padding:20px}
.label-options{display:flex;flex-direction:column;gap:16px;margin-bottom:20px}
.label-option-row{display:flex;align-items:center;gap:12px}
.label-option-row label{font-size:12px;color:var(--text2);width:100px;flex-shrink:0}
.label-option-row select{flex:1;height:32px;padding:0 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px}
.label-option-row input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.label-option-row .checkbox-label{font-size:12px;color:var(--text2);flex:1}
.label-preview-container{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:20px;display:flex;justify-content:center;align-items:center;min-height:150px}
.label-preview{background:#fff;color:#000;display:flex;align-items:center;gap:12px;padding:12px 16px;font-family:'Arial',sans-serif;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
.label-preview-qr{flex-shrink:0}
.label-preview-qr canvas{display:block}
.label-preview-info{flex:1;min-width:0}
.label-preview-name{font-size:14px;font-weight:600;margin-bottom:4px;word-break:break-word}
.label-preview-code{font-size:18px;font-weight:700;font-family:'Consolas','Courier New',monospace;margin-bottom:4px}
.label-preview-meta{font-size:10px;color:#666}
.label-count-info{text-align:center;font-size:11px;color:var(--text3);margin-top:12px}
.print-btn{background:var(--btn-primary-bg);color:var(--btn-primary-text);border:none;padding:0 20px;height:36px;font-size:13px;font-weight:500;border-radius:8px;cursor:pointer}
.print-btn:hover{opacity:0.9}
.print-btn svg{margin-right:6px}

/* Print button in row */
.print-label-btn{background:transparent;border:none;color:var(--text3);cursor:pointer;padding:4px;border-radius:4px;font-size:14px;opacity:0.6;transition:all .15s;width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;margin-right:4px}
.print-label-btn:hover{background:var(--bg3);color:var(--accent);opacity:1}
.part-row:hover .print-label-btn{opacity:1}
.part-actions{display:flex;align-items:center;gap:4px}

/* Print-specific styles - only shown when printing */
@media print{
  /* Hide everything except the print area */
  body *{visibility:hidden}
  #labelPrintArea,#labelPrintArea *{visibility:visible}
  #labelPrintArea{position:fixed;left:0;top:0;background:#fff;margin:0;padding:0}
  
  /* Individual label styling for print */
  .print-label{page-break-inside:avoid;background:#fff;color:#000;margin:0;padding:0}
  .print-label-inner{display:flex;align-items:center;gap:3mm;padding:2mm}
  .print-label-qr{flex-shrink:0}
  .print-label-qr img,.print-label-qr canvas{width:15mm;height:15mm}
  .print-label-info{flex:1}
  .print-label-name{font-size:11pt;font-weight:600;font-family:'Arial',sans-serif;margin-bottom:1mm}
  .print-label-code{font-size:14pt;font-weight:700;font-family:'Consolas','Courier New',monospace;margin-bottom:1mm}
  .print-label-meta{font-size:8pt;color:#333;font-family:'Arial',sans-serif}
  
  /* Label sizes */
  .print-label.size-102x51{width:102mm;height:51mm}
  .print-label.size-62x29{width:62mm;height:29mm}
  .print-label.size-62x100{width:62mm;height:100mm}
  .print-label.size-29x90{width:29mm;height:90mm}
  .print-label.size-29x90 .print-label-inner{flex-direction:column;text-align:center;padding:3mm}
  .print-label.size-29x90 .print-label-qr{margin-bottom:2mm}
  .print-label.size-29x90 .print-label-code{font-size:10pt}
  .print-label.size-29x90 .print-label-name{font-size:9pt}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
<div class="login-logo">EF Final Assembly</div>
<button class="login-btn-outline" id="loginQuick"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>Try Demo Project</button>
<div class="login-divider">OR</div>
<div class="login-field">
<input type="text" id="loginCode" placeholder="Enter project code" autocomplete="off">
</div>
<button class="login-btn" id="loginBtn">Open Project</button>
<div class="login-error" id="loginError"></div>
<div class="login-status" id="loginStatus">Connecting...</div>
</div>
</div>

<!-- Sync Indicator -->
<div class="sync-indicator" id="syncIndicator"><div class="sync-dot"></div><span id="syncText">Synced</span></div>

<!-- Offline Overlay -->
<div class="offline-overlay" id="offlineOverlay">
<div class="offline-box">
<div class="offline-icon">
  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
    <path d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0 1 19 12.55M5 12.55a10.94 10.94 0 0 1 5.17-2.39M10.71 5.05A16 16 0 0 1 22.58 9M1.42 9a15.91 15.91 0 0 1 4.7-2.88M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/>
  </svg>
</div>
<div class="offline-title">Connection Lost</div>
<div class="offline-message">Waiting for connection to be restored...</div>
<div class="offline-spinner"></div>
<div class="offline-pending" id="offlinePending"></div>
<div class="offline-hint">Your changes are saved locally and will sync when reconnected.</div>
</div>
</div>

<header class="header">
<div class="project-selector">
<div class="logo" id="projectName">EBS v2</div>
<button class="project-selector-btn" id="projectSelectorBtn" title="Switch Project"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg></button>
<button class="project-selector-btn" id="masterScheduleBtn" title="Master Schedule â€” All Projects"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="4" rx="1"/><rect x="3" y="10" width="13" height="4" rx="1"/><rect x="3" y="16" width="16" height="4" rx="1"/></svg></button>
<div class="project-dropdown" id="projectDropdown">
<div class="project-dropdown-header">Projects</div>
<div class="project-dropdown-list" id="projectDropdownList"></div>
<div class="project-dropdown-footer">
<div class="project-dropdown-action" id="newProjectBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Project</div>
<div class="project-dropdown-action" id="manageProjectsBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>Manage Projects</div>
</div>
</div>
</div>
<button class="ai-console-btn" id="aiAlert" title="AI Console"><div class="ai-console-icon"><span class="ai-console-plus"></span></div>AI Console</button>
<div class="header-spacer"></div>
<select class="filter-select" id="assigneeFilter"><option value="">All Assignees</option></select>
<button class="toggle-btn" id="expandToggle"><span class="arrow">â–¼</span> Expand</button>
<div class="header-spacer"></div>
<div class="online-badge"><div class="online-dot"></div><span id="onlineCount">1 online</span><div class="online-hover" id="onlineHover"><div id="onlineUserList"></div></div></div>
<div class="header-spacer"></div>
<div class="header-search"><input type="text" id="headerSearch" placeholder="Search parts..."><button class="header-search-clear" id="headerSearchClear">Ã—</button></div>
<div class="header-spacer"></div>
<div class="header-metrics" id="headerMetrics" onclick="window.toggleMetricsPopover(event)">
<div class="hm"><div><div class="hm-label">Ready</div><div class="hm-value" id="sReady">0/0</div></div></div>
<div class="hm" id="hmDays" style="display:none"><div><div class="hm-label">Days</div><div class="hm-value" id="sDays">â€”</div></div></div>
<div class="hm hm-progress" id="hmProgress"><div><div class="hm-label">Progress</div><div class="hm-value" id="sPct">0%</div></div><div class="hm-bar"><div class="hm-bar-fill" id="sBar"></div></div></div>
</div>
<div class="header-btns">
<button class="btn" id="themeBtn"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5.5"/><path d="M8 2.5v11M8 2.5a5.5 5.5 0 0 1 0 11" fill="currentColor" stroke="none"/></svg></button>
<button class="btn btn-receive" id="receivePOBtn"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M8 2v9M4.5 7.5 8 11l3.5-3.5M3 13h10"/></svg><span>Receive PO</span></button>
<div class="dropdown"><button class="btn" id="menuBtn">â˜°</button><div class="dropdown-menu" id="menuDrop"><div class="dropdown-item" id="reportBtn">ðŸ“Š Generate Report</div><div class="dropdown-div"></div><div class="dropdown-item" id="teamBtn">Team</div><div class="dropdown-item" id="datesBtn">Project Dates</div><div class="dropdown-item" id="milestonesBtn">ðŸ”· Milestones</div><div class="dropdown-item" id="leadtimeBtn">Lead Time Data</div><div class="dropdown-item" id="itemConfigBtn">Item Code Config</div><div class="dropdown-div"></div><div class="dropdown-item" id="saveTemplateBtn">ðŸ’¾ Save as Template</div><div class="dropdown-item" id="manageTemplatesBtn">ðŸ“‹ Manage Templates</div><div class="dropdown-div"></div><div class="dropdown-item" id="navImportBtn">ðŸ“¥ Import NAV Data</div><div class="dropdown-div"></div><div class="dropdown-item" id="sampleBtn">Load Sample Data</div><div class="dropdown-item" id="generateTestProjectsBtn">ðŸ§ª Generate 5 Test Projects</div><div class="dropdown-item danger" id="clearBtn">Clear All</div><div class="dropdown-div"></div><div class="dropdown-item" id="signOutBtn">Sign Out</div></div></div>
</div>
</header>
<main class="main">
<aside class="sidebar">
<div class="sidebar-section">
<div class="tabs">
<button class="tab active" data-tab="list"><span class="tab-icon">â˜°</span>Parts List</button>
<button class="tab" data-tab="gantt"><span class="tab-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg></span>Timeline</button>
</div>
</div>
<div class="sidebar-section">
<div class="sidebar-label">Pipeline</div>
<div class="pipeline">
<div class="pipe" data-s="waiting"><div class="pipe-count" id="p0">0</div><div class="pipe-label">Waiting</div></div>
<div class="pipe" data-s="to-order"><div class="pipe-count" id="p1">0</div><div class="pipe-label">To Order</div></div>
<div class="pipe" data-s="ordered"><div class="pipe-count" id="p2">0</div><div class="pipe-label">Ordered</div></div>
<div class="pipe" data-s="arrived"><div class="pipe-count" id="p3">0</div><div class="pipe-label">Arrived</div></div>
<div class="pipe" data-s="tested"><div class="pipe-count" id="p4">0</div><div class="pipe-label">Tested</div></div>
<div class="pipe" data-s="configured"><div class="pipe-count" id="p5">0</div><div class="pipe-label">Configured</div></div>
<div class="pipe" data-s="installed"><div class="pipe-count" id="p6">0</div><div class="pipe-label">Installed</div></div>
</div>
</div>
<div class="cmd-minimized" id="cmdMinimized" title="Restore AI Console">
<span class="cmd-minimized-icon">â– </span>
<span class="cmd-minimized-title">AI Console</span>
</div>
<div style="flex:1"></div>
<div class="version-badge" id="versionBadge">v2.1.0
<div class="version-info">
<div class="version-info-row"><span class="version-info-label">Version</span><span class="version-info-value">1.0.2</span></div>
<div class="version-info-row"><span class="version-info-label">Server</span><span class="version-info-value" id="serverStatus">Firebase</span></div>
<div class="version-info-divider"></div>
<div class="version-info-row"><span class="version-info-label">Project</span><span class="version-info-value" id="infoProjectId">â€”</span></div>
<div class="version-info-row"><span class="version-info-label">User</span><span class="version-info-value" id="infoUserEmail">â€”</span></div>
<div class="version-info-divider"></div>
<div class="version-info-row"><span class="version-info-label">Last sync</span><span class="version-info-value" id="infoLastSync">â€”</span></div>
</div>
</div>
</aside>
<div class="content">
<div class="panel active" id="listPanel">
<div class="filter-badges" id="filterBadges"></div>
<div class="bulk-bar" id="bulkBar"><span class="bulk-bar-count"><span id="bulkCount">0</span> selected</span><div class="bulk-bar-actions"><button class="btn" id="bulkStatusBtn">Set Status</button><button class="btn" id="bulkAssignBtn">Set Assignee</button><button class="btn" id="bulkPOBtn">Set PO</button><button class="btn" id="bulkPrintBtn">ðŸ·ï¸ Print Labels</button><button class="btn btn-danger" id="bulkDeleteBtn">Delete</button><button class="btn btn-clear" id="bulkClearBtn">âœ• Clear</button></div></div>
<div class="data-table" id="partsTable"><div class="table-header parts-grid"><div><input type="checkbox" class="part-checkbox" id="selectAllParts" title="Select all"></div><div>Name</div><div>Code</div><div>Mfr</div><div>Assignee</div><div>Qty</div><div>Status</div><div>Prog</div><div>ETA / PO</div><div>Notes</div><div></div></div><div class="table-body" id="partsList"></div></div>
<div class="empty" id="emptyList" style="display:none;">No items found</div>
</div>
<div class="panel" id="progressPanel">
<div class="progress-layout-full">
<div class="progress-row">
<div class="card"><div class="card-title">Burndown Chart <a id="burndownEdit">Edit Dates</a></div><div class="burndown-container" id="burndownChart"></div><div class="burndown-dates" id="burndownDates"></div><div class="burndown-legend"><div class="legend-item"><div class="legend-dot green"></div> Ahead</div><div class="legend-item"><div class="legend-dot red"></div> Behind</div><div class="legend-item"><div class="legend-dot gray"></div> Target</div><div class="legend-item"><div style="width:16px;height:2px;background:repeating-linear-gradient(90deg,var(--text3) 0,var(--text3) 3px,transparent 3px,transparent 6px);opacity:0.7;border-radius:1px"></div> Forecast</div><div class="legend-item"><div style="width:1px;height:10px;background:var(--accent);opacity:0.5"></div> Today</div></div></div>
</div>
<div class="progress-row">
<div class="card"><div class="card-title">Assembly Progress</div><div class="asm-progress-list" id="asmProgressList"></div></div>
<div class="card"><div class="card-title">Bottlenecks</div><div class="bottleneck-list" id="bottleneckList"></div></div>
<div class="card"><div class="card-title">Velocity Forecast</div><div class="forecast-card-inner"><div class="forecast-main"><span class="forecast-date" id="forecastDate">â€”</span><span class="forecast-label" id="forecastLabel"></span></div><div class="forecast-detail" id="forecastDetail"></div></div></div>
</div>
</div>
</div>
<div class="panel" id="ganttPanel">
<div class="gantt-container">
<div class="gantt-toolbar">
<span class="gantt-toolbar-title">Project Timeline</span>
<div class="gantt-toolbar-actions">
<span id="ganttConflictBadge" style="display:none;position:relative"></span>
<select class="gantt-filter-select" id="ganttResourceFilter">
<option value="">All Resources</option>
</select>
<button class="btn btn-sm" id="ganttExportPdf">ðŸ“„ Export PDF</button>
<button class="btn btn-sm" id="ganttToday">Today</button>
</div>
</div>
<div class="gantt-header-row">
<div class="gantt-sidebar-header">
<div class="gantt-col-name">Task Name</div>
<div class="gantt-col-resource">Resource</div>
<div class="gantt-col-start">Start</div>
<div class="gantt-col-end">End</div>
<div class="gantt-col-dur">Days</div>
</div>
<div class="gantt-timeline-header-wrap" id="ganttTimelineHeaderWrap">
<div class="gantt-timeline-header" id="ganttTimelineHeader"></div>
</div>
</div>
<div class="gantt-body-wrap" id="ganttBodyWrap">
<div class="gantt-body-inner" id="ganttBodyInner">
<div class="gantt-sidebar-body" id="ganttSidebar"></div>
<div class="gantt-timeline-body" id="ganttTimelineBody"></div>
</div>
</div>
</div>
<div class="gantt-color-popup" id="ganttColorPopup">
<div class="gantt-color-title">Bar Color</div>
<div class="gantt-color-grid" id="ganttColorGrid"></div>
</div>
<div class="gantt-date-popup" id="ganttDatePopup">
<div class="gantt-date-popup-title" id="ganttDatePopupTitle">Set Date</div>
<input type="date" class="gantt-date-popup-input" id="ganttDatePopupInput">
<div class="gantt-date-popup-btns">
<button class="btn btn-sm" id="ganttDatePopupClear">Clear</button>
<button class="btn btn-sm btn-primary" id="ganttDatePopupSave">Save</button>
</div>
</div>
<div class="gantt-tooltip" id="ganttTooltip">
<div class="gantt-tooltip-title" id="ganttTooltipTitle"></div>
<div class="gantt-tooltip-body" id="ganttTooltipBody"></div>
</div>
</div>
<div class="ai-workspace" id="aiWorkspace">
<div class="ai-workspace-conversation" id="aiWorkspaceConversation">
<div class="ai-workspace-conversation-inner">
<div class="ai-welcome-minimal">What would you like to know?</div>
</div>
</div>
<div class="ai-workspace-input-wrap">
<div class="ai-workspace-input">
<textarea id="aiWorkspaceQuestion" placeholder="Reply..." rows="1"></textarea>
<div class="ai-input-actions">
<div class="ai-model-selector-ws"><button class="ai-model-badge-ws" id="aiModelBadgeWs" onclick="window.toggleModelSelectorWs(event)">sonnet-4.5 <span style="opacity:0.5">â–¾</span></button><div class="ai-model-dropdown-ws" id="aiModelDropdownWs"><button class="ai-model-option" data-model="claude-haiku-4-5-20251001" onclick="window.selectAIModelWs(this)"><span class="model-name">Haiku 4.5</span><span class="model-desc">Fast & efficient</span></button><button class="ai-model-option active" data-model="claude-sonnet-4-5-20250929" onclick="window.selectAIModelWs(this)"><span class="model-name">Sonnet 4.5</span><span class="model-desc">Balanced</span></button><button class="ai-model-option" data-model="claude-opus-4-5-20251101" onclick="window.selectAIModelWs(this)"><span class="model-name">Opus 4.5</span><span class="model-desc">Most capable</span></button></div></div>
<button class="ai-input-btn" id="aiWorkspaceTellBtn" title="Get briefing">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg>
</button>
<button class="ai-send-btn" id="aiWorkspaceAskBtn" title="Send">
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
</button>
</div>
</div>
</div>
</div>
</main>

<!-- ===== MOBILE APP (completely separate from desktop) ===== -->
<div class="mobile-app" id="mobileApp">
  <header class="mob-header">
    <div class="mob-logo" id="mobLogo">EF Final Assembly</div>
    <div class="mob-header-btns">
      <button class="mob-btn" id="mobMenuBtn">â˜°</button>
    </div>
  </header>
  <div class="mob-pipeline" id="mobPipeline">
    <div class="mob-pipe" data-status="waiting"><div class="mob-pipe-count" id="mobP0">0</div><div class="mob-pipe-label">Waiting</div></div>
    <div class="mob-pipe" data-status="to-order"><div class="mob-pipe-count" id="mobP1">0</div><div class="mob-pipe-label">To Order</div></div>
    <div class="mob-pipe" data-status="ordered"><div class="mob-pipe-count" id="mobP2">0</div><div class="mob-pipe-label">Ordered</div></div>
    <div class="mob-pipe" data-status="arrived"><div class="mob-pipe-count" id="mobP3">0</div><div class="mob-pipe-label">Arrived</div></div>
    <div class="mob-pipe" data-status="tested"><div class="mob-pipe-count" id="mobP4">0</div><div class="mob-pipe-label">Tested</div></div>
    <div class="mob-pipe" data-status="configured"><div class="mob-pipe-count" id="mobP5">0</div><div class="mob-pipe-label">Config</div></div>
    <div class="mob-pipe" data-status="installed"><div class="mob-pipe-count" id="mobP6">0</div><div class="mob-pipe-label">Done</div></div>
  </div>
  <div class="mob-content">
    <div class="mob-list" id="mobPartsList"></div>
  </div>
</div>

<!-- Mobile Part Modal -->
<div class="mob-modal" id="mobPartModal">
  <div class="mob-modal-header">
    <button class="mob-modal-back" id="mobPartBack">â†</button>
    <div class="mob-modal-title" id="mobPartTitle">Part Details</div>
  </div>
  <div class="mob-modal-body">
    <div class="mob-field">
      <div class="mob-field-label">Name</div>
      <input type="text" class="mob-field-input" id="mobPartName">
    </div>
    <div class="mob-field">
      <div class="mob-field-label">Status</div>
      <select class="mob-field-select" id="mobPartStatus">
        <option value="waiting">Waiting</option>
        <option value="to-order">To Order</option>
        <option value="ordered">Ordered</option>
        <option value="arrived">Arrived</option>
        <option value="tested">Tested</option>
        <option value="configured">Configured</option>
        <option value="installed">Installed</option>
      </select>
    </div>
    <div class="mob-field">
      <div class="mob-field-label">Assignee</div>
      <select class="mob-field-select" id="mobPartAssignee"></select>
    </div>
    <div class="mob-field">
      <div class="mob-field-label">PO Number</div>
      <input type="text" class="mob-field-input" id="mobPartPO">
    </div>
  </div>
  <div class="mob-modal-footer">
    <button class="mob-btn" id="mobPartCancel">Cancel</button>
    <button class="mob-btn mob-btn-primary" id="mobPartSave">Save</button>
  </div>
</div>

<!-- Mobile Menu Modal -->
<div class="mob-modal" id="mobMenuModal">
  <div class="mob-modal-header">
    <button class="mob-modal-back" id="mobMenuBack">â†</button>
    <div class="mob-modal-title">Menu</div>
  </div>
  <div class="mob-modal-body">
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="mob-btn" id="mobSampleBtn" style="justify-content:flex-start;padding:0 16px">ðŸ“¦ Load Sample Data</button>
      <button class="mob-btn" id="mobSignOutBtn" style="justify-content:flex-start;padding:0 16px">ðŸšª Sign Out</button>
    </div>
  </div>
</div>

<div class="cmd-window" id="cmdWindow">
<div class="cmd-titlebar" id="cmdTitlebar">
<span class="cmd-icon">â– </span>
<span class="cmd-title">AI Console</span>
<div class="cmd-controls">
<select class="cmd-model-select" id="cmdModelSelect">
<option value="claude-haiku-4-5-20251001">haiku-4.5</option>
<option value="claude-sonnet-4-5-20250929" selected>sonnet-4.5</option>
<option value="claude-opus-4-5-20251101">opus-4.5</option>
</select>
<button class="cmd-ctrl-btn" id="cmdMinimize" title="Minimize">â”€</button>
<button class="cmd-ctrl-btn" id="cmdClose" title="Close">Ã—</button>
</div>
</div>
<div class="cmd-body" id="cmdBody">
<div class="cmd-line muted">Click a suggestion below or type your own question.</div>
</div>
<div class="cmd-suggestions" id="cmdSuggestions"></div>
<div class="cmd-input-row">
<span class="cmd-prompt">&gt;</span>
<input type="text" class="cmd-input" id="cmdInput" placeholder="Ask about your project...">
<div class="cmd-btn-row">
<button class="cmd-btn" id="cmdAsk">Ask</button>
<button class="cmd-btn primary" id="cmdTell">Tell me</button>
</div>
</div>
</div>
<div class="modal-popover report-popover" id="reportModal"><div class="modal-head"><span class="modal-title">Project Status Report</span><span class="report-model-badge" id="reportModelBadge"></span><button class="report-refresh-btn" id="reportRefresh" title="Regenerate report">â†»</button><button class="modal-close" id="reportClose">Ã—</button></div><div class="modal-body"><div class="report-content" id="reportContent"></div></div><div class="modal-foot"><button class="btn" id="reportCopy">Copy</button><button class="btn btn-primary" id="reportEmail">Email</button></div></div>
<div class="popover eta-popover" id="etaPopover">
<div class="eta-popover-header"><span class="eta-popover-name" id="etaPartName"></span><span class="eta-popover-code" id="etaCode"></span></div>
<div class="eta-popover-history" id="etaHistory"></div>
<div class="eta-popover-input"><label>Expected Arrival Date</label><input type="date" id="etaDateInput"></div>
<div class="eta-popover-actions"><button class="btn" id="etaClear">Clear</button><button class="btn btn-primary" id="etaSave">Save</button></div>
</div>
<div class="modal-bg" id="bomModal"><div class="modal bom-modal"><div class="modal-head"><span class="modal-title" id="bomTitle">ðŸ’¾ Save Specification</span><button class="modal-close" id="bomClose">Ã—</button></div><div class="modal-body"><div class="field" id="bomNameField"><label class="field-label">Specification Name</label><input type="text" class="field-input" id="bomName" placeholder="e.g. Standard Control Panel"></div><div class="bom-list" id="bomList"></div></div><div class="modal-foot"><button class="btn" id="bomCancel">Cancel</button><button class="btn btn-primary" id="bomSave">Save</button></div></div></div>
<div class="modal-bg" id="leadtimeModal"><div class="modal leadtime-modal"><div class="modal-head"><span class="modal-title">ðŸ“Š Lead Time Database</span><button class="modal-close" id="ltClose">Ã—</button></div><div class="modal-body" id="ltBody"></div><div class="modal-foot"><button class="btn" id="ltClear">Clear Data</button><button class="btn btn-primary" id="ltDone">Done</button></div></div></div>
<div class="modal-bg" id="itemConfigModal"><div class="modal itemconfig-modal"><div class="modal-head"><span class="modal-title">âš™ï¸ Item Code Configuration</span><button class="modal-close" id="icClose">Ã—</button></div><div class="modal-body"><p style="font-size:12px;color:var(--text2);margin-bottom:12px">Configure testing and configuration requirements per item code. These settings persist across projects.</p><div class="itemconfig-add"><input type="text" id="icNewCode" placeholder="Enter item code..."><button id="icAddBtn">Add Code</button></div><div class="itemconfig-list" id="icList"></div></div><div class="modal-foot"><button class="btn btn-primary" id="icDone">Done</button></div></div></div>
<div class="modal-bg" id="otdModal"><div class="modal otd-modal"><div class="modal-head"><span class="modal-title">ðŸšš Supplier On-Time Delivery</span><button class="modal-close" id="otdClose">Ã—</button></div><div class="modal-body" id="otdBody"></div><div class="modal-foot"><button class="btn btn-primary" id="otdDone">Done</button></div></div></div>
<div class="popover-backdrop" id="popoverBackdrop"></div>

<!-- Metrics Popover -->
<div class="metrics-popover" id="metricsPopover">
<div class="metrics-section metrics-section-full">
<div class="metrics-section-title">Progress Chart <span id="mpDeadlineLabel" style="font-weight:normal;color:var(--text-muted);font-size:11px;margin-left:8px"></span></div>
<div class="mp-chart-wrapper" style="position:relative">
<div class="mp-chart-container" id="mpChart"></div>
<div class="mp-chart-tooltip" id="mpChartTooltip"></div>
<div class="mp-forecast-popover" id="mpForecastPopover" style="display:none">
  <button class="mp-forecast-popover-close" onclick="$('mpForecastPopover').style.display='none'">Ã—</button>
  <div class="mp-forecast-popover-title" id="mpForecastPopoverTitle">Forecasted Finish</div>
  <div id="mpForecastPopoverContent"></div>
</div>
</div>
<div class="mp-chart-legend"><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--green)"></span>Ahead</span><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--red)"></span>Behind</span><span class="mp-legend-item"><span class="mp-legend-dot" style="background:var(--text3)"></span>Target</span><span class="mp-legend-item"><span style="width:16px;height:2px;background:repeating-linear-gradient(90deg,var(--text3) 0,var(--text3) 3px,transparent 3px,transparent 6px);opacity:0.7;border-radius:1px"></span>Forecast</span><span class="mp-legend-item"><span style="width:1px;height:10px;background:var(--accent);opacity:0.5"></span>Today</span></div>
</div>
<div class="metrics-row">
<div class="metrics-section">
<div class="metrics-section-title">Velocity Forecast</div>
<div class="mp-forecast" id="mpForecast"></div>
</div>
<div class="metrics-section">
<div class="metrics-section-title">Bottlenecks</div>
<div class="mp-bottlenecks" id="mpBottlenecks"></div>
</div>
</div>
</div>
<div class="modal-popover" id="partModal"><div class="modal-head"><span class="modal-title" id="pmTitle">Add Part</span><button class="modal-close" id="pmClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="pmName"></div><div class="field-row"><div class="field"><label class="field-label">Item Code</label><input type="text" class="field-input" id="pmCode"></div><div class="field"><label class="field-label">Manufacturer</label><input type="text" class="field-input" id="pmMfr"></div></div><div class="field-row"><div class="field"><label class="field-label">Qty</label><input type="number" class="field-input" id="pmQty" value="1" min="1"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="pmAssignee"></select></div></div><div class="field-row"><div class="field"><label class="field-label">Status</label><select class="field-select" id="pmStatus"><option value="waiting">Waiting</option><option value="to-order">To Order</option><option value="ordered">Ordered</option><option value="arrived">Arrived</option><option value="tested">Tested</option><option value="configured">Configured</option><option value="installed">Installed</option></select></div><div class="field"><label class="field-label">Assembly</label><select class="field-select" id="pmParent"></select></div></div><div class="field"><label class="field-label">Notes</label><textarea class="field-textarea" id="pmNotes"></textarea></div><button class="notify-btn" id="pmNotify" disabled>ðŸ”” Notify</button></div><div class="modal-foot"><button class="btn" id="pmCancel">Cancel</button><button class="btn btn-primary" id="pmSave">Save</button></div></div>
<div class="modal-popover" id="asmModal"><div class="modal-head"><span class="modal-title" id="amTitle">Add Assembly</span><button class="modal-close" id="amClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="amName"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="amAssignee"></select></div><div class="field"><label class="field-label">Notes</label><textarea class="field-textarea" id="amNotes"></textarea></div><button class="notify-btn" id="amNotify" disabled>ðŸ”” Notify</button></div><div class="modal-foot"><button class="btn" id="amCancel">Cancel</button><button class="btn btn-primary" id="amSave">Save</button></div></div>
<div class="modal-popover" id="actionModal"><div class="modal-head"><span class="modal-title" id="actTitle">Add Action</span><button class="modal-close" id="actClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Task</label><input type="text" class="field-input" id="actTask"></div><div class="field"><label class="field-label">Linked Part</label><select class="field-select" id="actLinkedPart"></select></div><div class="field-row"><div class="field"><label class="field-label">Due Date</label><input type="date" class="field-input" id="actDue"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="actAssignee"></select></div></div><div class="field"><label class="field-label">Status</label><select class="field-select" id="actStatus"><option value="not-started">Not Started</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div></div><div class="modal-foot"><button class="btn" id="actCancel">Cancel</button><button class="btn btn-primary" id="actSave">Save</button></div></div>
<div class="modal-bg" id="teamModal"><div class="modal"><div class="modal-head"><span class="modal-title">Team</span><button class="modal-close" id="teamClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="teamName"></div><div class="field"><label class="field-label">Email</label><input type="email" class="field-input" id="teamEmail"></div><button class="btn btn-primary" id="teamAdd" style="width:100%">Add</button><div class="team-list" id="teamList"></div></div><div class="modal-foot"><button class="btn" id="teamDone">Done</button></div></div></div>
<div class="modal-bg" id="milestonesModal"><div class="modal"><div class="modal-head"><span class="modal-title">Milestones</span><button class="modal-close" id="milestonesClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="milestoneName" placeholder="e.g. Customer Delivery"></div><div class="field"><label class="field-label">Date</label><input type="date" class="field-input" id="milestoneDate"></div><div class="field"><label class="field-label">Type</label><select class="field-input" id="milestoneType"><option value="deadline">ðŸ”´ Deadline</option><option value="delivery">ðŸŸ¢ Delivery</option><option value="review">ðŸŸ  Review</option><option value="custom">ðŸŸ£ Custom</option></select></div><button class="btn btn-primary" id="milestoneAdd" style="width:100%">Add Milestone</button><div class="team-list" id="milestoneList"></div></div><div class="modal-foot"><button class="btn" id="milestonesDone">Done</button></div></div></div>
<div class="modal-bg" id="datesModal"><div class="modal"><div class="modal-head"><span class="modal-title">Project Dates</span><button class="modal-close" id="datesClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Start</label><input type="date" class="field-input" id="startDate"></div><div class="field"><label class="field-label">End</label><input type="date" class="field-input" id="endDate"></div></div><div class="modal-foot"><button class="btn" id="datesCancel">Cancel</button><button class="btn btn-primary" id="datesSave">Save</button></div></div></div>
<div class="modal-popover theme-popover" id="themeModal"><div class="modal-head"><span class="modal-title">Theme</span><button class="modal-close" id="themeClose">Ã—</button></div><div class="modal-body"><div class="theme-grid" id="themeGrid"></div></div></div>
<div class="modal-bg" id="itemConfigModal"><div class="modal" style="max-width:500px"><div class="modal-head"><span class="modal-title">âš™ï¸ Item Code Configuration</span><button class="modal-close" id="icClose">Ã—</button></div><div class="modal-body">
<div class="item-config-form" id="icForm">
<div style="font-size:11px;color:var(--text3);margin-bottom:8px">Configure which phases apply to each item code. Settings are saved globally and reused across projects.</div>
<div><label>Item Code</label><input type="text" id="icCode" placeholder="e.g., PLC-001" style="text-transform:uppercase"></div>
<div class="form-row">
<div class="checkbox-row"><input type="checkbox" id="icReqConfig"><label for="icReqConfig">Requires Configuration</label></div>
<div class="checkbox-row"><input type="checkbox" id="icReqTest" checked><label for="icReqTest">Requires Testing</label></div>
</div>
<div class="form-row">
<div><label>Configured By</label><select id="icConfigBy"><option value="">Anyone</option></select></div>
<div><label>Tested By</label><select id="icTestBy"><option value="">Anyone</option></select></div>
</div>
<div class="form-actions"><button class="secondary" id="icClear">Clear</button><button class="primary" id="icSave">Save Configuration</button></div>
</div>
<div class="item-config-list" id="icList"></div>
</div><div class="modal-foot"><button class="btn" id="icExport">Export</button><button class="btn btn-primary" id="icDone">Done</button></div></div></div>
<div class="modal-popover po-popover" id="poModal"><div class="modal-head"><span class="modal-title">Order Details</span><button class="modal-close" id="poClose">Ã—</button></div><div class="modal-body"><div id="poPartName" style="font-weight:600;margin-bottom:12px;font-size:14px"></div><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="poNumber" placeholder="e.g. PO-2024-001"></div><div class="field"><label class="field-label">Expected Arrival Date</label><input type="date" class="field-input" id="poArrivalDate"></div><div class="po-note">Leave arrival date empty to use historical lead time data</div></div><div class="modal-foot"><button class="btn" id="poCancel">Cancel</button><button class="btn btn-primary" id="poSave">Confirm Order</button></div></div>
<div class="modal-popover receive-po-popover" id="receivePOModal"><div class="modal-head"><span class="modal-title">Receive PO</span><button class="modal-close" id="receivePOClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="receivePONumber" placeholder="Enter PO number..." list="poSuggestions"><datalist id="poSuggestions"></datalist></div><div class="receive-po-preview" id="receivePOPreview"><div class="receive-po-empty">Enter a PO number to see matching parts</div></div></div><div class="modal-foot"><button class="btn" id="receivePOCancel">Cancel</button><button class="btn btn-primary" id="receivePOConfirm" disabled>Receive All</button></div></div>
<div class="popover" id="deletePopover"><div class="popover-msg" id="deleteMsg"></div><div class="popover-btns"><button class="btn" id="deleteCancel">Cancel</button><button class="btn btn-danger" id="deleteConfirm">Delete</button></div></div>
<div class="modal-popover bulk-popover" id="bulkStatusModal"><div class="modal-head"><span class="modal-title">Set Status</span><button class="modal-close" id="bulkStatusClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkStatusPreview"></div><div class="field"><label class="field-label">New Status</label><select class="field-select" id="bulkStatusSelect"><option value="">Select status...</option><option value="waiting">Waiting</option><option value="to-order">To Order</option><option value="ordered">Ordered</option><option value="arrived">Arrived</option><option value="tested">Tested</option><option value="configured">Configured</option><option value="installed">Installed</option></select></div><div id="bulkPOFields" style="display:none"><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="bulkStatusPO" placeholder="e.g. PO-2024-001"></div><div class="field"><label class="field-label">Expected Arrival Date</label><input type="date" class="field-input" id="bulkStatusETA"></div></div></div><div class="modal-foot"><button class="btn" id="bulkStatusCancel">Cancel</button><button class="btn btn-primary" id="bulkStatusApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkAssignModal"><div class="modal-head"><span class="modal-title">Set Assignee</span><button class="modal-close" id="bulkAssignClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkAssignPreview"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="bulkAssignSelect"></select></div></div><div class="modal-foot"><button class="btn" id="bulkAssignCancel">Cancel</button><button class="btn btn-primary" id="bulkAssignApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkPOModal"><div class="modal-head"><span class="modal-title">Set PO Number</span><button class="modal-close" id="bulkPOClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkPOPreview"></div><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="bulkPOInput" placeholder="e.g. PO-2024-001"></div></div><div class="modal-foot"><button class="btn" id="bulkPOCancel">Cancel</button><button class="btn btn-primary" id="bulkPOApply">Apply</button></div></div>
<div class="modal-popover bulk-popover" id="bulkDeleteModal"><div class="modal-head"><span class="modal-title">Delete Parts</span><button class="modal-close" id="bulkDeleteClose">Ã—</button></div><div class="modal-body"><div class="bulk-preview" id="bulkDeletePreview"></div><p style="color:var(--red);font-size:12px;margin-top:8px">This action cannot be undone.</p></div><div class="modal-foot"><button class="btn" id="bulkDeleteCancel">Cancel</button><button class="btn btn-danger" id="bulkDeleteApply">Delete All</button></div></div>
<div class="modal-bg" id="navImportModal"><div class="modal" style="max-width:600px"><div class="modal-head"><span class="modal-title">ðŸ“¥ Import NAV Data</span><button class="modal-close" id="navImportClose">Ã—</button></div><div class="modal-body">
<div style="font-size:12px;color:var(--text2);margin-bottom:16px">Import PO data exported from NAV to automatically update parts with PO numbers, expected arrival dates, and receive arrived items.</div>
<div class="field"><label class="field-label">CSV File from NAV</label><input type="file" id="navFileInput" accept=".csv,.txt" style="display:none"><button class="btn" id="navFileBtn" style="width:100%;justify-content:center">ðŸ“ Choose CSV File...</button><div id="navFileName" style="font-size:11px;color:var(--text3);margin-top:4px"></div></div>
<div id="navPreview" style="display:none;margin-top:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:13px">Preview</span><span id="navMatchCount" style="font-size:11px;color:var(--text3)"></span></div>
<div id="navPreviewList" style="max-height:280px;overflow-y:auto;background:var(--bg);border-radius:8px;border:1px solid var(--border)"></div>
<div style="margin-top:12px;display:flex;gap:8px;align-items:center"><label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="navAutoReceive" checked> Auto-receive items marked as received in NAV</label></div>
</div>
</div><div class="modal-foot"><button class="btn" id="navImportCancel">Cancel</button><button class="btn btn-primary" id="navImportApply" disabled>Import</button></div></div></div>
<div class="popover" id="statusPopover" style="min-width:140px"><div style="font-size:11px;color:var(--text3);margin-bottom:8px">Change Status</div><div id="statusPopoverOptions"></div></div>
<div class="popover pending-popover" id="pendingPopover">
  <div class="pending-popover-header">Ready to order this part?</div>
  <div class="pending-popover-note">
    <textarea id="pendingNoteInput" placeholder="Add note about why part is pending..." rows="3"></textarea>
  </div>
  <div class="pending-popover-actions">
    <button class="btn" id="pendingNo">Not Yet</button>
    <button class="btn btn-primary" id="pendingYes">Yes, Ready â†’</button>
  </div>
</div>
<div class="popover part-info-popover" id="partInfoPopover">
  <div class="part-info-header">
    <span class="part-info-name" id="partInfoName"></span>
    <button class="modal-close" onclick="$('partInfoPopover').classList.remove('open')">Ã—</button>
  </div>
  <div class="part-info-body" id="partInfoBody"></div>
  <div class="part-info-footer">
    <button class="btn btn-sm" onclick="window.goToPartFromPopover()">View in List â†’</button>
  </div>
</div>
<div class="popover po-details-popover" id="poDetailsPopover">
<div class="po-details-header"><span class="po-details-number" id="poDetailsNumber"></span><span class="po-details-supplier" id="poDetailsSupplier"></span></div>
<div class="po-details-dates"><span id="poDetailsOrdered"></span><span id="poDetailsExpected"></span></div>
<div class="po-details-table">
<div class="po-details-thead"><span>Item</span><span>Ordered</span><span>Received</span></div>
<div class="po-details-tbody" id="poDetailsList"></div>
</div>
<div class="po-details-summary" id="poDetailsSummary"></div>
<div class="po-details-actions"><button class="btn" id="poDetailsClose" style="flex:1">Close</button><button class="btn btn-receive" id="poDetailsReceiveAll">Receive All</button></div>
</div>

<!-- New Project Modal -->
<div class="modal-bg" id="newProjectModal"><div class="modal" style="max-width:420px"><div class="modal-head"><span class="modal-title">New Project</span><button class="modal-close" id="newProjectClose">Ã—</button></div><div class="modal-body">
<div class="field"><label class="field-label">Project Name</label><input type="text" class="field-input" id="newProjectName" placeholder="e.g. MRS-450 Unit #8"></div>
<div class="field"><label class="field-label">Template</label><select class="field-input" id="newProjectTemplate"><option value="">Empty Project</option></select></div>
<div style="font-size:11px;color:var(--text3);margin-top:8px">The new project will use the shared team, lead time data, and item configurations.</div>
</div><div class="modal-foot"><button class="btn" id="newProjectCancel">Cancel</button><button class="btn btn-primary" id="newProjectCreate">Create Project</button></div></div></div>

<!-- Manage Projects Modal -->
<div class="modal-bg" id="manageProjectsModal"><div class="modal" style="max-width:520px"><div class="modal-head"><span class="modal-title">Manage Projects</span><button class="modal-close" id="manageProjectsClose">Ã—</button></div><div class="modal-body" style="padding:0">
<div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--bg2)">
<label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="showArchivedProjects"> Show archived</label>
</div>
<div id="manageProjectsList" style="max-height:400px;overflow-y:auto"></div>
</div><div class="modal-foot"><button class="btn" id="manageProjectsDone">Done</button></div></div></div>

<!-- Rename Project Modal -->
<div class="modal-bg" id="renameProjectModal"><div class="modal" style="max-width:380px"><div class="modal-head"><span class="modal-title">Rename Project</span><button class="modal-close" id="renameProjectClose">Ã—</button></div><div class="modal-body">
<div class="field"><label class="field-label">Project Name</label><input type="text" class="field-input" id="renameProjectName"></div>
</div><div class="modal-foot"><button class="btn" id="renameProjectCancel">Cancel</button><button class="btn btn-primary" id="renameProjectSave">Save</button></div></div></div>

<!-- Delete Project Modal -->
<div class="modal-bg" id="deleteProjectModal"><div class="modal" style="max-width:400px"><div class="modal-head"><span class="modal-title" style="color:var(--red)">Delete Project</span><button class="modal-close" id="deleteProjectClose">Ã—</button></div><div class="modal-body">
<div style="font-size:13px;color:var(--text);margin-bottom:16px">This will permanently delete the project and all its data. This cannot be undone.</div>
<div style="font-size:12px;color:var(--text2);margin-bottom:8px">Type the project name to confirm:</div>
<div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:8px;padding:8px;background:var(--bg2);border-radius:6px" id="deleteProjectDisplayName"></div>
<div class="field"><input type="text" class="field-input" id="deleteProjectConfirmName" placeholder="Type project name here"></div>
</div><div class="modal-foot"><button class="btn" id="deleteProjectCancel">Cancel</button><button class="btn" id="deleteProjectConfirm" style="background:var(--red);color:#fff" disabled>Delete Project</button></div></div></div>

<!-- Save as Template Modal -->
<div class="modal-bg" id="saveTemplateModal"><div class="modal" style="max-width:420px"><div class="modal-head"><span class="modal-title">ðŸ’¾ Save as Template</span><button class="modal-close" id="saveTemplateClose">Ã—</button></div><div class="modal-body">
<div style="font-size:12px;color:var(--text2);margin-bottom:16px">Save the current project structure (assemblies and parts) as a reusable template. Status, dates, and PO data will not be included.</div>
<div class="field"><label class="field-label">Template Name</label><input type="text" class="field-input" id="saveTemplateName" placeholder="e.g. MRS-450 Standard Config"></div>
<div class="field"><label class="field-label">Description (optional)</label><input type="text" class="field-input" id="saveTemplateDesc" placeholder="Brief description..."></div>
<div style="font-size:11px;color:var(--text3);margin-top:8px" id="saveTemplateStats"></div>
</div><div class="modal-foot"><button class="btn" id="saveTemplateCancel">Cancel</button><button class="btn btn-primary" id="saveTemplateSave">Save Template</button></div></div></div>

<!-- Manage Templates Modal -->
<div class="modal-bg" id="manageTemplatesModal"><div class="modal" style="max-width:520px"><div class="modal-head"><span class="modal-title">ðŸ“‹ Manage Templates</span><button class="modal-close" id="manageTemplatesClose">Ã—</button></div><div class="modal-body" style="padding:0">
<div id="templatesList" style="max-height:400px;overflow-y:auto"></div>
</div><div class="modal-foot"><button class="btn" id="manageTemplatesDone">Done</button></div></div></div>

<div class="toast-box" id="toastBox"></div>

<!-- Master Schedule Overlay -->
<div class="master-schedule-overlay" id="masterScheduleOverlay">
<div class="master-schedule-header">
<span class="master-schedule-title">Master Schedule</span>
<label style="font-size:12px;display:flex;align-items:center;gap:6px;color:var(--text2);cursor:pointer"><input type="checkbox" id="masterShowArchived"> Show archived</label>
<button class="master-schedule-close" id="masterScheduleClose">Ã—</button>
</div>
<div class="master-schedule-body">
<div id="masterTimelineHeader" class="master-timeline-header"></div>
<div id="masterScheduleContent"></div>
<div class="master-legend">
<div class="master-legend-item"><div class="master-legend-color" style="background:var(--accent)"></div> Active project</div>
<div class="master-legend-item"><div class="master-legend-color" style="background:var(--text3);opacity:0.6"></div> Archived</div>
<div class="master-legend-item"><div class="master-legend-color" style="background:var(--red);width:2px"></div> Today</div>
</div>
</div>
</div>

<!-- Chat -->
<div class="comments-popover" id="commentsPopover">
<div class="comments-header"><span id="commentsTitle">Comments</span><button id="commentsClose">Ã—</button></div>
<div class="comments-list" id="commentsList"></div>
<div class="comments-input"><input type="text" id="commentInput" placeholder="Add a note..." maxlength="200"><button id="commentAdd">Send</button></div>
</div>

<!-- Label Print Modal -->
<div class="modal-popover label-modal" id="labelModal">
<div class="modal-head"><span class="modal-title">ðŸ·ï¸ Print Label</span><button class="modal-close" id="labelClose">Ã—</button></div>
<div class="modal-body">
<div class="label-options">
<div class="label-option-row">
<label>Label Size</label>
<select id="labelSize">
<option value="29x90">90 Ã— 29mm (DK-1201 Landscape)</option>
<option value="102x51">102 Ã— 51mm (DK-1240)</option>
<option value="62x100">62 Ã— 100mm (DK-1202)</option>
<option value="62x29">62 Ã— 29mm (DK-1209)</option>
</select>
</div>
<div class="label-option-row">
<label>Options</label>
<div style="display:flex;flex-direction:column;gap:8px;flex:1">
<label style="display:flex;align-items:center;gap:8px;cursor:pointer;width:100%"><input type="checkbox" id="labelAssembly" checked><span class="checkbox-label">Show Assembly Name</span></label>
<label style="display:flex;align-items:center;gap:8px;cursor:pointer;width:100%"><input type="checkbox" id="labelMfr"><span class="checkbox-label">Show Manufacturer</span></label>
</div>
</div>
</div>
<div class="label-preview-container">
<div class="label-preview" id="labelPreview">
<div class="label-preview-info" id="labelPreviewInfo">
<div class="label-preview-name" id="labelPreviewName">Part Name</div>
<div class="label-preview-code" id="labelPreviewCode">CODE-123</div>
<div class="label-preview-meta" id="labelPreviewMeta">Assembly Name</div>
<div class="label-preview-project" id="labelPreviewProject" style="font-size:9px;color:#666;margin-top:4px;">Project: Project Name</div>
</div>
</div>
</div>
<div class="label-count-info" id="labelCountInfo"></div>
</div>
<div class="modal-foot">
<button class="btn" id="labelCancel">Cancel</button>
<button class="print-btn" id="labelPrint" onclick="window.printLabels()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>Print</button>
</div>
</div>

<!-- Hidden print area -->
<div id="labelPrintArea" style="display:none"></div>

<script>
(function(){

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyCuzREUYQica1pjdVgQJlXD2eh8D7Dqlo4",
  authDomain: "ebsv1-78d54.firebaseapp.com",
  databaseURL: "https://ebsv1-78d54-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ebsv1-78d54",
  storageBucket: "ebsv1-78d54.firebasestorage.app",
  messagingSenderId: "70538130924",
  appId: "1:70538130924:web:9e34e90b56e4f3f72ebcc9"
};

// Access code for the team (now serves as project code for path scoping)
const DEFAULT_PROJECT_CODE = "jaakko123";

// ============================================
// Initialize Firebase
// ============================================
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// ============================================
// Multi-Project Support
// ============================================
const globalRef = db.ref('global');
let projectIndex = {};  // {projectId: {name, archived, createdAt, updatedAt}}
let currentProjectId = null;

// Generate short alphanumeric ID for new projects
function generateProjectId() {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let id = 'p_';
  for (let i = 0; i < 6; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return id;
}

// Dynamic project reference - set after project code is entered
let projectRef = null;
let currentProjectCode = null;

// Set up project reference based on code
function setProjectCode(code) {
  currentProjectCode = code;
  currentProjectId = code;  // For now, code = id (will be migrated)
  projectRef = db.ref('projects/' + code);
  console.log('ðŸ“ Project path: projects/' + code);
}
window.setProjectCode = setProjectCode;
window.getCurrentProjectCode = () => currentProjectCode;

// Initialize with default (will be overwritten by login)
setProjectCode(DEFAULT_PROJECT_CODE);

// ============================================
// App State
// ============================================
const STAGES=['waiting','to-order','ordered','arrived','tested','configured','installed'];
const SLABELS={'waiting':'Waiting','to-order':'To Order','ordered':'Ordered','arrived':'Arrived','tested':'Tested','configured':'Configured','installed':'Installed'};
const ASTAGES=['not-started','in-progress','completed'];
const ALABELS={'not-started':'Not Started','in-progress':'In Progress','completed':'Completed'};

let data=[],team=[],expanded={},history=[],projectDates={start:'',end:''},actions=[],leadTimeDb={},savedBoms=[],currentProjectName='New Project',allExpanded=false,milestones=[];

// Item Code Configuration - saved to Firebase globally (shared across all projects)
// Structure: { 'ITEM-CODE': { requiresTesting: bool, tester: string, requiresConfig: bool, configuredBy: string } }
let itemCodeConfig={};
const ITEM_CONFIG_KEY='ebs-item-code-config';
// Note: itemConfigRef is now under /global/itemCodeConfig (migrated from root /itemCodeConfig)

function loadItemCodeConfig(){
  // Load from localStorage first as fallback
  try{
    const stored=localStorage.getItem(ITEM_CONFIG_KEY);
    if(stored)itemCodeConfig=JSON.parse(stored);
  }catch(e){console.warn('Failed to load item code config from localStorage',e)}
  
  // Then sync from Firebase (now under /global/itemCodeConfig)
  globalRef.child('itemCodeConfig').on('value',snapshot=>{
    const val=snapshot.val();
    if(val){
      itemCodeConfig=val;
      // Also save to localStorage as backup
      try{localStorage.setItem(ITEM_CONFIG_KEY,JSON.stringify(itemCodeConfig))}catch(e){}
      render(); // Re-render when config changes from another client
    }
  });
}

function saveItemCodeConfig(){
  // Save to Firebase (now under /global/itemCodeConfig)
  globalRef.child('itemCodeConfig').set(itemCodeConfig).catch(e=>console.warn('Failed to save item config to Firebase',e));
  // Also save to localStorage as backup
  try{
    localStorage.setItem(ITEM_CONFIG_KEY,JSON.stringify(itemCodeConfig));
  }catch(e){console.warn('Failed to save item code config to localStorage',e)}
}

function getItemConfig(code){
  if(!code||!itemCodeConfig[code])return{requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  return itemCodeConfig[code];
}

// ============================================
// Global Data Migration (Phase 1)
// ============================================
// Migrates team, leadTime, globalCodes, globalMfrs from project-specific to global storage
// This ensures all projects share the same team and reference data

let globalDataLoaded = false;
let migrationInProgress = false;

async function checkAndRunMigration() {
  if (migrationInProgress) return;
  migrationInProgress = true;
  
  try {
    // Check if global data already exists
    const globalSnap = await globalRef.child('migrated').once('value');
    
    if (globalSnap.val()) {
      console.log('âœ“ Global data migration already complete');
      migrationInProgress = false;
      return;
    }
    
    console.log('ðŸ”„ Running global data migration...');
    
    // Read current project's shared data
    const [teamSnap, leadTimeSnap, codesSnap, mfrsSnap, itemConfigSnap] = await Promise.all([
      projectRef.child('meta/team').once('value'),
      projectRef.child('leadTime').once('value'),
      projectRef.child('globalCodes').once('value'),
      projectRef.child('globalMfrs').once('value'),
      db.ref('itemCodeConfig').once('value')  // Old root-level path
    ]);
    
    // Prepare migration data
    const updates = {};
    
    if (teamSnap.val()) {
      updates['team'] = teamSnap.val();
      console.log('  â†’ Migrating team:', Array.isArray(teamSnap.val()) ? teamSnap.val().length : Object.keys(teamSnap.val()).length, 'members');
    }
    
    if (leadTimeSnap.val()) {
      updates['leadTime'] = leadTimeSnap.val();
      console.log('  â†’ Migrating lead time data');
    }
    
    if (codesSnap.val()) {
      updates['globalCodes'] = codesSnap.val();
      console.log('  â†’ Migrating global codes');
    }
    
    if (mfrsSnap.val()) {
      updates['globalMfrs'] = mfrsSnap.val();
      console.log('  â†’ Migrating global manufacturers');
    }
    
    if (itemConfigSnap.val()) {
      updates['itemCodeConfig'] = itemConfigSnap.val();
      console.log('  â†’ Migrating item code config');
    }
    
    // Also register current project in the index
    updates['projectIndex/' + currentProjectCode] = {
      name: currentProjectName || 'Untitled Project',
      archived: false,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    updates['migrated'] = true;
    updates['migratedAt'] = firebase.database.ServerValue.TIMESTAMP;
    
    // Write all at once
    await globalRef.update(updates);
    
    console.log('âœ“ Global data migration complete');
    
  } catch (err) {
    console.error('Migration error:', err);
  }
  
  migrationInProgress = false;
}

// Load global shared data (team, leadTime, globalCodes, globalMfrs)
let templatesIndex = {};  // {templateId: {name, description, createdAt, asmCount, partCount}}

function setupGlobalListeners() {
  // Team - shared across all projects
  globalRef.child('team').on('value', snap => {
    const val = snap.val();
    if (val) {
      team = Array.isArray(val) ? val : Object.values(val);
      if (globalDataLoaded) {
        updateSelects();
        render();
      }
    }
  });
  
  // Lead time database - shared across all projects
  globalRef.child('leadTime').on('value', snap => {
    leadTimeDb = snap.val() || {};
  });
  
  // Global codes - shared across all projects
  globalRef.child('globalCodes').on('value', snap => {
    const val = snap.val();
    globalCodes = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  });
  
  // Global manufacturers - shared across all projects
  globalRef.child('globalMfrs').on('value', snap => {
    const val = snap.val();
    globalMfrs = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  });
  
  // Project index - list of all projects
  globalRef.child('projectIndex').on('value', snap => {
    projectIndex = snap.val() || {};
    updateProjectDropdown();
  });
  
  // Templates index
  db.ref('templates').on('value', snap => {
    const val = snap.val() || {};
    templatesIndex = {};
    Object.entries(val).forEach(([id, tmpl]) => {
      if (tmpl.meta) {
        templatesIndex[id] = tmpl.meta;
      }
    });
    updateTemplateDropdowns();
  });
  
  globalDataLoaded = true;
}

// Update template dropdowns (New Project modal)
function updateTemplateDropdowns() {
  const select = $('newProjectTemplate');
  if (!select) return;
  
  const templates = Object.entries(templatesIndex)
    .map(([id, meta]) => ({ id, ...meta }))
    .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  
  select.innerHTML = '<option value="">Empty Project</option>' +
    templates.map(t => '<option value="' + esc(t.id) + '">' + esc(t.name) + ' (' + (t.asmCount || 0) + ' assemblies, ' + (t.partCount || 0) + ' parts)</option>').join('');
}

// Save global team data
function saveTeam() {
  globalRef.child('team').set(team).catch(e => console.warn('Failed to save team:', e));
}

// Save global lead time data  
function saveLeadTime() {
  globalRef.child('leadTime').set(leadTimeDb).catch(e => console.warn('Failed to save lead time:', e));
}

// Save global codes
function saveGlobalCodes() {
  globalRef.child('globalCodes').set(globalCodes).catch(e => console.warn('Failed to save global codes:', e));
}

// Save global manufacturers
function saveGlobalMfrs() {
  globalRef.child('globalMfrs').set(globalMfrs).catch(e => console.warn('Failed to save global mfrs:', e));
}

// Update project index entry
function updateProjectIndex() {
  if (!currentProjectCode) return;
  globalRef.child('projectIndex/' + currentProjectCode).update({
    name: currentProjectName,
    startDate: projectDates.start || null,
    endDate: projectDates.end || null,
    updatedAt: firebase.database.ServerValue.TIMESTAMP
  }).catch(e => console.warn('Failed to update project index:', e));
}

// ============================================
// Project Dropdown & Switching (Phase 2)
// ============================================

// Update the project dropdown UI
function updateProjectDropdown() {
  const list = $('projectDropdownList');
  if (!list) return;
  
  // Sort projects: active first (by name), then archived
  const projects = Object.entries(projectIndex)
    .map(([id, proj]) => ({ id, ...proj }))
    .sort((a, b) => {
      if (a.archived !== b.archived) return a.archived ? 1 : -1;
      return (a.name || '').localeCompare(b.name || '');
    });
  
  if (projects.length === 0) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:12px">No projects yet</div>';
    return;
  }
  
  list.innerHTML = projects.map(proj => {
    const isActive = proj.id === currentProjectCode;
    const archivedBadge = proj.archived ? '<span class="project-dropdown-item-archived">Archived</span>' : '';
    const checkMark = isActive ? 'âœ“' : '';
    return '<div class="project-dropdown-item'+(isActive?' active':'')+'" data-project-id="'+esc(proj.id)+'">' +
      '<span class="project-dropdown-item-check">'+checkMark+'</span>' +
      '<span class="project-dropdown-item-name">'+esc(proj.name || 'Untitled')+'</span>' +
      archivedBadge +
    '</div>';
  }).join('');
}

// Switch to a different project
async function switchProject(projectId) {
  if (projectId === currentProjectCode) {
    closeProjectDropdown();
    return;
  }
  
  const proj = projectIndex[projectId];
  if (!proj) {
    toast('Project not found', 1);
    return;
  }
  
  console.log('ðŸ“ Switching to project:', projectId, proj.name);
  
  // Show loading state
  showSync('syncing', 'Switching...');
  
  // Detach current project listeners
  detachProjectListeners();
  
  // Clear current project data
  data = [];
  history = [];
  actions = [];
  milestones = [];
  projectDates = { start: '', end: '' };
  savedBoms = [];
  expanded = {};
  
  // Clear localStorage for old project
  localStorage.removeItem('ebs-v3-project-' + currentProjectCode);
  
  // Set new project
  setProjectCode(projectId);
  currentProjectName = proj.name || 'Untitled Project';
  
  // Update URL
  const url = new URL(window.location);
  url.searchParams.set('project', projectId);
  window.history.pushState({}, '', url);
  
  // Load new project data
  await loadProjectData();
  
  // Close dropdown
  closeProjectDropdown();
  
  // Render
  updateProjectName();
  render();
  showSync('synced', 'Loaded');
  setTimeout(() => $('syncIndicator').classList.remove('active'), 1500);
}

// Detach all project-specific listeners
function detachProjectListeners() {
  if (!projectRef) return;
  
  try {
    projectRef.child('parts').off();
    projectRef.child('assemblies').off();
    projectRef.child('actions').off();
    projectRef.child('meta').off();
    projectRef.child('history').off();
    projectRef.child('boms').off();
  } catch (e) {
    console.warn('Error detaching listeners:', e);
  }
}

// Load project data (used after switch)
async function loadProjectData() {
  return new Promise((resolve) => {
    // Try localStorage first
    const localKey = 'ebs-v3-project-' + currentProjectCode;
    try {
      const saved = localStorage.getItem(localKey);
      if (saved) {
        const val = JSON.parse(saved);
        if (val.data && val.data.length > 0) {
          data = val.data;
          milestones = val.milestones || [];
          history = val.history || [];
          actions = val.actions || [];
          projectDates = val.projectDates || { start: '', end: '' };
          console.log('ðŸ“¦ Loaded from localStorage:', data.length, 'items');
        }
      }
    } catch (e) {
      console.warn('localStorage read error:', e);
    }
    
    // Set up realtime listeners for the new project
    setupRealtimeListener();
    
    // Wait a bit for Firebase to load
    setTimeout(resolve, 500);
  });
}

// Open/close dropdown
function openProjectDropdown() {
  $('projectDropdown').classList.add('open');
  updateProjectDropdown();
}

function closeProjectDropdown() {
  $('projectDropdown').classList.remove('open');
}

function toggleProjectDropdown() {
  const dropdown = $('projectDropdown');
  if (dropdown.classList.contains('open')) {
    closeProjectDropdown();
  } else {
    openProjectDropdown();
  }
}

// Handle URL parameters for project selection
function handleProjectUrlParam() {
  const params = new URLSearchParams(window.location.search);
  const projectId = params.get('project');
  
  if (projectId && projectId !== currentProjectCode) {
    // Will switch after global data loads
    return projectId;
  }
  return null;
}

// Save current project to its localStorage key
function saveProjectToLocalStorage() {
  if (!currentProjectCode) return;
  
  const localKey = 'ebs-v3-project-' + currentProjectCode;
  try {
    localStorage.setItem(localKey, JSON.stringify({
      data, milestones, history, actions, projectDates, projectName: currentProjectName
    }));
  } catch (e) {
    console.warn('localStorage save error:', e);
  }
}

function getPartStages(part){
  return ['waiting','to-order','ordered','arrived','tested','configured','installed'];
}

function getNextStage(part){
  const stages=getPartStages(part);
  const currentIdx=stages.indexOf(part.status);
  if(currentIdx===-1||currentIdx>=stages.length-1)return null;
  return stages[currentIdx+1];
}
let globalCodes=[],globalMfrs=[];
let editId=null,editAsmId=null,editActId=null,editEtaPartId=null,filterStage='',filterAssignee='',filterPO='',searchQ='',actionSearchQ='',actionAssigneeFilter='',highlightActionId=null,highlightPartId=null,bomMode='save';
let selectedParts=new Set(),lastSelectedPartId=null;
let isAuthenticated=false,isConnected=false,isSyncing=false;

const $=id=>document.getElementById(id);
window.$=$;
const esc=s=>s?String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'):'';
window.esc=esc;
const toast=(msg,e)=>{const t=document.createElement('div');t.className='toast '+(e?'err':'success');t.textContent=msg;$('toastBox').appendChild(t);setTimeout(()=>t.remove(),2500)};
window.toast=toast;

// ============================================
// Sync Indicator
// ============================================
function showSync(status,text){
  const ind=$('syncIndicator');
  const txt=$('syncText');
  ind.className='sync-indicator active '+status;
  txt.textContent=text||status;
  if(status==='synced')setTimeout(()=>ind.classList.remove('active'),2000);
}

let lastSyncTime=null;
function updateVersionInfo(){
  lastSyncTime=new Date();
  const timeStr=lastSyncTime.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  if($('infoLastSync'))$('infoLastSync').textContent=timeStr;
  if($('infoProjectId'))$('infoProjectId').textContent=currentProjectName?currentProjectName.substring(0,20):'â€”';
  if($('serverStatus'))$('serverStatus').textContent=isConnected?'Connected':'Offline';
}

// Version badge click handler
$('versionBadge').onclick=function(e){
  e.stopPropagation();
  const info=this.querySelector('.version-info');
  const rect=this.getBoundingClientRect();
  info.style.left=rect.left+'px';
  info.style.bottom=(window.innerHeight-rect.top+8)+'px';
  info.classList.toggle('open');
};
document.addEventListener('click',function(e){
  const info=document.querySelector('.version-info');
  if(info&&info.classList.contains('open')&&!e.target.closest('.version-badge')){
    info.classList.remove('open');
  }
});

// ============================================
// Firebase Data Operations - Granular Per-Entity Writes
// ============================================
let saveTimeout=null;
let isSaving=false;
let lastSyncShow=0;
let lastLocalSaveTime=0;
let lastSaveId='';
const clientId='client-'+Math.random().toString(36).substr(2,9)+'-'+Date.now();
const lastLocalWriteAt = new Map();  // Track local write times for echo suppression (by entity ID)
let serverTimeOffset = 0;  // Offset between client and server time (updated from .info/serverTimeOffset)

// Get server-aligned timestamp for cross-client merge decisions
function getServerAlignedTime() {
  return Date.now() + serverTimeOffset;
}
const SYNC_SHOW_INTERVAL=10000; // Only show sync indicator every 10 seconds max

// Dirty tracking - tracks which entities need to be written
const dirtyParts = new Set();      // part IDs that changed
const dirtyAsms = new Set();       // assembly IDs that changed  
const dirtyDeletes = new Set();    // IDs that were deleted (format: "part:id" or "asm:id")
let dirtyMeta = false;             // team, projectDates, projectName changed
let dirtyActions = new Set();      // action IDs that changed
let dirtyActionDeletes = new Set(); // action IDs that were deleted

// Legacy tracking (kept for field-level merge on incoming changes)
const pendingPartChanges = new Map(); // partId -> {fields that changed}
const pendingAsmChanges = new Map();  // asmId -> {fields that changed}
let pendingMetaChanges = false;

// Generate collision-proof IDs using Firebase push keys
function generateId() {
  return db.ref().push().key;
}

// Track field-level timestamps (using server-aligned time for cross-client merge)
function updateFieldTimestamp(item, field) {
  if (!item._fieldTs) item._fieldTs = {};
  item._fieldTs[field] = getServerAlignedTime();
}

// Mark a part as dirty (needs to be saved)
function markPartChanged(partId, changedFields) {
  dirtyParts.add(String(partId));
  // Also update legacy tracking for field-level merge
  if (!pendingPartChanges.has(partId)) {
    pendingPartChanges.set(partId, new Set());
  }
  changedFields.forEach(f => pendingPartChanges.get(partId).add(f));
}

// Mark an assembly as dirty
function markAsmChanged(asmId, changedFields) {
  dirtyAsms.add(String(asmId));
  if (!pendingAsmChanges.has(asmId)) {
    pendingAsmChanges.set(asmId, new Set());
  }
  changedFields.forEach(f => pendingAsmChanges.get(asmId).add(f));
}

// Mark an action as dirty
function markActionChanged(actionId) {
  dirtyActions.add(String(actionId));
}

// Mark entity for deletion
function markDeleted(type, id) {
  dirtyDeletes.add(type + ':' + String(id));
}

// Mark action for deletion
function markActionDeleted(actionId) {
  dirtyActionDeletes.add(String(actionId));
}

// Merge remote part with local part, keeping newer field values
function mergePartFields(localPart, remotePart) {
  if (!remotePart) return localPart;
  if (!localPart) return remotePart;
  
  // TOMBSTONE WINS: if remote is deleted, mark local as deleted too
  if (remotePart._deletedAt) {
    return { ...localPart, _deletedAt: remotePart._deletedAt, _deletedBy: remotePart._deletedBy };
  }
  
  // If local was deleted but remote isn't, the item was restored or never deleted remotely
  // In this case, we trust the remote (non-deleted) version
  if (localPart._deletedAt && !remotePart._deletedAt) {
    return remotePart;
  }
  
  const merged = { ...remotePart };
  const localTs = localPart._fieldTs || {};
  const remoteTs = remotePart._fieldTs || {};
  
  // For each field, keep the one with the newer timestamp
  const fields = ['name', 'code', 'mfr', 'assignee', 'qty', 'status', 'notes', 
                  'poNumber', 'orderedAt', 'expectedArrival', 'arrivedAt', 'parentId'];
  
  fields.forEach(field => {
    const localTime = localTs[field] || 0;
    const remoteTime = remoteTs[field] || 0;
    
    if (localTime > remoteTime && localPart[field] !== undefined) {
      merged[field] = localPart[field];
      if (!merged._fieldTs) merged._fieldTs = {};
      merged._fieldTs[field] = localTime;
    }
  });
  
  // Merge comments - keep all unique comments by timestamp
  if (localPart.comments || remotePart.comments) {
    const localComments = localPart.comments || [];
    const remoteComments = remotePart.comments || [];
    const commentMap = new Map();
    
    [...remoteComments, ...localComments].forEach(c => {
      const key = c.ts + '-' + c.author;
      if (!commentMap.has(key) || commentMap.get(key).ts < c.ts) {
        commentMap.set(key, c);
      }
    });
    
    merged.comments = Array.from(commentMap.values()).sort((a, b) => a.ts - b.ts);
  }
  
  return merged;
}

// Merge remote action with local action, keeping newer field values
function mergeActionFields(localAction, remoteAction) {
  if (!remoteAction) return localAction;
  if (!localAction) return remoteAction;
  
  // TOMBSTONE WINS: if remote is deleted, mark local as deleted too
  if (remoteAction._deletedAt) {
    return { ...localAction, _deletedAt: remoteAction._deletedAt, _deletedBy: remoteAction._deletedBy };
  }
  
  // If local was deleted but remote isn't, trust the remote
  if (localAction._deletedAt && !remoteAction._deletedAt) {
    return remoteAction;
  }
  
  const merged = { ...remoteAction };
  const localTs = localAction._fieldTs || {};
  const remoteTs = remoteAction._fieldTs || {};
  
  // For each field, keep the one with the newer timestamp
  const fields = ['task', 'assignee', 'status', 'due', 'linkedPartId', 'progress'];
  
  fields.forEach(field => {
    const localTime = localTs[field] || 0;
    const remoteTime = remoteTs[field] || 0;
    
    if (localTime > remoteTime && localAction[field] !== undefined) {
      merged[field] = localAction[field];
      if (!merged._fieldTs) merged._fieldTs = {};
      merged._fieldTs[field] = localTime;
    }
  });
  
  return merged;
}

// Sync pending changes after reconnection (uses granular writes)
async function syncPendingChanges() {
  if (useLocalStorage || !isConnected || !isAuthenticated) return;
  
  const hasPending = dirtyParts.size > 0 || dirtyAsms.size > 0 || 
                     dirtyDeletes.size > 0 || dirtyMeta ||
                     dirtyActions.size > 0 || dirtyActionDeletes.size > 0;
  if (!hasPending) return;
  
  console.log('ðŸ”„ Syncing pending changes:', dirtyParts.size, 'parts,', dirtyAsms.size, 'assemblies');
  showSync('syncing', 'Syncing offline changes...');
  
  // Just trigger the regular save - it now does granular writes
  clearTimeout(saveTimeout);
  isSaving = false;
  save();
}

function save(){
  if(!isAuthenticated) return;
  
  // Always save to localStorage first (immediate, reliable)
  saveToLocalStorage();
  
  // For localStorage-only mode, we're done
  if(useLocalStorage) return;
  
  // If offline, just track that we have pending changes
  if(!isConnected) {
    console.log('ðŸ“´ Offline - changes queued for sync');
    if($('offlineOverlay').classList.contains('active')){
      const count = dirtyParts.size + dirtyAsms.size + dirtyDeletes.size;
      const el = $('offlinePending');
      if(el){
        el.textContent = count + ' pending change' + (count > 1 ? 's' : '');
        el.style.display = 'block';
      }
    }
    return;
  }
  
  clearTimeout(saveTimeout);
  
  saveTimeout=setTimeout(()=>{
    if(isSaving) return;
    
    // Check if there's anything to save
    const hasChanges = dirtyParts.size > 0 || dirtyAsms.size > 0 || 
                       dirtyDeletes.size > 0 || dirtyMeta || 
                       dirtyActions.size > 0 || dirtyActionDeletes.size > 0;
    if(!hasChanges) return;
    
    isSaving=true;
    lastLocalSaveTime = Date.now();
    lastSaveId = clientId + '-' + Date.now();
    
    const now=Date.now();
    const showIndicator=now-lastSyncShow>SYNC_SHOW_INTERVAL;
    if(showIndicator) showSync('syncing','Syncing...');
    
    // Build multi-path update object for atomic write
    const updates = {};
    
    // Write dirty parts
    dirtyParts.forEach(partId => {
      const part = data.find(d => String(d.id) === partId && !d.isAsm);
      if(part) {
        const partData = {...part};
        partData._updatedAt = firebase.database.ServerValue.TIMESTAMP;
        partData._updatedBy = clientId;
        // Track local write time for echo suppression (namespaced by entity type)
        lastLocalWriteAt.set('part:' + partId, Date.now());
        updates['parts/' + partId] = partData;
      }
    });
    
    // Write dirty assemblies
    dirtyAsms.forEach(asmId => {
      const asm = data.find(d => String(d.id) === asmId && d.isAsm);
      if(asm) {
        const asmData = {...asm};
        asmData._updatedAt = firebase.database.ServerValue.TIMESTAMP;
        asmData._updatedBy = clientId;
        lastLocalWriteAt.set('asm:' + asmId, Date.now());
        updates['assemblies/' + asmId] = asmData;
      }
    });
    
    // Write dirty actions
    dirtyActions.forEach(actionId => {
      const action = actions.find(a => String(a.id) === actionId);
      if(action) {
        const actionData = {...action};
        actionData._updatedAt = firebase.database.ServerValue.TIMESTAMP;
        actionData._updatedBy = clientId;
        lastLocalWriteAt.set('action:' + actionId, Date.now());
        updates['actions/' + actionId] = actionData;
      }
    });
    
    // Process deletes (write tombstone instead of null for delete-wins semantics)
    dirtyDeletes.forEach(key => {
      const [type, id] = key.split(':');
      const tombstone = {
        _deletedAt: firebase.database.ServerValue.TIMESTAMP,
        _deletedBy: clientId
      };
      if(type === 'part') {
        updates['parts/' + id] = tombstone;
        lastLocalWriteAt.set('part:' + id, Date.now());
      } else if(type === 'asm') {
        updates['assemblies/' + id] = tombstone;
        lastLocalWriteAt.set('asm:' + id, Date.now());
      }
    });
    
    // Process action deletes (also use tombstones)
    dirtyActionDeletes.forEach(actionId => {
      updates['actions/' + actionId] = {
        _deletedAt: firebase.database.ServerValue.TIMESTAMP,
        _deletedBy: clientId
      };
      lastLocalWriteAt.set('action:' + actionId, Date.now());
    });
    
    // Write meta if changed
    if(dirtyMeta) {
      updates['meta/projectName'] = currentProjectName;
      updates['meta/projectDates'] = projectDates;
      // Note: team is now saved globally via saveTeam()
      updates['meta/milestones'] = milestones;
      updates['meta/updatedAt'] = firebase.database.ServerValue.TIMESTAMP;
      // Also update project index with new name
      updateProjectIndex();
    }
    
    // Also update lastSaveId for echo detection
    updates['meta/lastSaveId'] = lastSaveId;
    
    // Record today's progress to Firebase (before the update call)
    const today = new Date().toISOString().split('T')[0];
    const pct = calcOverallProgress();
    const hIdx = history.findIndex(h => h.date === today);
    if(hIdx >= 0) {
      history[hIdx].pct = pct;
    } else {
      history.push({ date: today, pct });
    }
    if(history.length > 100) history = history.slice(-100);
    // Write just today's progress to Firebase
    updates['history/' + today] = {
      date: today,
      pct,
      _updatedBy: clientId,
      _updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    console.log('ðŸ’¾ Saving:', dirtyParts.size, 'parts,', dirtyAsms.size, 'asms,', dirtyDeletes.size, 'deletes');
    
    // Atomic multi-path update
    projectRef.update(updates).then(()=>{
      isSaving=false;
      
      // Clear dirty tracking
      dirtyParts.clear();
      dirtyAsms.clear();
      dirtyDeletes.clear();
      dirtyActions.clear();
      dirtyActionDeletes.clear();
      dirtyMeta = false;
      
      // Clear legacy tracking too
      pendingPartChanges.clear();
      pendingAsmChanges.clear();
      pendingMetaChanges = false;
      
      // Progress is now recorded before the update, not after
      
      if(showIndicator){
        lastSyncShow=Date.now();
        showSync('synced','Synced âœ“');
        setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
      }
    }).catch(e=>{
      isSaving=false;
      showSync('offline','Save failed');
      console.error('Save failed:', e);
    });
  },500);
}

function saveBoms(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('boms').set(savedBoms).catch(console.error);
}

function saveExpanded(){
  // Keep expanded state local (per-user preference)
  try{localStorage.setItem('ebs-expanded',JSON.stringify(expanded))}catch(e){}
}

function loadExpanded(){
  try{const s=localStorage.getItem('ebs-expanded');if(s)expanded=JSON.parse(s)}catch(e){expanded={}}
}

function addGlobalCode(code){if(code&&!globalCodes.includes(code)){globalCodes.push(code);saveGlobalCodes()}}
function addGlobalMfr(mfr){if(mfr&&!globalMfrs.includes(mfr)){globalMfrs.push(mfr);saveGlobalMfrs()}}
function getAllCodes(){const projectCodes=[...new Set(data.filter(d=>d.code).map(d=>d.code))];return[...new Set([...globalCodes,...projectCodes])].sort()}
function getAllMfrs(){const projectMfrs=[...new Set(data.filter(d=>d.mfr).map(d=>d.mfr))];return[...new Set([...globalMfrs,...projectMfrs])].sort()}

function loadSampleBoms(){savedBoms=[{id:1,name:'Standard Control Panel',items:[{name:'Control Panel',isAsm:true},{name:'PLC CPU',code:'6ES7-1500',mfr:'Siemens',qty:1,parent:'Control Panel'}]}];saveBoms()}

function updateProjectName(){$('projectName').textContent=(currentProjectName||'EBS Cloud')+' â˜ï¸'}

// ============================================
// Authentication (now uses Firebase anonymous auth + project code)
// ============================================
let firebaseUser = null;

async function initAuth() {
  // Sign in anonymously - silent, no user input needed
  try {
    const userCredential = await auth.signInAnonymously();
    firebaseUser = userCredential.user;
    console.log('ðŸ” Anonymous auth successful, uid:', firebaseUser.uid);
    return true;
  } catch (error) {
    console.error('Auth error:', error);
    return false;
  }
}

function checkAuth(){
  const stored = sessionStorage.getItem('ebs-project-code');
  return !!stored && !!firebaseUser;
}

async function login(code){
  // Validate project code format (alphanumeric, 4-20 chars)
  if(!code || !/^[a-zA-Z0-9_-]{4,20}$/.test(code)) {
    toast('Invalid project code format', 1);
    return false;
  }
  
  // Ensure we have Firebase auth
  if(!firebaseUser) {
    const authSuccess = await initAuth();
    if(!authSuccess) {
      toast('Authentication failed', 1);
      return false;
    }
  }
  
  // Set the project path
  setProjectCode(code);
  sessionStorage.setItem('ebs-project-code', code);
  isAuthenticated = true;
  $('loginScreen').style.display = 'none';
  initFirebaseListeners();
  return true;
}

function logout(){
  sessionStorage.removeItem('ebs-project-code');
  isAuthenticated = false;
  currentProjectCode = null;
  projectRef = null;
  location.reload();
}

// ============================================
// Firebase Real-time Listeners
// ============================================
const LOCAL_STORAGE_KEY = 'ebs-v3-data';
let useLocalStorage = false;
let dataInitialized = false;

function initFirebaseListeners(){
  showSync('syncing','Loading...');
  
  // Check for project ID in URL parameter first
  const params = new URLSearchParams(window.location.search);
  const urlProjectId = params.get('project');
  
  if (urlProjectId && urlProjectId !== currentProjectCode) {
    // Switch to project specified in URL
    console.log('ðŸ“ Project from URL:', urlProjectId);
    setProjectCode(urlProjectId);
  } else {
    // Check for last opened project
    const lastProject = localStorage.getItem('ebs-v3-last-project');
    if (lastProject && lastProject !== currentProjectCode) {
      console.log('ðŸ“ Resuming last project:', lastProject);
      setProjectCode(lastProject);
    }
  }
  
  // Set up global listeners first (team, leadTime, globalCodes, globalMfrs, projectIndex)
  setupGlobalListeners();
  
  // ALWAYS check localStorage first
  const localData = loadFromLocalStorage();
  
  if(localData){
    // We have local data - use it immediately
    console.log('Loaded from localStorage');
    dataInitialized = true;
    showSync('synced','Loaded');
    setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
    
    // Try to connect to Firebase for sync
    tryFirebaseSync();
    
    // Run migration if needed (async, won't block UI)
    checkAndRunMigration();
  } else {
    // No local data - try Firebase, then create sample if needed
    tryFirebaseFirst();
  }
}

let checkedLegacyPath = false;

function tryFirebaseFirst(){
  const timeout = setTimeout(()=>{
    console.log('Firebase timeout, creating local sample');
    useLocalStorage = true;
    createAndSaveSampleData();
  }, 3000);
  
  // Try to load from new granular structure first
  Promise.all([
    projectRef.child('parts').once('value'),
    projectRef.child('assemblies').once('value'),
    projectRef.child('meta').once('value'),
    projectRef.child('actions').once('value'),
    projectRef.child('history').once('value'),
    projectRef.child('main').once('value')  // Check for legacy data
  ]).then(async ([partsSnap, asmsSnap, metaSnap, actionsSnap, historySnap, mainSnap]) => {
    clearTimeout(timeout);
    
    const partsVal = partsSnap.val();
    const asmsVal = asmsSnap.val();
    const metaVal = metaSnap.val();
    const mainVal = mainSnap.val();
    
    // Check if new project path has any data
    const hasNewPathData = partsVal || asmsVal || metaVal || mainVal;
    
    // If demo project and no data at new path, try legacy /project path (once)
    if(!hasNewPathData && currentProjectCode === DEFAULT_PROJECT_CODE && !checkedLegacyPath) {
      checkedLegacyPath = true;
      console.log('No data at new path, checking legacy /project path...');
      const legacyRef = db.ref('project');
      legacyRef.child('parts').once('value').then(legacySnap => {
        if(legacySnap.val()) {
          console.log('ðŸ“¦ Found data at legacy path, using it');
          // Switch to legacy path for this session
          projectRef = legacyRef;
          // Retry with legacy path
          tryFirebaseFirst();
        } else {
          // No legacy data either, create sample
          console.log('No legacy data, creating sample');
          createAndSaveSampleData();
        }
      }).catch(() => {
        createAndSaveSampleData();
      });
      return;
    }
    
    // Check schema version (0 = legacy, 1 = migration incomplete, 2 = granular)
    const schemaVersion = metaVal?.schemaVersion || 0;
    const hasGranularData = schemaVersion >= 2 || partsVal || asmsVal;
    const hasMigrationIncomplete = schemaVersion === 1;
    const hasLegacyData = mainVal && mainVal.data && 
      (Array.isArray(mainVal.data) ? mainVal.data.length > 0 : Object.keys(mainVal.data).length > 0);
    
    if(schemaVersion >= 2 || (hasGranularData && !hasMigrationIncomplete)) {
      // Load from granular structure
      console.log('Loading from granular structure');
      data = [];
      
      // Load assemblies
      if(asmsVal) {
        Object.entries(asmsVal).forEach(([id, asm]) => {
          data.push({...asm, id, isAsm: true});
        });
      }
      
      // Load parts
      if(partsVal) {
        Object.entries(partsVal).forEach(([id, part]) => {
          data.push({...part, id});
        });
      }
      
      // Load meta
      if(metaVal) {
        currentProjectName = metaVal.projectName || 'EBS Project';
        projectDates = metaVal.projectDates || {start:'', end:''};
        // Note: team is now loaded globally via setupGlobalListeners()
        // Only use project team as fallback if global team is empty (migration period)
        if(team.length === 0 && metaVal.team) {
          team = Array.isArray(metaVal.team) ? metaVal.team : Object.values(metaVal.team);
        }
        milestones = metaVal.milestones ? (Array.isArray(metaVal.milestones) ? metaVal.milestones : Object.values(metaVal.milestones)) : [];
      }
      
      // Load actions
      const actionsVal = actionsSnap.val();
      if(actionsVal) {
        actions = Object.entries(actionsVal).map(([id, action]) => ({...action, id}));
      }
      
      // Load history
      const historyVal = historySnap.val();
      if(historyVal) {
        history = Array.isArray(historyVal) ? historyVal : Object.values(historyVal);
      }
      
      // If data is still empty after loading, create sample data
      if(data.length === 0){
        console.log('No assemblies/parts found, creating sample data');
        createSampleData();
        await saveAllToGranular();
      }
      
      // Seed history if empty but we have data (await to ensure save completes before listener starts)
      await seedHistoryIfNeeded();
      
      updateProjectName();
      saveToLocalStorage();
      dataInitialized = true;
      showSync('synced','Connected');
      setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
      setupRealtimeListener();
      render();
      
      // Run global data migration if needed
      checkAndRunMigration();
      
    } else if(hasMigrationIncomplete && hasLegacyData) {
      // Migration was interrupted - retry from legacy data
      console.log('âš ï¸ Incomplete migration detected (schemaVersion=1), retrying...');
      loadFromSnapshot(mainVal);
      saveToLocalStorage();
      dataInitialized = true;
      
      seedHistoryIfNeeded().then(() => {
        migrateToGranular().then(() => {
          showSync('synced','Migration completed âœ“');
          setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
          setupRealtimeListener();
          checkAndRunMigration();
        });
      });
      
    } else if(hasLegacyData) {
      // Migrate from legacy blob structure
      console.log('Migrating from legacy blob structure...');
      loadFromSnapshot(mainVal);
      saveToLocalStorage();
      dataInitialized = true;
      
      // Migrate to granular structure
      seedHistoryIfNeeded().then(() => {
        migrateToGranular().then(() => {
          showSync('synced','Migrated âœ“');
          setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
          setupRealtimeListener();
          checkAndRunMigration();
        });
      });
      
    } else {
      // No data - create sample
      console.log('Firebase empty, creating sample');
      createAndSaveSampleData();
      
      // Save to granular structure
      saveAllToGranular().then(() => {
        setupRealtimeListener();
        checkAndRunMigration();
      });
    }
  }).catch(err=>{
    clearTimeout(timeout);
    console.log('Firebase error, using localStorage:', err);
    useLocalStorage = true;
    createAndSaveSampleData();
  });
}

// Migrate legacy blob data to granular structure (two-phase for safety)
async function migrateToGranular() {
  console.log('ðŸ”„ Migrating to granular structure...');
  
  // Phase 1: Mark migration in progress
  try {
    await projectRef.child('meta/schemaVersion').set(1);
  } catch(e) {
    console.error('Failed to mark migration start:', e);
    return;
  }
  
  // Phase 2: Write all granular data
  const updates = {};
  
  // Migrate parts and assemblies
  data.forEach(item => {
    const id = String(item.id);
    if(item.isAsm) {
      updates['assemblies/' + id] = item;
    } else {
      updates['parts/' + id] = item;
    }
  });
  
  // Migrate meta (except schemaVersion - we'll set that last)
  updates['meta/projectName'] = currentProjectName;
  updates['meta/projectDates'] = projectDates;
  // Note: team is now global, handled by checkAndRunMigration()
  updates['meta/milestones'] = milestones;
  updates['meta/updatedAt'] = firebase.database.ServerValue.TIMESTAMP;
  
  // Migrate actions
  actions.forEach(action => {
    const id = String(action.id);
    updates['actions/' + id] = action;
  });
  
  // Migrate history
  history.forEach((h, idx) => {
    updates['history/' + (h.date || idx)] = h;
  });
  
  try {
    await projectRef.update(updates);
    
    // Phase 3: Mark migration complete (only after all writes succeed)
    await projectRef.child('meta/schemaVersion').set(2);
    console.log('âœ… Migration complete!');
    
    // Optionally clear legacy data after successful migration
    // await projectRef.child('main').remove();
    
  } catch(e) {
    console.error('Migration failed (schemaVersion=1, will retry on next load):', e);
  }
}

// Save all current data to granular structure (for new projects)
async function saveAllToGranular() {
  const updates = {};
  
  data.forEach(item => {
    const id = String(item.id);
    if(item.isAsm) {
      updates['assemblies/' + id] = item;
    } else {
      updates['parts/' + id] = item;
    }
  });
  
  updates['meta/projectName'] = currentProjectName;
  updates['meta/projectDates'] = projectDates;
  // Note: team is now global, saved via saveTeam()
  updates['meta/milestones'] = milestones;
  updates['meta/schemaVersion'] = 2;  // Mark as granular structure
  updates['meta/updatedAt'] = firebase.database.ServerValue.TIMESTAMP;
  
  actions.forEach(action => {
    updates['actions/' + String(action.id)] = action;
  });
  
  // Save history too!
  history.forEach(h => {
    updates['history/' + h.date] = {
      date: h.date,
      pct: h.pct,
      action: h.action || null
    };
  });
  
  try {
    await projectRef.update(updates);
  } catch(e) {
    console.error('Save all failed:', e);
  }
}

function tryFirebaseSync(){
  projectRef.child('main').once('value').then(snapshot=>{
    const val = snapshot.val();
    if(val && val.data){
      // Firebase has data - check if newer
      console.log('Firebase connected, setting up sync');
    }
    setupRealtimeListener();
    
  }).catch(err=>{
    console.log('Firebase unavailable, local mode only');
    useLocalStorage = true;
  });
}

function loadFromLocalStorage(){
  try {
    // Try project-specific key first
    let saved = null;
    if (currentProjectCode) {
      const projectKey = 'ebs-v3-project-' + currentProjectCode;
      saved = localStorage.getItem(projectKey);
    }
    
    // Fall back to legacy key
    if (!saved) {
      saved = localStorage.getItem(LOCAL_STORAGE_KEY);
    }
    
    if(saved){
      const val = JSON.parse(saved);
      if(val.data && val.data.length > 0){
        data = val.data;
        team = val.team || team; // Keep existing team if not in saved data (team is global now)
        milestones = val.milestones || [];
        history = val.history || [];
        actions = val.actions || [];
        projectDates = val.projectDates || {start:'',end:''};
        currentProjectName = val.projectName || 'EBS Project';
        
        // Seed history if insufficient for chart - ALWAYS ensure we have 2+ points
        if(history.length < 2 && data.length > 0 && projectDates.start){
          const today = new Date().toISOString().split('T')[0];
          const parts = data.filter(d => !d.isAsm);
          const WEIGHTS = {'waiting':0,'to-order':20,'ordered':40,'arrived':70,'installed':100};
          const currentPct = parts.length ? Math.round(parts.reduce((acc, p) => acc + (WEIGHTS[p.status] || 0), 0) / parts.length) : 0;
          
          // Use project start date, or 7 days ago if project start is in the future
          const startDate = new Date(projectDates.start);
          const todayDate = new Date(today);
          
          if(startDate <= todayDate){
            // Project already started - create history from start to today
            history = [{date: projectDates.start, pct: 0}];
            // Add intermediate points if project is more than 7 days old
            const daysSinceStart = Math.floor((todayDate - startDate) / 86400000);
            if(daysSinceStart > 14){
              const midDate = new Date(startDate.getTime() + (todayDate - startDate) / 2);
              history.push({date: midDate.toISOString().split('T')[0], pct: Math.round(currentPct / 2)});
            }
            history.push({date: today, pct: currentPct});
          } else {
            // Project hasn't started yet - just use today
            const weekAgo = new Date(Date.now() - 7*86400000).toISOString().split('T')[0];
            history = [
              {date: weekAgo, pct: Math.max(0, currentPct - 10)},
              {date: today, pct: currentPct}
            ];
          }
          // Save the seeded history
          saveToLocalStorage();
        }
        
        updateProjectName();
        render();
        return true;
      }
    }
  } catch(e){
    console.error('localStorage read error:', e);
  }
  return false;
}

function saveToLocalStorage(){
  if (!currentProjectCode) return;
  
  try {
    // Save to project-specific key
    const projectKey = 'ebs-v3-project-' + currentProjectCode;
    localStorage.setItem(projectKey, JSON.stringify({
      data, milestones, history, actions, projectDates, projectName: currentProjectName
    }));
    
    // Also save to legacy key for backward compatibility
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
      data, team, milestones, history, actions, projectDates, projectName: currentProjectName
    }));
    
    // Remember last opened project
    localStorage.setItem('ebs-v3-last-project', currentProjectCode);
  } catch(e){
    console.error('localStorage save error:', e);
  }
}

function createAndSaveSampleData(){
  createSampleData();
  saveToLocalStorage();
  dataInitialized = true;
  showSync('synced','Ready');
  setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
  render();
}

function createSampleData(){
  const now=Date.now(),day=86400000;
  
  currentProjectName='Marine Radar System MRS-450 - Unit #7';
  
  // Finnish team matching document roles
  team=[
    {name:'Antti',email:'antti@radarfi.com'},      // Production Supervisor (primary user)
    {name:'Mikko',email:'mikko@radarfi.com'},      // Tester 1
    {name:'Sari',email:'sari@radarfi.com'},        // Tester 2
    {name:'Jukka',email:'jukka@radarfi.com'},      // Assembler 1
    {name:'Pekka',email:'pekka@radarfi.com'},      // Assembler 2
    {name:'Tuomas',email:'tuomas@radarfi.com'},    // Project Manager
    {name:'Matti',email:'matti@radarfi.com'}       // R&D Engineer
  ];
  
  // Project: Oct 2025 - March 2026 (typical 5-month radar project per document)
  projectDates={start:'2025-10-01',end:'2026-03-31'};
  
  // Sample milestones
  milestones=[
    {id:1,name:'Design Review',date:'2025-11-15',type:'review'},
    {id:2,name:'Customer Inspection',date:'2026-01-20',type:'review'},
    {id:3,name:'Factory Acceptance Test',date:'2026-02-28',type:'deadline'},
    {id:4,name:'Customer Delivery',date:'2026-03-15',type:'delivery'}
  ];
  
  // Sample history for burndown chart (simulated progress from project start)
  history=[
    {date:'2025-10-01',pct:0},
    {date:'2025-10-15',pct:5},
    {date:'2025-11-01',pct:12},
    {date:'2025-11-15',pct:18},
    {date:'2025-12-01',pct:28},
    {date:'2025-12-15',pct:35},
    {date:'2026-01-01',pct:42},
    {date:new Date().toISOString().split('T')[0],pct:48}
  ];
  
  // Calculate timestamps for sample data
  const projectStart=new Date('2025-10-01').getTime();
  const simToday=now; // Use actual current time
  
  // PO number generator
  let poCounter=2026001;
  const getPO=()=>'PO-'+(poCounter++);
  
  // Notes reflecting radar manufacturing context from document
  const partNotes={
    'RF Transmitter Module':'CRITICAL - Safety-critical component per document rules. Full testing required, no shortcuts.',
    'Waveguide Assembly':'Custom fabrication by Precision Metals Oy. 50% deposit paid per policy. Weekly progress calls.',
    'X-Band Antenna':'UK sister company shipment - budget 7-10 days for customs per document guidelines.',
    'Signal Processor Board':'R&D completed design validation. Firmware V2.4 required.',
    'Power Amplifier 500W':'High-value item (â‚¬8,200). Dual approval obtained (Tuomas + Finance) per â‚¬5k rule.',
    'Rotary Joint':'Long lead item - 6 week lead time. Specialized RF component per document.',
    'Magnetron':'SAFETY CRITICAL - Requires calibration certificate. Reject if missing per document rules.',
    'Slip Ring Assembly':'Custom spec from R&D. 18-channel configuration.',
    'Radome':'Fiberglass construction. Weather seal inspection required.',
    'Motor Drive Unit':'Yaskawa specialist needed for commissioning. Training scheduled Feb 25.'
  };
  
  // Realistic multi-person conversations with Finnish team
  const partComments={
    'RF Transmitter Module':[
      {text:'Initial testing started. Running thermal validation.',ts:simToday-8*day,author:'Mikko'},
      {text:'Thermal test passed at 45Â°C ambient. Starting RF calibration tomorrow.',ts:simToday-6*day,author:'Mikko'},
      {text:'Calibration certificate received from manufacturer. All parameters within spec.',ts:simToday-4*day,author:'Sari'},
      {text:'Ready for integration. Moving to configured status.',ts:simToday-2*day,author:'Antti'}
    ],
    'Waveguide Assembly':[
      {text:'Precision Metals confirmed start of fabrication. 50% deposit sent.',ts:simToday-20*day,author:'Tuomas'},
      {text:'Progress photos received - machining 60% complete.',ts:simToday-12*day,author:'Antti'},
      {text:'Surface finish issue found. Rework in progress, +3 days to schedule.',ts:simToday-8*day,author:'Tuomas'},
      {text:'Rework complete. Final inspection tomorrow, ship Friday.',ts:simToday-3*day,author:'Antti'}
    ],
    'X-Band Antenna':[
      {text:'Shipped from UK today. DHL tracking: 1234567890',ts:simToday-14*day,author:'Tuomas'},
      {text:'Stuck in customs. Missing commercial invoice. Contacted UK team.',ts:simToday-10*day,author:'Antti'},
      {text:'Customs cleared! Delivery tomorrow morning.',ts:simToday-5*day,author:'Antti'},
      {text:'Received. Minor cosmetic damage to protective cover - acceptable.',ts:simToday-4*day,author:'Jukka'}
    ],
    'Signal Processor Board':[
      {text:'Matti confirmed firmware V2.4 ready for flash.',ts:simToday-15*day,author:'Tuomas'},
      {text:'Board arrived. Visual inspection OK, starting power-on test.',ts:simToday-10*day,author:'Mikko'},
      {text:'All self-tests passed. Firmware loaded successfully.',ts:simToday-8*day,author:'Mikko'}
    ],
    'Power Amplifier 500W':[
      {text:'Quote received: â‚¬8,200. Need dual approval per >â‚¬5k policy.',ts:simToday-25*day,author:'Antti'},
      {text:'Approved by Tuomas and Finance. Order placed.',ts:simToday-23*day,author:'Tuomas'},
      {text:'Shipped via express. ETA Thursday.',ts:simToday-6*day,author:'Antti'}
    ],
    'Magnetron':[
      {text:'IMPORTANT: Cal cert MUST accompany this part. Do not accept without it.',ts:simToday-30*day,author:'Matti'},
      {text:'Delivery attempted but driver had no cal cert. Refused shipment per policy.',ts:simToday-12*day,author:'Antti'},
      {text:'Supplier reshipping with proper documentation. New ETA +5 days.',ts:simToday-10*day,author:'Tuomas'}
    ],
    'Rotary Joint':[
      {text:'6-week lead time confirmed. This is critical path.',ts:simToday-35*day,author:'Tuomas'},
      {text:'Week 3 update: Joint housing complete, electrical work starting.',ts:simToday-14*day,author:'Antti'},
      {text:'On track for delivery next week. Sari will run continuity tests.',ts:simToday-3*day,author:'Tuomas'}
    ],
    'Motor Drive Unit':[
      {text:'Standard unit wont work - need custom parameters for radar rotation.',ts:simToday-20*day,author:'Matti'},
      {text:'Yaskawa confirmed factory programming available. +â‚¬400.',ts:simToday-18*day,author:'Antti'},
      {text:'Approved. They need our parameter file by Friday.',ts:simToday-16*day,author:'Tuomas'}
    ],
    'Radar Cabinet':[
      {text:'Konepaja Virtanen starting fabrication Monday.',ts:simToday-25*day,author:'Antti'},
      {text:'Cabinet 80% complete. Paint booth available Thursday.',ts:simToday-10*day,author:'Jukka'},
      {text:'Delivered! Mounting frame fits perfectly.',ts:simToday-6*day,author:'Pekka'}
    ],
    'Safety PLC':[
      {text:'Waiting for safety assessment approval from UK customer.',ts:simToday-8*day,author:'Tuomas'},
      {text:'Customer safety engineer reviewing next week.',ts:simToday-5*day,author:'Matti'}
    ]
  };
  
  // Radar system assemblies matching document structure
  const partTemplates=[
    {asm:'RF Transmitter Unit',priority:1,parts:[
      {name:'RF Transmitter Module',code:'RF-TX-450',mfr:'UK Sister Co',status:'arrived',daysInStatus:2},
      {name:'Power Amplifier 500W',code:'PA-500W',mfr:'Ampleon',status:'arrived',daysInStatus:3},
      {name:'Frequency Synthesizer',code:'FS-X01',mfr:'Analog Devices',status:'arrived',daysInStatus:4},
      {name:'RF Isolator',code:'ISO-9GHZ',mfr:'DiTom',status:'installed',daysInStatus:12},
      {name:'Directional Coupler',code:'DC-20DB',mfr:'Krytar',status:'installed',daysInStatus:10},
      {name:'Waveguide Assembly',code:'WG-CUST',mfr:'Precision Metals Oy',status:'ordered',daysInStatus:5},
      {name:'RF Cables Set',code:'RFC-SET',mfr:'Times Microwave',status:'installed',daysInStatus:15},
      {name:'EMI Shielding',code:'EMI-TX',mfr:'Laird',status:'installed',daysInStatus:18}
    ]},
    {asm:'Antenna Assembly',priority:2,parts:[
      {name:'X-Band Antenna',code:'ANT-X9G',mfr:'UK Sister Co',status:'arrived',daysInStatus:4},
      {name:'Radome',code:'RDM-450',mfr:'Saint-Gobain',status:'arrived',daysInStatus:5},
      {name:'Antenna Mount',code:'MNT-HVY',mfr:'Konecranes',status:'installed',daysInStatus:20},
      {name:'Rotary Joint',code:'RJ-18CH',mfr:'Cobham',status:'ordered',daysInStatus:8},
      {name:'Slip Ring Assembly',code:'SR-18',mfr:'Moog',status:'arrived',daysInStatus:6},
      {name:'Bearing Assembly',code:'BRG-SL',mfr:'SKF',status:'installed',daysInStatus:15},
      {name:'Weather Seal Kit',code:'WS-KIT',mfr:'Parker',status:'installed',daysInStatus:12},
      {name:'Encoder',code:'ENC-ABS',mfr:'Heidenhain',status:'arrived',daysInStatus:4}
    ]},
    {asm:'Signal Processing Unit',priority:3,parts:[
      {name:'Signal Processor Board',code:'SPB-450',mfr:'In-House',status:'tested',daysInStatus:6},
      {name:'FPGA Module',code:'FPGA-K7',mfr:'Xilinx',status:'configured',daysInStatus:5},
      {name:'ADC Board',code:'ADC-14B',mfr:'Analog Devices',status:'tested',daysInStatus:5},
      {name:'DSP Module',code:'DSP-C66',mfr:'Texas Instruments',status:'installed',daysInStatus:10},
      {name:'Memory Module 32GB',code:'MEM-32G',mfr:'Kingston',status:'installed',daysInStatus:12},
      {name:'Backplane',code:'BP-6SL',mfr:'Elma',status:'installed',daysInStatus:18},
      {name:'Cooling Fan Assembly',code:'FAN-SP',mfr:'Sanyo Denki',status:'configured',daysInStatus:15},
      {name:'Debug Interface',code:'DBG-USB',mfr:'FTDI',status:'arrived',daysInStatus:3}
    ]},
    {asm:'Power System',priority:4,parts:[
      {name:'Main Power Supply',code:'PSU-48V',mfr:'TDK-Lambda',status:'arrived',daysInStatus:4},
      {name:'DC-DC Converters Set',code:'DCDC-SET',mfr:'Vicor',status:'installed',daysInStatus:10},
      {name:'UPS Module',code:'UPS-1KVA',mfr:'APC',status:'arrived',daysInStatus:5},
      {name:'Battery Pack',code:'BAT-48V',mfr:'Panasonic',status:'arrived',daysInStatus:3},
      {name:'Power Distribution Board',code:'PDB-01',mfr:'In-House',status:'arrived',daysInStatus:8},
      {name:'Surge Protection',code:'SPD-48',mfr:'Phoenix Contact',status:'installed',daysInStatus:12},
      {name:'Power Cables',code:'PWR-CBL',mfr:'Lapp',status:'installed',daysInStatus:15},
      {name:'Main Breaker',code:'MCB-63A',mfr:'ABB',status:'installed',daysInStatus:18}
    ]},
    {asm:'Motor Drive System',priority:5,parts:[
      {name:'Motor Drive Unit',code:'VFD-3KW',mfr:'Yaskawa',status:'arrived',daysInStatus:5},
      {name:'Servo Motor',code:'SGM-3KW',mfr:'Yaskawa',status:'arrived',daysInStatus:4},
      {name:'Gearbox',code:'GB-50:1',mfr:'Neugart',status:'installed',daysInStatus:12},
      {name:'Motor Cable',code:'MC-10M',mfr:'Lapp',status:'installed',daysInStatus:14},
      {name:'Encoder Cable',code:'EC-10M',mfr:'Lapp',status:'installed',daysInStatus:14},
      {name:'Brake Resistor',code:'BR-1KW',mfr:'Danfoss',status:'installed',daysInStatus:10},
      {name:'Motor Mount',code:'MM-CUST',mfr:'Konepaja Virtanen',status:'arrived',daysInStatus:6},
      {name:'Limit Switches',code:'LS-SET',mfr:'Omron',status:'installed',daysInStatus:15}
    ]},
    {asm:'Control Unit',priority:6,parts:[
      {name:'Industrial PC',code:'IPC-I7',mfr:'Advantech',status:'arrived',daysInStatus:10},
      {name:'Display 19"',code:'DSP-19',mfr:'Advantech',status:'arrived',daysInStatus:4},
      {name:'Keyboard Panel',code:'KBD-IP65',mfr:'InduKey',status:'installed',daysInStatus:12},
      {name:'Trackball Mouse',code:'TBM-IP65',mfr:'NSI',status:'installed',daysInStatus:12},
      {name:'Ethernet Switch',code:'ETH-8P',mfr:'Cisco',status:'installed',daysInStatus:15},
      {name:'GPS Receiver',code:'GPS-01',mfr:'u-blox',status:'arrived',daysInStatus:3},
      {name:'Compass Module',code:'CMP-01',mfr:'Honeywell',status:'arrived',daysInStatus:3},
      {name:'Control Panel Enclosure',code:'ENC-CTL',mfr:'Rittal',status:'installed',daysInStatus:20}
    ]},
    {asm:'Main Enclosure',priority:7,parts:[
      {name:'Radar Cabinet',code:'CAB-MAIN',mfr:'Konepaja Virtanen',status:'arrived',daysInStatus:6},
      {name:'Mounting Frame',code:'MF-INT',mfr:'Konepaja Virtanen',status:'installed',daysInStatus:15},
      {name:'Cable Entry Plates',code:'CEP-SET',mfr:'Roxtec',status:'installed',daysInStatus:18},
      {name:'Cooling System',code:'AC-2KW',mfr:'Rittal',status:'arrived',daysInStatus:5},
      {name:'Door Switches',code:'DS-SET',mfr:'Schmersal',status:'installed',daysInStatus:12},
      {name:'Internal Lighting',code:'LED-INT',mfr:'Phoenix Contact',status:'installed',daysInStatus:20},
      {name:'DIN Rails Set',code:'DIN-SET',mfr:'Phoenix Contact',status:'installed',daysInStatus:22},
      {name:'Terminal Blocks',code:'TB-SET',mfr:'Wago',status:'installed',daysInStatus:20}
    ]},
    {asm:'Safety System',priority:8,parts:[
      {name:'Magnetron',code:'MAG-X9G',mfr:'CPI',status:'ordered',daysInStatus:10},
      {name:'RF Safety Interlock',code:'INT-RF',mfr:'Pilz',status:'arrived',daysInStatus:4},
      {name:'E-Stop Assembly',code:'ESTOP-3',mfr:'ABB',status:'installed',daysInStatus:15},
      {name:'Safety Relay',code:'PNOZ-S4',mfr:'Pilz',status:'arrived',daysInStatus:8},
      {name:'Warning Lights',code:'WL-SET',mfr:'Patlite',status:'installed',daysInStatus:12},
      {name:'Radiation Warning Signs',code:'SGN-RF',mfr:'Brady',status:'installed',daysInStatus:20},
      {name:'Interlock Key Switch',code:'KS-INT',mfr:'Schmersal',status:'installed',daysInStatus:14},
      {name:'Safety PLC',code:'S7-F',mfr:'Siemens',status:'waiting',daysInStatus:5,pendingNote:'Waiting for safety assessment approval from UK customer'}
    ]},
    {asm:'Interface Modules',priority:9,parts:[
      {name:'Serial Interface',code:'RS422-4',mfr:'Moxa',status:'arrived',daysInStatus:3},
      {name:'Fiber Optic Transceiver',code:'FO-SFP',mfr:'Finisar',status:'installed',daysInStatus:10},
      {name:'NMEA Interface',code:'NMEA-01',mfr:'Actisense',status:'arrived',daysInStatus:6},
      {name:'Radar Output Module',code:'ROM-01',mfr:'In-House',status:'arrived',daysInStatus:4},
      {name:'AIS Interface',code:'AIS-01',mfr:'Weatherdock',status:'waiting',daysInStatus:5},
      {name:'Video Output Card',code:'VID-HD',mfr:'Matrox',status:'arrived',daysInStatus:4},
      {name:'Network Module',code:'NET-GB',mfr:'Intel',status:'installed',daysInStatus:12},
      {name:'USB Hub',code:'USB-7P',mfr:'Startech',status:'installed',daysInStatus:15}
    ]},
    {asm:'Documentation & Spares',priority:10,parts:[
      {name:'Technical Manual',code:'DOC-TM',mfr:'In-House',status:'waiting',daysInStatus:8,pendingNote:'Technical writer completing final review'},
      {name:'Spare Parts Kit',code:'SPK-01',mfr:'Various',status:'waiting',daysInStatus:6},
      {name:'Calibration Tools',code:'CAL-KIT',mfr:'Anritsu',status:'ordered',daysInStatus:12},
      {name:'Test Equipment Cert',code:'TEST-CERT',mfr:'Various',status:'waiting',daysInStatus:4,pendingNote:'Awaiting final calibration certs from lab'},
      {name:'Software License',code:'SW-LIC',mfr:'In-House',status:'arrived',daysInStatus:10},
      {name:'Training Materials',code:'TRN-MAT',mfr:'In-House',status:'waiting',daysInStatus:8},
      {name:'Shipping Crate',code:'CRATE-01',mfr:'Suomen Pakkaus',status:'waiting',daysInStatus:10},
      {name:'Packing Materials',code:'PACK-SET',mfr:'Various',status:'waiting',daysInStatus:10}
    ]}
  ];

  data=[];let id=1;expanded={};
  
  // Assign parts to team based on role (per document: Antti=supervisor, Mikko/Sari=testers, Jukka/Pekka=assemblers)
  const assignPart=(ai,pi)=>{
    const roles=['Antti','Mikko','Sari','Jukka','Pekka'];
    return roles[(ai+pi)%roles.length];
  };
  
  partTemplates.forEach((template,ai)=>{
    const asmId=id++;
    data.push({id:asmId,name:template.asm,isAsm:true,assignee:'Tuomas',priority:template.priority});
    expanded[String(asmId)]=ai<4;
    
    template.parts.forEach((p,pi)=>{
      const partId=id++;
      const assignee=assignPart(ai,pi);
      const changedAt=simToday-p.daysInStatus*day;
      
      // Generate PO and dates for ordered+ parts (not waiting)
      let poNumber,orderedAt,arrivedAt,expectedArrival;
      
      if(p.status!=='waiting'){
        poNumber=getPO();
        const orderDaysAgo=p.daysInStatus+Math.floor(Math.random()*10)+5;
        orderedAt=simToday-orderDaysAgo*day;
        
        // Set expected arrival based on typical lead times
        // Lead times per document: stock 3-7, standard 10-14, custom 3-4 weeks, UK +7-10 customs
        let leadDays;
        if(p.mfr==='UK Sister Co') leadDays=Math.floor(Math.random()*4)+14; // 14-18 days with customs
        else if(p.mfr.includes('Oy')||p.mfr.includes('Virtanen')||p.mfr==='In-House') leadDays=Math.floor(Math.random()*7)+18; // 18-25 days custom
        else if(p.mfr==='CPI'||p.mfr==='Cobham') leadDays=Math.floor(Math.random()*14)+28; // 28-42 days specialized RF
        else leadDays=Math.floor(Math.random()*7)+7; // 7-14 days standard
        expectedArrival=new Date(orderedAt+leadDays*day).toISOString().split('T')[0];
        
        if(['arrived','installed'].includes(p.status)){
          const actualLeadDays=leadDays+(Math.random()>0.7?Math.floor(Math.random()*5):-Math.floor(Math.random()*3));
          arrivedAt=orderedAt+actualLeadDays*day;
          if(arrivedAt>simToday)arrivedAt=simToday-p.daysInStatus*day-day;
        }
      }
      
      data.push({
        id:partId,
        name:p.name,
        code:p.code,
        mfr:p.mfr,
        qty:Math.ceil(Math.random()*2),
        assignee,
        parentId:asmId,
        status:p.status,
        changedAt,
        poNumber,
        orderedAt,
        arrivedAt,
        expectedArrival,
        pendingNote:p.pendingNote,
        notes:partNotes[p.name]||'',
        comments:partComments[p.name]?partComments[p.name].map(c=>({...c,timestamp:c.ts})):undefined
      });
    });
  });

  // Progress history - radar project timeline (per document: 3-5 months typical)
  history=[
    {date:'2025-10-01',pct:0,action:'Project kickoff with UK customer'},
    {date:'2025-10-10',pct:5,action:'R&D completed BOM finalization'},
    {date:'2025-10-20',pct:10,action:'Long-lead items ordered (rotary joint, magnetron)'},
    {date:'2025-10-31',pct:16,action:'Custom fabrication started at Precision Metals Oy'},
    {date:'2025-11-10',pct:24,action:'First parts received from distributors'},
    {date:'2025-11-20',pct:32,action:'Main enclosure delivered from Konepaja Virtanen'},
    {date:'2025-11-30',pct:40,action:'RF transmitter unit testing begun'},
    {date:'2025-12-10',pct:50,action:'Antenna assembly integration started'},
    {date:'2025-12-20',pct:56,action:'Signal processor board configured'},
    {date:'2026-01-02',pct:62,action:'Production resumed after holidays'}
  ];

  // Action items reflecting radar manufacturing workflow per document
  actions=[
    {id:now+1,task:'Follow up with Precision Metals on waveguide delivery',linkedPartId:null,due:'2026-01-08',assignee:'Antti',status:'not-started',createdAt:'2025-12-28'},
    {id:now+2,task:'Schedule magnetron installation with RF safety protocol',linkedPartId:null,due:'2026-01-15',assignee:'Tuomas',status:'not-started',createdAt:'2025-12-20'},
    {id:now+3,task:'Complete safety assessment documentation for UK customer',linkedPartId:null,due:'2026-01-20',assignee:'Matti',status:'in-progress',createdAt:'2025-11-15'},
    {id:now+4,task:'Arrange Yaskawa commissioning visit for motor drive',linkedPartId:null,due:'2026-02-01',assignee:'Antti',status:'not-started',createdAt:'2025-12-15'},
    {id:now+5,task:'Test rotary joint when delivered (critical path)',linkedPartId:null,due:'2026-01-12',assignee:'Sari',status:'not-started',createdAt:'2025-12-30'},
    {id:now+6,task:'Verify all calibration certificates are on file',linkedPartId:null,due:'2026-01-10',assignee:'Mikko',status:'in-progress',createdAt:'2025-12-01'},
    {id:now+7,task:'Order AIS interface - customer confirmed requirement',linkedPartId:null,due:'2026-01-05',assignee:'Antti',status:'not-started',createdAt:'2025-12-28'},
    {id:now+8,task:'Complete technical manual draft for customer review',linkedPartId:null,due:'2026-02-15',assignee:'Matti',status:'in-progress',createdAt:'2025-11-01'},
    {id:now+9,task:'Coordinate UK shipment schedule with sister company',linkedPartId:null,due:'2026-03-01',assignee:'Tuomas',status:'not-started',createdAt:'2025-12-20'},
    {id:now+10,task:'RF transmitter full power test (safety critical)',linkedPartId:null,due:'2026-01-18',assignee:'Mikko',status:'not-started',createdAt:'2025-12-22'},
    {id:now+11,task:'Book customer acceptance test date',linkedPartId:null,due:'2026-03-15',assignee:'Tuomas',status:'not-started',createdAt:'2025-12-01'},
    {id:now+12,task:'Order shipping crate - allow 2 weeks for custom size',linkedPartId:null,due:'2026-02-20',assignee:'Antti',status:'not-started',createdAt:'2025-12-15'}
  ];

  // Lead time database - radar components matching document lead time expectations
  leadTimeDb={
    'RF-TX-450':{samples:[{days:16,date:'2025-12-01'},{days:18,date:'2025-10-15'}],avg:17},    // UK with customs
    'ANT-X9G':{samples:[{days:15,date:'2025-12-10'},{days:17,date:'2025-11-05'}],avg:16},      // UK with customs
    'SPB-450':{samples:[{days:8,date:'2025-12-15'},{days:7,date:'2025-11-20'}],avg:8},         // In-house
    'PSU-48V':{samples:[{days:6,date:'2025-12-08'},{days:5,date:'2025-11-25'},{days:7,date:'2025-10-30'}],avg:6}, // Stock
    'VFD-3KW':{samples:[{days:10,date:'2025-12-12'},{days:12,date:'2025-11-18'}],avg:11},      // Standard
    'CAB-MAIN':{samples:[{days:22,date:'2025-11-28'}],avg:22},                                  // Custom fab
    'WG-CUST':{samples:[{days:25,date:'2025-10-01'}],avg:25},                                   // Custom fab
    'RJ-18CH':{samples:[{days:42,date:'2025-09-15'}],avg:42},                                   // Specialized RF
    'MAG-X9G':{samples:[{days:35,date:'2025-10-20'}],avg:35},                                   // Specialized RF  
    'IPC-I7':{samples:[{days:5,date:'2025-12-18'},{days:4,date:'2025-12-01'}],avg:5}           // Stock
  };
  
  updateProjectName();
  render();
}

function loadFromSnapshot(val){
  if(!val) return;
  
  // Only update data if Firebase actually has data - don't clear existing data on empty response
  if(val.data){
    const newData = Array.isArray(val.data) ? val.data : Object.values(val.data);
    if(newData.length > 0 || data.length === 0) {
      data = newData;
    }
  }
  // Team is now global - only load from project as fallback during migration
  if(val.team && team.length === 0){
    const newTeam = Array.isArray(val.team) ? val.team : Object.values(val.team);
    if(newTeam.length > 0) {
      team = newTeam;
    }
  }
  if(val.milestones){
    const newMilestones = Array.isArray(val.milestones) ? val.milestones : Object.values(val.milestones);
    milestones = newMilestones;
  }
  if(val.history){
    const newHistory = Array.isArray(val.history) ? val.history : Object.values(val.history);
    if(newHistory.length > 0 || history.length === 0) {
      history = newHistory;
    }
  }
  if(val.actions){
    const newActions = Array.isArray(val.actions) ? val.actions : Object.values(val.actions);
    if(newActions.length > 0 || actions.length === 0) {
      actions = newActions;
    }
  }
  if(val.projectDates) projectDates = val.projectDates;
  if(val.projectName) currentProjectName = val.projectName;
  
  updateProjectName();
  updateVersionInfo();
  render();
}

// Seed history if empty but we have parts data (for velocity forecast to work)
// Returns a Promise that resolves when seeding is complete (or immediately if no seeding needed)
async function seedHistoryIfNeeded() {
  const parts = data.filter(d => !d.isAsm && !d._deletedAt);
  if(parts.length === 0) return; // No parts, nothing to seed
  
  // If we already have 2+ history entries, we're good
  if(history.length >= 2) return;
  
  console.log('ðŸ“Š Seeding history for velocity forecast... (current entries:', history.length, ')');
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  // Calculate current progress inline
  const WEIGHTS = {'waiting':0,'to-order':20,'ordered':40,'arrived':70,'installed':100};
  const currentPct = Math.round(parts.reduce((acc, p) => acc + (WEIGHTS[p.status] || 0), 0) / parts.length);
  
  // Determine what "first point" date to use
  // If project start exists and is today or in the past, use project start
  // Otherwise use yesterday (but this may be filtered out)
  let firstPointDate;
  let firstPointPct;
  
  if(projectDates.start) {
    const startDate = new Date(projectDates.start);
    const daysSinceStart = Math.floor((today - startDate) / 86400000);
    
    if(daysSinceStart === 0) {
      // Today IS project start - use project start with 0% and today with current%
      // But they're the same day! We need to fake a second date.
      // Use "project start" as 0% and a "synthetic" date slightly after
      firstPointDate = projectDates.start;
      firstPointPct = 0;
    } else if(daysSinceStart > 0) {
      // Project started in the past - use project start date
      firstPointDate = projectDates.start;
      firstPointPct = 0;
    } else {
      // Project hasn't started yet - use yesterday
      const yesterday = new Date(today.getTime() - 86400000);
      firstPointDate = yesterday.toISOString().split('T')[0];
      firstPointPct = Math.max(0, currentPct - 5);
    }
  } else {
    // No project dates - use yesterday
    const yesterday = new Date(today.getTime() - 86400000);
    firstPointDate = yesterday.toISOString().split('T')[0];
    firstPointPct = Math.max(0, currentPct - 5);
  }
  
  // Build history array
  if(history.length === 1) {
    // We have 1 point, add another
    if(history[0].date === todayStr) {
      // Existing point is today - add the first point before it
      if(firstPointDate !== todayStr) {
        history.unshift({ date: firstPointDate, pct: firstPointPct });
      } else {
        // Both would be today - change first point to be 0% at start of day
        history.unshift({ date: firstPointDate, pct: 0 });
      }
    } else {
      // Existing point is not today - add today
      history.push({ date: todayStr, pct: currentPct });
    }
  } else {
    // No history - create 2 points
    history = [];
    if(firstPointDate === todayStr) {
      // Project starts today - create 0% at start and current% now
      history.push({ date: firstPointDate, pct: 0 });
      // For velocity calc, we need different dates - just duplicate with different pct
      // This won't show 2 dots but velocity will work based on rate calculation
      history.push({ date: todayStr, pct: currentPct });
    } else {
      history.push({ date: firstPointDate, pct: firstPointPct });
      history.push({ date: todayStr, pct: currentPct });
    }
  }
  
  // Remove duplicates by date (keep latest pct for each date)
  const dateMap = new Map();
  history.forEach(h => dateMap.set(h.date, h));
  history = Array.from(dateMap.values()).sort((a,b) => a.date.localeCompare(b.date));
  
  console.log('ðŸ“Š Seeded history:', history);
  
  // Save ALL seeded history entries to Firebase and WAIT for completion
  if(projectRef) {
    const historyUpdates = {};
    history.forEach(h => {
      historyUpdates[h.date] = {
        date: h.date,
        pct: h.pct,
        _updatedBy: clientId,
        _updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
    });
    try {
      await projectRef.child('history').update(historyUpdates);
      console.log('ðŸ“Š Saved seeded history to Firebase');
    } catch(err) {
      console.warn('Failed to save seeded history:', err);
    }
  }
}

// Track local changes to avoid re-render on echo
let pendingRenderTimeout = null;

function setupRealtimeListener(){
  // Track initial load for UX only (not data ingestion)
  let initialLoadComplete = false;
  let saveRenderTimeout = null;
  
  // Debounced save and render to prevent jank during burst events
  function scheduleSaveAndRender() {
    if(saveRenderTimeout) return;
    saveRenderTimeout = setTimeout(() => {
      saveRenderTimeout = null;
      saveToLocalStorage();
      if(initialLoadComplete) render();
    }, 50);  // 50ms debounce for burst coalescing
  }
  
  // ========== PARTS LISTENERS ==========
  // child_added fires for ALL existing children on attach - we handle this via upsert (findIndex + replace)
  projectRef.child('parts').on('child_added', snap => {
    const part = snap.val();
    if(!part) return;
    
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && !d.isAsm);
    
    // Always upsert (idempotent) - even for own changes to ensure data consistency
    if(idx >= 0) {
      // Only merge if not our own recent change (use local write time, not server timestamp)
      if(!(part._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('part:' + id) || 0) < 3000)) {
        data[idx] = mergePartFields(data[idx], {...part, id});
      }
    } else {
      // Insert new
      data.push({...part, id});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('parts').on('child_changed', snap => {
    const part = snap.val();
    if(!part) return;
    
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && !d.isAsm);
    
    // Always upsert - only skip merge for own RECENT echoes (use local write time)
    if(idx >= 0) {
      if(!(part._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('part:' + id) || 0) < 3000)) {
        data[idx] = mergePartFields(data[idx], {...part, id});
      }
    } else {
      // Insert if somehow missing (ensures consistency)
      data.push({...part, id});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('parts').on('child_removed', snap => {
    // With tombstones, child_removed should rarely fire (only manual Firebase console deletes)
    // Handle it gracefully by marking as deleted locally
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && !d.isAsm);
    if(idx >= 0) {
      data[idx]._deletedAt = Date.now();
      scheduleSaveAndRender();
    }
  });
  
  // ========== ASSEMBLY LISTENERS ==========
  projectRef.child('assemblies').on('child_added', snap => {
    const asm = snap.val();
    if(!asm) return;
    
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && d.isAsm);
    
    // Always upsert (idempotent) - use local write time for echo suppression
    if(idx >= 0) {
      if(!(asm._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('asm:' + id) || 0) < 3000)) {
        data[idx] = mergePartFields(data[idx], {...asm, id, isAsm: true});
      }
    } else {
      data.push({...asm, id, isAsm: true});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('assemblies').on('child_changed', snap => {
    const asm = snap.val();
    if(!asm) return;
    
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && d.isAsm);
    
    // Always upsert - only skip merge for own RECENT echoes
    if(idx >= 0) {
      if(!(asm._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('asm:' + id) || 0) < 3000)) {
        data[idx] = mergePartFields(data[idx], {...asm, id, isAsm: true});
      }
    } else {
      data.push({...asm, id, isAsm: true});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('assemblies').on('child_removed', snap => {
    // With tombstones, child_removed should rarely fire (only manual Firebase console deletes)
    const id = snap.key;
    const idx = data.findIndex(d => String(d.id) === id && d.isAsm);
    if(idx >= 0) {
      data[idx]._deletedAt = Date.now();
      scheduleSaveAndRender();
    }
  });
  
  // ========== ACTIONS LISTENERS ==========
  projectRef.child('actions').on('child_added', snap => {
    const action = snap.val();
    if(!action) return;
    
    const id = snap.key;
    const idx = actions.findIndex(a => String(a.id) === id);
    
    // Always upsert (idempotent) - use merge and echo suppression
    if(idx >= 0) {
      if(!(action._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('action:' + id) || 0) < 3000)) {
        actions[idx] = mergeActionFields(actions[idx], {...action, id});
      }
    } else {
      actions.push({...action, id});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('actions').on('child_changed', snap => {
    const action = snap.val();
    if(!action) return;
    
    const id = snap.key;
    const idx = actions.findIndex(a => String(a.id) === id);
    
    // Always upsert with merge - only skip for own RECENT echoes
    if(idx >= 0) {
      if(!(action._updatedBy === clientId && Date.now() - (lastLocalWriteAt.get('action:' + id) || 0) < 3000)) {
        actions[idx] = mergeActionFields(actions[idx], {...action, id});
      }
    } else {
      actions.push({...action, id});
    }
    scheduleSaveAndRender();
  });
  
  projectRef.child('actions').on('child_removed', snap => {
    // With tombstones, child_removed should rarely fire (only manual Firebase console deletes)
    // But handle it just in case - mark as deleted locally
    const id = snap.key;
    const idx = actions.findIndex(a => String(a.id) === id);
    if(idx >= 0) {
      actions[idx]._deletedAt = Date.now();
      scheduleSaveAndRender();
    }
  });
  
  // ========== META LISTENER ==========
  projectRef.child('meta').on('value', snap => {
    const val = snap.val();
    if(!val) return;
    
    // Skip if this is our own change
    if(val.lastSaveId === lastSaveId) return;
    
    if(val.projectName) currentProjectName = val.projectName;
    if(val.projectDates) projectDates = val.projectDates;
    // Note: team is now global, loaded via setupGlobalListeners()
    if(val.milestones) milestones = Array.isArray(val.milestones) ? val.milestones : Object.values(val.milestones);
    
    updateProjectName();
    scheduleSaveAndRender();
  });
  
  // ========== HISTORY LISTENER ==========
  projectRef.child('history').on('value', snap => {
    const val = snap.val();
    if(!val) {
      history = [];
      scheduleSaveAndRender();
      return;
    }
    history = Array.isArray(val) ? val : Object.values(val);
    // Sort chronologically to prevent zigzag chart rendering
    history.sort((a, b) => String(a.date).localeCompare(String(b.date)));
    scheduleSaveAndRender();
  });
  
  // Mark initial load complete after Firebase has sent all existing data
  // This only affects UX (render throttling), not data correctness
  projectRef.child('parts').once('value', () => {
    projectRef.child('assemblies').once('value', () => {
      projectRef.child('actions').once('value', () => {
        initialLoadComplete = true;
        render();  // Single render after all data loaded
        console.log('âœ… Realtime listeners active, initial load complete');
      });
    });
  });
  
  // ========== AUXILIARY LISTENERS (project-specific) ==========
  projectRef.child('boms').on('value', snapshot=>{
    const val = snapshot.val();
    if(val) savedBoms = Array.isArray(val) ? val : Object.values(val);
  });
  
  // ========== CONNECTION STATUS ==========
  let wasOffline = false;
  let offlineTimer = null;
  
  function updateOfflinePendingCount() {
    const count = dirtyParts.size + dirtyAsms.size + dirtyDeletes.size + 
                  dirtyActions.size + dirtyActionDeletes.size;
    const el = $('offlinePending');
    if (el) {
      el.textContent = count > 0 ? count + ' pending change' + (count > 1 ? 's' : '') : 'No pending changes';
      el.style.display = count > 0 ? 'block' : 'none';
    }
  }
  
  db.ref('.info/connected').on('value', snapshot=>{
    isConnected = snapshot.val() === true;
    updateVersionInfo();
    if(!isConnected && !useLocalStorage && isAuthenticated){
      wasOffline = true;
      showSync('offline','Offline');
      clearTimeout(offlineTimer);
      offlineTimer = setTimeout(()=>{
        if(!isConnected && isAuthenticated){
          updateOfflinePendingCount();
          $('offlineOverlay').classList.add('active');
        }
      }, 2000);
    } else if(isConnected){
      clearTimeout(offlineTimer);
      if(wasOffline){
        wasOffline = false;
        $('offlineOverlay').classList.remove('active');
        showSync('synced','Back online');
        syncPendingChanges();
        setTimeout(()=>$('syncIndicator').classList.remove('active'),2000);
      }
    }
  });
  
  // Sync server time offset for accurate cross-client timestamps
  db.ref('.info/serverTimeOffset').on('value', snapshot => {
    serverTimeOffset = snapshot.val() || 0;
    console.log('â±ï¸ Server time offset:', serverTimeOffset, 'ms');
  });
}

// ============================================
// Login UI Handlers
// ============================================
// Set up login handlers immediately since DOM should be ready
(function setupLoginHandlers(){
  const quickBtn = document.getElementById('loginQuick');
  const codeBtn = document.getElementById('loginBtn');
  const codeInput = document.getElementById('loginCode');
  
  console.log('Login setup:', !!quickBtn, !!codeBtn, !!codeInput);
  
  if(quickBtn){
    quickBtn.onclick = async function(){
      console.log('Demo login clicked');
      this.disabled = true;
      this.innerHTML = '<span>Loading...</span>';
      const success = await login(DEFAULT_PROJECT_CODE);
      if(!success) {
        this.disabled = false;
        this.innerHTML = '<span>Try Demo Project</span>';
      }
    };
  }
  
  if(codeBtn){
    codeBtn.onclick = async function(){
      console.log('Code login clicked');
      const code = codeInput ? codeInput.value.trim() : '';
      if(!code) {
        const err = document.getElementById('loginError');
        if(err) err.textContent = 'Enter a project code';
        return;
      }
      this.disabled = true;
      this.textContent = 'Loading...';
      const success = await login(code);
      if(!success) {
        this.disabled = false;
        this.textContent = 'Continue with code';
        const err = document.getElementById('loginError');
        if(err) err.textContent = 'Failed to connect';
      }
    };
  }
  
  if(codeInput){
    codeInput.onkeydown = function(e){
      if(e.key === 'Enter' && codeBtn) codeBtn.click();
    };
  }
})();

// Check connection status on load
db.ref('.info/connected').once('value').then(()=>{
  $('loginStatus').textContent='Ready';
}).catch(()=>{
  $('loginStatus').textContent='Unable to connect - check Firebase config';
});

function recordLeadTime(code,days){if(!code||days<=0||days>365)return;code=code.toUpperCase();if(!leadTimeDb[code])leadTimeDb[code]={samples:[],avg:null};const entry=leadTimeDb[code];entry.samples.push({days,date:new Date().toISOString().split('T')[0]});if(entry.samples.length>20)entry.samples=entry.samples.slice(-20);entry.avg=Math.round(entry.samples.reduce((a,s)=>a+s.days,0)/entry.samples.length);saveLeadTime()}

function getPartETA(part){
  if(STAGES.indexOf(part.status)>=2)return{display:'â€”',type:'done'};
  
  // Helper to format date as "25.12."
  function formatDate(d){
    return d.getDate()+'.'+(d.getMonth()+1)+'.';
  }
  
  // For manual ETA, calculate from orderedAt if available, else from today
  if(part.manualEta!==undefined&&part.manualEta!==null){
    const baseDate=part.orderedAt?new Date(part.orderedAt):new Date();
    const arrivalDate=new Date(baseDate);
    arrivalDate.setDate(arrivalDate.getDate()+part.manualEta);
    return{display:formatDate(arrivalDate),type:'manual',days:part.manualEta};
  }
  
  const code=part.code?part.code.toUpperCase():null;
  const lt=code?leadTimeDb[code]:null;
  if(lt&&lt.avg){
    // For ordered parts, calculate arrival date from order date
    if(part.status==='ordered'&&part.orderedAt){
      const orderDate=new Date(part.orderedAt);
      const arrivalDate=new Date(orderDate);
      arrivalDate.setDate(arrivalDate.getDate()+lt.avg);
      return{display:formatDate(arrivalDate),type:'predicted',days:lt.avg,avg:lt.avg};
    }
    // For waiting parts, we can't calculate a date since we don't know when they'll be ordered
    return{display:'?',type:'unknown'};
  }
  return{display:'?',type:'unknown'};
}
function getLeadTimeHistory(code){if(!code)return null;return leadTimeDb[code.toUpperCase()]||null}
function getProgressColor(pct){if(pct<20)return'var(--red)';if(pct<40)return'var(--orange)';return'var(--green)'}

function isOnSchedule(){
  if(!projectDates.start||!projectDates.end)return true;
  const start=new Date(projectDates.start),end=new Date(projectDates.end),now=new Date();
  const totalDays=Math.max(1,(end-start)/86400000);
  const elapsedDays=Math.max(0,(now-start)/86400000);
  const expectedPct=(elapsedDays/totalDays)*100;
  const actualPct=calcOverallProgress();
  return actualPct>=expectedPct;
}

function getScheduleColor(){return isOnSchedule()?'var(--green)':'var(--red)'}
function getProgressClass(pct){if(pct<20)return'red';if(pct<40)return'orange';return'green'}

// Calculate Supplier OTD from actual project data
function calcSupplierOTD(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt);
  if(!parts.length)return null;
  let onTime=0,total=0;
  parts.forEach(p=>{
    total++;
    // Check if arrived on or before expected date
    if(p.expectedArrival){
      const expected=new Date(p.expectedArrival).getTime();
      if(p.arrivedAt<=expected+86400000)onTime++; // Give 1 day grace
    }else{
      // No expected date set, consider on-time if lead time was reasonable (<=14 days)
      const days=Math.round((p.arrivedAt-p.orderedAt)/86400000);
      if(days<=14)onTime++;
    }
  });
  return total?Math.round(onTime/total*100):null;
}

// Calculate average lead time from actual project data
function calcAvgLeadTime(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt);
  if(!parts.length)return null;
  const totalDays=parts.reduce((sum,p)=>sum+Math.round((p.arrivedAt-p.orderedAt)/86400000),0);
  return Math.round(totalDays/parts.length);
}

// Calculate OTD per manufacturer
function calcOTDByMfr(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt&&p.mfr);
  const mfrStats={};
  parts.forEach(p=>{
    const mfr=p.mfr;
    if(!mfrStats[mfr])mfrStats[mfr]={onTime:0,total:0,totalDays:0};
    mfrStats[mfr].total++;
    const days=Math.round((p.arrivedAt-p.orderedAt)/86400000);
    mfrStats[mfr].totalDays+=days;
    if(p.expectedArrival){
      const expected=new Date(p.expectedArrival).getTime();
      if(p.arrivedAt<=expected+86400000)mfrStats[mfr].onTime++;
    }else{
      if(days<=14)mfrStats[mfr].onTime++;
    }
  });
  return Object.keys(mfrStats).map(mfr=>({
    mfr,
    otd:Math.round(mfrStats[mfr].onTime/mfrStats[mfr].total*100),
    avgLead:Math.round(mfrStats[mfr].totalDays/mfrStats[mfr].total),
    total:mfrStats[mfr].total
  })).sort((a,b)=>b.otd-a.otd||b.total-a.total);
}

function getVelocityForecast(){
  // Handle edge case: only 1 history entry but has progress (e.g., project starts today with existing progress)
  if(history.length === 1) {
    const entry = history[0];
    if(entry.pct > 0) {
      // Assume all progress was made in 1 day
      const rate = entry.pct;
      const pct = calcOverallProgress();
      const remaining = 100 - pct;
      if(remaining <= 0) return { status: 'complete', rate, estDate: entry.date, daysToComplete: 0, daysLeft: getDaysLeft() };
      const daysToComplete = Math.ceil(remaining / rate);
      const estDate = new Date();
      estDate.setDate(estDate.getDate() + daysToComplete);
      const daysLeft = getDaysLeft();
      let status = 'on-track';
      if(daysLeft !== null) {
        if(daysToComplete > daysLeft + 3) status = 'at-risk';
        else if(daysToComplete > daysLeft) status = 'behind';
        else if(daysToComplete < daysLeft - 3) status = 'ahead';
      }
      return { status, rate, estDate: estDate.toISOString().split('T')[0], daysToComplete, daysLeft };
    }
    return null;
  }
  
  if(history.length < 2) return null;
  
  const first = history[0], last = history[history.length - 1];
  const days = Math.max(1, (new Date(last.date) - new Date(first.date)) / 86400000);
  const rate = (last.pct - first.pct) / days;
  
  if(rate <= 0) return { status: 'stalled', rate: 0, estDate: null, daysToComplete: null };
  
  const pct = calcOverallProgress();
  const remaining = 100 - pct;
  const daysToComplete = Math.ceil(remaining / rate);
  const estDate = new Date();
  estDate.setDate(estDate.getDate() + daysToComplete);
  const daysLeft = getDaysLeft();
  let status = 'on-track';
  if(daysLeft !== null) {
    if(daysToComplete > daysLeft + 3) status = 'at-risk';
    else if(daysToComplete > daysLeft) status = 'behind';
    else if(daysToComplete < daysLeft - 3) status = 'ahead';
  }
  return { status, rate, estDate: estDate.toISOString().split('T')[0], daysToComplete, daysLeft };
}

const getAsms=()=>data.filter(d=>d.isAsm && !d._deletedAt).sort((a,b)=>(a.priority||99)-(b.priority||99));
const getParts=()=>data.filter(d=>!d.isAsm && !d._deletedAt);
const getActions=()=>actions.filter(a=>!a._deletedAt);
const getPartActions=partId=>getActions().filter(a=>a.linkedPartId===partId&&a.status!=='completed');
const getPartById=id=>data.find(d=>String(d.id)===String(id));
const getTeamEmail=name=>{const t=team.find(m=>m.name===name);return t?t.email:''};
const calcPartProgress=p=>STAGES.indexOf(p.status)/(STAGES.length-1);
function calcAsmProgress(asmId){const kids=data.filter(d=>!d._deletedAt&&String(d.parentId)===String(asmId));if(!kids.length)return 0;return Math.round(kids.reduce((acc,k)=>acc+calcPartProgress(k),0)/kids.length*100)}
function calcOverallProgress(){const parts=getParts();if(!parts.length)return 0;return Math.round(parts.reduce((acc,p)=>acc+calcPartProgress(p),0)/parts.length*100)}
function getExpectedProgress(){if(!projectDates.start||!projectDates.end)return null;const start=new Date(projectDates.start),end=new Date(projectDates.end),now=new Date();const total=end-start,elapsed=now-start;if(elapsed<0)return 0;if(elapsed>total)return 100;return Math.round(elapsed/total*100)}
function getDaysLeft(){if(!projectDates.end)return null;return Math.ceil((new Date(projectDates.end)-new Date())/86400000)}
function getProjectDateRange(){const parts=getParts();if(!parts.length)return{start:null,end:null};let earliest=null,latest=null;parts.forEach(p=>{if(p.changedAt){const d=new Date(p.changedAt);if(!earliest||d<earliest)earliest=d;if(!latest||d>latest)latest=d}});if(projectDates.start)earliest=new Date(projectDates.start);if(projectDates.end)latest=new Date(projectDates.end);return{start:earliest,end:latest}}
function recordProgress(){const today=new Date().toISOString().split('T')[0];const pct=calcOverallProgress();const idx=history.findIndex(h=>h.date===today);if(idx>=0)history[idx].pct=pct;else history.push({date:today,pct});if(history.length>100)history=history.slice(-100)}
const formatDate=d=>{if(!d)return'â€”';const p=d.split('-');return p[1]+'/'+p[2]};
const formatDateShort=d=>{if(!d)return'â€”';const dt=new Date(d);return dt.getDate()+'.'+(dt.getMonth()+1)+'.'};
const getWeek=d=>{const o=new Date(d.getFullYear(),0,1);return Math.ceil((((d-o)/86400000)+o.getDay()+1)/7)};

function render(){
  try{
    updateProjectName();
    const parts=getParts(),asms=getAsms();
    const pct=calcOverallProgress(),daysLeft=getDaysLeft();
    const readyCount=parts.filter(p=>p.status==='installed').length;

    $('sReady').textContent=readyCount+'/'+parts.length;
    $('sReady').style.color=parts.length?(readyCount===parts.length?'var(--green)':'var(--text)'):'var(--text3)';
    const scheduleColor=getScheduleColor();
    $('sPct').textContent=pct+'%';
    $('sPct').style.color=scheduleColor;
    $('sBar').style.width=pct+'%';
    $('sBar').style.background=scheduleColor;
    $('hmProgress').title=isOnSchedule()?'On Schedule':'Behind Schedule';

    if(daysLeft!==null){$('hmDays').style.display='block';$('sDays').textContent=daysLeft+'d';$('sDays').className='hm-value '+(daysLeft<3?'red':daysLeft<7?'yellow':'')}
    else{$('hmDays').style.display='none'}

    $('p0').textContent=parts.filter(p=>p.status==='waiting').length;
    $('p1').textContent=parts.filter(p=>p.status==='to-order').length;
    $('p2').textContent=parts.filter(p=>p.status==='ordered').length;
    $('p3').textContent=parts.filter(p=>p.status==='arrived').length;
    $('p4').textContent=parts.filter(p=>p.status==='tested').length;
    $('p5').textContent=parts.filter(p=>p.status==='configured').length;
    $('p6').textContent=parts.filter(p=>p.status==='installed').length;

    document.querySelectorAll('.pipe').forEach(p=>p.classList.toggle('active',p.dataset.s===filterStage));
    $('pmParent').innerHTML='<option value="">â€”</option>'+asms.map(a=>'<option value="'+a.id+'">'+esc(a.name)+'</option>').join('');
    updateSelects();updateExpandToggle();renderInsights();updateAIAlert();

    let badges='';
    if(filterStage)badges+='<span class="filter-badge">'+SLABELS[filterStage]+' <button onclick="window.clearStageFilter()">Ã—</button></span>';
    if(filterAssignee)badges+='<span class="filter-badge">'+esc(filterAssignee)+' <button onclick="window.clearAssigneeFilter()">Ã—</button></span>';
    if(filterPO)badges+='<span class="filter-badge">PO: '+esc(filterPO)+' <button onclick="window.clearPOFilter()">Ã—</button></span>';
    $('filterBadges').innerHTML=badges;

    let html='';
    
    // Helper to render a part and its sub-parts recursively
    function renderPartWithChildren(part,depth){
      let partHtml=renderPart({type:'part',item:part,child:true,depth:depth});
      // Check for sub-parts (parts whose parentId is this part's id) - exclude deleted
      const subParts=data.filter(d=>!d.isAsm&&!d._deletedAt&&String(d.parentId)===String(part.id)).filter(matchPart);
      if(subParts.length){
        subParts.forEach(sp=>{
          partHtml+=renderPartWithChildren(sp,depth+1);
        });
      }
      return partHtml;
    }
    
    asms.forEach(asm=>{
      // Get direct children of assembly (not sub-parts of parts) - exclude deleted
      const kids=data.filter(d=>!d._deletedAt&&String(d.parentId)===String(asm.id)&&!data.find(p=>!p._deletedAt&&String(p.id)===String(d.parentId)&&!p.isAsm));
      const matchingKids=kids.filter(matchPart);
      const asmMatch=!filterAssignee||asm.assignee===filterAssignee;
      if((filterStage||filterAssignee||filterPO)&&!matchingKids.length&&!asmMatch)return;
      if(searchQ&&asm.name.toLowerCase().indexOf(searchQ.toLowerCase())===-1&&!matchingKids.length)return;
      const isExp=(filterStage||filterAssignee||filterPO)?true:expanded[String(asm.id)];
      html+=renderAsm({type:'asm',item:asm,kids:kids.length,match:matchingKids.length,exp:isExp});
      if(isExp){
        const visibleKids=(filterStage||filterAssignee||filterPO)?matchingKids:kids.filter(matchPart);
        visibleKids.forEach(k=>{
          html+=renderPartWithChildren(k,0);
        });
        html+='<div class="add-row" style="padding-left:44px"><button class="add-row-btn" onclick="window.addNewPart(\''+asm.id+'\')" title="Add part to '+esc(asm.name)+'">+</button></div>';
      }
    });
    data.filter(d=>!d.isAsm&&!d._deletedAt&&!d.parentId).filter(matchPart).forEach(p=>{html+=renderPart({type:'part',item:p,child:false,depth:0})});
    
    // Show empty state with Add Assembly button if no assemblies
    if(!asms.length && !html){
      html='<div style="text-align:center;padding:60px 20px;color:var(--text3)">'+
        '<div style="font-size:32px;margin-bottom:12px">ðŸ“¦</div>'+
        '<div style="font-size:14px;font-weight:500;color:var(--text2);margin-bottom:8px">No assemblies yet</div>'+
        '<div style="font-size:12px;margin-bottom:20px">Add your first assembly to start tracking parts</div>'+
        '<button class="btn btn-primary" onclick="window.addNewAssembly()" style="display:inline-flex">+ Add Assembly</button>'+
      '</div>';
    } else if(asms.length && !filterStage && !filterAssignee && !filterPO && !searchQ) {
      // Add "Add Assembly" button at the bottom when not filtering
      html+='<div class="add-row" style="padding-left:12px;margin-top:8px"><button class="add-row-btn" onclick="window.addNewAssembly()" title="Add new assembly" style="width:auto;padding:0 12px;font-size:11px">+ Add Assembly</button></div>';
    }
    
    $('partsList').innerHTML=html;
    $('partsTable').style.display='flex';$('emptyList').style.display='none';
    if(highlightPartId){setTimeout(()=>{const row=document.querySelector('[data-part-id="'+highlightPartId+'"]');if(row){row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),5000)}highlightPartId=null},50)}
    if($('ganttPanel').classList.contains('active'))renderGantt();
  }catch(err){console.error('Render error:',err)}
}

const matchPart=p=>{if(filterStage&&p.status!==filterStage)return false;if(filterAssignee&&p.assignee!==filterAssignee)return false;if(filterPO&&p.poNumber!==filterPO)return false;if(searchQ&&[p.name,p.assignee,p.code,p.mfr].join(' ').toLowerCase().indexOf(searchQ.toLowerCase())===-1)return false;return true};

function renderInsights(){
  const daysLeft=getDaysLeft(),pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast(),otd=calcSupplierOTD(),avgLead=calcAvgLeadTime();
  const parts=getParts(),asms=getAsms();
  const now=Date.now(),day=86400000;

  // Update Velocity Forecast card
  if(forecast&&forecast.rate>0){
    $('forecastDate').textContent=formatDateShort(forecast.estDate);
    $('forecastDate').style.color=forecast.status==='ahead'||forecast.status==='on-track'?'var(--green)':'var(--red)';
    if(forecast.daysLeft!==null){
      const diff=forecast.daysLeft-forecast.daysToComplete;
      if(diff>0){$('forecastLabel').textContent=diff+' days early';$('forecastLabel').style.color='var(--green)'}
      else if(diff<0){$('forecastLabel').textContent=Math.abs(diff)+' days late';$('forecastLabel').style.color='var(--red)'}
      else{$('forecastLabel').textContent='on deadline';$('forecastLabel').style.color='var(--text2)'}
    }else{$('forecastLabel').textContent=''}
    $('forecastDetail').textContent='At '+forecast.rate.toFixed(1)+'%/day â€¢ '+forecast.daysToComplete+'d to complete';
  }else{
    $('forecastDate').textContent='â€”';$('forecastDate').style.color='var(--text3)';
    $('forecastLabel').textContent='';$('forecastDetail').textContent='Need 2+ days of data';
  }

  // Assembly progress list
  const asmProgress=asms.map(a=>{
    const prog=calcAsmProgress(a.id);
    return {id:a.id,name:a.name,progress:prog};
  }).sort((a,b)=>a.progress-b.progress);
  
  $('asmProgressList').innerHTML=asmProgress.length?asmProgress.map(a=>{
    const color=a.progress<30?'var(--red)':a.progress<60?'var(--orange)':'var(--green)';
    return '<div class="asm-progress-item"><span class="asm-progress-name">'+esc(a.name)+'</span><div class="asm-progress-bar"><div class="asm-progress-fill" style="width:'+a.progress+'%;background:'+color+'"></div></div><span class="asm-progress-pct" style="color:'+color+'">'+a.progress+'%</span></div>';
  }).join(''):'<div style="color:var(--text3);font-size:12px;padding:12px">No assemblies</div>';

  // Bottleneck list - parts stuck longest
  const bottlenecks=parts.filter(p=>p.changedAt&&p.status!=='installed').map(p=>({
    id:p.id,name:p.name,status:p.status,days:Math.floor((now-p.changedAt)/day)
  })).filter(p=>p.days>=3).sort((a,b)=>b.days-a.days).slice(0,8);

  $('bottleneckList').innerHTML=bottlenecks.length?bottlenecks.map(b=>{
    const level=b.days>=7?'':'warning';
    return '<div class="bottleneck-item '+level+'"><span class="bottleneck-name">'+esc(b.name)+'</span><span class="bottleneck-days">'+b.days+'d in '+SLABELS[b.status]+'</span></div>';
  }).join(''):'<div style="color:var(--text3);font-size:12px;padding:12px">No bottlenecks detected</div>';
}

function renderActions(){
  // Action plan removed - function kept as stub
  return;
}

function renderBurndown(){
  const chart=$('burndownChart');
  if(!projectDates.start||!projectDates.end){chart.innerHTML='<div class="burndown-empty" onclick="window.openDates()"><span>ðŸ“…</span><span>Set project dates</span></div>';$('burndownDates').innerHTML='';return}
  const start=new Date(projectDates.start),end=new Date(projectDates.end);
  const totalDays=Math.max(1,(end-start)/86400000);
  const w=500,h=180,pad={top:16,right:16,bottom:40,left:36};
  const chartW=w-pad.left-pad.right,chartH=h-pad.top-pad.bottom;
  const xScale=x=>pad.left+(x/totalDays)*chartW;
  const yScale=y=>pad.top+(1-y/100)*chartH;
  
  // If no history, create a point for today
  let workingHistory = history.length > 0 ? history : [{date: new Date().toISOString().split('T')[0], pct: calcOverallProgress()}];
  
  let points=workingHistory.filter(pt=>{const d=new Date(pt.date);return d>=start&&d<=end}).map(pt=>{const d=new Date(pt.date),dayNum=(d-start)/86400000;return{x:xScale(dayNum),y:yScale(pt.pct),pct:pt.pct,dayNum,date:pt.date}});
  points.sort((a,b) => a.dayNum - b.dayNum);
  
  // Ensure we have at least 2 points to draw a line
  if(points.length === 0){
    // No points in range - add project start at 0% and today
    const todayDate = new Date();
    const todayDayNum = (todayDate - start) / 86400000;
    const currentPct = calcOverallProgress();
    points = [
      {x: xScale(0), y: yScale(0), pct: 0, dayNum: 0, date: projectDates.start},
      {x: xScale(todayDayNum), y: yScale(currentPct), pct: currentPct, dayNum: todayDayNum, date: todayDate.toISOString().split('T')[0]}
    ];
  } else if(points.length === 1){
    // Only 1 point - add project start at 0%
    if(points[0].dayNum > 0){
      points.unshift({x: xScale(0), y: yScale(0), pct: 0, dayNum: 0, date: projectDates.start});
    } else {
      // Point is at start, add today
      const todayDate = new Date();
      const todayDayNum = (todayDate - start) / 86400000;
      const currentPct = calcOverallProgress();
      points.push({x: xScale(todayDayNum), y: yScale(currentPct), pct: currentPct, dayNum: todayDayNum, date: todayDate.toISOString().split('T')[0]});
    }
  }
  
  let svg='<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="xMidYMid meet">';
  
  // Grid lines
  [0,25,50,75,100].forEach(g=>{const y=yScale(g);svg+='<line x1="'+pad.left+'" y1="'+y+'" x2="'+(w-pad.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="1"/><text x="'+(pad.left-6)+'" y="'+(y+4)+'" fill="var(--text3)" font-size="10" text-anchor="end">'+g+'</text>'});
  
  // X-axis date labels
  const formatMonth = d => d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
  svg += '<text x="'+pad.left+'" y="'+(h-10)+'" fill="var(--text3)" font-size="9" text-anchor="start">'+formatMonth(start)+'</text>';
  svg += '<text x="'+(w/2)+'" y="'+(h-10)+'" fill="var(--text3)" font-size="9" text-anchor="middle">'+formatMonth(new Date(start.getTime()+(end-start)/2))+'</text>';
  svg += '<text x="'+(w-pad.right)+'" y="'+(h-10)+'" fill="var(--text3)" font-size="9" text-anchor="end">'+formatMonth(end)+'</text>';
  
  // Today marker
  const today = new Date();
  if(today >= start && today <= end) {
    const todayX = xScale((today - start) / 86400000);
    svg += '<line x1="'+todayX+'" y1="'+pad.top+'" x2="'+todayX+'" y2="'+(h-pad.bottom)+'" stroke="var(--accent)" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>';
  }
  
  // Target line
  svg+='<line x1="'+xScale(0)+'" y1="'+yScale(0)+'" x2="'+xScale(totalDays)+'" y2="'+yScale(100)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="4,3"/>';
  
  // Progress lines
  for(let i=0;i<points.length-1;i++){const p1=points[i],p2=points[i+1];const idealY1=(p1.dayNum/totalDays)*100,idealY2=(p2.dayNum/totalDays)*100;const above1=p1.pct>=idealY1,above2=p2.pct>=idealY2;const col1=above1?'var(--green)':'var(--red)';const col2=above2?'var(--green)':'var(--red)';if(above1===above2){svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>'}else{const t=(idealY1-p1.pct)/((p2.pct-p1.pct)-(idealY2-idealY1));const ix=p1.x+t*(p2.x-p1.x),iy=p1.y+t*(p2.y-p1.y);svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+ix+'" y2="'+iy+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/><line x1="'+ix+'" y1="'+iy+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col2+'" stroke-width="2.5" stroke-linecap="round"/>'}}
  
  // Prediction line with tooltip - use current progress and calculate from today
  if(points.length>=1){
    const lastPt=points[points.length-1];
    const forecast=getVelocityForecast();
    const currentPct=calcOverallProgress();
    const today=new Date();
    today.setHours(0,0,0,0);
    const todayDayNum=Math.round((today-start)/86400000);
    
    if(forecast&&forecast.rate>0&&currentPct<100){
      const remaining=100-currentPct;
      const daysTo100=remaining/forecast.rate;
      const dayAt100=todayDayNum+daysTo100;
      const estDate=new Date(today.getTime()+daysTo100*86400000);
      const estStr=estDate.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
      if(dayAt100<=totalDays){
        const x100=xScale(dayAt100),y100=yScale(100);
        svg+='<line x1="'+lastPt.x+'" y1="'+lastPt.y+'" x2="'+x100+'" y2="'+y100+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" opacity="0.7"><title>Forecasted finish: '+estStr+'</title></line>';
        svg+='<circle cx="'+x100+'" cy="'+y100+'" r="4" fill="var(--bg2)" stroke="var(--text3)" stroke-width="1.5" opacity="0.9" style="cursor:pointer"><title>Forecasted finish: '+estStr+'</title></circle>';
      }else{
        const daysRem=totalDays-todayDayNum;
        const predPct=currentPct+(forecast.rate*daysRem);
        svg+='<line x1="'+lastPt.x+'" y1="'+lastPt.y+'" x2="'+xScale(totalDays)+'" y2="'+yScale(predPct)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" opacity="0.7"><title>Forecasted finish: '+estStr+' (after deadline)</title></line>';
      }
    }else if(forecast&&forecast.rate<=0&&currentPct<100){
      svg+='<line x1="'+lastPt.x+'" y1="'+lastPt.y+'" x2="'+xScale(totalDays)+'" y2="'+lastPt.y+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" opacity="0.5"><title>Progress stalled</title></line>';
    }
  }
  
  // Data points with tooltips
  points.forEach(p=>{
    const idealY=(p.dayNum/totalDays)*100;
    const dateStr=new Date(p.date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const dotColor = p.pct>=idealY ? 'var(--green)' : 'var(--red)';
    svg+='<circle cx="'+p.x+'" cy="'+p.y+'" r="4" fill="'+dotColor+'" style="cursor:pointer"><title>'+dateStr+': '+Math.round(p.pct)+'%</title></circle>';
  });
  
  svg+='</svg>';chart.innerHTML=svg;
  $('burndownDates').innerHTML='';
}

function renderAsm(r){
  const a=r.item,progress=calcAsmProgress(a.id);
  const pColor=progress<20?'var(--red)':progress<40?'var(--orange)':'var(--green)';
  const count=(filterStage||filterAssignee||filterPO)?r.match+'/'+r.kids:r.kids;
  const priorityBtns='<div class="asm-priority" onclick="event.stopPropagation()"><button class="asm-priority-btn" onclick="window.moveAsmUp(\''+a.id+'\')" title="Move up">â–²</button><button class="asm-priority-btn" onclick="window.moveAsmDown(\''+a.id+'\')" title="Move down">â–¼</button></div>';
  const ganttBtn='<button class="sm-btn gantt-link-btn" onclick="window.goToGanttAsm(\''+a.id+'\',event)" title="View in Timeline"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18M7 7h6M9 11h9M7 15h5"/></svg></button>';
  return '<div class="asm-row parts-grid" data-asm-id="'+a.id+'" onclick="window.toggleAsmRow(event,\''+a.id+'\')"><div class="asm-toggle">'+(r.exp?'â–¼':'â–¶')+'</div><div class="asm-name-cell">'+priorityBtns+'<span class="asm-name">'+esc(a.name)+'</span> <span class="asm-meta">('+count+')</span></div><div></div><div></div><div></div><div></div><div onclick="event.stopPropagation()">'+ganttBtn+'</div><div class="asm-progress"><div class="asm-bar"><div class="asm-bar-fill" style="width:'+progress+'%;background:'+pColor+';"></div></div><span class="asm-pct" style="color:'+pColor+'">'+progress+'%</span></div><div></div><div class="notes-cell" title="'+(a.notes?esc(a.notes):'')+'">'+(a.notes?esc(a.notes):'â€”')+'</div><div class="asm-actions" onclick="event.stopPropagation()"><button class="sm-btn" onclick="window.editAsm(\''+a.id+'\',event)">âœŽ</button><button class="del-btn" onclick="window.confirmDelete(\''+a.id+'\',\'assembly\',event)" style="margin-left:4px">Ã—</button></div></div>';
}

function renderPart(r){
  const p=r.item;
  const partStages=getPartStages(p);
  const si=partStages.indexOf(p.status);
  const isInstalled=p.status==='installed';
  const stageDots=partStages.map((s,i)=>'<div class="stage-dot'+((i<si||isInstalled)?' done':(i===si?' current':'')+'" title="'+SLABELS[s])+'"></div>').join('');
  
  // Determine indent level
  const depth=r.depth||0;
  const indent=depth*24;
  
  // Add sub-part button (appears on hover)
  const addSubBtn='<button class="subpart-add" onclick="window.addSubPart(\''+p.id+'\',event)" title="Add sub-part">+</button>';
  
  // ETA and PO handling
  let etaHtml='';
  let etaDate='',etaClass='historical',poHtml='';
  
  // Only show arrival date if not installed
  if(p.status!=='installed'){
    if(p.expectedArrival){
      etaDate=formatDateShort(p.expectedArrival);
      etaClass='user-set';
    }else if(p.status==='ordered'||p.status==='to-order'){
      const eta=getPartETA(p);
      if(eta.type==='predicted'){
        etaDate=eta.display;
        etaClass='historical';
      }else if(eta.type==='manual'){
        etaDate=eta.display;
        etaClass='user-set';
      }else{
        etaDate='?';
        etaClass='historical';
      }
    }else{
      etaDate='?';
      etaClass='historical';
    }
  }
  
  // Always show PO number if exists
  if(p.poNumber){
    const isFiltered=filterPO===p.poNumber;
    poHtml='<span class="eta-po'+(isFiltered?' active':'')+'" onclick="window.showPODetails(\''+esc(p.poNumber)+'\',event)" title="Click to view PO details">'+esc(p.poNumber)+'</span>';
  }
  
  if(etaDate||poHtml){
    etaHtml='<div class="eta-cell">'+(etaDate?'<span class="eta-date '+etaClass+'" onclick="window.openEtaModal(\''+p.id+'\',event)" title="Click to edit">'+etaDate+'</span>':'')+(poHtml||'')+'</div>';
  }else{
    etaHtml='<span style="color:var(--text3)">â€”</span>';
  }
  
  // Notes/Comments - clickable cell that opens chat popover
  const commentCount=p.comments?.length||0;
  const lastComment=p.comments&&p.comments.length?p.comments[p.comments.length-1]:null;
  const maxLen=commentCount>1?28:42;
  const commentPreview=lastComment?esc(lastComment.text).substring(0,maxLen)+(lastComment.text.length>maxLen?'â€¦':''):'';
  const notesHtml='<div class="notes-chat-cell" onclick="window.openNotesChat(\''+p.id+'\',event)"><span class="comment-text">'+(commentPreview||'<span class="add-note">add note</span>')+'</span>'+(commentCount>1?'<span class="comment-badge">+'+(commentCount-1)+'</span>':'')+'</div>';
  
  const depthClass=depth>0?' depth-'+Math.min(depth,3):'';
  const childClass=r.child?' child'+depthClass:'';
  
  // Checkbox for bulk selection
  const isSelected=selectedParts.has(String(p.id));
  const checkbox='<input type="checkbox" class="part-checkbox" data-part-id="'+p.id+'" '+(isSelected?'checked':'')+' onclick="window.togglePartSelection(\''+p.id+'\',event)">';
  
  // Status badge with has-note indicator for pending parts
  const hasNoteClass=(p.status==='waiting'&&p.pendingNote)?' has-note':'';
  
  // Calculate days in current stage
  const now=Date.now();
  const day=86400000;
  const daysInStage=p.changedAt?Math.floor((now-p.changedAt)/day):0;
  let daysClass='fresh';
  if(daysInStage>=14)daysClass='stuck';
  else if(daysInStage>=7)daysClass='aging';
  else if(daysInStage>=3)daysClass='normal';
  const daysBadge=p.status!=='installed'?'<span class="days-badge '+daysClass+'">'+daysInStage+'d</span>':'';
  
  const statusBadge='<span class="status-badge '+p.status+hasNoteClass+'" onclick="window.openStatusPopover(\''+p.id+'\',event)" style="cursor:pointer" '+(p.pendingNote?'title="'+esc(p.pendingNote)+'"':'')+'>'+SLABELS[p.status]+daysBadge+'</span>';
  
  return '<div class="part-row parts-grid'+childClass+(isSelected?' selected':'')+'" data-part-id="'+p.id+'" data-depth="'+depth+'" onclick="window.handleRowClick(event)"><div>'+checkbox+'</div><div class="part-name-cell" style="padding-left:'+indent+'px"><span class="cell" onclick="window.editCell(event,\''+p.id+'\',\'name\')">'+esc(p.name)+'</span>'+addSubBtn+'</div><div class="cell muted" onclick="window.editCellAutocomplete(event,\''+p.id+'\',\'code\')">'+(p.code?esc(p.code):'â€”')+'</div><div class="cell muted" onclick="window.editCellAutocomplete(event,\''+p.id+'\',\'mfr\')">'+(p.mfr?esc(p.mfr):'â€”')+'</div><div class="cell muted" onclick="window.editCellAssignee(event,\''+p.id+'\')">'+(p.assignee?esc(p.assignee):'â€”')+'</div><div class="cell muted" onclick="window.editCell(event,\''+p.id+'\',\'qty\')">'+(p.qty||1)+'</div><div>'+statusBadge+'</div><div class="stage-dots">'+stageDots+'</div><div>'+etaHtml+'</div><div>'+notesHtml+'</div><div class="part-actions" onclick="event.stopPropagation()"><button class="print-label-btn" onclick="window.openLabelModal(\''+p.id+'\',event)" title="Print label">ðŸ·ï¸</button><button class="del-btn" onclick="window.confirmDelete(\''+p.id+'\',\'part\',event)">Ã—</button></div></div>';
}

let ganttZoom='day'; // day, week
let ganttExpanded={};
let ganttBarColors={}; // Store custom bar colors
let ganttResourceFilter=''; // Filter by assignee

// Detect resource conflicts (same person assigned to overlapping date ranges)
function detectResourceConflicts(rows){
  const conflicts=new Map(); // rowId -> [{id, name, start, end, assignee}]
  
  for(let i=0;i<rows.length;i++){
    const a=rows[i];
    if(!a.assignee||!a.startDate||!a.endDate)continue;
    
    for(let j=i+1;j<rows.length;j++){
      const b=rows[j];
      if(!b.assignee||!b.startDate||!b.endDate)continue;
      if(a.assignee!==b.assignee)continue;
      
      // Check overlap: A starts before B ends AND A ends after B starts
      if(a.startDate<=b.endDate&&a.endDate>=b.startDate){
        if(!conflicts.has(a.id))conflicts.set(a.id,[]);
        if(!conflicts.has(b.id))conflicts.set(b.id,[]);
        conflicts.get(a.id).push({id:b.id,name:b.name,start:b.startDate,end:b.endDate,assignee:a.assignee});
        conflicts.get(b.id).push({id:a.id,name:a.name,start:a.startDate,end:a.endDate,assignee:a.assignee});
      }
    }
  }
  return conflicts;
}

// Build conflict description HTML for popover
function buildConflictPopoverHtml(conflicts, rows){
  if(conflicts.size === 0) return '';
  
  // Group conflicts by assignee to make popover more readable
  const byAssignee = new Map(); // assignee -> [{task1, task2}]
  const seen = new Set(); // Track pairs we've already recorded
  
  conflicts.forEach((conflictList, rowId) => {
    const row = rows.find(r => r.id === rowId);
    if(!row) return;
    
    conflictList.forEach(c => {
      const pairKey = [rowId, c.id].sort().join('-');
      if(seen.has(pairKey)) return;
      seen.add(pairKey);
      
      const assignee = c.assignee || row.assignee;
      if(!byAssignee.has(assignee)) byAssignee.set(assignee, []);
      byAssignee.get(assignee).push({
        task1: row.name,
        task2: c.name
      });
    });
  });
  
  // Build popover HTML
  let html = '<div class="gantt-conflict-popover-title">âš ï¸ Resource Conflicts</div>';
  
  byAssignee.forEach((pairs, assignee) => {
    html += '<div class="gantt-conflict-item">';
    html += '<div class="gantt-conflict-resource">' + esc(assignee) + '</div>';
    html += '<div class="gantt-conflict-tasks">';
    pairs.forEach((p, i) => {
      if(i > 0) html += '<br>';
      html += '"' + esc(p.task1) + '" overlaps with "' + esc(p.task2) + '"';
    });
    html += '</div></div>';
  });
  
  return html;
}

function renderGantt(){
  // Update resource filter dropdown with team members
  updateResourceFilter();
  
  const asms=getAsms();
  const parts=getParts();
  if(!asms.length){
    $('ganttSidebar').innerHTML='<div style="padding:40px 20px;text-align:center;color:var(--text3)"><div style="font-size:24px;margin-bottom:8px">ðŸ“¦</div><div style="font-size:12px;margin-bottom:16px">No assemblies yet</div><button class="btn btn-primary" onclick="window.addNewAssembly()" style="display:inline-flex;font-size:12px">+ Add Assembly</button></div>';
    $('ganttTimelineHeader').innerHTML='';
    $('ganttTimelineBody').innerHTML='';
    return;
  }

  const dayMs=86400000;
  
  // Create today's date normalized to local midnight
  const today=new Date();
  today.setHours(0,0,0,0);
  const todayStr=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');
  
  // Parse project dates as local dates (not UTC)
  const parseLocalDate=(str)=>{
    if(!str)return null;
    const parts=str.split('-');
    return new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]));
  };
  
  const projStart=projectDates.start?parseLocalDate(projectDates.start):new Date(today);
  const projEnd=projectDates.end?parseLocalDate(projectDates.end):new Date(today.getTime()+90*dayMs);
  
  // Use projectDates for timeline range
  const startDate = projStart;
  const endDate = projEnd;
  
  // Calculate timeline range based on user dates
  // Use the actual start/end dates as the primary range, but ensure today is visible
  let rangeStart=new Date(startDate);
  let rangeEnd=new Date(endDate);
  
  // If today is outside the range, extend the range to include it
  if(today < rangeStart) {
    rangeStart = new Date(today);
  }
  if(today > rangeEnd) {
    rangeEnd = new Date(today);
  }
  
  // Add buffer on both ends (in weeks)
  rangeStart.setDate(rangeStart.getDate()-7);
  rangeEnd.setDate(rangeEnd.getDate()+7);

  // Function to get ISO week number
  function getISOWeek(date){
    const d=new Date(date);
    d.setHours(0,0,0,0);
    // Set to Thursday of current week (ISO weeks start Monday, Thursday is middle)
    d.setDate(d.getDate()+3-(d.getDay()+6)%7);
    // Get first Thursday of year
    const yearStart=new Date(d.getFullYear(),0,4);
    yearStart.setDate(yearStart.getDate()+3-(yearStart.getDay()+6)%7);
    // Calculate week number
    const weekNum=1+Math.round((d-yearStart)/(7*24*60*60*1000));
    return weekNum;
  }

  // Generate WEEKS array instead of days
  const weeks=[];
  const weekMs=7*dayMs;
  
  // Align to week start (Monday)
  let weekStart=new Date(rangeStart);
  const dayOfWeek=weekStart.getDay();
  const daysToMonday=dayOfWeek===0?-6:(1-dayOfWeek);
  weekStart.setDate(weekStart.getDate()+daysToMonday);
  weekStart.setHours(0,0,0,0);
  
  while(weekStart<=rangeEnd){
    const weekEnd=new Date(weekStart.getTime()+6*dayMs);
    const containsToday=today>=weekStart&&today<=weekEnd;
    const isoWeekNum=getISOWeek(weekStart);
    weeks.push({
      num:isoWeekNum,
      start:new Date(weekStart),
      end:weekEnd,
      isToday:containsToday
    });
    weekStart=new Date(weekStart.getTime()+weekMs);
  }

  const cellWidth=70;
  const totalWidth=weeks.length*cellWidth;
  const todayWeekIdx=weeks.findIndex(w=>w.isToday);

  // Render timeline header with weeks
  let headerHtml='';
  weeks.forEach((week,i)=>{
    const classes=['gantt-timeline-day'];
    if(week.isToday)classes.push('today');
    headerHtml+='<div class="'+classes.join(' ')+'" style="min-width:'+cellWidth+'px;width:'+cellWidth+'px"><div style="font-size:11px;font-weight:600">W'+week.num+'</div><div class="day-num" style="font-size:9px;opacity:0.7">'+week.start.getDate()+'/'+(week.start.getMonth()+1)+'</div></div>';
  });
  // Add today line to header
  if(todayWeekIdx>=0){
    const daysIntoWeek=Math.floor((today-weeks[todayWeekIdx].start)/dayMs);
    const todayPos=todayWeekIdx*cellWidth+(daysIntoWeek/7)*cellWidth+cellWidth/2;
    headerHtml+='<div class="gantt-today-line" style="left:'+todayPos+'px;top:0;bottom:0"></div>';
  }
  $('ganttTimelineHeader').innerHTML=headerHtml;

  // Color palette for assemblies (cycling through pleasant colors)
  const asmColors=['#5a8fd8','#6aaa6a','#d87756','#9b6bb5','#c07070','#b8a050','#5ab5b5','#7a8fa0','#aa6a8a','#6a9a5a'];

  // Build assembly rows with calculated dates
  let rows=[];
  const totalDuration=Math.ceil((endDate-startDate)/dayMs);
  
  asms.forEach((asm,asmIdx)=>{
    const asmParts=parts.filter(p=>String(p.parentId)===String(asm.id));
    const asmProgress=calcAsmProgress(asm.id);
    
    // Use custom dates if set, otherwise calculate
    let asmStart, asmEnd;
    
    // Check for custom gantt dates on assembly
    if(asm.ganttStart){
      asmStart=parseLocalDate(asm.ganttStart);
    }
    if(asm.ganttEnd){
      asmEnd=parseLocalDate(asm.ganttEnd);
    }
    
    // If no custom dates, try to calculate from parts
    if(!asmStart||!asmEnd){
      if(asmParts.length>0){
        // Find earliest start from parts
        const partStarts=asmParts.map(p=>{
          if(p.orderedAt)return new Date(p.orderedAt);
          if(p.changedAt)return new Date(p.changedAt);
          return null;
        }).filter(d=>d);
        
        // Find latest end from parts  
        const partEnds=asmParts.map(p=>{
          if(p.expectedArrival)return new Date(p.expectedArrival);
          if(p.arrivedAt)return new Date(p.arrivedAt);
          if(p.changedAt)return new Date(p.changedAt+14*dayMs);
          return null;
        }).filter(d=>d);
        
        if(!asmStart&&partStarts.length>0){
          asmStart=new Date(Math.min(...partStarts.map(d=>d.getTime())));
        }
        if(!asmEnd&&partEnds.length>0){
          asmEnd=new Date(Math.max(...partEnds.map(d=>d.getTime())));
        }
      }
    }
    
    // If no dates from parts, distribute assemblies in a realistic Gantt pattern
    if(!asmStart||!asmEnd){
      // Stagger assemblies: some overlap, some sequential
      const asmCount=asms.length;
      const avgDuration=Math.floor(totalDuration*0.4); // Each assembly ~40% of project
      const stagger=Math.floor((totalDuration-avgDuration)/(asmCount||1));
      
      const offset=asmIdx*stagger;
      asmStart=new Date(startDate.getTime()+offset*dayMs);
      asmEnd=new Date(asmStart.getTime()+avgDuration*dayMs);
      
      // Don't extend past project end
      if(asmEnd>endDate)asmEnd=new Date(endDate);
    }
    
    // Ensure minimum bar width
    if(asmEnd-asmStart<7*dayMs){
      asmEnd=new Date(asmStart.getTime()+14*dayMs);
    }
    
    rows.push({
      type:'asm',
      id:asm.id,
      name:asm.name,
      assignee:asm.assignee||'',
      startDate:asmStart,
      endDate:asmEnd,
      progress:asmProgress,
      color:ganttBarColors['asm-'+asm.id]||asmColors[asmIdx%asmColors.length],
      partCount:asmParts.length
    });
  });

  // Filter rows by resource if filter is set
  if(ganttResourceFilter){
    rows=rows.filter(r=>r.assignee===ganttResourceFilter);
  }

  // Detect resource conflicts (before filtering changes the array)
  const conflicts=detectResourceConflicts(rows);
  const totalConflicts=conflicts.size;
  const conflictPopoverHtml=buildConflictPopoverHtml(conflicts, rows);

  // Sort rows by start date (earliest first)
  rows.sort((a,b)=>{
    if(!a.startDate&&!b.startDate)return 0;
    if(!a.startDate)return 1;
    if(!b.startDate)return -1;
    return a.startDate.getTime()-b.startDate.getTime();
  });

  // Render sidebar (assemblies only)
  let sidebarHtml='';
  rows.forEach(row=>{
    const startStr=row.startDate?formatDateShort(row.startDate):'â€”';
    const endStr=row.endDate?formatDateShort(row.endDate):'â€”';
    const duration=row.startDate&&row.endDate?Math.max(1,Math.ceil((row.endDate-row.startDate)/dayMs)):'â€”';
    const startISO=row.startDate?row.startDate.toISOString().split('T')[0]:'';
    const endISO=row.endDate?row.endDate.toISOString().split('T')[0]:'';
    const nameLink='<span class="gantt-asm-link" onclick="window.goToAsm(\''+row.id+'\')">'+esc(row.name)+'</span>';
    
    // Build resource select dropdown
    let resourceOptions='<option value="">â€”</option>';
    team.forEach(t=>{
      const selected=t.name===row.assignee?'selected':'';
      resourceOptions+='<option value="'+esc(t.name)+'" '+selected+'>'+esc(t.name)+'</option>';
    });
    const resourceSelect='<select class="gantt-resource-select" onchange="window.setAsmAssignee(\''+row.id+'\',this.value)">'+resourceOptions+'</select>';
    
    sidebarHtml+='<div class="gantt-sidebar-row asm" data-row-type="asm" data-row-id="'+row.id+'"><div class="gantt-col-name">'+nameLink+'</div><div class="gantt-col-resource">'+resourceSelect+'</div><div class="gantt-col-start" data-field="start" data-date="'+startISO+'">'+startStr+'</div><div class="gantt-col-end" data-field="end" data-date="'+endISO+'">'+endStr+'</div><div class="gantt-col-dur">'+duration+'</div></div>';
  });
  $('ganttSidebar').innerHTML=sidebarHtml;

  // Render timeline body with bars
  let bodyHtml='';

  rows.forEach((row,rowIdx)=>{
    let cellsHtml='';
    weeks.forEach(week=>{
      const classes=['gantt-timeline-cell'];
      if(week.isToday)classes.push('today');
      cellsHtml+='<div class="'+classes.join(' ')+'" style="min-width:'+cellWidth+'px;width:'+cellWidth+'px"></div>';
    });

    // Calculate bar position based on weeks
    let barHtml='';
    if(row.startDate&&row.endDate){
      // Find which week the bar starts and ends in
      let startWeekIdx=-1,endWeekIdx=-1;
      weeks.forEach((week,i)=>{
        if(startWeekIdx<0&&row.startDate<=week.end)startWeekIdx=i;
        if(row.endDate>=week.start)endWeekIdx=i;
      });
      
      if(startWeekIdx>=0){
        // Calculate precise position within week
        const startWeek=weeks[startWeekIdx];
        const daysIntoStartWeek=Math.max(0,Math.floor((row.startDate-startWeek.start)/dayMs));
        const barStart=startWeekIdx*cellWidth+(daysIntoStartWeek/7)*cellWidth;
        
        const endWeek=weeks[Math.min(endWeekIdx,weeks.length-1)];
        const daysIntoEndWeek=Math.min(7,Math.ceil((row.endDate-endWeek.start)/dayMs));
        const barEnd=endWeekIdx*cellWidth+(daysIntoEndWeek/7)*cellWidth;
        
        const barWidth=Math.max(cellWidth/2,barEnd-barStart);
        
        // Progress indicator
        const progressWidth=Math.round(row.progress);
        const progressHtml=progressWidth>0?'<div class="gantt-bar-progress" style="width:'+progressWidth+'%"></div>':'';
        
        // Check for conflicts
        const rowConflicts=conflicts.get(row.id);
        const hasConflict=rowConflicts&&rowConflicts.length>0;
        const conflictClass=hasConflict?' has-conflict':'';
        const conflictIcon=hasConflict?'<span class="gantt-bar-conflict">âš ï¸</span>':'';
        
        // Build conflict data for tooltip
        let conflictData='';
        if(hasConflict){
          conflictData=rowConflicts.map(c=>c.name+'|'+formatDateShort(c.start)+'-'+formatDateShort(c.end)).join(';;');
        }
        
        // Check if overdue (end date passed but not 100% complete)
        const isOverdue=row.endDate<today&&row.progress<100;
        const overdueClass=isOverdue?' overdue':'';
        
        // Label shows assembly name + progress
        const label=esc(row.name)+' Â· '+row.progress+'%';
        
        // Resize handles
        const resizeHandles='<div class="gantt-bar-resize gantt-bar-resize-left" data-resize="start"></div><div class="gantt-bar-resize gantt-bar-resize-right" data-resize="end"></div>';
        
        // Data attributes for tooltip
        const startStr=formatDateShort(row.startDate);
        const endStr=formatDateShort(row.endDate);
        const duration=Math.max(1,Math.ceil((row.endDate-row.startDate)/dayMs));
        
        barHtml='<div class="gantt-bar-container" style="left:'+barStart+'px;width:'+barWidth+'px"><div class="gantt-bar gantt-bar-asm'+conflictClass+overdueClass+'" data-bar-type="asm" data-bar-id="'+row.id+'" data-name="'+esc(row.name)+'" data-start="'+startStr+'" data-end="'+endStr+'" data-duration="'+duration+'" data-progress="'+row.progress+'" data-assignee="'+(row.assignee||'')+'" data-parts="'+row.partCount+'" data-conflict="'+conflictData+'" data-overdue="'+(isOverdue?'1':'')+'" style="width:100%;background:'+row.color+'">'+progressHtml+conflictIcon+'<span class="gantt-bar-label">'+label+'</span>'+resizeHandles+'</div></div>';
      }
    }

    bodyHtml+='<div class="gantt-timeline-row" style="width:'+totalWidth+'px">'+cellsHtml+barHtml+'</div>';
  });

  // Add today line
  if(todayWeekIdx>=0){
    const daysIntoWeek=Math.floor((today-weeks[todayWeekIdx].start)/dayMs);
    const todayPos=todayWeekIdx*cellWidth+(daysIntoWeek/7)*cellWidth+cellWidth/2;
    bodyHtml+='<div class="gantt-today-line" style="left:'+todayPos+'px"><div class="gantt-today-marker">Today</div></div>';
  }

  // Render milestones
  milestones.forEach(m=>{
    const mDate=new Date(m.date);
    if(mDate<rangeStart||mDate>rangeEnd)return;
    
    // Find which week the milestone is in
    let mWeekIdx=-1;
    weeks.forEach((week,i)=>{
      if(mDate>=week.start&&mDate<=week.end)mWeekIdx=i;
    });
    
    if(mWeekIdx>=0){
      const mWeek=weeks[mWeekIdx];
      const daysIntoWeek=Math.floor((mDate-mWeek.start)/dayMs);
      const mPos=mWeekIdx*cellWidth+(daysIntoWeek/7)*cellWidth+cellWidth/14;
      bodyHtml+='<div class="gantt-milestone milestone-'+m.type+'" style="left:'+mPos+'px" data-milestone-id="'+m.id+'" data-name="'+esc(m.name)+'" data-date="'+formatDateShort(mDate)+'" data-type="'+m.type+'"></div>';
    }
  });

  $('ganttTimelineBody').innerHTML=bodyHtml;
  $('ganttTimelineBody').style.width=totalWidth+'px';
  $('ganttTimelineHeader').style.width=totalWidth+'px';
  // Set inner container width to enable horizontal scroll with sticky sidebar
  $('ganttBodyInner').style.width=(420+totalWidth)+'px';

  // Scroll to today on render
  if(todayWeekIdx>=0&&!window._ganttScrolled){
    const container=$('ganttBodyWrap');
    if(container){
      // Center today in the viewport (accounting for sidebar width)
      const daysIntoWeek=Math.floor((today-weeks[todayWeekIdx].start)/dayMs);
      const todayPos=todayWeekIdx*cellWidth+(daysIntoWeek/7)*cellWidth;
      const scrollPos=Math.max(0,todayPos-container.clientWidth/2+210);
      container.scrollLeft=scrollPos;
      $('ganttTimelineHeaderWrap').scrollLeft=scrollPos;
      window._ganttScrolled=true;
    }
  }
  
  // Update conflict badge
  const badge=$('ganttConflictBadge');
  if(badge){
    if(totalConflicts>0){
      badge.innerHTML='<span class="gantt-conflict-badge" onmouseenter="this.querySelector(\'.gantt-conflict-popover\').classList.add(\'open\')" onmouseleave="this.querySelector(\'.gantt-conflict-popover\').classList.remove(\'open\')">âš ï¸ '+totalConflicts+' conflict'+(totalConflicts>1?'s':'')+
        '<div class="gantt-conflict-popover">'+conflictPopoverHtml+'</div></span>';
      badge.style.display='inline';
    }else{
      badge.style.display='none';
    }
  }
}

function getPartProgress(p){
  const stages=['waiting','to-order','ordered','arrived','installed'];
  const idx=stages.indexOf(p.status);
  if(idx<0)return 0;
  return Math.round((idx/(stages.length-1))*100);
}

window.toggleGanttAsm=(asmId,e)=>{
  e&&e.stopPropagation();
  ganttExpanded[String(asmId)]=ganttExpanded[String(asmId)]===false?true:false;
  renderGantt();
};

// Set assembly assignee
window.setAsmAssignee=(asmId,name)=>{
  const asm=data.find(d=>String(d.id)===String(asmId)&&d.isAsm);
  if(asm){
    asm.assignee=name||undefined;
    markAsmChanged(asm.id,['assignee']);
    save();
  }
};

// Populate resource filter dropdown
function updateResourceFilter(){
  const select=$('ganttResourceFilter');
  if(!select)return;
  const currentValue=ganttResourceFilter; // Use the variable, not select.value
  let html='<option value="">All Resources</option>';
  team.forEach(t=>{
    const selected=t.name===currentValue?'selected':'';
    html+='<option value="'+esc(t.name)+'" '+selected+'>'+esc(t.name)+'</option>';
  });
  select.innerHTML=html;
}

// Resource filter change handler
$('ganttResourceFilter').addEventListener('change',function(){
  ganttResourceFilter=this.value;
  renderGantt();
});

$('ganttToday').onclick=()=>{
  const container=$('ganttBodyWrap');
  const todayLine=document.querySelector('.gantt-today-line');
  if(container&&todayLine){
    const pos=parseInt(todayLine.style.left)||0;
    const scrollPos=Math.max(0,pos-container.clientWidth/2+210);
    container.scrollTo({left:scrollPos,behavior:'smooth'});
    $('ganttTimelineHeaderWrap').scrollTo({left:scrollPos,behavior:'smooth'});
  }
};

// Export Timeline as PDF
$('ganttExportPdf').onclick=async()=>{
  const btn=$('ganttExportPdf');
  const origText=btn.textContent;
  btn.textContent='Generating...';
  btn.disabled=true;
  
  try{
    // Create a container for the full timeline
    const exportDiv=document.createElement('div');
    exportDiv.style.cssText='position:absolute;left:-9999px;top:0;background:#ffffff;padding:24px;';
    document.body.appendChild(exportDiv);
    
    // Get timeline dimensions
    const header=$('ganttTimelineHeader');
    const sidebar=$('ganttSidebar');
    const body=$('ganttTimelineBody');
    const timelineWidth=parseInt(header.style.width)||1000;
    const sidebarWidth=360;
    const totalWidth=sidebarWidth+timelineWidth+40;
    
    // Build export HTML
    const title=currentProjectName||'Project Timeline';
    const dateStr=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
    
    // Remove today line from header (keep only in body)
    const headerHtml=header.innerHTML.replace(/<div class="gantt-today-line"[^>]*>.*?<\/div>/g,'');
    
    // Process sidebar to convert select elements to text
    let sidebarExport=sidebar.innerHTML;
    // Extract selected values from select elements and replace with text
    sidebarExport=sidebarExport.replace(/<select[^>]*class="gantt-resource-select"[^>]*>([\s\S]*?)<\/select>/g,(match,options)=>{
      const selectedMatch=options.match(/<option[^>]*selected[^>]*>([^<]*)<\/option>/);
      return '<span class="export-col-resource">'+(selectedMatch?selectedMatch[1]:'â€”')+'</span>';
    });
    
    exportDiv.innerHTML=`
      <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#1a1a1a;width:${totalWidth}px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #e5e5e5;">
          <div>
            <div style="font-size:22px;font-weight:600;color:#1a1a1a;">${esc(title)}</div>
            <div style="font-size:12px;color:#666;margin-top:6px;">Exported ${dateStr}</div>
          </div>
        </div>
        <div style="display:flex;">
          <div style="width:${sidebarWidth}px;flex-shrink:0;overflow:hidden;">
            <div style="display:grid;grid-template-columns:1fr 70px 50px 50px 40px;height:42px;border-bottom:2px solid #e5e5e5;font-size:11px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.5px;align-items:center;">
              <div style="padding-left:12px;">Task Name</div>
              <div style="text-align:center;">Resource</div>
              <div style="text-align:center;">Start</div>
              <div style="text-align:center;">End</div>
              <div style="text-align:center;">Days</div>
            </div>
            ${sidebarExport.replace(/gantt-sidebar-row/g,'export-row').replace(/gantt-col-name/g,'export-col-name').replace(/gantt-col-resource/g,'export-col-resource').replace(/gantt-col-start/g,'export-col-start').replace(/gantt-col-end/g,'export-col-end').replace(/gantt-col-dur/g,'export-col-dur').replace(/gantt-asm-link/g,'export-asm-link').replace(/onclick="[^"]*"/g,'').replace(/onchange="[^"]*"/g,'')}
          </div>
          <div style="flex:1;overflow:hidden;">
            <div style="display:flex;border-bottom:2px solid #e5e5e5;height:42px;align-items:center;">
              ${headerHtml.replace(/gantt-timeline-day/g,'export-day')}
            </div>
            <div style="position:relative;">
              ${body.innerHTML.replace(/gantt-timeline-row/g,'export-trow').replace(/gantt-timeline-cell/g,'export-cell').replace(/gantt-bar-container/g,'export-bar-container').replace(/gantt-bar /g,'export-bar ').replace(/gantt-bar-progress/g,'export-bar-progress').replace(/gantt-bar-label/g,'export-bar-label').replace(/gantt-today-line/g,'export-today-line').replace(/gantt-today-marker/g,'export-today-marker')}
            </div>
          </div>
        </div>
      </div>
      <style>
        *{box-sizing:border-box;}
        .export-row{display:grid;grid-template-columns:1fr 70px 50px 50px 40px;border-bottom:1px solid #eee;font-size:12px;align-items:center;height:44px;}
        .export-row>div,.export-row>span{padding:0 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .export-col-name{padding-left:12px;font-weight:500;}
        .export-col-resource{text-align:center;font-size:11px;color:#666;}
        .export-col-start,.export-col-end{text-align:center;font-size:11px;color:#666;}
        .export-col-dur{text-align:center;font-size:11px;color:#888;}
        .export-asm-link{color:#1a1a1a;text-decoration:none;font-weight:500;}
        .export-day{min-width:70px;width:70px;text-align:center;font-size:11px;color:#666;border-right:1px solid #eee;display:inline-flex;flex-direction:column;justify-content:center;background:#fafafa;height:42px;}
        .export-day.today{background:#fff3e0;}
        .export-trow{display:flex;height:44px;border-bottom:1px solid #eee;position:relative;}
        .export-cell{min-width:70px;width:70px;height:44px;border-right:1px solid #eee;display:inline-block;background:#fff;}
        .export-cell.today{background:#fff8e8;}
        .export-bar-container{position:absolute;top:0;bottom:0;display:flex;align-items:center;}
        .export-bar{height:18px;border-radius:4px;font-size:11px;font-weight:500;color:#fff;display:flex;align-items:center;padding:0 10px;position:relative;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.15);}
        .export-bar-progress{position:absolute;left:0;top:0;bottom:0;background:rgba(255,255,255,0.25);border-radius:4px 0 0 4px;}
        .export-bar-label{position:relative;z-index:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .export-today-line{position:absolute;top:0;bottom:0;width:2px;background:#cc3300;z-index:10;}
        .export-today-marker{position:absolute;top:-20px;left:-18px;background:#cc3300;color:#fff;font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px;white-space:nowrap;}
      </style>
    `;
    
    // Wait for render
    await new Promise(r=>setTimeout(r,150));
    
    // Capture with html2canvas at higher resolution
    const canvas=await html2canvas(exportDiv,{
      backgroundColor:'#ffffff',
      scale:3,
      useCORS:true,
      logging:false
    });
    
    // Create PDF
    const {jsPDF}=window.jspdf;
    const imgWidth=canvas.width;
    const imgHeight=canvas.height;
    
    // Calculate PDF dimensions (landscape, fit to width)
    const pdfWidth=Math.min(imgWidth/3,1400);
    const pdfHeight=(imgHeight/imgWidth)*pdfWidth;
    
    const pdf=new jsPDF({
      orientation:pdfWidth>pdfHeight?'landscape':'portrait',
      unit:'px',
      format:[pdfWidth+40,pdfHeight+40]
    });
    
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',20,20,pdfWidth,pdfHeight);
    
    // Download
    const filename=(currentProjectName||'timeline').replace(/[^a-z0-9]/gi,'_')+'_'+new Date().toISOString().split('T')[0]+'.pdf';
    pdf.save(filename);
    
    // Cleanup
    document.body.removeChild(exportDiv);
    toast('PDF exported');
    
  }catch(err){
    console.error('PDF export error:',err);
    toast('Export failed: '+err.message);
  }finally{
    btn.textContent=origText;
    btn.disabled=false;
  }
};

// Sync horizontal scroll between header and body
$('ganttBodyWrap').addEventListener('scroll',function(){
  $('ganttTimelineHeaderWrap').scrollLeft=this.scrollLeft;
});

// Drag to scroll with momentum
(function(){
  const container=$('ganttBodyWrap');
  if(!container)return;
  
  let isDragging=false;
  let startX=0;
  let scrollStartX=0;
  let velocity=0;
  let lastX=0;
  let lastTime=0;
  let momentumId=null;
  
  container.addEventListener('mousedown',e=>{
    // Don't start drag on interactive elements
    if(e.target.closest('.gantt-bar')||e.target.closest('.gantt-col-start')||e.target.closest('.gantt-col-end')||e.target.closest('select')||e.target.closest('.gantt-col-resource')){return;}
    isDragging=true;
    startX=e.pageX;
    scrollStartX=container.scrollLeft;
    lastX=e.pageX;
    lastTime=Date.now();
    velocity=0;
    container.classList.add('grabbing');
    if(momentumId){cancelAnimationFrame(momentumId);momentumId=null;}
    e.preventDefault();
  });
  
  document.addEventListener('mousemove',e=>{
    if(!isDragging)return;
    const x=e.pageX;
    const walk=startX-x;
    container.scrollLeft=scrollStartX+walk;
    
    // Calculate velocity
    const now=Date.now();
    const dt=now-lastTime;
    if(dt>0){
      velocity=(lastX-x)/dt;
    }
    lastX=x;
    lastTime=now;
  });
  
  document.addEventListener('mouseup',()=>{
    if(!isDragging)return;
    isDragging=false;
    container.classList.remove('grabbing');
    
    // Apply momentum
    if(Math.abs(velocity)>0.1){
      const deceleration=0.95;
      const minVelocity=0.1;
      
      function applyMomentum(){
        if(Math.abs(velocity)<minVelocity){
          momentumId=null;
          return;
        }
        container.scrollLeft+=velocity*16;
        velocity*=deceleration;
        momentumId=requestAnimationFrame(applyMomentum);
      }
      applyMomentum();
    }
  });
  
  // Cancel momentum on new interaction
  container.addEventListener('wheel',()=>{
    if(momentumId){cancelAnimationFrame(momentumId);momentumId=null;}
  });
})();

// Bar dragging to change dates
(function(){
  let dragging=null;
  let resizing=null;
  const weekWidth=70;  // pixels per week
  const dayWidth=weekWidth/7;  // pixels per day
  const dayMs=86400000;
  
  function parseDate(str){
    if(!str)return null;
    const p=str.split('-');
    return new Date(+p[0],+p[1]-1,+p[2]);
  }
  
  function fmtDate(d){
    return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  }
  
  function fmtShort(d){
    return d.getDate()+'.'+(d.getMonth()+1)+'.';
  }

  document.addEventListener('mousedown',function(e){
    const bar=e.target.closest('.gantt-bar');
    if(!bar||bar.dataset.barType!=='asm')return;
    if(!e.target.closest('#ganttTimelineBody'))return;
    
    const id=bar.dataset.barId;
    const row=document.querySelector('.gantt-sidebar-row[data-row-id="'+id+'"]');
    if(!row)return;
    
    const startEl=row.querySelector('.gantt-col-start');
    const endEl=row.querySelector('.gantt-col-end');
    if(!startEl||!endEl||!startEl.dataset.date||!endEl.dataset.date)return;
    
    const container=bar.closest('.gantt-bar-container');
    const resizeHandle=e.target.closest('.gantt-bar-resize');
    
    // Check if clicking on resize handle
    if(resizeHandle){
      const edge=resizeHandle.dataset.resize; // 'start' or 'end'
      resizing={
        bar:bar,
        container:container,
        id:id,
        edge:edge,
        startX:e.clientX,
        origLeft:parseInt(container.style.left)||0,
        origWidth:parseInt(container.style.width)||100,
        origStart:parseDate(startEl.dataset.date),
        origEnd:parseDate(endEl.dataset.date),
        startEl:startEl,
        endEl:endEl,
        lastDays:0
      };
      bar.style.opacity='0.85';
      document.body.style.cursor='ew-resize';
      document.body.style.userSelect='none';
      e.preventDefault();
      e.stopPropagation();
      return;
    }
    
    // Regular drag
    dragging={
      bar:bar,
      container:container,
      id:id,
      startX:e.clientX,
      origLeft:parseInt(container.style.left)||0,
      origStart:parseDate(startEl.dataset.date),
      origEnd:parseDate(endEl.dataset.date),
      startEl:startEl,
      endEl:endEl,
      lastDays:0
    };
    
    bar.style.opacity='0.85';
    bar.style.boxShadow='0 4px 16px rgba(0,0,0,0.3)';
    document.body.style.cursor='grabbing';
    document.body.style.userSelect='none';
    e.preventDefault();
    e.stopPropagation();
  },true);
  
  document.addEventListener('mousemove',function(e){
    // Handle resize
    if(resizing){
      const dx=e.clientX-resizing.startX;
      const days=Math.round(dx/dayWidth);
      
      if(resizing.edge==='end'){
        // Resize end: change width
        const newWidth=Math.max(dayWidth*2,resizing.origWidth+days*dayWidth);
        resizing.container.style.width=newWidth+'px';
        resizing.bar.style.width='100%';
        
        if(days!==resizing.lastDays){
          resizing.lastDays=days;
          const newEnd=new Date(resizing.origEnd.getTime()+days*dayMs);
          resizing.endEl.textContent=fmtShort(newEnd);
        }
      }else{
        // Resize start: change left and width
        const newLeft=resizing.origLeft+days*dayWidth;
        const newWidth=Math.max(dayWidth*2,resizing.origWidth-days*dayWidth);
        resizing.container.style.left=newLeft+'px';
        resizing.container.style.width=newWidth+'px';
        resizing.bar.style.width='100%';
        
        if(days!==resizing.lastDays){
          resizing.lastDays=days;
          const newStart=new Date(resizing.origStart.getTime()+days*dayMs);
          resizing.startEl.textContent=fmtShort(newStart);
        }
      }
      return;
    }
    
    // Handle drag
    if(!dragging)return;
    
    const dx=e.clientX-dragging.startX;
    const days=Math.round(dx/dayWidth);
    
    // Move bar visually
    dragging.container.style.left=(dragging.origLeft+days*dayWidth)+'px';
    
    // Update sidebar dates if days changed
    if(days!==dragging.lastDays){
      dragging.lastDays=days;
      const newStart=new Date(dragging.origStart.getTime()+days*dayMs);
      const newEnd=new Date(dragging.origEnd.getTime()+days*dayMs);
      dragging.startEl.textContent=fmtShort(newStart);
      dragging.endEl.textContent=fmtShort(newEnd);
    }
  });
  
  document.addEventListener('mouseup',function(e){
    // Handle resize complete
    if(resizing){
      const dx=e.clientX-resizing.startX;
      const days=Math.round(dx/dayWidth);
      
      resizing.bar.style.opacity='';
      document.body.style.cursor='';
      document.body.style.userSelect='';
      
      if(days!==0){
        const asm=data.find(d=>String(d.id)===String(resizing.id)&&d.isAsm);
        if(asm){
          if(resizing.edge==='end'){
            const newEnd=new Date(resizing.origEnd.getTime()+days*dayMs);
            asm.ganttEnd=fmtDate(newEnd);
          }else{
            const newStart=new Date(resizing.origStart.getTime()+days*dayMs);
            asm.ganttStart=fmtDate(newStart);
          }
          markAsmChanged(asm.id,['ganttStart','ganttEnd']);
          save();
        }
        renderGantt();
        window._ganttJustDragged=true;
        setTimeout(()=>window._ganttJustDragged=false,100);
      }
      
      resizing=null;
      return;
    }
    
    // Handle drag complete
    if(!dragging)return;
    
    const dx=e.clientX-dragging.startX;
    const days=Math.round(dx/dayWidth);
    
    // Reset visual
    dragging.bar.style.opacity='';
    dragging.bar.style.boxShadow='';
    document.body.style.cursor='';
    document.body.style.userSelect='';
    
    // Save if moved
    if(days!==0){
      const newStart=new Date(dragging.origStart.getTime()+days*dayMs);
      const newEnd=new Date(dragging.origEnd.getTime()+days*dayMs);
      
      const asm=data.find(d=>String(d.id)===String(dragging.id)&&d.isAsm);
      if(asm){
        asm.ganttStart=fmtDate(newStart);
        asm.ganttEnd=fmtDate(newEnd);
        markAsmChanged(asm.id,['ganttStart','ganttEnd']);
        save();
      }
      renderGantt();
      window._ganttJustDragged=true;
      setTimeout(()=>window._ganttJustDragged=false,100);
    }
    
    dragging=null;
  });
})();

// Hover tooltip for bars and milestones
(function(){
  const tooltip=$('ganttTooltip');
  const tooltipTitle=$('ganttTooltipTitle');
  const tooltipBody=$('ganttTooltipBody');
  let hideTimeout=null;
  let showTimeout=null;
  
  function showTooltip(x,y,title,bodyHtml){
    tooltipTitle.textContent=title;
    tooltipBody.innerHTML=bodyHtml;
    
    // Position tooltip
    tooltip.style.left=x+'px';
    tooltip.style.top=y+'px';
    tooltip.classList.add('visible');
    
    // Adjust if off screen
    const rect=tooltip.getBoundingClientRect();
    if(rect.right>window.innerWidth-10){
      tooltip.style.left=(x-rect.width-10)+'px';
    }
    if(rect.bottom>window.innerHeight-10){
      tooltip.style.top=(y-rect.height-10)+'px';
    }
  }
  
  function hideTooltip(){
    tooltip.classList.remove('visible');
  }
  
  function scheduleTooltip(x,y,title,bodyHtml){
    clearTimeout(showTimeout);
    showTimeout=setTimeout(()=>showTooltip(x,y,title,bodyHtml),1000);
  }
  
  // Bar hover
  document.addEventListener('mouseover',function(e){
    const bar=e.target.closest('.gantt-bar[data-bar-type="asm"]');
    if(bar){
      clearTimeout(hideTimeout);
      clearTimeout(showTimeout);
      
      const name=bar.dataset.name||'';
      const start=bar.dataset.start||'';
      const end=bar.dataset.end||'';
      const duration=bar.dataset.duration||'';
      const progress=bar.dataset.progress||'0';
      const assignee=bar.dataset.assignee||'Unassigned';
      const parts=bar.dataset.parts||'0';
      const conflict=bar.dataset.conflict||'';
      const overdue=bar.dataset.overdue==='1';
      
      let bodyHtml='<div class="gantt-tooltip-row"><span>Dates:</span><span>'+start+' â†’ '+end+'</span></div>';
      bodyHtml+='<div class="gantt-tooltip-row"><span>Duration:</span><span>'+duration+' days</span></div>';
      bodyHtml+='<div class="gantt-tooltip-row"><span>Progress:</span><span>'+progress+'%</span></div>';
      bodyHtml+='<div class="gantt-tooltip-row"><span>Assignee:</span><span>'+assignee+'</span></div>';
      bodyHtml+='<div class="gantt-tooltip-row"><span>Parts:</span><span>'+parts+'</span></div>';
      
      if(overdue){
        bodyHtml+='<div class="gantt-tooltip-overdue">âš ï¸ Overdue - past end date</div>';
      }
      
      if(conflict){
        const conflicts=conflict.split(';;').map(c=>{
          const parts=c.split('|');
          return '<div>â€¢ '+parts[0]+' ('+parts[1]+')</div>';
        }).join('');
        bodyHtml+='<div class="gantt-tooltip-conflict">âš ï¸ Resource conflict:<br>'+conflicts+'</div>';
      }
      
      const rect=bar.getBoundingClientRect();
      scheduleTooltip(rect.right+10,rect.top,name,bodyHtml);
      return;
    }
    
    // Milestone hover
    const milestone=e.target.closest('.gantt-milestone');
    if(milestone){
      clearTimeout(hideTimeout);
      clearTimeout(showTimeout);
      
      const name=milestone.dataset.name||'';
      const date=milestone.dataset.date||'';
      const type=milestone.dataset.type||'';
      const typeLabels={deadline:'ðŸ”´ Deadline',delivery:'ðŸŸ¢ Delivery',review:'ðŸŸ  Review',custom:'ðŸŸ£ Custom'};
      
      const bodyHtml='<div class="gantt-tooltip-row"><span>Date:</span><span>'+date+'</span></div><div class="gantt-tooltip-row"><span>Type:</span><span>'+(typeLabels[type]||type)+'</span></div>';
      
      const rect=milestone.getBoundingClientRect();
      scheduleTooltip(rect.right+10,rect.top-20,name,bodyHtml);
      return;
    }
  });
  
  document.addEventListener('mouseout',function(e){
    const bar=e.target.closest('.gantt-bar[data-bar-type="asm"]');
    const milestone=e.target.closest('.gantt-milestone');
    if(bar||milestone){
      clearTimeout(showTimeout);
      hideTimeout=setTimeout(hideTooltip,100);
    }
  });
})();

// Color picker for bars
const ganttColors=['#ff6b6b','#ffa94d','#ffd43b','#69db7c','#38d9a9','#4dabf7','#748ffc','#da77f2','#f783ac','#868e96'];

function renderGanttColorGrid(){
  $('ganttColorGrid').innerHTML=ganttColors.map(c=>'<div class="gantt-color-swatch" data-color="'+c+'" style="background:'+c+'"></div>').join('');
}
renderGanttColorGrid();

let colorPickerTarget=null;

document.addEventListener('click',e=>{
  const bar=e.target.closest('.gantt-bar');
  const popup=$('ganttColorPopup');
  
  // Close popup if clicking outside
  if(!bar&&!popup.contains(e.target)){
    popup.classList.remove('open');
    colorPickerTarget=null;
    return;
  }
  
  // Don't open color picker if we just finished dragging
  if(window._ganttJustDragged)return;
  
  // Open popup for bar click
  if(bar&&!e.target.closest('.gantt-color-popup')){
    const barType=bar.dataset.barType;
    const barId=bar.dataset.barId;
    if(!barType||!barId)return;
    
    colorPickerTarget={type:barType,id:barId};
    const rect=bar.getBoundingClientRect();
    const panelRect=$('ganttPanel').getBoundingClientRect();
    
    popup.style.left=(rect.left-panelRect.left+rect.width/2-80)+'px';
    popup.style.top=(rect.bottom-panelRect.top+8)+'px';
    popup.classList.add('open');
    
    // Highlight current color
    const currentColor=ganttBarColors[barType+'-'+barId];
    document.querySelectorAll('.gantt-color-swatch').forEach(s=>{
      s.classList.toggle('selected',s.dataset.color===currentColor);
    });
  }
});

$('ganttColorGrid').addEventListener('click',e=>{
  const swatch=e.target.closest('.gantt-color-swatch');
  if(!swatch||!colorPickerTarget)return;
  
  const color=swatch.dataset.color;
  const key=colorPickerTarget.type+'-'+colorPickerTarget.id;
  ganttBarColors[key]=color;
  
  // Update the bar immediately
  const bar=document.querySelector('.gantt-bar[data-bar-type="'+colorPickerTarget.type+'"][data-bar-id="'+colorPickerTarget.id+'"]');
  if(bar)bar.style.background=color;
  
  $('ganttColorPopup').classList.remove('open');
  colorPickerTarget=null;
  
  // Save colors
  try{localStorage.setItem('ganttBarColors',JSON.stringify(ganttBarColors))}catch(e){}
});

// Load saved colors
try{
  const saved=localStorage.getItem('ganttBarColors');
  if(saved)ganttBarColors=JSON.parse(saved);
}catch(e){}

// Date picker popup for gantt row dates
let datePickerTarget=null;

$('ganttSidebar').addEventListener('click',e=>{
  // Don't interfere with select dropdowns
  if(e.target.closest('select'))return;
  
  const dateCell=e.target.closest('.gantt-col-start, .gantt-col-end');
  if(!dateCell)return;
  
  const row=dateCell.closest('.gantt-sidebar-row');
  if(!row)return;
  
  const rowType=row.dataset.rowType;
  const rowId=row.dataset.rowId;
  const field=dateCell.dataset.field;
  const currentDate=dateCell.dataset.date||'';
  
  datePickerTarget={type:rowType,id:rowId,field};
  
  $('ganttDatePopupTitle').textContent=field==='start'?'Start Date':'End Date';
  $('ganttDatePopupInput').value=currentDate;
  
  const popup=$('ganttDatePopup');
  const rect=dateCell.getBoundingClientRect();
  const panelRect=$('ganttPanel').getBoundingClientRect();
  
  popup.style.left=(rect.left-panelRect.left)+'px';
  popup.style.top=(rect.bottom-panelRect.top+4)+'px';
  popup.classList.add('open');
  
  setTimeout(()=>$('ganttDatePopupInput').focus(),50);
});

$('ganttDatePopupSave').onclick=()=>{
  if(!datePickerTarget)return;
  const newDate=$('ganttDatePopupInput').value;
  
  if(datePickerTarget.type==='part'){
    const part=data.find(d=>String(d.id)===String(datePickerTarget.id));
    if(part){
      if(datePickerTarget.field==='start'){
        part.orderedAt=newDate?new Date(newDate).getTime():undefined;
      }else{
        part.expectedArrival=newDate||undefined;
      }
      markPartChanged(part.id,['orderedAt','expectedArrival']);
      save();
      renderGantt();
    }
  }else if(datePickerTarget.type==='asm'){
    const asm=data.find(d=>String(d.id)===String(datePickerTarget.id)&&d.isAsm);
    if(asm){
      if(datePickerTarget.field==='start'){
        asm.ganttStart=newDate||undefined;
      }else{
        asm.ganttEnd=newDate||undefined;
      }
      markAsmChanged(asm.id,['ganttStart','ganttEnd']);
      save();
      renderGantt();
      toast('Assembly date updated');
    }
  }
  
  $('ganttDatePopup').classList.remove('open');
  datePickerTarget=null;
};

$('ganttDatePopupClear').onclick=()=>{
  if(!datePickerTarget)return;
  
  if(datePickerTarget.type==='part'){
    const part=data.find(d=>String(d.id)===String(datePickerTarget.id));
    if(part){
      if(datePickerTarget.field==='start'){
        part.orderedAt=undefined;
      }else{
        part.expectedArrival=undefined;
      }
      markPartChanged(part.id,['orderedAt','expectedArrival']);
      save();
      renderGantt();
    }
  }else if(datePickerTarget.type==='asm'){
    const asm=data.find(d=>String(d.id)===String(datePickerTarget.id)&&d.isAsm);
    if(asm){
      if(datePickerTarget.field==='start'){
        asm.ganttStart=undefined;
      }else{
        asm.ganttEnd=undefined;
      }
      markAsmChanged(asm.id,['ganttStart','ganttEnd']);
      save();
      renderGantt();
      toast('Assembly date cleared');
    }
  }
  
  $('ganttDatePopup').classList.remove('open');
  datePickerTarget=null;
};

// Close date popup when clicking outside
document.addEventListener('click',e=>{
  const popup=$('ganttDatePopup');
  if(popup.classList.contains('open')&&!popup.contains(e.target)&&!e.target.closest('.gantt-col-start')&&!e.target.closest('.gantt-col-end')){
    popup.classList.remove('open');
    datePickerTarget=null;
  }
});

function generateAIInsights(){
  const insights=[],parts=getParts();
  const today=new Date().toISOString().split('T')[0];
  const now=Date.now(),day=86400000;
  const pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast();
  // Action plan removed - overdue actions check removed
  if(forecast&&forecast.status==='at-risk'){insights.push({level:'critical',icon:'ðŸ“‰',title:'Completion at risk',desc:'At current rate, finishing '+(forecast.daysToComplete-forecast.daysLeft)+' days late',action:'Review metrics â†’',handler:()=>{window.toggleMetricsPopover({stopPropagation:()=>{}});minimizeCmdWindow()}})}
  if(expected!==null&&pct<expected-10){insights.push({level:'critical',icon:'ðŸ“Š',title:'Behind schedule',desc:(expected-pct)+'% behind target progress',action:'Review metrics â†’',handler:()=>{window.toggleMetricsPopover({stopPropagation:()=>{}});minimizeCmdWindow()}})}
  const stuckParts=parts.filter(p=>p.status==='to-order'&&p.changedAt&&(now-p.changedAt)>5*day);
  if(stuckParts.length>0){insights.push({level:'warning',icon:'â³',title:stuckParts.length+' part'+(stuckParts.length>1?'s':'')+' ready to order >5 days',desc:stuckParts.map(p=>p.name).slice(0,2).join(', '),action:'View parts â†’',handler:()=>{filterStage='to-order';render();minimizeCmdWindow()}})}
  const longTransit=parts.filter(p=>p.status==='ordered'&&p.changedAt&&(now-p.changedAt)>7*day);
  if(longTransit.length>0){insights.push({level:'warning',icon:'ðŸ“¦',title:longTransit.length+' part'+(longTransit.length>1?'s':'')+' in transit >7d',desc:'Follow up with suppliers',action:'View parts â†’',handler:()=>{filterStage='ordered';render();minimizeCmdWindow()}})}
  const missingEta=parts.filter(p=>(p.status==='to-order'||p.status==='ordered')&&getPartETA(p).type==='unknown');
  if(missingEta.length>0){insights.push({level:'warning',icon:'â“',title:missingEta.length+' part'+(missingEta.length>1?'s':'')+' missing ETA',desc:'Add lead time data for planning',action:'Set ETA â†’',handler:()=>{if(missingEta[0])window.openEtaModal(missingEta[0].id);minimizeCmdWindow()}})}
  const otd=calcSupplierOTD();
  if(otd!==null&&otd<80){insights.push({level:'warning',icon:'ðŸšš',title:'Supplier OTD: '+otd+'%',desc:'Consider adding buffer to estimates',action:'View lead times â†’',handler:()=>{renderLeadTimeModal();$('leadtimeModal').classList.add('open');minimizeCmdWindow()}})}
  if(forecast&&forecast.status==='ahead'){insights.push({level:'success',icon:'ðŸŽ¯',title:'Ahead of schedule',desc:'Finishing '+(forecast.daysLeft-forecast.daysToComplete)+' days early',action:null,handler:null})}
  const readyToInstall=parts.filter(p=>p.status==='arrived');
  if(readyToInstall.length>0){insights.push({level:'info',icon:'âœ“',title:readyToInstall.length+' ready to install',desc:readyToInstall.map(p=>p.name).slice(0,3).join(', '),action:'Install now â†’',handler:()=>{filterStage='arrived';render();minimizeCmdWindow()}})}
  if(insights.length===0){insights.push({level:'success',icon:'âœ“',title:'All systems nominal',desc:'No issues detected',action:null,handler:null})}
  return insights;
}

function updateAIAlert(){
  // Just generate insights for caching
  window._aiInsights=generateAIInsights();
}

// ============================================
// Event Logging for AI Learning
// ============================================
const eventLogRef=db.ref('analytics/events');

function logEvent(type,eventData){
  const event={
    timestamp:Date.now(),
    type,
    projectName:currentProjectName,
    ...eventData
  };
  eventLogRef.push(event).catch(e=>console.warn('Event log failed:',e));
}

function logArrival(part,daysInTransit,wasLate,daysDelta){
  logEvent('arrival',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    daysInTransit,
    expectedArrival:part.expectedArrival||null,
    wasLate,
    daysDelta,
    assemblyId:part.parentId,
    assemblyName:getAsms().find(a=>String(a.id)===String(part.parentId))?.name||''
  });
}

function logStuck(part,stage,daysStuck){
  logEvent('stuck',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    stage,
    daysStuck,
    assemblyId:part.parentId
  });
}

function logEtaMiss(part,expectedDate,actualDate,daysDelta){
  logEvent('eta_miss',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    expectedDate,
    actualDate,
    daysDelta
  });
}

function logComment(part,text){
  logEvent('comment',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    assemblyId:part.parentId,
    text:text.slice(0,500),
    partStatus:part.status
  });
}

function logActionOverdue(action,daysOverdue){
  logEvent('action_overdue',{
    actionId:action.id,
    task:action.task,
    assignee:action.assignee||'',
    daysOverdue,
    linkedPartId:action.linkedPartId||null
  });
}

// ============================================
// AI Report Generation (LLM-Powered)
// ============================================
let currentAIMode='quick';
let aiCache={quick:null,standup:null,risks:null};
let aiCacheTime={quick:0,standup:0,risks:0};
const AI_CACHE_TTL=60000; // 1 minute cache
let aiConversation=[];

function detectQuestionType(question){
  if(!question)return 'general';
  const q=question.toLowerCase();
  
  // LOOKUP: specific part/code/PO searches (highest priority)
  if(/code|item\s*#|part\s*#|sku|pn\s|p\/n|find|search|look\s*up|where\s*is|status\s*of|po\s*\d|po-\d/.test(q))return 'lookup';
  
  // Velocity/speed related
  if(/velocit|speed|pace|accelerat|slow|fast|rate|throughput|transition/.test(q))return 'velocity';
  
  // Bottleneck/stuck related
  if(/bottleneck|stuck|block|wait|delay|held up|holding/.test(q))return 'bottleneck';
  
  // Lead time/supplier related
  if(/lead\s*time|supplier|vendor|delivery|ship|transit|eta|arrival|on-?time/.test(q))return 'leadtime';
  
  // Workload/team related
  if(/workload|team|assign|who|balance|capacity|resource/.test(q))return 'workload';
  
  // Progress/forecast related
  if(/progress|forecast|complete|finish|deadline|schedule|behind|ahead|risk|estimat/.test(q))return 'forecast';
  
  // Action/task related
  if(/action|task|todo|overdue|due|upcoming/.test(q))return 'actions';
  
  // Specific part/assembly query
  if(/which part|what part|show.*part|list.*part/.test(q))return 'parts';
  
  return 'general';
}

function buildProjectContext(question){
  const parts=getParts();
  const asms=getAsms();
  const now=Date.now(),day=86400000;
  const today=new Date().toISOString().split('T')[0];
  const questionType=detectQuestionType(question);
  
  // Helper: convert timestamp to relative days (negative = past, positive = future)
  const relDays=(ts)=>ts?Math.round((ts-now)/day):null;
  const relDate=(dateStr)=>dateStr?Math.round((Date.parse(dateStr)-now)/day):null;
  
  // Status counts
  const byStatus={};
  STAGES.forEach(s=>byStatus[s]=parts.filter(p=>p.status===s).length);
  
  const totalParts=parts.length;
  const installedParts=byStatus.installed||0;
  const velocity=getVelocity();
  const daysLeft=getDaysRemaining();
  
  // Base context - CRITICAL DATA FIRST (in case of truncation)
  const context={
    // Plain English summary FIRST - most important for AI
    summary:`Project "${currentProjectName}" has ${totalParts} parts across ${asms.length} assemblies. Status: ${byStatus.waiting||0} waiting, ${byStatus['to-order']||0} to-order, ${byStatus.ordered||0} ordered, ${byStatus.arrived||0} arrived, ${byStatus.installed||0} installed. Progress: ${calcOverallProgress()}%.`,
    // Project info
    project:{
      name:currentProjectName,
      pct:calcOverallProgress(),
      vel:velocity,
      left:daysLeft,
      start:projectDates.start,
      end:projectDates.end
    },
    // Counts by status
    cnt:{total:totalParts,...byStatus},
    qType:questionType,
    today,
    // Schema for short keys (after critical data)
    _schema:{
      parts:'id,n=name,s=status,asm=assembly,a=assignee,c=code,m=mfr,po,q=qty,days=daysInStatus,ord=orderedDaysAgo,arr=arrivedDaysAgo,eta=expectedDays,nt=notes,pn=pendingNote,cm=comments',
      asms:'id,n=name,pct=progress%,cnt=partCount,a=assignee,pri=priority',
      actions:'id,t=task,st=status,a=assignee,due=dueDays,part=linkedPart',
      timelineConflicts:'person=assignee,asm1=firstAssembly,asm1Dates,asm2=secondAssembly,asm2Dates (overlapping date ranges for same person)',
      milestones:'name,date,type(deadline/delivery/review/custom),daysAway'
    },
    // Company context LAST (nice to have, not critical)
    company:{
      name:'Radar Systems Manufacturing',
      location:'Finland',
      customer:'UK sister company',
      rules:['Safety components need full testing','Parts >â‚¬5k need dual approval','RF parts need cal certs','International +7-10d customs'],
      leadTimes:{stock:'3-7d',standard:'10-14d',custom:'3-4wk',rfSpecialized:'4-6wk'}
    }
  };
  
  // TEAM - always include (small, useful for "who" questions)
  if(team.length){
    context.team=team.map(t=>({n:t.name,e:t.email}));
  }
  
  // LEAD TIME DB - historical data per item code
  if(Object.keys(leadTimeDb).length){
    context.leadTimes={};
    Object.entries(leadTimeDb).forEach(([code,lt])=>{
      context.leadTimes[code]={avg:lt.avg,samples:lt.samples.length};
    });
  }
  
  // HISTORY - include action descriptions (all entries, no nulls)
  if(history.length){
    context.hist=history.map(h=>{
      const entry={d:h.date,p:h.pct};
      if(h.action)entry.a=h.action;
      return entry;
    });
  }
  
  // ALL PARTS - optimized, no nulls, short keys
  // Key: id mod:name s:status asm:assembly a:assignee c:code m:mfr po:poNumber q:qty(if>1)
  //      days:daysInStatus(if>0) ord:orderedAt(rel) arr:arrivedAt(rel) eta:expectedArrival(rel)
  //      n:notes pn:pendingNote cmt:commentCount cm:comments
  context.parts=parts.map(p=>{
    const asm=asms.find(a=>String(a.id)===String(p.parentId));
    const part={id:p.id,n:p.name,s:p.status};
    
    // Only include non-empty, non-default values
    if(asm?.name)part.asm=asm.name;
    if(p.assignee)part.a=p.assignee;
    if(p.code)part.c=p.code;
    if(p.mfr)part.m=p.mfr;
    if(p.poNumber)part.po=p.poNumber;
    if(p.qty&&p.qty>1)part.q=p.qty;
    
    const days=p.changedAt?Math.floor((now-p.changedAt)/day):0;
    if(days>0)part.days=days;
    
    // Relative dates (negative=past, positive=future)
    if(p.orderedAt)part.ord=relDays(p.orderedAt);
    if(p.arrivedAt)part.arr=relDays(p.arrivedAt);
    if(p.expectedArrival)part.eta=relDate(p.expectedArrival);
    
    if(p.notes)part.nt=p.notes;
    if(p.pendingNote)part.pn=p.pendingNote;
    
    // Comments - all of them, not just last 3
    if(p.comments?.length){
      part.cmt=p.comments.length;
      part.cm=p.comments.map(c=>({
        by:c.author||'?',
        t:c.text,
        ago:c.timestamp?Math.floor((now-c.timestamp)/day):null
      }));
    }
    return part;
  });
  
  // ASSEMBLIES - with notes and priority
  context.asms=asms.map(a=>{
    const asmParts=parts.filter(p=>String(p.parentId)===String(a.id));
    const obj={id:a.id,n:a.name,pct:calcAsmProgress(a.id),cnt:asmParts.length};
    if(a.assignee)obj.a=a.assignee;
    if(a.priority)obj.pri=a.priority;
    if(a.notes)obj.nt=a.notes;
    return obj;
  });
  
  // ACTIONS - all of them, with linked parts
  const allActions=getActions();
  if(allActions.length){
    context.actions=allActions.map(act=>{
      const obj={id:act.id,t:act.task,st:act.status};
      if(act.assignee)obj.a=act.assignee;
      if(act.due)obj.due=relDate(act.due);
      if(act.linkedPartId){
        const lp=parts.find(p=>String(p.id)===String(act.linkedPartId));
        if(lp)obj.part=lp.name;
      }
      if(act.createdAt)obj.created=relDate(act.createdAt);
      return obj;
    });
  }
  
  // VELOCITY STATS (for velocity/general questions)
  if(questionType==='velocity'||questionType==='general'){
    const recentTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)<14*day);
    const weekAgoCount=recentTransitions.filter(p=>(now-p.changedAt)<=7*day).length;
    const priorWeekCount=recentTransitions.filter(p=>{const d=(now-p.changedAt)/day;return d>7&&d<=14}).length;
    context.vel={
      now:velocity,
      thisWk:weekAgoCount,
      lastWk:priorWeekCount,
      trend:priorWeekCount>0?Math.round((weekAgoCount-priorWeekCount)/priorWeekCount*100):0
    };
  }
  
  // BOTTLENECK STATS (for bottleneck/general questions)
  if(questionType==='bottleneck'||questionType==='general'){
    const stageDwell={};
    STAGES.forEach(s=>{
      const inStage=parts.filter(p=>p.status===s&&p.changedAt);
      if(inStage.length>0){
        const avgDays=Math.round(inStage.reduce((sum,p)=>sum+(now-p.changedAt),0)/inStage.length/day);
        const maxDays=Math.round(Math.max(...inStage.map(p=>(now-p.changedAt)/day)));
        stageDwell[s]={cnt:inStage.length,avg:avgDays,max:maxDays};
      }
    });
    context.dwell=stageDwell;
  }
  
  // LEAD TIME STATS (for leadtime/general questions)
  if(questionType==='leadtime'||questionType==='general'){
    const arrivedWithDates=parts.filter(p=>p.orderedAt&&p.arrivedAt);
    if(arrivedWithDates.length>=2){
      const leadTimes=arrivedWithDates.map(p=>Math.round((p.arrivedAt-p.orderedAt)/day));
      const avgLead=Math.round(leadTimes.reduce((a,b)=>a+b,0)/leadTimes.length);
      
      const mfrPerf={};
      parts.filter(p=>p.mfr).forEach(p=>{
        if(!mfrPerf[p.mfr])mfrPerf[p.mfr]={tot:0,transit:0,leads:[]};
        mfrPerf[p.mfr].tot++;
        if(p.status==='ordered')mfrPerf[p.mfr].transit++;
        if(p.orderedAt&&p.arrivedAt)mfrPerf[p.mfr].leads.push(Math.round((p.arrivedAt-p.orderedAt)/day));
      });
      
      context.lead={
        avg:avgLead,
        byMfr:Object.entries(mfrPerf).map(([m,d])=>({
          m,tot:d.tot,transit:d.transit,
          avg:d.leads.length?Math.round(d.leads.reduce((a,b)=>a+b,0)/d.leads.length):null
        }))
      };
    }
  }
  
  // WORKLOAD STATS (for workload/general questions)  
  if(questionType==='workload'||questionType==='general'){
    const assigneeWork={};
    parts.filter(p=>p.status!=='installed').forEach(p=>{
      const assignee=p.assignee||'Unassigned';
      if(!assigneeWork[assignee])assigneeWork[assignee]={tot:0,by:{}};
      assigneeWork[assignee].tot++;
      assigneeWork[assignee].by[p.status]=(assigneeWork[assignee].by[p.status]||0)+1;
    });
    context.work=Object.entries(assigneeWork)
      .map(([n,d])=>({n,tot:d.tot,by:d.by}))
      .sort((a,b)=>b.tot-a.tot);
  }
  
  // FORECAST STATS (for forecast/general questions)
  if(questionType==='forecast'||questionType==='general'){
    context.forecast=getVelocityForecast();
  }
  
  // TIMELINE CONFLICTS - resource scheduling conflicts
  const timelineConflicts=[];
  const asmWithDates=asms.filter(a=>a.ganttStart||a.ganttEnd).map(a=>{
    const asmParts=parts.filter(p=>String(p.parentId)===String(a.id));
    let startDate=a.ganttStart?new Date(a.ganttStart):null;
    let endDate=a.ganttEnd?new Date(a.ganttEnd):null;
    if(!startDate||!endDate){
      const orderedDates=asmParts.filter(p=>p.orderedAt).map(p=>p.orderedAt);
      const arrivedDates=asmParts.filter(p=>p.arrivedAt).map(p=>p.arrivedAt);
      if(!startDate&&orderedDates.length)startDate=new Date(Math.min(...orderedDates));
      if(!endDate&&arrivedDates.length)endDate=new Date(Math.max(...arrivedDates));
    }
    return {id:a.id,name:a.name,assignee:a.assignee,startDate,endDate};
  }).filter(a=>a.assignee&&a.startDate&&a.endDate);
  
  for(let i=0;i<asmWithDates.length;i++){
    const a=asmWithDates[i];
    for(let j=i+1;j<asmWithDates.length;j++){
      const b=asmWithDates[j];
      if(a.assignee!==b.assignee)continue;
      if(a.startDate<=b.endDate&&a.endDate>=b.startDate){
        timelineConflicts.push({
          person:a.assignee,
          asm1:a.name,
          asm1Dates:formatDateShort(a.startDate)+' - '+formatDateShort(a.endDate),
          asm2:b.name,
          asm2Dates:formatDateShort(b.startDate)+' - '+formatDateShort(b.endDate)
        });
      }
    }
  }
  if(timelineConflicts.length){
    context.timelineConflicts=timelineConflicts;
    context.summary+=` TIMELINE CONFLICTS: ${timelineConflicts.length} resource scheduling conflict(s) detected.`;
  }
  
  // MILESTONES - project milestones
  if(milestones.length){
    context.milestones=milestones.map(m=>({
      name:m.name,
      date:m.date,
      type:m.type,
      daysAway:Math.round((new Date(m.date)-new Date())/(86400000))
    }));
  }
  
  return context;
}

function getDaysRemaining(){
  if(!projectDates.end)return null;
  const end=new Date(projectDates.end);
  const now=new Date();
  return Math.max(0,Math.ceil((end-now)/(86400000)));
}

function getVelocity(){
  if(history.length<2)return null;
  const recent=history.slice(-7);
  if(recent.length<2)return null;
  const days=Math.max(1,(new Date(recent[recent.length-1].date)-new Date(recent[0].date))/(86400000));
  const progress=recent[recent.length-1].pct-recent[0].pct;
  const partsPerDay=(progress/100)*getParts().length/days;
  return Math.round(partsPerDay*10)/10;
}

async function generateAIReport(mode,question){
  // Use the SAME context builder as the working Opus report
  const context=buildFullProjectContext();
  if(question) context.question=question;
  
  // Quick mode uses local generation (instant, no API call)
  if(mode==='quick'){
    return generateLocalReport(mode,context);
  }
  
  // AI modes use Claude via Cloud Function
  try{
    console.log('Calling Cloud Function for mode:',mode);
    if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML='<span class="thinking-pulse">thinking...</span>';
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const payload={
      mode,
      projectContext:context,
      maxChars:1000,
      style:'concise',
      model:selectedAIModel
    };
    if(question)payload.question=question;
    
    const result=await generateInsights(payload);
    
    // Log model verification
    const requestedModel=selectedAIModel;
    const returnedModel=result.data?.model||'unknown';
    console.log('ðŸ¤– AI Model Verification:');
    console.log('   Requested:', requestedModel);
    console.log('   Returned:', returnedModel);
    console.log('   Match:', requestedModel===returnedModel ? 'âœ… YES' : 'âŒ NO');
    
    if(result.data?.success){
      // Use the RETURNED model from API, not the requested one
      const actualModel=result.data.model||selectedAIModel;
      const modelName=AI_MODELS[actualModel]?.name||actualModel;
      if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML=modelName+' <span style="opacity:0.5">â–¾</span>';
      lastUsedModel=actualModel;
      return formatClaudeResponse(result.data.content,mode,actualModel);
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Cloud function failed:',e);
    if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML='offline <span style="opacity:0.5">â–¾</span>';
    return '<div class="ai-prose"><p>Unable to connect to AI service. Please try again.</p></div>';
  }
}

function formatClaudeResponse(text,mode,usedModel){
  let html=text;
  
  // Check for SVG response - sanitize with DOMPurify
  if(html.trim().startsWith('<svg')){
    if(typeof DOMPurify !== 'undefined') {
      const sanitized = DOMPurify.sanitize(html, {
        USE_PROFILES: { svg: true },
        ADD_TAGS: ['svg'],
        ADD_ATTR: ['viewBox', 'preserveAspectRatio', 'xmlns']
      });
      return '<div class="ai-visual">'+sanitized+'</div>';
    } else {
      // Fallback: strip dangerous content with regex (less secure)
      const sanitized = html
        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
        .replace(/\s*on\w+\s*=\s*["'][^"']*["']/gi, '')
        .replace(/javascript:/gi, '');
      return '<div class="ai-visual">'+sanitized+'</div>';
    }
  }
  
  // Check for structured action response [ACTION:type:param]
  // Validate stage is a known status to prevent injection
  const validStages = ['waiting','ordered','arrived','installed'];
  html=html.replace(/\[ACTION:filter:([^\]]+)\]/g,(match,stage)=>{
    const cleanStage = stage.trim().toLowerCase();
    if(!validStages.includes(cleanStage)) return match; // Don't render invalid stages
    return '<button class="ai-action-btn" onclick="window.aiFilterStage(\''+cleanStage+'\')"><span>Show '+cleanStage.replace('-',' ')+' parts</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>';
  });
  
  // Validate IDs are numeric/alphanumeric only (Firebase push keys are alphanumeric with -)
  html=html.replace(/\[ACTION:highlight:([^\]]+)\]/g,(match,ids)=>{
    const cleanIds = ids.replace(/[^a-zA-Z0-9,\-_]/g, ''); // Strip anything suspicious
    if(!cleanIds) return match;
    return '<button class="ai-action-btn" onclick="window.highlightParts(['+cleanIds.split(',').map(id=>'\''+id.trim()+'\'').join(',')+'])"><span>Highlight these parts</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>';
  });
  
  // Check for mini chart markers [CHART:type:data]
  html=html.replace(/\[CHART:bar:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)||0};
      });
      if(!items.length||items.every(i=>!i.val))return '';
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*40+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 340 '+h+'" style="width:340px;height:'+h+'px;display:block;margin:8px 0">';
      items.forEach((item,i)=>{
        const w=Math.max(Math.round(item.val/max*180),4);
        const y=i*40+10;
        svg+='<text x="8" y="'+(y+24)+'" style="font-size:13px;fill:#9b9991">'+esc(item.label)+'</text>';
        svg+='<rect x="130" y="'+(y+8)+'" width="'+w+'" height="24" rx="6" style="fill:#5a9ac8;opacity:0.75"/>';
        svg+='<text x="'+(140+w)+'" y="'+(y+26)+'" style="font-size:14px;fill:#faf9f5;font-weight:500">'+item.val+'</text>';
      });
      svg+='</svg>';
      return '<div class="ai-visual">'+svg+'</div>';
    }catch(e){console.error('Chart error:',e);return '';}
  });
  
  // Funnel chart for pipeline
  html=html.replace(/\[CHART:funnel:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)||0};
      });
      if(!items.length||items.every(i=>!i.val))return '';
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*44+20;
      const colors=['#c07070','#d87756','#b8a050','#9888aa','#6aa0aa','#6aaa6a'];
      let svg='<svg class="ai-mini-chart" viewBox="0 0 360 '+h+'" style="width:360px;height:'+h+'px;display:block;margin:8px 0">';
      items.forEach((item,i)=>{
        const w=Math.max(Math.round(item.val/max*180),4);
        const x=(180-w)/2+100;
        const y=i*44+10;
        svg+='<text x="8" y="'+(y+26)+'" style="font-size:12px;fill:#9b9991">'+esc(item.label)+'</text>';
        svg+='<rect x="'+x+'" y="'+(y+8)+'" width="'+w+'" height="28" rx="6" style="fill:'+colors[i%6]+';opacity:0.85"/>';
        svg+='<text x="300" y="'+(y+28)+'" style="font-size:14px;fill:#faf9f5;font-weight:600">'+item.val+'</text>';
      });
      svg+='</svg>';
      return '<div class="ai-visual">'+svg+'</div>';
    }catch(e){console.error('Funnel error:',e);return '';}
  });
  
  // Escape HTML first (but preserve our generated HTML)
  const visualParts=[];
  html=html.replace(/<div class="ai-visual">[\s\S]*?<\/div>/g,(match)=>{
    visualParts.push(match);
    return '{{VISUAL'+(visualParts.length-1)+'}}';
  });
  const btnParts=[];
  html=html.replace(/<button class="ai-action-btn"[^>]*>.*?<\/button>/g,(match)=>{
    btnParts.push(match);
    return '{{BTN'+(btnParts.length-1)+'}}';
  });
  
  html=esc(html);
  
  // Restore visual parts
  visualParts.forEach((v,i)=>{html=html.replace('{{VISUAL'+i+'}}',v);});
  btnParts.forEach((b,i)=>{html=html.replace('{{BTN'+i+'}}',b);});
  
  // Replace [[Part Name]] with clickable links
  html=html.replace(/\[\[([^\]]+)\]\]/g,(match,partName)=>{
    // Try exact match first (case-insensitive)
    let part=getParts().find(p=>p.name.toLowerCase()===partName.toLowerCase().trim());
    
    // If no exact match, try partial match (part name contains the linked text or vice versa)
    if(!part){
      const searchName=partName.toLowerCase().trim();
      part=getParts().find(p=>
        p.name.toLowerCase().includes(searchName) || 
        searchName.includes(p.name.toLowerCase())
      );
    }
    
    // If still no match, try matching just the first word
    if(!part){
      const firstWord=partName.toLowerCase().trim().split(/\s+/)[0];
      if(firstWord.length>3){
        part=getParts().find(p=>p.name.toLowerCase().startsWith(firstWord));
      }
    }
    
    if(part){
      return '<a class="ai-part-link" href="#" onclick="window.aiGoToPart(\''+part.id+'\',event);return false;">'+partName+'</a>';
    }
    return partName;
  });
  
  // Replace {{Assembly Name}} with clickable links  
  html=html.replace(/\{\{([^\}]+)\}\}/g,(match,asmName)=>{
    const asm=getAsms().find(a=>a.name.toLowerCase()===asmName.toLowerCase());
    if(asm){
      return '<a class="ai-asm-link" href="#" onclick="window.aiGoToAsm(\''+asm.id+'\');return false;">'+asmName+'</a>';
    }
    return asmName;
  });
  
  // Replace **bold** with <strong>
  html=html.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  
  // Process line by line
  const lines=html.split('\n');
  let result=[];
  let inList=false;
  let listItems=[];
  
  const flushList=()=>{
    if(listItems.length){
      result.push('<ul>'+listItems.map(li=>'<li>'+li+'</li>').join('')+'</ul>');
      listItems=[];
    }
    inList=false;
  };
  
  lines.forEach(line=>{
    const trimmed=line.trim();
    if(!trimmed)return;
    
    // Check for section header (ALL CAPS followed by colon)
    if(/^[A-Z][A-Z\s]+:$/.test(trimmed)){
      flushList();
      result.push('<h4 class="ai-section-header">'+trimmed.replace(':','')+'</h4>');
      return;
    }
    
    // Check for bullet point
    if(/^[â€¢\-\*]\s/.test(trimmed)){
      inList=true;
      listItems.push(trimmed.replace(/^[â€¢\-\*]\s*/,''));
      return;
    }
    
    // Check for numbered item
    if(/^\d+[\.\)]\s/.test(trimmed)){
      inList=true;
      listItems.push(trimmed.replace(/^\d+[\.\)]\s*/,''));
      return;
    }
    
    // Regular text - flush any pending list and add as paragraph
    flushList();
    result.push('<p>'+trimmed+'</p>');
  });
  
  flushList();
  
  // Add model attribution
  const modelAttribution=usedModel?'<div class="ai-model-attribution" title="Response generated by '+usedModel+'">'+( AI_MODELS[usedModel]?.name||usedModel)+'</div>':'';
  
  return '<div class="ai-prose">'+result.join('')+modelAttribution+'</div>';
}

// Navigation functions for AI links
let currentPartInfoId=null;

window.aiGoToPart=function(partId,e){
  if(e)e.preventDefault();
  const part=data.find(d=>String(d.id)===String(partId));
  if(!part)return;
  
  // Minimize console instead of closing (preserves history)
  minimizeCmdWindow();
  closeAIWorkspace();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  
  // Expand parent assembly
  if(part.parentId){
    expanded[String(part.parentId)]=true;
  }
  render();
  
  setTimeout(()=>{
    const row=document.querySelector('[data-part-id="'+partId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.classList.add('ai-highlight');
      setTimeout(()=>row.classList.remove('ai-highlight'),5000);
    }
  },100);
};

window.goToPartFromPopover=function(){
  if(!currentPartInfoId)return;
  const partId=currentPartInfoId;
  $('partInfoPopover').classList.remove('open');
  closeAIWorkspace();
  minimizeCmdWindow();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  const part=data.find(d=>String(d.id)===String(partId));
  if(part&&part.parentId){
    expanded[String(part.parentId)]=true;
  }
  render();
  setTimeout(()=>{
    const row=document.querySelector('[data-part-id="'+partId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.classList.add('ai-highlight');
      setTimeout(()=>row.classList.remove('ai-highlight'),5000);
    }
  },100);
};

// Close part info popover when clicking outside
document.addEventListener('click',e=>{
  const popover=$('partInfoPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.ai-part-link')){
    popover.classList.remove('open');
  }
});

window.highlightParts=function(partIds){
  closeAIWorkspace();
  minimizeCmdWindow();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  // Expand all parent assemblies
  partIds.forEach(id=>{
    const part=data.find(d=>String(d.id)===String(id));
    if(part&&part.parentId)expanded[String(part.parentId)]=true;
  });
  render();
  setTimeout(()=>{
    partIds.forEach((id,i)=>{
      const row=document.querySelector('[data-part-id="'+id+'"]');
      if(row){
        row.classList.add('ai-highlight');
        if(i===0)row.scrollIntoView({behavior:'smooth',block:'center'});
        setTimeout(()=>row.classList.remove('ai-highlight'),5000);
      }
    });
  },100);
};

window.aiGoToAsm=function(asmId){
  closeAIWorkspace();
  minimizeCmdWindow();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('[data-tab="list"]').classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('listPanel').classList.add('active');
  expanded[String(asmId)]=true;
  render();
  setTimeout(()=>{
    // Highlight the assembly row
    const row=document.querySelector('[data-asm-id="'+asmId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.classList.add('ai-highlight');
      setTimeout(()=>row.classList.remove('ai-highlight'),5000);
    }
    // Recursively get all children (parts and sub-parts)
    function getAllChildren(parentId){
      const children=data.filter(d=>!d.isAsm&&!d._deletedAt&&String(d.parentId)===String(parentId));
      let all=[...children];
      children.forEach(c=>{
        all=all.concat(getAllChildren(c.id));
      });
      return all;
    }
    // Highlight all child parts within this assembly
    const allChildren=getAllChildren(asmId);
    allChildren.forEach(p=>{
      const partRow=document.querySelector('[data-part-id="'+p.id+'"]');
      if(partRow){
        partRow.classList.add('ai-highlight');
        setTimeout(()=>partRow.classList.remove('ai-highlight'),5000);
      }
    });
  },100);
};

window.aiFilterStage=function(stage){
  closeAIWorkspace();
  minimizeCmdWindow();
  
  // Handle special filter cases
  if(stage==='stuck'){
    // Show parts stuck more than 5 days
    const stuckIds=getParts().filter(p=>{
      const days=Math.floor((Date.now()-(p.changedAt||Date.now()))/(1000*60*60*24));
      return days>5&&p.status!=='installed';
    }).map(p=>p.id);
    if(stuckIds.length>0){
      highlightParts(stuckIds);
    }else{
      toast('No stuck parts found');
    }
    return;
  }
  
  filterStage=stage;
  render();
};

// AI Model Selection
let selectedAIModel='claude-sonnet-4-5-20250929';
let lastUsedModel=null;

// Debug helper - call window.checkAIModel() in console to see current model
window.checkAIModel=function(){
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ¤– AI Model Status');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Selected model:', selectedAIModel);
  console.log('Display name:', AI_MODELS[selectedAIModel]?.name || 'unknown');
  console.log('Last used model:', lastUsedModel || 'none yet');
  if(lastUsedModel){
    console.log('Last response from:', AI_MODELS[lastUsedModel]?.name || lastUsedModel);
  }
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  return {selected: selectedAIModel, lastUsed: lastUsedModel};
};
const AI_MODELS={
  'claude-haiku-4-5-20251001':{name:'haiku-4.5',label:'Haiku 4.5'},
  'claude-sonnet-4-5-20250929':{name:'sonnet-4.5',label:'Sonnet 4.5'},
  'claude-opus-4-5-20251101':{name:'opus-4.5',label:'Opus 4.5'}
};

window.toggleModelSelector=function(e){
  e.stopPropagation();
  if($('aiModelDropdown'))$('aiModelDropdown').classList.toggle('open');
};

window.selectAIModel=function(btn){
  const model=btn.dataset.model;
  selectedAIModel=model;
  if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML=AI_MODELS[model].name+' <span style="opacity:0.5">â–¾</span>';
  if($('cmdModelSelect'))$('cmdModelSelect').value=model;
  // Update active state
  document.querySelectorAll('.ai-model-option').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.ai-model-option[data-model="'+model+'"]').forEach(b=>b.classList.add('active'));
  if($('aiModelDropdown'))$('aiModelDropdown').classList.remove('open');
};

window.toggleModelSelectorWs=function(e){
  e.stopPropagation();
  $('aiModelDropdownWs').classList.toggle('open');
};

window.selectAIModelWs=function(btn){
  const model=btn.dataset.model;
  selectedAIModel=model;
  if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML=AI_MODELS[model].name+' <span style="opacity:0.5">â–¾</span>';
  if($('cmdModelSelect'))$('cmdModelSelect').value=model;
  // Update active state in both dropdowns
  document.querySelectorAll('.ai-model-option').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.ai-model-option[data-model="'+model+'"]').forEach(b=>b.classList.add('active'));
  $('aiModelDropdownWs').classList.remove('open');
};

// Close dropdown when clicking outside
document.addEventListener('click',e=>{
  if(!e.target.closest('.ai-model-selector')){
    if($('aiModelDropdown'))$('aiModelDropdown').classList.remove('open');
  }
  if(!e.target.closest('.ai-model-selector-ws')){
    $('aiModelDropdownWs').classList.remove('open');
  }
});

async function askAI(question){
  const partsCheck = getParts();
  if(partsCheck.length === 0) {
    return '<div class="ai-prose"><p><strong>No project data loaded.</strong> Click â˜° â†’ Load Sample Data to get started.</p></div>';
  }
  
  // Use the SAME context builder as the working report
  const context=buildFullProjectContext();
  // Add the question for context
  context.question=question;
  
  console.log('ðŸ¤– askAI context: parts=', context.allParts?.length, 'asms=', context.assemblies?.length);
  
  try{
    if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML='<span class="thinking-pulse">thinking...</span>';
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({
      mode:'ask',
      projectContext:context,
      question,
      maxChars:2000,  // Match the report setting
      style:'concise',
      model:selectedAIModel
    });
    
    // Log model verification
    const requestedModel=selectedAIModel;
    const returnedModel=result.data?.model||'unknown';
    console.log('ðŸ¤– AI Model Verification:');
    console.log('   Requested:', requestedModel);
    console.log('   Returned:', returnedModel);
    console.log('   Match:', requestedModel===returnedModel ? 'âœ… YES' : 'âŒ NO');
    
    if(result.data?.success){
      // Use the RETURNED model from API, not the requested one
      const actualModel=result.data.model||selectedAIModel;
      const modelName=AI_MODELS[actualModel]?.name||actualModel;
      if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML=modelName+' <span style="opacity:0.5">â–¾</span>';
      lastUsedModel=actualModel;
      return formatClaudeResponse(result.data.content,'ask',actualModel);
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Ask failed:',e);
    if($('aiModelBadgeWs'))$('aiModelBadgeWs').innerHTML='offline <span style="opacity:0.5">â–¾</span>';
    return '<div class="ai-prose"><p>Unable to get response. Please try again.</p></div>';
  }
}

function generateLocalReport(mode,ctx){
  const today=new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});
  
  if(mode==='quick'){
    return renderQuickInsights();
  }
  
  if(mode==='standup'){
    let html='<div class="ai-summary"><strong>'+ctx.project.name+'</strong><br>'+today+'<br><br>';
    html+='<strong>'+ctx.project.progress+'%</strong> complete';
    if(ctx.project.daysLeft!==null)html+=' Â· <strong>'+ctx.project.daysLeft+'</strong> days left';
    if(ctx.project.velocity)html+=' Â· <strong>'+ctx.project.velocity+'</strong> parts/day';
    html+='</div>';
    
    // Blockers
    if(ctx.overdue.length||ctx.stuck.filter(s=>s.status==='to-order').length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ”´</span> Blockers</div><div class="ai-report-items">';
      ctx.overdue.forEach(a=>{
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(a.task)+'</strong><div class="ai-report-meta">'+a.daysOverdue+' day'+(a.daysOverdue!==1?'s':'')+' overdue Â· '+esc(a.assignee)+'</div></div></div>';
      });
      ctx.stuck.filter(s=>s.status==='to-order').slice(0,3).forEach(p=>{
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(p.name)+'</strong> ready to order<div class="ai-report-meta">'+p.days+' days Â· '+(p.mfr?esc(p.mfr):'No supplier')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Needs Attention
    const arrivedCount=ctx.counts.arrived||0;
    const inTransit=ctx.stuck.filter(s=>s.status==='ordered');
    if(arrivedCount||inTransit.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸŸ¡</span> Needs Attention</div><div class="ai-report-items">';
      if(arrivedCount){
        html+='<div class="ai-report-item warning"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+arrivedCount+' part'+(arrivedCount!==1?'s':'')+' arrived</strong> - awaiting next step</div></div>';
      }
      inTransit.slice(0,3).forEach(p=>{
        html+='<div class="ai-report-item warning"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(p.name)+'</strong> in transit '+p.days+' days<div class="ai-report-meta">'+(p.mfr?esc(p.mfr):'Unknown supplier')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Due Soon
    if(ctx.upcoming.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ“‹</span> Due This Week</div><div class="ai-report-items">';
      ctx.upcoming.slice(0,5).forEach(a=>{
        const dueDate=new Date(a.due).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text">'+esc(a.task)+'<div class="ai-report-meta">'+dueDate+' Â· '+esc(a.assignee)+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Focus
    html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸŽ¯</span> Focus Today</div><div class="ai-report-items">';
    const focuses=[];
    if(ctx.overdue.length)focuses.push('Clear '+ctx.overdue.length+' overdue action'+(ctx.overdue.length!==1?'s':''));
    if(arrivedCount>=3)focuses.push('Process '+arrivedCount+' arrived parts');
    if(ctx.stuck.filter(s=>s.status==='to-order').length>=3)focuses.push('Place orders for stuck parts');
    if(inTransit.length)focuses.push('Follow up on long-transit items');
    if(!focuses.length)focuses.push('Continue steady progress');
    focuses.slice(0,3).forEach((f,i)=>{
      html+='<div class="ai-report-item success"><span class="ai-report-bullet">'+(i+1)+'.</span><div class="ai-report-text">'+f+'</div></div>';
    });
    html+='</div></div>';
    
    return html;
  }
  
  if(mode==='risks'){
    let html='<div class="ai-summary"><strong>Risk Analysis</strong><br>'+ctx.project.name+'<br>'+today+'</div>';
    
    // Schedule Risk
    const forecast=ctx.forecast;
    if(forecast){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ“Š</span> Schedule Risk</div><div class="ai-report-items">';
      if(forecast.status==='at-risk'){
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>Behind Schedule</strong><div class="ai-report-meta">At current velocity, completion '+(forecast.daysToComplete-forecast.daysLeft)+' days late</div></div></div>';
      }else if(forecast.status==='ahead'){
        html+='<div class="ai-report-item success"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>Ahead of Schedule</strong><div class="ai-report-meta">Finishing '+(forecast.daysLeft-forecast.daysToComplete)+' days before deadline</div></div></div>';
      }else{
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>On Track</strong><div class="ai-report-meta">Current velocity matches target</div></div></div>';
      }
      html+='</div></div>';
    }
    
    // Supplier Risks
    const riskySuppliers=ctx.suppliers.filter(s=>s.inTransit>=2);
    if(riskySuppliers.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸšš</span> Supplier Exposure</div><div class="ai-report-items">';
      riskySuppliers.forEach(s=>{
        const level=s.inTransit>=4?'critical':s.inTransit>=2?'warning':'info';
        html+='<div class="ai-report-item '+level+'"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(s.mfr)+'</strong><div class="ai-report-meta">'+s.inTransit+' parts in transit'+(s.avgLead?' Â· avg '+s.avgLead+'d lead time':'')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Assembly Risks (lowest progress)
    const atRiskAsms=ctx.asmProgress.filter(a=>a.progress<40);
    if(atRiskAsms.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">âš ï¸</span> Assemblies Behind</div><div class="ai-report-items">';
      atRiskAsms.slice(0,5).forEach(a=>{
        const level=a.progress<20?'critical':a.progress<40?'warning':'info';
        html+='<div class="ai-report-item '+level+'"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(a.name)+'</strong><div class="ai-report-meta">'+a.progress+'% complete Â· '+a.parts+' parts</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Recent Comments (may indicate issues)
    if(ctx.recentComments.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ’¬</span> Recent Notes</div><div class="ai-report-items">';
      ctx.recentComments.slice(0,5).forEach(c=>{
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text">"'+esc(c.text.slice(0,100))+(c.text.length>100?'...':'')+'"<div class="ai-report-meta">'+esc(c.partName)+' Â· '+c.date+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Mitigations
    html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ›¡ï¸</span> Recommended Actions</div><div class="ai-report-items">';
    const mitigations=[];
    if(ctx.overdue.length)mitigations.push('Clear overdue actions to unblock progress');
    if(riskySuppliers.length)mitigations.push('Contact '+riskySuppliers[0].mfr+' for delivery status');
    if(atRiskAsms.length)mitigations.push('Prioritize '+atRiskAsms[0].name+' assembly');
    if(ctx.counts['waiting']>10)mitigations.push('Reduce ordering backlog ('+ctx.counts['waiting']+' pending)');
    if(!mitigations.length)mitigations.push('Continue monitoring - no critical actions needed');
    mitigations.slice(0,4).forEach((m,i)=>{
      html+='<div class="ai-report-item success"><span class="ai-report-bullet">'+(i+1)+'.</span><div class="ai-report-text">'+m+'</div></div>';
    });
    html+='</div></div>';
    
    return html;
  }
  
  return '<div class="ai-error"><div class="ai-error-icon">â“</div><div class="ai-error-msg">Unknown report mode</div></div>';
}

function renderQuickInsights(){
  const insights=window._aiInsights||generateAIInsights();
  return insights.map((ins,i)=>'<div class="ai-insight '+ins.level+'" data-idx="'+i+'"><div class="ai-insight-icon">'+ins.icon+'</div><div class="ai-insight-content"><div class="ai-insight-title">'+ins.title+'</div><div class="ai-insight-desc">'+ins.desc+'</div>'+(ins.action?'<div class="ai-insight-action">'+ins.action+'</div>':'')+'</div></div>').join('');
}

let aiWorkspaceOpen=false;
let aiWorkspaceConversation=[];

function toggleAIWorkspace(){
  if(aiWorkspaceOpen){
    closeAIWorkspace();
  }else{
    openAIWorkspace();
  }
}

function openAIWorkspace(){
  aiWorkspaceOpen=true;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  $('aiWorkspace').classList.add('active');
  const btn=$('aiAlert');
  btn.classList.remove('decelerating');
  btn.classList.add('active');
  // After acceleration animation (2s), switch to fast spinning dot
  setTimeout(()=>{
    if(aiWorkspaceOpen)btn.classList.add('spinning');
  },1950);
  renderWorkspaceConversation();
  $('aiWorkspaceQuestion').focus();
}

function closeAIWorkspace(){
  if(!aiWorkspaceOpen)return;
  aiWorkspaceOpen=false;
  $('aiWorkspace').classList.remove('active');
  const btn=$('aiAlert');
  btn.classList.remove('active','spinning');
  btn.classList.add('decelerating');
  // Remove decelerating class after animation completes
  setTimeout(()=>{
    btn.classList.remove('decelerating');
  },2000);
  const activeTab=document.querySelector('.tab.active')||document.querySelector('[data-tab="list"]');
  if(activeTab){
    activeTab.classList.add('active');
    $(activeTab.dataset.tab+'Panel').classList.add('active');
  }else{
    document.querySelector('[data-tab="list"]').classList.add('active');
    $('listPanel').classList.add('active');
  }
}

function renderWorkspaceConversation(){
  const container=$('aiWorkspaceConversation');
  if(aiWorkspaceConversation.length===0){
    // Show insights dashboard when empty
    const insights=generateInsights();
    let html='<div class="ai-workspace-conversation-inner">';
    html+='<div class="ai-welcome-minimal">What would you like to know?</div>';
    if(insights.length>0){
      html+='<div class="ai-welcome-insights">';
      insights.slice(0,4).forEach(ins=>{
        html+='<div class="ai-welcome-insight '+ins.level+'" data-question="'+escapeAttr(ins.question||ins.title)+'">';
        html+='<span class="ai-welcome-insight-icon">'+ins.icon+'</span>';
        html+='<div class="ai-welcome-insight-text">';
        html+='<div class="ai-welcome-insight-title">'+ins.title+'</div>';
        html+='<div class="ai-welcome-insight-desc">'+ins.desc+'</div>';
        html+='</div>';
        html+='</div>';
      });
      html+='</div>';
    }
    html+='<div class="ai-welcome-suggestions">';
    html+='<button class="ai-suggest-btn" data-q="What\'s blocking progress?">What\'s blocking progress?</button>';
    html+='<button class="ai-suggest-btn" data-q="Which parts need attention?">Parts needing attention</button>';
    html+='<button class="ai-suggest-btn" data-q="Summarize supplier performance">Supplier performance</button>';
    html+='<button class="ai-suggest-btn" data-q="What should I focus on today?">Today\'s priorities</button>';
    html+='</div>';
    html+='</div>';
    container.innerHTML=html;
    // Bind click handlers
    container.querySelectorAll('.ai-welcome-insight').forEach(el=>{
      el.onclick=()=>{
        const q=el.dataset.question;
        if(q){$('aiWorkspaceQuestion').value=q;handleWorkspaceAsk();}
      };
    });
    container.querySelectorAll('.ai-suggest-btn').forEach(btn=>{
      btn.onclick=()=>{
        const q=btn.dataset.q;
        if(q){$('aiWorkspaceQuestion').value=q;handleWorkspaceAsk();}
      };
    });
    return;
  }
  let html='<div class="ai-workspace-conversation-inner">';
  html+=aiWorkspaceConversation.map(msg=>{
    if(msg.role==='user'){
      return '<div class="ai-msg ai-msg-user"><div class="ai-msg-content">'+esc(msg.content)+'</div></div>';
    }else{
      if(msg.isThinking){
        return '<div class="ai-msg ai-msg-assistant ai-msg-thinking">'+msg.content+'</div>';
      }
      // Sanitize AI response HTML with DOMPurify
      const sanitized = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(msg.content, {
        ALLOWED_TAGS: ['p','br','strong','em','ul','ol','li','h1','h2','h3','h4','div','span','a','table','thead','tbody','tr','th','td','code','pre','button','svg','path','line','polyline','rect','circle','text','tspan','g'],
        ALLOWED_ATTR: ['class','style','href','onclick','data-q','data-question','viewBox','width','height','fill','stroke','stroke-width','stroke-linecap','stroke-linejoin','d','x','y','x1','y1','x2','y2','cx','cy','r','rx','ry','points','font-size','font-weight','opacity','transform'],
        ALLOW_DATA_ATTR: true
      }) : msg.content;
      return '<div class="ai-msg ai-msg-assistant"><div class="ai-msg-content">'+sanitized+'</div></div>';
    }
  }).join('');
  html+='</div>';
  container.innerHTML=html;
  container.scrollTop=container.scrollHeight;
}

function escapeAttr(str){return str.replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

function generateInsights(){
  const parts=data.filter(d=>!d.isAsm&&!d._deletedAt);
  const total=parts.length;
  if(total===0)return [];
  
  const insights=[];
  const now=Date.now();
  const day=86400000;
  
  // Stuck parts
  const stuckParts=parts.filter(p=>p.status!=='installed'&&p.changedAt&&(now-p.changedAt)>5*day);
  if(stuckParts.length>0){
    insights.push({level:'warning',icon:'â³',title:stuckParts.length+' parts stuck >5 days',desc:stuckParts.slice(0,2).map(p=>p.name).join(', '),question:'Which parts are stuck and why?'});
  }
  
  // Progress
  const installed=parts.filter(p=>p.status==='installed').length;
  const pct=Math.round(installed/total*100);
  if(pct<50){
    insights.push({level:'info',icon:'ðŸ“Š',title:pct+'% complete',desc:'Progress update',question:'How is the project progressing?'});
  }
  
  // Ready to install
  const readyToInstall=parts.filter(p=>p.status==='arrived');
  if(readyToInstall.length>0){
    insights.push({level:'success',icon:'âœ“',title:readyToInstall.length+' ready to install',desc:readyToInstall.slice(0,2).map(p=>p.name).join(', '),question:'Which parts are ready to install?'});
  }
  
  // Workload
  const assignees={};
  parts.forEach(p=>{if(p.assignee)assignees[p.assignee]=(assignees[p.assignee]||0)+1;});
  const sorted=Object.entries(assignees).sort((a,b)=>b[1]-a[1]);
  if(sorted.length>0&&sorted[0][1]>total*0.5){
    insights.push({level:'warning',icon:'ðŸ‘¤',title:sorted[0][0]+' has '+sorted[0][1]+' parts',desc:'Workload may be unbalanced',question:'How is workload distributed across the team?'});
  }
  
  // In transit
  const inTransit=parts.filter(p=>p.status==='ordered');
  if(inTransit.length>5){
    insights.push({level:'info',icon:'ðŸ“¦',title:inTransit.length+' parts in transit',desc:'Awaiting delivery',question:'Which parts are in transit and when will they arrive?'});
  }
  
  return insights;
}

const AI_THINKING_ICON='<div class="ai-thinking-orb"><div class="ai-thinking-plus"></div></div>';

async function handleWorkspaceAsk(){
  const input=$('aiWorkspaceQuestion');
  const question=input.value.trim();
  if(!question)return;
  
  aiWorkspaceConversation.push({role:'user',content:esc(question)});
  renderWorkspaceConversation();
  input.value='';
  input.style.height='auto';
  
  aiWorkspaceConversation.push({role:'assistant',content:AI_THINKING_ICON,isThinking:true});
  renderWorkspaceConversation();
  
  const response=await askAI(question);
  
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'');
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].isThinking=false;
  renderWorkspaceConversation();
}

async function handleWorkspaceTell(){
  aiWorkspaceConversation.push({role:'user',content:'Tell me about the project status'});
  renderWorkspaceConversation();
  
  aiWorkspaceConversation.push({role:'assistant',content:AI_THINKING_ICON,isThinking:true});
  renderWorkspaceConversation();
  
  const response=await generateAIReport('straight');
  
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'');
  aiWorkspaceConversation[aiWorkspaceConversation.length-1].isThinking=false;
  renderWorkspaceConversation();
}

function openAIModal(){
  showPopoverModal($('aiModal'),$('aiAlert'));
  if(aiConversation.length===0){
    if($('aiContent'))$('aiContent').innerHTML=renderAIDashboard();
  }else{
    renderConversation();
  }
  if($('aiQuestion'))$('aiQuestion').focus();
}

function renderAIDashboard(){
  const parts=data.filter(d=>!d.isAsm&&!d._deletedAt);
  const asms=data.filter(d=>d.isAsm&&!d._deletedAt);
  const total=parts.length;
  if(total===0)return '<div class="ai-welcome"><p>No parts in this project yet. Add assemblies and parts to see analysis.</p></div>';
  
  const now=Date.now();
  const day=86400000;
  const week=7*day;
  
  // Calculate stage transitions for velocity
  const recentTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)<week).length;
  const olderTransitions=parts.filter(p=>p.changedAt&&(now-p.changedAt)>=week&&(now-p.changedAt)<2*week).length;
  const velocityTrend=olderTransitions>0?Math.round((recentTransitions-olderTransitions)/olderTransitions*100):0;
  const velocityDir=velocityTrend>10?'accelerating':velocityTrend<-10?'slowing':'steady';
  
  // Bottleneck detection - find stage with longest average dwell time
  const stages=['waiting','to-order','ordered','arrived','installed'];
  const stageLabels={'waiting':'Waiting','to-order':'To Order','ordered':'Ordered','arrived':'Arrived','installed':'Installed'};
  const stageDwellTimes={};
  stages.forEach(s=>{
    const inStage=parts.filter(p=>p.status===s&&p.changedAt);
    if(inStage.length>0){
      const avgDwell=inStage.reduce((sum,p)=>sum+(now-p.changedAt),0)/inStage.length/day;
      stageDwellTimes[s]={avg:avgDwell,count:inStage.length};
    }
  });
  let bottleneck=null,maxDwell=0;
  Object.entries(stageDwellTimes).forEach(([stage,data])=>{
    if(stage!=='installed'&&data.avg>maxDwell&&data.count>=2){
      maxDwell=data.avg;bottleneck=stage;
    }
  });
  
  // Lead time analysis (order to arrival)
  const completedOrders=parts.filter(p=>p.orderedAt&&p.arrivedAt);
  let avgLeadTime=0,leadTimeVariance=0;
  if(completedOrders.length>=2){
    const leadTimes=completedOrders.map(p=>(p.arrivedAt-p.orderedAt)/day);
    avgLeadTime=Math.round(leadTimes.reduce((a,b)=>a+b,0)/leadTimes.length);
    const mean=avgLeadTime;
    leadTimeVariance=Math.round(Math.sqrt(leadTimes.reduce((sum,lt)=>sum+Math.pow(lt-mean,2),0)/leadTimes.length));
  }
  
  // Workload imbalance
  const assignees={};
  parts.filter(p=>p.assignee&&p.status!=='installed').forEach(p=>{
    assignees[p.assignee]=(assignees[p.assignee]||0)+1;
  });
  const assigneeList=Object.entries(assignees).sort((a,b)=>b[1]-a[1]);
  const maxWorkload=assigneeList[0]?assigneeList[0][1]:0;
  const minWorkload=assigneeList.length>1?assigneeList[assigneeList.length-1][1]:maxWorkload;
  const workloadImbalance=maxWorkload>0?(maxWorkload-minWorkload)/maxWorkload:0;
  
  // Stalled items (no change in 7+ days, not installed)
  const stalledParts=parts.filter(p=>p.status!=='installed'&&p.changedAt&&(now-p.changedAt)>week);
  
  // Arriving soon accuracy (parts that arrived vs their ETA)
  const arrivedWithEta=parts.filter(p=>p.arrivedAt&&p.expectedArrival);
  let onTimeRate=null,avgDelay=0;
  if(arrivedWithEta.length>=3){
    const onTime=arrivedWithEta.filter(p=>p.arrivedAt<=new Date(p.expectedArrival).getTime()+day);
    onTimeRate=Math.round(onTime.length/arrivedWithEta.length*100);
    avgDelay=Math.round(arrivedWithEta.reduce((sum,p)=>{
      const expected=new Date(p.expectedArrival).getTime();
      return sum+(p.arrivedAt-expected)/day;
    },0)/arrivedWithEta.length);
  }
  
  // Completion forecast based on velocity
  const installed=parts.filter(p=>p.status==='installed').length;
  const remaining=total-installed;
  const dailyVelocity=recentTransitions/7;
  const daysToComplete=dailyVelocity>0?Math.ceil(remaining/dailyVelocity):null;
  
  // Risk score (0-100)
  let riskScore=0;
  if(stalledParts.length>total*0.2)riskScore+=30;
  else if(stalledParts.length>total*0.1)riskScore+=15;
  if(velocityDir==='slowing')riskScore+=20;
  if(bottleneck&&maxDwell>5)riskScore+=25;
  else if(bottleneck&&maxDwell>3)riskScore+=10;
  if(onTimeRate!==null&&onTimeRate<70)riskScore+=25;
  else if(onTimeRate!==null&&onTimeRate<85)riskScore+=10;
  
  // Build insights array
  const insights=[];
  
  // Velocity insight
  if(recentTransitions>0||olderTransitions>0){
    const velIcon=velocityDir==='accelerating'?'â†‘':velocityDir==='slowing'?'â†“':'â†’';
    const velClass=velocityDir==='accelerating'?'positive':velocityDir==='slowing'?'negative':'neutral';
    insights.push({
      icon:velIcon,
      cls:velClass,
      title:'Velocity '+velocityDir,
      detail:recentTransitions+' transitions this week'+(velocityTrend!==0?' ('+(velocityTrend>0?'+':'')+velocityTrend+'%)':''),
      prompt:'Velocity is '+velocityDir+'. One cause, one fix. Max 2 sentences.'
    });
  }
  
  // Bottleneck insight
  if(bottleneck&&maxDwell>2){
    insights.push({
      icon:'âŠ˜',
      cls:'warning',
      title:'Bottleneck: '+stageLabels[bottleneck],
      detail:stageDwellTimes[bottleneck].count+' parts stuck avg '+Math.round(maxDwell)+'d',
      prompt:'Bottleneck at '+stageLabels[bottleneck]+' ('+stageDwellTimes[bottleneck].count+' parts, '+Math.round(maxDwell)+'d avg). Root cause and action. Show [ACTION:filter:'+bottleneck+'] button.'
    });
  }
  
  // Lead time insight
  if(avgLeadTime>0){
    const reliability=leadTimeVariance<avgLeadTime*0.3?'consistent':'variable';
    insights.push({
      icon:'â—·',
      cls:reliability==='consistent'?'neutral':'warning',
      title:'Lead time: '+avgLeadTime+'d avg',
      detail:'Â±'+leadTimeVariance+'d variance ('+reliability+')',
      prompt:'Lead time '+avgLeadTime+'d Â±'+leadTimeVariance+'d. What buffer to add? One number answer with brief reason.'
    });
  }
  
  // Forecast insight
  if(daysToComplete!==null&&remaining>0){
    const forecastDate=new Date(now+daysToComplete*day);
    const dateStr=forecastDate.getDate()+'/'+(forecastDate.getMonth()+1);
    insights.push({
      icon:'â—Ž',
      cls:daysToComplete>30?'warning':'neutral',
      title:'Forecasted finish: '+dateStr,
      detail:daysToComplete+' days at current velocity ('+remaining+' remaining)',
      prompt:'Completion forecast: '+daysToComplete+' days, '+remaining+' parts left. Top risk to this date? One sentence.'
    });
  }
  
  // Stalled items insight
  if(stalledParts.length>0){
    const pct=Math.round(stalledParts.length/total*100);
    const stalledIds=stalledParts.slice(0,5).map(p=>p.id).join(',');
    insights.push({
      icon:'â—¼',
      cls:pct>20?'negative':'warning',
      title:stalledParts.length+' stalled parts ('+pct+'%)',
      detail:'No movement in 7+ days',
      prompt:stalledParts.length+' parts stalled 7+ days. Pattern or common cause? Include [ACTION:highlight:'+stalledIds+'] to show them.'
    });
  }
  
  // On-time delivery insight
  if(onTimeRate!==null){
    insights.push({
      icon:'â—‡',
      cls:onTimeRate>=85?'positive':onTimeRate>=70?'warning':'negative',
      title:'On-time delivery: '+onTimeRate+'%',
      detail:avgDelay>0?'Avg '+Math.round(avgDelay)+'d late':'Avg '+Math.abs(Math.round(avgDelay))+'d early',
      prompt:'Supplier OTD '+onTimeRate+'%. '+(avgDelay>0?'Avg '+Math.round(avgDelay)+'d late.':'')+' Should I add buffer? Yes/no + days.'
    });
  }
  
  // Workload imbalance insight
  if(assigneeList.length>=2&&workloadImbalance>0.4){
    insights.push({
      icon:'âš–',
      cls:'warning',
      title:'Workload imbalance',
      detail:assigneeList[0][0]+' has '+assigneeList[0][1]+' items vs '+assigneeList[assigneeList.length-1][1]+' for '+assigneeList[assigneeList.length-1][0],
      prompt:'Workload: '+assigneeList[0][0]+'='+assigneeList[0][1]+', '+assigneeList[assigneeList.length-1][0]+'='+assigneeList[assigneeList.length-1][1]+'. Rebalance suggestion in one sentence.'
    });
  }
  
  // Risk score insight
  if(insights.length>0){
    const riskLabel=riskScore>=50?'High':riskScore>=25?'Moderate':'Low';
    const riskCls=riskScore>=50?'negative':riskScore>=25?'warning':'positive';
    insights.unshift({
      icon:'â—',
      cls:riskCls,
      title:'Risk level: '+riskLabel,
      detail:'Score: '+riskScore+'/100 based on '+insights.length+' factors',
      prompt:'Risk score '+riskScore+'/100. Top 3 risks as bullet points, max 5 words each.'
    });
  }
  
  // Build HTML
  let html='<div class="ai-dashboard">';
  
  if(insights.length===0){
    html+='<div class="ai-welcome"><p>Not enough data yet for analysis. As parts move through stages, insights will appear here.</p></div>';
  }else{
    html+='<div class="ai-insights-list">';
    insights.forEach((ins,idx)=>{
      html+='<div class="ai-insight-card '+ins.cls+'" data-prompt-idx="'+idx+'">';
      html+='<div class="ai-insight-icon">'+ins.icon+'</div>';
      html+='<div class="ai-insight-body"><div class="ai-insight-title">'+ins.title+'</div>';
      html+='<div class="ai-insight-detail">'+ins.detail+'</div></div>';
      html+='<div class="ai-insight-arrow">â†’</div></div>';
    });
    html+='</div>';
    html+='<div class="ai-dashboard-hint">Click any insight to explore with AI</div>';
  }
  
  html+='</div>';
  
  // Store prompts globally for click handlers
  window._aiPrompts=insights.map(i=>i.prompt);
  
  // Add click handlers after render
  setTimeout(()=>{
    document.querySelectorAll('.ai-insight-card[data-prompt-idx]').forEach(card=>{
      card.onclick=()=>{
        const idx=parseInt(card.dataset.promptIdx);
        if(window._aiPrompts&&window._aiPrompts[idx]){
          askAIQuestion(window._aiPrompts[idx]);
        }
      };
    });
  },0);
  
  return html;
}

function askAIQuestion(prompt){
  $('aiQuestion').value=prompt;
  handleAskSubmit();
}
window.askAIQuestion=askAIQuestion;

function renderConversation(){
  let html='<div class="ai-conversation">';
  aiConversation.forEach(msg=>{
    if(msg.role==='user'){
      html+='<div class="ai-message user"><span class="ai-user-label">You:</span> '+msg.content+'</div>';
    }else{
      // Sanitize AI response HTML with DOMPurify
      const sanitized = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(msg.content, {
        ALLOWED_TAGS: ['p','br','strong','em','ul','ol','li','h1','h2','h3','h4','div','span','a','table','thead','tbody','tr','th','td','code','pre','button','svg','path','line','polyline','rect','circle','text','tspan','g'],
        ALLOWED_ATTR: ['class','style','href','onclick','data-q','data-question','viewBox','width','height','fill','stroke','stroke-width','stroke-linecap','stroke-linejoin','d','x','y','x1','y1','x2','y2','cx','cy','r','rx','ry','points','font-size','font-weight','opacity','transform'],
        ALLOW_DATA_ATTR: true
      }) : msg.content;
      html+='<div class="ai-message assistant">'+sanitized+'</div>';
    }
  });
  html+='</div>';
  $('aiContent').innerHTML=html;
  // Scroll to bottom
  const content=$('aiContent');
  content.scrollTop=content.scrollHeight;
}

async function handleAskSubmit(){
  const input=$('aiQuestion');
  const question=input.value.trim();
  if(!question)return;
  
  // Add user message
  aiConversation.push({role:'user',content:esc(question)});
  renderConversation();
  input.value='';
  
  // Add loading indicator
  aiConversation.push({role:'assistant',content:'<span class="ai-loading-text">Thinking...</span>'});
  renderConversation();
  
  // Get AI response
  const response=await askAI(question);
  
  // Replace loading with actual response - preserve paragraph breaks
  aiConversation[aiConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'').replace(/<\/p>\s*<p>/g,'</p><p>');
  renderConversation();
}

async function handleStraight(){
  // Add system indicator
  aiConversation.push({role:'user',content:'Tell me'});
  renderConversation();
  
  // Add loading indicator
  aiConversation.push({role:'assistant',content:'<span class="ai-loading-text">Analyzing...</span>'});
  renderConversation();
  
  // Get AI response
  const response=await generateAIReport('straight');
  
  // Replace loading with actual response - preserve paragraph breaks
  aiConversation[aiConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'').replace(/<\/p>\s*<p>/g,'</p><p>');
  renderConversation();
}

function bindQuickInsightHandlers(){
  const insights=window._aiInsights||[];
  document.querySelectorAll('.ai-insight').forEach(el=>{
    const idx=parseInt(el.dataset.idx);
    const ins=insights[idx];
    if(ins&&ins.handler)el.onclick=ins.handler;
  });
}

function renderLeadTimeModal(){const codes=Object.keys(leadTimeDb).sort();if(!codes.length){$('ltBody').innerHTML='<p style="color:var(--text3);text-align:center;padding:20px">No lead time data yet.</p>';return}$('ltBody').innerHTML=codes.map(code=>{const lt=leadTimeDb[code];return'<div class="lt-item"><div class="lt-code">'+esc(code)+'</div><div class="lt-stats"><span class="lt-stat-val">'+lt.avg+'d</span><span style="color:var(--text2);margin-left:8px">avg lead time</span><span class="lt-samples" style="margin-left:auto">'+lt.samples.length+' sample'+(lt.samples.length!==1?'s':'')+'</span></div></div>'}).join('')}

function openEtaModal(partId,e){const part=data.find(d=>String(d.id)===String(partId));if(!part)return;editEtaPartId=partId;$('etaPartName').textContent=part.name;$('etaCode').textContent=part.code?'Item Code: '+part.code:'No item code set';const lt=getLeadTimeHistory(part.code);let histHtml='<div class="eta-popover-history-title">Historical Data</div>';if(lt&&lt.samples.length){histHtml+=lt.samples.slice(-5).reverse().map(s=>'<div class="eta-popover-history-item"><span>'+s.date+'</span><span>'+s.days+' days</span></div>').join('');histHtml+='<div class="eta-popover-avg"><span>Average</span><span>'+lt.avg+' days</span></div>'}else{histHtml+='<div class="eta-popover-history-empty">No historical data</div>'}$('etaHistory').innerHTML=histHtml;$('etaDateInput').value=part.expectedArrival||'';const popover=$('etaPopover');if(e){const rect=e.target.getBoundingClientRect();popover.style.visibility='hidden';popover.classList.add('open');const popoverHeight=popover.offsetHeight||280;const popoverWidth=popover.offsetWidth||320;popover.classList.remove('open');popover.style.visibility='';let top=rect.bottom+8;if(top+popoverHeight>window.innerHeight-20){top=rect.top-popoverHeight-8;if(top<20)top=20}let left=rect.left;if(left+popoverWidth>window.innerWidth-20){left=window.innerWidth-popoverWidth-20}if(left<20)left=20;popover.style.top=top+'px';popover.style.left=left+'px'}closeAllPopovers();popover.classList.add('open')}
window.openEtaModal=openEtaModal;

function updateSelects(){const opts='<option value="">â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');$('pmAssignee').innerHTML=opts;$('amAssignee').innerHTML=opts;if($('actAssignee'))$('actAssignee').innerHTML=opts;$('assigneeFilter').innerHTML='<option value="">All</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');if($('actionAssigneeFilter'))$('actionAssigneeFilter').innerHTML='<option value="">All Assignees</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');if($('actLinkedPart'))$('actLinkedPart').innerHTML='<option value="">â€” None â€”</option>'+getParts().map(p=>'<option value="'+p.id+'">'+esc(p.name)+'</option>').join('')}
function updateExpandToggle(){const btn=$('expandToggle');const asms=getAsms();const expandedCount=asms.filter(a=>expanded[String(a.id)]).length;allExpanded=expandedCount>asms.length/2;btn.innerHTML=allExpanded?'<span class="arrow">â–²</span> Collapse':'<span class="arrow">â–¼</span> Expand';btn.classList.toggle('expanded',allExpanded)}

function renderTeamList(){$('teamList').innerHTML=!team.length?'<p style="color:var(--text3);text-align:center;padding:12px;font-size:10px">No team members</p>':team.map((t,i)=>'<div class="team-item"><div class="team-item-info"><div style="font-weight:600">'+esc(t.name)+'</div><div style="font-size:10px;color:var(--text3)">'+esc(t.email)+'</div></div><button class="team-item-del" onclick="window.delTeam('+i+',event)">Ã—</button></div>').join('')}
function renderBomList(){if(!savedBoms.length){$('bomList').innerHTML='<p style="color:var(--text3);text-align:center;padding:20px">No saved specifications</p>';return}$('bomList').innerHTML=savedBoms.map(b=>'<div class="bom-item" onclick="window.loadBom(\''+b.id+'\')"><div class="bom-item-info"><div class="bom-item-name">'+esc(b.name)+'</div><div class="bom-item-meta">'+b.items.filter(i=>i.isAsm).length+' asm, '+b.items.filter(i=>!i.isAsm).length+' parts</div></div><button class="bom-item-del" onclick="event.stopPropagation();window.delBom(\''+b.id+'\',event)">Ã—</button></div>').join('')}

window.toggleAsmRow=function(e,id){if(e.target.closest('.asm-actions')||e.target.closest('.cell')||e.target.closest('.asm-priority'))return;expanded[String(id)]=!expanded[String(id)];saveExpanded();render()};
window.moveAsmUp=function(id){
  const asms=getAsms();
  const idx=asms.findIndex(a=>String(a.id)===String(id));
  if(idx<=0)return;
  const current=asms[idx],prev=asms[idx-1];
  const tempPriority=current.priority;
  current.priority=prev.priority;
  prev.priority=tempPriority;
  save();render();
};
window.moveAsmDown=function(id){
  const asms=getAsms();
  const idx=asms.findIndex(a=>String(a.id)===String(id));
  if(idx<0||idx>=asms.length-1)return;
  const current=asms[idx],next=asms[idx+1];
  const tempPriority=current.priority;
  current.priority=next.priority;
  next.priority=tempPriority;
  save();render();
};
window.addNewAsm=function(){const id=generateId(),asms=getAsms();const maxP=asms.length?Math.max(...asms.map(a=>a.priority||0)):0;data.push({id,name:'New Assembly',isAsm:true,assignee:'',priority:maxP+1});expanded[String(id)]=true;dirtyAsms.add(id);save();render();setTimeout(()=>{editAsmId=id;$('amTitle').textContent='Edit Assembly';$('amName').value='New Assembly';$('amAssignee').value='';$('amNotes').value='';$('amNotify').disabled=true;showPopoverModal($('asmModal'),null);$('amName').select()},50)};
window.addNewAssembly=window.addNewAsm; // Alias for empty state button
window.addNewPart=function(parentId){const id=generateId();data.push({id,name:'New Part',code:'',mfr:'',qty:1,assignee:'',parentId:String(parentId),status:'waiting',changedAt:Date.now(),_fieldTs:{}});const serverTime=getServerAlignedTime();['name','status','parentId'].forEach(f=>data[data.length-1]._fieldTs[f]=serverTime);dirtyParts.add(id);expanded[String(parentId)]=true;save();highlightPartId=id;render();setTimeout(()=>{const row=document.querySelector('[data-part-id="'+id+'"] .cell');if(row)row.click()},50)};
window.addSubPart=function(parentPartId,e){if(e)e.stopPropagation();const parentPart=data.find(d=>String(d.id)===String(parentPartId));if(!parentPart)return;const id=generateId();data.push({id,name:'New Sub-Part',code:'',mfr:'',qty:1,assignee:parentPart.assignee||'',parentId:parentPartId,status:'waiting',changedAt:Date.now()});dirtyParts.add(id);save();highlightPartId=id;render();setTimeout(()=>{const nameCell=document.querySelector('[data-part-id="'+id+'"] .part-name-cell .cell');if(nameCell){nameCell.click();setTimeout(()=>{const input=nameCell.querySelector('input');if(input)input.select()},10)}},50)};

window.toggleMetricsPopover=function(e){
  e.stopPropagation();
  const popover=$('metricsPopover');
  const isOpen=popover.classList.contains('open');
  if(isOpen){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
    return;
  }
  updateMetricsPopover();
  const btn=$('headerMetrics');
  const rect=btn.getBoundingClientRect();
  popover.style.top=(rect.bottom+8)+'px';
  popover.style.right=(window.innerWidth-rect.right)+'px';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>{
    const closeHandler=(ev)=>{
      if(!popover.contains(ev.target)&&!btn.contains(ev.target)){
        popover.classList.remove('open');
        $('popoverBackdrop').classList.remove('active');
        document.removeEventListener('click',closeHandler);
      }
    };
    document.addEventListener('click',closeHandler);
  },0);
};

function updateMetricsPopover(){
  const daysLeft=getDaysLeft(),pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast(),otd=calcSupplierOTD(),avgLead=calcAvgLeadTime();
  const parts=getParts();
  const inTransit=parts.filter(p=>p.status==='ordered').length;
  const toOrder=parts.filter(p=>p.status==='to-order').length;
  
  // Set deadline label on progress chart
  if(projectDates.end){
    $('mpDeadlineLabel').textContent='Deadline: '+formatDateShort(projectDates.end);
  }else{
    $('mpDeadlineLabel').textContent='';
  }
  
  // Velocity forecast
  let forecastHtml='';
  if(forecast&&forecast.estDate&&forecast.rate>0){
    let label='on time',labelColor='var(--text2)';
    const deadlineDate=projectDates.end?formatDateShort(projectDates.end):'â€”';
    if(forecast.daysLeft!==null&&forecast.daysToComplete!==null){
      const diff=forecast.daysLeft-forecast.daysToComplete;
      if(diff>0){label=diff+' days early';labelColor='var(--green)'}
      else if(diff<0){label=Math.abs(diff)+' days late';labelColor='var(--red)'}
    }
    forecastHtml='<div><span class="mp-forecast-date">'+formatDateShort(forecast.estDate)+'</span><span class="mp-forecast-label" style="color:'+labelColor+'"> '+label+'</span></div><div class="mp-forecast-detail">At '+forecast.rate.toFixed(1)+'%/day â€¢ '+forecast.daysToComplete+'d to complete</div>';
    if(projectDates.end){
      forecastHtml+='<div class="mp-forecast-detail" style="color:var(--text-muted);margin-top:2px">Deadline: '+deadlineDate+'</div>';
    }
  }else{
    forecastHtml='<div style="color:var(--text3);font-size:11px">Not enough data</div>';
  }
  $('mpForecast').innerHTML=forecastHtml;
  
  // Bottlenecks
  const now=Date.now(),day=86400000;
  const bottlenecks=parts.filter(p=>p.status!=='installed').map(p=>{
    const daysInStage=p.changedAt?Math.floor((now-p.changedAt)/day):0;
    return{...p,daysInStage};
  }).filter(p=>p.daysInStage>=5).sort((a,b)=>b.daysInStage-a.daysInStage).slice(0,5);
  let bnHtml='';
  bottlenecks.forEach(p=>{
    bnHtml+='<div class="mp-bottleneck" onclick="window.goToPart(\''+p.id+'\')"><span class="mp-bottleneck-name">'+esc(p.name)+'</span><span class="mp-bottleneck-info">'+p.daysInStage+'d in '+SLABELS[p.status]+'</span></div>';
  });
  $('mpBottlenecks').innerHTML=bnHtml||'<div style="color:var(--text3);font-size:11px">No bottlenecks detected</div>';
  
  // Progress chart (burn-up)
  renderMetricsChart();
}

function renderMetricsChart(){
  const chart=$('mpChart');
  if(!projectDates.end){
    chart.innerHTML='<div class="mp-chart-empty" onclick="window.openDates()"><span>ðŸ“…</span><span>Set project end date to see chart</span></div>';
    return;
  }
  
  const dayMs = 86400000;
  const projectEndT = Date.parse(projectDates.end);
  const projectStartT = projectDates.start ? Date.parse(projectDates.start) : null;
  const todayT = Date.now();
  const todayStr = new Date().toISOString().split('T')[0];
  
  // Build working history - always include at least today's progress
  let workingHistory = history.length > 0 
    ? [...history] 
    : [{date: todayStr, pct: calcOverallProgress()}];
  
  // Sort by date and dedupe points too close together (< 3 days apart)
  workingHistory.sort((a, b) => Date.parse(a.date) - Date.parse(b.date));
  workingHistory = workingHistory.filter((h, i, arr) => {
    if (i === arr.length - 1) return true;
    const gap = (Date.parse(arr[i + 1].date) - Date.parse(h.date)) / dayMs;
    return gap >= 3;
  });
  
  // Chart X range: from earliest data to max(latest data, project end, today)
  const earliestT = Date.parse(workingHistory[0].date);
  const latestDataT = Date.parse(workingHistory[workingHistory.length - 1].date);
  const chartStartT = earliestT;
  const chartEndT = Math.max(latestDataT, projectEndT, todayT);
  const chartTotalDays = Math.max(1, (chartEndT - chartStartT) / dayMs);
  
  // For target line calculations
  const projectDuration = projectStartT ? (projectEndT - projectStartT) / dayMs : chartTotalDays;
  
  // Chart dimensions
  const w = 480, h = 170;
  const pad = {top: 14, right: 14, bottom: 38, left: 34};
  const chartW = w - pad.left - pad.right;
  const chartH = h - pad.top - pad.bottom;
  const xScale = t => pad.left + ((t - chartStartT) / dayMs / chartTotalDays) * chartW;
  const yScale = pct => pad.top + (1 - pct / 100) * chartH;
  
  // Map history to chart points
  const points = workingHistory.map(h => ({
    x: xScale(Date.parse(h.date)),
    y: yScale(h.pct),
    pct: h.pct,
    t: Date.parse(h.date),
    date: h.date
  }));
  
  // Get forecast for prediction line
  const forecast = getVelocityForecast();
  let forecastData = null;
  
  // Start SVG
  let svg = '<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="xMidYMid meet">';
  
  // Grid lines
  [0, 25, 50, 75, 100].forEach(g => {
    const y = yScale(g);
    svg += '<line x1="'+pad.left+'" y1="'+y+'" x2="'+(w-pad.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="1"/>';
    svg += '<text x="'+(pad.left-6)+'" y="'+(y+3)+'" fill="var(--text3)" font-size="9" text-anchor="end">'+g+'</text>';
  });
  
  // X-axis labels
  const formatLabel = t => new Date(t).toLocaleDateString('en-US', {month:'short', day:'numeric'});
  svg += '<text x="'+pad.left+'" y="'+(h-8)+'" fill="var(--text3)" font-size="9" text-anchor="start">'+formatLabel(chartStartT)+'</text>';
  svg += '<text x="'+(w/2)+'" y="'+(h-8)+'" fill="var(--text3)" font-size="9" text-anchor="middle">'+formatLabel(chartStartT + (chartEndT - chartStartT)/2)+'</text>';
  svg += '<text x="'+(w-pad.right)+'" y="'+(h-8)+'" fill="var(--text3)" font-size="9" text-anchor="end">'+formatLabel(chartEndT)+'</text>';
  
  // Today marker
  if (todayT >= chartStartT && todayT <= chartEndT) {
    svg += '<line x1="'+xScale(todayT)+'" y1="'+pad.top+'" x2="'+xScale(todayT)+'" y2="'+(h-pad.bottom)+'" stroke="var(--accent)" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>';
  }
  
  // Target line (if we have project start)
  if (projectStartT && projectEndT > projectStartT) {
    const tStartX = Math.max(pad.left, xScale(projectStartT));
    const tEndX = Math.min(w - pad.right, xScale(projectEndT));
    const startPct = projectStartT < chartStartT ? ((chartStartT - projectStartT) / dayMs / projectDuration) * 100 : 0;
    const endPct = projectEndT > chartEndT ? ((chartEndT - projectStartT) / dayMs / projectDuration) * 100 : 100;
    svg += '<line x1="'+tStartX+'" y1="'+yScale(startPct)+'" x2="'+tEndX+'" y2="'+yScale(endPct)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.6"/>';
  }
  
  // Helper: ideal progress at time t
  const getIdealPct = t => {
    if (!projectStartT) return 0;
    const elapsed = (t - projectStartT) / dayMs;
    return Math.max(0, Math.min(100, (elapsed / projectDuration) * 100));
  };
  
  // Progress line segments
  for (let i = 0; i < points.length - 1; i++) {
    const p1 = points[i], p2 = points[i + 1];
    const ideal1 = getIdealPct(p1.t), ideal2 = getIdealPct(p2.t);
    const ahead1 = p1.pct >= ideal1, ahead2 = p2.pct >= ideal2;
    const col1 = ahead1 ? 'var(--green)' : 'var(--red)';
    const col2 = ahead2 ? 'var(--green)' : 'var(--red)';
    
    if (ahead1 === ahead2) {
      svg += '<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>';
    } else {
      const t = (ideal1 - p1.pct) / ((p2.pct - p1.pct) - (ideal2 - ideal1));
      const ix = p1.x + t * (p2.x - p1.x), iy = p1.y + t * (p2.y - p1.y);
      svg += '<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+ix+'" y2="'+iy+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>';
      svg += '<line x1="'+ix+'" y1="'+iy+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col2+'" stroke-width="2.5" stroke-linecap="round"/>';
    }
  }
  
  // Prediction line - use current progress and calculate from today (consistent with velocity forecast)
  const lastPt = points[points.length - 1];
  const currentPct = calcOverallProgress();
  const todayForForecast = new Date();
  todayForForecast.setHours(0,0,0,0);
  const todayT_forecast = todayForForecast.getTime();
  
  if (forecast && forecast.rate > 0 && currentPct < 100) {
    // Use current progress, not last recorded point
    const remaining = 100 - currentPct;
    const daysTo100 = remaining / forecast.rate;
    const estFinishT = todayT_forecast + daysTo100 * dayMs;
    const estFinishStr = new Date(estFinishT).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    const afterDeadline = projectEndT ? estFinishT > projectEndT : false;
    const daysEarly = (afterDeadline || !projectEndT) ? null : Math.round((projectEndT - estFinishT) / dayMs);
    
    forecastData = { estDate: estFinishStr, rate: forecast.rate, daysToComplete: Math.round(daysTo100), afterDeadline, daysEarly };
    
    // Draw forecast line from last recorded point to estimated finish
    const forecastStartX = lastPt.x;
    const forecastStartY = lastPt.y;
    const targetX = Math.min(xScale(estFinishT), w - pad.right);
    const targetPct = estFinishT <= chartEndT ? 100 : currentPct + forecast.rate * ((chartEndT - todayT_forecast) / dayMs);
    
    svg += '<line x1="'+forecastStartX+'" y1="'+forecastStartY+'" x2="'+targetX+'" y2="'+yScale(Math.min(100, targetPct))+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" stroke-linecap="round" opacity="0.7"/>';
    
    if (estFinishT <= chartEndT) {
      svg += '<circle class="forecast-dot" cx="'+xScale(estFinishT)+'" cy="'+yScale(100)+'" r="5" fill="var(--bg2)" stroke="var(--text3)" stroke-width="1.5" style="cursor:pointer" data-tooltip="Forecasted finish: '+estFinishStr+'"/>';
    }
  } else if (forecast && forecast.rate <= 0 && currentPct < 100) {
    svg += '<line x1="'+lastPt.x+'" y1="'+lastPt.y+'" x2="'+(w-pad.right)+'" y2="'+lastPt.y+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="3,4" stroke-linecap="round" opacity="0.5"/>';
  }
  
  // Data points
  points.forEach(p => {
    const idealPct = getIdealPct(p.t);
    const dotColor = p.pct >= idealPct ? 'var(--green)' : 'var(--red)';
    const dateStr = new Date(p.date).toLocaleDateString('en-US', {month:'short', day:'numeric'});
    svg += '<circle class="data-dot" cx="'+p.x+'" cy="'+p.y+'" r="3.5" fill="'+dotColor+'" style="cursor:pointer" data-tooltip="'+dateStr+': '+Math.round(p.pct)+'%"/>';
  });
  
  svg += '</svg>';
  chart.innerHTML = svg;
  
  // Custom tooltips (instant, no delay)
  const tooltip = $('mpChartTooltip');
  const wrapper = chart.parentElement;
  
  chart.querySelectorAll('[data-tooltip]').forEach(el => {
    el.addEventListener('mouseenter', e => {
      tooltip.textContent = e.target.getAttribute('data-tooltip');
      tooltip.classList.add('visible');
      const r = e.target.getBoundingClientRect(), w = wrapper.getBoundingClientRect();
      tooltip.style.left = (r.left - w.left + r.width/2 - tooltip.offsetWidth/2) + 'px';
      tooltip.style.top = (r.top - w.top - 28) + 'px';
    });
    el.addEventListener('mouseleave', () => tooltip.classList.remove('visible'));
  });
  
  // Forecast dot click â†’ popover
  const forecastDot = chart.querySelector('.forecast-dot');
  if (forecastDot && forecastData) {
    forecastDot.addEventListener('click', e => {
      e.stopPropagation();
      const popover = $('mpForecastPopover');
      const r = forecastDot.getBoundingClientRect(), w = wrapper.getBoundingClientRect();
      
      $('mpForecastPopoverTitle').textContent = forecastData.estDate;
      $('mpForecastPopoverTitle').style.color = forecastData.afterDeadline ? 'var(--red)' : 'var(--green)';
      
      let content = '<div class="mp-forecast-popover-stat"><span>Velocity</span><span>'+forecastData.rate.toFixed(1)+'%/day</span></div>';
      content += '<div class="mp-forecast-popover-stat"><span>Days to complete</span><span>'+forecastData.daysToComplete+'d</span></div>';
      if (forecastData.daysEarly) {
        content += '<div class="mp-forecast-popover-stat"><span>Status</span><span style="color:var(--green)">'+forecastData.daysEarly+' days early</span></div>';
      } else if (forecastData.afterDeadline) {
        content += '<div class="mp-forecast-popover-stat"><span>Status</span><span style="color:var(--red)">After deadline</span></div>';
      }
      const historyDays = Math.round((Date.parse(history[history.length-1].date) - Date.parse(history[0].date)) / dayMs);
      content += '<div style="margin-top:8px;font-size:11px;color:var(--text3)">Based on '+history.length+' data points over '+historyDays+' days</div>';
      
      $('mpForecastPopoverContent').innerHTML = content;
      popover.style.display = 'block';
      popover.style.left = Math.max(10, r.left - w.left - 100) + 'px';
      popover.style.top = (r.bottom - w.top + 8) + 'px';
    });
  }
}

window.editCell=function(e,id,field){e.stopPropagation();const cell=e.currentTarget;if(cell.classList.contains('editing'))return;const item=data.find(d=>String(d.id)===String(id));if(!item)return;const currentValue=item[field]||'';cell.classList.add('editing');const inputType=field==='qty'?'number':'text';cell.innerHTML='<input type="'+inputType+'" value="'+esc(currentValue)+'" '+(field==='qty'?'min="1"':'')+'>';const input=cell.querySelector('input');input.focus();input.select();const saveValue=()=>{const newValue=field==='qty'?parseInt(input.value)||1:input.value.trim();if(item[field]!==newValue){item[field]=newValue;updateFieldTimestamp(item,field);markPartChanged(id,[field])}save();render()};input.onblur=saveValue;input.onkeydown=ev=>{if(ev.key==='Enter'){ev.preventDefault();saveValue()}if(ev.key==='Escape')render()}};

window.editCellAutocomplete=function(e,id,field){
  e.stopPropagation();
  const cell=e.currentTarget;
  if(cell.classList.contains('editing'))return;
  const item=data.find(d=>String(d.id)===String(id));
  if(!item)return;
  const currentValue=item[field]||'';
  const suggestions=field==='code'?getAllCodes():getAllMfrs();
  
  cell.classList.add('editing');
  cell.innerHTML='<div class="autocomplete-wrapper"><input type="text" value="'+esc(currentValue)+'" placeholder="Type to search..."><div class="autocomplete-list"></div></div>';
  const wrapper=cell.querySelector('.autocomplete-wrapper');
  const input=cell.querySelector('input');
  const list=cell.querySelector('.autocomplete-list');
  let selectedIdx=-1;
  
  function positionList(){
    const rect=wrapper.getBoundingClientRect();
    list.style.top=(rect.bottom+2)+'px';
    list.style.left=rect.left+'px';
    list.style.width=Math.max(rect.width,180)+'px';
  }
  
  function filterSuggestions(val){
    if(!val||!val.trim())return suggestions.slice(0,10);
    const v=val.toLowerCase();
    return suggestions.filter(s=>s.toLowerCase().includes(v)).slice(0,10);
  }
  
  function renderList(filtered,val){
    if(!filtered.length){list.classList.remove('open');list.innerHTML='';return}
    list.innerHTML=filtered.map((s,i)=>{
      let highlighted=esc(s);
      if(val&&val.trim()){
        const idx=s.toLowerCase().indexOf(val.toLowerCase());
        if(idx>=0)highlighted=esc(s.substring(0,idx))+'<em>'+esc(s.substring(idx,idx+val.length))+'</em>'+esc(s.substring(idx+val.length));
      }
      return '<div class="autocomplete-item'+(i===selectedIdx?' selected':'')+'" data-val="'+esc(s)+'">'+highlighted+'</div>';
    }).join('');
    positionList();
    list.classList.add('open');
    list.querySelectorAll('.autocomplete-item').forEach((el,i)=>{
      el.onmousedown=ev=>{ev.preventDefault();ev.stopPropagation();input.value=el.dataset.val;saveValue()};
    });
  }
  
  input.focus();input.select();
  
  // Find existing part with same code to auto-fill name and mfr
  function findMatchingPart(code){
    if(!code)return null;
    return data.find(d=>!d.isAsm&&d.id!==id&&d.code&&d.code.toLowerCase()===code.toLowerCase());
  }
  
  const saveValue=()=>{
    list.classList.remove('open');
    const newValue=input.value.trim();
    item[field]=newValue;
    if(newValue){
      if(field==='code'){
        addGlobalCode(newValue);
        // Auto-fill name and mfr from existing part with same code
        const match=findMatchingPart(newValue);
        if(match){
          if(match.name&&(!item.name||item.name==='New Part'))item.name=match.name;
          if(match.mfr&&!item.mfr)item.mfr=match.mfr;
        }
      }else if(field==='mfr'){
        addGlobalMfr(newValue);
      }
    }
    save();render();
  };
  
  input.oninput=()=>{selectedIdx=-1;renderList(filterSuggestions(input.value),input.value)};
  input.onfocus=()=>{renderList(filterSuggestions(input.value),input.value)};
  input.onblur=()=>setTimeout(saveValue,200);
  input.onkeydown=ev=>{
    const filtered=filterSuggestions(input.value);
    if(ev.key==='ArrowDown'){ev.preventDefault();selectedIdx=Math.min(selectedIdx+1,filtered.length-1);renderList(filtered,input.value)}
    else if(ev.key==='ArrowUp'){ev.preventDefault();selectedIdx=Math.max(selectedIdx-1,-1);renderList(filtered,input.value)}
    else if(ev.key==='Enter'){ev.preventDefault();if(selectedIdx>=0&&filtered[selectedIdx])input.value=filtered[selectedIdx];saveValue()}
    else if(ev.key==='Escape')render();
    else if(ev.key==='Tab'&&selectedIdx>=0&&filtered[selectedIdx]){input.value=filtered[selectedIdx]}
  };
  // Show suggestions immediately on open
  setTimeout(()=>renderList(filterSuggestions(currentValue),currentValue),50);
};

window.editCellAssignee=function(e,id){e.stopPropagation();const cell=e.currentTarget;if(cell.classList.contains('editing'))return;const item=data.find(d=>String(d.id)===String(id));if(!item)return;cell.classList.add('editing');const opts='<option value="">â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(t.name===item.assignee?' selected':'')+'>'+esc(t.name)+'</option>').join('');cell.innerHTML='<select>'+opts+'</select>';const select=cell.querySelector('select');select.focus();const saveValue=()=>{if(item.assignee!==select.value){item.assignee=select.value;updateFieldTimestamp(item,'assignee');markPartChanged(id,['assignee'])}save();render()};select.onblur=saveValue;select.onchange=saveValue;select.onkeydown=ev=>{if(ev.key==='Escape')render()}};

function generateReport(){
  const today=new Date();const dateStr=today.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const parts=getParts(),asms=getAsms();
  const pct=calcOverallProgress(),expected=getExpectedProgress(),daysLeft=getDaysLeft();
  const toOrder=parts.filter(p=>p.status==='to-order');
  const ordered=parts.filter(p=>p.status==='ordered');
  const installed=parts.filter(p=>p.status==='installed');
  const overdueActions=getActions().filter(a=>a.status!=='completed'&&a.due&&a.due<today.toISOString().split('T')[0]);
  const forecast=getVelocityForecast();const otd=calcSupplierOTD();

  let status='ðŸŸ¢ ON TRACK',statusDetail='Project progressing as planned.';
  if(expected&&pct<expected-10){status='ðŸ”´ BEHIND SCHEDULE';statusDetail='Project is '+(expected-pct)+'% behind expected progress.'}
  else if(expected&&pct>=expected+5){status='ðŸŸ¢ AHEAD OF SCHEDULE';statusDetail='Project is '+(pct-expected)+'% ahead of target.'}

  let report=currentProjectName.toUpperCase()+'\nPROJECT STATUS REPORT\n'+'â•'.repeat(52)+'\n'+dateStr+'\n\nEXECUTIVE SUMMARY\n'+'â”€'.repeat(36)+'\nStatus: '+status+'\n'+statusDetail+'\n\nPROGRESS METRICS\n'+'â”€'.repeat(36)+'\nOverall Completion: '+pct+'%\n  â””â”€ '+installed.length+' of '+parts.length+' parts installed\n\n';
  if(expected!==null)report+='Expected Progress: '+expected+'%\nVariance: '+(pct>=expected?'+':'')+(pct-expected)+'%\n';
  if(daysLeft!==null)report+='Days Remaining: '+daysLeft+'\n';
  report+='\nVELOCITY FORECAST\n'+'â”€'.repeat(36)+'\n';
  if(forecast&&forecast.rate>0)report+='Current Rate: '+forecast.rate.toFixed(1)+'% per day\nEst. Completion: '+formatDateShort(forecast.estDate)+'\nDays Required: '+forecast.daysToComplete+'\n'+(daysLeft!==null?'Buffer: '+(forecast.daysToComplete<=daysLeft?'+':'')+(daysLeft-forecast.daysToComplete)+' days\n':'')+'\nStatus: '+(forecast.status==='ahead'?'âœ“ Ahead of schedule':forecast.status==='on-track'?'âœ“ On track':forecast.status==='behind'?'âš  Slightly behind':'âš  At risk')+'\n';
  else report+='Insufficient data for velocity forecast\n';
  report+='\nSUPPLIER PERFORMANCE\n'+'â”€'.repeat(36)+'\nOn-Time Delivery: '+(otd!==null?otd+'%':'No data yet')+'\nAverage Lead Time: '+(calcAvgLeadTime()||'â€”')+' days\n';
  report+='\nASSEMBLY STATUS\n'+'â”€'.repeat(36)+'\n'+asms.map(a=>{const prog=calcAsmProgress(a.id);const statusIcon=prog===100?'âœ“':prog>=50?'â—':'â—‹';return statusIcon+' '+a.name.substring(0,30).padEnd(30)+' '+String(prog).padStart(3)+'%'}).join('\n')+'\n';
  if(toOrder.length)report+='\nâš  AWAITING ORDER ('+toOrder.length+')\n'+'â”€'.repeat(36)+'\n'+toOrder.slice(0,8).map(p=>'  â€¢ '+p.name+(p.code?' ['+p.code+']':'')).join('\n')+(toOrder.length>8?'\n  ... and '+(toOrder.length-8)+' more':'')+'\n';
  if(ordered.length)report+='\nðŸ“¦ IN TRANSIT ('+ordered.length+')\n'+'â”€'.repeat(36)+'\n'+ordered.slice(0,8).map(p=>{const eta=getPartETA(p);return'  â€¢ '+p.name+' â€” ETA: '+eta.display}).join('\n')+(ordered.length>8?'\n  ... and '+(ordered.length-8)+' more':'')+'\n';
  if(overdueActions.length)report+='\nðŸš¨ OVERDUE ACTIONS ('+overdueActions.length+')\n'+'â”€'.repeat(36)+'\n'+overdueActions.map(a=>'  â€¢ '+a.task+'\n    Due: '+a.due+' | '+(a.assignee||'Unassigned')).join('\n')+'\n';
  report+='\n'+'â•'.repeat(52)+'\nGenerated: '+new Date().toLocaleString();
  return report;
}


window.loadBom=function(bomId){const bom=savedBoms.find(b=>String(b.id)===String(bomId));if(!bom)return;if(!confirm('Load "'+bom.name+'"?'))return;currentProjectName=bom.name;data=[];expanded={};history=[];const asmMap={};bom.items.filter(i=>i.isAsm).forEach((item,idx)=>{const asmId=generateId();asmMap[item.name]=asmId;data.push({id:asmId,name:item.name,isAsm:true,assignee:'',priority:idx+1});expanded[String(asmId)]=true;dirtyAsms.add(asmId)});bom.items.filter(i=>!i.isAsm).forEach(item=>{const parentId=asmMap[item.parent]||null;const partId=generateId();data.push({id:partId,name:item.name,code:item.code||'',mfr:item.mfr||'',qty:item.qty||1,assignee:'',parentId,status:'waiting',changedAt:Date.now()});dirtyParts.add(partId)});dirtyMeta=true;save();render();closeModal('bomModal');toast('Loaded: '+bom.name)};
window.delBom=function(bomId,e){
  deleteTarget={id:bomId,type:'bom'};
  const bom=savedBoms.find(b=>String(b.id)===String(bomId));
  const name=bom?bom.name:'Specification';
  $('deleteMsg').innerHTML='Delete "<strong>'+esc(name)+'</strong>"?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};
window.saveBom=function(){const name=$('bomName').value.trim();if(!name){toast('Enter name',1);return}const items=[];const asms=getAsms();asms.forEach(asm=>{items.push({name:asm.name,isAsm:true});data.filter(d=>!d._deletedAt&&String(d.parentId)===String(asm.id)).forEach(p=>{items.push({name:p.name,code:p.code,mfr:p.mfr,qty:p.qty,parent:asm.name})})});savedBoms.push({id:generateId(),name,items});saveBoms();closeModal('bomModal');toast('Saved')};

window.clearStageFilter=()=>{filterStage='';render()};
window.clearAssigneeFilter=()=>{filterAssignee='';$('assigneeFilter').value='';render()};
window.clearPOFilter=()=>{filterPO='';render()};
window.togglePOFilter=(po,e)=>{e&&e.stopPropagation();filterPO=filterPO===po?'':po;render()};

window.showPODetails=(po,e)=>{
  e&&e.stopPropagation();
  const parts=data.filter(p=>p.poNumber===po);
  if(!parts.length)return;
  
  // Get first part's data for header info
  const firstPart=parts.find(p=>p.orderedAt)||parts[0];
  const supplier=parts.find(p=>p.supplier)?.supplier||'';
  const orderedDate=firstPart.orderedAt?new Date(firstPart.orderedAt).toLocaleDateString():'-';
  const expectedDate=firstPart.expectedArrival?new Date(firstPart.expectedArrival).toLocaleDateString():'-';
  
  $('poDetailsNumber').textContent=po;
  $('poDetailsSupplier').textContent=supplier;
  $('poDetailsOrdered').innerHTML='<strong>Ordered:</strong> '+orderedDate;
  $('poDetailsExpected').innerHTML='<strong>Expected:</strong> '+expectedDate;
  
  // Build items list
  let received=0,total=parts.length;
  let html='';
  parts.forEach(p=>{
    const isReceived=p.status!=='waiting'&&p.status!=='ordered';
    if(isReceived)received++;
    const recDate=p.arrivedAt?new Date(p.arrivedAt).toLocaleDateString().split('/').slice(0,2).join('.'):'â€”';
    html+='<div class="po-details-row">';
    html+='<div class="item-name"><span>'+esc(p.name)+'</span>'+(p.code?'<span class="item-code">'+esc(p.code)+'</span>':'')+'</div>';
    html+='<div class="qty">'+(p.qty||1)+'</div>';
    html+='<div class="status '+(isReceived?'received':'pending')+'">'+(isReceived?'<span>'+recDate+'</span> âœ“':'â€”')+'</div>';
    html+='</div>';
  });
  $('poDetailsList').innerHTML=html;
  
  // Summary
  const pct=Math.round((received/total)*100);
  $('poDetailsSummary').innerHTML='<span>'+received+' of '+total+' lines complete</span><div class="progress-bar"><div class="progress-fill" style="width:'+pct+'%"></div></div><span>'+pct+'%</span>';
  
  // Show/hide receive button
  const canReceive=parts.some(p=>p.status==='ordered');
  $('poDetailsReceiveAll').style.display=canReceive?'block':'none';
  $('poDetailsReceiveAll').onclick=()=>{
    const toReceive=parts.filter(p=>p.status==='ordered');
    if(!confirm('Receive '+toReceive.length+' item'+(toReceive.length>1?'s':'')+'?'))return;
    toReceive.forEach(p=>{
      p.status='arrived';
      p.arrivedAt=Date.now();
      p.changedAt=Date.now();
    });
    save();render();
    closeAllPopovers();
    toast('Received '+toReceive.length+' items','success');
  };
  
  // Position and show popover
  const popover=$('poDetailsPopover');
  const rect=e.target.getBoundingClientRect();
  
  // Calculate popover height (estimate if not yet visible)
  popover.style.visibility='hidden';
  popover.classList.add('open');
  const popoverHeight=popover.offsetHeight||300;
  const popoverWidth=popover.offsetWidth||360;
  popover.classList.remove('open');
  popover.style.visibility='';
  
  // Position vertically - show above if not enough space below
  let top=rect.bottom+8;
  if(top+popoverHeight>window.innerHeight-20){
    top=rect.top-popoverHeight-8;
    if(top<20)top=20; // Don't go above viewport
  }
  
  // Position horizontally
  let left=rect.left;
  if(left+popoverWidth>window.innerWidth-20){
    left=window.innerWidth-popoverWidth-20;
  }
  if(left<20)left=20;
  
  popover.style.top=top+'px';
  popover.style.left=left+'px';
  closeAllPopovers();
  popover.classList.add('open');
};
$('poDetailsClose').onclick=()=>$('poDetailsPopover').classList.remove('open');
document.addEventListener('click',e=>{
  const popover=$('poDetailsPopover');
  if(popover&&popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.eta-po')){
    popover.classList.remove('open');
  }
  const etaPop=$('etaPopover');
  if(etaPop&&etaPop.classList.contains('open')&&!etaPop.contains(e.target)&&!e.target.closest('.eta-date')){
    etaPop.classList.remove('open');editEtaPartId=null;
  }
});
function closeAllPopovers(){
  // Close popover modals
  ['partModal','asmModal','aiModal'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  // Close other popovers
  ['themeModal','reportModal','receivePOModal','commentsPopover','deletePopover','statusPopover','pendingPopover','poDetailsPopover','etaPopover','bulkStatusPopover','bulkAssigneePopover','bulkPOPopover','bulkDeletePopover','partInfoPopover'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  // Close gantt popups
  ['ganttColorPopup','ganttDatePopup'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
  $('popoverBackdrop').classList.remove('active');
}
function showPopoverModal(modal,btn){
  closeAllPopovers();
  $('popoverBackdrop').classList.add('active');
  if(btn){
    const rect=btn.getBoundingClientRect();
    const mw=320,mh=Math.min(modal.scrollHeight||400,window.innerHeight-100);
    let top=rect.top;
    let left=rect.right-mw-10;
    // Keep in viewport
    if(left<16)left=16;
    if(left+mw>window.innerWidth-16)left=window.innerWidth-mw-16;
    if(top+mh>window.innerHeight-50)top=Math.max(50,window.innerHeight-mh-50);
    modal.style.top=top+'px';
    modal.style.left=left+'px';
  }else{
    modal.style.top='50%';
    modal.style.left='50%';
    modal.style.transform='translate(-50%,-50%) scale(1)';
  }
  modal.classList.add('open');
}
function hidePopoverModal(modal){
  modal.classList.remove('open');
  modal.style.transform='';
  $('popoverBackdrop').classList.remove('active');
}
$('popoverBackdrop').onclick=(e)=>{
  // Only handle if click was directly on the backdrop, not on elements above it
  if(e.target!==$('popoverBackdrop'))return;
  hidePopoverModal($('partModal'));editId=null;
  hidePopoverModal($('asmModal'));editAsmId=null;
  if($('actionModal'))hidePopoverModal($('actionModal'));editActId=null;
  closeCmdWindow();
  $('themeModal').classList.remove('open');
  $('reportModal').classList.remove('open');
  $('receivePOModal').classList.remove('open');
  $('metricsPopover').classList.remove('open');
  $('poModal').classList.remove('open');pendingAdvPartId=null;
  $('labelModal').classList.remove('open');$('labelModal').style.transform='';
  $('commentsPopover').classList.remove('open');currentCommentPartId=null;
  $('deletePopover').classList.remove('open');deleteTarget={id:null,type:null};
  $('popoverBackdrop').classList.remove('active');
  $('mpForecastPopover').style.display='none';
};
// Close forecast popover when clicking outside
document.addEventListener('click',e=>{
  if(!e.target.closest('.mp-forecast-popover')&&!e.target.closest('.forecast-dot')){
    $('mpForecastPopover').style.display='none';
  }
});
window.editAsm=(id,e)=>{const a=data.find(d=>String(d.id)===String(id));if(!a)return;editAsmId=id;$('amTitle').textContent='Edit Assembly';$('amName').value=a.name;$('amAssignee').value=a.assignee||'';$('amNotes').value=a.notes||'';$('amNotify').disabled=!getTeamEmail(a.assignee);showPopoverModal($('asmModal'),e?e.target.closest('button'):null)};
window.editPart=(id,e)=>{const p=data.find(d=>String(d.id)===String(id));if(!p)return;editId=id;$('pmTitle').textContent='Edit Part';$('pmName').value=p.name;$('pmCode').value=p.code||'';$('pmMfr').value=p.mfr||'';$('pmQty').value=p.qty||1;$('pmAssignee').value=p.assignee||'';$('pmStatus').value=p.status;$('pmParent').value=p.parentId||'';$('pmNotes').value=p.notes||'';$('pmNotify').disabled=!getTeamEmail(p.assignee);showPopoverModal($('partModal'),e?e.target.closest('button'):null)};

let statusPopoverPartId=null;
window.openStatusPopover=(id,e)=>{
  e.stopPropagation();
  const p=data.find(d=>String(d.id)===String(id));if(!p)return;
  statusPopoverPartId=id;
  
  // Special handling for waiting status (previously pending)
  if(p.status==='waiting'){
    const popover=$('pendingPopover');
    $('pendingNoteInput').value=p.pendingNote||'';
    const rect=e.target.getBoundingClientRect();
    let top=rect.bottom+6;
    let left=rect.left;
    if(left+280>window.innerWidth)left=window.innerWidth-290;
    if(top+200>window.innerHeight)top=rect.top-210;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
    popover.classList.add('open');
    setTimeout(()=>$('pendingNoteInput').focus(),50);
    return;
  }
  
  const popover=$('statusPopover');
  const rect=e.target.getBoundingClientRect();
  let top=rect.bottom+6;
  let left=rect.left;
  if(left+140>window.innerWidth)left=window.innerWidth-150;
  if(top+200>window.innerHeight)top=rect.top-210;
  popover.style.top=Math.max(10,top)+'px';
  popover.style.left=Math.max(10,left)+'px';
  // Generate status options
  $('statusPopoverOptions').innerHTML=STAGES.map(s=>{
    const active=s===p.status?' style="background:var(--accent);color:#fff"':'';
    return '<div class="dropdown-item"'+active+' onclick="window.setPartStatus(\''+id+'\',\''+s+'\')">'+SLABELS[s]+'</div>';
  }).join('');
  popover.classList.add('open');
};

// Pending popover handlers
$('pendingYes').onclick=()=>{
  const p=data.find(d=>String(d.id)===String(statusPopoverPartId));
  if(!p)return;
  const note=$('pendingNoteInput').value.trim();
  if(note)p.pendingNote=note;
  // Move to "to-order" status (no PO modal needed yet)
  p.status='to-order';
  p.changedAt=Date.now();
  updateFieldTimestamp(p,'status');
  markPartChanged(statusPopoverPartId,['status']);
  $('pendingPopover').classList.remove('open');
  save();render();
  toast('â†’ To Order');
};

$('pendingNo').onclick=()=>{
  const p=data.find(d=>String(d.id)===String(statusPopoverPartId));
  if(!p)return;
  const note=$('pendingNoteInput').value.trim();
  if(note){
    p.pendingNote=note;
    updateFieldTimestamp(p,'pendingNote');
    markPartChanged(statusPopoverPartId,['pendingNote']);
    save();render();
    toast('Note saved');
  }
  $('pendingPopover').classList.remove('open');
};

window.setPartStatus=(id,status)=>{
  const p=data.find(d=>String(d.id)===String(id));if(!p)return;
  const now=Date.now();
  const oldStatus=p.status;
  if(oldStatus===status){$('statusPopover').classList.remove('open');return;}
  $('statusPopover').classList.remove('open');
  
  // If moving to "ordered" from "to-order", show PO popover
  if(oldStatus==='to-order'&&status==='ordered'){
    pendingAdvPartId=id;
    $('poPartName').textContent=p.name+(p.code?' ('+p.code+')':'');
    $('poNumber').value=p.poNumber||'';
    $('poArrivalDate').value=p.expectedArrival||'';
    const popover=$('poModal');
    // Position near the status badge
    const badge=document.querySelector('[data-part-id="'+id+'"] .status-badge');
    if(badge){
      const rect=badge.getBoundingClientRect();
      let top=rect.bottom+8;
      let left=rect.left;
      if(left+320>window.innerWidth)left=window.innerWidth-330;
      if(top+300>window.innerHeight)top=rect.top-310;
      popover.style.top=Math.max(10,top)+'px';
      popover.style.left=Math.max(10,left)+'px';
    }
    popover.classList.add('open');
    $('popoverBackdrop').classList.add('active');
    setTimeout(()=>$('poNumber').focus(),100);
    return;
  }
  
  if(oldStatus==='ordered'&&status==='arrived'&&p.orderedAt&&p.code){
    const days=Math.round((now-p.orderedAt)/86400000);
    if(days>0)recordLeadTime(p.code,days);
    p.arrivedAt=now;
  }
  if(status==='ordered'&&oldStatus!=='ordered')p.orderedAt=now;
  p.status=status;
  p.changedAt=now;
  updateFieldTimestamp(p,'status');
  markPartChanged(id,['status']);
  save();render();
  toast('â†’ '+SLABELS[status]);
};

// Close status popover on outside click
document.addEventListener('click',e=>{
  const popover=$('statusPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.status-badge')){
    popover.classList.remove('open');
  }
});

// Close pending popover on outside click
document.addEventListener('click',e=>{
  const popover=$('pendingPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.status-badge')){
    popover.classList.remove('open');
  }
});

let pendingAdvPartId=null;
window.advPart=(id,e)=>{
  const p=data.find(d=>String(d.id)===String(id));if(!p)return;
  const si=STAGES.indexOf(p.status),next=STAGES[si+1];
  if(!next)return;
  // If moving to "ordered" from "to-order", show PO popover
  if(p.status==='to-order'&&next==='ordered'){
    pendingAdvPartId=id;
    $('poPartName').textContent=p.name+(p.code?' ('+p.code+')':'');
    $('poNumber').value=p.poNumber||'';
    $('poArrivalDate').value=p.expectedArrival||'';
    const popover=$('poModal');
    if(e&&e.target){
      const rect=e.target.getBoundingClientRect();
      let top=rect.bottom+8;
      let left=rect.left;
      // Ensure it stays on screen
      if(left+320>window.innerWidth)left=window.innerWidth-330;
      if(top+300>window.innerHeight)top=rect.top-310;
      popover.style.top=Math.max(10,top)+'px';
      popover.style.left=Math.max(10,left)+'px';
    }
    popover.classList.add('open');
    $('popoverBackdrop').classList.add('active');
    setTimeout(()=>$('poNumber').focus(),100);
    return;
  }
  // Normal advancement
  advancePartStatus(id);
};

function advancePartStatus(id){
  const p=data.find(d=>String(d.id)===String(id));if(!p)return;
  const next=getNextStage(p);
  if(!next)return;
  const oldStatus=p.status;
  // Record lead time when transitioning from ordered to arrived
  if(p.status==='ordered'&&next==='arrived'&&p.orderedAt){
    const days=Math.round((Date.now()-p.orderedAt)/86400000);
    if(p.code&&days>0)recordLeadTime(p.code,days);
    p.arrivedAt=Date.now();
    // Log arrival event
    const wasLate=p.expectedArrival&&new Date(p.expectedArrival)<new Date();
    const daysDelta=p.expectedArrival?Math.round((Date.now()-new Date(p.expectedArrival).getTime())/86400000):null;
    logArrival(p,days,wasLate,daysDelta);
    // Log ETA miss if late
    if(wasLate&&p.expectedArrival){
      logEtaMiss(p,p.expectedArrival,new Date().toISOString().split('T')[0],daysDelta);
    }
  }
  if(next==='ordered')p.orderedAt=Date.now();
  p.status=next;p.changedAt=Date.now();
  save();render();toast('â†’ '+SLABELS[next]);
}

let deleteTarget={id:null,type:null};
window.confirmDelete=(id,type,e)=>{
  if(e)e.stopPropagation();
  deleteTarget={id,type};
  const item=data.find(d=>String(d.id)===String(id));
  const name=item?item.name:'Item';
  let msg='Delete "<strong>'+esc(name)+'</strong>"?';
  if(type==='assembly'){
    const kids=data.filter(d=>!d._deletedAt&&String(d.parentId)===String(id));
    if(kids.length)msg+='<br><span style="color:var(--text3);font-size:11px">+'+kids.length+' part'+(kids.length>1?'s':'')+'</span>';
  }else if(type==='part'){
    const subParts=data.filter(d=>!d._deletedAt&&String(d.parentId)===String(id));
    if(subParts.length)msg+='<br><span style="color:var(--text3);font-size:11px">+'+subParts.length+' sub-part'+(subParts.length>1?'s':'')+'</span>';
  }
  $('deleteMsg').innerHTML=msg;
  
  // Position popover near the button
  const popover=$('deletePopover');
  popover.style.transform=''; // Reset any previous transform
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left;
    // Keep in viewport
    if(left+220>window.innerWidth)left=window.innerWidth-230;
    if(left<10)left=10;
    if(top+150>window.innerHeight)top=rect.top-160;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
  }else{
    popover.style.top='50%';
    popover.style.left='50%';
    popover.style.transform='translate(-50%,-50%)';
  }
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
};

window.copyPO=(po,e)=>{
  e.stopPropagation();
  navigator.clipboard.writeText(po);
  toast('Copied: '+po);
};

window.delTeam=(idx,e)=>{
  deleteTarget={id:idx,type:'team'};
  const member=team[idx];
  const name=member?member.name:'Member';
  $('deleteMsg').innerHTML='Remove "<strong>'+esc(name)+'</strong>" from team?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};
window.openDates=()=>{$('startDate').value=projectDates.start||'';$('endDate').value=projectDates.end||'';$('datesModal').classList.add('open')};

function sendNotify(item,isAsm){const email=getTeamEmail(item.assignee);if(!email)return;const status=isAsm?calcAsmProgress(item.id)+'%':SLABELS[item.status],subject=encodeURIComponent('Action Required: '+item.name),body=encodeURIComponent('Hi '+item.assignee+',\n\nItem: '+item.name+'\nStatus: '+status+'\n'+(item.notes?'Notes: '+item.notes+'\n':'')+'\nThanks!');window.location.href='mailto:'+email+'?subject='+subject+'&body='+body}

window.editAction=(id,e)=>{const a=actions.find(x=>String(x.id)===String(id));if(!a)return;editActId=id;$('actTitle').textContent='Edit Action';$('actTask').value=a.task;$('actLinkedPart').value=a.linkedPartId||'';$('actDue').value=a.due||'';$('actAssignee').value=a.assignee||'';$('actStatus').value=a.status;showPopoverModal($('actionModal'),e?e.target.closest('button'):null)};
window.advAction=id=>{const a=actions.find(x=>String(x.id)===String(id));if(!a)return;const si=ASTAGES.indexOf(a.status),next=ASTAGES[si+1];if(next){a.status=next;if(!a._fieldTs)a._fieldTs={};a._fieldTs.status=getServerAlignedTime();markActionChanged(id);save();render();toast('â†’ '+ALABELS[next])}};
window.delAction=(id,e)=>{
  deleteTarget={id,type:'action'};
  const item=actions.find(a=>String(a.id)===String(id));
  const name=item?item.task:'Action';
  $('deleteMsg').innerHTML='Delete "<strong>'+esc(name.substring(0,30))+(name.length>30?'...':'')+'</strong>"?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};

// Action plan removed - goToAction stub
window.goToAction=()=>{};
window.goToPart=partId=>{$('metricsPopover').classList.remove('open');document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="list"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('listPanel').classList.add('active');const part=data.find(d=>String(d.id)===String(partId));if(part&&part.parentId)expanded[String(part.parentId)]=true;highlightPartId=partId;render();setTimeout(()=>{const row=document.querySelector('[data-part-id="'+partId+'"]');if(row)row.scrollIntoView({behavior:'smooth',block:'center'})},50)};
window.goToAsm=asmId=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="list"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('listPanel').classList.add('active');expanded[String(asmId)]=true;highlightAsmId=asmId;render();setTimeout(()=>{const row=document.querySelector('[data-asm-id="'+asmId+'"]');if(row){row.scrollIntoView({behavior:'smooth',block:'center'});row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),5000)}},50)};
window.goToGanttAsm=(asmId,e)=>{e&&e.stopPropagation();document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="gantt"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('ganttPanel').classList.add('active');ganttExpanded[String(asmId)]=true;window._ganttScrolled=false;setTimeout(()=>{renderGantt();const row=document.querySelector('.gantt-sidebar-row[data-row-id="'+asmId+'"]');if(row){row.scrollIntoView({behavior:'smooth',block:'center'});row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),5000)}},50)};
let highlightAsmId=null;

const closeModal=id=>{const el=$(id);if(el)el.classList.remove('open')};
const openModal=id=>{const el=$(id);if(el)el.classList.add('open');else console.error('Modal not found:',id)};

// ============================================
// Command Prompt Window
// ============================================
let cmdWindowState={
  open:false,
  minimized:false,
  x:null,
  y:null,
  width:2100,
  height:1200,
  version:6
};

function openCmdWindow(){
  const win=$('cmdWindow');
  const btn=$('aiAlert');
  
  // Position in center-left area if not set
  if(cmdWindowState.x===null||cmdWindowState.x===undefined){
    // Position roughly 250px from left edge, 80px from top
    cmdWindowState.x=250;
    cmdWindowState.y=80;
  }
  
  // Ensure window stays within viewport
  const maxX=window.innerWidth-cmdWindowState.width-20;
  const maxY=window.innerHeight-cmdWindowState.height-20;
  cmdWindowState.x=Math.max(10,Math.min(cmdWindowState.x,maxX));
  cmdWindowState.y=Math.max(10,Math.min(cmdWindowState.y,maxY));
  
  // Apply position and size explicitly
  win.style.left=cmdWindowState.x+'px';
  win.style.top=cmdWindowState.y+'px';
  win.style.width=cmdWindowState.width+'px';
  win.style.height=cmdWindowState.height+'px';
  
  win.classList.add('open');
  win.classList.remove('minimized');
  $('cmdMinimized').classList.remove('active');
  cmdWindowState.open=true;
  cmdWindowState.minimized=false;
  
  // Button state - just add active class (rotates + to X)
  btn.classList.add('active');
  
  // Show suggested questions when opening
  const suggestions=$('cmdSuggestions');
  if(suggestions)suggestions.style.display='flex';
  
  $('cmdInput').focus();
  saveCmdWindowState();
}

function closeCmdWindow(){
  const win=$('cmdWindow');
  win.classList.remove('open');
  $('cmdMinimized').classList.remove('active');
  cmdWindowState.open=false;
  cmdWindowState.minimized=false;
  
  // Button state - remove active (rotates X back to +)
  const btn=$('aiAlert');
  btn.classList.remove('active');
  
  saveCmdWindowState();
}

function minimizeCmdWindow(){
  const win=$('cmdWindow');
  win.classList.remove('open');
  win.classList.add('minimized');
  $('cmdMinimized').classList.add('active');
  cmdWindowState.minimized=true;
  
  // Button stays active (X visible)
  saveCmdWindowState();
}

function restoreCmdWindow(){
  const win=$('cmdWindow');
  win.classList.add('open');
  win.classList.remove('minimized');
  $('cmdMinimized').classList.remove('active');
  cmdWindowState.minimized=false;
  
  $('cmdInput').focus();
  saveCmdWindowState();
}

function toggleCmdWindow(){
  if(cmdWindowState.open&&!cmdWindowState.minimized){
    closeCmdWindow();
  }else if(cmdWindowState.minimized){
    restoreCmdWindow();
  }else{
    openCmdWindow();
    // Show initial dashboard if no conversation
    if($('cmdBody').querySelectorAll('.cmd-line').length<=1){
      renderCmdDashboard();
    }
  }
}

function saveCmdWindowState(){
  try{
    localStorage.setItem('ebs-cmd-window',JSON.stringify(cmdWindowState));
  }catch(e){}
}

function loadCmdWindowState(){
  try{
    const saved=localStorage.getItem('ebs-cmd-window');
    if(saved){
      const s=JSON.parse(saved);
      // If version mismatch, clear old settings and use new defaults
      if(!s.version||s.version<6){
        localStorage.removeItem('ebs-cmd-window');
        return;
      }
      // Same version - use saved values
      if(s.x!==null&&s.x!==undefined)cmdWindowState.x=s.x;
      if(s.y!==null&&s.y!==undefined)cmdWindowState.y=s.y;
      if(s.width&&s.width>=800)cmdWindowState.width=s.width;
      if(s.height&&s.height>=500)cmdWindowState.height=s.height;
    }
  }catch(e){
    console.error('loadCmdWindowState error:',e);
  }
}
loadCmdWindowState();

// Drag functionality
let cmdDragging=false,cmdDragOffset={x:0,y:0};

function initCmdDrag(){
  const titlebar=$('cmdTitlebar');
  if(!titlebar)return;
  
  titlebar.addEventListener('mousedown',function(e){
    // Don't drag if clicking on controls
    if(e.target.closest('.cmd-controls'))return;
    if(e.target.tagName==='SELECT')return;
    if(e.target.tagName==='BUTTON')return;
    
    e.preventDefault();
    cmdDragging=true;
    const win=$('cmdWindow');
    const rect=win.getBoundingClientRect();
    cmdDragOffset.x=e.clientX-rect.left;
    cmdDragOffset.y=e.clientY-rect.top;
    document.body.style.userSelect='none';
    document.body.style.cursor='move';
  });
}
initCmdDrag();

document.addEventListener('mousemove',function(e){
  if(!cmdDragging)return;
  e.preventDefault();
  const win=$('cmdWindow');
  const newX=e.clientX-cmdDragOffset.x;
  const newY=e.clientY-cmdDragOffset.y;
  
  // Keep within bounds
  cmdWindowState.x=Math.max(0,Math.min(window.innerWidth-100,newX));
  cmdWindowState.y=Math.max(0,Math.min(window.innerHeight-50,newY));
  
  win.style.left=cmdWindowState.x+'px';
  win.style.top=cmdWindowState.y+'px';
});

document.addEventListener('mouseup',function(){
  if(cmdDragging){
    cmdDragging=false;
    document.body.style.userSelect='';
    document.body.style.cursor='';
    saveCmdWindowState();
  }
});

// Track resize
const cmdResizeObserver=new ResizeObserver(entries=>{
  for(const entry of entries){
    cmdWindowState.width=entry.contentRect.width;
    cmdWindowState.height=entry.contentRect.height;
    saveCmdWindowState();
  }
});
cmdResizeObserver.observe($('cmdWindow'));

// Render dashboard in cmd style
function renderCmdDashboard(){
  const parts=getParts();
  const asms=getAsms();
  const body=$('cmdBody');
  
  if(parts.length===0){
    body.innerHTML='<div class="cmd-line muted">No parts in project. Add assemblies and parts to see analysis.</div>';
    updateCmdSuggestions([]);
    return;
  }
  
  const pct=calcOverallProgress();
  const daysLeft=getDaysLeft();
  const byStatus={};
  parts.forEach(p=>byStatus[p.status]=(byStatus[p.status]||0)+1);
  
  let html='';
  html+='<div class="cmd-line">C:\\PROJECT\\'+currentProjectName.toUpperCase().replace(/\s+/g,'-')+'&gt;</div>';
  html+='<div class="cmd-line"></div>';
  html+='<div class="cmd-line">Project: <span class="cmd-link" onclick="window.scrollTo(0,0)">"'+esc(currentProjectName)+'"</span> - '+pct+'% complete</div>';
  html+='<div class="cmd-line">â”œâ”€ '+(byStatus.waiting||0)+' waiting, '+(byStatus['to-order']||0)+' to-order, '+(byStatus.ordered||0)+' ordered</div>';
  html+='<div class="cmd-line">â”œâ”€ '+(byStatus.arrived||0)+' arrived, '+(byStatus.installed||0)+' installed</div>';
  if(daysLeft!==null)html+='<div class="cmd-line">â””â”€ '+daysLeft+' days until deadline</div>';
  html+='<div class="cmd-line"></div>';
  
  // Insights as text with clickable actions
  const insights=generateAIInsights();
  window._cmdInsights=insights; // Store for click handlers
  if(insights.length>0&&!(insights.length===1&&insights[0].title==='All systems nominal')){
    insights.forEach((ins,idx)=>{
      if(ins.title==='All systems nominal')return;
      const colorClass=ins.level==='critical'?'error':ins.level==='warning'?'warning':ins.level==='success'?'success':'info';
      let line='[!] '+ins.title;
      if(ins.action&&ins.handler){
        line+=' <a class="cmd-link" href="#" onclick="window._cmdInsights['+idx+'].handler();return false;">'+ins.action+'</a>';
      }
      html+='<div class="cmd-line '+colorClass+'">'+line+'</div>';
      if(ins.desc)html+='<div class="cmd-line muted">    '+ins.desc+'</div>';
    });
  }else{
    html+='<div class="cmd-line success">[OK] All systems nominal</div>';
  }
  
  html+='<div class="cmd-line"></div>';
  html+='<div class="cmd-line muted">Click a suggestion or type your own question.</div>';
  
  body.innerHTML=html;
  body.scrollTop=body.scrollHeight;
  
  // Generate context-aware suggestions
  updateCmdSuggestions(generateCmdSuggestions(byStatus,daysLeft,insights));
}

function generateCmdSuggestions(byStatus,daysLeft,insights){
  const suggestions=[];
  
  // Always include general status
  suggestions.push('Give me a project status summary');
  
  // Based on current state
  if((byStatus['to-order']||0)>0){
    suggestions.push('Which parts should I order first?');
  }
  if((byStatus.ordered||0)>0){
    suggestions.push('Any parts arriving soon?');
  }
  if((byStatus.arrived||0)>0){
    suggestions.push('What parts are ready to install?');
  }
  if((byStatus.waiting||0)>3){
    suggestions.push('Why are so many parts waiting?');
  }
  
  // Based on insights
  const hasOverdue=insights.some(i=>i.title.includes('overdue')||i.title.includes('>5 days')||i.title.includes('>7d'));
  if(hasOverdue){
    suggestions.push('What are the biggest blockers?');
  }
  
  // Deadline-based
  if(daysLeft!==null&&daysLeft<14){
    suggestions.push('Will we meet the deadline?');
  }
  
  // Limit to 5 suggestions
  return suggestions.slice(0,5);
}

function updateCmdSuggestions(suggestions){
  const container=$('cmdSuggestions');
  if(!container)return;
  if(!suggestions||suggestions.length===0){
    container.innerHTML='';
    return;
  }
  container.innerHTML=suggestions.map(s=>
    '<button class="cmd-suggestion" onclick="window.askCmdQuestion(\''+esc(s).replace(/'/g,"\\'")+'\')">'+esc(s)+'</button>'
  ).join('');
}

window.askCmdQuestion=function(question){
  $('cmdInput').value=question;
  handleCmdAsk();
};

function addCmdLine(text,className){
  const body=$('cmdBody');
  const line=document.createElement('div');
  line.className='cmd-line'+(className?' '+className:'');
  line.innerHTML=text;
  body.appendChild(line);
  body.scrollTop=body.scrollHeight;
}

async function handleCmdAsk(){
  const input=$('cmdInput');
  const question=input.value.trim();
  if(!question)return;
  
  // Hide suggestions after first question
  const suggestions=$('cmdSuggestions');
  if(suggestions)suggestions.style.display='none';
  
  addCmdLine('&gt; '+esc(question),'prompt');
  input.value='';
  addCmdLine('Thinking...','muted');
  
  try{
    const response=await askAI(question);
    
    // Remove "Thinking..."
    const body=$('cmdBody');
    if(body.lastChild)body.removeChild(body.lastChild);
    
    // Format response for readability
    formatCmdResponse(response);
    addCmdLine('','');
  }catch(e){
    console.error('handleCmdAsk error:',e);
    const body=$('cmdBody');
    if(body.lastChild)body.removeChild(body.lastChild);
    addCmdLine('Error: Unable to get response. Please try again.','error');
  }
}

function formatCmdResponse(html){
  const tempDiv=document.createElement('div');
  tempDiv.innerHTML=html;
  
  // Check for ai-prose wrapper
  const prose=tempDiv.querySelector('.ai-prose');
  const content=prose||tempDiv;
  
  // Convert AI links to cmd-link style but preserve onclick handlers
  content.querySelectorAll('a.ai-part-link,a.ai-asm-link').forEach(link=>{
    link.className='cmd-link';
  });
  
  // Convert action buttons to cmd style
  content.querySelectorAll('.ai-action-btn').forEach(btn=>{
    btn.className='cmd-suggestion';
    btn.style.marginTop='4px';
    btn.style.display='inline-block';
  });
  
  // Try to parse structured content
  const paragraphs=content.querySelectorAll('p');
  const lists=content.querySelectorAll('ul,ol');
  const headings=content.querySelectorAll('h1,h2,h3,h4,h5,h6');
  
  addCmdLine('');
  
  // Helper to get HTML content preserving links
  function getContentWithLinks(node){
    // Clone node to avoid modifying original
    const clone=node.cloneNode(true);
    // Convert any remaining ai links
    clone.querySelectorAll('a').forEach(a=>{
      a.className='cmd-link';
    });
    return clone.innerHTML;
  }
  
  if(paragraphs.length>0||lists.length>0||headings.length>0){
    // Process structured HTML
    const processNode=(node)=>{
      if(node.nodeType===Node.TEXT_NODE){
        const text=node.textContent.trim();
        if(text)addCmdLine(text);
      }else if(node.nodeName==='P'){
        const hasLinks=node.querySelector('a');
        const hasButtons=node.querySelector('button,.ai-action-btn');
        if(hasLinks||hasButtons){
          // Preserve HTML for links
          addCmdLine('  '+getContentWithLinks(node));
        }else{
          const text=node.textContent.trim();
          if(text){
            const strong=node.querySelector('strong,b');
            if(strong&&node.textContent.startsWith(strong.textContent)){
              addCmdLine('â–º '+text,'info');
            }else{
              addCmdLine('  '+text);
            }
          }
        }
      }else if(node.nodeName==='UL'||node.nodeName==='OL'){
        node.querySelectorAll('li').forEach(li=>{
          const hasLinks=li.querySelector('a');
          if(hasLinks){
            addCmdLine('  â€¢ '+getContentWithLinks(li));
          }else{
            const text=li.textContent.trim();
            const strong=li.querySelector('strong,b');
            if(strong){
              addCmdLine('  â€¢ '+strong.textContent,'info');
              const rest=text.replace(strong.textContent,'').trim();
              if(rest)addCmdLine('    '+rest,'muted');
            }else{
              addCmdLine('  â€¢ '+text);
            }
          }
        });
      }else if(node.nodeName.match(/^H[1-6]$/)){
        addCmdLine('');
        addCmdLine('â•â•â• '+node.textContent.trim().toUpperCase()+' â•â•â•','warning');
        addCmdLine('');
      }else if(node.nodeName==='STRONG'||node.nodeName==='B'){
        addCmdLine('â–º '+node.textContent.trim(),'info');
      }else if(node.nodeName==='DIV'){
        const hasLinks=node.querySelector('a');
        const hasButtons=node.querySelector('button,.ai-action-btn');
        if(hasLinks||hasButtons){
          addCmdLine(getContentWithLinks(node));
        }else{
          node.childNodes.forEach(processNode);
        }
      }else if(node.nodeName==='BR'){
        addCmdLine('');
      }else if(node.nodeName==='A'){
        // Standalone link
        const clone=node.cloneNode(true);
        clone.className='cmd-link';
        addCmdLine(clone.outerHTML);
      }else if(node.nodeName==='BUTTON'){
        // Action button
        const clone=node.cloneNode(true);
        clone.className='cmd-suggestion';
        clone.style.cssText='margin-top:4px;display:inline-block';
        addCmdLine(clone.outerHTML);
      }
    };
    
    content.childNodes.forEach(processNode);
  }else{
    // Plain text fallback - but check for links first
    const hasLinks=content.querySelector('a');
    if(hasLinks){
      addCmdLine('  '+getContentWithLinks(content));
    }else{
      let text=content.textContent||content.innerText||'';
      text=text.replace(/\s+/g,' ').trim();
      
      const sentences=text.split(/(?<=[.!?])\s+/);
      let lineBuffer='';
      
      sentences.forEach(sentence=>{
        sentence=sentence.trim();
        if(!sentence)return;
        
        if(sentence.match(/^\d+\./)||sentence.match(/^[-â€¢*]/)){
          if(lineBuffer){
            addCmdLine('  '+lineBuffer);
            lineBuffer='';
          }
          addCmdLine('  '+sentence);
          return;
        }
        
        if(lineBuffer.length+sentence.length>70){
          if(lineBuffer)addCmdLine('  '+lineBuffer);
          lineBuffer=sentence;
        }else{
          lineBuffer+=(lineBuffer?' ':'')+sentence;
        }
      });
      
      if(lineBuffer)addCmdLine('  '+lineBuffer);
    }
  }
  
  addCmdLine('');
}

async function handleCmdTell(){
  // Hide suggestions after first question
  const suggestions=$('cmdSuggestions');
  if(suggestions)suggestions.style.display='none';
  
  addCmdLine('&gt; Tell me','prompt');
  addCmdLine('Analyzing project...','muted');
  
  try{
    const response=await generateAIReport('straight');
    
    // Remove "Analyzing..."
    const body=$('cmdBody');
    if(body.lastChild)body.removeChild(body.lastChild);
    
    // Convert HTML response to cmd-style text
    const tempDiv=document.createElement('div');
    tempDiv.innerHTML=response;
    
    // Helper to get content preserving links
    function getContentWithLinks(node){
      const clone=node.cloneNode(true);
      clone.querySelectorAll('a').forEach(a=>{
        a.className='cmd-link';
      });
      clone.querySelectorAll('.ai-action-btn').forEach(btn=>{
        btn.className='cmd-suggestion';
        btn.style.cssText='margin:4px 4px 0 0;display:inline-block';
      });
      return clone.innerHTML;
    }
    
    // Process sections
    const sections=tempDiv.querySelectorAll('.ai-report-section');
    if(sections.length>0){
      addCmdLine('');
      sections.forEach(section=>{
        const header=section.querySelector('.ai-report-header');
        if(header){
          addCmdLine('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”','muted');
          addCmdLine('â”‚  '+header.textContent.trim().padEnd(39)+'â”‚','info');
          addCmdLine('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜','muted');
        }
        section.querySelectorAll('.ai-report-item').forEach(item=>{
          const text=item.querySelector('.ai-report-text');
          if(text){
            const hasLinks=text.querySelector('a');
            const level=item.classList.contains('critical')?'error':
                        item.classList.contains('warning')?'warning':
                        item.classList.contains('success')?'success':'';
            
            if(hasLinks){
              // Preserve HTML with links
              addCmdLine('  â€¢ '+getContentWithLinks(text),level);
            }else{
              const strong=text.querySelector('strong');
              const meta=text.querySelector('.ai-report-meta');
              let mainText=strong?strong.textContent:'';
              addCmdLine('  â€¢ '+mainText,level);
              if(meta)addCmdLine('    '+meta.textContent,'muted');
            }
          }
        });
        addCmdLine('');
      });
    }else{
      // Use the general formatter
      formatCmdResponse(response);
    }
    addCmdLine('');
  }catch(e){
    console.error('handleCmdTell error:',e);
    const body=$('cmdBody');
    if(body.lastChild)body.removeChild(body.lastChild);
    addCmdLine('Error: Unable to get response. Please try again.','error');
  }
}

// Event listeners for cmd window
function initCmdWindowHandlers(){
  const closeBtn=$('cmdClose');
  const minBtn=$('cmdMinimize');
  const minBar=$('cmdMinimized');
  const askBtn=$('cmdAsk');
  const tellBtn=$('cmdTell');
  const input=$('cmdInput');
  const modelSel=$('cmdModelSelect');
  
  if(closeBtn)closeBtn.addEventListener('click',closeCmdWindow);
  if(minBtn)minBtn.addEventListener('click',minimizeCmdWindow);
  if(minBar)minBar.addEventListener('click',restoreCmdWindow);
  if(askBtn)askBtn.addEventListener('click',handleCmdAsk);
  if(tellBtn)tellBtn.addEventListener('click',handleCmdTell);
  if(input)input.addEventListener('keydown',e=>{if(e.key==='Enter')handleCmdAsk()});
  if(modelSel)modelSel.addEventListener('change',function(){selectedAIModel=this.value});
}
initCmdWindowHandlers();

$('aiAlert').onclick=(e)=>{toggleCmdWindow()};

// AI Workspace handlers
$('aiWorkspaceAskBtn').onclick=handleWorkspaceAsk;
$('aiWorkspaceTellBtn').onclick=handleWorkspaceTell;
$('aiWorkspaceQuestion').onkeydown=e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleWorkspaceAsk()}
};
$('aiWorkspaceQuestion').oninput=function(){
  this.style.height='auto';
  this.style.height=Math.min(this.scrollHeight,150)+'px';
};

$('reportBtn').onclick=async(e)=>{
  $('menuDrop').classList.remove('open'); // Close menu
  const popover=$('reportModal');
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  
  // Show empty state if no report generated yet
  if(!lastReportContent){
    showReportEmptyState();
  }
};

function showReportEmptyState(){
  $('reportModelBadge').textContent='';
  $('reportRefresh').disabled=true;
  $('reportContent').innerHTML=`
    <div class="report-empty">
      <button class="report-generate-btn" onclick="event.stopPropagation(); window.generateOpusReport()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 3v3m0 12v3m-9-9h3m12 0h3m-4.6-7.4l-2.1 2.1m-5.7 5.7l-2.1 2.1m0-9.9l2.1 2.1m5.7 5.7l2.1 2.1"/></svg>
        Generate Report
      </button>
    </div>
  `;
}

window.generateOpusReport=async function(){
  $('reportContent').innerHTML='<div class="report-loading"><div class="report-loading-spinner"></div><div class="report-loading-text">Generating comprehensive report with Opus 4.5...</div></div>';
  $('reportModelBadge').textContent='thinking...';
  $('reportRefresh').disabled=false;
  $('reportRefresh').classList.add('spinning');
  
  const context=buildFullProjectContext();
  
  try{
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({
      mode:'report',
      projectContext:context,
      maxChars:2000,
      style:'detailed',
      model:'claude-opus-4-5-20251101'
    });
    
    console.log('ðŸ¤– Report Model Verification:');
    console.log('   Requested: claude-opus-4-5-20251101');
    console.log('   Returned:', result.data?.model||'unknown');
    
    if(result.data?.success){
      const actualModel=result.data.model||'claude-opus-4-5-20251101';
      $('reportModelBadge').textContent=AI_MODELS[actualModel]?.name||actualModel;
      $('reportContent').innerHTML=formatReportResponse(result.data.content);
      lastReportContent=result.data.content;
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Report generation failed:',e);
    $('reportModelBadge').textContent='offline';
    // Fallback to local report
    const localReport=generateReport();
    $('reportContent').innerHTML='<div class="report-prose"><p style="color:var(--text3);margin-bottom:12px;font-size:12px">âš  AI unavailable - showing local report</p><pre style="white-space:pre-wrap;font-family:inherit;font-size:13px">'+esc(localReport)+'</pre></div>';
    lastReportContent=localReport;
  }
  
  $('reportRefresh').classList.remove('spinning');
}

function buildFullProjectContext(){
  const parts=getParts(),asms=getAsms();
  const pct=calcOverallProgress(),expected=getExpectedProgress(),daysLeft=getDaysLeft();
  const forecast=getVelocityForecast();
  const otd=calcSupplierOTD();
  const now=Date.now(),day=86400000;
  
  // Build comprehensive context
  const ctx={
    // Company context (condensed)
    company:{
      name:'Radar Systems Manufacturing',
      location:'Finland',
      customer:'UK sister company',
      rules:['Safety components need full testing','Parts >â‚¬5k need dual approval','RF parts need cal certs','International shipments +7-10d customs'],
      leadTimes:{stock:'3-7d',standard:'10-14d',custom:'3-4wk',rfSpecialized:'4-6wk'}
    },
    project:{
      name:currentProjectName,
      progress:pct,
      expected:expected,
      daysLeft:daysLeft,
      totalParts:parts.length,
      totalAssemblies:asms.length
    },
    counts:{
      waiting:parts.filter(p=>p.status==='waiting').length,
      'to-order':parts.filter(p=>p.status==='to-order').length,
      ordered:parts.filter(p=>p.status==='ordered').length,
      arrived:parts.filter(p=>p.status==='arrived').length,
      installed:parts.filter(p=>p.status==='installed').length,
      total:parts.length
    },
    assemblies:asms.map(a=>({
      name:a.name,
      progress:calcAsmProgress(a.id),
      partCount:parts.filter(p=>String(p.parentId)===String(a.id)).length,
      priority:a.priority||999
    })).sort((a,b)=>a.priority-b.priority),
    // ALL parts with full details (only non-empty fields)
    allParts:parts.map(p=>{
      const asm=asms.find(a=>String(a.id)===String(p.parentId));
      const daysInStatus=p.changedAt?Math.floor((now-p.changedAt)/day):0;
      const part={id:p.id,name:p.name,status:p.status,daysInStatus};
      if(asm?.name)part.assembly=asm.name;
      if(p.assignee)part.assignee=p.assignee;
      if(p.poNumber)part.poNumber=p.poNumber;
      if(p.mfr)part.mfr=p.mfr;
      if(p.code)part.code=p.code;
      if(p.qty&&p.qty>1)part.qty=p.qty;
      if(p.expectedArrival)part.expectedArrival=p.expectedArrival;
      if(p.pendingNote)part.pendingNote=p.pendingNote;
      if(p.notes)part.notes=p.notes;
      return part;
    }),
    stuck:parts.filter(p=>{
      const days=Math.floor((now-(p.changedAt||now))/day);
      return days>5&&p.status!=='installed';
    }).map(p=>({
      name:p.name,
      status:p.status,
      days:Math.floor((now-(p.changedAt||now))/day),
      assembly:asms.find(a=>String(a.id)===String(p.parentId))?.name||'Unassigned',
      assignee:p.assignee||''
    })),
    velocity:forecast?{
      rate:forecast.rate,
      daysToComplete:forecast.daysToComplete,
      status:forecast.status,
      estDate:forecast.estDate
    }:null,
    suppliers:getSupplierStats(),
    otdRate:otd,
    overdueActions:getActions().filter(a=>a.status!=='completed'&&a.due&&a.due<new Date().toISOString().split('T')[0]).map(a=>({
      task:a.task,
      due:a.due,
      assignee:a.assignee,
      daysOverdue:Math.floor((now-new Date(a.due))/day)
    })),
    upcomingActions:getActions().filter(a=>a.status!=='completed'&&a.due).sort((a,b)=>a.due.localeCompare(b.due)).slice(0,5).map(a=>({
      task:a.task,
      due:a.due,
      assignee:a.assignee
    })),
    workload:getWorkloadStats(),
    recentActivity:history.slice(-10).map(h=>({
      action:h.action,
      item:h.item,
      time:new Date(h.ts).toLocaleDateString()
    })),
    team:team.map(t=>({name:t.name,email:t.email}))
  };
  
  // TIMELINE CONFLICTS - resource scheduling conflicts
  const timelineConflicts=[];
  const asmWithDates=asms.filter(a=>a.ganttStart||a.ganttEnd||a.assignee).map(a=>{
    const asmParts=parts.filter(p=>String(p.parentId)===String(a.id));
    let startDate=a.ganttStart?new Date(a.ganttStart):null;
    let endDate=a.ganttEnd?new Date(a.ganttEnd):null;
    if(!startDate||!endDate){
      const orderedDates=asmParts.filter(p=>p.orderedAt).map(p=>p.orderedAt);
      const arrivedDates=asmParts.filter(p=>p.arrivedAt).map(p=>p.arrivedAt);
      if(!startDate&&orderedDates.length)startDate=new Date(Math.min(...orderedDates));
      if(!endDate&&arrivedDates.length)endDate=new Date(Math.max(...arrivedDates));
      if(!startDate)startDate=new Date();
      if(!endDate)endDate=new Date(startDate.getTime()+14*day);
    }
    return {id:a.id,name:a.name,assignee:a.assignee,startDate,endDate};
  }).filter(a=>a.assignee&&a.startDate&&a.endDate);
  
  for(let i=0;i<asmWithDates.length;i++){
    const a=asmWithDates[i];
    for(let j=i+1;j<asmWithDates.length;j++){
      const b=asmWithDates[j];
      if(a.assignee!==b.assignee)continue;
      if(a.startDate<=b.endDate&&a.endDate>=b.startDate){
        timelineConflicts.push({
          person:a.assignee,
          assembly1:a.name,
          dates1:a.startDate.toLocaleDateString()+' - '+a.endDate.toLocaleDateString(),
          assembly2:b.name,
          dates2:b.startDate.toLocaleDateString()+' - '+b.endDate.toLocaleDateString()
        });
      }
    }
  }
  if(timelineConflicts.length){
    ctx.timelineConflicts=timelineConflicts;
  }
  
  // MILESTONES
  if(milestones&&milestones.length){
    ctx.milestones=milestones.map(m=>({
      name:m.name,
      date:m.date,
      type:m.type,
      daysAway:Math.round((new Date(m.date)-new Date())/day)
    }));
  }
  
  return ctx;
}

function getSupplierStats(){
  const parts=getParts();
  const suppliers={};
  parts.forEach(p=>{
    if(p.mfr){
      if(!suppliers[p.mfr])suppliers[p.mfr]={total:0,installed:0,ordered:0};
      suppliers[p.mfr].total++;
      if(p.status==='installed')suppliers[p.mfr].installed++;
      if(p.status==='ordered')suppliers[p.mfr].ordered++;
    }
  });
  return Object.entries(suppliers).map(([name,s])=>({
    name,
    total:s.total,
    installed:s.installed,
    pending:s.ordered
  })).sort((a,b)=>b.total-a.total).slice(0,8);
}

function getWorkloadStats(){
  const parts=getParts();
  const workload={};
  parts.forEach(p=>{
    const assignee=p.assignee||'Unassigned';
    if(!workload[assignee])workload[assignee]={total:0,installed:0,pending:0};
    workload[assignee].total++;
    if(p.status==='installed')workload[assignee].installed++;
    else workload[assignee].pending++;
  });
  return Object.entries(workload).map(([name,w])=>({
    name,
    total:w.total,
    installed:w.installed,
    pending:w.pending
  })).sort((a,b)=>b.pending-a.pending).slice(0,6);
}

function formatReportResponse(text){
  let html=text;
  
  // Process charts BEFORE escaping
  // Bar chart
  html=html.replace(/\[CHART:bar:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)};
      });
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*40+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 400 '+h+'" width="400" style="margin:16px 0">';
      items.forEach((item,i)=>{
        const w=Math.round(item.val/max*200);
        const y=i*40+10;
        svg+='<text x="8" y="'+(y+24)+'" font-size="13" fill="var(--text2)">'+item.label+'</text>';
        svg+='<rect x="140" y="'+(y+8)+'" width="'+w+'" height="24" rx="6" fill="var(--accent)" opacity="0.75"/>';
        svg+='<text x="'+(150+w)+'" y="'+(y+26)+'" font-size="14" fill="var(--text)" font-weight="500">'+item.val+'</text>';
      });
      svg+='</svg>';
      return svg;
    }catch(e){return '';}
  });
  
  // Funnel chart
  html=html.replace(/\[CHART:funnel:([^\]]+)\]/g,(match,dataStr)=>{
    try{
      const items=dataStr.split(',').map(s=>{
        const [label,val]=s.split(':');
        return {label:label.trim(),val:parseInt(val)};
      });
      const max=Math.max(...items.map(i=>i.val),1);
      const h=items.length*44+20;
      let svg='<svg class="ai-mini-chart" viewBox="0 0 420 '+h+'" width="420" style="margin:16px 0">';
      items.forEach((item,i)=>{
        const w=Math.round(item.val/max*200);
        const x=(200-w)/2+120;
        const y=i*44+10;
        svg+='<text x="8" y="'+(y+26)+'" font-size="12" fill="var(--text3)">'+item.label+'</text>';
        svg+='<rect x="'+x+'" y="'+(y+8)+'" width="'+w+'" height="28" rx="6" fill="var(--s'+((i%6)+1)+')" opacity="0.85"/>';
        svg+='<text x="340" y="'+(y+28)+'" font-size="14" fill="var(--text)" font-weight="600">'+item.val+'</text>';
      });
      svg+='</svg>';
      return svg;
    }catch(e){return '';}
  });
  
  // Extract SVGs before escaping
  const svgParts=[];
  html=html.replace(/<svg[\s\S]*?<\/svg>/g,(match)=>{
    svgParts.push(match);
    return '{{SVG'+(svgParts.length-1)+'}}';
  });
  
  // Escape HTML
  html=esc(html);
  
  // Restore SVGs
  svgParts.forEach((v,i)=>{html=html.replace('{{SVG'+i+'}}',v);});
  
  // Replace [[Part Name]] with clickable links
  html=html.replace(/\[\[([^\]]+)\]\]/g,(match,partName)=>{
    // Try exact match first (case-insensitive)
    let part=getParts().find(p=>p.name.toLowerCase()===partName.toLowerCase().trim());
    
    // If no exact match, try partial match
    if(!part){
      const searchName=partName.toLowerCase().trim();
      part=getParts().find(p=>
        p.name.toLowerCase().includes(searchName) || 
        searchName.includes(p.name.toLowerCase())
      );
    }
    
    // If still no match, try matching just the first word
    if(!part){
      const firstWord=partName.toLowerCase().trim().split(/\s+/)[0];
      if(firstWord.length>3){
        part=getParts().find(p=>p.name.toLowerCase().startsWith(firstWord));
      }
    }
    
    if(part){
      return '<a class="ai-part-link" href="#" onclick="window.aiGoToPart(\''+part.id+'\',event);return false;">'+partName+'</a>';
    }
    return '<strong>'+partName+'</strong>';
  });
  
  // Replace {{Assembly Name}} with clickable links  
  html=html.replace(/\{\{([^\}]+)\}\}/g,(match,asmName)=>{
    // Skip our SVG placeholders
    if(asmName.startsWith('SVG'))return match;
    const asm=getAsms().find(a=>a.name.toLowerCase()===asmName.toLowerCase());
    if(asm){
      return '<a class="ai-asm-link" href="#" onclick="window.aiGoToAsm(\''+asm.id+'\');return false;">'+asmName+'</a>';
    }
    return '<strong>'+asmName+'</strong>';
  });
  
  // Replace **bold** with <strong>
  html=html.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  
  // Replace headers
  html=html.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  html=html.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  html=html.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  
  // Replace --- with divider
  html=html.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid var(--border);margin:20px 0">');
  
  // Replace bullet points
  html=html.replace(/^[â€¢\-\*] (.+)$/gm,'<li>$1</li>');
  
  // Wrap consecutive li elements in ul
  html=html.replace(/(<li>.*<\/li>\n?)+/g,(match)=>'<ul>'+match+'</ul>');
  
  // Replace numbered lists
  html=html.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
  
  // Handle ALL CAPS headers
  html=html.replace(/^([A-Z][A-Z\s&]+):?\s*$/gm,'<h2 style="margin-top:24px">$1</h2>');
  
  // Paragraphs - split by double newline
  const parts=html.split(/\n\n+/);
  const processed=parts.map(p=>{
    p=p.trim();
    if(!p)return '';
    if(p.startsWith('<'))return p;
    return '<p>'+p.replace(/\n/g,' ')+'</p>';
  }).filter(p=>p).join('\n');
  
  return '<div class="report-prose">'+processed+'</div>';
}

let lastReportContent='';

$('reportRefresh').onclick=async()=>{
  await window.generateOpusReport();
};
$('reportClose').onclick=()=>{$('reportModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
document.addEventListener('click',e=>{
  const popover=$('reportModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#reportBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});
$('reportCopy').onclick=()=>{
  const text=$('reportContent').innerText||lastReportContent;
  navigator.clipboard.writeText(text);
  toast('Copied');
};
$('reportEmail').onclick=()=>{
  const emails=team.map(t=>t.email).filter(e=>e).join(',');
  if(!emails){toast('No team emails',1);return}
  const text=$('reportContent').innerText||lastReportContent;
  const subject=encodeURIComponent(currentProjectName+' - Status Report');
  const body=encodeURIComponent(text);
  window.location.href='mailto:'+emails+'?subject='+subject+'&body='+body;
};

$('etaSave').onclick=()=>{if(!editEtaPartId)return;const part=data.find(d=>String(d.id)===String(editEtaPartId));if(!part)return;const val=$('etaDateInput').value;part.expectedArrival=val||undefined;part.manualEta=undefined;updateFieldTimestamp(part,'expectedArrival');markPartChanged(editEtaPartId,['expectedArrival']);save();render();$('etaPopover').classList.remove('open');editEtaPartId=null;toast('Saved')};
$('etaClear').onclick=()=>{if(!editEtaPartId)return;const part=data.find(d=>String(d.id)===String(editEtaPartId));if(!part)return;part.expectedArrival=undefined;part.manualEta=undefined;updateFieldTimestamp(part,'expectedArrival');markPartChanged(editEtaPartId,['expectedArrival']);save();render();$('etaPopover').classList.remove('open');editEtaPartId=null;toast('Cleared')};

$('bomClose').onclick=$('bomCancel').onclick=()=>closeModal('bomModal');
$('bomModal').onclick=e=>{if(e.target.id==='bomModal')closeModal('bomModal')};
$('bomSave').onclick=window.saveBom;

$('leadtimeBtn').onclick=()=>{renderLeadTimeModal();$('leadtimeModal').classList.add('open')};
$('ltClose').onclick=$('ltDone').onclick=()=>closeModal('leadtimeModal');
$('leadtimeModal').onclick=e=>{if(e.target.id==='leadtimeModal')closeModal('leadtimeModal')};
$('ltClear').onclick=()=>{if(confirm('Clear all?')){leadTimeDb={};saveLeadTime();renderLeadTimeModal();toast('Cleared')}};

// Item Code Configuration Modal
function renderItemConfigModal(){
  const codes=Object.keys(itemCodeConfig).sort();
  if(!codes.length){
    $('icList').innerHTML='<div class="itemconfig-empty">No item codes configured yet.<br>Add a code above to customize testing & configuration requirements.</div>';
    return;
  }
  let html='';
  codes.forEach(code=>{
    const cfg=itemCodeConfig[code];
    html+='<div class="itemconfig-item" data-code="'+esc(code)+'">';
    html+='<div class="itemconfig-item-header"><span class="itemconfig-code">'+esc(code)+'</span><button class="itemconfig-del" onclick="window.deleteItemConfig(\''+esc(code)+'\')">Ã—</button></div>';
    html+='<div class="itemconfig-options">';
    html+='<div class="itemconfig-opt"><label>Testing Required</label><input type="checkbox" '+(cfg.requiresTesting?'checked':'')+' onchange="window.updateItemConfig(\''+esc(code)+'\',\'requiresTesting\',this.checked)"></div>';
    html+='<div class="itemconfig-opt"><label>Tester</label><select onchange="window.updateItemConfig(\''+esc(code)+'\',\'tester\',this.value)"><option value="">â€” Any â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(cfg.tester===t.name?' selected':'')+'>'+esc(t.name)+'</option>').join('')+'</select></div>';
    html+='<div class="itemconfig-opt"><label>Config Required</label><input type="checkbox" '+(cfg.requiresConfig?'checked':'')+' onchange="window.updateItemConfig(\''+esc(code)+'\',\'requiresConfig\',this.checked)"></div>';
    html+='<div class="itemconfig-opt"><label>Configured By</label><select onchange="window.updateItemConfig(\''+esc(code)+'\',\'configuredBy\',this.value)"><option value="">â€” Any â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(cfg.configuredBy===t.name?' selected':'')+'>'+esc(t.name)+'</option>').join('')+'</select></div>';
    html+='</div></div>';
  });
  $('icList').innerHTML=html;
}

window.updateItemConfig=function(code,field,value){
  if(!itemCodeConfig[code])itemCodeConfig[code]={requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  itemCodeConfig[code][field]=value;
  saveItemCodeConfig();
  render(); // Re-render to update stage dots
};

window.deleteItemConfig=function(code){
  delete itemCodeConfig[code];
  saveItemCodeConfig();
  renderItemConfigModal();
  render();
  toast('Removed');
};

window.addItemConfig=function(){
  const input=$('icNewCode');
  const code=input.value.trim().toUpperCase();
  if(!code){toast('Enter code',1);return}
  if(itemCodeConfig[code]){toast('Already exists',1);return}
  itemCodeConfig[code]={requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  saveItemCodeConfig();
  input.value='';
  renderItemConfigModal();
  toast('Added');
};

$('itemConfigBtn').onclick=()=>{renderItemConfigModal();$('itemConfigModal').classList.add('open')};
$('icClose').onclick=$('icDone').onclick=()=>closeModal('itemConfigModal');
$('itemConfigModal').onclick=e=>{if(e.target.id==='itemConfigModal')closeModal('itemConfigModal')};
$('icAddBtn').onclick=window.addItemConfig;
$('icNewCode').onkeydown=e=>{if(e.key==='Enter')window.addItemConfig()};

// OTD Modal
window.showOTDModal=function(){
  const mfrData=calcOTDByMfr();
  const overallOTD=calcSupplierOTD();
  const avgLead=calcAvgLeadTime();
  
  let html='';
  if(!mfrData.length){
    html='<div class="otd-empty">No delivery data yet.<br><span style="font-size:11px">Data is collected when parts move from Ordered â†’ Arrived</span></div>';
  }else{
    // Overall summary
    html+='<div class="otd-item" style="background:var(--bg3);margin-bottom:16px"><div class="otd-mfr">Overall</div><div class="otd-stats"><div class="otd-stat"><span class="otd-stat-val" style="color:'+(overallOTD>=90?'var(--green)':overallOTD>=70?'var(--yellow)':'var(--red)')+'">'+(overallOTD||0)+'%</span><span class="otd-stat-label">OTD</span></div><div class="otd-stat"><span class="otd-stat-val">'+(avgLead||0)+'d</span><span class="otd-stat-label">Avg Lead</span></div></div></div>';
    // Per manufacturer
    mfrData.forEach(m=>{
      const color=m.otd>=90?'var(--green)':m.otd>=70?'var(--yellow)':'var(--red)';
      html+='<div class="otd-item"><div class="otd-mfr">'+esc(m.mfr)+'</div><div class="otd-stats"><div class="otd-stat"><span class="otd-stat-val" style="color:'+color+'">'+m.otd+'%</span><span class="otd-stat-label">OTD</span></div><div class="otd-stat"><span class="otd-stat-val">'+m.avgLead+'d</span><span class="otd-stat-label">Lead</span></div><div class="otd-stat"><span class="otd-stat-val" style="font-size:13px">'+m.total+'</span><span class="otd-stat-label">Parts</span></div><div class="otd-bar"><div class="otd-bar-fill" style="width:'+m.otd+'%;background:'+color+'"></div></div></div></div>';
    });
  }
  $('otdBody').innerHTML=html;
  $('otdModal').classList.add('open');
};

// OTD inline functions removed - suppliers section removed

$('otdClose').onclick=$('otdDone').onclick=()=>closeModal('otdModal');
$('otdModal').onclick=e=>{if(e.target.id==='otdModal')closeModal('otdModal')};

$('pmClose').onclick=$('pmCancel').onclick=()=>{hidePopoverModal($('partModal'));editId=null};
$('pmSave').onclick=()=>{
  const name=$('pmName').value.trim();if(!name){toast('Enter name',1);return}
  const now=Date.now();
  if(editId){
    const p=data.find(d=>String(d.id)===String(editId));
    if(p){
      const changedFields=[];
      const oldStatus=p.status;
      const newName=$('pmName').value.trim();
      const newCode=$('pmCode').value.trim();
      const newMfr=$('pmMfr').value.trim();
      const newQty=parseInt($('pmQty').value)||1;
      const newAssignee=$('pmAssignee').value;
      const newParentId=$('pmParent').value||null;  // Keep as string
      const newNotes=$('pmNotes').value.trim();
      const newStatus=$('pmStatus').value;
      
      if(p.name!==newName){p.name=newName;changedFields.push('name');}
      if(p.code!==newCode){p.code=newCode;changedFields.push('code');}
      if(p.mfr!==newMfr){p.mfr=newMfr;changedFields.push('mfr');}
      if(p.qty!==newQty){p.qty=newQty;changedFields.push('qty');}
      if(p.assignee!==newAssignee){p.assignee=newAssignee;changedFields.push('assignee');}
      if(String(p.parentId)!==String(newParentId)){p.parentId=newParentId;changedFields.push('parentId');}
      if(p.notes!==newNotes){p.notes=newNotes;changedFields.push('notes');}
      
      if(oldStatus!==newStatus){
        if(oldStatus==='ordered'&&newStatus==='arrived'&&p.orderedAt&&p.code){
          const days=Math.round((now-p.orderedAt)/86400000);
          if(days>0)recordLeadTime(p.code,days);
        }
        if(newStatus==='ordered')p.orderedAt=now;
        p.status=newStatus;
        p.changedAt=now;
        changedFields.push('status');
      }
      
      changedFields.forEach(f=>updateFieldTimestamp(p,f));
      if(changedFields.length)markPartChanged(editId,changedFields);
    }
    toast('Updated');
  }else{
    const id=generateId();
    const parentId=$('pmParent').value||null;  // Keep as string
    const part={id,name,code:$('pmCode').value.trim(),mfr:$('pmMfr').value.trim(),qty:parseInt($('pmQty').value)||1,assignee:$('pmAssignee').value,status:$('pmStatus').value,parentId,notes:$('pmNotes').value.trim(),changedAt:now,_fieldTs:{}};
    const serverTime=getServerAlignedTime();
    ['name','code','mfr','qty','assignee','status','parentId','notes'].forEach(f=>{if(part[f])part._fieldTs[f]=serverTime;});
    if(part.status==='ordered')part.orderedAt=now;
    data.push(part);
    dirtyParts.add(id);
    toast('Added');
  }
  save();render();hidePopoverModal($('partModal'));editId=null;
};


$('amClose').onclick=$('amCancel').onclick=()=>{hidePopoverModal($('asmModal'));editAsmId=null};
$('amSave').onclick=()=>{
  const name=$('amName').value.trim();if(!name){toast('Enter name',1);return}
  if(editAsmId){
    const a=data.find(d=>String(d.id)===String(editAsmId));
    if(a){
      a.name=name;a.assignee=$('amAssignee').value;a.notes=$('amNotes').value.trim();
      markAsmChanged(editAsmId,['name','assignee','notes']);
    }
    toast('Updated');
  }else{
    const asms=getAsms(),maxP=asms.length?Math.max(...asms.map(a=>a.priority||0)):0;
    const id=generateId();
    data.push({id,name,isAsm:true,assignee:$('amAssignee').value,notes:$('amNotes').value.trim(),priority:maxP+1});
    expanded[String(id)]=true;
    dirtyAsms.add(id);
    toast('Added');
  }
  save();render();hidePopoverModal($('asmModal'));editAsmId=null;
};


$('amNotify').onclick=()=>{if(editAsmId){const a=data.find(d=>String(d.id)===String(editAsmId));if(a)sendNotify(a,true)}};
$('amAssignee').onchange=()=>{$('amNotify').disabled=!getTeamEmail($('amAssignee').value)};
$('pmAssignee').onchange=()=>{$('pmNotify').disabled=!getTeamEmail($('pmAssignee').value)};
$('pmNotify').onclick=()=>{if(editId){const p=data.find(d=>String(d.id)===String(editId));if(p)sendNotify(p,false)}};

if($('actClose'))$('actClose').onclick=$('actCancel').onclick=()=>{if($('actionModal'))hidePopoverModal($('actionModal'));editActId=null};
if($('actSave'))$('actSave').onclick=()=>{
  const task=$('actTask').value.trim();if(!task){toast('Enter task',1);return}
  const newStatus=$('actStatus').value;
  const linkedPartVal=$('actLinkedPart').value;
  const linkedPartId=linkedPartVal?linkedPartVal:null;  // Keep as string
  const serverTime = getServerAlignedTime();
  if(editActId){
    const a=actions.find(x=>String(x.id)===String(editActId));
    if(a){
      // Track which fields changed for field-level merge
      if(!a._fieldTs) a._fieldTs = {};
      if(a.task !== task) { a.task=task; a._fieldTs.task = serverTime; }
      if(a.linkedPartId !== linkedPartId) { a.linkedPartId=linkedPartId; a._fieldTs.linkedPartId = serverTime; }
      if(a.due !== $('actDue').value) { a.due=$('actDue').value; a._fieldTs.due = serverTime; }
      if(a.assignee !== $('actAssignee').value) { a.assignee=$('actAssignee').value; a._fieldTs.assignee = serverTime; }
      if(a.status !== newStatus) { a.status=newStatus; a._fieldTs.status = serverTime; }
      markActionChanged(editActId);
    }
    toast('Updated');
  }else{
    const id=generateId();
    const newAction = {
      id,task,linkedPartId,
      due:$('actDue').value,
      assignee:$('actAssignee').value,
      status:newStatus,
      createdAt:new Date().toISOString().split('T')[0],
      _fieldTs: { task: serverTime, status: serverTime, assignee: serverTime, due: serverTime, linkedPartId: serverTime }
    };
    actions.push(newAction);
    dirtyActions.add(id);
    toast('Added');
  }
  save();render();if($('actionModal'))hidePopoverModal($('actionModal'));editActId=null;
};


if($('addActionBtn'))$('addActionBtn').onclick=(e)=>{};

$('teamBtn').onclick=()=>{renderTeamList();$('teamModal').classList.add('open')};
$('teamClose').onclick=$('teamDone').onclick=()=>closeModal('teamModal');
$('teamModal').onclick=e=>{if(e.target.id==='teamModal')closeModal('teamModal')};
$('teamAdd').onclick=()=>{const name=$('teamName').value.trim(),email=$('teamEmail').value.trim();if(!name||!email.includes('@')){toast('Enter name & email',1);return}if(team.find(t=>t.name===name)){toast('Exists',1);return}team.push({name,email});saveTeam();$('teamName').value='';$('teamEmail').value='';renderTeamList();updateSelects();toast('Added')};

// Milestones modal handlers
function renderMilestoneList(){
  $('milestoneList').innerHTML=!milestones.length?'<p style="color:var(--text3);text-align:center;padding:12px;font-size:10px">No milestones</p>':milestones.map((m,i)=>{
    const typeColors={deadline:'#e53935',delivery:'#4caf50',review:'#ff9800',custom:'#9c27b0'};
    const typeIcons={deadline:'ðŸ”´',delivery:'ðŸŸ¢',review:'ðŸŸ ',custom:'ðŸŸ£'};
    return '<div class="team-item"><div style="width:8px;height:8px;border-radius:2px;background:'+typeColors[m.type]+';margin-right:8px"></div><div class="team-item-info"><div style="font-weight:600">'+esc(m.name)+'</div><div style="font-size:10px;color:var(--text3)">'+formatDateShort(new Date(m.date))+' Â· '+typeIcons[m.type]+' '+m.type+'</div></div><button class="team-item-del" onclick="window.delMilestone('+i+',event)">Ã—</button></div>';
  }).join('');
}
$('milestonesBtn').onclick=()=>{renderMilestoneList();$('milestonesModal').classList.add('open')};
$('milestonesClose').onclick=$('milestonesDone').onclick=()=>closeModal('milestonesModal');
$('milestonesModal').onclick=e=>{if(e.target.id==='milestonesModal')closeModal('milestonesModal')};
$('milestoneAdd').onclick=()=>{
  const name=$('milestoneName').value.trim();
  const date=$('milestoneDate').value;
  const type=$('milestoneType').value;
  if(!name||!date){toast('Enter name & date',1);return}
  milestones.push({id:Date.now(),name,date,type});
  dirtyMeta=true;
  save();
  $('milestoneName').value='';
  $('milestoneDate').value='';
  renderMilestoneList();
  renderGantt();
  toast('Milestone added');
};
window.delMilestone=(idx,e)=>{
  e&&e.stopPropagation();
  milestones.splice(idx,1);
  dirtyMeta=true;
  save();
  renderMilestoneList();
  renderGantt();
  toast('Milestone deleted');
};

$('datesBtn').onclick=$('burndownEdit').onclick=window.openDates;
$('datesClose').onclick=$('datesCancel').onclick=()=>closeModal('datesModal');
$('datesSave').onclick=()=>{projectDates.start=$('startDate').value;projectDates.end=$('endDate').value;dirtyMeta=true;save();updateProjectIndex();render();renderGantt();closeModal('datesModal');toast('Project dates saved')};
$('datesModal').onclick=e=>{if(e.target.id==='datesModal')closeModal('datesModal')};

// PO Modal handlers
$('poClose').onclick=$('poCancel').onclick=()=>{$('poModal').classList.remove('open');$('popoverBackdrop').classList.remove('active');pendingAdvPartId=null};
$('poSave').onclick=()=>{
  if(pendingAdvPartId){
    const p=data.find(d=>String(d.id)===String(pendingAdvPartId));
    if(p){
      p.poNumber=$('poNumber').value.trim()||null;
      p.expectedArrival=$('poArrivalDate').value||null;
      updateFieldTimestamp(p,'poNumber');
      updateFieldTimestamp(p,'expectedArrival');
      markPartChanged(pendingAdvPartId,['poNumber','expectedArrival']);
      advancePartStatus(pendingAdvPartId);
    }
  }
  $('poModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  pendingAdvPartId=null;
};

// Receive PO Modal handlers
function updatePOSuggestions(){
  const poNumbers=[...new Set(data.filter(d=>d.poNumber&&d.status==='ordered').map(d=>d.poNumber))];
  $('poSuggestions').innerHTML=poNumbers.map(po=>'<option value="'+esc(po)+'">').join('');
}
function updateReceivePOPreview(){
  const po=$('receivePONumber').value.trim();
  if(!po){
    $('receivePOPreview').innerHTML='<div class="receive-po-empty">Enter a PO number to see matching parts</div>';
    $('receivePOConfirm').disabled=true;
    return;
  }
  const matchingParts=data.filter(d=>d.poNumber===po&&d.status==='ordered');
  if(!matchingParts.length){
    $('receivePOPreview').innerHTML='<div class="receive-po-empty">No ordered parts found with PO: '+esc(po)+'</div>';
    $('receivePOConfirm').disabled=true;
    return;
  }
  $('receivePOPreview').innerHTML='<div class="receive-po-count"><span>'+matchingParts.length+'</span> part'+(matchingParts.length!==1?'s':'')+' will be marked as arrived</div><div class="receive-po-list">'+matchingParts.map(p=>'<div class="receive-po-item"><span class="receive-po-item-name">'+esc(p.name)+'</span><span class="receive-po-item-status ordered">Ordered</span></div>').join('')+'</div>';
  $('receivePOConfirm').disabled=false;
}
$('receivePOBtn').onclick=(e)=>{
  updatePOSuggestions();
  $('receivePONumber').value='';
  updateReceivePOPreview();
  const popover=$('receivePOModal');
  const btn=e.target.closest('button');
  const rect=btn.getBoundingClientRect();
  popover.style.top=(rect.bottom+8)+'px';
  popover.style.left=Math.max(10,rect.right-320)+'px';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>$('receivePONumber').focus(),100);
};
$('receivePONumber').oninput=updateReceivePOPreview;
$('receivePOClose').onclick=$('receivePOCancel').onclick=()=>{$('receivePOModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
$('receivePOConfirm').onclick=()=>{
  const po=$('receivePONumber').value.trim();
  if(!po)return;
  const matchingParts=data.filter(d=>d.poNumber===po&&d.status==='ordered');
  if(!matchingParts.length)return;
  const today=new Date().toISOString().split('T')[0];
  matchingParts.forEach(p=>{
    // Record lead time if we have orderedDate
    if(p.orderedDate&&p.code){
      const orderDate=new Date(p.orderedDate);
      const arriveDate=new Date(today);
      const days=Math.round((arriveDate-orderDate)/(86400000));
      if(days>0&&days<365)recordLeadTime(p.code,days);
    }
    p.status='arrived';
    p.arrivedDate=today;
    p.changedAt=Date.now();
    updateFieldTimestamp(p,'status');
    markPartChanged(p.id,['status']);
  });
  save();
  render();
  $('receivePOModal').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  toast(matchingParts.length+' part'+(matchingParts.length!==1?'s':'')+' received');
};
// Close receive PO popover when clicking outside
document.addEventListener('click',e=>{
  const popover=$('receivePOModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#receivePOBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});

// Delete confirmation popover handlers
function closeDeletePopover(){$('deletePopover').classList.remove('open');$('popoverBackdrop').classList.remove('active');deleteTarget={id:null,type:null}}
$('deleteCancel').onclick=(e)=>{e.stopPropagation();closeDeletePopover()};
$('deleteConfirm').onclick=(e)=>{
  e.stopPropagation();
  e.preventDefault();
  
  // Capture values immediately before any async operations could reset them
  const targetId=deleteTarget.id;
  const targetType=deleteTarget.type;
  
  if(targetId===null||targetId===undefined){
    closeDeletePopover();
    return;
  }
  
  if(targetType==='action'){
    markActionDeleted(targetId);
    const action = actions.find(a=>String(a.id)===String(targetId));
    if(action) action._deletedAt = Date.now();
    save();render();
  }else if(targetType==='team'){
    team.splice(targetId,1);
    saveTeam();renderTeamList();updateSelects();
  }else if(targetType==='bom'){
    savedBoms=savedBoms.filter(b=>String(b.id)!==String(targetId));
    saveBoms();renderBomList();
  }else{
    const item=data.find(d=>String(d.id)===String(targetId));
    if(item){
      // Mark for deletion (writes tombstone to Firebase)
      if(item.isAsm){
        markDeleted('asm',targetId);
        item._deletedAt = Date.now();
        // Also mark child parts for deletion
        data.filter(d=>String(d.parentId)===String(targetId)).forEach(child=>{
          markDeleted('part',child.id);
          child._deletedAt = Date.now();
        });
      }else{
        markDeleted('part',targetId);
        item._deletedAt = Date.now();
        // Also mark sub-parts for deletion
        data.filter(d=>String(d.parentId)===String(targetId)).forEach(child=>{
          markDeleted('part',child.id);
          child._deletedAt = Date.now();
        });
      }
      delete expanded[String(targetId)];
      save();render();
    }
  }
  toast('Deleted');
  closeDeletePopover();
};
// Delete close handled by backdrop

$('menuBtn').onclick=e=>{
  e.stopPropagation();
  $('menuDrop').classList.toggle('open');
};
document.addEventListener('click',e=>{
  if($('menuDrop').classList.contains('open')&&!e.target.closest('.dropdown')){
    $('menuDrop').classList.remove('open');
  }
  // Close project dropdown when clicking outside
  if($('projectDropdown').classList.contains('open')&&!e.target.closest('.project-selector')){
    closeProjectDropdown();
  }
});

// Project selector handlers
$('projectSelectorBtn').onclick=e=>{
  e.stopPropagation();
  toggleProjectDropdown();
};

$('projectDropdownList').onclick=e=>{
  const item=e.target.closest('.project-dropdown-item');
  if(item){
    const projectId=item.dataset.projectId;
    if(projectId)switchProject(projectId);
  }
};

$('newProjectBtn').onclick=()=>{
  closeProjectDropdown();
  openModal('newProjectModal');
};

$('manageProjectsBtn').onclick=()=>{
  closeProjectDropdown();
  openModal('manageProjectsModal');
  renderManageProjectsList();
};

// New Project Modal handlers
$('newProjectModal').onclick=e=>{if(e.target.id==='newProjectModal')closeModal('newProjectModal')};
$('newProjectClose').onclick=()=>closeModal('newProjectModal');
$('newProjectCancel').onclick=()=>closeModal('newProjectModal');
$('newProjectCreate').onclick=async ()=>{
  const name=$('newProjectName').value.trim();
  if(!name){toast('Enter a project name',1);return}
  
  // Generate new project ID
  const projectId=generateProjectId();
  console.log('Creating project:', projectId, name);
  
  // Create project in Firebase
  const newProjectRef=db.ref('projects/'+projectId);
  
  try{
    // Initialize project with minimal data
    console.log('Writing to projects/'+projectId+'/meta...');
    await newProjectRef.child('meta').set({
      name:name,
      projectDates:{start:'',end:''},
      milestones:[],
      schemaVersion:2,
      createdAt:firebase.database.ServerValue.TIMESTAMP,
      updatedAt:firebase.database.ServerValue.TIMESTAMP
    });
    console.log('Meta written successfully');
    
    // Add to project index
    console.log('Writing to global/projectIndex/'+projectId+'...');
    await globalRef.child('projectIndex/'+projectId).set({
      name:name,
      archived:false,
      createdAt:firebase.database.ServerValue.TIMESTAMP,
      updatedAt:firebase.database.ServerValue.TIMESTAMP
    });
    console.log('Project index written successfully');
    
    closeModal('newProjectModal');
    $('newProjectName').value='';
    toast('Project created');
    
    // Switch to new project
    switchProject(projectId);
    
  }catch(e){
    console.error('Failed to create project:',e);
    console.error('Error code:', e.code);
    console.error('Error message:', e.message);
    toast('Failed: '+(e.message||'Unknown error'),1);
  }
};

// Manage Projects Modal handlers
$('manageProjectsModal').onclick=e=>{if(e.target.id==='manageProjectsModal')closeModal('manageProjectsModal')};
$('manageProjectsClose').onclick=()=>closeModal('manageProjectsModal');
$('manageProjectsDone').onclick=()=>closeModal('manageProjectsModal');
$('showArchivedProjects').onchange=()=>renderManageProjectsList();

let renameProjectId=null;
let deleteProjectId=null;

function renderManageProjectsList(){
  const list=$('manageProjectsList');
  const showArchived=$('showArchivedProjects').checked;
  
  const projects=Object.entries(projectIndex)
    .map(([id,proj])=>({id,...proj}))
    .filter(p=>showArchived||!p.archived)
    .sort((a,b)=>{
      if(a.archived!==b.archived)return a.archived?1:-1;
      return(a.name||'').localeCompare(b.name||'');
    });
  
  if(projects.length===0){
    list.innerHTML='<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px">No projects</div>';
    return;
  }
  
  list.innerHTML=projects.map(proj=>{
    const isActive=proj.id===currentProjectCode;
    const archivedBadge=proj.archived?'<span class="manage-project-item-archived">Archived</span>':'';
    const archiveBtn=proj.archived
      ?'<button onclick="window.unarchiveProject(\''+proj.id+'\')" title="Unarchive">ðŸ“¤</button>'
      :'<button onclick="window.archiveProject(\''+proj.id+'\')" title="Archive">ðŸ“¥</button>';
    const dateStr=proj.createdAt?new Date(proj.createdAt).toLocaleDateString():'';
    
    return '<div class="manage-project-item">'+
      '<div style="flex:1">'+
        '<div class="manage-project-item-name">'+esc(proj.name||'Untitled')+archivedBadge+(isActive?' <span style="color:var(--accent);font-size:11px">(current)</span>':'')+'</div>'+
        '<div class="manage-project-item-date">Created: '+dateStr+'</div>'+
      '</div>'+
      '<div class="manage-project-item-actions">'+
        '<button onclick="window.renameProject(\''+proj.id+'\',\''+esc(proj.name||'').replace(/'/g,"\\'")+'\')" title="Rename">âœï¸</button>'+
        archiveBtn+
        (isActive?'':'<button class="danger" onclick="window.confirmDeleteProject(\''+proj.id+'\',\''+esc(proj.name||'').replace(/'/g,"\\'")+'\')" title="Delete">ðŸ—‘ï¸</button>')+
      '</div>'+
    '</div>';
  }).join('');
}

window.renameProject=(id,currentName)=>{
  renameProjectId=id;
  $('renameProjectName').value=currentName;
  openModal('renameProjectModal');
};

window.archiveProject=async(id)=>{
  try{
    await globalRef.child('projectIndex/'+id+'/archived').set(true);
    toast('Project archived');
    renderManageProjectsList();
    updateProjectDropdown();
  }catch(e){
    toast('Failed to archive',1);
  }
};

window.unarchiveProject=async(id)=>{
  try{
    await globalRef.child('projectIndex/'+id+'/archived').set(false);
    toast('Project restored');
    renderManageProjectsList();
    updateProjectDropdown();
  }catch(e){
    toast('Failed to restore',1);
  }
};

window.confirmDeleteProject=(id,name)=>{
  deleteProjectId=id;
  $('deleteProjectDisplayName').textContent=name;
  $('deleteProjectConfirmName').value='';
  $('deleteProjectConfirm').disabled=true;
  openModal('deleteProjectModal');
};

// Rename Project Modal handlers
$('renameProjectModal').onclick=e=>{if(e.target.id==='renameProjectModal')closeModal('renameProjectModal')};
$('renameProjectClose').onclick=()=>closeModal('renameProjectModal');
$('renameProjectCancel').onclick=()=>closeModal('renameProjectModal');
$('renameProjectSave').onclick=async()=>{
  const newName=$('renameProjectName').value.trim();
  if(!newName){toast('Enter a name',1);return}
  
  try{
    await globalRef.child('projectIndex/'+renameProjectId+'/name').set(newName);
    await globalRef.child('projectIndex/'+renameProjectId+'/updatedAt').set(firebase.database.ServerValue.TIMESTAMP);
    
    // If renaming current project, update local state
    if(renameProjectId===currentProjectCode){
      currentProjectName=newName;
      updateProjectName();
    }
    
    closeModal('renameProjectModal');
    toast('Renamed');
    renderManageProjectsList();
    updateProjectDropdown();
  }catch(e){
    toast('Failed to rename',1);
  }
};

// Delete Project Modal handlers
$('deleteProjectModal').onclick=e=>{if(e.target.id==='deleteProjectModal')closeModal('deleteProjectModal')};
$('deleteProjectClose').onclick=()=>closeModal('deleteProjectModal');
$('deleteProjectCancel').onclick=()=>closeModal('deleteProjectModal');
$('deleteProjectConfirmName').oninput=()=>{
  const expected=$('deleteProjectDisplayName').textContent;
  const entered=$('deleteProjectConfirmName').value;
  $('deleteProjectConfirm').disabled=entered!==expected;
};
$('deleteProjectConfirm').onclick=async()=>{
  if(!deleteProjectId)return;
  
  try{
    // Delete project data
    await db.ref('projects/'+deleteProjectId).set(null);
    
    // Remove from index
    await globalRef.child('projectIndex/'+deleteProjectId).set(null);
    
    closeModal('deleteProjectModal');
    closeModal('manageProjectsModal');
    toast('Project deleted');
    
    // If deleted current project, switch to another
    if(deleteProjectId===currentProjectCode){
      const remaining=Object.keys(projectIndex).filter(id=>id!==deleteProjectId);
      if(remaining.length>0){
        switchProject(remaining[0]);
      }else{
        // No projects left - create a new one
        location.reload();
      }
    }
    
    updateProjectDropdown();
  }catch(e){
    toast('Failed to delete',1);
  }
};

// ============================================
// Template System (Phase 4)
// ============================================

// Generate template ID
function generateTemplateId() {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let id = 't_';
  for (let i = 0; i < 6; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return id;
}

// Save as Template Modal handlers
$('saveTemplateBtn').onclick=()=>{
  $('menuDrop').classList.remove('open');
  
  // Calculate stats
  const asms = data.filter(d => d.isAsm);
  const parts = data.filter(d => !d.isAsm);
  $('saveTemplateStats').textContent = 'Will save ' + asms.length + ' assemblies and ' + parts.length + ' parts';
  $('saveTemplateName').value = currentProjectName + ' Template';
  $('saveTemplateDesc').value = '';
  
  openModal('saveTemplateModal');
};

$('saveTemplateClose').onclick=()=>closeModal('saveTemplateModal');
$('saveTemplateCancel').onclick=()=>closeModal('saveTemplateModal');

$('saveTemplateSave').onclick=async()=>{
  const name = $('saveTemplateName').value.trim();
  if(!name) { toast('Enter a template name', 1); return; }
  
  const desc = $('saveTemplateDesc').value.trim();
  const templateId = generateTemplateId();
  
  // Build template data - assemblies and parts structure only (no status, dates, PO data)
  const asms = data.filter(d => d.isAsm);
  const parts = data.filter(d => !d.isAsm);
  
  const templateAsms = {};
  const templateParts = {};
  
  asms.forEach(asm => {
    templateAsms[asm.id] = {
      id: asm.id,
      name: asm.name,
      isAsm: true,
      priority: asm.priority || 0
    };
  });
  
  parts.forEach(part => {
    templateParts[part.id] = {
      id: part.id,
      name: part.name,
      code: part.code || '',
      mfr: part.mfr || '',
      qty: part.qty || 1,
      parentId: part.parentId || null,
      notes: part.notes || ''
    };
  });
  
  try {
    const templateRef = db.ref('templates/' + templateId);
    
    await templateRef.set({
      meta: {
        name: name,
        description: desc,
        asmCount: asms.length,
        partCount: parts.length,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        createdBy: firebaseUser ? firebaseUser.uid : null,
        sourceProject: currentProjectCode
      },
      assemblies: templateAsms,
      parts: templateParts
    });
    
    closeModal('saveTemplateModal');
    toast('Template saved');
    
  } catch(e) {
    console.error('Failed to save template:', e);
    toast('Failed: ' + (e.message || 'Unknown error'), 1);
  }
};

// Manage Templates Modal handlers
$('manageTemplatesBtn').onclick=()=>{
  $('menuDrop').classList.remove('open');
  renderTemplatesList();
  openModal('manageTemplatesModal');
};

$('manageTemplatesClose').onclick=()=>closeModal('manageTemplatesModal');
$('manageTemplatesDone').onclick=()=>closeModal('manageTemplatesModal');

function renderTemplatesList() {
  const list = $('templatesList');
  
  const templates = Object.entries(templatesIndex)
    .map(([id, meta]) => ({ id, ...meta }))
    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  
  if (templates.length === 0) {
    list.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px">No templates yet. Use "Save as Template" from the menu to create one.</div>';
    return;
  }
  
  list.innerHTML = templates.map(tmpl => {
    const dateStr = tmpl.createdAt ? new Date(tmpl.createdAt).toLocaleDateString() : '';
    const stats = (tmpl.asmCount || 0) + ' assemblies, ' + (tmpl.partCount || 0) + ' parts';
    
    return '<div class="template-item">' +
      '<div class="template-item-info">' +
        '<div class="template-item-name">' + esc(tmpl.name || 'Untitled') + '</div>' +
        (tmpl.description ? '<div class="template-item-desc">' + esc(tmpl.description) + '</div>' : '') +
        '<div class="template-item-meta">' + stats + ' â€¢ Created ' + dateStr + '</div>' +
      '</div>' +
      '<div class="template-item-actions">' +
        '<button onclick="window.useTemplate(\'' + tmpl.id + '\')" title="Create project from this template">ðŸ“„</button>' +
        '<button class="danger" onclick="window.deleteTemplate(\'' + tmpl.id + '\',\'' + esc(tmpl.name || '').replace(/'/g, "\\'") + '\')" title="Delete">ðŸ—‘ï¸</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

window.useTemplate = (templateId) => {
  closeModal('manageTemplatesModal');
  $('newProjectTemplate').value = templateId;
  $('newProjectName').value = '';
  openModal('newProjectModal');
};

window.deleteTemplate = async (templateId, templateName) => {
  if (!confirm('Delete template "' + templateName + '"? This cannot be undone.')) return;
  
  try {
    await db.ref('templates/' + templateId).set(null);
    toast('Template deleted');
    renderTemplatesList();
  } catch(e) {
    toast('Failed to delete', 1);
  }
};

// ============================================
// Master Schedule (Portfolio View)
// ============================================

$('masterScheduleBtn').onclick = () => {
  renderMasterSchedule();
  $('masterScheduleOverlay').classList.add('open');
};

$('masterScheduleClose').onclick = () => {
  $('masterScheduleOverlay').classList.remove('open');
};

$('masterShowArchived').onchange = () => {
  renderMasterSchedule();
};

function renderMasterSchedule() {
  const showArchived = $('masterShowArchived').checked;
  const content = $('masterScheduleContent');
  const headerEl = $('masterTimelineHeader');
  
  // Get projects
  let projects = Object.entries(projectIndex)
    .map(([id, p]) => ({ id, ...p }))
    .filter(p => showArchived || !p.archived)
    .sort((a, b) => {
      // Sort by start date, then name
      if (a.startDate && b.startDate) return a.startDate.localeCompare(b.startDate);
      if (a.startDate) return -1;
      if (b.startDate) return 1;
      return (a.name || '').localeCompare(b.name || '');
    });
  
  if (!projects.length) {
    content.innerHTML = '<div class="master-schedule-empty">No projects yet</div>';
    headerEl.innerHTML = '';
    return;
  }
  
  // Calculate timeline range - 12 months centered around today
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Find earliest and latest dates from projects
  let minDate = new Date(today);
  let maxDate = new Date(today);
  
  projects.forEach(p => {
    if (p.startDate) {
      const d = new Date(p.startDate);
      if (d < minDate) minDate = new Date(d);
    }
    if (p.endDate) {
      const d = new Date(p.endDate);
      if (d > maxDate) maxDate = new Date(d);
    }
  });
  
  // Extend range to show context
  minDate.setMonth(minDate.getMonth() - 1);
  minDate.setDate(1); // Start of month
  maxDate.setMonth(maxDate.getMonth() + 2);
  maxDate.setDate(0); // End of month
  
  // Ensure at least 6 months shown
  const sixMonthsLater = new Date(minDate);
  sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
  if (maxDate < sixMonthsLater) maxDate = sixMonthsLater;
  
  const totalDays = Math.ceil((maxDate - minDate) / 86400000);
  
  // Build month headers
  const months = [];
  let monthDate = new Date(minDate);
  while (monthDate <= maxDate) {
    const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
    const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
    const daysInMonth = monthEnd.getDate();
    
    // Calculate width as percentage
    const startOffset = Math.max(0, (monthStart - minDate) / 86400000);
    const endOffset = Math.min(totalDays, (monthEnd - minDate) / 86400000 + 1);
    const widthPct = ((endOffset - startOffset) / totalDays) * 100;
    
    months.push({
      label: monthDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
      widthPct: widthPct
    });
    
    monthDate.setMonth(monthDate.getMonth() + 1);
  }
  
  headerEl.innerHTML = months.map(m => 
    '<div class="master-timeline-month" style="flex:0 0 ' + m.widthPct + '%">' + m.label + '</div>'
  ).join('');
  
  // Calculate today position
  const todayOffset = (today - minDate) / 86400000;
  const todayPct = (todayOffset / totalDays) * 100;
  
  // Build project rows
  let html = '';
  projects.forEach(p => {
    const hasStart = !!p.startDate;
    const hasEnd = !!p.endDate;
    const startDate = hasStart ? new Date(p.startDate) : null;
    const endDate = hasEnd ? new Date(p.endDate) : null;
    
    // Format dates for display
    const startStr = startDate ? startDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : 'â€”';
    const endStr = endDate ? endDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : 'â€”';
    
    html += '<div class="master-project-row">';
    html += '<div class="master-project-info">';
    html += '<div class="master-project-name" onclick="window.openProjectFromMaster(\'' + p.id + '\')">' + esc(p.name || 'Untitled') + '</div>';
    html += '<div class="master-project-dates">' + startStr + ' â†’ ' + endStr + '</div>';
    html += '</div>';
    
    html += '<div class="master-timeline-wrap">';
    
    // Today line
    if (todayPct >= 0 && todayPct <= 100) {
      html += '<div class="master-timeline-today" style="left:' + todayPct + '%"></div>';
    }
    
    if (hasStart && hasEnd && startDate <= endDate) {
      const barStart = Math.max(0, (startDate - minDate) / 86400000);
      const barEnd = Math.min(totalDays, (endDate - minDate) / 86400000 + 1);
      const leftPct = (barStart / totalDays) * 100;
      const widthPct = ((barEnd - barStart) / totalDays) * 100;
      
      const archivedClass = p.archived ? ' archived' : '';
      html += '<div class="master-timeline-bar' + archivedClass + '" style="left:' + leftPct + '%;width:' + widthPct + '%" onclick="window.openProjectFromMaster(\'' + p.id + '\')" title="' + esc(p.name) + '">' + esc(p.name) + '</div>';
    } else {
      // No dates set
      html += '<div class="master-timeline-bar no-dates" style="left:5%;width:90%" onclick="window.openProjectFromMaster(\'' + p.id + '\')">No dates set</div>';
    }
    
    html += '</div>';
    html += '</div>';
  });
  
  content.innerHTML = html;
}

window.openProjectFromMaster = (projectId) => {
  $('masterScheduleOverlay').classList.remove('open');
  switchProject(projectId);
};

// Update newProjectCreate to handle templates
const originalNewProjectCreate = $('newProjectCreate').onclick;
$('newProjectCreate').onclick = async () => {
  const name = $('newProjectName').value.trim();
  if (!name) { toast('Enter a project name', 1); return; }
  
  const templateId = $('newProjectTemplate').value;
  const projectId = generateProjectId();
  
  console.log('Creating project:', projectId, name, 'from template:', templateId || '(empty)');
  
  const newProjectRef = db.ref('projects/' + projectId);
  
  try {
    // Initialize project meta
    await newProjectRef.child('meta').set({
      name: name,
      projectDates: { start: '', end: '' },
      milestones: [],
      schemaVersion: 2,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP,
      fromTemplate: templateId || null
    });
    
    // Add to project index
    await globalRef.child('projectIndex/' + projectId).set({
      name: name,
      archived: false,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
    
    // If template selected, copy its structure
    if (templateId) {
      console.log('Loading template data...');
      const templateSnap = await db.ref('templates/' + templateId).once('value');
      const templateData = templateSnap.val();
      
      if (templateData) {
        // Copy assemblies with new IDs
        const idMap = {}; // old ID -> new ID
        
        if (templateData.assemblies) {
          const newAsms = {};
          Object.values(templateData.assemblies).forEach(asm => {
            const newId = generateId();
            idMap[asm.id] = newId;
            newAsms[newId] = {
              id: newId,
              name: asm.name,
              isAsm: true,
              priority: asm.priority || 0,
              assignee: '',
              _updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
          });
          await newProjectRef.child('assemblies').set(newAsms);
          console.log('Copied', Object.keys(newAsms).length, 'assemblies');
        }
        
        // Copy parts with new IDs and updated parentIds
        if (templateData.parts) {
          const newParts = {};
          Object.values(templateData.parts).forEach(part => {
            const newId = generateId();
            newParts[newId] = {
              id: newId,
              name: part.name,
              code: part.code || '',
              mfr: part.mfr || '',
              qty: part.qty || 1,
              parentId: part.parentId ? (idMap[part.parentId] || null) : null,
              status: 'waiting',
              assignee: '',
              notes: part.notes || '',
              changedAt: Date.now(),
              _updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
          });
          await newProjectRef.child('parts').set(newParts);
          console.log('Copied', Object.keys(newParts).length, 'parts');
        }
      }
    }
    
    closeModal('newProjectModal');
    $('newProjectName').value = '';
    $('newProjectTemplate').value = '';
    toast('Project created');
    
    // Switch to new project
    switchProject(projectId);
    
  } catch(e) {
    console.error('Failed to create project:', e);
    toast('Failed: ' + (e.message || 'Unknown error'), 1);
  }
};

$('sampleBtn').onclick=()=>{if(confirm('Load sample data? This will replace all current data.')){
  // Clear existing data first
  if(projectRef) {
    projectRef.set(null).then(() => {
      createAndSaveSampleData();
      saveAllToGranular().then(() => {
        toast('Sample data loaded');
        render();
      });
    });
  } else {
    createAndSaveSampleData();
    toast('Sample data loaded');
    render();
  }
}};

// Generate 5 Test Projects
$('generateTestProjectsBtn').onclick=async()=>{
  if(!confirm('Generate 5 test projects with ~150 parts each? This will create new projects but not affect existing ones.')) return;
  
  $('menuDrop').classList.remove('open');
  toast('Generating test projects...');
  
  try {
    await generateTestProjects();
    toast('5 test projects created! Check Master Schedule');
  } catch(e) {
    console.error('Failed to generate test projects:', e);
    toast('Failed: ' + (e.message || 'Unknown error'), 1);
  }
};

async function generateTestProjects() {
  // Team members (shared across projects)
  const testTeam = [
    { name: 'Antti Korhonen', email: 'antti.korhonen@company.fi' },
    { name: 'Sari Virtanen', email: 'sari.virtanen@company.fi' },
    { name: 'Mikko Lahtinen', email: 'mikko.lahtinen@company.fi' },
    { name: 'Tuomas Niemi', email: 'tuomas.niemi@company.fi' },
    { name: 'Jukka Heikkinen', email: 'jukka.heikkinen@company.fi' },
    { name: 'Kaisa MÃ¤kinen', email: 'kaisa.makinen@company.fi' },
    { name: 'Pekka JÃ¤rvinen', email: 'pekka.jarvinen@company.fi' },
    { name: 'Laura Salo', email: 'laura.salo@company.fi' }
  ];
  
  const assemblyTemplates = {
    radar: ['Antenna Array', 'RF Transmitter Module', 'RF Receiver Module', 'Signal Processor', 'Power Distribution Unit', 'Cooling System', 'Control Interface', 'Data Processor', 'Waveguide Assembly', 'Rotary Joint', 'Pedestal Mount', 'Radome', 'Cable Harness Main', 'EMI Shielding', 'Test Interface Panel'],
    communication: ['Transceiver Unit', 'Antenna System', 'Modem Assembly', 'Encryption Module', 'Power Amplifier', 'Low Noise Amplifier', 'Frequency Synthesizer', 'Digital Backend', 'Cooling Assembly', 'Power Supply Unit', 'Control Panel', 'Cable Assembly', 'RF Filter Bank', 'Diplexer Unit', 'Housing Enclosure'],
    sensor: ['Sensor Head', 'Processing Unit', 'Power Module', 'Interface Board', 'Optics Assembly', 'Detector Array', 'Thermal Management', 'Calibration Unit', 'Data Acquisition', 'Signal Conditioning', 'Environmental Sealing', 'Mount Assembly', 'Wiring Harness', 'Test Connector Panel', 'Protective Housing'],
    control: ['Main Controller', 'I/O Module', 'Communication Interface', 'Power Management', 'Display Unit', 'User Interface Panel', 'Safety System', 'Diagnostic Module', 'Data Storage', 'Network Switch', 'Backup Controller', 'Sensor Interface', 'Actuator Driver', 'Emergency Stop', 'Enclosure Assembly'],
    power: ['Rectifier Unit', 'Inverter Module', 'Battery Bank', 'Charge Controller', 'Distribution Panel', 'Protection Circuit', 'Monitoring System', 'Cooling System', 'Transfer Switch', 'Surge Suppressor', 'Grounding Assembly', 'Cable Tray', 'Control Interface', 'Metering Unit', 'Enclosure']
  };
  
  const partTemplates = [
    { name: 'Capacitor Bank 100uF', code: 'CAP-100UF', mfr: 'Murata' },
    { name: 'Capacitor Array 10uF', code: 'CAP-10UF', mfr: 'TDK' },
    { name: 'Resistor Network 10K', code: 'RES-10K', mfr: 'Vishay' },
    { name: 'Power MOSFET', code: 'FET-PWR', mfr: 'Infineon' },
    { name: 'FPGA Module', code: 'FPGA-01', mfr: 'Xilinx' },
    { name: 'DSP Processor', code: 'DSP-TI', mfr: 'Texas Instruments' },
    { name: 'ADC 16-bit', code: 'ADC-16B', mfr: 'Analog Devices' },
    { name: 'DAC 14-bit', code: 'DAC-14B', mfr: 'Analog Devices' },
    { name: 'Op-Amp Quad', code: 'OPAMP-4', mfr: 'Texas Instruments' },
    { name: 'Voltage Regulator 5V', code: 'VREG-5V', mfr: 'Linear Tech' },
    { name: 'RF Amplifier 10W', code: 'RFA-10W', mfr: 'Qorvo' },
    { name: 'LNA Module', code: 'LNA-01', mfr: 'Mini-Circuits' },
    { name: 'RF Switch SP4T', code: 'RFSW-4', mfr: 'Analog Devices' },
    { name: 'RF Mixer', code: 'MIX-01', mfr: 'Mini-Circuits' },
    { name: 'RF Filter 2.4GHz', code: 'RFF-2G4', mfr: 'Johanson' },
    { name: 'VCO Module', code: 'VCO-01', mfr: 'Analog Devices' },
    { name: 'Aluminum Bracket', code: 'BRK-AL', mfr: 'Custom' },
    { name: 'Heat Sink Assembly', code: 'HS-ASM', mfr: 'Aavid' },
    { name: 'Fan Assembly 80mm', code: 'FAN-80', mfr: 'Delta' },
    { name: 'Thermal Pad', code: 'THERM-P', mfr: '3M' },
    { name: 'SMA Connector Male', code: 'SMA-M', mfr: 'Amphenol' },
    { name: 'N-Type Connector', code: 'N-CON', mfr: 'Amphenol' },
    { name: 'D-Sub 25 Connector', code: 'DSUB-25', mfr: 'TE Connectivity' },
    { name: 'Circular Connector 12P', code: 'CIRC-12', mfr: 'Amphenol' },
    { name: 'Coax Cable RG-58', code: 'CBL-RG58', mfr: 'Times Microwave' },
    { name: 'Power Cable 12AWG', code: 'CBL-12A', mfr: 'Alpha Wire' },
    { name: 'Main Controller PCB', code: 'PCB-CTRL', mfr: 'PCBWAY' },
    { name: 'Power Supply PCB', code: 'PCB-PWR', mfr: 'PCBWAY' },
    { name: 'RF Frontend PCB', code: 'PCB-RF', mfr: 'Rogers' },
    { name: 'Gasket Seal', code: 'GSK-01', mfr: 'Parker' }
  ];
  
  const projects = [
    { id: 'proj_mrs450', name: 'MRS-450 Marine Radar', type: 'radar', startDate: '2025-08-01', endDate: '2026-03-15', progress: 85 },
    { id: 'proj_satcom', name: 'SATCOM Terminal v2', type: 'communication', startDate: '2025-11-15', endDate: '2026-06-30', progress: 55 },
    { id: 'proj_eovis', name: 'EO-VIS Sensor Suite', type: 'sensor', startDate: '2026-01-10', endDate: '2026-08-20', progress: 20 },
    { id: 'proj_scada', name: 'SCADA Controller Unit', type: 'control', startDate: '2026-03-01', endDate: '2026-09-30', progress: 5 },
    { id: 'proj_ups500', name: 'UPS-500 Power System', type: 'power', startDate: '2026-05-15', endDate: '2026-12-15', progress: 0 }
  ];
  
  function getStatusForProgress(progress) {
    const rand = Math.random() * 100;
    if (progress >= 85) {
      if (rand < 70) return 'installed';
      if (rand < 80) return 'configured';
      if (rand < 90) return 'tested';
      return 'arrived';
    } else if (progress >= 50) {
      if (rand < 30) return 'installed';
      if (rand < 45) return 'configured';
      if (rand < 60) return 'tested';
      if (rand < 75) return 'arrived';
      if (rand < 85) return 'ordered';
      return rand < 95 ? 'to-order' : 'waiting';
    } else if (progress >= 20) {
      if (rand < 10) return 'installed';
      if (rand < 35) return 'tested';
      if (rand < 50) return 'arrived';
      if (rand < 70) return 'ordered';
      return rand < 85 ? 'to-order' : 'waiting';
    } else if (progress >= 5) {
      if (rand < 15) return 'arrived';
      if (rand < 30) return 'ordered';
      return rand < 50 ? 'to-order' : 'waiting';
    }
    return 'waiting';
  }
  
  function addDays(dateStr, days) {
    const d = new Date(dateStr);
    d.setDate(d.getDate() + days);
    return d.toISOString().split('T')[0];
  }
  
  function randomDays(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }
  
  function randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
  
  // Save team
  await globalRef.child('team').set(testTeam);
  team = testTeam;
  
  for (const proj of projects) {
    console.log('Generating:', proj.name);
    
    const projectRef = db.ref('projects/' + proj.id);
    const assemblies = assemblyTemplates[proj.type];
    const asmData = {};
    const partsData = {};
    
    let currentAsmStart = proj.startDate;
    
    for (let i = 0; i < assemblies.length; i++) {
      const asmId = generateId();
      const asmName = assemblies[i];
      const assignee = randomChoice(testTeam).name;
      
      const staggerDays = i === 0 ? 0 : randomDays(3, 14);
      const asmStartDate = addDays(currentAsmStart, staggerDays);
      const asmDuration = randomDays(21, 45);
      const asmEndDate = addDays(asmStartDate, asmDuration);
      currentAsmStart = asmStartDate;
      
      asmData[asmId] = {
        id: asmId,
        name: asmName,
        isAsm: true,
        assignee: assignee,
        priority: i + 1,
        startDate: asmStartDate,
        endDate: asmEndDate,
        _updatedAt: firebase.database.ServerValue.TIMESTAMP
      };
      
      const numParts = randomDays(8, 12);
      const shuffled = [...partTemplates].sort(() => Math.random() - 0.5);
      
      for (let j = 0; j < numParts; j++) {
        const partId = generateId();
        const partTemplate = shuffled[j % shuffled.length];
        const status = getStatusForProgress(proj.progress);
        
        let poNumber = '', poDate = '', eta = '';
        if (['ordered', 'arrived', 'tested', 'configured', 'installed'].includes(status)) {
          poNumber = 'PO-2026-' + String(1000 + Math.floor(Math.random() * 9000));
          poDate = addDays(proj.startDate, randomDays(0, 30));
          eta = addDays(poDate, randomDays(7, 28));
        }
        
        partsData[partId] = {
          id: partId,
          name: partTemplate.name + (j >= partTemplates.length ? ' #' + Math.ceil(j / partTemplates.length) : ''),
          code: partTemplate.code + '-' + String(100 + j),
          mfr: partTemplate.mfr,
          qty: randomDays(1, 5),
          parentId: asmId,
          assignee: randomChoice(testTeam).name,
          status: status,
          poNumber: poNumber,
          poDate: poDate,
          eta: eta,
          changedAt: Date.now() - randomDays(0, 60) * 86400000,
          _updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
      }
    }
    
    const projDuration = Math.ceil((new Date(proj.endDate) - new Date(proj.startDate)) / 86400000);
    
    await projectRef.set({
      meta: {
        name: proj.name,
        projectDates: { start: proj.startDate, end: proj.endDate },
        milestones: [
          { id: generateId(), name: 'Design Review', date: addDays(proj.startDate, 30), color: '#8ABADC' },
          { id: generateId(), name: 'First Article', date: addDays(proj.startDate, Math.floor(projDuration * 0.5)), color: '#D4A574' },
          { id: generateId(), name: 'Final Delivery', date: proj.endDate, color: '#27AE60' }
        ],
        schemaVersion: 2,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      },
      assemblies: asmData,
      parts: partsData
    });
    
    await globalRef.child('projectIndex/' + proj.id).set({
      name: proj.name,
      archived: false,
      startDate: proj.startDate,
      endDate: proj.endDate,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    });
  }
  
  // Switch to first project
  switchProject('proj_mrs450');
}

// NAV Import functionality
let navImportData=[];
$('navImportBtn').onclick=()=>{
  navImportData=[];
  $('navFileInput').value='';
  $('navFileName').textContent='';
  $('navPreview').style.display='none';
  $('navImportApply').disabled=true;
  $('navImportModal').classList.add('open');
};
$('navImportClose').onclick=$('navImportCancel').onclick=()=>$('navImportModal').classList.remove('open');
$('navFileBtn').onclick=()=>$('navFileInput').click();
$('navFileInput').onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  $('navFileName').textContent=file.name;
  const reader=new FileReader();
  reader.onload=ev=>{
    parseNavCSV(ev.target.result);
  };
  reader.readAsText(file);
};

function parseNavCSV(csvText){
  const lines=csvText.trim().split('\n');
  if(lines.length<2){toast('Invalid CSV file','err');return}
  
  // Parse header to find columns - flexible matching
  const header=lines[0].split(/[,;\t]/).map(h=>h.trim().toLowerCase().replace(/['"]/g,''));
  const colMap={};
  header.forEach((h,i)=>{
    if(h.includes('item')&&h.includes('no')||h==='itemno'||h==='item_no'||h==='item number')colMap.itemNo=i;
    else if(h.includes('description')||h==='desc')colMap.desc=i;
    else if(h.includes('po')&&h.includes('no')||h==='pono'||h==='po_no'||h==='po number'||h==='document no')colMap.po=i;
    else if(h.includes('quantity')||h==='qty')colMap.qty=i;
    else if(h.includes('expected')&&h.includes('date')||h.includes('eta')||h.includes('arrival')||h.includes('receipt date'))colMap.eta=i;
    else if(h.includes('status')||h.includes('received')||h.includes('qty received')||h.includes('quantity received'))colMap.status=i;
    else if(h.includes('vendor')||h.includes('supplier'))colMap.vendor=i;
  });
  
  // Fallback: if no specific PO column, check for 'no' or 'document'
  if(colMap.po===undefined){
    header.forEach((h,i)=>{
      if((h.includes('document')||h==='no')&&colMap.po===undefined)colMap.po=i;
    });
  }
  
  navImportData=[];
  const delimiter=lines[0].includes('\t')?'\t':lines[0].includes(';')?';':',';
  
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(delimiter).map(c=>c.trim().replace(/^["']|["']$/g,''));
    if(cols.length<2)continue;
    
    const itemNo=colMap.itemNo!==undefined?cols[colMap.itemNo]:'';
    const desc=colMap.desc!==undefined?cols[colMap.desc]:'';
    const po=colMap.po!==undefined?cols[colMap.po]:'';
    const qty=colMap.qty!==undefined?parseInt(cols[colMap.qty])||1:1;
    const eta=colMap.eta!==undefined?cols[colMap.eta]:'';
    const statusRaw=colMap.status!==undefined?cols[colMap.status]:'';
    const vendor=colMap.vendor!==undefined?cols[colMap.vendor]:'';
    
    // Determine if item is received (check qty received or status text)
    let isReceived=false;
    if(statusRaw){
      const sl=statusRaw.toLowerCase();
      if(sl==='received'||sl==='yes'||sl==='true'||sl==='arrived')isReceived=true;
      // If it's a number (qty received), check if >0
      const qtyRec=parseInt(statusRaw);
      if(!isNaN(qtyRec)&&qtyRec>0)isReceived=true;
    }
    
    // Try to match with existing parts by item code or description
    let matchedPart=null;
    if(itemNo){
      matchedPart=data.find(p=>!p.isAsm&&p.code&&p.code.toLowerCase()===itemNo.toLowerCase());
    }
    if(!matchedPart&&desc){
      // Try exact match first, then partial
      matchedPart=data.find(p=>!p.isAsm&&p.name&&p.name.toLowerCase()===desc.toLowerCase());
      if(!matchedPart){
        matchedPart=data.find(p=>!p.isAsm&&p.name&&(p.name.toLowerCase().includes(desc.toLowerCase())||desc.toLowerCase().includes(p.name.toLowerCase())));
      }
    }
    
    navImportData.push({
      itemNo,desc,po,qty,eta,isReceived,vendor,
      matchedPartId:matchedPart?matchedPart.id:null,
      matchedPartName:matchedPart?matchedPart.name:null
    });
  }
  
  renderNavPreview();
}

function renderNavPreview(){
  const list=$('navPreviewList');
  const matched=navImportData.filter(d=>d.matchedPartId);
  const unmatched=navImportData.filter(d=>!d.matchedPartId);
  
  $('navMatchCount').textContent=matched.length+' of '+navImportData.length+' items matched to parts';
  
  let html='';
  // Show matched first
  matched.forEach(d=>{
    const etaDisplay=d.eta?new Date(d.eta).toLocaleDateString():'â€”';
    const statusClass=d.isReceived?'will-receive':'will-update';
    const statusText=d.isReceived?'Will receive':'Will update PO';
    html+='<div class="nav-preview-item"><div class="nav-preview-name">'+esc(d.matchedPartName)+'<span class="match">âœ“ matched</span></div>';
    if(d.po)html+='<div class="nav-preview-po">'+esc(d.po)+'</div>';
    if(d.eta)html+='<div class="nav-preview-eta">ETA: '+etaDisplay+'</div>';
    html+='<div class="nav-preview-status '+statusClass+'">'+statusText+'</div></div>';
  });
  
  // Show a few unmatched
  if(unmatched.length>0){
    const showUnmatched=unmatched.slice(0,5);
    showUnmatched.forEach(d=>{
      html+='<div class="nav-preview-item no-match"><div class="nav-preview-name">'+esc(d.desc||d.itemNo||'Unknown')+'<span class="no-match">no match</span></div>';
      if(d.po)html+='<div class="nav-preview-po">'+esc(d.po)+'</div>';
      html+='<div class="nav-preview-status">Skipped</div></div>';
    });
    if(unmatched.length>5){
      html+='<div class="nav-preview-item no-match" style="justify-content:center;color:var(--text3);font-size:11px">+'+(unmatched.length-5)+' more unmatched items</div>';
    }
  }
  
  if(html==='')html='<div style="padding:16px;text-align:center;color:var(--text3)">No data found in CSV</div>';
  
  list.innerHTML=html;
  $('navPreview').style.display='block';
  $('navImportApply').disabled=matched.length===0;
}

$('navImportApply').onclick=()=>{
  const autoReceive=$('navAutoReceive').checked;
  let updated=0,received=0;
  
  navImportData.filter(d=>d.matchedPartId).forEach(d=>{
    const part=data.find(p=>String(p.id)===String(d.matchedPartId));
    if(!part)return;
    
    const changedFields=[];
    
    // Update PO number
    if(d.po&&d.po!==part.poNumber){
      part.poNumber=d.po;
      changedFields.push('poNumber');
      updated++;
    }
    
    // Update vendor/supplier
    if(d.vendor&&!part.supplier){
      part.supplier=d.vendor;
      changedFields.push('supplier');
    }
    
    // Update expected arrival date
    if(d.eta){
      const etaDate=new Date(d.eta);
      if(!isNaN(etaDate.getTime())){
        part.expectedArrival=etaDate.toISOString().split('T')[0];
        changedFields.push('expectedArrival');
      }
    }
    
    // Auto-receive if enabled and item is marked as received
    if(autoReceive&&d.isReceived&&part.status==='ordered'){
      part.status='arrived';
      part.arrivedAt=Date.now();
      part.changedAt=Date.now();
      changedFields.push('status');
      received++;
    }
    
    // If part was to-order and now has PO, mark as ordered
    if(d.po&&part.status==='to-order'){
      part.status='ordered';
      part.orderedAt=Date.now();
      part.changedAt=Date.now();
      changedFields.push('status');
    }
    
    if(changedFields.length){
      changedFields.forEach(f=>updateFieldTimestamp(part,f));
      markPartChanged(part.id,changedFields);
    }
  });
  
  save();render();
  $('navImportModal').classList.remove('open');
  
  let msg='Import complete: '+updated+' parts updated';
  if(received>0)msg+=', '+received+' received';
  toast(msg,'success');
};

$('expandToggle').onclick=()=>{
  const asms=getAsms();
  if(allExpanded){expanded={};allExpanded=false}
  else{asms.forEach(a=>expanded[String(a.id)]=true);allExpanded=true}
  save();render();
};

$('clearBtn').onclick=()=>{if(confirm('Delete ALL data? This cannot be undone.')){
  // Actually delete everything from Firebase (not tombstones)
  if(projectRef) {
    projectRef.set(null).then(() => {
      console.log('Firebase data deleted');
      data=[];team=[];expanded={};history=[];projectDates={start:'',end:''};actions=[];milestones=[];currentProjectName='New Project';
      localStorage.removeItem(LOCAL_STORAGE_KEY);
      toast('All data cleared - reload to start fresh');
      setTimeout(() => location.reload(), 500);
    }).catch(err => {
      console.error('Failed to clear Firebase:', err);
      toast('Failed to clear data', 1);
    });
  } else {
    data=[];team=[];expanded={};history=[];projectDates={start:'',end:''};actions=[];milestones=[];currentProjectName='New Project';
    localStorage.removeItem(LOCAL_STORAGE_KEY);
    toast('All data cleared');
    render();
  }
}};
$('signOutBtn').onclick=()=>{if(confirm('Sign out?'))logout()};

// Header search
$('headerSearch').oninput=e=>{
  searchQ=e.target.value;
  $('headerSearchClear').classList.toggle('visible',searchQ.length>0);
  render();
};
$('headerSearchClear').onclick=()=>{
  $('headerSearch').value='';
  searchQ='';
  $('headerSearchClear').classList.remove('visible');
  render();
};

// Action handlers removed - stubs to prevent errors
if($('actionSearchBox'))$('actionSearchBox').oninput=e=>{};
if($('actionAssigneeFilter'))$('actionAssigneeFilter').onchange=e=>{};
$('assigneeFilter').onchange=e=>{filterAssignee=e.target.value;render()};

document.querySelectorAll('.pipe').forEach(p=>p.onclick=()=>{filterStage=filterStage===p.dataset.s?'':p.dataset.s;document.querySelector('[data-tab="list"]').click();render()});

document.querySelectorAll('.tab').forEach(tab=>tab.onclick=()=>{
  closeAIWorkspace();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $(tab.dataset.tab+'Panel').classList.add('active');
  if(tab.dataset.tab==='gantt'){
    window._ganttScrolled=false;
    setTimeout(()=>{
      renderGantt();
      // Force scroll after render
      setTimeout(()=>{
        const todayLine=document.querySelector('.gantt-today-line');
        const container=$('ganttBodyWrap');
        if(todayLine&&container){
          const pos=parseInt(todayLine.style.left)||0;
          container.scrollLeft=Math.max(0,pos-container.clientWidth/2+210);
          $('ganttTimelineHeaderWrap').scrollLeft=container.scrollLeft;
        }
      },50);
    },10);
  }
});

document.onkeydown=e=>{if(e.key==='Escape'){closeAIWorkspace();['teamModal','datesModal','leadtimeModal','bomModal','otdModal','itemConfigModal','newProjectModal','manageProjectsModal','renameProjectModal','deleteProjectModal'].forEach(closeModal);$('themeModal').classList.remove('open');$('receivePOModal').classList.remove('open');$('reportModal').classList.remove('open');$('metricsPopover').classList.remove('open');$('poModal').classList.remove('open');$('menuDrop').classList.remove('open');$('ganttColorPopup').classList.remove('open');$('ganttDatePopup').classList.remove('open');$('etaPopover').classList.remove('open');hidePopoverModal($('partModal'));hidePopoverModal($('asmModal'));closeCmdWindow();closeDeletePopover();$('commentsPopover').classList.remove('open');$('popoverBackdrop').classList.remove('active');closeProjectDropdown();currentCommentPartId=null;editId=editAsmId=editActId=editEtaPartId=pendingAdvPartId=null}};

// Comments on parts
let currentCommentPartId=null;

window.openComments=window.openNotesChat=function(partId,e){
  currentCommentPartId=partId;
  const part=data.find(d=>String(d.id)===String(partId));
  $('commentsTitle').textContent=part?part.name.substring(0,25):'Notes';
  
  // Position near clicked element
  const popover=$('commentsPopover');
  const target=e?e.target.closest('.notes-chat-cell')||e.target.closest('button')||e.target:null;
  if(target){
    const rect=target.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left;
    if(left+320>window.innerWidth)left=window.innerWidth-330;
    if(top+400>window.innerHeight)top=rect.top-400-8;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
  }
  
  loadComments(partId);
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
  setTimeout(()=>$('commentInput').focus(),100);
};

function loadComments(partId){
  const part=data.find(d=>String(d.id)===String(partId));
  const comments=part?.comments||[];
  if(comments.length===0){
    $('commentsList').innerHTML='<div class="comments-empty">No notes yet.<br>Add the first one below.</div>';
  }else{
    $('commentsList').innerHTML=comments.map(c=>{
      const time=new Date(c.ts||c.timestamp).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      return '<div class="comment-item"><div class="comment-author">'+esc(c.author)+'</div><div class="comment-text">'+esc(c.text)+'</div><div class="comment-time">'+time+'</div></div>';
    }).join('');
  }
}

$('commentsClose').onclick=()=>{
  $('commentsPopover').classList.remove('open');
  $('popoverBackdrop').classList.remove('active');
  currentCommentPartId=null;
};

// Close comments - handled by backdrop

$('commentAdd').onclick=()=>{
  const input=$('commentInput');
  const text=input.value.trim();
  if(!text||!currentCommentPartId)return;
  
  const part=data.find(d=>String(d.id)===String(currentCommentPartId));
  if(!part)return;
  
  // Get or prompt for username
  let author=localStorage.getItem('ebs-username');
  if(!author){
    author=prompt('Enter your name for comments:','');
    if(author)localStorage.setItem('ebs-username',author);
  }
  if(!author)author='Anonymous';
  
  if(!part.comments)part.comments=[];
  part.comments.push({
    author:author,
    text:text,
    ts:Date.now()
  });
  
  // Track the comment change
  updateFieldTimestamp(part,'comments');
  markPartChanged(currentCommentPartId,['comments']);
  
  // Log comment event
  logComment(part,text);
  
  save();
  loadComments(currentCommentPartId);
  input.value='';
  render(); // Update comment count
};

$('commentInput').onkeydown=e=>{if(e.key==='Enter')$('commentAdd').click()};

// ============================================
// BULK OPERATIONS
// ============================================
function updateBulkBar(){
  const bar=$('bulkBar');
  const count=selectedParts.size;
  $('bulkCount').textContent=count;
  
  if(count>0){
    bar.classList.add('active');
  }else{
    bar.classList.remove('active');
  }
}

function clearSelection(){
  selectedParts.clear();
  lastSelectedPartId=null;
  updateBulkBar();
  render();
}

window.togglePartSelection=function(partId,e){
  e.stopPropagation();
  const parts=getParts().filter(matchPart);
  
  // Ensure partId is string for consistent comparison
  partId = String(partId);
  
  // Shift+click for range selection
  if(e.shiftKey&&lastSelectedPartId!==null){
    const ids=parts.map(p=>String(p.id));
    const startIdx=ids.indexOf(String(lastSelectedPartId));
    const endIdx=ids.indexOf(partId);
    if(startIdx>=0&&endIdx>=0){
      const [from,to]=[Math.min(startIdx,endIdx),Math.max(startIdx,endIdx)];
      for(let i=from;i<=to;i++){
        selectedParts.add(ids[i]);
      }
    }
  }else{
    if(selectedParts.has(partId)){
      selectedParts.delete(partId);
    }else{
      selectedParts.add(partId);
    }
    lastSelectedPartId=partId;
  }
  updateBulkBar();
  render();
};

window.toggleSelectAll=function(e){
  const parts=getParts().filter(matchPart);
  if(selectedParts.size===parts.length){
    selectedParts.clear();
  }else{
    parts.forEach(p=>selectedParts.add(String(p.id)));
  }
  updateBulkBar();
  render();
};

// Click on empty space in parts table to deselect
$('partsList').addEventListener('click',function(e){
  // If click is directly on the table body (not on a part row or its children)
  if(e.target===this||e.target.classList.contains('add-row')||e.target.classList.contains('add-row-text')){
    if(selectedParts.size>0){
      clearSelection();
    }
  }
});

// Click on table container background to deselect
$('partsTable').addEventListener('click',function(e){
  if(e.target===this){
    if(selectedParts.size>0){
      clearSelection();
    }
  }
});

// Handle clicks on row background/padding to deselect
window.handleRowClick=function(e){
  if(!selectedParts.size)return;
  // Check if click is on the row itself (padding area) or on an empty child div
  const row=e.currentTarget;
  // If clicked directly on the row (padding area)
  if(e.target===row){
    clearSelection();
    return;
  }
  // If clicked on an empty div that's a direct child of the row
  if(e.target.parentElement===row&&e.target.tagName==='DIV'){
    // Check if this div has no interactive content
    const hasContent=e.target.textContent.trim()||e.target.querySelector('input,button,span.status-badge,span.eta-po,span.eta-date,.cell,.stage-dot,.comment-btn,.adv-btn,.sm-btn');
    if(!hasContent){
      clearSelection();
      return;
    }
  }
};

// Click on partsList background (between rows) to deselect
$('partsList').addEventListener('click',function(e){
  if(!selectedParts.size)return;
  if(e.target===this){
    clearSelection();
  }
});

function positionBulkPopover(popover,btn){
  const rect=btn.getBoundingClientRect();
  let top=rect.bottom+8;
  let left=rect.left;
  if(left+320>window.innerWidth)left=window.innerWidth-330;
  if(top+300>window.innerHeight)top=rect.top-310;
  popover.style.top=Math.max(10,top)+'px';
  popover.style.left=Math.max(10,left)+'px';
}

function renderBulkPreview(containerId){
  const container=$(containerId);
  const parts=Array.from(selectedParts).map(id=>data.find(d=>String(d.id)===String(id))).filter(Boolean);
  if(parts.length<=5){
    container.innerHTML=parts.map(p=>'<div style="padding:4px 0;font-size:11px;border-bottom:1px solid var(--bg4)">'+esc(p.name)+'</div>').join('');
  }else{
    container.innerHTML=parts.slice(0,3).map(p=>'<div style="padding:4px 0;font-size:11px;border-bottom:1px solid var(--bg4)">'+esc(p.name)+'</div>').join('')+'<div style="padding:4px 0;font-size:11px;color:var(--text3)">...and '+(parts.length-3)+' more</div>';
  }
}

function closeBulkPopovers(){
  ['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
    const el=$(id);if(el)el.classList.remove('open');
  });
}

window.openBulkStatusModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkStatusPreview');
  $('bulkStatusSelect').value='';
  $('bulkStatusPO').value='';
  $('bulkStatusETA').value='';
  $('bulkPOFields').style.display='none';
  positionBulkPopover($('bulkStatusModal'),e.target);
  $('bulkStatusModal').classList.add('open');
};

window.openBulkAssignModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkAssignPreview');
  $('bulkAssignSelect').innerHTML='<option value="">Select assignee...</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');
  positionBulkPopover($('bulkAssignModal'),e.target);
  $('bulkAssignModal').classList.add('open');
};

window.openBulkPOModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkPOPreview');
  $('bulkPOInput').value='';
  positionBulkPopover($('bulkPOModal'),e.target);
  $('bulkPOModal').classList.add('open');
  setTimeout(()=>$('bulkPOInput').focus(),100);
};

window.openBulkDeleteModal=function(e){
  if(!selectedParts.size)return;
  closeBulkPopovers();
  renderBulkPreview('bulkDeletePreview');
  positionBulkPopover($('bulkDeleteModal'),e.target);
  $('bulkDeleteModal').classList.add('open');
};

window.applyBulkStatus=function(){
  const status=$('bulkStatusSelect').value;
  if(!status)return;
  const now=Date.now();
  const po=$('bulkStatusPO').value.trim();
  const eta=$('bulkStatusETA').value;
  const count=selectedParts.size;
  
  selectedParts.forEach(id=>{
    const p=data.find(d=>String(d.id)===String(id));
    if(p){
      const changedFields=['status'];
      if(p.status==='ordered'&&status==='arrived'&&p.orderedAt&&p.code){
        const days=Math.round((now-p.orderedAt)/86400000);
        if(days>0)recordLeadTime(p.code,days);
        p.arrivedAt=now;
      }
      if(status==='ordered'&&p.status!=='ordered'){
        p.orderedAt=now;
        if(po){p.poNumber=po;changedFields.push('poNumber');}
        if(eta){p.expectedArrival=eta;changedFields.push('expectedArrival');}
      }
      p.status=status;
      p.changedAt=now;
      changedFields.forEach(f=>updateFieldTimestamp(p,f));
      markPartChanged(id,changedFields);
    }
  });
  save();
  $('bulkStatusModal').classList.remove('open');
  clearSelection();
  render();
  toast(count+' parts updated â†’ '+SLABELS[status]);
};

// Show/hide PO fields based on status selection
$('bulkStatusSelect').onchange=function(){
  const showPO=this.value==='ordered';
  $('bulkPOFields').style.display=showPO?'block':'none';
};

window.applyBulkAssign=function(){
  const assignee=$('bulkAssignSelect').value;
  if(!assignee)return;
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    const p=data.find(d=>String(d.id)===String(id));
    if(p){
      p.assignee=assignee;
      updateFieldTimestamp(p,'assignee');
      markPartChanged(id,['assignee']);
    }
  });
  save();
  $('bulkAssignModal').classList.remove('open');
  clearSelection();
  render();
  toast(count+' parts assigned');
};

window.applyBulkPO=function(){
  const po=$('bulkPOInput').value.trim();
  if(!po)return;
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    const p=data.find(d=>String(d.id)===String(id));
    if(p){
      p.poNumber=po;
      updateFieldTimestamp(p,'poNumber');
      markPartChanged(id,['poNumber']);
    }
  });
  save();
  $('bulkPOModal').classList.remove('open');
  clearSelection();
  render();
  toast(count+' parts updated');
};

window.applyBulkDelete=function(){
  const count=selectedParts.size;
  selectedParts.forEach(id=>{
    const item=data.find(d=>String(d.id)===String(id));
    if(item){
      if(item.isAsm){
        markDeleted('asm',id);
        // Also mark child parts for deletion
        data.filter(d=>String(d.parentId)===String(id)).forEach(child=>{
          markDeleted('part',child.id);
        });
      }else{
        markDeleted('part',id);
        // Also mark sub-parts for deletion
        data.filter(d=>String(d.parentId)===String(id)).forEach(child=>{
          markDeleted('part',child.id);
        });
      }
    }
    data=data.filter(d=>String(d.id)!==String(id)&&String(d.parentId)!==String(id));
  });
  save();
  $('bulkDeleteModal').classList.remove('open');
  clearSelection();
  render();
  toast(count+' parts deleted');
};

// Close bulk popovers
['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
  $(id).querySelector('.modal-close').onclick=()=>$(id).classList.remove('open');
});

document.addEventListener('click',e=>{
  ['bulkStatusModal','bulkAssignModal','bulkPOModal','bulkDeleteModal'].forEach(id=>{
    const modal=$(id);
    if(modal.classList.contains('open')&&!modal.contains(e.target)&&!e.target.closest('.bulk-bar')){
      modal.classList.remove('open');
    }
  });
});

// ============================================
// Label Printing System
// ============================================
let labelPartIds = [];

window.openLabelModal = function(partId, e) {
  if (e) e.stopPropagation();
  
  // Check if we have selected parts - use those, otherwise use single part
  if (selectedParts.size > 0) {
    labelPartIds = Array.from(selectedParts);
  } else {
    labelPartIds = [partId];
  }
  
  updateLabelPreview();
  
  // Center the modal on screen (it's too big for standard popover positioning)
  const modal = $('labelModal');
  closeAllPopovers();
  $('popoverBackdrop').classList.add('active');
  modal.style.top = '50%';
  modal.style.left = '50%';
  modal.style.transform = 'translate(-50%, -50%)';
  modal.classList.add('open');
};

window.openBulkLabelModal = function(e) {
  if (selectedParts.size === 0) {
    toast('Select parts first');
    return;
  }
  labelPartIds = Array.from(selectedParts);
  updateLabelPreview();
  
  // Center the modal on screen
  const modal = $('labelModal');
  closeAllPopovers();
  $('popoverBackdrop').classList.add('active');
  modal.style.top = '50%';
  modal.style.left = '50%';
  modal.style.transform = 'translate(-50%, -50%)';
  modal.classList.add('open');
};

function updateLabelPreview() {
  const size = $('labelSize').value;
  const showAssembly = $('labelAssembly').checked;
  const showMfr = $('labelMfr').checked;
  
  // Get first part for preview
  const part = data.find(d => String(d.id) === String(labelPartIds[0]));
  if (!part) return;
  
  // Find assembly name
  const asm = data.find(d => d.isAsm && String(d.id) === String(part.parentId));
  const asmName = asm ? asm.name : '';
  
  // Get project name
  const projectName = currentProjectName || 'Project';
  
  // Update preview text
  $('labelPreviewName').textContent = part.name;
  $('labelPreviewCode').textContent = part.code || 'â€”';
  $('labelPreviewProject').textContent = 'Project: ' + projectName;
  
  let metaText = '';
  if (showAssembly && asmName) metaText += asmName;
  if (showMfr && part.mfr) metaText += (metaText ? ' Â· ' : '') + part.mfr;
  $('labelPreviewMeta').textContent = metaText || '';
  $('labelPreviewMeta').style.display = metaText ? 'block' : 'none';
  
  // Update preview size (29x90 is landscape: 90mm wide x 29mm tall)
  const preview = $('labelPreview');
  const sizes = {
    '29x90': { w: '270px', h: '85px' },
    '102x51': { w: '240px', h: '120px' },
    '62x100': { w: '150px', h: '240px' },
    '62x29': { w: '186px', h: '85px' }
  };
  const s = sizes[size] || sizes['29x90'];
  preview.style.width = s.w;
  preview.style.minHeight = s.h;
  preview.style.flexDirection = 'column';
  preview.style.textAlign = 'left';
  preview.style.justifyContent = 'center';
  
  // Update count info
  if (labelPartIds.length > 1) {
    $('labelCountInfo').textContent = 'Printing ' + labelPartIds.length + ' labels';
    $('labelCountInfo').style.display = 'block';
  } else {
    $('labelCountInfo').style.display = 'none';
  }
}

window.printLabels = function() {
  const size = $('labelSize').value;
  const showAssembly = $('labelAssembly').checked;
  const showMfr = $('labelMfr').checked;
  
  // Get project name
  const projectName = currentProjectName || 'Project';
  
  // Map size to actual dimensions (29x90 is landscape: 90mm wide x 29mm tall)
  const pageSizes = {
    '29x90': { css: '90mm 29mm', w: '90mm', h: '29mm' },
    '102x51': { css: '102mm 51mm', w: '102mm', h: '51mm' },
    '62x100': { css: '62mm 100mm', w: '62mm', h: '100mm' },
    '62x29': { css: '62mm 29mm', w: '62mm', h: '29mm' }
  };
  const ps = pageSizes[size] || pageSizes['29x90'];
  
  // Build labels HTML
  let labelsHtml = '';
  labelPartIds.forEach((partId, idx) => {
    const part = data.find(d => String(d.id) === String(partId));
    if (!part) return;
    
    const asm = data.find(d => d.isAsm && String(d.id) === String(part.parentId));
    const asmName = asm ? asm.name : '';
    
    let metaText = '';
    if (showAssembly && asmName) metaText += esc(asmName);
    if (showMfr && part.mfr) metaText += (metaText ? ' Â· ' : '') + esc(part.mfr);
    
    labelsHtml += '<div class="label">' +
      '<div class="label-inner">' +
      '<div class="label-name">' + esc(part.name) + '</div>' +
      '<div class="label-code">' + esc(part.code || 'â€”') + '</div>' +
      (metaText ? '<div class="label-meta">' + metaText + '</div>' : '') +
      '<div class="label-project">Project: ' + esc(projectName) + '</div>' +
      '</div></div>';
  });
  
  // Create print document (landscape layout, bigger fonts, no QR)
  const printDoc = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Label</title><style>' +
    '@page{size:' + ps.css + ';margin:0;}' +
    '*{margin:0;padding:0;box-sizing:border-box;}' +
    'body{font-family:Arial,sans-serif;}' +
    '.label{width:' + ps.w + ';height:' + ps.h + ';page-break-after:always;background:#fff;}' +
    '.label:last-child{page-break-after:auto;}' +
    '.label-inner{display:flex;flex-direction:column;justify-content:center;padding:2mm 3mm;height:100%;}' +
    '.label-name{font-size:12pt;font-weight:600;margin-bottom:1mm;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}' +
    '.label-code{font-size:14pt;font-weight:700;font-family:Consolas,monospace;margin-bottom:1mm;}' +
    '.label-meta{font-size:9pt;color:#333;margin-bottom:1mm;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}' +
    '.label-project{font-size:8pt;color:#666;}' +
    '</style></head><body>' + labelsHtml + '<script>window.print();<\/script></body></html>';
  
  // Open print window
  const printWin = window.open('', '_blank', 'width=400,height=200');
  if (printWin) {
    printWin.document.write(printDoc);
    printWin.document.close();
    
    // Close modal
    $('labelModal').classList.remove('open');
    $('labelModal').style.transform = '';
    $('popoverBackdrop').classList.remove('active');
    clearSelection();
    toast('Label' + (labelPartIds.length > 1 ? 's' : '') + ' sent to printer');
  } else {
    toast('Popup blocked - please allow popups', 1);
  }
};

// Label modal event handlers
$('labelSize').onchange = updateLabelPreview;
$('labelAssembly').onchange = updateLabelPreview;
$('labelMfr').onchange = updateLabelPreview;
$('labelClose').onclick = () => { $('labelModal').classList.remove('open'); $('labelModal').style.transform=''; $('popoverBackdrop').classList.remove('active'); };
$('labelCancel').onclick = () => { $('labelModal').classList.remove('open'); $('labelModal').style.transform=''; $('popoverBackdrop').classList.remove('active'); };

// Theme System
const THEMES=[
  {id:'default',name:'Claude Dark',colors:{bg:'#302e2b',bg2:'#282624',accent:'#8abadc',green:'#7fb87f',red:'#c08080'}},
  {id:'claude-light',name:'Claude Light',colors:{bg:'#ffffff',bg2:'#faf9f5',accent:'#1a66b2',green:'#1a7a1a',red:'#b04545'}}
];
let currentTheme=localStorage.getItem('ebs-theme')||'default';

function applyTheme(themeId){
  if(themeId==='default')document.documentElement.removeAttribute('data-theme');
  else document.documentElement.setAttribute('data-theme',themeId);
  currentTheme=themeId;
  localStorage.setItem('ebs-theme',themeId);
  renderThemeGrid();
}

function renderThemeGrid(){
  const grid=$('themeGrid');
  const lightThemes=['claude-light'];
  grid.innerHTML=THEMES.map(t=>{
    const isActive=t.id===currentTheme;
    const isLight=lightThemes.includes(t.id);
    return '<div class="theme-card'+(isActive?' active':'')+'" data-theme-id="'+t.id+'" style="background:'+t.colors.bg+';color:'+(isLight?'#2d2d2d':'#e8e8ec')+'"><div class="theme-name">'+t.name+'</div><div class="theme-preview"><span style="background:'+t.colors.bg2+'"></span><span style="background:'+t.colors.accent+'"></span><span style="background:'+t.colors.green+'"></span><span style="background:'+t.colors.red+'"></span></div></div>';
  }).join('');
  grid.querySelectorAll('.theme-card').forEach(card=>{
    card.onclick=()=>applyTheme(card.dataset.themeId);
  });
}

$('themeBtn').onclick=(e)=>{
  renderThemeGrid();
  const popover=$('themeModal');
  const btn=e.target.closest('button');
  const rect=btn.getBoundingClientRect();
  popover.style.top=(rect.bottom+8)+'px';
  popover.style.left=Math.max(10,rect.right-280)+'px';
  popover.classList.add('open');
  $('popoverBackdrop').classList.add('active');
};
$('themeClose').onclick=()=>{$('themeModal').classList.remove('open');$('popoverBackdrop').classList.remove('active')};
document.addEventListener('click',e=>{
  const popover=$('themeModal');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('#themeBtn')){
    popover.classList.remove('open');
    $('popoverBackdrop').classList.remove('active');
  }
});

// Item Code Configuration
function renderItemConfigList(){
  const codes=Object.keys(itemCodeConfig).sort();
  if(codes.length===0){
    $('icList').innerHTML='<div class="item-config-empty">No item codes configured yet.<br>Add configurations above to customize phase requirements.</div>';
    return;
  }
  let html='<div class="item-config-row header"><div>Item Code</div><div>Phases</div><div></div></div>';
  codes.forEach(code=>{
    const cfg=itemCodeConfig[code];
    let badges='';
    badges+=cfg.requiresConfig?'<span class="item-config-badge active">Config'+(cfg.configuredBy?' ('+esc(cfg.configuredBy)+')':'')+'</span>':'<span class="item-config-badge skip">Config</span>';
    badges+=cfg.requiresTesting?'<span class="item-config-badge active">Test'+(cfg.tester?' ('+esc(cfg.tester)+')':'')+'</span>':'<span class="item-config-badge skip">Test</span>';
    html+='<div class="item-config-row"><div class="item-config-code">'+esc(code)+'</div><div class="item-config-badges">'+badges+'</div><div class="item-config-actions"><button onclick="window.editItemConfig(\''+esc(code)+'\')">Edit</button><button onclick="window.deleteItemConfig(\''+esc(code)+'\')">Ã—</button></div></div>';
  });
  $('icList').innerHTML=html;
}

function updateItemConfigSelects(){
  const teamOpts='<option value="">Anyone</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');
  $('icConfigBy').innerHTML=teamOpts;
  $('icTestBy').innerHTML=teamOpts;
}

function clearItemConfigForm(){
  $('icCode').value='';
  $('icReqConfig').checked=false;
  $('icReqTest').checked=true;
  $('icConfigBy').value='';
  $('icTestBy').value='';
}

window.editItemConfig=function(code){
  const cfg=itemCodeConfig[code]||{};
  $('icCode').value=code;
  $('icReqConfig').checked=cfg.requiresConfig||false;
  $('icReqTest').checked=cfg.requiresTesting!==false;
  $('icConfigBy').value=cfg.configuredBy||'';
  $('icTestBy').value=cfg.tester||'';
};

window.deleteItemConfig=function(code){
  if(!confirm('Remove configuration for "'+code+'"?'))return;
  delete itemCodeConfig[code];
  saveItemCodeConfig();
  renderItemConfigList();
  render();
  toast('Removed');
};

$('itemConfigBtn').onclick=()=>{
  updateItemConfigSelects();
  renderItemConfigList();
  clearItemConfigForm();
  $('itemConfigModal').classList.add('open');
};

$('icClose').onclick=$('icDone').onclick=()=>closeModal('itemConfigModal');
$('itemConfigModal').onclick=e=>{if(e.target.id==='itemConfigModal')closeModal('itemConfigModal')};

$('icSave').onclick=()=>{
  const code=$('icCode').value.trim().toUpperCase();
  if(!code){toast('Enter item code',1);return}
  itemCodeConfig[code]={
    requiresConfig:$('icReqConfig').checked,
    configuredBy:$('icConfigBy').value,
    requiresTesting:$('icReqTest').checked,
    tester:$('icTestBy').value
  };
  saveItemCodeConfig();
  renderItemConfigList();
  clearItemConfigForm();
  render();
  toast('Saved: '+code);
};

$('icClear').onclick=clearItemConfigForm;

$('icExport').onclick=()=>{
  const json=JSON.stringify(itemCodeConfig,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='item-code-config.json';a.click();
  URL.revokeObjectURL(url);
  toast('Exported');
};

// Bulk operations button handlers
$('bulkStatusBtn').onclick=window.openBulkStatusModal;
$('bulkAssignBtn').onclick=window.openBulkAssignModal;
$('bulkPOBtn').onclick=window.openBulkPOModal;
$('bulkPrintBtn').onclick=window.openBulkLabelModal;
$('bulkDeleteBtn').onclick=window.openBulkDeleteModal;
$('bulkClearBtn').onclick=clearSelection;
$('selectAllParts').onclick=window.toggleSelectAll;
$('bulkStatusApply').onclick=window.applyBulkStatus;
$('bulkAssignApply').onclick=window.applyBulkAssign;
$('bulkPOApply').onclick=window.applyBulkPO;
$('bulkDeleteApply').onclick=window.applyBulkDelete;
$('bulkStatusCancel').onclick=()=>$('bulkStatusModal').classList.remove('open');
$('bulkAssignCancel').onclick=()=>$('bulkAssignModal').classList.remove('open');
$('bulkPOCancel').onclick=()=>$('bulkPOModal').classList.remove('open');
$('bulkDeleteCancel').onclick=()=>$('bulkDeleteModal').classList.remove('open');

// Initialize
applyTheme(currentTheme);
loadExpanded();
loadItemCodeConfig();

// Initialize auth and check for existing session
(async function initSession() {
  // First, initialize Firebase anonymous auth
  await initAuth();
  
  // Then check if we have a stored project code AND valid auth
  const storedCode = sessionStorage.getItem('ebs-project-code');
  if(storedCode && firebaseUser) {
    setProjectCode(storedCode);
    isAuthenticated = true;
    $('loginScreen').style.display = 'none';
    initFirebaseListeners();
  }
})();


// ===== MOBILE APP (completely separate from desktop) =====
(function(){
  const SLABELS={waiting:'Waiting','to-order':'To Order',ordered:'Ordered',arrived:'Arrived',installed:'Installed'};
  let mobFilterStatus='';
  let mobCurrentTab='parts';
  let mobEditPartId=null;
  let mobExpanded={};
  
  // Render mobile parts list
  function renderMobParts(){
    const parts=data.filter(d=>!d.isAsm&&!d._deletedAt);
    const asms=data.filter(d=>d.isAsm&&!d._deletedAt);
    
    // Update pipeline counts
    const counts={waiting:0,'to-order':0,ordered:0,arrived:0,tested:0,configured:0,installed:0};
    parts.forEach(p=>counts[p.status]=(counts[p.status]||0)+1);
    if($('mobP0'))$('mobP0').textContent=counts.waiting;
    if($('mobP1'))$('mobP1').textContent=counts['to-order'];
    if($('mobP2'))$('mobP2').textContent=counts.ordered;
    if($('mobP3'))$('mobP3').textContent=counts.arrived;
    if($('mobP4'))$('mobP4').textContent=counts.tested;
    if($('mobP5'))$('mobP5').textContent=counts.configured;
    if($('mobP6'))$('mobP6').textContent=counts.installed;
    
    // Update active state on pipes
    document.querySelectorAll('.mob-pipe').forEach(p=>{
      p.classList.toggle('active',p.dataset.status===mobFilterStatus);
    });
    
    // Filter parts
    let filteredParts=parts;
    if(mobFilterStatus)filteredParts=parts.filter(p=>p.status===mobFilterStatus);
    
    // Group by assembly
    let html='';
    asms.forEach(asm=>{
      const asmParts=filteredParts.filter(p=>String(p.parentId)===String(asm.id));
      if(asmParts.length===0&&mobFilterStatus)return;
      
      const allAsmParts=parts.filter(p=>String(p.parentId)===String(asm.id));
      const installed=allAsmParts.filter(p=>p.status==='installed').length;
      const pct=allAsmParts.length?Math.round(installed/allAsmParts.length*100):0;
      const isExpanded=mobExpanded[asm.id];
      
      html+='<div class="mob-asm'+(isExpanded?' expanded':'')+'" data-asm-id="'+asm.id+'">';
      html+='<div class="mob-asm-header">';
      html+='<span class="mob-asm-toggle">â–¶</span>';
      html+='<div class="mob-asm-info"><div class="mob-asm-name">'+esc(asm.name)+'</div><div class="mob-asm-meta">'+asmParts.length+' parts</div></div>';
      html+='<div class="mob-asm-progress"><div class="mob-asm-progress-bar" style="width:'+pct+'%"></div></div>';
      html+='<div class="mob-asm-pct">'+pct+'%</div>';
      html+='</div>';
      html+='<div class="mob-parts">';
      asmParts.forEach(p=>{
        html+='<div class="mob-part" data-part-id="'+p.id+'">';
        html+='<div class="mob-part-info"><div class="mob-part-name">'+esc(p.name)+'</div>';
        html+='<div class="mob-part-meta">';
        if(p.assignee)html+='<span>@'+esc(p.assignee)+'</span>';
        if(p.poNumber)html+='<span>PO: '+esc(p.poNumber)+'</span>';
        html+='</div></div>';
        html+='<span class="mob-status '+p.status+'">'+SLABELS[p.status]+'</span>';
        html+='<span class="mob-part-arrow">â€º</span>';
        html+='</div>';
      });
      html+='</div></div>';
    });
    
    if(!html)html='<div class="mob-empty">No parts found</div>';
    $('mobPartsList').innerHTML=html;
    
    // Attach events
    document.querySelectorAll('.mob-asm-header').forEach(h=>{
      h.onclick=()=>{
        const asm=h.closest('.mob-asm');
        const asmId=asm.dataset.asmId;
        mobExpanded[asmId]=!mobExpanded[asmId];
        asm.classList.toggle('expanded');
      };
    });
    
    document.querySelectorAll('.mob-part').forEach(p=>{
      p.onclick=(e)=>{
        e.stopPropagation();
        openMobPartModal(p.dataset.partId);
      };
    });
  }
  
  // Render mobile actions list
  function renderMobActions(){
    const actions=getActions();
    let html='';
    actions.forEach(a=>{
      html+='<div class="mob-action" data-action-id="'+a.id+'">';
      html+='<div class="mob-action-task">'+esc(a.task)+'</div>';
      html+='<div class="mob-action-meta">';
      if(a.assignee)html+='<span>@'+esc(a.assignee)+'</span>';
      if(a.due)html+='<span>Due: '+a.due+'</span>';
      html+='<span class="mob-action-status '+a.status+'">'+a.status+'</span>';
      html+='</div></div>';
    });
    if(!html)html='<div class="mob-empty">No actions yet</div>';
    $('mobActionsList').innerHTML=html;
  }
  
  // Open part modal
  function openMobPartModal(partId){
    const part=data.find(d=>String(d.id)===String(partId));
    if(!part)return;
    mobEditPartId=partId;
    $('mobPartTitle').textContent=part.name;
    $('mobPartName').value=part.name||'';
    $('mobPartStatus').value=part.status||'waiting';
    $('mobPartPO').value=part.poNumber||'';
    
    // Populate assignee dropdown
    let assigneeHtml='<option value="">â€” Unassigned â€”</option>';
    team.forEach(t=>{
      assigneeHtml+='<option value="'+esc(t.name)+'"'+(part.assignee===t.name?' selected':'')+'>'+esc(t.name)+'</option>';
    });
    $('mobPartAssignee').innerHTML=assigneeHtml;
    
    $('mobPartModal').classList.add('open');
  }
  
  // Save part from modal
  function saveMobPart(){
    if(!mobEditPartId)return;
    const part=data.find(d=>String(d.id)===String(mobEditPartId));
    if(!part)return;
    
    const newStatus=$('mobPartStatus').value;
    const oldStatus=part.status;
    
    part.name=$('mobPartName').value;
    part.status=newStatus;
    part.assignee=$('mobPartAssignee').value;
    part.poNumber=$('mobPartPO').value;
    
    if(newStatus!==oldStatus){
      part.changedAt=Date.now();
      history.push({ts:Date.now(),action:'Status â†’ '+SLABELS[newStatus],item:part.name,partId:part.id});
    }
    
    saveItem(part);
    $('mobPartModal').classList.remove('open');
    mobEditPartId=null;
    renderMobParts();
    render(); // Sync desktop
  }
  
  // Mobile render function
  function renderMobile(){
    if(!$('mobileApp'))return;
    $('mobLogo').textContent=currentProjectName||'EF Final Assembly';
    renderMobParts();
    renderMobActions();
  }
  
  // Hook into main render
  const origRender=window.render||render;
  if(typeof render==='function'){
    const _origRender=render;
    window.render=function(){
      _origRender.apply(this,arguments);
      renderMobile();
    };
  }
  
  // Initialize mobile events
  document.addEventListener('DOMContentLoaded',()=>{
    // Pipeline filter
    document.querySelectorAll('.mob-pipe').forEach(p=>{
      p.onclick=()=>{
        const status=p.dataset.status;
        mobFilterStatus=mobFilterStatus===status?'':status;
        renderMobParts();
      };
    });
    
    // Tabs
    document.querySelectorAll('.mob-tab').forEach(t=>{
      t.onclick=()=>{
        document.querySelectorAll('.mob-tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        mobCurrentTab=t.dataset.mobTab;
        $('mobPartsList').style.display=mobCurrentTab==='parts'?'block':'none';
        $('mobActionsList').style.display=mobCurrentTab==='actions'?'block':'none';
      };
    });
    
    // Part modal
    $('mobPartBack').onclick=()=>$('mobPartModal').classList.remove('open');
    $('mobPartCancel').onclick=()=>$('mobPartModal').classList.remove('open');
    $('mobPartSave').onclick=saveMobPart;
    
    // Menu
    $('mobMenuBtn').onclick=()=>$('mobMenuModal').classList.add('open');
    $('mobMenuBack').onclick=()=>$('mobMenuModal').classList.remove('open');
    $('mobSampleBtn').onclick=()=>{
      $('mobMenuModal').classList.remove('open');
      if(typeof loadSampleData==='function')loadSampleData();
    };
    $('mobSignOutBtn').onclick=()=>{
      $('mobMenuModal').classList.remove('open');
      if(typeof signOut==='function')signOut();
    };
    
    // Initial render
    setTimeout(renderMobile,100);
  });
})();

})();
</script>
</body>
</html>
