<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>EBS v3 - Cloud</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<style>
:root{--bg:#2f2f2f;--bg2:#3d3d3d;--bg3:#4a4a4a;--bg4:#5a5a5a;--border:#4a4a4a;--text:#ececec;--text2:#a0a0a0;--text3:#707070;--accent:#da7756;--green:#5cb85c;--yellow:#f0c36d;--orange:#e89a5a;--red:#d9534f;--cyan:#5bc0de;--purple:#a87fd1;--s1:#d9534f;--s2:#e89a5a;--s3:#f0c36d;--s4:#a87fd1;--s5:#5bc0de;--s6:#5cb85c}
[data-theme="claude-light"]{--bg:#f5f4f2;--bg2:#ffffff;--bg3:#eae8e4;--bg4:#ddd9d4;--border:#d4d0ca;--text:#2d2d2d;--text2:#6b6b6b;--text3:#9a9a9a;--accent:#da7756;--green:#3d8c40;--yellow:#c49a30;--orange:#c67840;--red:#c44540;--cyan:#3a8ea8;--purple:#7c5aad;--s1:#c44540;--s2:#c67840;--s3:#c49a30;--s4:#7c5aad;--s5:#3a8ea8;--s6:#3d8c40}
[data-theme="graphite"]{--bg:#1c1c1e;--bg2:#2c2c2e;--bg3:#3a3a3c;--bg4:#48484a;--border:#38383a;--text:#f5f5f7;--text2:#a1a1a6;--text3:#636366;--accent:#98989d;--green:#30d158;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#64d2ff;--purple:#bf5af2}
[data-theme="midnight"]{--bg:#0a1628;--bg2:#0f1f33;--bg3:#152840;--bg4:#1c334d;--border:#234060;--text:#e0e8f0;--text2:#8aa4c0;--text3:#506880;--accent:#0a84ff;--green:#30d158;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#64d2ff;--purple:#bf5af2}
[data-theme="forest"]{--bg:#161d14;--bg2:#1e271a;--bg3:#283422;--bg4:#32402a;--border:#3d4d32;--text:#e8f0e6;--text2:#9db396;--text3:#6a8060;--accent:#30d158;--green:#32d74b;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#64d2ff;--purple:#bf5af2}
[data-theme="sunset"]{--bg:#1e1614;--bg2:#2a1e1a;--bg3:#382822;--bg4:#46322a;--border:#5a4035;--text:#f5ebe8;--text2:#c4a69a;--text3:#8a6a5c;--accent:#ff9f0a;--green:#30d158;--yellow:#ffd60a;--orange:#ff9500;--red:#ff453a;--cyan:#64d2ff;--purple:#bf5af2}
[data-theme="ocean"]{--bg:#0f1a1e;--bg2:#152228;--bg3:#1c2c34;--bg4:#243640;--border:#2d4250;--text:#e6f2f5;--text2:#8fc4d4;--text3:#4a8a9e;--accent:#64d2ff;--green:#30d158;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#5ac8fa;--purple:#bf5af2}
[data-theme="lavender"]{--bg:#1a181e;--bg2:#242028;--bg3:#302a36;--bg4:#3c3444;--border:#4a4058;--text:#f5f0fa;--text2:#b8a8d0;--text3:#7a6890;--accent:#bf5af2;--green:#30d158;--yellow:#ffd60a;--orange:#ff9f0a;--red:#ff453a;--cyan:#64d2ff;--purple:#da8aff}
[data-theme="highcontrast"]{--bg:#000000;--bg2:#1c1c1e;--bg3:#2c2c2e;--bg4:#3a3a3c;--border:#545456;--text:#ffffff;--text2:#ebebf0;--text3:#aeaeb2;--accent:#409cff;--green:#30db5b;--yellow:#ffd426;--orange:#ffb340;--red:#ff6961;--cyan:#70d7ff;--purple:#da8fff}
.theme-modal{max-width:480px}
.theme-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.theme-card{padding:14px;border-radius:12px;cursor:pointer;border:2px solid transparent;background:var(--bg3);transition:all .2s;position:relative}
.theme-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.theme-card.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(10,132,255,.3)}
.theme-card.active::after{content:'âœ“';position:absolute;top:10px;right:12px;font-size:14px;font-weight:bold;color:var(--accent)}
.theme-name{font-size:12px;font-weight:600;margin-bottom:8px}
.theme-preview{display:flex;gap:4px;height:24px;border-radius:6px;overflow:hidden}
.theme-preview span{flex:1;border-radius:4px}
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:var(--bg4) transparent}
*::-webkit-scrollbar{width:6px;height:6px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
*::-webkit-scrollbar-thumb:hover{background:var(--text3)}
html,body{height:100%;overflow:hidden;overflow-x:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","SF Pro Text",system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:13px;-webkit-font-smoothing:antialiased;line-height:1.5}
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 18px;display:flex;align-items:center;position:fixed;top:0;left:0;right:0;z-index:100;height:54px;gap:12px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.logo{font-weight:600;font-size:15px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:140px;max-width:280px;letter-spacing:-0.2px;flex-shrink:0}
.header-search{position:relative;width:220px;flex-shrink:0}
.header-search input{width:100%;height:32px;padding:0 32px 0 12px;font-size:13px;color:var(--text);background:var(--bg3);border:none;border-radius:8px}
.header-search input:focus{outline:none;box-shadow:0 0 0 2px rgba(10,132,255,.3)}
.header-search input::placeholder{color:var(--text3)}
.header-search-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:18px;height:18px;background:var(--bg4);border:none;border-radius:50%;color:var(--text3);font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center}
.header-search-clear.visible{display:flex}
.header-search-clear:hover{background:var(--text3);color:var(--bg)}
.ai-console-btn{display:flex;align-items:center;gap:10px;padding:6px 14px 6px 6px;background:transparent;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:400;color:var(--text);transition:all .15s;flex-shrink:0}
.ai-console-btn:hover{background:rgba(255,255,255,0.06)}
.ai-console-icon{width:26px;height:26px;border-radius:50%;background:#d4776b;display:flex;align-items:center;justify-content:center;font-size:18px;color:white;font-weight:300;line-height:1}
.header-spacer{flex:1}
.header-metrics{display:flex;align-items:center;gap:8px}
.hm{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border-radius:10px}
.hm-label{font-size:10px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px}
.hm-value{font-size:15px;font-weight:600;letter-spacing:-0.3px}
.hm-progress{min-width:180px}
.hm-bar{width:100px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.hm-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.header-btns{display:flex;gap:8px}
.version-badge{font-size:9px;color:var(--text3);padding:4px 8px;background:var(--bg);border-radius:4px;margin-left:8px;font-family:monospace}
.btn{height:34px;padding:0 16px;font-size:13px;font-weight:500;color:var(--text);background:var(--bg3);border:none;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:all .2s}
.btn:hover{background:var(--bg4)}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent);filter:brightness(1.1)}
.btn-report{background:var(--bg3);color:var(--text)}
.btn-report:hover{background:var(--bg4)}
.btn-save{background:var(--bg3);color:var(--text)}
.btn-save:hover{background:var(--bg4)}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:var(--red);filter:brightness(1.1)}
.po-modal{max-width:360px}
.po-note{font-size:11px;color:var(--text3);margin-top:4px;font-style:italic}
.delete-modal{max-width:320px}
.notes-cell{font-size:11px;color:var(--text3);font-style:italic;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.eta-cell{display:flex;flex-direction:column;gap:2px;font-size:11px}
.eta-date{cursor:pointer}
.eta-date.historical{color:var(--text3)}
.eta-date.user-set{color:var(--green)}
.eta-po{font-size:10px;color:var(--accent);cursor:pointer;font-weight:500}
.eta-po:hover{text-decoration:underline}
.autocomplete-wrapper{position:relative;width:100%}
.autocomplete-wrapper input{width:100%;height:26px;padding:2px 8px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--accent);border-radius:4px;outline:none}
.autocomplete-list{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:8px;max-height:180px;overflow-y:auto;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.5);display:none}
.autocomplete-list.open{display:block}
.autocomplete-item{padding:8px 12px;font-size:13px;cursor:pointer;color:var(--text)}
.autocomplete-item:hover,.autocomplete-item.selected{background:var(--bg4)}
.autocomplete-item em{color:var(--accent);font-style:normal;font-weight:600}
.main{padding:14px 18px;padding-top:68px;max-width:1600px;margin:0 auto;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.pipeline{display:flex;gap:6px;margin-bottom:10px;flex-shrink:0}
.pipe{flex:1;background:var(--bg2);border:none;border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;position:relative;transition:all .15s}
.pipe::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0;opacity:.8}
.pipe[data-s="to-order"]::before{background:var(--s1)}.pipe[data-s="ordered"]::before{background:var(--s2)}.pipe[data-s="arrived"]::before{background:var(--s3)}.pipe[data-s="configured"]::before{background:var(--s4)}.pipe[data-s="tested"]::before{background:var(--s5)}.pipe[data-s="installed"]::before{background:var(--s6)}
.pipe:hover{background:var(--bg3)}.pipe.active{background:var(--bg3)}
.pipe-count{font-size:18px;font-weight:600;letter-spacing:-0.5px}
.pipe[data-s="to-order"] .pipe-count{color:var(--s1)}.pipe[data-s="ordered"] .pipe-count{color:var(--s2)}.pipe[data-s="arrived"] .pipe-count{color:var(--s3)}.pipe[data-s="configured"] .pipe-count{color:var(--s4)}.pipe[data-s="tested"] .pipe-count{color:var(--s5)}.pipe[data-s="installed"] .pipe-count{color:var(--s6)}
.pipe-label{font-size:10px;font-weight:500;color:var(--text2);text-transform:uppercase;letter-spacing:0.3px;margin-top:2px}
.tabs{display:flex;background:var(--bg2);border:none;border-radius:10px;padding:3px;margin-bottom:10px;gap:2px;flex-shrink:0}
.tab{flex:1;height:30px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:500;color:var(--text2);background:transparent;border:none;border-radius:8px;cursor:pointer;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{background:var(--bg4);color:var(--text);font-weight:600}
.toolbar{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-shrink:0}
.search{flex:1;height:34px;padding:0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:none;border-radius:10px}
.search:focus{outline:none;box-shadow:0 0 0 3px rgba(10,132,255,.3)}
.search::placeholder{color:var(--text3)}
.filter-select{height:34px;padding:0 12px;font-size:13px;color:var(--text);background:var(--bg2);border:none;border-radius:10px;cursor:pointer}
.toggle-btn{height:34px;padding:0 14px;font-size:12px;font-weight:500;color:var(--text2);background:var(--bg2);border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
.toggle-btn:hover{background:var(--bg3);color:var(--text)}
.toggle-btn.expanded{background:var(--bg3);color:var(--accent)}
.toggle-btn .arrow{font-size:9px;transition:transform .2s}
.panel{display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden;-webkit-overflow-scrolling:touch}.panel.active{display:flex}
.filter-badges{margin-bottom:6px;flex-shrink:0}
.filter-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(10,132,255,.15);color:var(--accent);padding:4px 10px;border-radius:8px;font-size:12px;font-weight:500;margin-right:6px}
.filter-badge button{background:rgba(255,255,255,.2);border:none;color:var(--accent);width:16px;height:16px;border-radius:50%;cursor:pointer;font-size:11px}
.data-table{background:var(--bg2);border:none;border-radius:14px;display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.table-header{display:grid;gap:1px;padding:0 12px;background:var(--bg3);font-size:11px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px;height:36px;align-items:center;flex-shrink:0}
.table-body{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.parts-grid{grid-template-columns:22px 22px minmax(80px,1fr) 100px 100px 60px 30px 62px 70px 100px minmax(100px,180px) 32px 32px 32px 32px}
.add-row{display:flex;align-items:center;padding:8px 12px;background:var(--bg)}
.add-row-btn{width:24px;height:24px;background:var(--bg3);border:none;border-radius:8px;color:var(--text3);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-right:10px;transition:all .15s}
.add-row-btn:hover{background:var(--accent);color:#fff}
.add-row-text{font-size:12px;color:var(--text3)}
.asm-row{display:grid;gap:1px;padding:0 12px;background:var(--bg3);height:40px;align-items:center;cursor:pointer;transition:background .15s;grid-template-columns:22px 22px 28px minmax(80px,1fr) 100px 100px 60px 30px 62px 240px minmax(100px,180px) 44px 32px}
.asm-row:hover{background:var(--bg4)}
.asm-priority{display:flex;flex-direction:column;gap:1px;align-items:center}
.asm-priority-btn{width:18px;height:14px;background:transparent;border:none;color:var(--text3);font-size:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:3px;transition:all .15s}
.asm-priority-btn:hover{background:var(--bg4);color:var(--text)}
.asm-priority-btn:active{background:var(--accent);color:#fff}
.asm-toggle{width:20px;height:20px;background:transparent;border:none;color:var(--text2);font-size:10px;cursor:pointer;pointer-events:none}
.asm-name{font-weight:600;font-size:13px;color:var(--accent);pointer-events:none}
.asm-meta{font-size:11px;color:var(--text3);pointer-events:none}
.asm-progress{display:flex;align-items:center;gap:8px}
.asm-bar{width:180px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;display:block}
.asm-bar-fill{height:100%;border-radius:3px;display:block}
.asm-pct{font-size:12px;font-weight:600;min-width:40px}
.stage-dots{display:flex;align-items:center;gap:4px}
.stage-dot{width:8px;height:8px;border-radius:50%;background:var(--bg4)}
.stage-dot.done{background:var(--green)}
.stage-dot.current{background:var(--accent);box-shadow:0 0 0 3px rgba(10,132,255,.2)}
.asm-actions{display:flex;gap:4px}
.sm-btn{width:24px;height:24px;background:var(--bg4);border:none;border-radius:6px;color:var(--text3);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.sm-btn:hover{background:var(--bg);color:var(--text);transform:scale(1.05)}.sm-btn.red{color:var(--red);opacity:0.7}.sm-btn.red:hover{opacity:1;background:rgba(255,69,58,.15);transform:scale(1.05)}
.part-row{display:grid;gap:1px;padding:0 12px;background:var(--bg2);height:38px;align-items:center;transition:background .15s}
.part-row:hover{background:var(--bg3)}.part-row.child{background:var(--bg)}.part-row.child:hover{background:var(--bg3)}
.part-row.subchild{background:var(--bg);border-left:2px solid var(--border);margin-left:10px}
.part-row.highlight{background:rgba(10,132,255,.1)}
.part-indent{font-size:10px;color:var(--text3);text-align:center}
.subpart-add{width:18px;height:18px;border-radius:4px;background:transparent;border:1px dashed var(--border);color:var(--text3);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.subpart-add:hover{background:var(--accent);border-color:var(--accent);color:#fff}
.cell{font-size:13px;color:var(--text);padding:4px 6px;border-radius:6px;cursor:text;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:20px;display:flex;align-items:center}
.cell.editing{overflow:visible;position:relative;z-index:100}
.cell.editing{overflow:visible;position:relative;z-index:50}
.cell:hover{background:var(--bg4)}.cell.editing{background:var(--bg);padding:0}
.cell input,.cell select{width:100%;height:26px;padding:0 8px;font-size:13px;color:var(--text);background:var(--bg);border:2px solid var(--accent);border-radius:6px;outline:none}
.cell.muted{color:var(--text2)}.cell.note{font-style:italic;color:var(--text3);font-size:11px;margin-left:6px}
.status-badge{font-size:10px;font-weight:600;padding:4px 8px;border-radius:6px;text-align:center;display:inline-block}
.status-badge.to-order{background:rgba(255,69,58,.15);color:var(--s1)}.status-badge.ordered{background:rgba(255,159,10,.15);color:var(--s2)}.status-badge.arrived{background:rgba(255,214,10,.15);color:var(--s3)}.status-badge.configured{background:rgba(168,127,209,.15);color:var(--s4)}.status-badge.tested{background:rgba(100,210,255,.15);color:var(--s5)}.status-badge.installed{background:rgba(48,209,88,.15);color:var(--s6)}
.eta-badge{font-size:11px;padding:4px 8px;border-radius:6px;background:var(--bg4);color:var(--text2);cursor:pointer;font-weight:500}
.eta-badge:hover{background:var(--bg3);color:var(--text)}
.eta-badge.has-data{background:rgba(191,90,242,.15);color:var(--purple)}
.eta-badge.manual{background:rgba(48,209,88,.15);color:var(--green)}
.action-indicator{width:18px;height:18px;background:var(--yellow);color:var(--bg);border-radius:6px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer}
.adv-btn{width:24px;height:24px;font-size:12px;font-weight:600;color:var(--text2);background:var(--bg3);border:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.adv-btn:hover{background:var(--bg4);color:var(--text);transform:scale(1.05)}.adv-btn.done{color:var(--green);cursor:default}.adv-btn.done:hover{transform:none}
.empty{padding:40px 20px;text-align:center;color:var(--text3);font-size:13px;flex:1;display:flex;align-items:center;justify-content:center}
.action-grid{grid-template-columns:minmax(140px,1fr) 110px 70px 90px 70px 70px 70px 70px}
.action-row{display:grid;gap:1px;padding:0 12px;background:var(--bg2);height:38px;align-items:center}
.action-row:hover{background:var(--bg3)}
.action-task{font-size:13px}.action-task.completed{text-decoration:line-through;color:var(--text3)}
.action-progress-bar{width:100%;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.action-progress-fill{height:100%;border-radius:3px;transition:width .3s}
.action-link{font-size:11px;color:var(--accent);cursor:pointer}.action-link:hover{text-decoration:underline}
.action-due{font-size:12px;color:var(--text2)}.action-due.overdue{color:var(--red);font-weight:600}.action-due.soon{color:var(--yellow)}
.action-status{font-size:10px;font-weight:600;padding:4px 8px;border-radius:6px;text-align:center}
.action-status.not-started{background:rgba(255,69,58,.15);color:var(--s1)}.action-status.in-progress{background:rgba(255,214,10,.15);color:var(--s3)}.action-status.completed{background:rgba(48,209,88,.15);color:var(--s5)}
.progress-layout{display:flex;flex-direction:column;gap:12px;flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.progress-top{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.progress-top{grid-template-columns:1fr}}
.card{background:var(--bg2);border:none;border-radius:14px;padding:16px;display:flex;flex-direction:column;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.card-title{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.card-title a{font-size:12px;color:var(--accent);cursor:pointer;text-transform:none;font-weight:500}
.burndown-container{background:var(--bg);border-radius:10px;padding:12px;flex:1;display:flex;align-items:center;justify-content:center;min-height:180px}
.burndown-container svg{display:block;width:100%;height:100%}
.burndown-dates{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-top:8px}
.burndown-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);font-size:13px;cursor:pointer;gap:6px}
.burndown-legend{display:flex;gap:16px;margin-top:10px;font-size:11px;color:var(--text2)}
.legend-item{display:flex;align-items:center;gap:6px}
.legend-dot{width:10px;height:3px;border-radius:2px}
.legend-dot.green{background:var(--green)}.legend-dot.red{background:var(--red)}.legend-dot.gray{background:var(--text3)}
.insights-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ins-group{margin-bottom:12px}.ins-group:last-child{margin-bottom:0}
.ins-group-title{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;padding:0 4px}
.ins-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg);border-radius:8px;font-size:12px}
.ins-label{color:var(--text2)}.ins-val{font-weight:600}
.ins-val.green{color:var(--green)}.ins-val.red{color:var(--red)}.ins-val.yellow{color:var(--yellow)}.ins-val.cyan{color:var(--cyan)}.ins-val.orange{color:var(--orange)}
.forecast-card{background:var(--bg);border-radius:10px;padding:12px;margin-top:8px;border-left:3px solid var(--purple)}
.forecast-title{font-size:10px;font-weight:600;color:var(--purple);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.forecast-main{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.forecast-date{font-size:20px;font-weight:700;letter-spacing:-0.5px}
.forecast-label{font-size:12px;color:var(--text2)}
.forecast-detail{font-size:11px;color:var(--text3)}
.gantt-wrap{background:var(--bg2);border:none;border-radius:12px;overflow:hidden}
.gantt-header-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--bg3)}
.gantt-title{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px}
.gantt-dates{font-size:12px;color:var(--text)}
.gantt-scroll{overflow:auto;max-height:calc(100vh - 420px);-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
.gantt-inner{min-width:800px}
.gantt-header{display:flex;background:var(--bg3);position:sticky;top:0;z-index:10}
.gantt-label-col{width:180px;min-width:180px;padding:10px 16px;font-size:11px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px;border-right:1px solid var(--border)}
.gantt-weeks{display:flex;position:relative;flex:1}
.gantt-week{width:70px;min-width:70px;padding:10px 4px;text-align:center;font-size:11px;font-weight:500;color:var(--text3);border-right:1px solid var(--border)}
.gantt-week.current{background:rgba(10,132,255,.1);color:var(--accent)}
.gantt-now-line{position:absolute;top:0;bottom:0;width:2px;background:var(--accent);z-index:5;pointer-events:none}
.gantt-row{display:flex;position:relative}
.gantt-row:hover{background:var(--bg3)}.gantt-row.asm{background:var(--bg3)}.gantt-row.asm:hover{background:var(--bg4)}
.gantt-row-label{width:180px;min-width:180px;padding:10px 16px;font-size:13px;border-right:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;cursor:pointer;gap:8px}
.gantt-row-label:hover{color:var(--accent)}.gantt-row-label.asm{font-weight:600;color:var(--accent)}.gantt-row-label.child{padding-left:28px;color:var(--text2);font-size:12px}
.gantt-row-priority{font-size:10px;color:var(--text3);background:var(--bg4);padding:2px 6px;border-radius:4px}
.gantt-cells{display:flex;position:relative;flex:1}
.gantt-cell{width:70px;min-width:70px;border-right:1px solid var(--border);display:flex;align-items:center;justify-content:center;padding:6px}
.gantt-bar{height:24px;border-radius:6px;font-size:10px;font-weight:600;color:#fff;display:flex;align-items:center;justify-content:center;min-width:60px;cursor:pointer}
.gantt-bar.to-order{background:var(--s1)}.gantt-bar.ordered{background:var(--s2)}.gantt-bar.arrived{background:var(--s3);color:#1c1c1e}.gantt-bar.configured{background:var(--s4)}.gantt-bar.tested{background:var(--s5);color:#1c1c1e}.gantt-bar.installed{background:var(--s6)}.gantt-bar.asm-bar{background:var(--accent)}
.ai-modal{max-width:720px;width:95vw}
.ai-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--text2)}
.ai-loading-spinner{width:32px;height:32px;border:3px solid var(--bg4);border-top-color:var(--purple);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.ai-loading-text{font-size:14px;color:#888;font-style:italic}
.ai-loading-sub{font-size:10px;color:var(--text3);margin-top:4px}
.ai-report{font-size:12px;line-height:1.7}
.ai-report-section{margin-bottom:16px}
.ai-report-header{display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.ai-report-header-icon{font-size:14px}
.ai-report-items{display:flex;flex-direction:column;gap:6px}
.ai-report-item{display:flex;gap:8px;padding:8px 10px;background:var(--bg);border-radius:6px;font-size:11px;align-items:flex-start}
.ai-report-item.critical{border-left:3px solid var(--red)}
.ai-report-item.warning{border-left:3px solid var(--yellow)}
.ai-report-item.info{border-left:3px solid var(--cyan)}
.ai-report-item.success{border-left:3px solid var(--green)}
.ai-report-bullet{flex-shrink:0;margin-top:2px}
.ai-report-text{flex:1}
.ai-report-meta{font-size:10px;color:var(--text3);margin-top:2px}
.ai-summary{background:var(--bg);padding:12px;border-radius:8px;margin-bottom:16px;font-size:12px;line-height:1.6;border-left:3px solid var(--purple)}
.ai-error{text-align:center;padding:30px;color:var(--text3)}
.ai-error-icon{font-size:24px;margin-bottom:8px}
.ai-error-msg{font-size:12px;margin-bottom:12px}
.ai-insights-list{display:flex;flex-direction:column;gap:8px}
.ai-insight{display:flex;gap:10px;padding:10px;background:var(--bg);border-radius:6px;border-left:3px solid var(--border);cursor:pointer}
.ai-insight:hover{background:var(--bg3)}
.ai-insight.critical{border-color:var(--red)}.ai-insight.warning{border-color:var(--yellow)}.ai-insight.info{border-color:var(--cyan)}.ai-insight.success{border-color:var(--green)}
.ai-insight-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.ai-insight.critical .ai-insight-icon{background:rgba(201,74,74,.15);color:var(--red)}.ai-insight.warning .ai-insight-icon{background:rgba(201,162,39,.15);color:var(--yellow)}.ai-insight.info .ai-insight-icon{background:rgba(58,168,168,.15);color:var(--cyan)}.ai-insight.success .ai-insight-icon{background:rgba(61,181,114,.15);color:var(--green)}
.ai-insight-content{flex:1}
.ai-insight-title{font-size:12px;font-weight:600;margin-bottom:2px}
.ai-insight-desc{font-size:10px;color:var(--text2)}
.ai-insight-action{font-size:9px;color:var(--accent);margin-top:4px}
.ai-timestamp{font-size:9px;color:var(--text3);text-align:right;margin-top:12px;padding-top:8px;border-top:1px solid var(--border)}
.ai-source{font-size:10px;color:var(--text3);text-align:center;padding:6px;margin-bottom:12px;background:var(--bg);border-radius:6px}
.report-modal{max-width:640px}
.report-content{background:var(--bg);border-radius:6px;padding:16px;font-size:11px;line-height:1.6;max-height:440px;overflow-y:auto;white-space:pre-wrap;font-family:monospace}
.report-meta{font-size:10px;color:var(--text3);margin-bottom:12px;display:flex;justify-content:space-between}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);justify-content:center;align-items:center;z-index:1000;padding:16px}
.modal-bg.open{display:flex}

/* Small contextual popover */
.popover{position:fixed;background:var(--bg2);border:1px solid var(--bg4);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:1001;padding:14px 16px;min-width:180px;max-width:260px;opacity:0;transform:scale(0.95) translateY(-4px);transition:opacity 0.15s ease,transform 0.15s ease;pointer-events:none}
.popover.open{opacity:1;transform:scale(1) translateY(0);pointer-events:auto}
.popover-msg{font-size:13px;margin-bottom:12px;line-height:1.4;color:var(--text)}
.popover-btns{display:flex;gap:8px;justify-content:flex-end}
.popover-btns .btn{padding:6px 12px;font-size:11px;min-width:60px}

/* Backdrop blur for popovers */
.popover-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.15);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);z-index:999;opacity:0;transition:opacity 0.2s ease;pointer-events:none}
.popover-backdrop.active{opacity:1;pointer-events:auto}

/* Popover-style modal (positioned near trigger) */
.modal-popover{position:fixed;background:var(--bg2);border:1px solid var(--bg4);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.4);z-index:1001;width:320px;max-width:calc(100vw - 32px);max-height:calc(100vh - 100px);overflow:auto;opacity:0;transform:scale(0.95);transition:opacity 0.18s ease,transform 0.18s ease;pointer-events:none}
.modal-popover.open{opacity:1;transform:scale(1);pointer-events:auto}
.modal-popover .modal-head{padding:12px 16px;border-bottom:1px solid var(--bg4);display:flex;justify-content:space-between;align-items:center}
.modal-popover .modal-title{font-size:14px;font-weight:600}
.modal-popover .modal-close{background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer;padding:0 4px}
.modal-popover .modal-body{padding:14px 16px}
.modal-popover .modal-foot{padding:12px 16px;border-top:1px solid var(--bg4);display:flex;gap:8px;justify-content:flex-end}
.modal-popover .field{margin-bottom:12px}
.modal-popover .field-label{font-size:11px;margin-bottom:4px;color:var(--text2)}
.modal-popover .field-input,.modal-popover .field-select,.modal-popover .field-textarea{width:100%;padding:8px 10px;font-size:12px}
.modal-popover .field-textarea{min-height:50px;resize:vertical}
.modal-popover .field-row{display:flex;gap:10px}
.modal-popover .field-row .field{flex:1;margin-bottom:12px}
.modal-popover .btn{padding:7px 14px;font-size:12px}
.modal-popover .notify-btn{width:100%;padding:8px;font-size:11px;margin-top:4px}

/* AI popover specific - Claude UI style */
.ai-popover{width:700px;max-width:calc(100vw - 32px);background:#2f2f2f;border:1px solid #3d3d3d;border-radius:16px;box-shadow:0 24px 80px rgba(0,0,0,0.5)}
.ai-popover .modal-body{padding:0;display:flex;flex-direction:column;max-height:70vh}
.ai-popover .modal-head{display:flex;align-items:center;gap:12px;border-bottom:1px solid #3d3d3d;padding:16px 24px}
.ai-popover .modal-title{flex:1;font-size:15px;font-weight:500;color:#e8e8e8}
.ai-popover .modal-close{background:#3d3d3d;color:#999;width:32px;height:32px;font-size:18px}
.ai-popover .modal-close:hover{background:#4d4d4d;color:#ccc}
.ai-title-icon{color:#d4776b;font-size:14px;margin-right:4px}
.ai-model-badge{font-size:11px;color:#777;font-family:-apple-system,system-ui,sans-serif;background:#3d3d3d;padding:5px 12px;border-radius:6px;font-weight:500}
.ai-content{flex:1;overflow-y:auto;padding:24px;min-height:200px;background:#212121}
.ai-welcome{color:#777;font-size:15px;line-height:1.7}
.ai-welcome p{margin:0}
.ai-welcome strong{color:#aaa;font-weight:600}
.ai-prose{font-size:15px;line-height:1.8;color:#e0e0e0}
.ai-prose p{margin-bottom:20px}
.ai-prose p:last-child{margin-bottom:0}
.ai-part-link{color:#60a5fa;cursor:pointer;text-decoration:underline;text-decoration-color:rgba(96,165,250,0.4);text-underline-offset:3px;transition:all .15s}
.ai-part-link:hover{color:#93c5fd;text-decoration-color:rgba(147,197,253,0.6)}
.ai-asm-link{color:#2dd4bf;cursor:pointer;text-decoration:underline;text-decoration-color:rgba(45,212,191,0.4);text-underline-offset:3px;transition:all .15s}
.ai-asm-link:hover{color:#5eead4;text-decoration-color:rgba(94,234,212,0.6)}
.ai-input-row{display:flex;align-items:center;gap:12px;padding:16px 24px;border-top:1px solid #3d3d3d;background:#2f2f2f;border-radius:0 0 16px 16px}
.ai-input-row input{flex:1;height:48px;padding:0 18px;font-size:15px;background:#212121;border:1px solid #3d3d3d;border-radius:12px;color:#e8e8e8;transition:border-color .15s}
.ai-input-row input:focus{outline:none;border-color:#555}
.ai-input-row input::placeholder{color:#666}
.ai-input-row .btn{height:48px;padding:0 24px;font-size:14px;font-weight:500;border-radius:10px}
.ai-input-row .btn:first-of-type{background:#3d3d3d;color:#ccc}
.ai-input-row .btn:first-of-type:hover{background:#4a4a4a}
.btn-tell{background:linear-gradient(135deg,#7c5cff 0%,#6366f1 100%);color:white;border:none}
.btn-tell:hover{filter:brightness(1.1)}
.ai-conversation{display:flex;flex-direction:column;gap:28px}
.ai-message{font-size:15px;line-height:1.8}
.ai-message.user{color:#888;font-size:14px}
.ai-user-label{color:#60a5fa;font-weight:500}
.ai-message.assistant{color:#e0e0e0}
.ai-message.assistant p{margin:0 0 16px 0}
.ai-message.assistant p:last-child{margin-bottom:0}
.modal{background:var(--bg2);width:100%;max-width:400px;max-height:85vh;overflow-y:auto;border-radius:16px;border:none;box-shadow:0 16px 48px rgba(0,0,0,.25);-webkit-overflow-scrolling:touch}
.modal-head{padding:16px 18px;display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px;letter-spacing:-0.2px}
.modal-close{width:28px;height:28px;background:var(--bg3);border:none;border-radius:8px;color:var(--text2);font-size:14px;cursor:pointer;transition:all .15s}
.modal-close:hover{background:var(--bg4);color:var(--text)}
.modal-body{padding:4px 18px 18px}
.modal-foot{padding:14px 18px;background:var(--bg3);display:flex;gap:8px;border-radius:0 0 14px 14px}
.modal-foot .btn{flex:1;height:36px}
.field{margin-bottom:14px}
.field-label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:6px;letter-spacing:0.2px}
.field-input,.field-select,.field-textarea{width:100%;height:38px;padding:0 12px;font-size:14px;color:var(--text);background:var(--bg);border:none;border-radius:10px}
.field-input:focus,.field-select:focus{outline:none;box-shadow:0 0 0 3px rgba(10,132,255,.3)}
.field-input[type="date"]{cursor:pointer;padding-right:12px;color-scheme:dark}
.field-input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer;filter:invert(0.8);opacity:1;width:24px;height:24px;padding:4px;border-radius:4px;background-color:var(--bg3)}
.field-input[type="date"]::-webkit-calendar-picker-indicator:hover{background-color:var(--bg4)}
.field-textarea{height:60px;padding:10px 12px;resize:none}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.notify-btn{width:100%;height:38px;margin-top:14px;background:var(--bg3);border:none;border-radius:10px;color:var(--yellow);font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
.notify-btn:hover{background:var(--bg4)}.notify-btn:disabled{opacity:.4;cursor:not-allowed}
.toast-box{position:fixed;bottom:16px;left:16px;right:16px;z-index:1100;pointer-events:none}

/* Login Screen */
.login-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;padding:20px}
.login-box{background:var(--bg2);border-radius:16px;padding:32px;width:100%;max-width:360px;box-shadow:0 8px 32px rgba(0,0,0,.3)}
.login-logo{font-size:24px;font-weight:600;text-align:center;margin-bottom:8px;color:var(--text)}
.login-subtitle{font-size:13px;color:var(--text3);text-align:center;margin-bottom:24px}
.login-field{margin-bottom:16px}
.login-field label{display:block;font-size:12px;font-weight:500;color:var(--text2);margin-bottom:6px}
.login-field input{width:100%;height:44px;padding:0 14px;font-size:16px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:10px;outline:none}
.login-field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(218,119,86,.2)}
.login-btn{width:100%;height:44px;font-size:14px;font-weight:600;color:#fff;background:var(--accent);border:none;border-radius:10px;cursor:pointer;transition:all .2s}
.login-btn:hover{filter:brightness(1.1)}
.login-btn:disabled{opacity:0.5;cursor:not-allowed}
.login-error{color:var(--red);font-size:12px;text-align:center;margin-top:12px;min-height:18px}
.login-status{font-size:11px;color:var(--text3);text-align:center;margin-top:16px}
.sync-indicator{position:fixed;top:62px;right:74px;padding:6px 12px;background:var(--bg2);border-radius:8px;font-size:11px;color:var(--text2);display:flex;align-items:center;gap:6px;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.2);opacity:0;transform:translateY(-5px);transition:opacity 0.4s ease,transform 0.4s ease;pointer-events:none}
.sync-indicator.active{opacity:1;transform:translateY(0);pointer-events:auto}
.sync-indicator.syncing{color:var(--yellow)}
.sync-indicator.syncing .sync-dot{animation:spin 1s linear infinite;border:2px solid var(--yellow);border-top-color:transparent;background:transparent}
.sync-indicator.synced{color:var(--green)}
.sync-indicator.offline{color:var(--red)}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.sync-dot{width:8px;height:8px;border-radius:50%;background:currentColor}

/* Online indicator */
.online-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg3);border-radius:8px;font-size:12px;color:var(--text2);position:relative;cursor:pointer}
.online-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* Chat Panel */
.chat-toggle{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:var(--accent);color:#fff;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.3);z-index:300;transition:transform .2s;display:flex;align-items:center;justify-content:center}
.chat-toggle:hover{transform:scale(1.1)}
.chat-toggle svg{width:24px;height:24px}
.chat-badge{position:absolute;top:-4px;right:-4px;min-width:20px;height:20px;background:#ff3b30;color:#fff;border-radius:10px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 5px;box-shadow:0 2px 6px rgba(0,0,0,.3);animation:badgePulse 2s ease-in-out infinite}
@keyframes badgePop{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
@keyframes badgePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.chat-panel{position:fixed;bottom:80px;right:20px;width:320px;height:420px;background:var(--bg2);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:300;display:none;flex-direction:column;overflow:hidden}
.chat-panel.open{display:flex}
.chat-header{padding:12px 14px;background:var(--bg3);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.chat-title{font-weight:600;font-size:13px}
.chat-close{width:26px;height:26px;border-radius:50%;background:var(--bg4);border:none;color:var(--text2);font-size:16px;cursor:pointer}
.chat-close:hover{background:var(--border);color:var(--text)}
.chat-messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px;-webkit-overflow-scrolling:touch}
.chat-msg{max-width:85%;padding:8px 10px;border-radius:10px;font-size:12px;line-height:1.4;word-wrap:break-word}
.chat-msg.mine{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.chat-msg.other{background:var(--bg3);color:var(--text);align-self:flex-start;border-bottom-left-radius:4px}
.chat-msg-name{font-size:10px;font-weight:600;margin-bottom:2px;opacity:0.8}
.chat-msg-time{font-size:9px;opacity:0.5;margin-top:3px}
.chat-input-area{padding:10px;background:var(--bg3);border-top:1px solid var(--border);display:flex;gap:6px}
.chat-input{flex:1;height:34px;padding:0 12px;font-size:12px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:17px;outline:none}
.chat-input:focus{border-color:var(--accent)}
.chat-send{width:34px;height:34px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:14px;cursor:pointer}
.chat-send:hover{filter:brightness(1.1)}
.chat-nickname{padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:12px;text-align:center}
.chat-nickname-title{font-size:13px;color:var(--text2)}
.chat-nickname input{width:100%;max-width:180px;height:38px;padding:0 14px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid var(--border);border-radius:10px;text-align:center}
.chat-nickname input:focus{outline:none;border-color:var(--accent)}
.chat-nickname button{padding:10px 24px;font-size:12px;font-weight:600;color:#fff;background:var(--accent);border:none;border-radius:10px;cursor:pointer}
.chat-empty{text-align:center;color:var(--text3);padding:40px 20px;font-size:12px}

/* Online hover card */
.online-hover{position:absolute;top:100%;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:400;display:none}
.online-badge:hover .online-hover{display:block}
.online-user{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px}
.online-user-dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
.online-user-name{flex:1;color:var(--text)}
.online-user-time{font-size:10px;color:var(--text3)}

/* Part comments */
.comment-btn{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;padding:2px 4px;border-radius:4px;display:flex;align-items:center;gap:3px}
.comment-btn:hover{color:var(--accent);background:var(--bg4)}
.comment-btn.has-comments{color:var(--accent)}
.comment-count{font-size:10px}
.comments-popover{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.4);z-index:1002;width:280px;max-height:350px;display:flex;flex-direction:column;opacity:0;transform:scale(0.95);transition:all 0.15s ease;pointer-events:none}
.comments-popover.open{opacity:1;transform:scale(1);pointer-events:auto}
.comments-header{padding:10px 12px;border-bottom:1px solid var(--border);font-size:12px;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.comments-header button{background:none;border:none;color:var(--text3);font-size:16px;cursor:pointer}
.comments-list{flex:1;overflow-y:auto;padding:8px;max-height:200px}
.comment-item{padding:8px;background:var(--bg3);border-radius:8px;margin-bottom:6px;font-size:11px}
.comment-item:last-child{margin-bottom:0}
.comment-author{font-weight:600;color:var(--accent);margin-bottom:2px}
.comment-text{color:var(--text);line-height:1.4}
.comment-time{font-size:9px;color:var(--text3);margin-top:4px}
.comments-input{padding:8px;border-top:1px solid var(--border);display:flex;gap:6px}
.comments-input input{flex:1;height:30px;padding:0 10px;font-size:11px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.comments-input button{padding:0 12px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:11px;cursor:pointer}
.comments-empty{text-align:center;color:var(--text3);padding:20px;font-size:11px}

/* Mobile chat */
@media(max-width:768px){
  .chat-panel{width:calc(100vw - 32px);right:16px;bottom:80px;height:60vh}
  .chat-toggle{width:46px;height:46px}
}
/* Item Code Configuration */
.item-config-list{max-height:300px;overflow-y:auto;margin:12px 0;border:1px solid var(--border);border-radius:8px}
.item-config-row{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);align-items:center}
.item-config-row:last-child{border-bottom:none}
.item-config-row.header{background:var(--bg3);font-weight:600;font-size:11px;color:var(--text2);position:sticky;top:0}
.item-config-code{font-weight:500;font-size:12px}
.item-config-code small{display:block;font-weight:400;color:var(--text3);font-size:10px;margin-top:2px}
.item-config-badges{display:flex;gap:4px;flex-wrap:wrap}
.item-config-badge{padding:2px 6px;border-radius:4px;font-size:10px;background:var(--bg4);color:var(--text2)}
.item-config-badge.active{background:var(--accent);color:#fff}
.item-config-badge.skip{background:var(--bg4);color:var(--text3);text-decoration:line-through}
.item-config-actions button{padding:4px 8px;font-size:11px;background:var(--bg4);border:none;border-radius:4px;color:var(--text2);cursor:pointer}
.item-config-actions button:hover{background:var(--accent);color:#fff}
.item-config-empty{text-align:center;padding:30px;color:var(--text3);font-size:12px}
.item-config-form{display:grid;gap:10px;padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:12px}
.item-config-form label{font-size:11px;color:var(--text2);margin-bottom:2px}
.item-config-form input[type="text"],.item-config-form select{width:100%;padding:8px 10px;font-size:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.item-config-form .checkbox-row{display:flex;align-items:center;gap:8px;padding:6px 0}
.item-config-form .checkbox-row input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.item-config-form .checkbox-row label{font-size:12px;color:var(--text);margin:0}
.item-config-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.item-config-form .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.item-config-form button{padding:8px 16px;font-size:12px;border:none;border-radius:6px;cursor:pointer}
.item-config-form button.primary{background:var(--accent);color:#fff}
.item-config-form button.secondary{background:var(--bg4);color:var(--text2)}

.toast{padding:12px 18px;background:var(--bg3);border:none;border-radius:10px;font-size:13px;margin-top:8px;box-shadow:0 4px 16px rgba(0,0,0,.15)}
.toast.success{border-left:4px solid var(--green)}.toast.err{border-left:4px solid var(--red)}
.dropdown{position:relative}
.dropdown-menu{display:none;position:absolute;top:calc(100% + 4px);right:0;background:var(--bg3);border:none;border-radius:10px;min-width:160px;z-index:200;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.3)}
.dropdown-menu.open{display:block}
.dropdown-item{padding:10px 14px;font-size:13px;cursor:pointer;color:var(--text2);transition:all .1s}
.dropdown-item:hover{background:var(--bg4);color:var(--text)}.dropdown-item.danger{color:var(--red)}
.dropdown-div{height:1px;background:var(--border);margin:4px 0}
.team-list{margin-top:12px}
.team-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg);border-radius:10px;margin-bottom:6px;font-size:13px}
.team-item-info{flex:1}
.team-item-del{width:22px;height:22px;background:transparent;border:none;border-radius:6px;color:var(--red);cursor:pointer;font-size:12px;transition:all .15s}
.team-item-del:hover{background:rgba(255,69,58,.15)}
.eta-modal{max-width:340px}
.eta-history{background:var(--bg);border-radius:10px;padding:14px;margin-bottom:14px}
.eta-history-title{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px}
.eta-history-empty{font-size:13px;color:var(--text3);text-align:center;padding:10px}
.eta-history-item{display:flex;justify-content:space-between;font-size:11px;padding:4px 0;border-bottom:1px solid var(--border)}
.eta-history-item:last-child{border:none}
.eta-avg{background:var(--bg3);border-radius:4px;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.eta-avg-label{font-size:10px;color:var(--text2)}
.eta-avg-val{font-size:16px;font-weight:700;color:var(--purple)}
.bom-modal{max-width:450px}
.bom-list{max-height:200px;overflow-y:auto;margin-bottom:12px}
.bom-item{display:flex;align-items:center;padding:8px 10px;background:var(--bg);border-radius:4px;margin-bottom:4px;cursor:pointer}
.bom-item:hover{background:var(--bg3)}
.bom-item-info{flex:1}
.bom-item-name{font-weight:600;font-size:12px}
.bom-item-meta{font-size:10px;color:var(--text3)}
.bom-item-del{width:20px;height:20px;background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--red);cursor:pointer;font-size:10px}
.leadtime-modal{max-width:500px}
.lt-item{background:var(--bg);border-radius:6px;padding:10px;margin-bottom:8px}
.itemconfig-modal{max-width:600px}
.itemconfig-list{max-height:350px;overflow-y:auto}
.itemconfig-item{background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px}
.itemconfig-item-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.itemconfig-code{font-weight:600;font-size:14px;flex:1;color:var(--accent)}
.itemconfig-del{width:24px;height:24px;background:transparent;border:1px solid var(--border);border-radius:4px;color:var(--red);cursor:pointer;font-size:12px}
.itemconfig-options{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.itemconfig-opt{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg2);border-radius:6px}
.itemconfig-opt label{font-size:11px;color:var(--text2);flex:1}
.itemconfig-opt input[type="checkbox"]{width:16px;height:16px;accent-color:var(--accent)}
.itemconfig-opt select{flex:1;padding:4px 6px;font-size:11px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text)}
.itemconfig-add{display:flex;gap:8px;margin-bottom:12px;padding:12px;background:var(--bg);border-radius:8px}
.itemconfig-add input{flex:1;height:32px;padding:0 10px;font-size:12px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
.itemconfig-add button{padding:0 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer}
.itemconfig-empty{text-align:center;padding:30px;color:var(--text3);font-size:13px}
.otd-modal{max-width:500px}
.otd-item{display:flex;align-items:center;background:var(--bg);border-radius:8px;padding:12px;margin-bottom:8px}
.otd-mfr{font-weight:600;font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.otd-stats{display:flex;gap:16px;align-items:center}
.otd-stat{text-align:center}
.otd-stat-val{font-size:16px;font-weight:600;display:block}
.otd-stat-label{font-size:10px;color:var(--text3)}
.otd-bar{width:60px;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}
.otd-bar-fill{height:100%;border-radius:3px}
.otd-empty{text-align:center;color:var(--text3);padding:30px}
.lt-code{font-weight:600;font-size:12px;margin-bottom:6px;color:var(--accent)}
.lt-stats{display:flex;gap:12px;font-size:10px;align-items:center}
.lt-stat-val{font-size:14px;font-weight:700;color:var(--purple)}
.lt-samples{font-size:9px;color:var(--text3)}

/* Tablet styles */
@media(max-width:1024px){
  .header-metrics{gap:6px}
  .hm{padding:6px 10px}
  .hm-progress{min-width:140px}
  .hm-bar{width:80px}
  .header-search{width:180px}
  .ai-console-btn{padding:8px 14px;font-size:12px}
}

/* Mobile styles */
@media(max-width:768px){
  html,body{overflow-x:hidden!important}
  .header{height:50px;padding:0 12px;gap:8px;overflow:hidden}
  .logo{min-width:60px;max-width:100px;font-size:14px}
  .header-search{display:none}
  .header-metrics{display:none}
  .ai-console-btn{display:none}
  .header-spacer{display:none}
  .header-btns .btn span{display:none}
  .header-btns .btn{padding:0 10px;min-width:36px;justify-content:center}
  .header-btns{gap:4px}
  .version-badge{display:none}
  .main{padding:8px 10px;padding-top:58px;overflow-x:hidden}
  .pipeline{gap:4px;margin-bottom:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0}
  .pipe{min-width:60px;padding:8px 6px;border-radius:10px;flex-shrink:0}
  .pipe-count{font-size:16px}
  .pipe-label{font-size:8px}
  .tabs{margin-bottom:8px;padding:2px;gap:1px;flex-shrink:0}
  .tab{height:32px;font-size:12px;padding:0 8px}
  .data-table{border-radius:10px;overflow:hidden}
  .table-header{height:32px;padding:0 8px;font-size:9px}
  .table-header.parts-grid{grid-template-columns:20px 1fr 60px 60px 28px 28px 28px!important}
  .part-row.parts-grid{grid-template-columns:20px 1fr 60px 60px 28px 28px 28px!important}
  .parts-grid{grid-template-columns:20px 1fr 60px 60px 28px 28px 28px!important}
  .asm-row{grid-template-columns:20px 1fr 80px 28px 28px!important;height:38px;padding:0 8px}
  .part-row{height:36px;padding:0 8px}
  .table-header>div:nth-child(n+7),.part-row>div:nth-child(n+7),.asm-row>div:nth-child(n+6){display:none}
  .col-subpart,.col-code,.col-mfr,.col-qty,.col-assignee,.col-eta,.col-notes{display:none!important}
  .asm-priority{display:none}
  .asm-name{font-size:13px}
  .asm-meta{font-size:10px}
  .asm-toggle{font-size:10px}
  .cell{font-size:12px}
  .status-badge{font-size:9px;padding:3px 6px}
  .sm-btn{width:28px;height:28px}
  .adv-btn{width:28px;height:28px}
  .subpart-add{display:none}
  .add-row{padding:8px!important;padding-left:12px!important}
  .add-row-btn{width:24px;height:24px;font-size:14px}
  .add-row-text{font-size:11px}
  .card{padding:12px;border-radius:10px}
  .card-title{font-size:13px}
  .progress-top{grid-template-columns:1fr!important;gap:10px}
  .progress-layout{overflow-x:hidden}
  .gantt-wrap{display:none}
  .ins-group-title{font-size:10px}
  .ins-label{font-size:11px}
  .ins-val{font-size:13px}
  .toolbar{gap:8px;flex-wrap:wrap}
  .toolbar .search{width:100%;max-width:none}
  .toolbar .filter-select{width:100%}
  .toolbar .btn{flex:1;min-width:80px}
  .action-row{grid-template-columns:1fr 70px 70px 28px!important}
  .action-row>div:nth-child(2),.action-row>div:nth-child(3),.action-row>div:nth-child(5){display:none}
  .action-task{font-size:12px}
  .action-status{font-size:9px;padding:3px 6px}
  .filter-badges{flex-wrap:wrap}
  .filter-badge{font-size:10px}
  .modal{max-width:calc(100vw - 32px);max-height:calc(100vh - 32px);border-radius:14px}
  .modal-head{padding:14px 16px}
  .modal-title{font-size:15px}
  .modal-body{padding:4px 16px 16px}
  .modal-foot{padding:12px 16px}
  .field-label{font-size:11px}
  .field-input,.field-select,.field-textarea{font-size:16px;height:44px;border-radius:8px}
  .field-textarea{height:80px}
  .field-row{flex-direction:column;gap:8px}
  .modal-foot .btn{height:44px;font-size:14px}
  .toast{font-size:12px;padding:10px 14px}
  .dropdown-menu{right:0;left:auto;min-width:180px}
  .theme-grid{grid-template-columns:1fr 1fr}
  .theme-card{padding:10px}
  .theme-name{font-size:11px}
  .burndown-container{height:140px}
  .report-content{font-size:10px}
  .notes-cell{display:none}
}

/* Small mobile styles */
@media(max-width:480px){
  .header{height:48px;padding:0 10px}
  .logo{font-size:13px;min-width:50px;max-width:80px}
  .header-btns .btn{padding:0 8px;height:32px;min-width:32px}
  .main{padding:6px 8px;padding-top:54px}
  .pipeline{gap:3px;margin-bottom:6px;padding-bottom:4px}
  .pipe{min-width:56px;padding:6px 4px;border-radius:8px}
  .pipe-count{font-size:14px}
  .pipe-label{font-size:7px;letter-spacing:0}
  .tabs{margin-bottom:6px}
  .tab{height:30px;font-size:11px;padding:0 6px}
  .table-header.parts-grid,.part-row.parts-grid,.parts-grid{grid-template-columns:18px 1fr 55px 26px 26px 26px!important}
  .asm-row{grid-template-columns:18px 1fr 60px 26px!important;height:36px}
  .part-row{height:34px}
  .asm-name{font-size:12px}
  .cell{font-size:11px}
  .status-badge{font-size:8px;padding:2px 5px}
  .sm-btn{width:26px;height:26px;font-size:10px}
  .adv-btn{width:26px;height:26px;font-size:10px}
  .action-row{grid-template-columns:1fr 60px 26px!important}
  .action-task{font-size:11px}
  .modal{border-radius:12px;margin:8px}
  .modal-head{padding:12px 14px}
  .modal-body{padding:4px 14px 14px}
  .modal-foot{padding:10px 14px;flex-direction:column;gap:8px}
  .modal-foot .btn{width:100%}
  .field-input,.field-select,.field-textarea{height:44px;font-size:16px}
  .modal-foot .btn{height:44px;font-size:14px}
  .progress-top{gap:8px}
  .card{padding:10px}
  .ins-row{padding:6px 0}
  .theme-grid{grid-template-columns:1fr 1fr}
  .burndown-container{height:120px}
  .forecast-card{padding:10px}
  .forecast-date{font-size:16px}
}

/* Touch improvements */
@media(hover:none){
  .btn:hover,.sm-btn:hover,.adv-btn:hover,.pipe:hover,.tab:hover,.action-row:hover,.part-row:hover,.asm-row:hover{transform:none;filter:none}
  .btn:active,.sm-btn:active,.adv-btn:active{transform:scale(0.95);opacity:0.8}
  .pipe:active,.tab:active{background:var(--bg4)}
}

/* Safe area for notched devices */
@supports(padding:max(0px)){
  .header{padding-left:max(12px,env(safe-area-inset-left));padding-right:max(12px,env(safe-area-inset-right))}
  .main{padding-left:max(10px,env(safe-area-inset-left));padding-right:max(10px,env(safe-area-inset-right));padding-bottom:max(10px,env(safe-area-inset-bottom))}
  .modal{margin-bottom:env(safe-area-inset-bottom)}
}
</style>
</head>
<body>
<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
<div class="login-logo">ðŸ“¦ EBS Cloud</div>
<div class="login-subtitle">Parts Pipeline Tracker</div>
<div class="login-field">
<label>Access Code</label>
<input type="password" id="loginCode" placeholder="Enter team access code" autocomplete="off">
</div>
<button class="login-btn" id="loginBtn">Sign In</button>
<div class="login-error" id="loginError"></div>
<div class="login-status" id="loginStatus">Connecting to cloud...</div>
</div>
</div>

<!-- Sync Indicator -->
<div class="sync-indicator" id="syncIndicator"><div class="sync-dot"></div><span id="syncText">Synced</span></div>

<header class="header">
<div class="logo" id="projectName">EBS v2</div>
<button class="ai-console-btn" id="aiAlert" title="AI Console"><div class="ai-console-icon">+</div>AI Console</button>
<div class="header-spacer"></div>
<div class="online-badge"><div class="online-dot"></div><span id="onlineCount">1 online</span><div class="online-hover" id="onlineHover"><div id="onlineUserList"></div></div></div>
<div class="header-spacer"></div>
<div class="header-search"><input type="text" id="headerSearch" placeholder="Search parts..."><button class="header-search-clear" id="headerSearchClear">Ã—</button></div>
<div class="header-spacer"></div>
<div class="header-metrics">
<div class="hm"><div><div class="hm-label">Ready</div><div class="hm-value" id="sReady">0/0</div></div></div>
<div class="hm" id="hmDays" style="display:none"><div><div class="hm-label">Days</div><div class="hm-value" id="sDays">â€”</div></div></div>
<div class="hm hm-progress" id="hmProgress"><div><div class="hm-label">Progress</div><div class="hm-value" id="sPct">0%</div></div><div class="hm-bar"><div class="hm-bar-fill" id="sBar"></div></div></div>
</div>
<div class="header-btns">
<button class="btn" id="themeBtn">ðŸŽ¨</button>
<button class="btn btn-report" id="reportBtn">ðŸ“‹ <span>Report</span></button>
<div class="dropdown"><button class="btn" id="menuBtn">â˜°</button><div class="dropdown-menu" id="menuDrop"><div class="dropdown-item" id="teamBtn">Team</div><div class="dropdown-item" id="datesBtn">Project Dates</div><div class="dropdown-item" id="leadtimeBtn">Lead Time Data</div><div class="dropdown-item" id="itemConfigBtn">Item Code Config</div><div class="dropdown-div"></div><div class="dropdown-item" id="sampleBtn">Reset to Sample Data</div><div class="dropdown-div"></div><div class="dropdown-item danger" id="clearBtn">Clear All</div><div class="dropdown-div"></div><div class="dropdown-item" id="signOutBtn">Sign Out</div></div></div>
<div class="version-badge">v1.0.2</div>
</div>
</header>
<main class="main">
<div class="pipeline">
<div class="pipe" data-s="to-order"><div class="pipe-count" id="p1">0</div><div class="pipe-label">To Order</div></div>
<div class="pipe" data-s="ordered"><div class="pipe-count" id="p2">0</div><div class="pipe-label">Ordered</div></div>
<div class="pipe" data-s="arrived"><div class="pipe-count" id="p3">0</div><div class="pipe-label">Arrived</div></div>
<div class="pipe" data-s="configured"><div class="pipe-count" id="p4">0</div><div class="pipe-label">Configured</div></div>
<div class="pipe" data-s="tested"><div class="pipe-count" id="p5">0</div><div class="pipe-label">Tested</div></div>
<div class="pipe" data-s="installed"><div class="pipe-count" id="p6">0</div><div class="pipe-label">Installed</div></div>
</div>
<div class="tabs">
<button class="tab active" data-tab="list">Parts List</button>
<button class="tab" data-tab="actions">Action Plan</button>
<button class="tab" data-tab="progress">Progress</button>
</div>
<div class="panel active" id="listPanel">
<div class="toolbar"><select class="filter-select" id="assigneeFilter"><option value="">All Assignees</option></select><button class="toggle-btn" id="expandToggle"><span class="arrow">â–¼</span> Expand</button></div>
<div class="filter-badges" id="filterBadges"></div>
<div class="data-table" id="partsTable"><div class="table-header parts-grid"><div></div><div></div><div>Name</div><div>Code</div><div>Mfr</div><div>Assignee</div><div>Qty</div><div>Status</div><div>Prog</div><div>ETA / PO</div><div>Notes</div><div></div><div></div><div></div><div></div></div><div class="table-body" id="partsList"></div></div>
<div class="empty" id="emptyList" style="display:none;">No items found</div>
</div>
<div class="panel" id="actionsPanel">
<div class="toolbar"><input type="text" class="search" id="actionSearchBox" placeholder="Search actions..."><select class="filter-select" id="actionAssigneeFilter"><option value="">All Assignees</option></select><button class="btn btn-primary" id="addActionBtn">+ Action</button></div>
<div class="data-table" id="actionsTable"><div class="table-header action-grid"><div>Task</div><div>Linked Part</div><div>Created</div><div>Progress</div><div>Due Date</div><div>Assignee</div><div>Status</div><div></div></div><div class="table-body" id="actionsList"></div></div>
<div class="empty" id="emptyActions" style="display:none;">No actions yet</div>
</div>
<div class="panel" id="progressPanel">
<div class="progress-layout">
<div class="progress-top">
<div class="card"><div class="card-title">Burndown Chart <a id="burndownEdit">Edit Dates</a></div><div class="burndown-container" id="burndownChart"></div><div class="burndown-dates" id="burndownDates"></div><div class="burndown-legend"><div class="legend-item"><div class="legend-dot green"></div> Ahead</div><div class="legend-item"><div class="legend-dot red"></div> Behind</div><div class="legend-item"><div class="legend-dot gray"></div> Target</div></div></div>
<div class="card"><div class="card-title">Insights</div><div class="ins-group"><div class="ins-group-title">Schedule</div><div class="insights-grid"><div class="ins-row"><span class="ins-label">Days Left</span><span class="ins-val" id="insDays">â€”</span></div><div class="ins-row"><span class="ins-label">Status</span><span class="ins-val" id="insStatus">â€”</span></div><div class="ins-row"><span class="ins-label">Expected</span><span class="ins-val" id="insExpected">â€”</span></div><div class="ins-row"><span class="ins-label">Actual</span><span class="ins-val" id="insActual">â€”</span></div></div></div><div class="ins-group"><div class="ins-group-title">Velocity &amp; Suppliers</div><div class="insights-grid"><div class="ins-row"><span class="ins-label">Rate</span><span class="ins-val" id="insRate">â€”</span></div><div class="ins-row"><span class="ins-label">Est. Done</span><span class="ins-val" id="insEst">â€”</span></div><div class="ins-row" style="cursor:pointer" onclick="window.showOTDModal()"><span class="ins-label">ðŸšš Supplier OTD</span><span class="ins-val" id="insOTD">â€”</span></div><div class="ins-row"><span class="ins-label">ðŸ“¦ Avg Lead</span><span class="ins-val" id="insAvgLead">â€”</span></div></div></div><div class="forecast-card"><div class="forecast-title">Velocity Forecast</div><div class="forecast-main"><span class="forecast-date" id="forecastDate">â€”</span><span class="forecast-label" id="forecastLabel"></span></div><div class="forecast-detail" id="forecastDetail"></div></div></div>
</div>
<div class="gantt-wrap"><div class="gantt-header-bar"><span class="gantt-title">Timeline</span><span class="gantt-dates" id="ganttDateRange"></span></div><div class="gantt-scroll" id="ganttScroll"><div class="gantt-inner"><div class="gantt-header"><div class="gantt-label-col">Item</div><div class="gantt-weeks" id="ganttHeader"></div></div><div class="gantt-body" id="ganttBody"></div></div></div></div>
</div>
</div>
</main>
<div class="modal-popover ai-popover ai-modal" id="aiModal"><div class="modal-head"><span class="modal-title"><span class="ai-title-icon">âœ¦</span> AI Console</span><span class="ai-model-badge" id="aiModelBadge"></span><button class="modal-close" id="aiClose">Ã—</button></div><div class="modal-body"><div class="ai-content" id="aiContent"><div class="ai-welcome"><p>Ask any question about your project, or click <strong>Tell me</strong> for a status briefing.</p></div></div><div class="ai-input-row"><input type="text" id="aiQuestion" placeholder="Ask a question..."><button class="btn" id="aiAskBtn">Ask</button><button class="btn btn-tell" id="aiStraightBtn">Tell me</button></div></div></div>
<div class="modal-bg" id="reportModal"><div class="modal report-modal"><div class="modal-head"><span class="modal-title">ðŸ“‹ Daily Report</span><button class="modal-close" id="reportClose">Ã—</button></div><div class="modal-body"><div class="report-meta"><span id="reportDate"></span><span id="reportRecipients"></span></div><div class="report-content" id="reportContent"></div></div><div class="modal-foot"><button class="btn" id="reportCopy">ðŸ“‹ Copy</button><button class="btn btn-primary" id="reportEmail">âœ‰ï¸ Email Team</button></div></div></div>
<div class="modal-bg" id="etaModal"><div class="modal eta-modal"><div class="modal-head"><span class="modal-title">ðŸ“… Expected Arrival</span><button class="modal-close" id="etaClose">Ã—</button></div><div class="modal-body"><div id="etaPartName" style="font-weight:600;margin-bottom:8px"></div><div id="etaCode" style="font-size:10px;color:var(--text3);margin-bottom:12px"></div><div class="eta-history" id="etaHistory"></div><div class="field"><label class="field-label">Expected Arrival Date</label><input type="date" class="field-input" id="etaDateInput"></div></div><div class="modal-foot"><button class="btn" id="etaClear">Clear</button><button class="btn btn-primary" id="etaSave">Save</button></div></div></div>
<div class="modal-bg" id="bomModal"><div class="modal bom-modal"><div class="modal-head"><span class="modal-title" id="bomTitle">ðŸ’¾ Save Specification</span><button class="modal-close" id="bomClose">Ã—</button></div><div class="modal-body"><div class="field" id="bomNameField"><label class="field-label">Specification Name</label><input type="text" class="field-input" id="bomName" placeholder="e.g. Standard Control Panel"></div><div class="bom-list" id="bomList"></div></div><div class="modal-foot"><button class="btn" id="bomCancel">Cancel</button><button class="btn btn-primary" id="bomSave">Save</button></div></div></div>
<div class="modal-bg" id="leadtimeModal"><div class="modal leadtime-modal"><div class="modal-head"><span class="modal-title">ðŸ“Š Lead Time Database</span><button class="modal-close" id="ltClose">Ã—</button></div><div class="modal-body" id="ltBody"></div><div class="modal-foot"><button class="btn" id="ltClear">Clear Data</button><button class="btn btn-primary" id="ltDone">Done</button></div></div></div>
<div class="modal-bg" id="itemConfigModal"><div class="modal itemconfig-modal"><div class="modal-head"><span class="modal-title">âš™ï¸ Item Code Configuration</span><button class="modal-close" id="icClose">Ã—</button></div><div class="modal-body"><p style="font-size:12px;color:var(--text2);margin-bottom:12px">Configure testing and configuration requirements per item code. These settings persist across projects.</p><div class="itemconfig-add"><input type="text" id="icNewCode" placeholder="Enter item code..."><button id="icAddBtn">Add Code</button></div><div class="itemconfig-list" id="icList"></div></div><div class="modal-foot"><button class="btn btn-primary" id="icDone">Done</button></div></div></div>
<div class="modal-bg" id="otdModal"><div class="modal otd-modal"><div class="modal-head"><span class="modal-title">ðŸšš Supplier On-Time Delivery</span><button class="modal-close" id="otdClose">Ã—</button></div><div class="modal-body" id="otdBody"></div><div class="modal-foot"><button class="btn btn-primary" id="otdDone">Done</button></div></div></div>
<div class="popover-backdrop" id="popoverBackdrop"></div>
<div class="modal-popover" id="partModal"><div class="modal-head"><span class="modal-title" id="pmTitle">Add Part</span><button class="modal-close" id="pmClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="pmName"></div><div class="field-row"><div class="field"><label class="field-label">Item Code</label><input type="text" class="field-input" id="pmCode"></div><div class="field"><label class="field-label">Manufacturer</label><input type="text" class="field-input" id="pmMfr"></div></div><div class="field-row"><div class="field"><label class="field-label">Qty</label><input type="number" class="field-input" id="pmQty" value="1" min="1"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="pmAssignee"></select></div></div><div class="field-row"><div class="field"><label class="field-label">Status</label><select class="field-select" id="pmStatus"><option value="to-order">To Order</option><option value="ordered">Ordered</option><option value="arrived">Arrived</option><option value="configured">Configured</option><option value="tested">Tested</option><option value="installed">Installed</option></select></div><div class="field"><label class="field-label">Assembly</label><select class="field-select" id="pmParent"></select></div></div><div class="field"><label class="field-label">Notes</label><textarea class="field-textarea" id="pmNotes"></textarea></div><button class="notify-btn" id="pmNotify" disabled>ðŸ”” Notify</button></div><div class="modal-foot"><button class="btn" id="pmCancel">Cancel</button><button class="btn btn-primary" id="pmSave">Save</button></div></div>
<div class="modal-popover" id="asmModal"><div class="modal-head"><span class="modal-title" id="amTitle">Add Assembly</span><button class="modal-close" id="amClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="amName"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="amAssignee"></select></div><div class="field"><label class="field-label">Notes</label><textarea class="field-textarea" id="amNotes"></textarea></div><button class="notify-btn" id="amNotify" disabled>ðŸ”” Notify</button></div><div class="modal-foot"><button class="btn" id="amCancel">Cancel</button><button class="btn btn-primary" id="amSave">Save</button></div></div>
<div class="modal-popover" id="actionModal"><div class="modal-head"><span class="modal-title" id="actTitle">Add Action</span><button class="modal-close" id="actClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Task</label><input type="text" class="field-input" id="actTask"></div><div class="field"><label class="field-label">Linked Part</label><select class="field-select" id="actLinkedPart"></select></div><div class="field-row"><div class="field"><label class="field-label">Due Date</label><input type="date" class="field-input" id="actDue"></div><div class="field"><label class="field-label">Assignee</label><select class="field-select" id="actAssignee"></select></div></div><div class="field"><label class="field-label">Status</label><select class="field-select" id="actStatus"><option value="not-started">Not Started</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div></div><div class="modal-foot"><button class="btn" id="actCancel">Cancel</button><button class="btn btn-primary" id="actSave">Save</button></div></div>
<div class="modal-bg" id="teamModal"><div class="modal"><div class="modal-head"><span class="modal-title">Team</span><button class="modal-close" id="teamClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="teamName"></div><div class="field"><label class="field-label">Email</label><input type="email" class="field-input" id="teamEmail"></div><button class="btn btn-primary" id="teamAdd" style="width:100%">Add</button><div class="team-list" id="teamList"></div></div><div class="modal-foot"><button class="btn" id="teamDone">Done</button></div></div></div>
<div class="modal-bg" id="datesModal"><div class="modal"><div class="modal-head"><span class="modal-title">Project Dates</span><button class="modal-close" id="datesClose">Ã—</button></div><div class="modal-body"><div class="field"><label class="field-label">Start</label><input type="date" class="field-input" id="startDate"></div><div class="field"><label class="field-label">End</label><input type="date" class="field-input" id="endDate"></div></div><div class="modal-foot"><button class="btn" id="datesCancel">Cancel</button><button class="btn btn-primary" id="datesSave">Save</button></div></div></div>
<div class="modal-bg" id="themeModal"><div class="modal theme-modal"><div class="modal-head"><span class="modal-title">ðŸŽ¨ Choose Theme</span><button class="modal-close" id="themeClose">Ã—</button></div><div class="modal-body"><div class="theme-grid" id="themeGrid"></div></div></div></div>
<div class="modal-bg" id="itemConfigModal"><div class="modal" style="max-width:500px"><div class="modal-head"><span class="modal-title">âš™ï¸ Item Code Configuration</span><button class="modal-close" id="icClose">Ã—</button></div><div class="modal-body">
<div class="item-config-form" id="icForm">
<div style="font-size:11px;color:var(--text3);margin-bottom:8px">Configure which phases apply to each item code. Settings are saved globally and reused across projects.</div>
<div><label>Item Code</label><input type="text" id="icCode" placeholder="e.g., PLC-001" style="text-transform:uppercase"></div>
<div class="form-row">
<div class="checkbox-row"><input type="checkbox" id="icReqConfig"><label for="icReqConfig">Requires Configuration</label></div>
<div class="checkbox-row"><input type="checkbox" id="icReqTest" checked><label for="icReqTest">Requires Testing</label></div>
</div>
<div class="form-row">
<div><label>Configured By</label><select id="icConfigBy"><option value="">Anyone</option></select></div>
<div><label>Tested By</label><select id="icTestBy"><option value="">Anyone</option></select></div>
</div>
<div class="form-actions"><button class="secondary" id="icClear">Clear</button><button class="primary" id="icSave">Save Configuration</button></div>
</div>
<div class="item-config-list" id="icList"></div>
</div><div class="modal-foot"><button class="btn" id="icExport">Export</button><button class="btn btn-primary" id="icDone">Done</button></div></div></div>
<div class="modal-bg" id="poModal"><div class="modal po-modal"><div class="modal-head"><span class="modal-title">ðŸ“¦ Order Details</span><button class="modal-close" id="poClose">Ã—</button></div><div class="modal-body"><div id="poPartName" style="font-weight:600;margin-bottom:12px;font-size:14px"></div><div class="field"><label class="field-label">PO Number</label><input type="text" class="field-input" id="poNumber" placeholder="e.g. PO-2024-001"></div><div class="field"><label class="field-label">Expected Arrival Date</label><input type="date" class="field-input" id="poArrivalDate"></div><div class="po-note">Leave arrival date empty to use historical lead time data</div></div><div class="modal-foot"><button class="btn" id="poCancel">Cancel</button><button class="btn btn-primary" id="poSave">Confirm Order</button></div></div></div>
<div class="popover" id="deletePopover"><div class="popover-msg" id="deleteMsg"></div><div class="popover-btns"><button class="btn" id="deleteCancel">Cancel</button><button class="btn btn-danger" id="deleteConfirm">Delete</button></div></div>
<div class="toast-box" id="toastBox"></div>

<!-- Chat -->
<button class="chat-toggle" id="chatToggle" title="Team Chat"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg><span class="chat-badge" id="chatBadge" style="display:none">0</span></button>
<div class="chat-panel" id="chatPanel">
<div class="chat-header">
<div class="chat-title">Team Chat</div>
<button class="chat-close" id="chatClose">Ã—</button>
</div>
<div class="chat-nickname" id="chatNickname">
<div class="chat-nickname-title">Enter your name to chat</div>
<input type="text" id="chatNickInput" placeholder="Your name..." maxlength="20">
<button id="chatNickBtn">Join</button>
</div>
<div class="chat-messages" id="chatMessages" style="display:none"></div>
<div class="chat-input-area" id="chatInputArea" style="display:none">
<input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." maxlength="500">
<button class="chat-send" id="chatSend">âž¤</button>
</div>
</div>
<div class="comments-popover" id="commentsPopover">
<div class="comments-header"><span id="commentsTitle">Comments</span><button id="commentsClose">Ã—</button></div>
<div class="comments-list" id="commentsList"></div>
<div class="comments-input"><input type="text" id="commentInput" placeholder="Add comment..." maxlength="200"><button id="commentAdd">Add</button></div>
</div>
<script>
(function(){

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyCuzREUYQica1pjdVgQJlXD2eh8D7Dqlo4",
  authDomain: "ebsv1-78d54.firebaseapp.com",
  databaseURL: "https://ebsv1-78d54-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ebsv1-78d54",
  storageBucket: "ebsv1-78d54.firebasestorage.app",
  messagingSenderId: "70538130924",
  appId: "1:70538130924:web:9e34e90b56e4f3f72ebcc9"
};

// Access code for the team
const ACCESS_CODE = "jaakko123";

// ============================================
// Initialize Firebase
// ============================================
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const projectRef = db.ref('project');

// ============================================
// App State
// ============================================
const STAGES=['to-order','ordered','arrived','configured','tested','installed'];
const SLABELS={'to-order':'To Order','ordered':'Ordered','arrived':'Arrived','configured':'Configured','tested':'Tested','installed':'Installed'};
const ASTAGES=['not-started','in-progress','completed'];
const ALABELS={'not-started':'Not Started','in-progress':'In Progress','completed':'Completed'};

let data=[],team=[],expanded={},history=[],projectDates={start:'',end:''},actions=[],leadTimeDb={},savedBoms=[],currentProjectName='New Project',allExpanded=false;

// Item Code Configuration - saved to Firebase globally (shared across all projects)
// Structure: { 'ITEM-CODE': { requiresTesting: bool, tester: string, requiresConfig: bool, configuredBy: string } }
let itemCodeConfig={};
const ITEM_CONFIG_KEY='ebs-item-code-config';
const itemConfigRef = db.ref('itemCodeConfig');

function loadItemCodeConfig(){
  // Load from localStorage first as fallback
  try{
    const stored=localStorage.getItem(ITEM_CONFIG_KEY);
    if(stored)itemCodeConfig=JSON.parse(stored);
  }catch(e){console.warn('Failed to load item code config from localStorage',e)}
  
  // Then sync from Firebase
  itemConfigRef.on('value',snapshot=>{
    const val=snapshot.val();
    if(val){
      itemCodeConfig=val;
      // Also save to localStorage as backup
      try{localStorage.setItem(ITEM_CONFIG_KEY,JSON.stringify(itemCodeConfig))}catch(e){}
      render(); // Re-render when config changes from another client
    }
  });
}

function saveItemCodeConfig(){
  // Save to Firebase
  itemConfigRef.set(itemCodeConfig).catch(e=>console.warn('Failed to save item config to Firebase',e));
  // Also save to localStorage as backup
  try{
    localStorage.setItem(ITEM_CONFIG_KEY,JSON.stringify(itemCodeConfig));
  }catch(e){console.warn('Failed to save item code config to localStorage',e)}
}

function getItemConfig(code){
  if(!code||!itemCodeConfig[code])return{requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  return itemCodeConfig[code];
}

function getPartStages(part){
  const config=getItemConfig(part.code);
  let stages=['to-order','ordered','arrived'];
  if(config.requiresTesting)stages.push('tested');
  if(config.requiresConfig)stages.push('configured');
  stages.push('installed');
  return stages;
}

function getNextStage(part){
  const stages=getPartStages(part);
  const currentIdx=stages.indexOf(part.status);
  if(currentIdx===-1||currentIdx>=stages.length-1)return null;
  return stages[currentIdx+1];
}
let globalCodes=[],globalMfrs=[];
let editId=null,editAsmId=null,editActId=null,editEtaPartId=null,filterStage='',filterAssignee='',searchQ='',actionSearchQ='',actionAssigneeFilter='',highlightActionId=null,highlightPartId=null,bomMode='save';
let isAuthenticated=false,isConnected=false,isSyncing=false;

const $=id=>document.getElementById(id);
const esc=s=>s?String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'):'';
const toast=(msg,e)=>{const t=document.createElement('div');t.className='toast '+(e?'err':'success');t.textContent=msg;$('toastBox').appendChild(t);setTimeout(()=>t.remove(),2500)};

// ============================================
// Sync Indicator
// ============================================
function showSync(status,text){
  const ind=$('syncIndicator');
  const txt=$('syncText');
  ind.className='sync-indicator active '+status;
  txt.textContent=text||status;
  if(status==='synced')setTimeout(()=>ind.classList.remove('active'),2000);
}

// ============================================
// Firebase Data Operations
// ============================================
let saveTimeout=null;
let isSaving=false;
let lastSyncShow=0;
let lastLocalSaveTime=0;
const SYNC_SHOW_INTERVAL=10000; // Only show sync indicator every 10 seconds max

function save(){
  if(!isAuthenticated) return;
  
  // Always save to localStorage first (immediate, reliable)
  saveToLocalStorage();
  
  // For localStorage-only mode, we're done
  if(useLocalStorage) return;
  
  clearTimeout(saveTimeout);
  
  saveTimeout=setTimeout(()=>{
    if(isSaving) return;
    isSaving=true;
    
    // Mark this as a local save so we don't re-render when it echoes back
    lastLocalSaveTime = Date.now();
    
    // Only show syncing indicator if enough time has passed
    const now=Date.now();
    const showIndicator=now-lastSyncShow>SYNC_SHOW_INTERVAL;
    if(showIndicator) showSync('syncing','Syncing...');
    
    projectRef.child('main').set({
      data, team, history, projectDates, actions, projectName: currentProjectName,
      updatedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(()=>{
      isSaving=false;
      if(showIndicator){
        lastSyncShow=Date.now();
        showSync('synced','Synced âœ“');
        setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
      }
    }).catch(e=>{
      isSaving=false;
      showSync('offline','Save failed');
      console.error(e);
    });
  },500);
}

function saveLeadTime(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('leadTime').set(leadTimeDb).catch(console.error);
}

function saveBoms(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('boms').set(savedBoms).catch(console.error);
}

function saveGlobalCodes(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('globalCodes').set(globalCodes).catch(console.error);
}

function saveGlobalMfrs(){
  if(!isAuthenticated||useLocalStorage)return;
  projectRef.child('globalMfrs').set(globalMfrs).catch(console.error);
}

function saveExpanded(){
  // Keep expanded state local (per-user preference)
  try{localStorage.setItem('ebs-expanded',JSON.stringify(expanded))}catch(e){}
}

function loadExpanded(){
  try{const s=localStorage.getItem('ebs-expanded');if(s)expanded=JSON.parse(s)}catch(e){expanded={}}
}

function addGlobalCode(code){if(code&&!globalCodes.includes(code)){globalCodes.push(code);saveGlobalCodes()}}
function addGlobalMfr(mfr){if(mfr&&!globalMfrs.includes(mfr)){globalMfrs.push(mfr);saveGlobalMfrs()}}
function getAllCodes(){const projectCodes=[...new Set(data.filter(d=>d.code).map(d=>d.code))];return[...new Set([...globalCodes,...projectCodes])].sort()}
function getAllMfrs(){const projectMfrs=[...new Set(data.filter(d=>d.mfr).map(d=>d.mfr))];return[...new Set([...globalMfrs,...projectMfrs])].sort()}

function loadSampleBoms(){savedBoms=[{id:1,name:'Standard Control Panel',items:[{name:'Control Panel',isAsm:true},{name:'PLC CPU',code:'6ES7-1500',mfr:'Siemens',qty:1,parent:'Control Panel'}]}];saveBoms()}

function updateProjectName(){$('projectName').textContent=(currentProjectName||'EBS Cloud')+' â˜ï¸'}

// ============================================
// Authentication
// ============================================
function checkAuth(){
  const stored=sessionStorage.getItem('ebs-auth');
  return stored===ACCESS_CODE;
}

function login(code){
  if(code===ACCESS_CODE){
    sessionStorage.setItem('ebs-auth',code);
    isAuthenticated=true;
    $('loginScreen').style.display='none';
    initFirebaseListeners();
    return true;
  }
  return false;
}

function logout(){
  sessionStorage.removeItem('ebs-auth');
  isAuthenticated=false;
  location.reload();
}

// ============================================
// Firebase Real-time Listeners
// ============================================
const LOCAL_STORAGE_KEY = 'ebs-v3-data';
let useLocalStorage = false;
let dataInitialized = false;

function initFirebaseListeners(){
  showSync('syncing','Loading...');
  
  // ALWAYS check localStorage first
  const localData = loadFromLocalStorage();
  
  if(localData){
    // We have local data - use it immediately
    console.log('Loaded from localStorage');
    dataInitialized = true;
    showSync('synced','Loaded');
    setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
    
    // Try to connect to Firebase for sync
    tryFirebaseSync();
  } else {
    // No local data - try Firebase, then create sample if needed
    tryFirebaseFirst();
  }
}

function tryFirebaseFirst(){
  const timeout = setTimeout(()=>{
    // Firebase taking too long - create sample locally
    console.log('Firebase timeout, creating local sample');
    useLocalStorage = true;
    createAndSaveSampleData();
  }, 3000);
  
  projectRef.child('main').once('value').then(snapshot=>{
    clearTimeout(timeout);
    const val = snapshot.val();
    const hasData = val && val.data && (Array.isArray(val.data) ? val.data.length > 0 : Object.keys(val.data).length > 0);
    
    if(hasData){
      console.log('Loaded from Firebase');
      loadFromSnapshot(val);
      saveToLocalStorage(); // Cache locally
      dataInitialized = true;
      showSync('synced','Connected');
      setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
      setupRealtimeListener();
      initChat();
    } else {
      // Firebase empty - create sample and save to both
      console.log('Firebase empty, creating sample');
      createAndSaveSampleData();
      // Save to Firebase too
      projectRef.child('main').set({
        data, team, history, projectDates, actions, projectName: currentProjectName,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
      });
      setupRealtimeListener();
      initChat();
    }
  }).catch(err=>{
    clearTimeout(timeout);
    console.log('Firebase error, using localStorage:', err);
    useLocalStorage = true;
    createAndSaveSampleData();
  });
}

function tryFirebaseSync(){
  projectRef.child('main').once('value').then(snapshot=>{
    const val = snapshot.val();
    if(val && val.data){
      // Firebase has data - check if newer
      console.log('Firebase connected, setting up sync');
    }
    setupRealtimeListener();
    initChat();
  }).catch(err=>{
    console.log('Firebase unavailable, local mode only');
    useLocalStorage = true;
  });
}

function loadFromLocalStorage(){
  try {
    const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
    if(saved){
      const val = JSON.parse(saved);
      if(val.data && val.data.length > 0){
        data = val.data;
        team = val.team || [];
        history = val.history || [];
        actions = val.actions || [];
        projectDates = val.projectDates || {start:'',end:''};
        currentProjectName = val.projectName || 'EBS Project';
        updateProjectName();
        render();
        return true;
      }
    }
  } catch(e){
    console.error('localStorage read error:', e);
  }
  return false;
}

function saveToLocalStorage(){
  try {
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
      data, team, history, actions, projectDates, projectName: currentProjectName
    }));
  } catch(e){
    console.error('localStorage save error:', e);
  }
}

function createAndSaveSampleData(){
  createSampleData();
  saveToLocalStorage();
  dataInitialized = true;
  showSync('synced','Ready');
  setTimeout(()=>$('syncIndicator').classList.remove('active'),1500);
  toast('Project initialized: 15 assemblies, 150 parts');
}

function createSampleData(){
  const now=Date.now(),day=86400000;
  
  currentProjectName='Industrial Automation Line - Phase 2';
  team=[
    {name:'Marisa',email:'marisa@company.com'},
    {name:'John',email:'john@company.com'},
    {name:'Sarah',email:'sarah@company.com'},
    {name:'Mike',email:'mike@company.com'}
  ];
  
  const start=new Date();start.setDate(start.getDate()-14);
  const end=new Date();end.setDate(end.getDate()+45);
  projectDates={start:start.toISOString().split('T')[0],end:end.toISOString().split('T')[0]};
  
  // Notes and comments to add context
  const partNotes={
    'Robot Stand':'Custom fabrication - drawings sent to vendor Dec 15. Waiting for quote approval.',
    'Safety PLC':'Need to confirm safety category requirements with customer before ordering.',
    'Light Curtain 600mm':'Check if 600mm is sufficient - customer mentioned possible layout change.',
    'Robot Arm 6-Axis':'Long lead item - Fanuc quoted 3-4 weeks. December shipments may be delayed.',
    'Hydraulic Power Unit':'15HP unit is special order. Standard is 10HP. Confirm with engineering.',
    '2D Camera':'Keyence rep suggested newer model CV-X series. Waiting for comparison specs.',
    'Vision Camera':'Cognex recommended In-Sight 2800 instead. Need to validate.',
    'Air Compressor 7.5HP':'Verify if existing plant air can be used instead.',
    'Main Breaker 400A':'Electrician needs to confirm panel space before ordering.'
  };
  
  const partComments={
    'Robot Arm 6-Axis':[
      {text:'Fanuc confirmed delivery for Jan 15',ts:now-3*day,author:'John'},
      {text:'Need to book installation training - 2 days required',ts:now-day,author:'Marisa'}
    ],
    'Light Curtain 600mm':[
      {text:'Sick says 10 days lead time, not 7 as quoted',ts:now-5*day,author:'Sarah'},
      {text:'Ordered backup from Banner in case Sick is late',ts:now-2*day,author:'Marisa'}
    ],
    'Safety PLC':[
      {text:'Customer confirmed Cat 3 PLd is sufficient',ts:now-2*day,author:'Mike'}
    ],
    'Robot Stand':[
      {text:'Vendor asking for 50% deposit before starting fabrication',ts:now-4*day,author:'John'},
      {text:'Approved by finance - PO going out today',ts:now-day,author:'Marisa'}
    ],
    'Servo Motor 3kW':[
      {text:'Wrong model delivered - returning for replacement',ts:now-2*day,author:'Sarah'}
    ],
    'PLC CPU S7-1500':[
      {text:'Firmware needs to be V2.9 or higher for safety integration',ts:now-6*day,author:'Mike'}
    ],
    'HMI Panel 15"':[
      {text:'Customer wants additional screens added - change request pending',ts:now-3*day,author:'John'}
    ],
    'Hydraulic Power Unit':[
      {text:'Bosch Rexroth quoted 14 days - faster than Parker',ts:now-5*day,author:'Mike'},
      {text:'Oil cooler sizing needs verification with thermal calc',ts:now-2*day,author:'John'}
    ],
    '2D Camera':[
      {text:'Keyence demo went well. Proceeding with CV-X420 model',ts:now-4*day,author:'Sarah'},
      {text:'Need to order calibration target separately',ts:now-day,author:'Sarah'}
    ],
    'Gripper Assembly':[
      {text:'Schunk can do 5 day delivery if we pay express freight',ts:now-3*day,author:'Marisa'}
    ]
  };
  
  const partTemplates=[
    {asm:'Main Control Panel',parts:[{name:'PLC CPU S7-1500',code:'6ES7-1500',mfr:'Siemens'},{name:'HMI Panel 15"',code:'HMI-TP1500',mfr:'Siemens'},{name:'PSU 24V 40A',code:'PSU-24-40',mfr:'Mean Well'},{name:'DI Module 32pt',code:'IO-DI-32',mfr:'Siemens'},{name:'DO Module 32pt',code:'IO-DO-32',mfr:'Siemens'},{name:'AI Module 8ch',code:'IO-AI-8',mfr:'Siemens'},{name:'AO Module 4ch',code:'IO-AO-4',mfr:'Siemens'},{name:'Profinet Switch',code:'PN-SW-8',mfr:'Scalance'},{name:'UPS System',code:'UPS-3KVA',mfr:'APC'},{name:'Panel Cooler',code:'PC-500W',mfr:'Rittal'}]},
    {asm:'Conveyor Line 1',parts:[{name:'Servo Motor 3kW',code:'SM-3KW-01',mfr:'Yaskawa'},{name:'Servo Drive',code:'SD-3KW-01',mfr:'Yaskawa'},{name:'Gearbox 15:1',code:'GB-15-1',mfr:'SEW'},{name:'Timing Belt',code:'TB-500',mfr:'Gates'},{name:'Conveyor Frame',code:'CF-3M',mfr:'Bosch'},{name:'Guide Rails',code:'GR-3M',mfr:'Bosch'},{name:'Proximity Sensors x4',code:'PS-IND-4',mfr:'IFM'},{name:'Photo Eyes x2',code:'PE-RET-2',mfr:'Banner'},{name:'Motor Cable 15m',code:'MC-15M',mfr:'Lapp'},{name:'Encoder Cable',code:'EC-10M',mfr:'Lapp'}]},
    {asm:'Conveyor Line 2',parts:[{name:'Servo Motor 2kW',code:'SM-2KW-02',mfr:'Yaskawa'},{name:'Servo Drive 2kW',code:'SD-2KW-02',mfr:'Yaskawa'},{name:'Gearbox 10:1',code:'GB-10-2',mfr:'SEW'},{name:'V-Belt System',code:'VB-400',mfr:'Gates'},{name:'Conveyor Frame 2m',code:'CF-2M',mfr:'Bosch'},{name:'Side Guards',code:'SG-2M',mfr:'Bosch'},{name:'Inductive Sensors x6',code:'PS-IND-6',mfr:'IFM'},{name:'Reflective Sensor',code:'RS-01',mfr:'Sick'},{name:'Junction Box',code:'JB-IP65',mfr:'Wago'},{name:'Cable Tray 2m',code:'CT-2M',mfr:'Legrand'}]},
    {asm:'Robot Cell 1',parts:[{name:'Robot Arm 6-Axis',code:'RA-6AX-20',mfr:'Fanuc'},{name:'Robot Controller R30iB',code:'RC-R30IB',mfr:'Fanuc'},{name:'Gripper Assembly',code:'GRP-PNU',mfr:'Schunk'},{name:'Tool Changer',code:'TC-AUTO',mfr:'ATI'},{name:'Vision Camera',code:'VC-2MP',mfr:'Cognex'},{name:'Vision Light',code:'VL-RING',mfr:'CCS'},{name:'Robot Pedestal',code:'RP-750',mfr:'Custom'},{name:'Safety Mat',code:'SM-1200',mfr:'Omron'},{name:'Teach Pendant Cable',code:'TPC-10M',mfr:'Fanuc'},{name:'Robot Base Plate',code:'RBP-01',mfr:'Custom'}]},
    {asm:'Robot Cell 2',parts:[{name:'Robot Arm SCARA',code:'RA-SCARA',mfr:'Epson'},{name:'Robot Controller RC90',code:'RC-90',mfr:'Epson'},{name:'Vacuum Gripper',code:'VG-SUC',mfr:'Schmalz'},{name:'Force Sensor',code:'FS-6AX',mfr:'ATI'},{name:'2D Camera',code:'CAM-2D',mfr:'Keyence'},{name:'Backlight Panel',code:'BL-200',mfr:'CCS'},{name:'Robot Stand',code:'RS-400',mfr:'Custom'},{name:'Vacuum Generator',code:'VG-01',mfr:'SMC'},{name:'IO Link Master',code:'IOL-8PT',mfr:'IFM'},{name:'Cable Carrier',code:'CC-R38',mfr:'Igus'}]},
    {asm:'Safety System',parts:[{name:'Safety PLC',code:'SP-PNOZ',mfr:'Pilz'},{name:'Light Curtain 600mm',code:'LC-600',mfr:'Sick'},{name:'Light Curtain 400mm',code:'LC-400',mfr:'Sick'},{name:'E-Stop Stations x4',code:'ES-4SET',mfr:'ABB'},{name:'Safety Door Switch x3',code:'SDS-3SET',mfr:'Schmersal'},{name:'Safety Relay Module',code:'SRM-01',mfr:'Pilz'},{name:'Muting Sensors x4',code:'MS-4SET',mfr:'Sick'},{name:'Safety Scanner',code:'SS-3M',mfr:'Sick'},{name:'Reset Button x2',code:'RB-2SET',mfr:'ABB'},{name:'Safety Edge',code:'SE-2M',mfr:'Haake'}]},
    {asm:'Pneumatic System',parts:[{name:'Air Compressor 7.5HP',code:'AC-7HP',mfr:'Atlas Copco'},{name:'Air Dryer',code:'AD-REF',mfr:'Atlas Copco'},{name:'FRL Unit Large',code:'FRL-LG',mfr:'SMC'},{name:'Main Manifold',code:'MM-16PT',mfr:'SMC'},{name:'Solenoid Valves x8',code:'SV-5-8',mfr:'SMC'},{name:'Cylinders 50mm x4',code:'CYL-50-4',mfr:'Festo'},{name:'Cylinders 32mm x6',code:'CYL-32-6',mfr:'Festo'},{name:'Flow Controls x10',code:'FC-10SET',mfr:'SMC'},{name:'Air Tank 100L',code:'AT-100L',mfr:'SMC'},{name:'Pressure Transducer',code:'PT-0-10',mfr:'SMC'}]},
    {asm:'Hydraulic Unit',parts:[{name:'Hydraulic Power Unit',code:'HPU-15HP',mfr:'Bosch Rexroth'},{name:'Hydraulic Manifold',code:'HM-6PT',mfr:'Custom'},{name:'Proportional Valve',code:'PV-01',mfr:'Bosch Rexroth'},{name:'Pressure Relief Valve',code:'PRV-210',mfr:'Sun'},{name:'Hydraulic Cylinder',code:'HC-100-500',mfr:'Parker'},{name:'Hydraulic Hoses Set',code:'HH-SET',mfr:'Eaton'},{name:'Oil Cooler',code:'OC-24V',mfr:'AKG'},{name:'Hydraulic Filter',code:'HF-10UM',mfr:'Hydac'},{name:'Level Switch',code:'LS-01',mfr:'Hydac'},{name:'Pressure Gauge x2',code:'PG-2SET',mfr:'WIKA'}]},
    {asm:'Electrical Distribution',parts:[{name:'Main Breaker 400A',code:'MB-400A',mfr:'ABB'},{name:'Contactor 150A x2',code:'CT-150-2',mfr:'ABB'},{name:'Soft Starter 75kW',code:'SS-75KW',mfr:'ABB'},{name:'VFD 15kW',code:'VFD-15KW',mfr:'ABB'},{name:'VFD 7.5kW x2',code:'VFD-7K5-2',mfr:'ABB'},{name:'MCB Set 20pc',code:'MCB-20SET',mfr:'Schneider'},{name:'Overload Relays x6',code:'OLR-6SET',mfr:'ABB'},{name:'Power Meter',code:'PM-3PH',mfr:'Schneider'},{name:'Surge Protector',code:'SPD-01',mfr:'Phoenix'},{name:'Bus Bar System',code:'BBS-400A',mfr:'Rittal'}]},
    {asm:'Vision Inspection',parts:[{name:'Smart Camera',code:'SC-5MP',mfr:'Cognex'},{name:'Telecentric Lens',code:'TL-0.5X',mfr:'Edmund'},{name:'Dome Light',code:'DL-150',mfr:'CCS'},{name:'Bar Light x2',code:'BAR-200-2',mfr:'CCS'},{name:'Light Controller',code:'LC-4CH',mfr:'CCS'},{name:'Camera Mount',code:'CM-ADJ',mfr:'Cognex'},{name:'Trigger Sensor',code:'TS-01',mfr:'Banner'},{name:'Ethernet Switch',code:'ETH-5PT',mfr:'Cisco'},{name:'Reject Cylinder',code:'RJ-CYL',mfr:'Festo'},{name:'Inspection Stand',code:'IS-ADJ',mfr:'Custom'}]},
    {asm:'Labeling Station',parts:[{name:'Label Applicator',code:'LA-AUTO',mfr:'Videojet'},{name:'Label Roll Holder',code:'LRH-01',mfr:'Videojet'},{name:'Print Engine',code:'PE-300',mfr:'Zebra'},{name:'Ribbon Holder',code:'RIB-01',mfr:'Zebra'},{name:'Label Sensor',code:'LS-FORK',mfr:'Sick'},{name:'Tamp Cylinder',code:'TC-50',mfr:'Festo'},{name:'Vacuum Pad Set',code:'VP-SET',mfr:'Schmalz'},{name:'Control Box',code:'LCB-01',mfr:'Custom'},{name:'Warning Lights',code:'WL-3CLR',mfr:'Patlite'},{name:'Label Waste Bin',code:'LWB-01',mfr:'Custom'}]},
    {asm:'Packaging Unit',parts:[{name:'Box Former',code:'BF-AUTO',mfr:'Wexxar'},{name:'Tape Head x2',code:'TH-2SET',mfr:'3M'},{name:'Case Conveyor',code:'CC-1.5M',mfr:'Bosch'},{name:'Pusher Cylinder',code:'PC-100',mfr:'Festo'},{name:'Box Magazine',code:'BM-50',mfr:'Custom'},{name:'Glue System',code:'GS-HOT',mfr:'Nordson'},{name:'Glue Nozzles x4',code:'GN-4SET',mfr:'Nordson'},{name:'Photoeye Set',code:'PES-3',mfr:'Banner'},{name:'Reject Gate',code:'RG-01',mfr:'Custom'},{name:'Pack Counter',code:'PC-DIG',mfr:'Red Lion'}]},
    {asm:'Palletizer',parts:[{name:'Palletizer Frame',code:'PF-MAIN',mfr:'Custom'},{name:'Layer Gripper',code:'LG-01',mfr:'Schmalz'},{name:'Z-Axis Servo',code:'ZS-5KW',mfr:'Yaskawa'},{name:'X-Axis Linear',code:'XL-2M',mfr:'Bosch'},{name:'Y-Axis Linear',code:'YL-1.5M',mfr:'Bosch'},{name:'Pallet Dispenser',code:'PD-01',mfr:'Custom'},{name:'Slip Sheet Inserter',code:'SSI-01',mfr:'Custom'},{name:'Layer Press',code:'LP-01',mfr:'Custom'},{name:'Pallet Sensor',code:'PS-RF',mfr:'Sick'},{name:'Stack Height Sensor',code:'SHS-01',mfr:'Banner'}]},
    {asm:'Stretch Wrapper',parts:[{name:'Turntable',code:'TT-1500',mfr:'Lantech'},{name:'Film Carriage',code:'FC-PRE',mfr:'Lantech'},{name:'Film Roll Holder',code:'FRH-01',mfr:'Lantech'},{name:'Mast Assembly',code:'MA-2M',mfr:'Lantech'},{name:'Cut & Clamp',code:'CC-AUTO',mfr:'Lantech'},{name:'Top Press',code:'TP-01',mfr:'Custom'},{name:'Ramp',code:'RAMP-01',mfr:'Custom'},{name:'Film Break Sensor',code:'FBS-01',mfr:'Banner'},{name:'Wrap Counter',code:'WC-DIG',mfr:'Red Lion'},{name:'Safety Fence Gate',code:'SFG-01',mfr:'Troax'}]},
    {asm:'Outfeed Conveyor',parts:[{name:'Roller Conveyor 3m',code:'RC-3M',mfr:'Hytrol'},{name:'Drive Motor 1.5kW',code:'DM-1K5',mfr:'SEW'},{name:'Gearmotor',code:'GM-01',mfr:'SEW'},{name:'Accumulation Zone x3',code:'AZ-3SET',mfr:'Hytrol'},{name:'Zone Sensors',code:'ZS-6SET',mfr:'Banner'},{name:'Transfer Section',code:'TS-90',mfr:'Hytrol'},{name:'End Stop',code:'ESTOP-01',mfr:'Custom'},{name:'Pallet Stop x2',code:'PSTOP-2',mfr:'Custom'},{name:'Guide Rails 3m',code:'GR-3M-2',mfr:'Bosch'},{name:'Floor Mounts Set',code:'FM-SET',mfr:'Custom'}]}
  ];

  data=[];let id=1;expanded={};
  const statuses=['to-order','ordered','arrived','tested','installed'];
  
  partTemplates.forEach((template,ai)=>{
    const asmId=id++;
    const asmAssignee=Math.random()<0.8?'Marisa':team[ai%team.length].name;
    data.push({id:asmId,name:template.asm,isAsm:true,assignee:asmAssignee,priority:ai+1});
    expanded[asmId]=ai<3;
    
    template.parts.forEach((p,pi)=>{
      const statusIdx=Math.floor(Math.random()*5);
      const partId=id++;
      let orderedAt,arrivedAt,expectedArrival;
      const partAssignee=Math.random()<0.8?'Marisa':team[(ai+pi)%team.length].name;
      
      if(statusIdx>=1){
        const orderDaysAgo=Math.floor(Math.random()*15)+5;
        orderedAt=now-orderDaysAgo*day;
        const expectedLeadDays=Math.floor(Math.random()*9)+3;
        expectedArrival=new Date(orderedAt+expectedLeadDays*day).toISOString().split('T')[0];
        
        if(statusIdx>=2){
          const onTime=Math.random()>0.3;
          const actualLeadDays=onTime?Math.floor(Math.random()*expectedLeadDays)+1:expectedLeadDays+Math.floor(Math.random()*5)+1;
          arrivedAt=orderedAt+actualLeadDays*day;
          if(arrivedAt>now)arrivedAt=now-Math.floor(Math.random()*3)*day;
        }
      }
      
      // Add notes and comments
      const notes=partNotes[p.name]||'';
      const comments=partComments[p.name]||[];
      
      data.push({id:partId,name:p.name,code:p.code,mfr:p.mfr,qty:Math.ceil(Math.random()*3),assignee:partAssignee,parentId:asmId,status:statuses[statusIdx],changedAt:now-Math.floor(Math.random()*14)*day,orderedAt,arrivedAt,expectedArrival,notes,comments:comments.length?comments:undefined});
    });
  });

  history=[
    {date:new Date(now-14*day).toISOString().split('T')[0],pct:5},
    {date:new Date(now-12*day).toISOString().split('T')[0],pct:12},
    {date:new Date(now-10*day).toISOString().split('T')[0],pct:18},
    {date:new Date(now-8*day).toISOString().split('T')[0],pct:28},
    {date:new Date(now-6*day).toISOString().split('T')[0],pct:35},
    {date:new Date(now-4*day).toISOString().split('T')[0],pct:42},
    {date:new Date(now-2*day).toISOString().split('T')[0],pct:48},
    {date:new Date(now-day).toISOString().split('T')[0],pct:55}
  ];

  const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);
  const nextWeek=new Date();nextWeek.setDate(nextWeek.getDate()+7);
  const twoDaysAgo=new Date();twoDaysAgo.setDate(twoDaysAgo.getDate()-2);
  const inTwoDays=new Date();inTwoDays.setDate(inTwoDays.getDate()+2);
  const inFourDays=new Date();inFourDays.setDate(inFourDays.getDate()+4);
  
  actions=[
    {id:now+1,task:'Order remaining pneumatic components',linkedPartId:null,due:yesterday.toISOString().split('T')[0],assignee:'Marisa',status:'not-started',createdAt:new Date(now-7*day).toISOString().split('T')[0]},
    {id:now+2,task:'Complete safety system certification docs',linkedPartId:null,due:nextWeek.toISOString().split('T')[0],assignee:'Mike',status:'in-progress',createdAt:new Date(now-5*day).toISOString().split('T')[0]},
    {id:now+3,task:'Follow up with Fanuc on robot delivery',linkedPartId:null,due:inTwoDays.toISOString().split('T')[0],assignee:'John',status:'not-started',createdAt:new Date(now-3*day).toISOString().split('T')[0]},
    {id:now+4,task:'Get deposit approval for Robot Stand fabrication',linkedPartId:null,due:twoDaysAgo.toISOString().split('T')[0],assignee:'Marisa',status:'completed',createdAt:new Date(now-5*day).toISOString().split('T')[0]},
    {id:now+5,task:'Schedule hydraulic system commissioning',linkedPartId:null,due:nextWeek.toISOString().split('T')[0],assignee:'John',status:'not-started',createdAt:new Date(now-5*day).toISOString().split('T')[0]},
    {id:now+6,task:'Review customer change request for HMI screens',linkedPartId:null,due:inFourDays.toISOString().split('T')[0],assignee:'Sarah',status:'in-progress',createdAt:new Date(now-2*day).toISOString().split('T')[0]},
    {id:now+7,task:'Confirm Sick light curtain lead time',linkedPartId:null,due:yesterday.toISOString().split('T')[0],assignee:'Sarah',status:'completed',createdAt:new Date(now-4*day).toISOString().split('T')[0]},
    {id:now+8,task:'Order calibration target for Keyence camera',linkedPartId:null,due:inTwoDays.toISOString().split('T')[0],assignee:'Sarah',status:'not-started',createdAt:new Date(now-1*day).toISOString().split('T')[0]}
  ];

  leadTimeDb={
    '6ES7-1500':{samples:[{days:7,date:'2024-12-20'},{days:6,date:'2024-12-10'},{days:8,date:'2024-11-25'}],avg:7},
    'HMI-TP1500':{samples:[{days:10,date:'2024-12-15'},{days:12,date:'2024-11-20'}],avg:11},
    'SM-3KW-01':{samples:[{days:5,date:'2024-12-22'},{days:4,date:'2024-12-01'}],avg:5},
    'RA-6AX-20':{samples:[{days:21,date:'2024-12-15'},{days:18,date:'2024-11-10'}],avg:20},
    'LC-600':{samples:[{days:8,date:'2024-12-18'},{days:7,date:'2024-12-05'}],avg:8},
    'HPU-15HP':{samples:[{days:14,date:'2024-12-10'}],avg:14},
    'SC-5MP':{samples:[{days:6,date:'2024-12-20'},{days:5,date:'2024-12-08'}],avg:6},
    'VFD-15KW':{samples:[{days:3,date:'2024-12-22'},{days:4,date:'2024-12-15'},{days:3,date:'2024-12-01'}],avg:3}
  };
  
  updateProjectName();
  render();
}

function loadFromSnapshot(val){
  if(!val) return;
  
  if(val.data){
    data = Array.isArray(val.data) ? val.data : Object.values(val.data);
  } else {
    data = [];
  }
  if(val.team){
    team = Array.isArray(val.team) ? val.team : Object.values(val.team);
  } else {
    team = [];
  }
  if(val.history){
    history = Array.isArray(val.history) ? val.history : Object.values(val.history);
  } else {
    history = [];
  }
  if(val.actions){
    actions = Array.isArray(val.actions) ? val.actions : Object.values(val.actions);
  } else {
    actions = [];
  }
  projectDates = val.projectDates || {start:'',end:''};
  currentProjectName = val.projectName || 'EBS Project';
  
  updateProjectName();
  render();
}

// Track local changes to avoid re-render on echo
let pendingRenderTimeout = null;

function setupRealtimeListener(){
  let skipNext = true;
  
  projectRef.child('main').on('value', snapshot=>{
    if(skipNext){
      skipNext = false;
      return;
    }
    
    // If this is our own change echoing back (within 2 seconds), skip re-render
    if(Date.now() - lastLocalSaveTime < 2000){
      return;
    }
    
    const val = snapshot.val();
    if(val && val.data){
      console.log('Received update from another user');
      loadFromSnapshot(val);
      saveToLocalStorage();
    }
  });
  
  projectRef.child('leadTime').on('value', snapshot=>{
    leadTimeDb = snapshot.val() || {};
  });
  
  projectRef.child('boms').on('value', snapshot=>{
    const val = snapshot.val();
    if(val) savedBoms = Array.isArray(val) ? val : Object.values(val);
  });
  
  projectRef.child('globalCodes').on('value', snapshot=>{
    const val = snapshot.val();
    globalCodes = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  });
  
  projectRef.child('globalMfrs').on('value', snapshot=>{
    const val = snapshot.val();
    globalMfrs = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
  });
  
  let wasOffline = false;
  db.ref('.info/connected').on('value', snapshot=>{
    isConnected = snapshot.val() === true;
    if(!isConnected && !useLocalStorage){
      wasOffline = true;
      showSync('offline','Offline');
    } else if(wasOffline){
      wasOffline = false;
      showSync('synced','Back online');
      setTimeout(()=>$('syncIndicator').classList.remove('active'),2000);
    }
  });
}

// ============================================
// Login UI Handlers
// ============================================
$('loginBtn').onclick=()=>{
  const code=$('loginCode').value.trim();
  if(!code){
    $('loginError').textContent='Please enter access code';
    return;
  }
  $('loginBtn').disabled=true;
  $('loginBtn').textContent='Signing in...';
  
  // Small delay for UX
  setTimeout(()=>{
    if(login(code)){
      $('loginError').textContent='';
    }else{
      $('loginError').textContent='Invalid access code';
      $('loginBtn').disabled=false;
      $('loginBtn').textContent='Sign In';
    }
  },500);
};

$('loginCode').onkeydown=e=>{if(e.key==='Enter')$('loginBtn').click()};

// Check connection status on load
db.ref('.info/connected').once('value').then(()=>{
  $('loginStatus').textContent='Ready';
}).catch(()=>{
  $('loginStatus').textContent='Unable to connect - check Firebase config';
});

function recordLeadTime(code,days){if(!code||days<=0||days>365)return;code=code.toUpperCase();if(!leadTimeDb[code])leadTimeDb[code]={samples:[],avg:null};const entry=leadTimeDb[code];entry.samples.push({days,date:new Date().toISOString().split('T')[0]});if(entry.samples.length>20)entry.samples=entry.samples.slice(-20);entry.avg=Math.round(entry.samples.reduce((a,s)=>a+s.days,0)/entry.samples.length);saveLeadTime()}

function getPartETA(part){
  if(STAGES.indexOf(part.status)>=2)return{display:'â€”',type:'done'};
  
  // Helper to format date as "25.12."
  function formatDate(d){
    return d.getDate()+'.'+(d.getMonth()+1)+'.';
  }
  
  // For manual ETA, calculate from orderedAt if available, else from today
  if(part.manualEta!==undefined&&part.manualEta!==null){
    const baseDate=part.orderedAt?new Date(part.orderedAt):new Date();
    const arrivalDate=new Date(baseDate);
    arrivalDate.setDate(arrivalDate.getDate()+part.manualEta);
    return{display:formatDate(arrivalDate),type:'manual',days:part.manualEta};
  }
  
  const code=part.code?part.code.toUpperCase():null;
  const lt=code?leadTimeDb[code]:null;
  if(lt&&lt.avg){
    // For ordered parts, calculate arrival date from order date
    if(part.status==='ordered'&&part.orderedAt){
      const orderDate=new Date(part.orderedAt);
      const arrivalDate=new Date(orderDate);
      arrivalDate.setDate(arrivalDate.getDate()+lt.avg);
      return{display:formatDate(arrivalDate),type:'predicted',days:lt.avg,avg:lt.avg};
    }
    // For to-order parts, we can't calculate a date since we don't know when they'll be ordered
    return{display:'?',type:'unknown'};
  }
  return{display:'?',type:'unknown'};
}
function getLeadTimeHistory(code){if(!code)return null;return leadTimeDb[code.toUpperCase()]||null}
function getProgressColor(pct){if(pct<20)return'var(--red)';if(pct<40)return'var(--orange)';return'var(--green)'}

function isOnSchedule(){
  if(!projectDates.start||!projectDates.end)return true;
  const start=new Date(projectDates.start),end=new Date(projectDates.end),now=new Date();
  const totalDays=Math.max(1,(end-start)/86400000);
  const elapsedDays=Math.max(0,(now-start)/86400000);
  const expectedPct=(elapsedDays/totalDays)*100;
  const actualPct=calcOverallProgress();
  return actualPct>=expectedPct;
}

function getScheduleColor(){return isOnSchedule()?'var(--green)':'var(--red)'}
function getProgressClass(pct){if(pct<20)return'red';if(pct<40)return'orange';return'green'}

// Calculate Supplier OTD from actual project data
function calcSupplierOTD(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt);
  if(!parts.length)return null;
  let onTime=0,total=0;
  parts.forEach(p=>{
    total++;
    // Check if arrived on or before expected date
    if(p.expectedArrival){
      const expected=new Date(p.expectedArrival).getTime();
      if(p.arrivedAt<=expected+86400000)onTime++; // Give 1 day grace
    }else{
      // No expected date set, consider on-time if lead time was reasonable (<=14 days)
      const days=Math.round((p.arrivedAt-p.orderedAt)/86400000);
      if(days<=14)onTime++;
    }
  });
  return total?Math.round(onTime/total*100):null;
}

// Calculate average lead time from actual project data
function calcAvgLeadTime(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt);
  if(!parts.length)return null;
  const totalDays=parts.reduce((sum,p)=>sum+Math.round((p.arrivedAt-p.orderedAt)/86400000),0);
  return Math.round(totalDays/parts.length);
}

// Calculate OTD per manufacturer
function calcOTDByMfr(){
  const parts=getParts().filter(p=>p.arrivedAt&&p.orderedAt&&p.mfr);
  const mfrStats={};
  parts.forEach(p=>{
    const mfr=p.mfr;
    if(!mfrStats[mfr])mfrStats[mfr]={onTime:0,total:0,totalDays:0};
    mfrStats[mfr].total++;
    const days=Math.round((p.arrivedAt-p.orderedAt)/86400000);
    mfrStats[mfr].totalDays+=days;
    if(p.expectedArrival){
      const expected=new Date(p.expectedArrival).getTime();
      if(p.arrivedAt<=expected+86400000)mfrStats[mfr].onTime++;
    }else{
      if(days<=14)mfrStats[mfr].onTime++;
    }
  });
  return Object.keys(mfrStats).map(mfr=>({
    mfr,
    otd:Math.round(mfrStats[mfr].onTime/mfrStats[mfr].total*100),
    avgLead:Math.round(mfrStats[mfr].totalDays/mfrStats[mfr].total),
    total:mfrStats[mfr].total
  })).sort((a,b)=>b.otd-a.otd||b.total-a.total);
}

function getVelocityForecast(){if(history.length<2)return null;const first=history[0],last=history[history.length-1];const days=Math.max(1,(new Date(last.date)-new Date(first.date))/86400000);const rate=(last.pct-first.pct)/days;if(rate<=0)return{status:'stalled',rate:0,estDate:null,daysToComplete:null};const pct=calcOverallProgress();const remaining=100-pct;const daysToComplete=Math.ceil(remaining/rate);const estDate=new Date();estDate.setDate(estDate.getDate()+daysToComplete);const daysLeft=getDaysLeft();let status='on-track';if(daysLeft!==null){if(daysToComplete>daysLeft+3)status='at-risk';else if(daysToComplete>daysLeft)status='behind';else if(daysToComplete<daysLeft-3)status='ahead'}return{status,rate,estDate:estDate.toISOString().split('T')[0],daysToComplete,daysLeft}}

const getAsms=()=>data.filter(d=>d.isAsm).sort((a,b)=>(a.priority||99)-(b.priority||99));
const getParts=()=>data.filter(d=>!d.isAsm);
const getPartActions=partId=>actions.filter(a=>a.linkedPartId===partId&&a.status!=='completed');
const getPartById=id=>data.find(d=>d.id===id);
const getTeamEmail=name=>{const t=team.find(m=>m.name===name);return t?t.email:''};
const calcPartProgress=p=>STAGES.indexOf(p.status)/(STAGES.length-1);
function calcAsmProgress(asmId){const kids=data.filter(d=>d.parentId===asmId);if(!kids.length)return 0;return Math.round(kids.reduce((acc,k)=>acc+calcPartProgress(k),0)/kids.length*100)}
function calcOverallProgress(){const parts=getParts();if(!parts.length)return 0;return Math.round(parts.reduce((acc,p)=>acc+calcPartProgress(p),0)/parts.length*100)}
function getExpectedProgress(){if(!projectDates.start||!projectDates.end)return null;const start=new Date(projectDates.start),end=new Date(projectDates.end),now=new Date();const total=end-start,elapsed=now-start;if(elapsed<0)return 0;if(elapsed>total)return 100;return Math.round(elapsed/total*100)}
function getDaysLeft(){if(!projectDates.end)return null;return Math.ceil((new Date(projectDates.end)-new Date())/86400000)}
function getProjectDateRange(){const parts=getParts();if(!parts.length)return{start:null,end:null};let earliest=null,latest=null;parts.forEach(p=>{if(p.changedAt){const d=new Date(p.changedAt);if(!earliest||d<earliest)earliest=d;if(!latest||d>latest)latest=d}});if(projectDates.start)earliest=new Date(projectDates.start);if(projectDates.end)latest=new Date(projectDates.end);return{start:earliest,end:latest}}
function recordProgress(){const today=new Date().toISOString().split('T')[0];const pct=calcOverallProgress();const idx=history.findIndex(h=>h.date===today);if(idx>=0)history[idx].pct=pct;else history.push({date:today,pct});if(history.length>100)history=history.slice(-100)}
const formatDate=d=>{if(!d)return'â€”';const p=d.split('-');return p[1]+'/'+p[2]};
const formatDateShort=d=>{if(!d)return'â€”';const dt=new Date(d);return dt.getDate()+'.'+(dt.getMonth()+1)+'.'};
const getWeek=d=>{const o=new Date(d.getFullYear(),0,1);return Math.ceil((((d-o)/86400000)+o.getDay()+1)/7)};

function render(){
  try{
    recordProgress();save();updateProjectName();
    const parts=getParts(),asms=getAsms();
    const pct=calcOverallProgress(),daysLeft=getDaysLeft();
    const readyCount=parts.filter(p=>p.status==='installed').length;

    $('sReady').textContent=readyCount+'/'+parts.length;
    $('sReady').style.color=parts.length?(readyCount===parts.length?'var(--green)':'var(--text)'):'var(--text3)';
    const scheduleColor=getScheduleColor();
    $('sPct').textContent=pct+'%';
    $('sPct').style.color=scheduleColor;
    $('sBar').style.width=pct+'%';
    $('sBar').style.background=scheduleColor;
    $('hmProgress').title=isOnSchedule()?'On Schedule':'Behind Schedule';

    if(daysLeft!==null){$('hmDays').style.display='block';$('sDays').textContent=daysLeft+'d';$('sDays').className='hm-value '+(daysLeft<3?'red':daysLeft<7?'yellow':'')}
    else{$('hmDays').style.display='none'}

    $('p1').textContent=parts.filter(p=>p.status==='to-order').length;
    $('p2').textContent=parts.filter(p=>p.status==='ordered').length;
    $('p3').textContent=parts.filter(p=>p.status==='arrived').length;
    $('p4').textContent=parts.filter(p=>p.status==='configured').length;
    $('p5').textContent=parts.filter(p=>p.status==='tested').length;
    $('p6').textContent=parts.filter(p=>p.status==='installed').length;

    document.querySelectorAll('.pipe').forEach(p=>p.classList.toggle('active',p.dataset.s===filterStage));
    $('pmParent').innerHTML='<option value="">â€”</option>'+asms.map(a=>'<option value="'+a.id+'">'+esc(a.name)+'</option>').join('');
    updateSelects();updateExpandToggle();renderInsights();renderActions();updateAIAlert();

    let badges='';
    if(filterStage)badges+='<span class="filter-badge">'+SLABELS[filterStage]+' <button onclick="window.clearStageFilter()">Ã—</button></span>';
    if(filterAssignee)badges+='<span class="filter-badge">'+esc(filterAssignee)+' <button onclick="window.clearAssigneeFilter()">Ã—</button></span>';
    $('filterBadges').innerHTML=badges;

    let html='<div class="add-row"><button class="add-row-btn" onclick="window.addNewAsm()">+</button><span class="add-row-text">Add assembly</span></div>';
    
    // Helper to render a part and its sub-parts recursively
    function renderPartWithChildren(part,depth){
      let partHtml=renderPart({type:'part',item:part,child:true,depth:depth});
      // Check for sub-parts (parts whose parentId is this part's id)
      const subParts=data.filter(d=>!d.isAsm&&d.parentId===part.id);
      if(subParts.length){
        subParts.filter(matchPart).forEach(sp=>{
          partHtml+=renderPart({type:'part',item:sp,child:true,depth:depth+1});
        });
      }
      return partHtml;
    }
    
    asms.forEach(asm=>{
      // Get direct children of assembly (not sub-parts of parts)
      const kids=data.filter(d=>d.parentId===asm.id&&!data.find(p=>p.id===d.parentId&&!p.isAsm));
      const matchingKids=kids.filter(matchPart);
      const asmMatch=!filterAssignee||asm.assignee===filterAssignee;
      if((filterStage||filterAssignee)&&!matchingKids.length&&!asmMatch)return;
      if(searchQ&&asm.name.toLowerCase().indexOf(searchQ.toLowerCase())===-1&&!matchingKids.length)return;
      const isExp=(filterStage||filterAssignee)?true:expanded[asm.id];
      html+=renderAsm({type:'asm',item:asm,kids:kids.length,match:matchingKids.length,exp:isExp});
      if(isExp){
        const visibleKids=(filterStage||filterAssignee)?matchingKids:kids.filter(matchPart);
        visibleKids.forEach(k=>{html+=renderPartWithChildren(k,0)});
        html+='<div class="add-row" style="padding-left:44px"><button class="add-row-btn" onclick="window.addNewPart('+asm.id+')">+</button><span class="add-row-text">Add part to '+esc(asm.name)+'</span></div>';
      }
    });
    data.filter(d=>!d.isAsm&&!d.parentId).filter(matchPart).forEach(p=>{html+=renderPart({type:'part',item:p,child:false,depth:0})});
    $('partsList').innerHTML=html;
    $('partsTable').style.display='flex';$('emptyList').style.display='none';
    if(highlightPartId){setTimeout(()=>{const row=document.querySelector('[data-part-id="'+highlightPartId+'"]');if(row){row.classList.add('highlight');setTimeout(()=>row.classList.remove('highlight'),1500)}highlightPartId=null},50)}
    renderGantt();
    if($('progressPanel').classList.contains('active'))renderBurndown();
  }catch(err){console.error('Render error:',err)}
}

const matchPart=p=>{if(filterStage&&p.status!==filterStage)return false;if(filterAssignee&&p.assignee!==filterAssignee)return false;if(searchQ&&[p.name,p.assignee,p.code,p.mfr].join(' ').toLowerCase().indexOf(searchQ.toLowerCase())===-1)return false;return true};

function renderInsights(){
  const daysLeft=getDaysLeft(),pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast(),otd=calcSupplierOTD(),avgLead=calcAvgLeadTime();

  $('insDays').textContent=daysLeft!==null?daysLeft+'d':'â€”';
  $('insDays').className='ins-val'+(daysLeft!==null&&daysLeft<3?' red':daysLeft!==null&&daysLeft<7?' yellow':'');

  if(expected!==null){
    const diff=pct-expected;
    if(diff>=5){$('insStatus').textContent='Ahead';$('insStatus').className='ins-val green'}
    else if(diff<=-5){$('insStatus').textContent='Behind';$('insStatus').className='ins-val red'}
    else{$('insStatus').textContent='On Track';$('insStatus').className='ins-val green'}
    $('insExpected').textContent=expected+'%';
  }else{$('insStatus').textContent='â€”';$('insExpected').textContent='â€”'}

  $('insActual').textContent=pct+'%';
  $('insActual').className='ins-val '+getProgressClass(pct);

  $('insOTD').textContent=otd!==null?otd+'%':'â€”';
  $('insOTD').className='ins-val '+(otd===null?'':(otd>=90?'green':otd>=70?'yellow':'red'));
  $('insAvgLead').textContent=avgLead!==null?avgLead+'d':'â€”';

  if(forecast&&forecast.rate>0){
    $('insRate').textContent=forecast.rate.toFixed(1)+'%/d';
    $('insRate').className='ins-val green';
    $('insEst').textContent=formatDateShort(forecast.estDate);
    $('insEst').className='ins-val'+(forecast.status==='ahead'||forecast.status==='on-track'?' green':' red');
    $('forecastDate').textContent=formatDateShort(forecast.estDate);
    $('forecastDate').style.color=forecast.status==='ahead'||forecast.status==='on-track'?'var(--green)':'var(--red)';
    if(forecast.daysLeft!==null){
      const diff=forecast.daysLeft-forecast.daysToComplete;
      if(diff>0){$('forecastLabel').textContent=diff+' days early';$('forecastLabel').style.color='var(--green)'}
      else if(diff<0){$('forecastLabel').textContent=Math.abs(diff)+' days late';$('forecastLabel').style.color='var(--red)'}
      else{$('forecastLabel').textContent='on deadline';$('forecastLabel').style.color='var(--text2)'}
    }else{$('forecastLabel').textContent=''}
    $('forecastDetail').textContent='At '+forecast.rate.toFixed(1)+'%/day â€¢ '+forecast.daysToComplete+'d to complete';
  }else{
    $('insRate').textContent='â€”';$('insEst').textContent='â€”';
    $('forecastDate').textContent='â€”';$('forecastDate').style.color='var(--text3)';
    $('forecastLabel').textContent='';$('forecastDetail').textContent='Need 2+ days of data';
  }
}

function renderActions(){
  const today=new Date().toISOString().split('T')[0],soon=new Date();soon.setDate(soon.getDate()+3);const soonStr=soon.toISOString().split('T')[0];
  const filtered=actions.filter(a=>{
    if(actionSearchQ&&!a.task.toLowerCase().includes(actionSearchQ.toLowerCase()))return false;
    if(actionAssigneeFilter&&a.assignee!==actionAssigneeFilter)return false;
    return true;
  }).sort((a,b)=>{if(a.status==='completed'&&b.status!=='completed')return 1;if(b.status==='completed'&&a.status!=='completed')return -1;return new Date(a.due||'9999')-new Date(b.due||'9999')});
  if(!filtered.length){$('actionsList').innerHTML='';$('actionsTable').style.display='none';$('emptyActions').style.display='flex';return}
  $('actionsTable').style.display='flex';$('emptyActions').style.display='none';
  $('actionsList').innerHTML=filtered.map(a=>{
    let dueClass='';if(a.status!=='completed'&&a.due){if(a.due<today)dueClass=' overdue';else if(a.due<=soonStr)dueClass=' soon'}
    const si=ASTAGES.indexOf(a.status),next=ASTAGES[si+1];
    const advBtn=!next?'<button class="adv-btn done">âœ“</button>':'<button class="adv-btn" onclick="window.advAction('+a.id+')">â†’</button>';
    const linkedPart=a.linkedPartId?getPartById(a.linkedPartId):null;
    const linkedHtml=linkedPart?'<span class="action-link" onclick="window.goToPart('+linkedPart.id+')">'+esc(linkedPart.name)+'</span>':'<span style="color:var(--text3)">â€”</span>';
    const highlight=highlightActionId===a.id?' highlight':'';
    // Created date in "29.12." format
    const createdDate=a.createdAt?formatDateShort(a.createdAt):'â€”';
    // Progress bar calculation
    let progressHtml='<span style="color:var(--text3)">â€”</span>';
    if(a.createdAt&&a.due&&a.status!=='completed'){
      const created=new Date(a.createdAt).getTime();
      const due=new Date(a.due).getTime();
      const now=Date.now();
      const total=due-created;
      const elapsed=now-created;
      const pct=total>0?Math.min(100,Math.max(0,Math.round(elapsed/total*100))):0;
      const barColor=pct>=100?'var(--red)':pct>=80?'var(--orange)':'var(--text3)';
      progressHtml='<div class="action-progress-bar"><div class="action-progress-fill" style="width:'+pct+'%;background:'+barColor+'"></div></div>';
    }else if(a.status==='completed'){
      progressHtml='<div class="action-progress-bar"><div class="action-progress-fill" style="width:100%;background:var(--green)"></div></div>';
    }
    // Due date in "29.12." format
    const dueDate=a.due?formatDateShort(a.due):'â€”';
    return '<div class="action-row action-grid'+highlight+'" data-action-id="'+a.id+'"><div class="action-task'+(a.status==='completed'?' completed':'')+'">'+esc(a.task)+'</div><div>'+linkedHtml+'</div><div style="font-size:11px;color:var(--text3)">'+createdDate+'</div><div>'+progressHtml+'</div><div class="action-due'+dueClass+'">'+dueDate+'</div><div style="font-size:10px;color:var(--text2)">'+(a.assignee||'â€”')+'</div><div class="action-status '+a.status+'">'+ALABELS[a.status]+'</div><div style="display:flex;gap:2px;justify-content:flex-end">'+advBtn+'<button class="adv-btn" onclick="window.editAction('+a.id+',event)">âœŽ</button><button class="adv-btn" onclick="window.delAction('+a.id+',event)">Ã—</button></div></div>';
  }).join('');
  highlightActionId=null;
}

function renderBurndown(){
  const chart=$('burndownChart');
  if(!projectDates.start||!projectDates.end){chart.innerHTML='<div class="burndown-empty" onclick="window.openDates()"><span>ðŸ“…</span><span>Set project dates</span></div>';$('burndownDates').innerHTML='';return}
  const start=new Date(projectDates.start),end=new Date(projectDates.end);
  const totalDays=Math.max(1,(end-start)/86400000);
  const w=500,h=160,pad={top:16,right:16,bottom:24,left:36};
  const chartW=w-pad.left-pad.right,chartH=h-pad.top-pad.bottom;
  const xScale=x=>pad.left+(x/totalDays)*chartW;
  const yScale=y=>pad.top+(1-y/100)*chartH;
  const points=history.filter(pt=>{const d=new Date(pt.date);return d>=start&&d<=end}).map(pt=>{const d=new Date(pt.date),dayNum=(d-start)/86400000;return{x:xScale(dayNum),y:yScale(pt.pct),pct:pt.pct,dayNum}});
  let svg='<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="xMidYMid meet">';
  [0,25,50,75,100].forEach(g=>{const y=yScale(g);svg+='<line x1="'+pad.left+'" y1="'+y+'" x2="'+(w-pad.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="1"/><text x="'+(pad.left-6)+'" y="'+(y+4)+'" fill="var(--text3)" font-size="10" text-anchor="end">'+g+'</text>'});
  svg+='<line x1="'+xScale(0)+'" y1="'+yScale(0)+'" x2="'+xScale(totalDays)+'" y2="'+yScale(100)+'" stroke="var(--text3)" stroke-width="1.5" stroke-dasharray="4,3"/>';
  for(let i=0;i<points.length-1;i++){const p1=points[i],p2=points[i+1];const idealY1=(p1.dayNum/totalDays)*100,idealY2=(p2.dayNum/totalDays)*100;const above1=p1.pct>=idealY1,above2=p2.pct>=idealY2;const col1=above1?'var(--green)':'var(--red)';const col2=above2?'var(--green)':'var(--red)';if(above1===above2){svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/>'}else{const t=(idealY1-p1.pct)/((p2.pct-p1.pct)-(idealY2-idealY1));const ix=p1.x+t*(p2.x-p1.x),iy=p1.y+t*(p2.y-p1.y);svg+='<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+ix+'" y2="'+iy+'" stroke="'+col1+'" stroke-width="2.5" stroke-linecap="round"/><line x1="'+ix+'" y1="'+iy+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="'+col2+'" stroke-width="2.5" stroke-linecap="round"/>'}}
  points.forEach(p=>{const idealY=(p.dayNum/totalDays)*100;svg+='<circle cx="'+p.x+'" cy="'+p.y+'" r="4" fill="'+(p.pct>=idealY?'var(--green)':'var(--red)')+'"/>'});
  svg+='</svg>';chart.innerHTML=svg;
  $('burndownDates').innerHTML='<span>'+formatDateShort(projectDates.start)+'</span><span>'+formatDateShort(projectDates.end)+'</span>';
}

function renderAsm(r){
  const a=r.item,progress=calcAsmProgress(a.id);
  const pColor=progress<20?'var(--red)':progress<40?'var(--orange)':'var(--green)';
  const count=(filterStage||filterAssignee)?r.match+'/'+r.kids:r.kids;
  const priorityBtns='<div class="asm-priority" onclick="event.stopPropagation()"><button class="asm-priority-btn" onclick="window.moveAsmUp('+a.id+')" title="Move up">â–²</button><button class="asm-priority-btn" onclick="window.moveAsmDown('+a.id+')" title="Move down">â–¼</button></div>';
  return '<div class="asm-row" data-asm-id="'+a.id+'" onclick="window.toggleAsmRow(event,'+a.id+')"><span class="asm-toggle">'+(r.exp?'â–¼':'â–¶')+'</span><div></div>'+priorityBtns+'<div><span class="asm-name">'+esc(a.name)+'</span> <span class="asm-meta">('+count+')</span></div><div></div><div></div><div></div><div></div><div></div><div class="asm-progress"><div class="asm-bar"><div class="asm-bar-fill" style="width:'+progress+'%;background:'+pColor+';"></div></div><span class="asm-pct" style="color:'+pColor+'">'+progress+'%</span></div><div class="notes-cell" title="'+(a.notes?esc(a.notes):'')+'">'+(a.notes?esc(a.notes):'â€”')+'</div><div class="asm-actions" onclick="event.stopPropagation()"><button class="sm-btn" onclick="window.editAsm('+a.id+',event)">âœŽ</button></div><div onclick="event.stopPropagation()"><button class="sm-btn red" onclick="window.confirmDelete('+a.id+',\'assembly\',event)">Ã—</button></div></div>';
}

function renderPart(r){
  const p=r.item;
  const partStages=getPartStages(p);
  const si=partStages.indexOf(p.status);
  const next=getNextStage(p);
  const advBtn=!next?'<button class="adv-btn done">âœ“</button>':'<button class="adv-btn" onclick="window.advPart('+p.id+')">â†’</button>';
  const stageDots=partStages.map((s,i)=>'<div class="stage-dot'+(i<si?' done':(i===si?' current':'')+'" title="'+SLABELS[s])+'"></div>').join('');
  
  // Determine indent level
  const depth=r.depth||0;
  const indentSymbol=depth===0?'':'â””';
  const indentStyle=depth>0?'padding-left:'+(depth*12)+'px':'';
  
  // Add sub-part button (only for first level parts under assemblies)
  const addSubBtn=depth===0?'<button class="subpart-add" onclick="event.stopPropagation();window.addSubPart('+p.id+')" title="Add sub-part">+</button>':'';
  
  // ETA and PO handling
  let etaHtml='';
  let etaDate='',etaClass='historical',poHtml='';
  
  // Only show arrival date if not installed
  if(p.status!=='installed'){
    if(p.expectedArrival){
      etaDate=formatDateShort(p.expectedArrival);
      etaClass='user-set';
    }else if(p.status==='ordered'||p.status==='to-order'){
      const eta=getPartETA(p);
      if(eta.type==='predicted'){
        etaDate=eta.display;
        etaClass='historical';
      }else if(eta.type==='manual'){
        etaDate=eta.display;
        etaClass='user-set';
      }else{
        etaDate='?';
        etaClass='historical';
      }
    }else{
      etaDate='?';
      etaClass='historical';
    }
  }
  
  // Always show PO number if exists
  if(p.poNumber){
    poHtml='<span class="eta-po" onclick="window.copyPO(\''+esc(p.poNumber)+'\',event)" title="Click to copy">'+esc(p.poNumber)+'</span>';
  }
  
  if(etaDate||poHtml){
    etaHtml='<div class="eta-cell">'+(etaDate?'<span class="eta-date '+etaClass+'" onclick="window.openEtaModal('+p.id+')" title="Click to edit">'+etaDate+'</span>':'')+(poHtml||'')+'</div>';
  }else{
    etaHtml='<span style="color:var(--text3)">â€”</span>';
  }
  
  const notesHtml=p.notes?'<span class="notes-cell" title="'+esc(p.notes)+'">'+esc(p.notes)+'</span>':'<span style="color:var(--text3)">â€”</span>';
  
  // Comments button
  const commentCount=p.comments?.length||0;
  const commentBtn='<button class="comment-btn'+(commentCount?' has-comments':'')+'" onclick="window.openComments('+p.id+',event)" title="Comments">ðŸ’¬'+(commentCount?'<span class="comment-count">'+commentCount+'</span>':'')+'</button>';
  
  const childClass=r.child?' child'+(depth>0?' subchild':''):'';
  
  return '<div class="part-row parts-grid'+childClass+'" data-part-id="'+p.id+'" style="'+(depth>0?'background:var(--bg);':'')+'"><div class="part-indent" style="'+indentStyle+'">'+indentSymbol+'</div><div>'+addSubBtn+'</div><div class="cell" onclick="window.editCell(event,'+p.id+',\'name\')">'+esc(p.name)+'</div><div class="cell muted" onclick="window.editCellAutocomplete(event,'+p.id+',\'code\')">'+(p.code||'â€”')+'</div><div class="cell muted" onclick="window.editCellAutocomplete(event,'+p.id+',\'mfr\')">'+(p.mfr||'â€”')+'</div><div class="cell muted" onclick="window.editCellAssignee(event,'+p.id+')">'+(p.assignee||'â€”')+'</div><div class="cell muted" onclick="window.editCell(event,'+p.id+',\'qty\')">'+(p.qty||1)+'</div><div><span class="status-badge '+p.status+'">'+SLABELS[p.status]+'</span></div><div class="stage-dots">'+stageDots+'</div><div>'+etaHtml+'</div><div>'+notesHtml+'</div><div>'+advBtn+'</div><div>'+commentBtn+'</div><div><button class="sm-btn" onclick="window.editPart('+p.id+',event)">âœŽ</button></div><div><button class="sm-btn red" onclick="window.confirmDelete('+p.id+',\'part\',event)">Ã—</button></div></div>';
}

function renderGantt(){
  const asms=getAsms();
  if(!asms.length){$('ganttBody').innerHTML='<div style="padding:20px;text-align:center;color:var(--text3)">No assemblies</div>';$('ganttDateRange').textContent='';return}
  const startDate=projectDates.start?new Date(projectDates.start):new Date();
  const endDate=projectDates.end?new Date(projectDates.end):new Date(startDate.getTime()+45*86400000);
  const startStr=startDate.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  const endStr=endDate.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  $('ganttDateRange').innerHTML='<strong>Start:</strong> '+startStr+' &nbsp;â”‚&nbsp; <strong>End:</strong> '+endStr;
  const numWeeks=Math.max(10,Math.ceil((endDate-startDate)/(7*86400000))+2);
  const weeks=[];const baseDate=new Date(startDate);baseDate.setDate(baseDate.getDate()-7);
  const now=new Date(),currentWeekNum=getWeek(now);
  for(let i=0;i<numWeeks;i++){const d=new Date(baseDate);d.setDate(d.getDate()+i*7);const wn=getWeek(d);weeks.push({label:'W'+wn,cur:wn===currentWeekNum,date:d,weekNum:wn})}
  const currentWeekIdx=weeks.findIndex(w=>w.cur);
  const nowLinePos=currentWeekIdx>=0?currentWeekIdx*70+35:null;
  $('ganttHeader').innerHTML=weeks.map(w=>'<div class="gantt-week'+(w.cur?' current':'')+'">'+w.label+'</div>').join('')+(nowLinePos!==null?'<div class="gantt-now-line" style="left:'+nowLinePos+'px"></div>':'');
  const rows=[];
  asms.forEach((asm,ai)=>{
    const kids=data.filter(d=>d.parentId===asm.id);
    const prog=calcAsmProgress(asm.id);
    const asmWeekIdx=Math.min(1+ai%8,weeks.length-1);
    rows.push('<div class="gantt-row asm"><div class="gantt-row-label asm" onclick="window.goToAsm('+asm.id+')"><span class="gantt-row-priority">'+(ai+1)+'</span>'+esc(asm.name)+'</div><div class="gantt-cells">'+weeks.map((w,idx)=>'<div class="gantt-cell">'+(idx===asmWeekIdx?'<div class="gantt-bar asm-bar" onclick="window.goToAsm('+asm.id+')">'+prog+'%</div>':'')+'</div>').join('')+(nowLinePos!==null?'<div class="gantt-now-line" style="left:'+nowLinePos+'px"></div>':'')+'</div></div>');
    if(expanded[asm.id]){
      kids.slice(0,10).forEach((p,pi)=>{
        const pIdx=Math.min(asmWeekIdx+Math.floor(STAGES.indexOf(p.status)/2),weeks.length-1);
        rows.push('<div class="gantt-row"><div class="gantt-row-label child" onclick="window.goToPart('+p.id+')">'+esc(p.name)+'</div><div class="gantt-cells">'+weeks.map((w,idx)=>'<div class="gantt-cell">'+(idx===pIdx?'<div class="gantt-bar '+p.status+'" onclick="window.goToPart('+p.id+')">'+SLABELS[p.status].slice(0,3)+'</div>':'')+'</div>').join('')+(nowLinePos!==null?'<div class="gantt-now-line" style="left:'+nowLinePos+'px"></div>':'')+'</div></div>');
      });
    }
  });
  $('ganttBody').innerHTML=rows.join('');
}

function generateAIInsights(){
  const insights=[],parts=getParts();
  const today=new Date().toISOString().split('T')[0];
  const now=Date.now(),day=86400000;
  const pct=calcOverallProgress(),expected=getExpectedProgress();
  const forecast=getVelocityForecast();
  const overdueActions=actions.filter(a=>a.status!=='completed'&&a.due&&a.due<today);
  if(overdueActions.length>0){insights.push({level:'critical',icon:'âš ',title:overdueActions.length+' overdue action'+(overdueActions.length>1?'s':''),desc:overdueActions.map(a=>a.task).slice(0,2).join(', '),action:'View in Action Plan â†’',handler:()=>{document.querySelector('[data-tab="actions"]').click();hidePopoverModal($('aiModal'))}})}
  if(forecast&&forecast.status==='at-risk'){insights.push({level:'critical',icon:'ðŸ“‰',title:'Completion at risk',desc:'At current rate, finishing '+(forecast.daysToComplete-forecast.daysLeft)+' days late',action:'Review velocity â†’',handler:()=>{document.querySelector('[data-tab="progress"]').click();hidePopoverModal($('aiModal'))}})}
  if(expected!==null&&pct<expected-10){insights.push({level:'critical',icon:'ðŸ“Š',title:'Behind schedule',desc:(expected-pct)+'% behind target progress',action:'Review progress â†’',handler:()=>{document.querySelector('[data-tab="progress"]').click();hidePopoverModal($('aiModal'))}})}
  const stuckParts=parts.filter(p=>p.status==='to-order'&&p.changedAt&&(now-p.changedAt)>5*day);
  if(stuckParts.length>0){insights.push({level:'warning',icon:'â³',title:stuckParts.length+' part'+(stuckParts.length>1?'s':'')+' waiting >5 days',desc:stuckParts.map(p=>p.name).slice(0,2).join(', '),action:'View parts â†’',handler:()=>{filterStage='to-order';render();hidePopoverModal($('aiModal'))}})}
  const longTransit=parts.filter(p=>p.status==='ordered'&&p.changedAt&&(now-p.changedAt)>7*day);
  if(longTransit.length>0){insights.push({level:'warning',icon:'ðŸ“¦',title:longTransit.length+' part'+(longTransit.length>1?'s':'')+' in transit >7d',desc:'Follow up with suppliers',action:'View parts â†’',handler:()=>{filterStage='ordered';render();hidePopoverModal($('aiModal'))}})}
  const missingEta=parts.filter(p=>(p.status==='to-order'||p.status==='ordered')&&getPartETA(p).type==='unknown');
  if(missingEta.length>0){insights.push({level:'warning',icon:'â“',title:missingEta.length+' part'+(missingEta.length>1?'s':'')+' missing ETA',desc:'Add lead time data for planning',action:'Set ETA â†’',handler:()=>{if(missingEta[0])window.openEtaModal(missingEta[0].id);hidePopoverModal($('aiModal'))}})}
  const otd=calcSupplierOTD();
  if(otd!==null&&otd<80){insights.push({level:'warning',icon:'ðŸšš',title:'Supplier OTD: '+otd+'%',desc:'Consider adding buffer to estimates',action:'View lead times â†’',handler:()=>{renderLeadTimeModal();$('leadtimeModal').classList.add('open');hidePopoverModal($('aiModal'))}})}
  if(forecast&&forecast.status==='ahead'){insights.push({level:'success',icon:'ðŸŽ¯',title:'Ahead of schedule',desc:'Est. completion '+(forecast.daysLeft-forecast.daysToComplete)+' days early',action:null,handler:null})}
  const readyToInstall=parts.filter(p=>p.status==='tested');
  if(readyToInstall.length>0){insights.push({level:'info',icon:'âœ“',title:readyToInstall.length+' ready to install',desc:readyToInstall.map(p=>p.name).slice(0,3).join(', '),action:'Install now â†’',handler:()=>{filterStage='tested';render();hidePopoverModal($('aiModal'))}})}
  if(insights.length===0){insights.push({level:'success',icon:'âœ“',title:'All systems nominal',desc:'No issues detected',action:null,handler:null})}
  return insights;
}

function updateAIAlert(){
  // Just generate insights for caching
  window._aiInsights=generateAIInsights();
}

// ============================================
// Event Logging for AI Learning
// ============================================
const eventLogRef=db.ref('analytics/events');

function logEvent(type,eventData){
  const event={
    timestamp:Date.now(),
    type,
    projectName:currentProjectName,
    ...eventData
  };
  eventLogRef.push(event).catch(e=>console.warn('Event log failed:',e));
}

function logArrival(part,daysInTransit,wasLate,daysDelta){
  logEvent('arrival',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    daysInTransit,
    expectedArrival:part.expectedArrival||null,
    wasLate,
    daysDelta,
    assemblyId:part.parentId,
    assemblyName:getAsms().find(a=>a.id===part.parentId)?.name||''
  });
}

function logStuck(part,stage,daysStuck){
  logEvent('stuck',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    stage,
    daysStuck,
    assemblyId:part.parentId
  });
}

function logEtaMiss(part,expectedDate,actualDate,daysDelta){
  logEvent('eta_miss',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    mfr:part.mfr||'',
    expectedDate,
    actualDate,
    daysDelta
  });
}

function logComment(part,text){
  logEvent('comment',{
    partId:part.id,
    partCode:part.code||'',
    partName:part.name,
    assemblyId:part.parentId,
    text:text.slice(0,500),
    partStatus:part.status
  });
}

function logActionOverdue(action,daysOverdue){
  logEvent('action_overdue',{
    actionId:action.id,
    task:action.task,
    assignee:action.assignee||'',
    daysOverdue,
    linkedPartId:action.linkedPartId||null
  });
}

// ============================================
// AI Report Generation (LLM-Powered)
// ============================================
let currentAIMode='quick';
let aiCache={quick:null,standup:null,risks:null};
let aiCacheTime={quick:0,standup:0,risks:0};
const AI_CACHE_TTL=60000; // 1 minute cache
let aiConversation=[];

function buildProjectContext(){
  const parts=getParts();
  const asms=getAsms();
  const today=new Date().toISOString().split('T')[0];
  const now=Date.now(),day=86400000;
  
  // Status breakdown
  const byStatus={};
  STAGES.forEach(s=>byStatus[s]=parts.filter(p=>p.status===s).length);
  
  // Stuck parts (>5 days in same status) with notes
  const stuck=parts.filter(p=>p.changedAt&&(now-p.changedAt)>5*day).map(p=>{
    const asm=asms.find(a=>a.id===p.parentId);
    return {
      id:p.id,
      name:p.name,
      code:p.code||'',
      mfr:p.mfr||'',
      status:p.status,
      days:Math.floor((now-p.changedAt)/day),
      assembly:asm?.name||'',
      notes:p.notes||'',
      lastComment:p.comments?.length?p.comments[p.comments.length-1].text:''
    };
  }).sort((a,b)=>b.days-a.days);
  
  // All actions with details
  const allActions=actions.map(a=>({
    task:a.task,
    status:a.status,
    due:a.due,
    assignee:a.assignee||'Unassigned',
    isOverdue:a.status!=='completed'&&a.due&&a.due<today,
    daysOverdue:a.due&&a.due<today?Math.floor((new Date(today)-new Date(a.due))/day):0,
    linkedPartId:a.linkedPartId
  }));
  
  // Overdue actions
  const overdue=allActions.filter(a=>a.isOverdue);
  
  // Upcoming actions (next 7 days)
  const nextWeek=new Date(now+7*day).toISOString().split('T')[0];
  const upcoming=allActions.filter(a=>a.status!=='completed'&&a.due&&a.due>=today&&a.due<=nextWeek);
  
  // Parts with notes or comments
  const partsWithNotes=parts.filter(p=>p.notes||p.comments?.length).map(p=>{
    const asm=asms.find(a=>a.id===p.parentId);
    return {
      id:p.id,
      name:p.name,
      status:p.status,
      assembly:asm?.name||'',
      notes:p.notes||'',
      comments:p.comments?.map(c=>c.text)||[]
    };
  });
  
  // Supplier stats from lead time DB
  const suppliers=[];
  const mfrStats={};
  parts.filter(p=>p.mfr).forEach(p=>{
    if(!mfrStats[p.mfr])mfrStats[p.mfr]={total:0,ordered:0,arrived:0};
    mfrStats[p.mfr].total++;
    if(p.status==='ordered')mfrStats[p.mfr].ordered++;
    if(['arrived','tested','configured','installed'].includes(p.status))mfrStats[p.mfr].arrived++;
  });
  Object.keys(mfrStats).forEach(mfr=>{
    const lt=Object.keys(leadTimeDb).filter(c=>parts.find(p=>p.code===c&&p.mfr===mfr)).map(c=>leadTimeDb[c]);
    const avgLead=lt.length?Math.round(lt.reduce((s,l)=>s+l.avg,0)/lt.length):null;
    suppliers.push({mfr,count:mfrStats[mfr].total,inTransit:mfrStats[mfr].ordered,avgLead});
  });
  
  // Recent comments (last 7 days)
  const recentComments=[];
  parts.forEach(p=>{
    if(p.comments){
      p.comments.filter(c=>(now-(c.ts||c.timestamp))<7*day).forEach(c=>{
        recentComments.push({partName:p.name,partId:p.id,text:c.text,date:new Date(c.ts||c.timestamp).toLocaleDateString()});
      });
    }
  });
  
  // Assembly progress with details
  const asmProgress=asms.map(a=>{
    const asmParts=parts.filter(p=>p.parentId===a.id);
    const installed=asmParts.filter(p=>p.status==='installed').length;
    return {
      id:a.id,
      name:a.name,
      progress:calcAsmProgress(a.id),
      total:asmParts.length,
      installed,
      stuck:asmParts.filter(p=>p.changedAt&&(now-p.changedAt)>5*day).length
    };
  }).sort((a,b)=>a.progress-b.progress);
  
  // Critical path - lowest progress assemblies blocking completion
  const criticalPath=asmProgress.filter(a=>a.progress<50).slice(0,3);
  
  // Calculate math
  const totalParts=parts.length;
  const installedParts=byStatus.installed||0;
  const remainingParts=totalParts-installedParts;
  const velocity=getVelocity();
  const daysLeft=getDaysRemaining();
  const daysNeeded=velocity&&velocity>0?Math.ceil(remainingParts/velocity):null;
  const buffer=daysLeft&&daysNeeded?(daysLeft-daysNeeded):null;
  
  return {
    project:{
      name:currentProjectName,
      progress:calcOverallProgress(),
      velocity,
      daysLeft,
      daysNeeded,
      buffer,
      startDate:projectDates.start,
      endDate:projectDates.end
    },
    counts:{
      total:totalParts,
      remaining:remainingParts,
      assemblies:asms.length,
      ...byStatus
    },
    stuck:stuck.slice(0,20),
    overdue,
    upcoming,
    allActions:allActions.slice(0,15),
    partsWithNotes:partsWithNotes.slice(0,15),
    suppliers:suppliers.filter(s=>s.count>=2).slice(0,10),
    recentComments:recentComments.slice(0,15),
    asmProgress:asmProgress.slice(0,10),
    criticalPath,
    forecast:getVelocityForecast()
  };
}

function getDaysRemaining(){
  if(!projectDates.end)return null;
  const end=new Date(projectDates.end);
  const now=new Date();
  return Math.max(0,Math.ceil((end-now)/(86400000)));
}

function getVelocity(){
  if(history.length<2)return null;
  const recent=history.slice(-7);
  if(recent.length<2)return null;
  const days=Math.max(1,(new Date(recent[recent.length-1].date)-new Date(recent[0].date))/(86400000));
  const progress=recent[recent.length-1].pct-recent[0].pct;
  const partsPerDay=(progress/100)*getParts().length/days;
  return Math.round(partsPerDay*10)/10;
}

async function generateAIReport(mode,question){
  const context=buildProjectContext();
  
  // Quick mode uses local generation (instant, no API call)
  if(mode==='quick'){
    $('aiModelBadge').textContent='';
    return generateLocalReport(mode,context);
  }
  
  // AI modes use Claude via Cloud Function
  try{
    console.log('Calling Cloud Function for mode:',mode);
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const payload={mode,projectContext:context};
    if(question)payload.question=question;
    
    const result=await generateInsights(payload);
    console.log('Cloud Function response:',result.data);
    
    if(result.data?.success){
      $('aiModelBadge').textContent='haiku-4.5';
      return formatClaudeResponse(result.data.content,mode);
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Cloud function failed:',e);
    $('aiModelBadge').textContent='offline';
    return '<div class="ai-prose"><p>Unable to connect to AI service. Please try again.</p></div>';
  }
}

function formatClaudeResponse(text,mode){
  let html=text;
  
  // Escape HTML first
  html=esc(html);
  
  // Replace [[Part Name]] with clickable links
  html=html.replace(/\[\[([^\]]+)\]\]/g,(match,partName)=>{
    const part=getParts().find(p=>p.name.toLowerCase()===partName.toLowerCase());
    if(part){
      return '<a class="ai-part-link" href="#" onclick="window.aiGoToPart('+part.id+');return false;">'+partName+'</a>';
    }
    return partName;
  });
  
  // Replace {{Assembly Name}} with clickable links  
  html=html.replace(/\{\{([^\}]+)\}\}/g,(match,asmName)=>{
    const asm=getAsms().find(a=>a.name.toLowerCase()===asmName.toLowerCase());
    if(asm){
      return '<a class="ai-asm-link" href="#" onclick="window.aiGoToAsm('+asm.id+');return false;">'+asmName+'</a>';
    }
    return asmName;
  });
  
  // Split into paragraphs - try double newlines first, then single
  let paragraphs=html.split(/\n\n+/).filter(p=>p.trim());
  if(paragraphs.length===1){
    // No double newlines - split on sentence boundaries after 2+ sentences
    const text=paragraphs[0];
    const sentences=text.split(/(?<=[.!?])\s+(?=[A-Z])/);
    if(sentences.length>3){
      paragraphs=[];
      for(let i=0;i<sentences.length;i+=3){
        paragraphs.push(sentences.slice(i,i+3).join(' '));
      }
    }
  }
  
  html='<div class="ai-prose">'+paragraphs.map(p=>'<p>'+p.replace(/\n/g,' ').trim()+'</p>').join('')+'</div>';
  
  return html;
}

// Navigation functions for AI links
window.aiGoToPart=function(partId){
  hidePopoverModal($('aiModal'));
  const part=data.find(d=>d.id===partId);
  if(part&&part.parentId){
    expanded[part.parentId]=true;
  }
  render();
  setTimeout(()=>{
    const row=document.querySelector('[data-id="'+partId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.style.background='rgba(99,102,241,0.2)';
      setTimeout(()=>row.style.background='',2000);
    }
  },100);
};

window.aiGoToAsm=function(asmId){
  hidePopoverModal($('aiModal'));
  expanded[asmId]=true;
  render();
  setTimeout(()=>{
    const row=document.querySelector('[data-id="'+asmId+'"]');
    if(row){
      row.scrollIntoView({behavior:'smooth',block:'center'});
      row.style.background='rgba(99,102,241,0.2)';
      setTimeout(()=>row.style.background='',2000);
    }
  },100);
};

async function askAI(question){
  const context=buildProjectContext();
  
  try{
    $('aiModelBadge').textContent='thinking...';
    const generateInsights=firebase.functions().httpsCallable('generateInsights');
    const result=await generateInsights({mode:'ask',projectContext:context,question});
    
    if(result.data?.success){
      $('aiModelBadge').textContent='haiku-4.5';
      return formatClaudeResponse(result.data.content,'ask');
    }else{
      throw new Error('No response');
    }
  }catch(e){
    console.error('Ask failed:',e);
    $('aiModelBadge').textContent='offline';
    return '<div class="ai-prose"><p>Unable to get response. Please try again.</p></div>';
  }
}

function generateLocalReport(mode,ctx){
  const today=new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric',year:'numeric'});
  
  if(mode==='quick'){
    return renderQuickInsights();
  }
  
  if(mode==='standup'){
    let html='<div class="ai-summary"><strong>'+ctx.project.name+'</strong><br>'+today+'<br><br>';
    html+='<strong>'+ctx.project.progress+'%</strong> complete';
    if(ctx.project.daysLeft!==null)html+=' Â· <strong>'+ctx.project.daysLeft+'</strong> days left';
    if(ctx.project.velocity)html+=' Â· <strong>'+ctx.project.velocity+'</strong> parts/day';
    html+='</div>';
    
    // Blockers
    if(ctx.overdue.length||ctx.stuck.filter(s=>s.status==='to-order').length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ”´</span> Blockers</div><div class="ai-report-items">';
      ctx.overdue.forEach(a=>{
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(a.task)+'</strong><div class="ai-report-meta">'+a.daysOverdue+' day'+(a.daysOverdue!==1?'s':'')+' overdue Â· '+esc(a.assignee)+'</div></div></div>';
      });
      ctx.stuck.filter(s=>s.status==='to-order').slice(0,3).forEach(p=>{
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(p.name)+'</strong> waiting to order<div class="ai-report-meta">'+p.days+' days Â· '+(p.mfr||'No supplier')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Needs Attention
    const arrivedCount=ctx.counts.arrived||0;
    const inTransit=ctx.stuck.filter(s=>s.status==='ordered');
    if(arrivedCount||inTransit.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸŸ¡</span> Needs Attention</div><div class="ai-report-items">';
      if(arrivedCount){
        html+='<div class="ai-report-item warning"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+arrivedCount+' part'+(arrivedCount!==1?'s':'')+' arrived</strong> - awaiting next step</div></div>';
      }
      inTransit.slice(0,3).forEach(p=>{
        html+='<div class="ai-report-item warning"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(p.name)+'</strong> in transit '+p.days+' days<div class="ai-report-meta">'+(p.mfr||'Unknown supplier')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Due Soon
    if(ctx.upcoming.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ“‹</span> Due This Week</div><div class="ai-report-items">';
      ctx.upcoming.slice(0,5).forEach(a=>{
        const dueDate=new Date(a.due).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text">'+esc(a.task)+'<div class="ai-report-meta">'+dueDate+' Â· '+esc(a.assignee)+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Focus
    html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸŽ¯</span> Focus Today</div><div class="ai-report-items">';
    const focuses=[];
    if(ctx.overdue.length)focuses.push('Clear '+ctx.overdue.length+' overdue action'+(ctx.overdue.length!==1?'s':''));
    if(arrivedCount>=3)focuses.push('Process '+arrivedCount+' arrived parts');
    if(ctx.stuck.filter(s=>s.status==='to-order').length>=3)focuses.push('Place orders for stuck parts');
    if(inTransit.length)focuses.push('Follow up on long-transit items');
    if(!focuses.length)focuses.push('Continue steady progress');
    focuses.slice(0,3).forEach((f,i)=>{
      html+='<div class="ai-report-item success"><span class="ai-report-bullet">'+(i+1)+'.</span><div class="ai-report-text">'+f+'</div></div>';
    });
    html+='</div></div>';
    
    return html;
  }
  
  if(mode==='risks'){
    let html='<div class="ai-summary"><strong>Risk Analysis</strong><br>'+ctx.project.name+'<br>'+today+'</div>';
    
    // Schedule Risk
    const forecast=ctx.forecast;
    if(forecast){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ“Š</span> Schedule Risk</div><div class="ai-report-items">';
      if(forecast.status==='at-risk'){
        html+='<div class="ai-report-item critical"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>Behind Schedule</strong><div class="ai-report-meta">At current velocity, completion '+(forecast.daysToComplete-forecast.daysLeft)+' days late</div></div></div>';
      }else if(forecast.status==='ahead'){
        html+='<div class="ai-report-item success"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>Ahead of Schedule</strong><div class="ai-report-meta">Est. completion '+(forecast.daysLeft-forecast.daysToComplete)+' days early</div></div></div>';
      }else{
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>On Track</strong><div class="ai-report-meta">Current velocity matches target</div></div></div>';
      }
      html+='</div></div>';
    }
    
    // Supplier Risks
    const riskySuppliers=ctx.suppliers.filter(s=>s.inTransit>=2);
    if(riskySuppliers.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸšš</span> Supplier Exposure</div><div class="ai-report-items">';
      riskySuppliers.forEach(s=>{
        const level=s.inTransit>=4?'critical':s.inTransit>=2?'warning':'info';
        html+='<div class="ai-report-item '+level+'"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(s.mfr)+'</strong><div class="ai-report-meta">'+s.inTransit+' parts in transit'+(s.avgLead?' Â· avg '+s.avgLead+'d lead time':'')+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Assembly Risks (lowest progress)
    const atRiskAsms=ctx.asmProgress.filter(a=>a.progress<40);
    if(atRiskAsms.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">âš ï¸</span> Assemblies Behind</div><div class="ai-report-items">';
      atRiskAsms.slice(0,5).forEach(a=>{
        const level=a.progress<20?'critical':a.progress<40?'warning':'info';
        html+='<div class="ai-report-item '+level+'"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text"><strong>'+esc(a.name)+'</strong><div class="ai-report-meta">'+a.progress+'% complete Â· '+a.parts+' parts</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Recent Comments (may indicate issues)
    if(ctx.recentComments.length){
      html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ’¬</span> Recent Notes</div><div class="ai-report-items">';
      ctx.recentComments.slice(0,5).forEach(c=>{
        html+='<div class="ai-report-item info"><span class="ai-report-bullet">â€¢</span><div class="ai-report-text">"'+esc(c.text.slice(0,100))+(c.text.length>100?'...':'')+'"<div class="ai-report-meta">'+esc(c.partName)+' Â· '+c.date+'</div></div></div>';
      });
      html+='</div></div>';
    }
    
    // Mitigations
    html+='<div class="ai-report-section"><div class="ai-report-header"><span class="ai-report-header-icon">ðŸ›¡ï¸</span> Recommended Actions</div><div class="ai-report-items">';
    const mitigations=[];
    if(ctx.overdue.length)mitigations.push('Clear overdue actions to unblock progress');
    if(riskySuppliers.length)mitigations.push('Contact '+riskySuppliers[0].mfr+' for delivery status');
    if(atRiskAsms.length)mitigations.push('Prioritize '+atRiskAsms[0].name+' assembly');
    if(ctx.counts['to-order']>10)mitigations.push('Reduce ordering backlog ('+ctx.counts['to-order']+' pending)');
    if(!mitigations.length)mitigations.push('Continue monitoring - no critical actions needed');
    mitigations.slice(0,4).forEach((m,i)=>{
      html+='<div class="ai-report-item success"><span class="ai-report-bullet">'+(i+1)+'.</span><div class="ai-report-text">'+m+'</div></div>';
    });
    html+='</div></div>';
    
    return html;
  }
  
  return '<div class="ai-error"><div class="ai-error-icon">â“</div><div class="ai-error-msg">Unknown report mode</div></div>';
}

function renderQuickInsights(){
  const insights=window._aiInsights||generateAIInsights();
  return insights.map((ins,i)=>'<div class="ai-insight '+ins.level+'" data-idx="'+i+'"><div class="ai-insight-icon">'+ins.icon+'</div><div class="ai-insight-content"><div class="ai-insight-title">'+ins.title+'</div><div class="ai-insight-desc">'+ins.desc+'</div>'+(ins.action?'<div class="ai-insight-action">'+ins.action+'</div>':'')+'</div></div>').join('');
}

function openAIModal(){
  showPopoverModal($('aiModal'),$('aiAlert'));
  if(aiConversation.length===0){
    $('aiContent').innerHTML='<div class="ai-welcome"><p>Ask any question about your project, or click <strong>Tell me</strong> for a status briefing.</p></div>';
    $('aiModelBadge').textContent='';
  }else{
    renderConversation();
  }
  $('aiQuestion').focus();
}

function renderConversation(){
  let html='<div class="ai-conversation">';
  aiConversation.forEach(msg=>{
    if(msg.role==='user'){
      html+='<div class="ai-message user"><span class="ai-user-label">You:</span> '+msg.content+'</div>';
    }else{
      html+='<div class="ai-message assistant">'+msg.content+'</div>';
    }
  });
  html+='</div>';
  $('aiContent').innerHTML=html;
  // Scroll to bottom
  const content=$('aiContent');
  content.scrollTop=content.scrollHeight;
}

async function handleAskSubmit(){
  const input=$('aiQuestion');
  const question=input.value.trim();
  if(!question)return;
  
  // Add user message
  aiConversation.push({role:'user',content:esc(question)});
  renderConversation();
  input.value='';
  
  // Add loading indicator
  aiConversation.push({role:'assistant',content:'<span class="ai-loading-text">Thinking...</span>'});
  renderConversation();
  
  // Get AI response
  const response=await askAI(question);
  
  // Replace loading with actual response - preserve paragraph breaks
  aiConversation[aiConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'').replace(/<\/p>\s*<p>/g,'</p><p>');
  renderConversation();
}

async function handleStraight(){
  // Add system indicator
  aiConversation.push({role:'user',content:'Tell me'});
  renderConversation();
  
  // Add loading indicator
  aiConversation.push({role:'assistant',content:'<span class="ai-loading-text">Analyzing...</span>'});
  renderConversation();
  
  // Get AI response
  const response=await generateAIReport('straight');
  
  // Replace loading with actual response - preserve paragraph breaks
  aiConversation[aiConversation.length-1].content=response.replace(/<div class="ai-prose">/g,'').replace(/<\/div>/g,'').replace(/<\/p>\s*<p>/g,'</p><p>');
  renderConversation();
}

function bindQuickInsightHandlers(){
  const insights=window._aiInsights||[];
  document.querySelectorAll('.ai-insight').forEach(el=>{
    const idx=parseInt(el.dataset.idx);
    const ins=insights[idx];
    if(ins&&ins.handler)el.onclick=ins.handler;
  });
}

function renderLeadTimeModal(){const codes=Object.keys(leadTimeDb).sort();if(!codes.length){$('ltBody').innerHTML='<p style="color:var(--text3);text-align:center;padding:20px">No lead time data yet.</p>';return}$('ltBody').innerHTML=codes.map(code=>{const lt=leadTimeDb[code];return'<div class="lt-item"><div class="lt-code">'+esc(code)+'</div><div class="lt-stats"><span class="lt-stat-val">'+lt.avg+'d</span><span style="color:var(--text2);margin-left:8px">avg lead time</span><span class="lt-samples" style="margin-left:auto">'+lt.samples.length+' sample'+(lt.samples.length!==1?'s':'')+'</span></div></div>'}).join('')}

function openEtaModal(partId){const part=data.find(d=>d.id===partId);if(!part)return;editEtaPartId=partId;$('etaPartName').textContent=part.name;$('etaCode').textContent=part.code?'Item Code: '+part.code:'No item code set';const lt=getLeadTimeHistory(part.code);let histHtml='<div class="eta-history-title">Historical Data</div>';if(lt&&lt.samples.length){histHtml+=lt.samples.slice(-5).reverse().map(s=>'<div class="eta-history-item"><span>'+s.date+'</span><span>'+s.days+' days</span></div>').join('');histHtml+='<div class="eta-avg"><span class="eta-avg-label">Average</span><span class="eta-avg-val">'+lt.avg+'d</span></div>'}else{histHtml+='<div class="eta-history-empty">No historical data</div>'}$('etaHistory').innerHTML=histHtml;$('etaDateInput').value=part.expectedArrival||'';$('etaModal').classList.add('open')}
window.openEtaModal=openEtaModal;

function updateSelects(){const opts='<option value="">â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');$('pmAssignee').innerHTML=opts;$('amAssignee').innerHTML=opts;$('actAssignee').innerHTML=opts;$('assigneeFilter').innerHTML='<option value="">All</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');$('actionAssigneeFilter').innerHTML='<option value="">All Assignees</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');$('actLinkedPart').innerHTML='<option value="">â€” None â€”</option>'+getParts().map(p=>'<option value="'+p.id+'">'+esc(p.name)+'</option>').join('')}
function updateExpandToggle(){const btn=$('expandToggle');const asms=getAsms();const expandedCount=asms.filter(a=>expanded[a.id]).length;allExpanded=expandedCount>asms.length/2;btn.innerHTML=allExpanded?'<span class="arrow">â–²</span> Collapse':'<span class="arrow">â–¼</span> Expand';btn.classList.toggle('expanded',allExpanded)}

function renderTeamList(){$('teamList').innerHTML=!team.length?'<p style="color:var(--text3);text-align:center;padding:12px;font-size:10px">No team members</p>':team.map((t,i)=>'<div class="team-item"><div class="team-item-info"><div style="font-weight:600">'+esc(t.name)+'</div><div style="font-size:10px;color:var(--text3)">'+esc(t.email)+'</div></div><button class="team-item-del" onclick="window.delTeam('+i+',event)">Ã—</button></div>').join('')}
function renderBomList(){if(!savedBoms.length){$('bomList').innerHTML='<p style="color:var(--text3);text-align:center;padding:20px">No saved specifications</p>';return}$('bomList').innerHTML=savedBoms.map(b=>'<div class="bom-item" onclick="window.loadBom('+b.id+')"><div class="bom-item-info"><div class="bom-item-name">'+esc(b.name)+'</div><div class="bom-item-meta">'+b.items.filter(i=>i.isAsm).length+' asm, '+b.items.filter(i=>!i.isAsm).length+' parts</div></div><button class="bom-item-del" onclick="event.stopPropagation();window.delBom('+b.id+',event)">Ã—</button></div>').join('')}

window.toggleAsmRow=function(e,id){if(e.target.closest('.asm-actions')||e.target.closest('.cell')||e.target.closest('.asm-priority'))return;expanded[id]=!expanded[id];saveExpanded();render()};
window.moveAsmUp=function(id){
  const asms=getAsms();
  const idx=asms.findIndex(a=>a.id===id);
  if(idx<=0)return;
  const current=asms[idx],prev=asms[idx-1];
  const tempPriority=current.priority;
  current.priority=prev.priority;
  prev.priority=tempPriority;
  save();render();
};
window.moveAsmDown=function(id){
  const asms=getAsms();
  const idx=asms.findIndex(a=>a.id===id);
  if(idx<0||idx>=asms.length-1)return;
  const current=asms[idx],next=asms[idx+1];
  const tempPriority=current.priority;
  current.priority=next.priority;
  next.priority=tempPriority;
  save();render();
};
window.addNewAsm=function(){const id=Date.now(),asms=getAsms();const maxP=asms.length?Math.max(...asms.map(a=>a.priority||0)):0;data.push({id,name:'New Assembly',isAsm:true,assignee:'',priority:maxP+1});expanded[id]=true;save();render();setTimeout(()=>{editAsmId=id;$('amTitle').textContent='Edit Assembly';$('amName').value='New Assembly';$('amAssignee').value='';$('amNotes').value='';$('amNotify').disabled=true;showPopoverModal($('asmModal'),null);$('amName').select()},50)};
window.addNewPart=function(parentId){const id=Date.now();data.push({id,name:'New Part',code:'',mfr:'',qty:1,assignee:'',parentId,status:'to-order',changedAt:id});save();render();highlightPartId=id;setTimeout(()=>{const row=document.querySelector('[data-part-id="'+id+'"] .cell');if(row)row.click()},50)};
window.addSubPart=function(parentPartId){const parentPart=data.find(d=>d.id===parentPartId);if(!parentPart)return;const id=Date.now();data.push({id,name:'New Sub-Part',code:'',mfr:'',qty:1,assignee:parentPart.assignee||'',parentId:parentPartId,status:'to-order',changedAt:id});save();render();highlightPartId=id;setTimeout(()=>{const row=document.querySelector('[data-part-id="'+id+'"] .cell');if(row)row.click()},50)};

window.editCell=function(e,id,field){e.stopPropagation();const cell=e.currentTarget;if(cell.classList.contains('editing'))return;const item=data.find(d=>d.id===id);if(!item)return;const currentValue=item[field]||'';cell.classList.add('editing');const inputType=field==='qty'?'number':'text';cell.innerHTML='<input type="'+inputType+'" value="'+esc(currentValue)+'" '+(field==='qty'?'min="1"':'')+'>';const input=cell.querySelector('input');input.focus();input.select();const saveValue=()=>{const newValue=field==='qty'?parseInt(input.value)||1:input.value.trim();item[field]=newValue;save();render()};input.onblur=saveValue;input.onkeydown=ev=>{if(ev.key==='Enter'){ev.preventDefault();saveValue()}if(ev.key==='Escape')render()}};

window.editCellAutocomplete=function(e,id,field){
  e.stopPropagation();
  const cell=e.currentTarget;
  if(cell.classList.contains('editing'))return;
  const item=data.find(d=>d.id===id);
  if(!item)return;
  const currentValue=item[field]||'';
  const suggestions=field==='code'?getAllCodes():getAllMfrs();
  
  cell.classList.add('editing');
  cell.innerHTML='<div class="autocomplete-wrapper"><input type="text" value="'+esc(currentValue)+'" placeholder="Type to search..."><div class="autocomplete-list"></div></div>';
  const wrapper=cell.querySelector('.autocomplete-wrapper');
  const input=cell.querySelector('input');
  const list=cell.querySelector('.autocomplete-list');
  let selectedIdx=-1;
  
  function positionList(){
    const rect=wrapper.getBoundingClientRect();
    list.style.top=(rect.bottom+2)+'px';
    list.style.left=rect.left+'px';
    list.style.width=Math.max(rect.width,180)+'px';
  }
  
  function filterSuggestions(val){
    if(!val||!val.trim())return suggestions.slice(0,10);
    const v=val.toLowerCase();
    return suggestions.filter(s=>s.toLowerCase().includes(v)).slice(0,10);
  }
  
  function renderList(filtered,val){
    if(!filtered.length){list.classList.remove('open');list.innerHTML='';return}
    list.innerHTML=filtered.map((s,i)=>{
      let highlighted=esc(s);
      if(val&&val.trim()){
        const idx=s.toLowerCase().indexOf(val.toLowerCase());
        if(idx>=0)highlighted=esc(s.substring(0,idx))+'<em>'+esc(s.substring(idx,idx+val.length))+'</em>'+esc(s.substring(idx+val.length));
      }
      return '<div class="autocomplete-item'+(i===selectedIdx?' selected':'')+'" data-val="'+esc(s)+'">'+highlighted+'</div>';
    }).join('');
    positionList();
    list.classList.add('open');
    list.querySelectorAll('.autocomplete-item').forEach((el,i)=>{
      el.onmousedown=ev=>{ev.preventDefault();ev.stopPropagation();input.value=el.dataset.val;saveValue()};
    });
  }
  
  input.focus();input.select();
  
  // Find existing part with same code to auto-fill name and mfr
  function findMatchingPart(code){
    if(!code)return null;
    return data.find(d=>!d.isAsm&&d.id!==id&&d.code&&d.code.toLowerCase()===code.toLowerCase());
  }
  
  const saveValue=()=>{
    list.classList.remove('open');
    const newValue=input.value.trim();
    item[field]=newValue;
    if(newValue){
      if(field==='code'){
        addGlobalCode(newValue);
        // Auto-fill name and mfr from existing part with same code
        const match=findMatchingPart(newValue);
        if(match){
          if(match.name&&(!item.name||item.name==='New Part'))item.name=match.name;
          if(match.mfr&&!item.mfr)item.mfr=match.mfr;
        }
      }else if(field==='mfr'){
        addGlobalMfr(newValue);
      }
    }
    save();render();
  };
  
  input.oninput=()=>{selectedIdx=-1;renderList(filterSuggestions(input.value),input.value)};
  input.onfocus=()=>{renderList(filterSuggestions(input.value),input.value)};
  input.onblur=()=>setTimeout(saveValue,200);
  input.onkeydown=ev=>{
    const filtered=filterSuggestions(input.value);
    if(ev.key==='ArrowDown'){ev.preventDefault();selectedIdx=Math.min(selectedIdx+1,filtered.length-1);renderList(filtered,input.value)}
    else if(ev.key==='ArrowUp'){ev.preventDefault();selectedIdx=Math.max(selectedIdx-1,-1);renderList(filtered,input.value)}
    else if(ev.key==='Enter'){ev.preventDefault();if(selectedIdx>=0&&filtered[selectedIdx])input.value=filtered[selectedIdx];saveValue()}
    else if(ev.key==='Escape')render();
    else if(ev.key==='Tab'&&selectedIdx>=0&&filtered[selectedIdx]){input.value=filtered[selectedIdx]}
  };
  // Show suggestions immediately on open
  setTimeout(()=>renderList(filterSuggestions(currentValue),currentValue),50);
};

window.editCellAssignee=function(e,id){e.stopPropagation();const cell=e.currentTarget;if(cell.classList.contains('editing'))return;const item=data.find(d=>d.id===id);if(!item)return;cell.classList.add('editing');const opts='<option value="">â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(t.name===item.assignee?' selected':'')+'>'+esc(t.name)+'</option>').join('');cell.innerHTML='<select>'+opts+'</select>';const select=cell.querySelector('select');select.focus();const saveValue=()=>{item.assignee=select.value;save();render()};select.onblur=saveValue;select.onchange=saveValue;select.onkeydown=ev=>{if(ev.key==='Escape')render()}};

function generateReport(){
  const today=new Date();const dateStr=today.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const parts=getParts(),asms=getAsms();
  const pct=calcOverallProgress(),expected=getExpectedProgress(),daysLeft=getDaysLeft();
  const toOrder=parts.filter(p=>p.status==='to-order');
  const ordered=parts.filter(p=>p.status==='ordered');
  const installed=parts.filter(p=>p.status==='installed');
  const overdueActions=actions.filter(a=>a.status!=='completed'&&a.due&&a.due<today.toISOString().split('T')[0]);
  const forecast=getVelocityForecast();const otd=calcSupplierOTD();

  let status='ðŸŸ¢ ON TRACK',statusDetail='Project progressing as planned.';
  if(expected&&pct<expected-10){status='ðŸ”´ BEHIND SCHEDULE';statusDetail='Project is '+(expected-pct)+'% behind expected progress.'}
  else if(expected&&pct>=expected+5){status='ðŸŸ¢ AHEAD OF SCHEDULE';statusDetail='Project is '+(pct-expected)+'% ahead of target.'}

  let report=currentProjectName.toUpperCase()+'\nPROJECT STATUS REPORT\n'+'â•'.repeat(52)+'\n'+dateStr+'\n\nEXECUTIVE SUMMARY\n'+'â”€'.repeat(36)+'\nStatus: '+status+'\n'+statusDetail+'\n\nPROGRESS METRICS\n'+'â”€'.repeat(36)+'\nOverall Completion: '+pct+'%\n  â””â”€ '+installed.length+' of '+parts.length+' parts installed\n\n';
  if(expected!==null)report+='Expected Progress: '+expected+'%\nVariance: '+(pct>=expected?'+':'')+(pct-expected)+'%\n';
  if(daysLeft!==null)report+='Days Remaining: '+daysLeft+'\n';
  report+='\nVELOCITY FORECAST\n'+'â”€'.repeat(36)+'\n';
  if(forecast&&forecast.rate>0)report+='Current Rate: '+forecast.rate.toFixed(1)+'% per day\nEst. Completion: '+formatDateShort(forecast.estDate)+'\nDays Required: '+forecast.daysToComplete+'\n'+(daysLeft!==null?'Buffer: '+(forecast.daysToComplete<=daysLeft?'+':'')+(daysLeft-forecast.daysToComplete)+' days\n':'')+'\nStatus: '+(forecast.status==='ahead'?'âœ“ Ahead of schedule':forecast.status==='on-track'?'âœ“ On track':forecast.status==='behind'?'âš  Slightly behind':'âš  At risk')+'\n';
  else report+='Insufficient data for velocity forecast\n';
  report+='\nSUPPLIER PERFORMANCE\n'+'â”€'.repeat(36)+'\nOn-Time Delivery: '+(otd!==null?otd+'%':'No data yet')+'\nAverage Lead Time: '+(calcAvgLeadTime()||'â€”')+' days\n';
  report+='\nASSEMBLY STATUS\n'+'â”€'.repeat(36)+'\n'+asms.map(a=>{const prog=calcAsmProgress(a.id);const statusIcon=prog===100?'âœ“':prog>=50?'â—':'â—‹';return statusIcon+' '+a.name.substring(0,30).padEnd(30)+' '+String(prog).padStart(3)+'%'}).join('\n')+'\n';
  if(toOrder.length)report+='\nâš  AWAITING ORDER ('+toOrder.length+')\n'+'â”€'.repeat(36)+'\n'+toOrder.slice(0,8).map(p=>'  â€¢ '+p.name+(p.code?' ['+p.code+']':'')).join('\n')+(toOrder.length>8?'\n  ... and '+(toOrder.length-8)+' more':'')+'\n';
  if(ordered.length)report+='\nðŸ“¦ IN TRANSIT ('+ordered.length+')\n'+'â”€'.repeat(36)+'\n'+ordered.slice(0,8).map(p=>{const eta=getPartETA(p);return'  â€¢ '+p.name+' â€” ETA: '+eta.display}).join('\n')+(ordered.length>8?'\n  ... and '+(ordered.length-8)+' more':'')+'\n';
  if(overdueActions.length)report+='\nðŸš¨ OVERDUE ACTIONS ('+overdueActions.length+')\n'+'â”€'.repeat(36)+'\n'+overdueActions.map(a=>'  â€¢ '+a.task+'\n    Due: '+a.due+' | '+(a.assignee||'Unassigned')).join('\n')+'\n';
  report+='\n'+'â•'.repeat(52)+'\nGenerated: '+new Date().toLocaleString();
  return report;
}


window.loadBom=function(bomId){const bom=savedBoms.find(b=>b.id===bomId);if(!bom)return;if(!confirm('Load "'+bom.name+'"?'))return;currentProjectName=bom.name;data=[];expanded={};history=[];let id=1;const asmMap={};bom.items.filter(i=>i.isAsm).forEach((item,idx)=>{const asmId=id++;asmMap[item.name]=asmId;data.push({id:asmId,name:item.name,isAsm:true,assignee:'',priority:idx+1});expanded[asmId]=true});bom.items.filter(i=>!i.isAsm).forEach(item=>{const parentId=asmMap[item.parent]||null;data.push({id:id++,name:item.name,code:item.code||'',mfr:item.mfr||'',qty:item.qty||1,assignee:'',parentId,status:'to-order',changedAt:Date.now()})});save();render();closeModal('bomModal');toast('Loaded: '+bom.name)};
window.delBom=function(bomId,e){
  deleteTarget={id:bomId,type:'bom'};
  const bom=savedBoms.find(b=>b.id===bomId);
  const name=bom?bom.name:'Specification';
  $('deleteMsg').innerHTML='Delete "<strong>'+esc(name)+'</strong>"?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};
window.saveBom=function(){const name=$('bomName').value.trim();if(!name){toast('Enter name',1);return}const items=[];const asms=getAsms();asms.forEach(asm=>{items.push({name:asm.name,isAsm:true});data.filter(d=>d.parentId===asm.id).forEach(p=>{items.push({name:p.name,code:p.code,mfr:p.mfr,qty:p.qty,parent:asm.name})})});savedBoms.push({id:Date.now(),name,items});saveBoms();closeModal('bomModal');toast('Saved')};

window.clearStageFilter=()=>{filterStage='';render()};
window.clearAssigneeFilter=()=>{filterAssignee='';$('assigneeFilter').value='';render()};
function showPopoverModal(modal,btn){
  $('popoverBackdrop').classList.add('active');
  if(btn){
    const rect=btn.getBoundingClientRect();
    const mw=320,mh=Math.min(modal.scrollHeight||400,window.innerHeight-100);
    let top=rect.top;
    let left=rect.right-mw-10;
    // Keep in viewport
    if(left<16)left=16;
    if(left+mw>window.innerWidth-16)left=window.innerWidth-mw-16;
    if(top+mh>window.innerHeight-50)top=Math.max(50,window.innerHeight-mh-50);
    modal.style.top=top+'px';
    modal.style.left=left+'px';
  }else{
    modal.style.top='50%';
    modal.style.left='50%';
    modal.style.transform='translate(-50%,-50%) scale(1)';
  }
  modal.classList.add('open');
}
function hidePopoverModal(modal){
  modal.classList.remove('open');
  modal.style.transform='';
  $('popoverBackdrop').classList.remove('active');
}
$('popoverBackdrop').onclick=()=>{
  hidePopoverModal($('partModal'));editId=null;
  hidePopoverModal($('asmModal'));editAsmId=null;
  hidePopoverModal($('actionModal'));editActId=null;
  hidePopoverModal($('aiModal'));
};
window.editAsm=(id,e)=>{const a=data.find(d=>d.id===id);if(!a)return;editAsmId=id;$('amTitle').textContent='Edit Assembly';$('amName').value=a.name;$('amAssignee').value=a.assignee||'';$('amNotes').value=a.notes||'';$('amNotify').disabled=!getTeamEmail(a.assignee);showPopoverModal($('asmModal'),e?e.target.closest('button'):null)};
window.editPart=(id,e)=>{const p=data.find(d=>d.id===id);if(!p)return;editId=id;$('pmTitle').textContent='Edit Part';$('pmName').value=p.name;$('pmCode').value=p.code||'';$('pmMfr').value=p.mfr||'';$('pmQty').value=p.qty||1;$('pmAssignee').value=p.assignee||'';$('pmStatus').value=p.status;$('pmParent').value=p.parentId||'';$('pmNotes').value=p.notes||'';$('pmNotify').disabled=!getTeamEmail(p.assignee);showPopoverModal($('partModal'),e?e.target.closest('button'):null)};

let pendingAdvPartId=null;
window.advPart=id=>{
  const p=data.find(d=>d.id===id);if(!p)return;
  const si=STAGES.indexOf(p.status),next=STAGES[si+1];
  if(!next)return;
  // If moving to "ordered", show PO modal
  if(p.status==='to-order'&&next==='ordered'){
    pendingAdvPartId=id;
    $('poPartName').textContent=p.name+(p.code?' ('+p.code+')':'');
    $('poNumber').value=p.poNumber||'';
    $('poArrivalDate').value=p.expectedArrival||'';
    $('poModal').classList.add('open');
    setTimeout(()=>$('poNumber').focus(),100);
    return;
  }
  // Normal advancement
  advancePartStatus(id);
};

function advancePartStatus(id){
  const p=data.find(d=>d.id===id);if(!p)return;
  const next=getNextStage(p);
  if(!next)return;
  const oldStatus=p.status;
  // Record lead time when transitioning from ordered to arrived
  if(p.status==='ordered'&&next==='arrived'&&p.orderedAt){
    const days=Math.round((Date.now()-p.orderedAt)/86400000);
    if(p.code&&days>0)recordLeadTime(p.code,days);
    p.arrivedAt=Date.now();
    // Log arrival event
    const wasLate=p.expectedArrival&&new Date(p.expectedArrival)<new Date();
    const daysDelta=p.expectedArrival?Math.round((Date.now()-new Date(p.expectedArrival).getTime())/86400000):null;
    logArrival(p,days,wasLate,daysDelta);
    // Log ETA miss if late
    if(wasLate&&p.expectedArrival){
      logEtaMiss(p,p.expectedArrival,new Date().toISOString().split('T')[0],daysDelta);
    }
  }
  if(next==='ordered')p.orderedAt=Date.now();
  p.status=next;p.changedAt=Date.now();
  save();render();toast('â†’ '+SLABELS[next]);
}

let deleteTarget={id:null,type:null};
window.confirmDelete=(id,type,e)=>{
  deleteTarget={id,type};
  const item=data.find(d=>d.id===id);
  const name=item?item.name:'Item';
  let msg='Delete "<strong>'+esc(name)+'</strong>"?';
  if(type==='assembly'){
    const kids=data.filter(d=>d.parentId===id);
    if(kids.length)msg+='<br><span style="color:var(--text3);font-size:11px">+'+kids.length+' part'+(kids.length>1?'s':'')+'</span>';
  }else if(type==='part'){
    const subParts=data.filter(d=>d.parentId===id);
    if(subParts.length)msg+='<br><span style="color:var(--text3);font-size:11px">+'+subParts.length+' sub-part'+(subParts.length>1?'s':'')+'</span>';
  }
  $('deleteMsg').innerHTML=msg;
  
  // Position popover near the button
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    // Keep in viewport
    if(left<10)left=10;
    if(top+150>window.innerHeight)top=rect.top-popover.offsetHeight-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }else{
    popover.style.top='50%';
    popover.style.left='50%';
    popover.style.transform='translate(-50%,-50%) scale(1)';
  }
  popover.classList.add('open');
};

window.copyPO=(po,e)=>{
  e.stopPropagation();
  navigator.clipboard.writeText(po);
  toast('Copied: '+po);
};

window.delTeam=(idx,e)=>{
  deleteTarget={id:idx,type:'team'};
  const member=team[idx];
  const name=member?member.name:'Member';
  $('deleteMsg').innerHTML='Remove "<strong>'+esc(name)+'</strong>" from team?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};
window.openDates=()=>{$('startDate').value=projectDates.start||'';$('endDate').value=projectDates.end||'';$('datesModal').classList.add('open')};

function sendNotify(item,isAsm){const email=getTeamEmail(item.assignee);if(!email)return;const status=isAsm?calcAsmProgress(item.id)+'%':SLABELS[item.status],subject=encodeURIComponent('Action Required: '+item.name),body=encodeURIComponent('Hi '+item.assignee+',\n\nItem: '+item.name+'\nStatus: '+status+'\n'+(item.notes?'Notes: '+item.notes+'\n':'')+'\nThanks!');window.location.href='mailto:'+email+'?subject='+subject+'&body='+body}

window.editAction=(id,e)=>{const a=actions.find(x=>x.id===id);if(!a)return;editActId=id;$('actTitle').textContent='Edit Action';$('actTask').value=a.task;$('actLinkedPart').value=a.linkedPartId||'';$('actDue').value=a.due||'';$('actAssignee').value=a.assignee||'';$('actStatus').value=a.status;showPopoverModal($('actionModal'),e?e.target.closest('button'):null)};
window.advAction=id=>{const a=actions.find(x=>x.id===id);if(!a)return;const si=ASTAGES.indexOf(a.status),next=ASTAGES[si+1];if(next){a.status=next;save();render();toast('â†’ '+ALABELS[next])}};
window.delAction=(id,e)=>{
  deleteTarget={id,type:'action'};
  const item=actions.find(a=>a.id===id);
  const name=item?item.task:'Action';
  $('deleteMsg').innerHTML='Delete "<strong>'+esc(name.substring(0,30))+(name.length>30?'...':'')+'</strong>"?';
  
  const popover=$('deletePopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left-popover.offsetWidth+rect.width;
    if(left<10)left=10;
    if(top+120>window.innerHeight)top=rect.top-120-8;
    popover.style.top=top+'px';
    popover.style.left=left+'px';
  }
  popover.classList.add('open');
};

window.goToAction=actionId=>{highlightActionId=actionId;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="actions"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('actionsPanel').classList.add('active');renderActions();setTimeout(()=>{const row=document.querySelector('[data-action-id="'+actionId+'"]');if(row)row.scrollIntoView({behavior:'smooth',block:'center'})},50)};
window.goToPart=partId=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="list"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('listPanel').classList.add('active');const part=data.find(d=>d.id===partId);if(part&&part.parentId)expanded[part.parentId]=true;highlightPartId=partId;render();setTimeout(()=>{const row=document.querySelector('[data-part-id="'+partId+'"]');if(row)row.scrollIntoView({behavior:'smooth',block:'center'})},50)};
window.goToAsm=asmId=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector('[data-tab="list"]').classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));$('listPanel').classList.add('active');expanded[asmId]=true;render()};

const closeModal=id=>$(id).classList.remove('open');

// Event listeners
$('aiAlert').onclick=(e)=>{openAIModal()};
$('aiClose').onclick=()=>hidePopoverModal($('aiModal'));
$('aiAskBtn').onclick=handleAskSubmit;
$('aiStraightBtn').onclick=handleStraight;
$('aiQuestion').onkeydown=e=>{if(e.key==='Enter')handleAskSubmit()};

$('reportBtn').onclick=()=>{const report=generateReport();$('reportContent').textContent=report;$('reportDate').textContent=new Date().toLocaleDateString();$('reportRecipients').textContent=team.length?'To: '+team.map(t=>t.name).join(', '):'No team';$('reportModal').classList.add('open')};
$('reportClose').onclick=()=>closeModal('reportModal');
$('reportModal').onclick=e=>{if(e.target.id==='reportModal')closeModal('reportModal')};
$('reportCopy').onclick=()=>{navigator.clipboard.writeText($('reportContent').textContent);toast('Copied')};
$('reportEmail').onclick=()=>{const emails=team.map(t=>t.email).filter(e=>e).join(',');if(!emails){toast('No emails',1);return}const report=generateReport(),subject=encodeURIComponent(currentProjectName+' - Status Report'),body=encodeURIComponent(report);window.location.href='mailto:'+emails+'?subject='+subject+'&body='+body};

$('etaClose').onclick=()=>{closeModal('etaModal');editEtaPartId=null};
$('etaModal').onclick=e=>{if(e.target.id==='etaModal'){closeModal('etaModal');editEtaPartId=null}};
$('etaSave').onclick=()=>{if(!editEtaPartId)return;const part=data.find(d=>d.id===editEtaPartId);if(!part)return;const val=$('etaDateInput').value;part.expectedArrival=val||undefined;part.manualEta=undefined;save();render();closeModal('etaModal');editEtaPartId=null;toast('Saved')};
$('etaClear').onclick=()=>{if(!editEtaPartId)return;const part=data.find(d=>d.id===editEtaPartId);if(!part)return;part.expectedArrival=undefined;part.manualEta=undefined;save();render();closeModal('etaModal');editEtaPartId=null;toast('Cleared')};

$('bomClose').onclick=$('bomCancel').onclick=()=>closeModal('bomModal');
$('bomModal').onclick=e=>{if(e.target.id==='bomModal')closeModal('bomModal')};
$('bomSave').onclick=window.saveBom;

$('leadtimeBtn').onclick=()=>{renderLeadTimeModal();$('leadtimeModal').classList.add('open')};
$('ltClose').onclick=$('ltDone').onclick=()=>closeModal('leadtimeModal');
$('leadtimeModal').onclick=e=>{if(e.target.id==='leadtimeModal')closeModal('leadtimeModal')};
$('ltClear').onclick=()=>{if(confirm('Clear all?')){leadTimeDb={};saveLeadTime();renderLeadTimeModal();toast('Cleared')}};

// Item Code Configuration Modal
function renderItemConfigModal(){
  const codes=Object.keys(itemCodeConfig).sort();
  if(!codes.length){
    $('icList').innerHTML='<div class="itemconfig-empty">No item codes configured yet.<br>Add a code above to customize testing & configuration requirements.</div>';
    return;
  }
  let html='';
  codes.forEach(code=>{
    const cfg=itemCodeConfig[code];
    html+='<div class="itemconfig-item" data-code="'+esc(code)+'">';
    html+='<div class="itemconfig-item-header"><span class="itemconfig-code">'+esc(code)+'</span><button class="itemconfig-del" onclick="window.deleteItemConfig(\''+esc(code)+'\')">Ã—</button></div>';
    html+='<div class="itemconfig-options">';
    html+='<div class="itemconfig-opt"><label>Testing Required</label><input type="checkbox" '+(cfg.requiresTesting?'checked':'')+' onchange="window.updateItemConfig(\''+esc(code)+'\',\'requiresTesting\',this.checked)"></div>';
    html+='<div class="itemconfig-opt"><label>Tester</label><select onchange="window.updateItemConfig(\''+esc(code)+'\',\'tester\',this.value)"><option value="">â€” Any â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(cfg.tester===t.name?' selected':'')+'>'+esc(t.name)+'</option>').join('')+'</select></div>';
    html+='<div class="itemconfig-opt"><label>Config Required</label><input type="checkbox" '+(cfg.requiresConfig?'checked':'')+' onchange="window.updateItemConfig(\''+esc(code)+'\',\'requiresConfig\',this.checked)"></div>';
    html+='<div class="itemconfig-opt"><label>Configured By</label><select onchange="window.updateItemConfig(\''+esc(code)+'\',\'configuredBy\',this.value)"><option value="">â€” Any â€”</option>'+team.map(t=>'<option value="'+esc(t.name)+'"'+(cfg.configuredBy===t.name?' selected':'')+'>'+esc(t.name)+'</option>').join('')+'</select></div>';
    html+='</div></div>';
  });
  $('icList').innerHTML=html;
}

window.updateItemConfig=function(code,field,value){
  if(!itemCodeConfig[code])itemCodeConfig[code]={requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  itemCodeConfig[code][field]=value;
  saveItemCodeConfig();
  render(); // Re-render to update stage dots
};

window.deleteItemConfig=function(code){
  delete itemCodeConfig[code];
  saveItemCodeConfig();
  renderItemConfigModal();
  render();
  toast('Removed');
};

window.addItemConfig=function(){
  const input=$('icNewCode');
  const code=input.value.trim().toUpperCase();
  if(!code){toast('Enter code',1);return}
  if(itemCodeConfig[code]){toast('Already exists',1);return}
  itemCodeConfig[code]={requiresTesting:true,tester:'',requiresConfig:false,configuredBy:''};
  saveItemCodeConfig();
  input.value='';
  renderItemConfigModal();
  toast('Added');
};

$('itemConfigBtn').onclick=()=>{renderItemConfigModal();$('itemConfigModal').classList.add('open')};
$('icClose').onclick=$('icDone').onclick=()=>closeModal('itemConfigModal');
$('itemConfigModal').onclick=e=>{if(e.target.id==='itemConfigModal')closeModal('itemConfigModal')};
$('icAddBtn').onclick=window.addItemConfig;
$('icNewCode').onkeydown=e=>{if(e.key==='Enter')window.addItemConfig()};

// OTD Modal
window.showOTDModal=function(){
  const mfrData=calcOTDByMfr();
  const overallOTD=calcSupplierOTD();
  const avgLead=calcAvgLeadTime();
  
  let html='';
  if(!mfrData.length){
    html='<div class="otd-empty">No delivery data yet.<br><span style="font-size:11px">Data is collected when parts move from Ordered â†’ Arrived</span></div>';
  }else{
    // Overall summary
    html+='<div class="otd-item" style="background:var(--bg3);margin-bottom:16px"><div class="otd-mfr">Overall</div><div class="otd-stats"><div class="otd-stat"><span class="otd-stat-val" style="color:'+(overallOTD>=90?'var(--green)':overallOTD>=70?'var(--yellow)':'var(--red)')+'">'+(overallOTD||0)+'%</span><span class="otd-stat-label">OTD</span></div><div class="otd-stat"><span class="otd-stat-val">'+(avgLead||0)+'d</span><span class="otd-stat-label">Avg Lead</span></div></div></div>';
    // Per manufacturer
    mfrData.forEach(m=>{
      const color=m.otd>=90?'var(--green)':m.otd>=70?'var(--yellow)':'var(--red)';
      html+='<div class="otd-item"><div class="otd-mfr">'+esc(m.mfr)+'</div><div class="otd-stats"><div class="otd-stat"><span class="otd-stat-val" style="color:'+color+'">'+m.otd+'%</span><span class="otd-stat-label">OTD</span></div><div class="otd-stat"><span class="otd-stat-val">'+m.avgLead+'d</span><span class="otd-stat-label">Lead</span></div><div class="otd-stat"><span class="otd-stat-val" style="font-size:13px">'+m.total+'</span><span class="otd-stat-label">Parts</span></div><div class="otd-bar"><div class="otd-bar-fill" style="width:'+m.otd+'%;background:'+color+'"></div></div></div></div>';
    });
  }
  $('otdBody').innerHTML=html;
  $('otdModal').classList.add('open');
};
$('otdClose').onclick=$('otdDone').onclick=()=>closeModal('otdModal');
$('otdModal').onclick=e=>{if(e.target.id==='otdModal')closeModal('otdModal')};

$('pmClose').onclick=$('pmCancel').onclick=()=>{hidePopoverModal($('partModal'));editId=null};
$('pmSave').onclick=()=>{
  const name=$('pmName').value.trim();if(!name){toast('Enter name',1);return}
  const now=Date.now();
  if(editId){
    const p=data.find(d=>d.id===editId);
    if(p){
      const oldStatus=p.status;
      p.name=name;p.code=$('pmCode').value.trim();p.mfr=$('pmMfr').value.trim();p.qty=parseInt($('pmQty').value)||1;p.assignee=$('pmAssignee').value;p.parentId=$('pmParent').value?parseInt($('pmParent').value):null;p.notes=$('pmNotes').value.trim();
      const newStatus=$('pmStatus').value;
      if(oldStatus!==newStatus){if(oldStatus==='ordered'&&newStatus==='arrived'&&p.orderedAt&&p.code){const days=Math.round((now-p.orderedAt)/86400000);if(days>0)recordLeadTime(p.code,days)}if(newStatus==='ordered')p.orderedAt=now;p.status=newStatus;p.changedAt=now}
    }
    toast('Updated');
  }else{
    const part={id:now,name,code:$('pmCode').value.trim(),mfr:$('pmMfr').value.trim(),qty:parseInt($('pmQty').value)||1,assignee:$('pmAssignee').value,status:$('pmStatus').value,parentId:$('pmParent').value?parseInt($('pmParent').value):null,notes:$('pmNotes').value.trim(),changedAt:now};
    if(part.status==='ordered')part.orderedAt=now;
    data.push(part);toast('Added');
  }
  save();render();hidePopoverModal($('partModal'));editId=null;
};


$('amClose').onclick=$('amCancel').onclick=()=>{hidePopoverModal($('asmModal'));editAsmId=null};
$('amSave').onclick=()=>{
  const name=$('amName').value.trim();if(!name){toast('Enter name',1);return}
  if(editAsmId){
    const a=data.find(d=>d.id===editAsmId);
    if(a){a.name=name;a.assignee=$('amAssignee').value;a.notes=$('amNotes').value.trim()}
    toast('Updated');
  }else{
    const asms=getAsms(),maxP=asms.length?Math.max(...asms.map(a=>a.priority||0)):0;
    const id=Date.now();
    data.push({id,name,isAsm:true,assignee:$('amAssignee').value,notes:$('amNotes').value.trim(),priority:maxP+1});
    expanded[id]=true;
    toast('Added');
  }
  save();render();hidePopoverModal($('asmModal'));editAsmId=null;
};


$('amNotify').onclick=()=>{if(editAsmId){const a=data.find(d=>d.id===editAsmId);if(a)sendNotify(a,true)}};
$('amAssignee').onchange=()=>{$('amNotify').disabled=!getTeamEmail($('amAssignee').value)};
$('pmAssignee').onchange=()=>{$('pmNotify').disabled=!getTeamEmail($('pmAssignee').value)};
$('pmNotify').onclick=()=>{if(editId){const p=data.find(d=>d.id===editId);if(p)sendNotify(p,false)}};

$('actClose').onclick=$('actCancel').onclick=()=>{hidePopoverModal($('actionModal'));editActId=null};
$('actSave').onclick=()=>{
  const task=$('actTask').value.trim();if(!task){toast('Enter task',1);return}
  const newStatus=$('actStatus').value;
  if(editActId){
    const a=actions.find(x=>x.id===editActId);
    if(a){
      a.task=task;a.linkedPartId=$('actLinkedPart').value?parseInt($('actLinkedPart').value):null;a.due=$('actDue').value;a.assignee=$('actAssignee').value;a.status=newStatus;
    }
    toast('Updated');
  }else{
    actions.push({id:Date.now(),task,linkedPartId:$('actLinkedPart').value?parseInt($('actLinkedPart').value):null,due:$('actDue').value,assignee:$('actAssignee').value,status:newStatus,createdAt:new Date().toISOString().split('T')[0]});
    toast('Added');
  }
  save();render();hidePopoverModal($('actionModal'));editActId=null;
};


$('addActionBtn').onclick=(e)=>{editActId=null;$('actTitle').textContent='Add Action';$('actTask').value='';$('actLinkedPart').value='';$('actDue').value='';$('actAssignee').value='';$('actStatus').value='not-started';showPopoverModal($('actionModal'),e.target)};

$('teamBtn').onclick=()=>{renderTeamList();$('teamModal').classList.add('open')};
$('teamClose').onclick=$('teamDone').onclick=()=>closeModal('teamModal');
$('teamModal').onclick=e=>{if(e.target.id==='teamModal')closeModal('teamModal')};
$('teamAdd').onclick=()=>{const name=$('teamName').value.trim(),email=$('teamEmail').value.trim();if(!name||!email.includes('@')){toast('Enter name & email',1);return}if(team.find(t=>t.name===name)){toast('Exists',1);return}team.push({name,email});save();$('teamName').value='';$('teamEmail').value='';renderTeamList();updateSelects();toast('Added')};

$('datesBtn').onclick=$('burndownEdit').onclick=window.openDates;
$('datesClose').onclick=$('datesCancel').onclick=()=>closeModal('datesModal');
$('datesSave').onclick=()=>{projectDates.start=$('startDate').value;projectDates.end=$('endDate').value;save();render();closeModal('datesModal');toast('Saved')};
$('datesModal').onclick=e=>{if(e.target.id==='datesModal')closeModal('datesModal')};

// PO Modal handlers
$('poClose').onclick=$('poCancel').onclick=()=>{closeModal('poModal');pendingAdvPartId=null};
$('poSave').onclick=()=>{
  if(pendingAdvPartId){
    const p=data.find(d=>d.id===pendingAdvPartId);
    if(p){
      p.poNumber=$('poNumber').value.trim()||null;
      p.expectedArrival=$('poArrivalDate').value||null;
      advancePartStatus(pendingAdvPartId);
    }
  }
  closeModal('poModal');
  pendingAdvPartId=null;
};
$('poModal').onclick=e=>{if(e.target.id==='poModal'){closeModal('poModal');pendingAdvPartId=null}};

// Delete confirmation popover handlers
function closeDeletePopover(){$('deletePopover').classList.remove('open');deleteTarget={id:null,type:null}}
$('deleteCancel').onclick=closeDeletePopover;
$('deleteConfirm').onclick=()=>{
  if(deleteTarget.id!==null){
    if(deleteTarget.type==='action'){
      actions=actions.filter(a=>a.id!==deleteTarget.id);
      save();render();
    }else if(deleteTarget.type==='team'){
      team.splice(deleteTarget.id,1);
      save();renderTeamList();updateSelects();
    }else if(deleteTarget.type==='bom'){
      savedBoms=savedBoms.filter(b=>b.id!==deleteTarget.id);
      saveBoms();renderBomList();
    }else{
      const item=data.find(d=>d.id===deleteTarget.id);
      if(item){
        data=data.filter(d=>d.id!==deleteTarget.id&&d.parentId!==deleteTarget.id);
        delete expanded[deleteTarget.id];
        save();render();
      }
    }
    toast('Deleted');
  }
  closeDeletePopover();
};
// Close popover when clicking outside
document.addEventListener('click',e=>{
  const popover=$('deletePopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.sm-btn.red')&&!e.target.closest('.adv-btn')&&!e.target.closest('.team-item-del')&&!e.target.closest('.bom-item-del')){
    closeDeletePopover();
  }
});

$('menuBtn').onclick=e=>{e.stopPropagation();$('menuDrop').classList.toggle('open')};
document.onclick=()=>$('menuDrop').classList.remove('open');

$('sampleBtn').onclick=()=>{if(confirm('Reset to sample data? This will replace all current data.'))createAndSaveSampleData()};

$('expandToggle').onclick=()=>{
  const asms=getAsms();
  if(allExpanded){expanded={};allExpanded=false}
  else{asms.forEach(a=>expanded[a.id]=true);allExpanded=true}
  save();render();
};

$('clearBtn').onclick=()=>{if(confirm('Delete ALL data? This cannot be undone.')){data=[];team=[];expanded={};history=[];projectDates={start:'',end:''};actions=[];currentProjectName='New Project';projectRef.child('main').set({data,team,history,projectDates,actions,projectName:currentProjectName,updatedAt:firebase.database.ServerValue.TIMESTAMP});toast('All data cleared')}};
$('signOutBtn').onclick=()=>{if(confirm('Sign out?'))logout()};

// Header search
$('headerSearch').oninput=e=>{
  searchQ=e.target.value;
  $('headerSearchClear').classList.toggle('visible',searchQ.length>0);
  render();
};
$('headerSearchClear').onclick=()=>{
  $('headerSearch').value='';
  searchQ='';
  $('headerSearchClear').classList.remove('visible');
  render();
};

$('actionSearchBox').oninput=e=>{actionSearchQ=e.target.value;renderActions()};
$('actionAssigneeFilter').onchange=e=>{actionAssigneeFilter=e.target.value;renderActions()};
$('assigneeFilter').onchange=e=>{filterAssignee=e.target.value;render()};

document.querySelectorAll('.pipe').forEach(p=>p.onclick=()=>{filterStage=filterStage===p.dataset.s?'':p.dataset.s;render()});

document.querySelectorAll('.tab').forEach(tab=>tab.onclick=()=>{
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $(tab.dataset.tab+'Panel').classList.add('active');
  if(tab.dataset.tab==='progress')setTimeout(renderBurndown,10);
});

document.onkeydown=e=>{if(e.key==='Escape'){['teamModal','datesModal','reportModal','leadtimeModal','etaModal','bomModal','themeModal','poModal','otdModal','itemConfigModal'].forEach(closeModal);hidePopoverModal($('partModal'));hidePopoverModal($('asmModal'));hidePopoverModal($('actionModal'));hidePopoverModal($('aiModal'));closeDeletePopover();$('commentsPopover').classList.remove('open');currentCommentPartId=null;editId=editAsmId=editActId=editEtaPartId=pendingAdvPartId=null}};

// ============================================
// CHAT SYSTEM
// ============================================
let chatNickname='';
let lastMessageId=null;
let chatOpen=false;

let unreadCount=0;
let chatInitialized=false;

function updateChatBadge(){
  const badge=$('chatBadge');
  if(unreadCount>0){
    badge.textContent=unreadCount>99?'99+':unreadCount;
    badge.style.display='flex';
  }else{
    badge.style.display='none';
  }
}

function initChat(){
  const stored=localStorage.getItem('ebs-chat-nick');
  if(stored){
    chatNickname=stored;
    showChatInterface();
  }
  
  // Load initial messages first, then listen for new ones
  projectRef.child('chat').orderByChild('timestamp').limitToLast(50).once('value',snapshot=>{
    // Mark as initialized after initial load
    setTimeout(()=>{chatInitialized=true},500);
  });
  
  // Listen for chat messages
  projectRef.child('chat').orderByChild('timestamp').limitToLast(50).on('child_added',snapshot=>{
    const msg=snapshot.val();
    if(msg&&chatNickname){
      addMessageToUI(msg,snapshot.key);
      // Show badge if panel is closed, message is from someone else, and we're past initial load
      if(chatInitialized&&!chatOpen&&msg.nickname!==chatNickname){
        unreadCount++;
        updateChatBadge();
      }
    }
  });
  
  // Online presence
  setupPresence();
}

function setupPresence(){
  const myPresenceRef=projectRef.child('presence').push();
  const myData={nickname:chatNickname||'Anonymous',lastSeen:firebase.database.ServerValue.TIMESTAMP};
  
  myPresenceRef.set(myData);
  myPresenceRef.onDisconnect().remove();
  
  // Update presence periodically
  setInterval(()=>{
    if(isAuthenticated)myPresenceRef.update({lastSeen:firebase.database.ServerValue.TIMESTAMP});
  },30000);
  
  // Listen for online users
  projectRef.child('presence').on('value',snapshot=>{
    const users=snapshot.val();
    const now=Date.now();
    let onlineUsers=[];
    if(users){
      Object.values(users).forEach(u=>{
        if(u.lastSeen&&now-u.lastSeen<60000){
          onlineUsers.push({name:u.nickname,lastSeen:u.lastSeen});
        }
      });
    }
    if(onlineUsers.length===0)onlineUsers.push({name:'You',lastSeen:now});
    
    $('onlineCount').textContent=onlineUsers.length===1?'1 online':onlineUsers.length+' online';
    
    // Update hover card
    $('onlineUserList').innerHTML=onlineUsers.map(u=>{
      const ago=Math.floor((now-u.lastSeen)/1000);
      const timeStr=ago<60?'now':ago<3600?Math.floor(ago/60)+'m ago':Math.floor(ago/3600)+'h ago';
      return '<div class="online-user"><div class="online-user-dot"></div><span class="online-user-name">'+esc(u.name)+'</span><span class="online-user-time">'+timeStr+'</span></div>';
    }).join('');
  });
}

function showChatInterface(){
  $('chatNickname').style.display='none';
  $('chatMessages').style.display='flex';
  $('chatInputArea').style.display='flex';
  
  // Clear unread badge
  unreadCount=0;
  updateChatBadge();
  
  // Load existing messages
  projectRef.child('chat').orderByChild('timestamp').limitToLast(50).once('value',snapshot=>{
    const msgs=snapshot.val();
    if(msgs){
      $('chatMessages').innerHTML='';
      Object.entries(msgs).forEach(([key,msg])=>addMessageToUI(msg,key));
      scrollChatToBottom();
    }else{
      $('chatMessages').innerHTML='<div class="chat-empty">No messages yet.<br>Start the conversation!</div>';
    }
  });
}

function addMessageToUI(msg,key){
  if(lastMessageId===key)return;
  lastMessageId=key;
  
  const container=$('chatMessages');
  const empty=container.querySelector('.chat-empty');
  if(empty)empty.remove();
  
  const isMine=msg.nickname===chatNickname;
  const time=new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  
  const div=document.createElement('div');
  div.className='chat-msg '+(isMine?'mine':'other');
  div.innerHTML=
    (isMine?'':'<div class="chat-msg-name">'+esc(msg.nickname)+'</div>')+
    esc(msg.text)+
    '<div class="chat-msg-time">'+time+'</div>';
  container.appendChild(div);
  scrollChatToBottom();
}

function scrollChatToBottom(){
  const container=$('chatMessages');
  container.scrollTop=container.scrollHeight;
}

function sendMessage(){
  const input=$('chatInput');
  const text=input.value.trim();
  if(!text||!chatNickname)return;
  
  projectRef.child('chat').push({
    nickname:chatNickname,
    text:text,
    timestamp:firebase.database.ServerValue.TIMESTAMP
  });
  
  input.value='';
}

// Chat UI handlers
$('chatToggle').onclick=()=>{
  chatOpen=!chatOpen;
  $('chatPanel').classList.toggle('open',chatOpen);
  if(chatOpen){
    unreadCount=0;
    updateChatBadge();
    if(chatNickname)scrollChatToBottom();
  }
};

$('chatClose').onclick=()=>{
  chatOpen=false;
  $('chatPanel').classList.remove('open');
};

$('chatNickBtn').onclick=()=>{
  const nick=$('chatNickInput').value.trim();
  if(!nick)return;
  chatNickname=nick;
  localStorage.setItem('ebs-chat-nick',nick);
  showChatInterface();
  setupPresence();
};

$('chatNickInput').onkeydown=e=>{if(e.key==='Enter')$('chatNickBtn').click()};

$('chatSend').onclick=sendMessage;
$('chatInput').onkeydown=e=>{if(e.key==='Enter')sendMessage()};

// Comments on parts
let currentCommentPartId=null;

window.openComments=function(partId,e){
  currentCommentPartId=partId;
  const part=data.find(d=>d.id===partId);
  $('commentsTitle').textContent='Comments: '+(part?part.name.substring(0,20):'Part');
  
  // Position near button
  const popover=$('commentsPopover');
  const btn=e?e.target.closest('button'):null;
  if(btn){
    const rect=btn.getBoundingClientRect();
    let top=rect.bottom+8;
    let left=rect.left;
    if(left+280>window.innerWidth)left=window.innerWidth-290;
    if(top+350>window.innerHeight)top=rect.top-350-8;
    popover.style.top=Math.max(10,top)+'px';
    popover.style.left=Math.max(10,left)+'px';
  }
  
  loadComments(partId);
  popover.classList.add('open');
};

function loadComments(partId){
  const part=data.find(d=>d.id===partId);
  const comments=part?.comments||[];
  if(comments.length===0){
    $('commentsList').innerHTML='<div class="comments-empty">No comments yet</div>';
  }else{
    $('commentsList').innerHTML=comments.map(c=>{
      const time=new Date(c.ts||c.timestamp).toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      return '<div class="comment-item"><div class="comment-author">'+esc(c.author)+'</div><div class="comment-text">'+esc(c.text)+'</div><div class="comment-time">'+time+'</div></div>';
    }).join('');
  }
}

$('commentsClose').onclick=()=>{
  $('commentsPopover').classList.remove('open');
  currentCommentPartId=null;
};

// Close comments when clicking outside
document.addEventListener('click',e=>{
  const popover=$('commentsPopover');
  if(popover.classList.contains('open')&&!popover.contains(e.target)&&!e.target.closest('.comment-btn')){
    popover.classList.remove('open');
    currentCommentPartId=null;
  }
});

$('commentAdd').onclick=()=>{
  const input=$('commentInput');
  const text=input.value.trim();
  if(!text||!currentCommentPartId)return;
  
  const part=data.find(d=>d.id===currentCommentPartId);
  if(!part)return;
  
  if(!part.comments)part.comments=[];
  part.comments.push({
    author:chatNickname||'Anonymous',
    text:text,
    ts:Date.now()
  });
  
  // Log comment event
  logComment(part,text);
  
  save();
  loadComments(currentCommentPartId);
  input.value='';
  render(); // Update comment count
};

$('commentInput').onkeydown=e=>{if(e.key==='Enter')$('commentAdd').click()};

// Theme System
const THEMES=[
  {id:'default',name:'Claude Dark',colors:{bg:'#2f2f2f',bg2:'#3d3d3d',accent:'#da7756',green:'#5cb85c',red:'#d9534f'}},
  {id:'claude-light',name:'Claude Light',colors:{bg:'#f5f4f2',bg2:'#ffffff',accent:'#da7756',green:'#3d8c40',red:'#c44540'}},
  {id:'graphite',name:'Graphite',colors:{bg:'#1c1c1e',bg2:'#2c2c2e',accent:'#98989d',green:'#30d158',red:'#ff453a'}},
  {id:'midnight',name:'Midnight',colors:{bg:'#0a1628',bg2:'#0f1f33',accent:'#0a84ff',green:'#30d158',red:'#ff453a'}},
  {id:'forest',name:'Forest',colors:{bg:'#161d14',bg2:'#1e271a',accent:'#30d158',green:'#32d74b',red:'#ff453a'}},
  {id:'sunset',name:'Sunset',colors:{bg:'#1e1614',bg2:'#2a1e1a',accent:'#ff9f0a',green:'#30d158',red:'#ff453a'}},
  {id:'ocean',name:'Ocean',colors:{bg:'#0f1a1e',bg2:'#152228',accent:'#64d2ff',green:'#30d158',red:'#ff453a'}},
  {id:'lavender',name:'Lavender',colors:{bg:'#1a181e',bg2:'#242028',accent:'#bf5af2',green:'#30d158',red:'#ff453a'}},
  {id:'highcontrast',name:'High Contrast',colors:{bg:'#000000',bg2:'#1c1c1e',accent:'#409cff',green:'#30db5b',red:'#ff6961'}}
];
let currentTheme=localStorage.getItem('ebs-theme')||'default';

function applyTheme(themeId){
  if(themeId==='default')document.documentElement.removeAttribute('data-theme');
  else document.documentElement.setAttribute('data-theme',themeId);
  currentTheme=themeId;
  localStorage.setItem('ebs-theme',themeId);
  renderThemeGrid();
}

function renderThemeGrid(){
  const grid=$('themeGrid');
  const lightThemes=['claude-light'];
  grid.innerHTML=THEMES.map(t=>{
    const isActive=t.id===currentTheme;
    const isLight=lightThemes.includes(t.id);
    return '<div class="theme-card'+(isActive?' active':'')+'" data-theme-id="'+t.id+'" style="background:'+t.colors.bg+';color:'+(isLight?'#2d2d2d':'#e8e8ec')+'"><div class="theme-name">'+t.name+'</div><div class="theme-preview"><span style="background:'+t.colors.bg2+'"></span><span style="background:'+t.colors.accent+'"></span><span style="background:'+t.colors.green+'"></span><span style="background:'+t.colors.red+'"></span></div></div>';
  }).join('');
  grid.querySelectorAll('.theme-card').forEach(card=>{
    card.onclick=()=>applyTheme(card.dataset.themeId);
  });
}

$('themeBtn').onclick=()=>{renderThemeGrid();$('themeModal').classList.add('open')};
$('themeClose').onclick=()=>closeModal('themeModal');
$('themeModal').onclick=e=>{if(e.target.id==='themeModal')closeModal('themeModal')};

// Item Code Configuration
function renderItemConfigList(){
  const codes=Object.keys(itemCodeConfig).sort();
  if(codes.length===0){
    $('icList').innerHTML='<div class="item-config-empty">No item codes configured yet.<br>Add configurations above to customize phase requirements.</div>';
    return;
  }
  let html='<div class="item-config-row header"><div>Item Code</div><div>Phases</div><div></div></div>';
  codes.forEach(code=>{
    const cfg=itemCodeConfig[code];
    let badges='';
    badges+=cfg.requiresConfig?'<span class="item-config-badge active">Config'+(cfg.configuredBy?' ('+esc(cfg.configuredBy)+')':'')+'</span>':'<span class="item-config-badge skip">Config</span>';
    badges+=cfg.requiresTesting?'<span class="item-config-badge active">Test'+(cfg.tester?' ('+esc(cfg.tester)+')':'')+'</span>':'<span class="item-config-badge skip">Test</span>';
    html+='<div class="item-config-row"><div class="item-config-code">'+esc(code)+'</div><div class="item-config-badges">'+badges+'</div><div class="item-config-actions"><button onclick="window.editItemConfig(\''+esc(code)+'\')">Edit</button><button onclick="window.deleteItemConfig(\''+esc(code)+'\')">Ã—</button></div></div>';
  });
  $('icList').innerHTML=html;
}

function updateItemConfigSelects(){
  const teamOpts='<option value="">Anyone</option>'+team.map(t=>'<option value="'+esc(t.name)+'">'+esc(t.name)+'</option>').join('');
  $('icConfigBy').innerHTML=teamOpts;
  $('icTestBy').innerHTML=teamOpts;
}

function clearItemConfigForm(){
  $('icCode').value='';
  $('icReqConfig').checked=false;
  $('icReqTest').checked=true;
  $('icConfigBy').value='';
  $('icTestBy').value='';
}

window.editItemConfig=function(code){
  const cfg=itemCodeConfig[code]||{};
  $('icCode').value=code;
  $('icReqConfig').checked=cfg.requiresConfig||false;
  $('icReqTest').checked=cfg.requiresTesting!==false;
  $('icConfigBy').value=cfg.configuredBy||'';
  $('icTestBy').value=cfg.tester||'';
};

window.deleteItemConfig=function(code){
  if(!confirm('Remove configuration for "'+code+'"?'))return;
  delete itemCodeConfig[code];
  saveItemCodeConfig();
  renderItemConfigList();
  render();
  toast('Removed');
};

$('itemConfigBtn').onclick=()=>{
  updateItemConfigSelects();
  renderItemConfigList();
  clearItemConfigForm();
  $('itemConfigModal').classList.add('open');
};

$('icClose').onclick=$('icDone').onclick=()=>closeModal('itemConfigModal');
$('itemConfigModal').onclick=e=>{if(e.target.id==='itemConfigModal')closeModal('itemConfigModal')};

$('icSave').onclick=()=>{
  const code=$('icCode').value.trim().toUpperCase();
  if(!code){toast('Enter item code',1);return}
  itemCodeConfig[code]={
    requiresConfig:$('icReqConfig').checked,
    configuredBy:$('icConfigBy').value,
    requiresTesting:$('icReqTest').checked,
    tester:$('icTestBy').value
  };
  saveItemCodeConfig();
  renderItemConfigList();
  clearItemConfigForm();
  render();
  toast('Saved: '+code);
};

$('icClear').onclick=clearItemConfigForm;

$('icExport').onclick=()=>{
  const json=JSON.stringify(itemCodeConfig,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='item-code-config.json';a.click();
  URL.revokeObjectURL(url);
  toast('Exported');
};

// Initialize
applyTheme(currentTheme);
loadExpanded();
loadItemCodeConfig();

// Check if already authenticated
if(checkAuth()){
  isAuthenticated=true;
  $('loginScreen').style.display='none';
  initFirebaseListeners();
}

})();
</script>
</body>
</html>
